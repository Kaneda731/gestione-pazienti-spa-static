import{j as e,D as t,u as a,c as n,d as i,v as r}from"./shared-DM1owLfs.js";import{a as o,l as s,B as l,z as c,m as d}from"./core-services-CSrwUk3W.js";import{r as p}from"./react-vendor-DMMrM9kC.js";import{p as u,r as m,e as v}from"./patientService-BUKaJ6EC.js";import"./PatientListPage---HZuWA-.js";/* empty css               */import{u as h}from"./useQuery-25yGgNuF.js";const g=new class{cache=new Map;timeout=3e5;get(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<this.timeout?t.data:(t&&this.cache.delete(e),null)}set(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}clear(){this.cache.clear()}cleanup(){const e=Date.now();for(const[t,a]of this.cache.entries())e-a.timestamp>this.timeout&&this.cache.delete(t)}},x={activeOnly:!1,maxResults:10,minSearchLength:2,debounceDelay:300,enableCache:!0,cacheKey:"patient-search",enableDeduplication:!0};const b=({value:t,onChange:a,placeholder:n="Cerca paziente...",className:i="",disabled:r=!1,required:l=!1,activeOnly:c=!1,maxResults:d=10,minSearchLength:v=2,debounceDelay:h=300,showPatientInfo:b=!0,highlightMatch:_=!0})=>{const f=o.useId(),j=`patient-autocomplete-${f}`,N=`patient-autocomplete-list-${f}`,w=o.useRef(null),z=o.useRef(null),S=o.useRef(null),[y,E]=o.useState(!1),[C,k]=o.useState(-1),[D,P]=o.useState(""),[I,R]=o.useState({top:0,left:0,width:0}),{searchTerm:T,setSearchTerm:$,results:A,loading:L,error:O,clearSearch:F}=function(e={}){const t={...x,...e},{activeOnly:a,maxResults:n,minSearchLength:i,debounceDelay:r,enableCache:l,cacheKey:c,enableDeduplication:d}=t,[p,v]=o.useState(""),[h,b]=o.useState([]),[_,f]=o.useState(!1),[j,N]=o.useState(null),[w,z]=o.useState({hits:0,misses:0}),S=o.useRef(),y=o.useRef(null),E=o.useRef(""),C=o.useCallback(async e=>{if(e===E.current)return;E.current=e,y.current&&y.current.abort(),y.current=new AbortController;const{signal:t}=y.current;if(!e||e.trim().length<i)return b([]),N(null),f(!1),void 0;const r=e.trim();f(!0),N(null);try{let e;if(l){const e=g.get(`${c}:${r}:${a}:${n}`);if(e)return s.log("[usePatientAutocomplete] Cache hit for:",r),b(e),z(e=>({...e,hits:e.hits+1})),f(!1),void 0;z(e=>({...e,misses:e.misses+1}))}const i=async()=>u.searchPatients(r,a,n);d?(s.log("[usePatientAutocomplete] Using deduplication for search:",{deduplicationKey:`patient-search:${r}:${a}:${n}`}),e=await m.executeRequest(`patient-search:${r}:${a}:${n}`,i,{signal:t})):(s.log("[usePatientAutocomplete] Direct search without deduplication"),e=await i()),t.aborted||(s.group("[usePatientAutocomplete] Search results DEBUG"),s.log("Risultati ricevuti:",{term:r,resultsCount:e.length,fromCache:!1,activeOnly:a,maxResults:n,enableDeduplication:d,sampleResults:e.slice(0,3).map(e=>({id:e.id,nome:e.nome,cognome:e.cognome,codice_rad:e.codice_rad}))}),l&&e.length>0&&(g.set(`${c}:${r}:${a}:${n}`,e),s.log("Results cached")),b(e),0===e.length&&N(`Nessun paziente trovato per "${r}"`))}catch(o){if(!t.aborted){const e=o instanceof Error?o.message:"Errore durante la ricerca";N(e),b([]),s.error("[usePatientAutocomplete] Search error:",o)}}finally{t.aborted||f(!1)}},[a,n,i,l,c,d]),k=o.useCallback(e=>{v(e),S.current&&clearTimeout(S.current),S.current=window.setTimeout(()=>{C(e)},r)},[C,r]),D=o.useCallback(()=>{v(""),b([]),N(null),E.current="",S.current&&clearTimeout(S.current),y.current&&y.current.abort()},[]),P=o.useCallback(()=>{p&&C(p)},[p,C]);return o.useEffect(()=>()=>{S.current&&clearTimeout(S.current),y.current&&y.current.abort()},[]),o.useEffect(()=>{l&&g.clear()},[a,n,l,c]),{searchTerm:p,setSearchTerm:k,results:h,loading:_,error:j,clearSearch:D,refetch:P,cacheStats:w}}({activeOnly:c,maxResults:d,minSearchLength:v,debounceDelay:h,enableCache:!0,cacheKey:"patient-autocomplete",enableDeduplication:!0});o.useEffect(()=>{if(t){P(`${t.cognome} ${t.nome}`)}else P("")},[t]),o.useEffect(()=>{const e=e=>{const t=e.target,a=w.current&&w.current.contains(t),n=S.current&&S.current.contains(t);a||n||(E(!1),k(-1))};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),o.useEffect(()=>{if(y&&z.current){const e=z.current.getBoundingClientRect();R({top:e.top+e.height,left:e.left,width:e.width})}},[y]);const M=o.useMemo(()=>A.slice(0,d),[A,d]),q=o.useCallback((t,a)=>{if(!_||!a.trim())return t;const n=new RegExp(`(${a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return t.split(n).map((t,a)=>n.test(t)?e.jsx("mark",{className:"bg-warning text-dark",children:t},a):t)},[_]),K=o.useCallback(e=>{const t=e.target.value;P(t),(t.toLowerCase().includes("olak")||t.toLowerCase().includes("kozak"))&&(s.group("[PatientAutocomplete] DEBUG SEARCH FOR OLAK/KOZAK"),s.log("Input value:",t),s.log("Min search length:",v),s.log("Will trigger search:",t.trim().length>=v),s.groupEnd()),$(t),t.trim().length>=v?(E(!0),k(-1)):(E(!1),k(-1)),t.trim()||a(null)},[$,v,a]),B=o.useCallback(e=>{a(e),E(!1),k(-1),s.log("[PatientAutocomplete] Patient selected:",{id:e.id,name:`${e.cognome} ${e.nome}`})},[a]),H=o.useCallback(e=>{if(!y||0===M.length)return"ArrowDown"===e.key&&T.trim().length>=v&&(E(!0),k(0)),void 0;switch(e.key){case"ArrowDown":e.preventDefault(),k(e=>e<M.length-1?e+1:0);break;case"ArrowUp":e.preventDefault(),k(e=>e>0?e-1:M.length-1);break;case"Enter":e.preventDefault(),C>=0&&M[C]&&B(M[C]);break;case"Escape":e.preventDefault(),E(!1),k(-1),z.current?.blur()}},[y,M,C,T,v,B]),U=o.useCallback(()=>{T.trim().length>=v&&M.length>0&&E(!0)},[T,v,M.length]),X=o.useCallback(()=>{P(""),$(""),E(!1),k(-1),a(null),F()},[$,a,F]),V=o.useCallback(e=>q(`${e.cognome} ${e.nome}`,T),[T,q]),W=o.useCallback(e=>{const t=[];if(e.codice_rad&&t.push(`RAD: ${e.codice_rad}`),e.reparto_appartenenza&&t.push(e.reparto_appartenenza),e.data_ricovero){const a=new Date(e.data_ricovero);t.push(`Ric: ${a.toLocaleDateString("it-IT")}`)}return t.join(" • ")},[]);return o.useEffect(()=>{if(C>=0&&S.current){const e=S.current.children[C];e&&e.scrollIntoView({block:"nearest"})}},[C]),o.useEffect(()=>{if(!y||!S.current)return;const e=e=>{e.stopPropagation(),e.preventDefault();const t=e.currentTarget,a=S.current?.querySelectorAll('li[role="option"]');if(a){const e=Array.from(a).indexOf(t);e>=0&&M[e]&&B(M[e])}};let t=0;const a=()=>{if(!S.current)return;const n=S.current.querySelectorAll('li[role="option"]');n.length>0?n.forEach(t=>{t.addEventListener("click",e,!1)}):t<10&&(t++,setTimeout(a,50))};return a(),()=>{if(S.current){S.current.querySelectorAll('li[role="option"]').forEach(t=>{t.removeEventListener("click",e,!1)})}}},[y,M,B]),e.jsxs("div",{className:`patient-autocomplete position-relative ${i}`,ref:w,children:[e.jsxs("div",{className:"input-group",children:[e.jsx("input",{ref:z,id:j,type:"text",className:"form-control "+(r?"bg-light":""),placeholder:n,value:D,onChange:K,onKeyDown:H,onFocus:U,disabled:r,required:l,role:"combobox","aria-controls":N,"aria-expanded":y,"aria-autocomplete":"list","aria-busy":L,"aria-describedby":O?`${j}-error`:void 0}),D&&!r&&e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:X,"aria-label":"Cancella ricerca",children:e.jsx("i",{className:"bi bi-x-lg"})}),L&&e.jsx("span",{className:"input-group-text",children:e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"})})]}),O&&e.jsx("div",{id:`${j}-error`,className:"form-text text-danger mt-1",children:O}),y&&p.createPortal(e.jsxs("ul",{ref:S,id:N,className:"list-group shadow-sm",style:{position:"fixed",top:`${I.top}px`,left:`${I.left}px`,width:`${I.width}px`,maxHeight:"300px",overflowY:"auto",zIndex:9999,backgroundColor:"white",borderRadius:"0.25rem",border:"1px solid #dee2e6"},role:"listbox",children:[L&&e.jsxs("li",{className:"list-group-item text-muted",role:"presentation",children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Ricerca in corso..."]}),!L&&0===M.length&&T.trim().length>=v&&e.jsxs("li",{className:"list-group-item text-muted text-center py-3",role:"presentation",children:[e.jsx("i",{className:"bi bi-person-x fs-4 d-block mb-2"}),'Nessun paziente trovato per "',e.jsx("strong",{children:T}),'"']}),!L&&M.map((a,n)=>e.jsx("li",{role:"option",className:`list-group-item list-group-item-action cursor-pointer ${n===C?"active":""} ${t?.id===a.id?"border-primary":""}`,onMouseEnter:()=>k(n),"aria-selected":n===C,"data-patient-index":n,children:e.jsx("div",{className:"d-flex justify-content-between align-items-start",children:e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"fw-semibold",children:[V(a),t?.id===a.id&&e.jsx("i",{className:"bi bi-check-circle-fill text-primary ms-2","aria-label":"Selezionato"})]}),b&&e.jsx("div",{className:"small text-muted mt-1",children:W(a)}),a.diagnosi&&e.jsxs("div",{className:"small text-muted mt-1",children:[e.jsx("i",{className:"bi bi-clipboard2-pulse me-1"}),a.diagnosi]})]})})},a.id))]}),document.body)]})},_=["event-type","event-details","dates","notes","review"],f=({currentStep:t,getStepLabel:a,getStepNumber:n,totalSteps:i,selectedPatient:r})=>{const o=n(t),s=a(t);return e.jsxs("div",{className:"event-wizard-stepper",children:[e.jsx("div",{className:"event-wizard-stepper-progress",children:e.jsx("div",{className:"event-wizard-stepper-progress-bar",children:e.jsx("div",{className:"event-wizard-stepper-progress-fill",style:{width:`${o/i*100}%`},role:"progressbar","aria-valuenow":o,"aria-valuemin":1,"aria-valuemax":i,"aria-label":`Progresso: ${o} di ${i}`})})}),e.jsxs("div",{className:"event-wizard-stepper-info",children:[e.jsx("span",{className:"event-wizard-stepper-label",children:s}),e.jsxs("span",{className:"event-wizard-stepper-counter",children:[o," di ",i]}),r&&o>1&&e.jsxs("div",{className:"event-wizard-stepper-patient",children:[e.jsx("small",{className:"text-muted",children:"Paziente:"}),e.jsxs("strong",{children:[r.cognome," ",r.nome]})]})]}),e.jsx("div",{className:"event-wizard-stepper-dots d-md-none",children:_.map((n,i)=>{const r=i+1,s=a(n);return e.jsx("div",{className:`event-wizard-stepper-dot ${n===t?"active":""} ${i<o-1?"completed":""}`,"aria-label":`Step ${r}: ${s}`},n)})})]})},j=[{value:"batterico",label:"Batterico"},{value:"virale",label:"Virale"},{value:"fungino",label:"Fungino"},{value:"parassitario",label:"Parassitario"}],N={TEXTAREA_ROWS:{DESCRIPTION:4,NOTES:6},BREAKPOINTS:{MOBILE_MAX:991},DEBOUNCE:{PATIENT_SEARCH:300}},w={PLACEHOLDER:"Cerca per nome, cognome o RAD...",HELP_TEXT:"Seleziona un paziente per continuare",SELECTED:(e,t)=>`Paziente selezionato: ${e} ${t}`},z=({values:t,onChange:a,hasPatient:n=!0,selectedPatient:i=null,onSelectPatient:r,onPatientSelect:o})=>e.jsx("div",{className:"wizard-step","data-step":"event-type",children:e.jsxs("div",{className:"wizard-step-content",children:[!n&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"wizard-step-title",children:"Seleziona Paziente"}),e.jsxs("div",{className:"mb-4",children:[e.jsx(b,{value:i,onChange:e=>{r&&r(e?.id||""),o&&o(e)},placeholder:w.PLACEHOLDER,activeOnly:!1,maxResults:10,minSearchLength:1,debounceDelay:N.DEBOUNCE.PATIENT_SEARCH,showPatientInfo:!0,highlightMatch:!0}),i&&e.jsxs("div",{className:"alert alert-success mt-3",role:"alert",children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),w.SELECTED(i.cognome,i.nome)]}),!i&&e.jsxs("div",{className:"alert alert-info mt-3",role:"alert",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),w.HELP_TEXT]})]}),!i&&e.jsx("div",{style:{marginBottom:"2rem"}})]}),(n||i)&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"wizard-step-title",children:"Tipo di Evento"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona il tipo di evento clinico da registrare"}),e.jsx("div",{className:"event-type-selection",children:e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"event-type-card "+("intervento"===t.tipo_evento?"selected":""),onClick:()=>a({tipo_evento:"intervento"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),a({tipo_evento:"intervento"}))},children:[e.jsx("div",{className:"event-type-card-icon",children:e.jsx("i",{className:"bi bi-heart-pulse"})}),e.jsxs("div",{className:"event-type-card-content",children:[e.jsx("h4",{className:"event-type-card-title",children:"Intervento Chirurgico"}),e.jsx("p",{className:"event-type-card-description",children:"Registra un intervento chirurgico eseguito sul paziente"})]}),e.jsx("div",{className:"event-type-card-radio",children:e.jsx("input",{type:"radio",name:"tipo_evento",value:"intervento",checked:"intervento"===t.tipo_evento,onChange:()=>a({tipo_evento:"intervento"}),className:"form-check-input"})})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"event-type-card "+("infezione"===t.tipo_evento?"selected":""),onClick:()=>a({tipo_evento:"infezione"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),a({tipo_evento:"infezione"}))},children:[e.jsx("div",{className:"event-type-card-icon",children:e.jsx("i",{className:"bi bi-virus"})}),e.jsxs("div",{className:"event-type-card-content",children:[e.jsx("h4",{className:"event-type-card-title",children:"Infezione"}),e.jsx("p",{className:"event-type-card-description",children:"Registra un'infezione contratta dal paziente"})]}),e.jsx("div",{className:"event-type-card-radio",children:e.jsx("input",{type:"radio",name:"tipo_evento",value:"infezione",checked:"infezione"===t.tipo_evento,onChange:()=>a({tipo_evento:"infezione"}),className:"form-check-input"})})]})})]})})]})]})}),S=({values:t,onChange:a,errors:n,isSubmitting:i,tipiIntervento:r,agentiPatogeno:o,loadingTypes:s,loadingPatogens:l})=>{const c="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"event-details",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:c?"Dettagli Intervento":"Dettagli Infezione"}),e.jsx("p",{className:"wizard-step-description",children:c?"Specifica il tipo di intervento e la descrizione":"Specifica l'agente patogeno e il tipo"}),e.jsxs(e.Fragment,c?{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"tipo_intervento_id",className:"form-label",children:["Tipo Intervento ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("select",{id:"tipo_intervento_id",name:"tipo_intervento_id",className:"form-select "+(n?.tipo_intervento_id?"is-invalid":""),value:t.tipo_intervento_id?String(t.tipo_intervento_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):void 0;a({tipo_intervento_id:t})},disabled:i||s,required:!0,children:[e.jsx("option",{value:"",children:s?"Caricamento tipi intervento...":"Seleziona tipo intervento..."}),r.map(t=>e.jsx("option",{value:String(t.id),children:t.nome},t.id))]}),n?.tipo_intervento_id&&e.jsx("div",{className:"invalid-feedback",role:"alert",children:n.tipo_intervento_id})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"descrizione_intervento",className:"form-label",children:"Descrizione Dettagliata"}),e.jsx("textarea",{id:"descrizione_intervento",name:"descrizione_intervento",className:"form-control",value:t.descrizione_intervento||"",onChange:e=>a({descrizione_intervento:e.target.value}),disabled:i,rows:N.TEXTAREA_ROWS.DESCRIPTION,placeholder:"Descrivere dettagliatamente l'intervento eseguito..."}),e.jsx("div",{className:"form-text",children:"Opzionale - Fornire una descrizione dettagliata della procedura"})]})]}:{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"agente_patogeno_id",className:"form-label",children:["Agente Eziologico ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("select",{id:"agente_patogeno_id",name:"agente_patogeno_id",className:"form-select "+(n?.agente_patogeno_id?"is-invalid":""),value:t.agente_patogeno_id?String(t.agente_patogeno_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):void 0;a({agente_patogeno_id:t})},disabled:i||l,required:!0,children:[e.jsx("option",{value:"",children:l?"Caricamento agenti patogeno...":"Seleziona agente eziologico..."}),o.map(t=>e.jsx("option",{value:String(t.id),children:t.nome},t.id))]}),n?.agente_patogeno_id&&e.jsx("div",{className:"invalid-feedback",role:"alert",children:n.agente_patogeno_id}),e.jsx("div",{className:"form-text",children:"Selezionare l'agente responsabile dell'infezione"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"tipo_patogeno",className:"form-label",children:"Tipo Patogeno"}),e.jsxs("select",{id:"tipo_patogeno",name:"tipo_patogeno",className:"form-select",value:t.tipo_patogeno||"",onChange:e=>a({tipo_patogeno:e.target.value}),disabled:i,children:[e.jsx("option",{value:"",children:"Seleziona tipo patogeno..."}),j.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]}),e.jsx("div",{className:"form-text",children:"Opzionale - Specificare la categoria del patogeno"})]})]})]})})},y=({values:a,onChange:n,errors:i,isSubmitting:r,showResolutionDate:o,setShowResolutionDate:s})=>{const l="intervento"===a.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"dates",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Date Evento"}),e.jsx("p",{className:"wizard-step-description",children:l?"Specifica quando è stato eseguito l'intervento":"Specifica le date di inizio e fine dell'infezione"}),l?e.jsx("div",{className:"mb-3",children:e.jsx(t,{label:"Data Intervento",value:a.data_evento||"",onChange:e=>n({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:r,isInvalid:!!i?.data_evento,errorMessage:i?.data_evento})}):e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-12 mb-3",children:e.jsx(t,{label:"Data Inizio",value:a.data_evento||"",onChange:e=>n({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:r,isInvalid:!!i?.data_evento,errorMessage:i?.data_evento})}),e.jsxs("div",{className:"col-12 mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2 gap-2",children:[e.jsx("label",{htmlFor:"toggle_resolution",className:"form-label mb-0",children:"Data Fine"}),e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"toggle_resolution",checked:o,onChange:e=>{s(e.target.checked),e.target.checked||n({data_fine_evento:""})},disabled:r}),e.jsx("label",{className:"form-check-label",htmlFor:"toggle_resolution",children:"Infezione risolta"})]})]}),o&&e.jsx(t,{value:a.data_fine_evento||"",onChange:e=>n({data_fine_evento:e||""}),placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:r,isInvalid:!!i?.data_fine_evento,errorMessage:i?.data_fine_evento})]})]})]})})},E=({values:t,onChange:a,isSubmitting:n})=>{const i="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"notes",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Note Aggiuntive"}),e.jsx("p",{className:"wizard-step-description",children:"Aggiungi informazioni o osservazioni rilevanti (opzionale)"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"note",className:"form-label",children:i?"Note Aggiuntive":"Note Cliniche"}),e.jsx("textarea",{id:"note",name:"note",className:"form-control",value:t.note||"",onChange:e=>a({note:e.target.value}),disabled:n,rows:N.TEXTAREA_ROWS.NOTES,placeholder:i?"Note aggiuntive sull'intervento...":"Sintomi, terapia, esami, decorso...","aria-describedby":"note-help"}),e.jsxs("div",{id:"note-help",className:"form-text",children:["Opzionale - ",i?"Informazioni aggiuntive sull'intervento":"Informazioni cliniche rilevanti"]})]})]})})},C=({values:t,tipiIntervento:a,agentiPatogeno:n})=>{const i="intervento"===t.tipo_evento,r=o.useMemo(()=>a.find(e=>e.id===t.tipo_intervento_id)?.nome,[a,t.tipo_intervento_id]),s=o.useMemo(()=>n.find(e=>e.id===t.agente_patogeno_id)?.nome,[n,t.agente_patogeno_id]);return e.jsx("div",{className:"wizard-step","data-step":"review",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Riepilogo"}),e.jsx("p",{className:"wizard-step-description",children:"Verifica i dati inseriti prima di salvare"}),e.jsxs("div",{className:"event-review-summary",children:[e.jsxs("div",{className:"alert alert-light",children:[e.jsx("h5",{className:"alert-heading",children:i?"Intervento Chirurgico":"Infezione"}),e.jsx("hr",{}),e.jsxs(e.Fragment,i?{children:[e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Tipo Intervento:"})," ",e.jsx("span",{children:r||"Non specificato"})]}),t.descrizione_intervento&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Descrizione:"})," ",e.jsx("span",{children:t.descrizione_intervento})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Intervento:"})," ",e.jsx("span",{children:t.data_evento||"Non specificata"})]})]}:{children:[e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Agente Eziologico:"})," ",e.jsx("span",{children:s||"Non specificato"})]}),t.tipo_patogeno&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Tipo Patogeno:"})," ",e.jsx("span",{children:j.find(e=>e.value===t.tipo_patogeno)?.label})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Inizio:"})," ",e.jsx("span",{children:t.data_evento||"Non specificata"})]}),t.data_fine_evento&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Fine:"})," ",e.jsx("span",{children:t.data_fine_evento})]})]}),t.note&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Note:"})," ",e.jsx("span",{children:t.note})]})]}),e.jsxs("div",{className:"alert alert-info",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),"Verifica che tutti i dati siano corretti. Puoi tornare indietro per modificare qualsiasi campo prima di salvare."]})]})]})})},k=["event-type","event-details","dates","notes","review"],D={"event-type":"Tipo Evento","event-details":"Dettagli",dates:"Date",notes:"Note",review:"Riepilogo"},P=({patientId:t,event:p,onSubmit:m,onCancel:g})=>{const x=!!p,b=((e="event-type")=>a({steps:k,labels:D,initialStep:e}))("event-type"),_=n({currentStep:b.currentStep,getStepLabel:b.getStepLabel,totalSteps:b.totalSteps,currentStepNumber:b.getStepNumber(b.currentStep),enabled:!1});i();const{patient:j}=(e=>{const{data:t,isLoading:a,error:n}=h({queryKey:["patient",e],queryFn:async()=>{if(!e)return null;try{const t=await u.getPatientById(e);if(t){const a={id:t.id,nome:t.nome,cognome:t.cognome};return s.info("Patient loaded successfully",{patientId:e}),a}return s.warn("Patient not found",{patientId:e}),l("Paziente non trovato",{duration:3e3}),null}catch(t){const a=t instanceof Error?t:new Error(String(t));throw s.error("Error loading patient data",{patientId:e,error:a}),c("Errore nel caricamento del paziente",{duration:5e3}),a}},enabled:!!e,staleTime:3e5});return{patient:t||null,loading:a,error:n instanceof Error?n:null}})(t),{tipiIntervento:N,agentiPatogeno:w,loading:P}=(()=>{const{data:e,isLoading:t,error:a}=h({queryKey:["eventLookupTables"],queryFn:async()=>{try{const[e,t]=await Promise.all([v.getListaTipiIntervento(),v.getListaAgentiPatogeno()]);return s.info("Event lookup tables loaded successfully",{tipiCount:e.length,agentiCount:t.length}),{tipi:e,agenti:t}}catch(e){const t=e instanceof Error?e:new Error(String(e));throw s.error("Error loading event lookup tables",{error:t}),c("Impossibile caricare i dati. Riprova più tardi.",{duration:5e3}),t}},staleTime:6e5}),n=e?.tipi||[],i=e?.agenti||[],r=o.useMemo(()=>new Map(n.map(e=>[e.id,e.nome])),[n]),l=o.useMemo(()=>new Map(i.map(e=>[e.id,e.nome])),[i]);return{tipiIntervento:n,agentiPatogeno:i,loading:t,error:a instanceof Error?a:null,tipiInterventoMap:r,agentiPatogeniMap:l}})(),[I,R]=o.useState(t||""),[T,$]=o.useState(j),[A,L]=o.useState({paziente_id:I,tipo_evento:p?.tipo_evento||"intervento",data_evento:p?.data_evento||"",tipo_intervento_id:p?.tipo_intervento_id??void 0,descrizione_intervento:p?.descrizione_intervento||"",agente_patogeno_id:p?.agente_patogeno_id??void 0,tipo_patogeno:p?.tipo_patogeno??void 0,data_fine_evento:p?.data_fine_evento||"",note:p?.note||""}),[O,F]=o.useState(!!p?.data_fine_evento),[M,q]=o.useState({}),[K,B]=o.useState(!1);d.useEffect(()=>{j&&$(j)},[j]);const H=e=>{R(e),L(t=>({...t,paziente_id:e}))},U=e=>{$(e)},X=e=>{L(t=>({...t,...e}));const t=Object.keys(e);t.some(e=>M[e])&&q(e=>{const a={...e};return t.forEach(e=>delete a[e]),a})},V=()=>{switch(b.currentStep){case"event-type":return!!I&&!!A.tipo_evento;case"event-details":return"intervento"===A.tipo_evento?!!A.tipo_intervento_id:"infezione"===A.tipo_evento&&!!A.agente_patogeno_id;case"dates":return!!A.data_evento;case"notes":case"review":return!0;default:return!1}};return e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),!(()=>{const e={};if(!I)return e.paziente_id="Seleziona un paziente",q(e),!1;if(A.tipo_evento||(e.tipo_evento="Seleziona il tipo di evento"),"intervento"===A.tipo_evento&&(A.tipo_intervento_id||(e.tipo_intervento_id="Il tipo di intervento è obbligatorio"),A.data_evento||(e.data_evento="La data dell'intervento è obbligatoria")),"infezione"===A.tipo_evento){A.agente_patogeno_id||(e.agente_patogeno_id="Il tipo di batterio è obbligatorio"),A.data_evento||(e.data_evento="La data di inizio infezione è obbligatoria");const t=r(A.data_evento,O?A.data_fine_evento:void 0,"infezione");t&&(e.data_evento=t)}if("intervento"===A.tipo_evento){A.data_evento||(e.data_evento="La data dell'intervento è obbligatoria");const t=r(A.data_evento,void 0,"intervento");t&&(e.data_evento=t)}return q(e),0===Object.keys(e).length})())return b.goToStep("event-type"),void 0;try{B(!0);const e={paziente_id:I,tipo_evento:A.tipo_evento,data_evento:A.data_evento,note:A.note};"intervento"===A.tipo_evento&&(e.tipo_intervento_id=A.tipo_intervento_id,e.descrizione_intervento=A.descrizione_intervento),"infezione"===A.tipo_evento&&(e.agente_patogeno_id=A.agente_patogeno_id,e.tipo_patogeno=A.tipo_patogeno,O&&(e.data_fine_evento=A.data_fine_evento)),await m(e)}catch(t){s.error("Errore durante il salvataggio del evento",{error:t}),c("Errore durante il salvataggio. Riprova più tardi.",{duration:5e3}),B(!1)}},className:"wizard-form event-wizard-form",noValidate:!0,children:[e.jsxs("div",{className:"wizard-form-header",children:[e.jsx("button",{type:"button",className:"wizard-back-button",onClick:g,disabled:K,"aria-label":"Torna indietro",children:e.jsx("i",{className:"bi bi-arrow-left"})}),e.jsx("h1",{className:"wizard-form-title",children:x?"Modifica Evento":"Nuovo Evento"})]}),e.jsx(f,{currentStep:b.currentStep,getStepLabel:b.getStepLabel,getStepNumber:b.getStepNumber,totalSteps:b.totalSteps,selectedPatient:T}),e.jsx("div",{ref:_,className:"wizard-form-content",children:(()=>{const t=!!I,a={values:A,onChange:X,errors:M,isSubmitting:K};switch(b.currentStep){case"event-type":return e.jsx(z,{...a,hasPatient:t,selectedPatient:T,onSelectPatient:H,onPatientSelect:U});case"event-details":return e.jsx(S,{...a,tipiIntervento:N,agentiPatogeno:w,loadingTypes:P,loadingPatogens:P});case"dates":return e.jsx(y,{...a,showResolutionDate:O,setShowResolutionDate:F});case"notes":return e.jsx(E,{...a});case"review":return e.jsx(C,{...a,tipiIntervento:N,agentiPatogeno:w,loadingTypes:P,loadingPatogens:P});default:return null}})()}),e.jsxs("div",{className:"wizard-form-actions",children:[b.canGoPrev&&e.jsxs("button",{type:"button",className:"btn btn-secondary btn-block",onClick:b.prevStep,disabled:K,children:[e.jsx("i",{className:"bi bi-chevron-left"})," Indietro"]}),"review"!==b.currentStep?e.jsxs("button",{type:"button",className:"btn btn-primary btn-block",onClick:b.nextStep,disabled:K||!V(),title:V()?void 0:"Completa i campi obbligatori per continuare",children:["Avanti ",e.jsx("i",{className:"bi bi-chevron-right"})]}):e.jsx("button",{type:"submit",className:"btn btn-success btn-block",disabled:K,children:e.jsxs(e.Fragment,K?{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio..."]}:{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),x?"Aggiorna Evento":"Salva Evento"]})})]})]})};export{P as E,N as F,b as P};
