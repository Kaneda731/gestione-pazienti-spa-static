const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ConfirmModal-BGl6_Lcm.js","assets/index-3IpvjS9T.js","assets/supabase-AmyKTmiY.js","assets/vendor-BU6HxVpN.js","assets/index-CIUH-r2y.css","assets/infectionDataManager-BMqDmlOT.js","assets/index-B6ar2qdR.js","assets/lookupService-DhOISCst.js","assets/patientService-DKDslI8e.js"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-AmyKTmiY.js";import{s as t,l as n,n as a,a as i,c as o}from"./index-3IpvjS9T.js";import{i as r,C as s,u as c}from"./CustomSelect-BDJKwdbT.js";import l from"./CustomDatepicker-6By5cdaM.js";import{e as d,i as m}from"./infectionDataManager-BMqDmlOT.js";import{p as u}from"./post-operative-calculator-C3z7C_vm.js";import{ResolveInfectionModal as p}from"./ResolveInfectionModal-BnJfMhRW.js";import{Modal as v}from"./vendor-BU6HxVpN.js";import g from"./surgeryDataManager-CbtGeuzn.js";import{l as f}from"./lookupService-DhOISCst.js";import"./utils-BtSsRyB2.js";async function y(){const{data:e,error:a}=await t.from("diagnosi").select("nome").order("nome",{ascending:!0});if(a)throw n.error("Error loading diagnosi options:",a),new Error("Impossibile caricare le opzioni di diagnosi.");return e||[]}async function h(e){if(!e)return null;const{data:a,error:i}=await t.from("pazienti").select("*").eq("id",e).single();if(i)throw n.error("Error loading patient for editing:",i),new Error("Impossibile caricare i dati del paziente.");return a}async function _(e,a){const i={};let o;if(Object.keys(e).forEach(t=>{""!==e[t]&&null!=e[t]&&(i[t]=e[t])}),i.infetto=Boolean(i.infetto),o=a?await t.from("pazienti").update(i).eq("id",a).select().single():await t.from("pazienti").insert(i).select().single(),o.error)throw n.error("Error saving patient:",o.error),new Error(`Errore durante il salvataggio: ${o.error.message}`);return o.data}let E=null,I=null,b=[],z=null;function w(e){z=e,function(){const e=document.getElementById("add-evento-btn");e&&e.addEventListener("click",D);[document.getElementById("cancel-evento-btn"),document.getElementById("cancel-evento-btn-2")].forEach(e=>{e&&e.addEventListener("click",S)});const t=document.getElementById("save-evento-btn");t&&t.addEventListener("click",x);const n=document.getElementById("evento-tipo");n&&n.addEventListener("change",e=>{$(e.target.value)});const a=document.getElementById("eventi-clinici-tab");a&&a.addEventListener("shown.bs.tab",()=>{T()})}(),function(){r("#evento-tipo");const e=document.getElementById("evento-tipo-intervento");e&&!e.customSelectInstance&&new s(e);E=new l("#evento-data",{dateFormat:"d/m/Y",allowInput:!0,maxDate:"today",onChange:function(e,t,n){if(e.length>0){const t=e[0],i=new Date;i.setHours(23,59,59,999),t>i&&(n.clear(),a.warning("La data dell'evento non può essere nel futuro"))}}})}()}function D(){const e=document.getElementById("nuovo-evento-form");e&&(e.style.display="block",B(),e.scrollIntoView({behavior:"smooth",block:"start"}))}function S(){const e=document.getElementById("nuovo-evento-form");e&&(e.style.display="none",B())}function B(){if(!document.getElementById("nuovo-evento-form"))return;document.getElementById("evento-id").value="",document.getElementById("evento-tipo").value="",document.getElementById("evento-data").value="",document.getElementById("evento-tipo-intervento").value="",document.getElementById("evento-agente-patogeno").value="",document.getElementById("evento-descrizione").value="",$("");const e=document.getElementById("evento-tipo");e?.customSelectInstance&&e.customSelectInstance.setValue("");const t=document.getElementById("evento-tipo-intervento");t?.customSelectInstance&&t.customSelectInstance.setValue("")}function $(e){const t=document.getElementById("tipo-intervento-container"),n=document.getElementById("agente-patogeno-container");t&&(t.style.display="none"),n&&(n.style.display="none");const a=document.getElementById("evento-tipo-intervento"),i=document.getElementById("evento-agente-patogeno");switch(a&&(a.value="",a.customSelectInstance&&a.customSelectInstance.setValue("")),i&&(i.value=""),e){case"intervento":t&&(t.style.display="block",console.log("Inizializzando CustomSelect per tipo intervento"),a&&!a.customSelectInstance&&new s(a));break;case"infezione":n&&(n.style.display="block")}}async function x(){try{const e=function(){const e=document.getElementById("evento-data").value;let t=null;if(e&&""!==e.trim())try{t=function(e){if(!e)return null;if(e.match(/^\d{4}-\d{2}-\d{2}$/))return e;if(!e.includes("/"))throw new Error("Formato data non valido. Utilizzare il formato gg/mm/aaaa");const t=e.split("/");if(3!==t.length)throw new Error("Formato data non valido. Utilizzare il formato gg/mm/aaaa");const[n,a,i]=t,o=parseInt(n,10),r=parseInt(a,10),s=parseInt(i,10);if(isNaN(o)||isNaN(r)||isNaN(s))throw new Error("Formato data non valido. Utilizzare numeri validi");if(o<1||o>31)throw new Error("Giorno non valido (1-31)");if(r<1||r>12)throw new Error("Mese non valido (1-12)");if(s<1900||s>2100)throw new Error("Anno non valido");const c=new Date(s,r-1,o);if(c.getDate()!==o||c.getMonth()!==r-1||c.getFullYear()!==s)throw new Error("Data non valida (es. 31/02/2025)");const l=a.padStart(2,"0"),d=n.padStart(2,"0");return`${i}-${l}-${d}`}(e.trim())}catch(a){throw new Error(a.message||"Formato data non valido. Utilizzare il formato gg/mm/aaaa")}const n={id:document.getElementById("evento-id").value||null,tipo_evento:document.getElementById("evento-tipo").value,data_evento:t,descrizione:document.getElementById("evento-descrizione").value,tipo_intervento:document.getElementById("evento-tipo-intervento").value||null,agente_patogeno:document.getElementById("evento-agente-patogeno").value||null};return Object.keys(n).forEach(e=>{""!==n[e]&&null!==n[e]||(n[e]=null)}),n}(),t=function(e){if(!e.tipo_evento)return{isValid:!1,message:"Seleziona il tipo di evento"};if(!e.data_evento)return{isValid:!1,message:"Inserisci la data dell'evento"};try{const t=new Date(e.data_evento+"T00:00:00");if(isNaN(t.getTime()))return{isValid:!1,message:"Formato data non valido"};const n=new Date,a=new Date(n.getFullYear(),n.getMonth(),n.getDate());if(new Date(t.getFullYear(),t.getMonth(),t.getDate())>a)return{isValid:!1,message:"La data dell'evento non può essere nel futuro"}}catch(t){return{isValid:!1,message:"Errore nella validazione della data: "+t.message}}if("intervento"===e.tipo_evento&&!e.tipo_intervento)return{isValid:!1,message:"Seleziona il tipo di intervento"};return{isValid:!0}}(e);if(!t.isValid)return a.error(t.message),void 0;if(!I)return!function(e){try{const t={...e,id:`temp_manual_${Date.now()}`,isTemporary:!0};b||(b=[]),b=b.filter(t=>!t.isTemporary||t.tipo_evento!==e.tipo_evento),b.push(t),L(b),S(),N(),a.success("Evento aggiunto temporaneamente. Verrà salvato quando salvi il paziente.")}catch(t){n.error("Errore nella gestione evento temporaneo:",t.message),a.error("Errore nell'aggiungere l'evento temporaneo")}}(e),void 0;e.paziente_id=I,e.id?await d.updateEvento(e.id,e):(delete e.id,await d.createEvento(e)),await T(),S(),N();const i=document.getElementById("eventi-list");i&&(i.style.opacity="0.7",setTimeout(()=>{i.style.opacity="1"},150))}catch(e){n.error("Errore catturato in handleSaveEvento:",e.message)}}function k(e){if(!e||!e.includes("-"))return e;const[t,n,a]=e.split("-");return`${a}/${n}/${t}`}async function T(){if(I)try{const e=await d.getEventiByPaziente(I);b=e,L(e),C(e),"function"==typeof z&&z(),N()}catch(e){n.error("Errore nel caricamento eventi clinici per il paziente:",e)}}function L(t){const a=document.getElementById("eventi-list"),o=document.getElementById("no-eventi-message");if(!t||0===t.length)return o&&(o.style.display="block"),a.innerHTML='<div class="text-center text-muted py-4">Nessun evento clinico registrato</div>',o&&a.appendChild(o),void 0;let r;o&&(o.style.display="none");try{r=t.map(e=>{const t=k(e.data_evento),n="intervento"===e.tipo_evento?"medical_services":"coronavirus",a="intervento"===e.tipo_evento?"primary":"warning";let i="";"infezione"===e.tipo_evento&&e.data_fine_evento&&(i=`<span class="badge bg-success ms-2">Risolto il ${k(e.data_fine_evento)}</span>`),e.isTemporary&&(i+='<span class="badge bg-info ms-2">\n                <span class="material-icons me-1" style="font-size: 12px;">schedule</span>Da salvare\n            </span>');const o=e.isTemporary;return`\n            <div class="card mb-3 evento-card" data-evento-id="${e.id}">\n                <div class="card-body">\n                    <div class="d-flex justify-content-between align-items-start">\n                        <div class="flex-grow-1">\n                            <div class="d-flex align-items-center mb-2">\n                                <span class="badge bg-${a} me-2">\n                                    <span class="material-icons me-1" style="font-size: 14px;">${n}</span>\n                                    ${"intervento"===e.tipo_evento?"Intervento":"Infezione"}\n                                </span>\n                                <small class="text-muted">${t}</small>\n                                ${i}\n                            </div>\n                            \n                            ${e.tipo_intervento?`<p class="mb-1"><strong>Tipo:</strong> ${e.tipo_intervento}</p>`:""}\n                            ${e.agente_patogeno?`<p class="mb-1"><strong>Agente:</strong> ${e.agente_patogeno}</p>`:""}\n                            ${e.descrizione?`<p class="mb-0 text-muted">${e.descrizione}</p>`:""}\n                        </div>\n                        \n                        <div class="dropdown">\n                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" ${o?"disabled":""}>\n                                <span class="material-icons" style="font-size: 16px;">more_vert</span>\n                            </button>\n                            ${o?'\n                            <ul class="dropdown-menu">\n                                <li><span class="dropdown-item-text text-muted">\n                                    <span class="material-icons me-2" style="font-size: 16px;">info</span>\n                                    Evento temporaneo - Salva il paziente per renderlo definitivo\n                                </span></li>\n                            </ul>\n                            ':`\n                            <ul class="dropdown-menu">\n                                <li><a class="dropdown-item edit-evento" href="#" data-evento-id="${e.id}">\n                                    <span class="material-icons me-2" style="font-size: 16px;">edit</span>Modifica\n                                </a></li>\n                                ${"infezione"!==e.tipo_evento||"infezione"===e.tipo_evento&&e.data_fine_evento?"":`\n                                <li><a class="dropdown-item resolve-infezione" href="#" data-evento-id="${e.id}" data-start-date="${e.data_evento}">\n                                    <span class="material-icons me-2" style="font-size: 16px;">check_circle</span>Risolvi\n                                </a></li>\n                                `}\n                                <li><a class="dropdown-item delete-evento text-danger" href="#" data-evento-id="${e.id}">\n                                    <span class="material-icons me-2" style="font-size: 16px;">delete</span>Elimina\n                                </a></li>\n                            </ul>\n                            `}\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `}).join("")}catch(s){n.error("Errore durante generazione HTML eventi:",s),r='<div class="alert alert-danger">Errore nel caricamento eventi</div>'}a.innerHTML=i(r),a.querySelectorAll(".edit-evento").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();!function(e){const t=b.find(t=>t.id===e);if(!t)return;D(),setTimeout(()=>{document.getElementById("evento-id").value=t.id,document.getElementById("evento-data").value=k(t.data_evento),document.getElementById("evento-descrizione").value=t.descrizione||"",document.getElementById("evento-tipo-intervento").value=t.tipo_intervento||"",document.getElementById("evento-agente-patogeno").value=t.agente_patogeno||"";const e=document.getElementById("evento-tipo");e?.customSelectInstance&&t.tipo_evento?e.customSelectInstance.setValue(t.tipo_evento):document.getElementById("evento-tipo").value=t.tipo_evento,$(t.tipo_evento),setTimeout(()=>{const e=document.getElementById("evento-tipo-intervento");e?.customSelectInstance&&t.tipo_intervento&&e.customSelectInstance.setValue(t.tipo_intervento)},100)},50)}(e.currentTarget.dataset.eventoId)})}),a.querySelectorAll(".delete-evento").forEach(t=>{t.addEventListener("click",t=>{t.preventDefault();!async function(t){const{ConfirmModal:a}=await e(async()=>{const{ConfirmModal:e}=await import("./ConfirmModal-BGl6_Lcm.js");return{ConfirmModal:e}},__vite__mapDeps([0,1,2,3,4])),i=a.forClinicalEventDeletion();if(!(await i.show()))return;try{await d.deleteEvento(t),await T(),N()}catch(s){n.error("Errore catturato in deleteEvento:",s.message)}}(t.currentTarget.dataset.eventoId)})}),a.querySelectorAll(".resolve-infezione").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();!async function(e,t){const a=new p({minDate:t}),i=await a.show();if(i)try{await d.resolveInfezione(e,i),await T()}catch(s){n.error("Errore catturato durante la risoluzione dell'infezione:",s)}}(e.currentTarget.dataset.eventoId,e.currentTarget.dataset.startDate)})})}function C(e){const t=document.getElementById("post-op-info"),n=document.getElementById("post-op-text");if(!e||0===e.length)return t.classList.add("d-none"),void 0;const a=u.calculatePostOperativeDays(e);a.hasInterventions?(t.classList.remove("d-none"),n.textContent=a.displayText,t.className="alert d-flex align-items-center",t.classList.add(a.postOperativeDays<=7?"alert-danger":a.postOperativeDays<=30?"alert-warning":"alert-info")):t.classList.add("d-none")}function P(){return!(!b||0===b.length)&&b.some(e=>"infezione"===e.tipo_evento&&!e.data_fine_evento)}function N(){const e=document.getElementById("infetto"),t=document.getElementById("ha_intervento");if(!e||!t)return;const n=P(),a=b&&b.some(e=>"intervento"===e.tipo_evento);if(n){e.checked=!0,e.disabled=!0;const t=document.getElementById("infetto-helper-text");t&&(t.textContent="Stato gestito dagli eventi di infezione attivi.",t.style.display="block")}else{e.disabled=!1;const t=document.getElementById("infetto-helper-text");t&&(t.style.display="none")}if(a){t.checked=!0,t.disabled=!0;const e=document.getElementById("intervento-helper-text");e&&(e.textContent="Stato gestito dagli eventi di intervento presenti.",e.style.display="block")}else{t.disabled=!1;const e=document.getElementById("intervento-helper-text");e&&(e.style.display="none")}"function"==typeof window.updateInfectionIndicator&&window.updateInfectionIndicator(),"function"==typeof window.updateSurgeryIndicator&&window.updateSurgeryIndicator()}function V(e){I=e;const t=document.getElementById("eventi-clinici-tab");t&&t.classList.contains("active")&&T()}function M(){E&&(E.destroy(),E=null),I=null,b=[]}const j=Object.freeze(Object.defineProperty({__proto__:null,cleanupEventiCliniciTab:M,createTemporaryEventsFromCheckboxes:function(){e(async()=>{const{default:e}=await import("./infectionDataManager-BMqDmlOT.js").then(e=>e.a);return{default:e}},__vite__mapDeps([5,1,2,3,4])).then(({default:t})=>{e(async()=>{const{default:e}=await import("./surgeryDataManager-CbtGeuzn.js");return{default:e}},[]).then(({default:e})=>{const n=[];if(t.hasValidInfectionData()){const e=t.getInfectionData();n.push({id:"temp_infection",tipo_evento:"infezione",data_evento:e.data_evento,agente_patogeno:e.agente_patogeno,descrizione:e.descrizione,data_fine_evento:null,isTemporary:!0})}if(e.hasValidSurgeryData()){const t=e.getSurgeryData();n.push({id:"temp_surgery",tipo_evento:"intervento",data_evento:t.data_evento,tipo_intervento:t.tipo_intervento,descrizione:t.descrizione,isTemporary:!0}),t.has_infection&&t.data_infezione&&n.push({id:"temp_surgery_infection",tipo_evento:"infezione",data_evento:t.data_infezione,agente_patogeno:t.agente_patogeno,descrizione:t.descrizione_infezione,data_fine_evento:null,isTemporary:!0})}const a=[...b||[],...n];L(a),C(a)})})},getTemporaryEvents:function(){return b?b.filter(e=>e.isTemporary):[]},initEventiCliniciTab:w,isPatientCurrentlyInfected:P,loadEventiForCurrentPatient:T,setCurrentPatient:V,syncCheckboxesWithEvents:N},Symbol.toStringTag,{value:"Module"}));class q{constructor(e={}){this.options={title:"Registra Infezione",patientName:"",defaultDate:(new Date).toISOString().split("T")[0],...e},this.modalId=`infection-modal-${Date.now()}`,this.datepickerInstance=null}show(){return new Promise(e=>{const t=this.render();document.body.insertAdjacentHTML("beforeend",t);const n=document.getElementById(this.modalId),a=n.querySelector("form"),i=new v(n);this.datepickerInstance=new l(`#${this.modalId} [data-datepicker]`,{defaultDate:this.options.defaultDate,maxDate:"today"});a.addEventListener("submit",t=>{t.preventDefault();const o=new FormData(a),r=this.datepickerInstance.instances[0]?.selectedDates[0],s={data_evento:r?r.toISOString().split("T")[0]:null,agente_patogeno:o.get("agente_patogeno"),descrizione:o.get("descrizione")};return s.agente_patogeno?s.data_evento?(this._defocus(n),i.hide(),e(s),void 0):(alert("La data di infezione è obbligatoria."),void 0):(alert("L'agente patogeno è obbligatorio."),void 0)}),n.addEventListener("hide.bs.modal",()=>{this._defocus(n)}),n.addEventListener("hidden.bs.modal",()=>{this.datepickerInstance&&this.datepickerInstance.destroy(),n.remove(),e(null)}),i.show()})}render(){const e=this.options.patientName?`${this.options.title} per <strong>${i(this.options.patientName)}</strong>`:this.options.title;return`\n            <div class="modal fade" id="${this.modalId}" tabindex="-1" aria-labelledby="infectionModalLabel" aria-hidden="true">\n                <div class="modal-dialog modal-dialog-centered">\n                    <div class="modal-content">\n                        <form>\n                            <div class="modal-header">\n                                <h5 class="modal-title" id="infectionModalLabel">${e}</h5>\n                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                            </div>\n                            <div class="modal-body">\n                                <div class="mb-3">\n                                    <label for="data_evento" class="form-label">Data Infezione</label>\n                                    <div class="input-group-icon">\n                                        <input type="text" class="form-control" id="data_evento" name="data_evento" data-datepicker placeholder="gg/mm/aaaa" required>\n                                        <span class="material-icons input-icon">calendar_today</span>\n                                    </div>\n                                </div>\n                                <div class="mb-3">\n                                    <label for="agente_patogeno" class="form-label">Agente Patogeno</label>\n                                    <input type="text" class="form-control" id="agente_patogeno" name="agente_patogeno" placeholder="Es. Staphylococcus aureus" required>\n                                </div>\n                                <div class="mb-3">\n                                    <label for="descrizione" class="form-label">Descrizione (opzionale)</label>\n                                    <textarea class="form-control" id="descrizione" name="descrizione" rows="3" placeholder="Dettagli aggiuntivi sull'infezione..."></textarea>\n                                </div>\n                            </div>\n                            <div class="modal-footer">\n                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>\n                                <button type="submit" class="btn btn-primary">Salva Evento</button>\n                            </div>\n                        </form>\n                    </div>\n                </div>\n            </div>\n        `}_defocus(e){try{const t=document.activeElement;t&&e.contains(t)&&"function"==typeof t.blur&&t.blur()}catch{}}}class O{constructor(e={}){this.options={title:"Dati Intervento Chirurgico",patientName:"",defaultDate:(new Date).toISOString().split("T")[0],...e},this.modal=null,this.datepicker=null,this.resolve=null,this.reject=null}show(){return new Promise((e,t)=>{this.resolve=e,this.reject=t,this.createModal(),this.showModal()})}createModal(){const e="surgery-event-modal",t=document.getElementById(e);t&&t.remove();const n=`\n            <div class="modal fade" id="${e}" tabindex="-1" aria-labelledby="${e}-label" aria-hidden="true">\n                <div class="modal-dialog modal-lg">\n                    <div class="modal-content">\n                        <div class="modal-header bg-primary text-white">\n                            <h5 class="modal-title" id="${e}-label">\n                                <span class="material-icons me-2">medical_services</span>\n                                ${this.options.title}\n                            </h5>\n                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>\n                        </div>\n                        <div class="modal-body">\n                            ${this.options.patientName?`\n                                <div class="alert alert-info d-flex align-items-center mb-3">\n                                    <span class="material-icons me-2">person</span>\n                                    <span><strong>Paziente:</strong> ${i(this.options.patientName)}</span>\n                                </div>\n                            `:""}\n                            \n                            <form id="surgery-event-form">\n                                <div class="row g-3">\n                                    <div class="col-md-6">\n                                        <label for="surgery-data-evento" class="form-label">\n                                            Data Intervento <span class="text-danger">*</span>\n                                        </label>\n                                        <div class="input-group-icon">\n                                            <input\n                                                type="text"\n                                                class="form-control"\n                                                id="surgery-data-evento"\n                                                name="data_evento"\n                                                data-datepicker\n                                                placeholder="gg/mm/aaaa"\n                                                required\n                                            />\n                                            <span class="material-icons input-icon">calendar_today</span>\n                                        </div>\n                                        <small class="form-text text-muted">\n                                            Data in cui è stato eseguito l'intervento\n                                        </small>\n                                    </div>\n\n                                    <div class="col-md-6">\n                                        <label for="surgery-tipo-intervento" class="form-label">\n                                            Tipo Intervento <span class="text-danger">*</span>\n                                        </label>\n                                        <select\n                                            class="form-select"\n                                            id="surgery-tipo-intervento"\n                                            name="tipo_intervento"\n                                            data-custom="true"\n                                            required\n                                        >\n                                            <option value="">Seleziona tipo...</option>\n                                            <option value="Chirurgia Ortopedica">Chirurgia Ortopedica</option>\n                                            <option value="Chirurgia Plastica">Chirurgia Plastica</option>\n                                            <option value="Chirurgia Vascolare">Chirurgia Vascolare</option>\n                                            <option value="Chirurgia Generale">Chirurgia Generale</option>\n                                            <option value="Chirurgia Cardiaca">Chirurgia Cardiaca</option>\n                                            <option value="Neurochirurgia">Neurochirurgia</option>\n                                            <option value="Chirurgia Toracica">Chirurgia Toracica</option>\n                                            <option value="Altro">Altro</option>\n                                        </select>\n                                    </div>\n\n                                    <div class="col-12">\n                                        <label for="surgery-descrizione" class="form-label">\n                                            Descrizione Intervento\n                                        </label>\n                                        <textarea\n                                            class="form-control"\n                                            id="surgery-descrizione"\n                                            name="descrizione"\n                                            rows="3"\n                                            placeholder="Descrizione dettagliata dell'intervento eseguito..."\n                                        ></textarea>\n                                        <small class="form-text text-muted">\n                                            Descrizione opzionale dell'intervento\n                                        </small>\n                                    </div>\n\n                                    \x3c!-- Sezione Infezione Post-Operatoria --\x3e\n                                    <div class="col-12">\n                                        <hr class="my-3">\n                                        <h6 class="mb-3">\n                                            <span class="material-icons me-2">coronavirus</span>\n                                            Infezione Post-Operatoria\n                                        </h6>\n                                        \n                                        <div class="form-check form-switch mb-3">\n                                            <input\n                                                class="form-check-input"\n                                                type="checkbox"\n                                                id="surgery-has-infection"\n                                                name="has_infection"\n                                            />\n                                            <label class="form-check-label" for="surgery-has-infection">\n                                                Paziente ha sviluppato infezione post-operatoria\n                                            </label>\n                                        </div>\n\n                                        \x3c!-- Campi Infezione (nascosti di default) --\x3e\n                                        <div id="surgery-infection-fields" class="d-none">\n                                            <div class="row g-3">\n                                                <div class="col-md-6">\n                                                    <label for="surgery-data-infezione" class="form-label">\n                                                        Data Inizio Infezione\n                                                    </label>\n                                                    <div class="input-group-icon">\n                                                        <input\n                                                            type="text"\n                                                            class="form-control"\n                                                            id="surgery-data-infezione"\n                                                            name="data_infezione"\n                                                            data-datepicker\n                                                            placeholder="gg/mm/aaaa"\n                                                        />\n                                                        <span class="material-icons input-icon">calendar_today</span>\n                                                    </div>\n                                                </div>\n\n                                                <div class="col-md-6">\n                                                    <label for="surgery-agente-patogeno" class="form-label">\n                                                        Agente Patogeno\n                                                    </label>\n                                                    <input\n                                                        type="text"\n                                                        class="form-control"\n                                                        id="surgery-agente-patogeno"\n                                                        name="agente_patogeno"\n                                                        placeholder="Es. Staphylococcus aureus"\n                                                    />\n                                                </div>\n\n                                                <div class="col-12">\n                                                    <label for="surgery-descrizione-infezione" class="form-label">\n                                                        Descrizione Infezione\n                                                    </label>\n                                                    <textarea\n                                                        class="form-control"\n                                                        id="surgery-descrizione-infezione"\n                                                        name="descrizione_infezione"\n                                                        rows="2"\n                                                        placeholder="Descrizione dell'infezione post-operatoria..."\n                                                    ></textarea>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </form>\n                        </div>\n                        <div class="modal-footer">\n                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">\n                                <span class="material-icons me-1">cancel</span>\n                                Annulla\n                            </button>\n                            <button type="button" class="btn btn-primary" id="surgery-save-btn">\n                                <span class="material-icons me-1">save</span>\n                                Salva Dati\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",n),this.modal=document.getElementById(e),this.setupEventListeners(),this.initializeComponents()}setupEventListeners(){this.modal.querySelector("#surgery-save-btn").addEventListener("click",()=>this.handleSave());this.modal.querySelector("#surgery-has-infection").addEventListener("change",e=>{this.toggleInfectionFields(e.target.checked)}),this.modal.addEventListener("hidden.bs.modal",()=>{this.resolve&&this.resolve(null),this.cleanup()});this.modal.querySelector("#surgery-event-form").addEventListener("submit",e=>{e.preventDefault(),this.handleSave()})}initializeComponents(){this.datepicker=new l("#surgery-data-evento, #surgery-data-infezione",{dateFormat:"d/m/Y",allowInput:!0,maxDate:"today"}),r("#surgery-tipo-intervento");const e=this.modal.querySelector("#surgery-data-evento");if(this.options.defaultDate){const[t,n,a]=this.options.defaultDate.split("-");e.value=`${a}/${n}/${t}`}}toggleInfectionFields(e){const t=this.modal.querySelector("#surgery-infection-fields");if(e){t.classList.remove("d-none");const e=this.modal.querySelector("#surgery-data-evento"),n=this.modal.querySelector("#surgery-data-infezione");e.value&&!n.value&&(n.value=e.value)}else t.classList.add("d-none"),this.modal.querySelector("#surgery-data-infezione").value="",this.modal.querySelector("#surgery-agente-patogeno").value="",this.modal.querySelector("#surgery-descrizione-infezione").value=""}showModal(){new bootstrap.Modal(this.modal,{backdrop:"static",keyboard:!1}).show()}handleSave(){const e=this.getFormData(),t=this.validateData(e);if(!t.isValid)return this.showValidationErrors(t.errors),void 0;bootstrap.Modal.getInstance(this.modal).hide(),this.resolve&&(this.resolve(e),this.resolve=null)}getFormData(){const e=this.modal.querySelector("#surgery-event-form"),t=new FormData(e),n=Object.fromEntries(t.entries());if(n.data_evento&&n.data_evento.includes("/")){const[e,t,a]=n.data_evento.split("/");n.data_evento=`${a}-${t.padStart(2,"0")}-${e.padStart(2,"0")}`}if(this.modal.querySelector("#surgery-has-infection").checked){if(n.has_infection=!0,n.data_infezione&&n.data_infezione.includes("/")){const[e,t,a]=n.data_infezione.split("/");n.data_infezione=`${a}-${t.padStart(2,"0")}-${e.padStart(2,"0")}`}}else n.has_infection=!1,delete n.data_infezione,delete n.agente_patogeno,delete n.descrizione_infezione;return n}validateData(e){const t=[];if(e.data_evento||t.push("La data dell'intervento è obbligatoria"),e.tipo_intervento||t.push("Il tipo di intervento è obbligatorio"),e.data_evento){const n=new Date(e.data_evento),a=new Date;a.setHours(23,59,59,999),isNaN(n.getTime())?t.push("Data intervento non valida"):n>a&&t.push("La data dell'intervento non può essere nel futuro")}if(e.has_infection)if(e.data_infezione){const n=new Date(e.data_infezione),a=new Date(e.data_evento);isNaN(n.getTime())?t.push("Data infezione non valida"):n<a&&t.push("La data dell'infezione non può essere precedente all'intervento")}else t.push("La data di inizio infezione è obbligatoria se si indica un'infezione");return{isValid:0===t.length,errors:t}}showValidationErrors(e){this.modal.querySelectorAll(".validation-error").forEach(e=>e.remove());const t=`\n            <div class="alert alert-danger validation-error">\n                <strong>Errori di validazione:</strong>\n                <ul class="mb-0 mt-2">\n                    ${e.map(e=>`<li>${i(e)}</li>`).join("")}\n                </ul>\n            </div>\n        `;this.modal.querySelector(".modal-body").insertAdjacentHTML("afterbegin",t)}cleanup(){this.datepicker&&(this.datepicker.destroy(),this.datepicker=null),this.modal&&(this.modal.remove(),this.modal=null),this.resolve=null,this.reject=null}}let A=null;async function F(){await async function(){try{const e=[],t=document.getElementById("codice_dimissione");t&&e.push(f.populateCodiciDimissioneSelect(t));const n=document.getElementById("reparto_destinazione");n&&e.push(f.populateRepartiSelect(n,null,"interno"));const a=document.getElementById("codice_clinica");a&&e.push(f.populateClinicheSelect(a)),await Promise.all(e)}catch(e){console.error("Errore nel caricamento dati lookup:",e),a.error("Errore nel caricamento delle opzioni del form")}}(),r('#form-inserimento [data-custom="true"]'),A=new l("[data-datepicker]",{dateFormat:"d/m/Y",allowInput:!0}),function(){const e=document.getElementById("tipo_dimissione");e&&e.addEventListener("change",e=>{R(e.target.value)});const t=document.getElementById("nome"),n=document.getElementById("cognome");t&&n&&[t,n].forEach(e=>{e.addEventListener("input",W)})}(),function(){const e=document.getElementById("infetto"),t=document.querySelector('label[for="infetto"]');if(!e||!t)return;e.addEventListener("change",async e=>{if(e.target.checked){const t=await U();t?(m.setInfectionData(t),J(),K()):(e.target.checked=!1,m.clearInfectionData(),J(),K())}else!function(){m.clearInfectionData(),J();const e=document.getElementById("infetto");e&&e.checked&&(e.checked=!1);K()}(),K()}),J()}(),function(){const e=document.getElementById("ha_intervento"),t=document.querySelector('label[for="ha_intervento"]');if(!e||!t)return;e.addEventListener("change",async e=>{if(e.target.checked){const t=await Y();t?(g.setSurgeryData(t),G(),K()):(e.target.checked=!1,g.clearSurgeryData(),G(),K())}else!function(){g.clearSurgeryData(),G();const e=document.getElementById("ha_intervento");e&&e.checked&&(e.checked=!1);K()}(),K()}),G()}(),w(H)}function R(e){const t=document.getElementById("reparto-destinazione-container"),n=document.getElementById("clinica-destinazione-container"),a=document.getElementById("codice-clinica-container");switch(t.style.display="none",n.style.display="none",a.style.display="none",document.getElementById("reparto_destinazione").value="",document.getElementById("clinica_destinazione").value="",document.getElementById("codice_clinica").value="",e){case"trasferimento_interno":t.style.display="block";break;case"trasferimento_esterno":n.style.display="block",a.style.display="block"}setTimeout(()=>{if("trasferimento_interno"===e){const e=document.getElementById("reparto_destinazione");e&&!e.customSelectInstance&&r("#reparto_destinazione")}else if("trasferimento_esterno"===e){const e=document.getElementById("codice_clinica");e&&!e.customSelectInstance&&r("#codice_clinica")}},50)}function H(){const e=document.getElementById("infetto"),t=document.getElementById("infetto-helper-text");if(!e||!t)return;const n=P(),a=m.hasValidInfectionData();n?(e.checked=!0,e.disabled=!0,t.textContent="Stato gestito dagli eventi di infezione attivi.",t.style.display="block",a&&(m.clearInfectionData(),J())):(e.disabled=!1,e.checked=a,t.style.display="none",J())}function W(){const e=document.getElementById("inserimento-title");if(!e)return;const t=document.getElementById("nome"),n=document.getElementById("cognome"),a=document.getElementById("paziente-id");if(a&&a.value){const a=`${t?t.value.trim():""} ${n?n.value.trim():""}`.trim();e.innerHTML=i(a?`<span class="material-icons text-primary me-2">person</span><span class="patient-name fw-bold">${a}</span>`:'<span class="material-icons text-primary me-2">person</span>Nome Cognome')}else e.innerHTML=i('<span class="material-icons me-2">person_add</span>Inserimento Nuovo Paziente')}async function Y(){const e=document.getElementById("nome"),t=document.getElementById("cognome"),n=e&&t?`${e.value.trim()} ${t.value.trim()}`.trim():"",i=g.getSurgeryData(),o=new O({title:"Dati Intervento Chirurgico",patientName:n||"Nuovo Paziente",defaultDate:i?.data_evento||(new Date).toISOString().split("T")[0]});try{return await o.show()}catch(r){return console.error("Errore nella modal di intervento:",r),a.error("Errore nell'apertura della modal di intervento"),null}}async function U(){const e=document.getElementById("nome"),t=document.getElementById("cognome"),n=e&&t?`${e.value.trim()} ${t.value.trim()}`.trim():"",i=m.getInfectionData(),o=new q({title:"Dati Infezione Paziente",patientName:n||"Nuovo Paziente",defaultDate:i?.data_evento||(new Date).toISOString().split("T")[0]});try{return await o.show()}catch(r){return console.error("Errore nella modal di infezione:",r),a.error("Errore nell'apertura della modal di infezione"),null}}function G(){const e=document.querySelector('label[for="ha_intervento"]'),t=document.getElementById("ha_intervento");if(!e||!t)return;const n=e.querySelector(".surgery-data-badge");if(n&&n.remove(),g.hasSurgeryData()){const t=g.hasValidSurgeryData(),n=document.createElement("span");n.className="badge ms-2 surgery-data-badge "+(t?"bg-success":"bg-warning"),n.innerHTML=t?'<span class="material-icons" style="font-size: 12px;">check_circle</span> Dati inseriti':'<span class="material-icons" style="font-size: 12px;">warning</span> Dati incompleti',e.appendChild(n);const a=g.getSurgeryData();if(a){n.title=`Data: ${a.data_evento||"Non specificata"}\nTipo: ${a.tipo_intervento||"Non specificato"}${a.has_infection?" + Infezione":""}`}n.style.cursor="pointer",n.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const t=await Y();t&&(g.setSurgeryData(t),G())})}}function J(){const e=document.querySelector('label[for="infetto"]'),t=document.getElementById("infetto");if(!e||!t)return;const n=e.querySelector(".infection-data-badge");if(n&&n.remove(),m.hasInfectionData()){const t=m.hasValidInfectionData(),n=document.createElement("span");n.className="badge ms-2 infection-data-badge "+(t?"bg-success":"bg-warning"),n.innerHTML=t?'<span class="material-icons" style="font-size: 12px;">check_circle</span> Dati inseriti':'<span class="material-icons" style="font-size: 12px;">warning</span> Dati incompleti',e.appendChild(n);const a=m.getInfectionData();a&&(n.title=`Data: ${a.data_evento||"Non specificata"}\nAgente: ${a.agente_patogeno||"Non specificato"}`),n.style.cursor="pointer",n.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const t=await U();t&&(m.setInfectionData(t),J())})}}function K(){e(async()=>{const{createTemporaryEventsFromCheckboxes:e}=await Promise.resolve().then(()=>j);return{createTemporaryEventsFromCheckboxes:e}},void 0).then(({createTemporaryEventsFromCheckboxes:e})=>{e()}).catch(e=>{console.warn("Impossibile aggiornare la tab eventi clinici:",e)})}async function Q(){const t=document.getElementById("form-inserimento"),n=new FormData(t),a=Object.fromEntries(n.entries()),i=P(),o=m.hasValidInfectionData(),r=g.hasValidSurgeryData(),s=r&&g.hasAssociatedInfection();if(a.infetto=i||o||s,o&&!i){const e=m.getInfectionData();a._hasInfectionData=!0,a._infectionData=e,a._requiresInfectionEvent=!0}if(r){const e=g.getSurgeryData();a._hasSurgeryData=!0,a._surgeryData=e,a._requiresSurgeryEvent=!0}["data_nascita","data_ricovero","data_dimissione","data_infezione","data_evento"].forEach(e=>{if(a[e]&&a[e].includes("/")){const[t,n,i]=a[e].split("/");a[e]=`${i}-${n.padStart(2,"0")}-${t.padStart(2,"0")}`}else a[e]?console.log(`Data ${e} già in formato corretto: ${a[e]}`):console.log(`Data ${e} vuota o non presente`)}),Object.keys(a).forEach(e=>{""!==a[e]&&null!=a[e]||(a[e]=null)});const c=a.tipo_dimissione;"trasferimento_interno"!==c&&(a.reparto_destinazione=null,a.reparto_destinazione_id=null),"trasferimento_esterno"!==c&&(a.clinica_destinazione=null,a.codice_clinica=null,a.clinica_destinazione_id=null),delete a.ha_intervento;return["nome","cognome","data_ricovero"].forEach(e=>{a[e]&&""!==a[e].toString().trim()||console.error(`Campo obbligatorio mancante: ${e}`,a)}),await async function(t){try{const{codiciDimissioneService:n,repartiService:a,clinicheService:i}=await e(async()=>{const{codiciDimissioneService:e,repartiService:t,clinicheService:n}=await import("./index-B6ar2qdR.js");return{codiciDimissioneService:e,repartiService:t,clinicheService:n}},__vite__mapDeps([6,7,1,2,3,4]));if(t.codice_dimissione&&!isNaN(t.codice_dimissione)){const e=await n.getById(parseInt(t.codice_dimissione));e&&(t.codice_dimissione_id=parseInt(t.codice_dimissione),t.codice_dimissione=e.codice)}if(t.reparto_destinazione&&!isNaN(t.reparto_destinazione)){const e=await a.getById(parseInt(t.reparto_destinazione));e&&(t.reparto_destinazione_id=parseInt(t.reparto_destinazione),t.reparto_destinazione=e.nome)}if(t.codice_clinica&&!isNaN(t.codice_clinica)){const e=await i.getById(parseInt(t.codice_clinica));e&&(t.clinica_destinazione_id=parseInt(t.codice_clinica),t.codice_clinica=e.codice)}}catch(n){console.error("Errore nella conversione campi normalizzati:",n)}}(a),a}function X(e,t){switch(t){case"success":a.success(e);break;case"error":a.error(e);break;case"warning":a.warning(e);break;default:a.info(e)}}async function Z(){const t=document.getElementById("form-inserimento");if(!t)return console.error("Elemento form #form-inserimento non trovato!"),void 0;const n=function(){const e=sessionStorage.getItem("editPazienteId");return e?{mode:"edit",patientId:e}:{mode:"create",patientId:null}}(),a=t=>async function(t,n){t.preventDefault();const a=await Q();try{X("Salvataggio in corso...","info");const t={},i={};let r;if(Object.keys(a).forEach(e=>{e.startsWith("_")?i[e]=a[e]:t[e]=a[e]}),"edit"===n.mode){if(r=await _(t,n.patientId),i._hasInfectionData&&i._infectionData){const{patientService:t}=await e(async()=>{const{patientService:e}=await import("./patientService-DKDslI8e.js");return{patientService:e}},__vite__mapDeps([8,2,1,3,4,5]));await t.handleInfectionEventCreation(n.patientId,i._infectionData)}const{getTemporaryEvents:a}=await e(async()=>{const{getTemporaryEvents:e}=await Promise.resolve().then(()=>j);return{getTemporaryEvents:e}},void 0),o=a();if(o&&o.length>0){const{patientService:t}=await e(async()=>{const{patientService:e}=await import("./patientService-DKDslI8e.js");return{patientService:e}},__vite__mapDeps([8,2,1,3,4,5]));await t.handleTemporaryEventsCreation(n.patientId,o)}}else{const n=i._hasInfectionData&&i._infectionData,a=i._hasSurgeryData&&i._surgeryData;if(n||a){const{patientService:o}=await e(async()=>{const{patientService:e}=await import("./patientService-DKDslI8e.js");return{patientService:e}},__vite__mapDeps([8,2,1,3,4,5]));n&&a?r=(await o.createPatientWithSurgeryAndInfection(t,i._surgeryData,i._infectionData)).patient:a?r=(await o.createPatientWithSurgery(t,i._surgeryData)).patient:n&&(r=(await o.createPatientWithInfection(t,i._infectionData)).patient)}else{const{getTemporaryEvents:n}=await e(async()=>{const{getTemporaryEvents:e}=await Promise.resolve().then(()=>j);return{getTemporaryEvents:e}},void 0),a=n();if(a&&a.length>0){const{patientService:n}=await e(async()=>{const{patientService:e}=await import("./patientService-DKDslI8e.js");return{patientService:e}},__vite__mapDeps([8,2,1,3,4,5]));r=(await n.createPatientWithTemporaryEvents(t,a)).patient}else r=await _(t,null)}}if(r&&r.id){const{setCurrentPatient:t}=await e(async()=>{const{setCurrentPatient:e}=await Promise.resolve().then(()=>j);return{setCurrentPatient:e}},void 0);t(r.id)}X(`Paziente ${"edit"===n.mode?"aggiornato":"inserito"} con successo!`,"success"),setTimeout(()=>o("list"),1500)}catch(i){X(i.message,"danger")}}(t,n);try{const[o,r]=await Promise.all([y(),"edit"===n.mode?h(n.patientId):Promise.resolve(null)]);!function(e){const t=document.getElementById("diagnosi");t&&(t.innerHTML=i('<option value="">Seleziona diagnosi...</option>'),e.forEach(e=>{const n=document.createElement("option");n.value=e.nome,n.textContent=e.nome,t.appendChild(n)}),c("#diagnosi"))}(o);const s=document.getElementById("inserimento-title");if(s&&(r?(s.innerHTML=`\n          <span class="patient-name fw-bold">${r.nome} ${r.cognome}</span>\n        `,function(e){if(!e)return;const t=(e,t)=>{const n=document.getElementById(e);n?"checkbox"===n.type?n.checked=Boolean(t):n.value=t||"":console.warn(`Elemento con ID '${e}' non trovato durante populateForm`)},n=e=>{if(!e)return"";if(e.includes("-")){const[t,n,a]=e.split("-");return`${a}/${n}/${t}`}return e};t("paziente-id",e.id),t("nome",e.nome),t("cognome",e.cognome),t("data_nascita",n(e.data_nascita)),t("data_ricovero",n(e.data_ricovero)),t("data_dimissione",n(e.data_dimissione)),t("diagnosi",e.diagnosi),t("reparto_appartenenza",e.reparto_appartenenza),t("reparto_provenienza",e.reparto_provenienza),t("livello_assistenza",e.livello_assistenza),t("codice_rad",e.codice_rad),t("infetto",e.infetto),t("tipo_dimissione",e.tipo_dimissione),t("clinica_destinazione",e.clinica_destinazione),t("reparto_destinazione",e.reparto_destinazione_id||e.reparto_destinazione),t("codice_clinica",e.clinica_destinazione_id||e.codice_clinica),t("codice_dimissione",e.codice_dimissione_id||e.codice_dimissione),R(e.tipo_dimissione||""),m.clearInfectionData(),g.clearSurgeryData(),J(),G(),V(e.id);const a=`${e.nome||""} ${e.cognome||""}`.trim(),o=a?`<span class="patient-name fw-bold">${a}</span>`:'<span class="patient-name fw-bold">Nome Cognome</span>';document.getElementById("inserimento-title").innerHTML=i(o),document.getElementById("save-patient-btn").innerHTML=i('<span class="material-icons me-1" style="vertical-align: middle;">save</span>Aggiorna Paziente'),c('#form-inserimento [data-custom="true"]')}(r)):s.innerHTML='\n          <span class="material-icons text-primary me-2">person_add</span>Inserimento Nuovo Paziente\n        '),F(),"edit"===n.mode&&n.patientId){const{setCurrentPatient:t}=await e(async()=>{const{setCurrentPatient:e}=await Promise.resolve().then(()=>j);return{setCurrentPatient:e}},void 0);t(n.patientId)}t.addEventListener("submit",a)}catch(r){X(r.message,"danger")}return()=>{A&&(A.destroy(),A=null),m.clearInfectionData(),g.clearSurgeryData(),void M(),sessionStorage.removeItem("editPazienteId"),t.removeEventListener("submit",a)}}export{Z as initInserimentoView};
