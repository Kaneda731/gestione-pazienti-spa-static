import{s as e,a as t,n as r}from"./index-kmkWUIqe.js";import{g as n,p as a}from"./helpers-x6jexb_e.js";import{_ as i}from"./supabase-AmyKTmiY.js";import{R as o,c as l,g as s,a as c,d,b as u}from"./chartjsService-eCPZngdw.js";import p from"./CustomDatepicker-6By5cdaM.js";import{i as f,u as m}from"./CustomSelect-CrgYxVDy.js";import"./vendor-BU6HxVpN.js";import"./utils-BtSsRyB2.js";async function g(){try{const[e,t,r]=await Promise.all([n("reparto_appartenenza"),n("reparto_provenienza"),n("diagnosi")]);return{repartoOptions:e,provenienzaOptions:t,diagnosiOptions:r}}catch(e){throw console.error("Errore nel recuperare le opzioni dei filtri:",e),new Error("Impossibile caricare le opzioni per i filtri.")}}const h=Object.freeze(Object.defineProperty({__proto__:null,getChartData:async function(t){let r=e.from("pazienti").select("diagnosi");t.reparto&&(r=r.eq("reparto_appartenenza",t.reparto)),t.provenienza&&(r=r.eq("reparto_provenienza",t.provenienza)),t.diagnosi&&(r=r.eq("diagnosi",t.diagnosi)),t.assistenza&&(r=r.eq("livello_assistenza",t.assistenza)),"true"===t.infetto&&(r=r.eq("infetto",!0)),"false"===t.infetto&&(r=r.eq("infetto",!1)),t.startDate&&(r=r.gte("data_ricovero",t.startDate)),t.endDate&&(r=r.lte("data_ricovero",t.endDate));const{data:n,error:a}=await r;if(a)throw console.error("Errore nel recuperare i dati del grafico:",a),new Error("Impossibile caricare i dati per il grafico.");return(n||[]).filter(e=>e&&"object"==typeof e&&e.diagnosi&&null!==e.diagnosi&&""!==String(e.diagnosi).trim())},getFilterOptionsForChart:g},Symbol.toStringTag,{value:"Module"}));let v=null,y=null,z="pie",E=null;const b={get chartContainer(){return document.getElementById("chart-container")},get chartControls(){return document.getElementById("chart-controls")},get chartTypeSelector(){return document.getElementById("chart-type-selector")},get chartExportBtn(){return document.getElementById("chart-export-btn")},get chartShareBtn(){return document.getElementById("chart-share-btn")},get repartoFilter(){return document.getElementById("filter-reparto")},get provenienzaFilter(){return document.getElementById("filter-provenienza")},get diagnosiFilter(){return document.getElementById("filter-diagnosi")},get assistenzaFilter(){return document.getElementById("filter-assistenza")},get infettoFilter(){return document.getElementById("filter-infetto")},get startDateFilter(){return document.getElementById("filter-start-date")},get endDateFilter(){return document.getElementById("filter-end-date")},get applyButton(){return document.getElementById("apply-filters-btn")},get resetButton(){return document.getElementById("reset-filters-btn")}};async function w(){try{const t=[{id:"chart-container",name:"Container del grafico"},{id:"filter-reparto",name:"Filtro reparto"},{id:"filter-provenienza",name:"Filtro provenienza"},{id:"filter-diagnosi",name:"Filtro diagnosi"}];for(const e of t)document.getElementById(e.id)||console.warn(`Elemento ${e.name} (${e.id}) non trovato nel DOM`);document.querySelector("#filter-reparto, #filter-provenienza, #filter-diagnosi, #filter-assistenza, #filter-infetto")&&f("#filter-reparto, #filter-provenienza, #filter-diagnosi, #filter-assistenza, #filter-infetto");if(document.querySelectorAll("[data-datepicker]").length>0&&(v=new p("[data-datepicker]",{dateFormat:"d/m/Y"})),E=new o,await async function(){await async function(){try{const e=await s();if(!b.chartTypeSelector){const t=document.querySelector(".filters-fieldset .row.mt-3 .col-12.d-flex.justify-content-center"),r=document.createElement("div");r.className="chart-type-selector-container ms-0 ms-md-3 mt-3 mt-md-0";const n=document.createElement("select");n.id="chart-type-selector",n.className="form-select form-select-sm",n.setAttribute("data-custom","true"),e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,t.setAttribute("data-icon",e.icon),n.appendChild(t)}),n.value=z,n.addEventListener("change",C),r.appendChild(n),t&&t.appendChild(r),f("#chart-type-selector"),setTimeout(()=>{m("#chart-type-selector")},100),document.addEventListener("chartTypeChange",F)}}catch(e){console.error("Errore nell'inizializzazione del selettore del tipo di grafico:",e)}}(),function(){const e=document.getElementById("chart-buttons-container");if(!e)return;const t=document.createElement("div");t.className="chart-export-buttons d-inline-flex gap-2";const r=document.createElement("button");r.id="chart-export-btn",r.className="btn btn-sm btn-outline-primary",r.innerHTML='<span class="material-icons">download</span> Esporta',r.addEventListener("click",I);const n=document.createElement("button");n.id="chart-share-btn",n.className="btn btn-sm btn-outline-secondary",n.innerHTML='<span class="material-icons">share</span> Condividi',n.addEventListener("click",B),t.appendChild(r),t.appendChild(n),e.appendChild(t)}()}(),b.chartContainer)try{E.adaptLayout(b.chartContainer)}catch(e){console.error("Errore nell'adattamento del layout:",e)}else console.warn("Container del grafico non trovato, impossibile adattare il layout");_()}catch(t){console.error("Errore nell'inizializzazione della UI del grafico:",t),j(`Errore nell'inizializzazione: ${t.message}`)}}function C(e){if(z=e.target.value,y){T(S())}}function F(e){const t=e.detail.direction,r=["pie","bar","line"],n=r.indexOf(z);let a;a="next"===t?(n+1)%r.length:0===n?r.length-1:n-1;const i=r[a];z=i;const o=b.chartTypeSelector;if(o&&(o.value=i,o.customSelectInstance?o.customSelectInstance.setValue(i):m("#chart-type-selector")),y){T(S())}}async function I(){if(!y)return r.warning("Nessun grafico da esportare. Genera prima un grafico."),void 0;try{const e=S(),t={timestamp:(new Date).toLocaleString(),filters:e};await d(y,"grafico-pazienti",t)}catch(e){console.error("Errore nell'esportazione del grafico:",e),r.error(`Errore nell'esportazione: ${e.message}`)}}async function B(){if(!y)return r.warning("Nessun grafico da condividere. Genera prima un grafico."),void 0;try{const e=S(),t=await u(e,z);await navigator.clipboard.writeText(t),r.success("Link copiato negli appunti!")}catch(e){console.error("Errore nella condivisione del grafico:",e),r.error(`Errore nella condivisione: ${e.message}`)}}function D(){v&&(v.destroy(),v=null),document.removeEventListener("chartTypeChange",F),l(),y&&(y.destroy(),y=null)}function S(){return{reparto:b.repartoFilter.value,provenienza:b.provenienzaFilter.value,diagnosi:b.diagnosiFilter.value,assistenza:b.assistenzaFilter.value,infetto:b.infettoFilter.value,startDate:b.startDateFilter.value,endDate:b.endDateFilter.value}}function x(){["filter-reparto","filter-provenienza","filter-diagnosi","filter-assistenza","filter-infetto"].forEach(e=>{const t=document.getElementById(e);t&&(t.value="",t.customSelectInstance&&t.customSelectInstance.setValue(""))}),b.startDateFilter.value="",b.endDateFilter.value="",_()}async function L(e){if(!b.chartContainer)return console.error("Container del grafico non trovato"),null;if(!e||!Array.isArray(e))return console.warn("Dati non validi per il grafico:",e),k("Dati non validi per visualizzare il grafico."),null;const{labels:t,dataPoints:r}=function(e){if(!e||0===e.length)return{labels:[],dataPoints:[]};const t=new Map;return e.forEach(({diagnosi:e})=>{const r=e?String(e).trim():"Non specificata";r&&t.set(r,(t.get(r)||0)+1)}),{labels:Array.from(t.keys()),dataPoints:Array.from(t.values())}}(e);if(0===t.length)return k("Nessun dato valido per visualizzare il grafico."),null;const n={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!1,text:"",font:{size:18,weight:"bold"}},legend:{position:E&&"function"==typeof E.detectDevice&&"desktop"===E.detectDevice()?"right":"top",onHover:function(e,t,r){},onClick:function(e,t,r){}}}};"bar"===z&&(n.scales={y:{beginAtZero:!0,ticks:{precision:0}},x:{ticks:{maxRotation:45,minRotation:0}}},n.plugins.tooltip={enabled:!1});try{if(y)try{y.destroy()}catch(a){console.warn("Errore durante la distruzione del grafico precedente:",a)}if(y=await c(b.chartContainer,{labels:t,datasets:[{label:"Numero di Pazienti",data:r}]},n,z),E&&y)try{"function"==typeof E.handleResize&&E.handleResize(y,n),y.update()}catch(i){console.error("Errore durante l'adattamento del grafico:",i)}b.chartExportBtn&&(b.chartExportBtn.disabled=!1),b.chartShareBtn&&(b.chartShareBtn.disabled=!1);try{document.dispatchEvent(new CustomEvent("chartUpdated",{detail:{chart:y}}))}catch(o){console.warn("Errore durante la generazione dell'evento chartUpdated:",o)}return y}catch(l){return console.error("Errore durante la creazione del grafico:",l),j(`Errore nella visualizzazione del grafico: ${l.message}`),null}}async function T(e){void(b.chartContainer.innerHTML=t('<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>'));try{const{getChartData:t}=await i(async()=>{const{getChartData:e}=await Promise.resolve().then(()=>h);return{getChartData:e}},void 0),r=await t(e);await L(r)}catch(r){console.error("Errore nel ridisegno del grafico:",r);try{const e=[{diagnosi:"Influenza"},{diagnosi:"Polmonite"},{diagnosi:"Frattura"},{diagnosi:"Influenza"},{diagnosi:"Polmonite"},{diagnosi:"Frattura"},{diagnosi:"Infarto"},{diagnosi:"Ictus"},{diagnosi:"Diabete"}];await L(e)}catch(n){console.error("Errore anche con i dati di fallback:",n),j(`Errore nell'aggiornamento del grafico: ${r.message}`)}}}function _(){b.chartContainer.innerHTML=t('<p class="text-muted">Seleziona i filtri e clicca "Applica" per visualizzare il grafico.</p>')}function k(e){b.chartContainer.innerHTML=t(`<p class="text-muted">${e}</p>`)}function j(e){b.chartContainer.innerHTML=t(`<div class="alert alert-danger">${e}</div>`)}async function O(){const e=S();try{await T(e)}catch(t){j(t.message)}}async function A(){w();try{!function(e){a(b.repartoFilter,e.repartoOptions),m("#filter-reparto"),a(b.provenienzaFilter,e.provenienzaOptions),m("#filter-provenienza"),a(b.diagnosiFilter,e.diagnosiOptions),m("#filter-diagnosi"),b.infettoFilter&&(b.infettoFilter.innerHTML=t('\n            <option value="">Tutti</option>\n            <option value="true">Sì</option>\n            <option value="false">No</option>\n        '),m("#filter-infetto"))}(await g())}catch(e){console.error("Errore durante l'inizializzazione della vista grafico:",e),j(e.message||"Errore durante il caricamento dei filtri.")}return b.applyButton.addEventListener("click",O),void b.resetButton.addEventListener("click",x),D}export{A as initGraficoView};
