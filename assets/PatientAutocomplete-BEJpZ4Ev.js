import{l as t,n as e,p as n}from"./index-sw_W3wV3.js";import{patientService as i}from"./patientService-kdtGKTVT.js";class s{constructor(t={}){this.options={title:"Nessun dato trovato",description:"",icon:"inbox",actionText:"",actionCallback:null,...t}}render(){const t=this.options.actionText?this.renderActionButton():"";return`\n            <div class="text-center text-muted py-5">\n                <span class="material-icons mb-3" style="font-size: 4rem; opacity: 0.5;">${this.options.icon}</span>\n                <h5>${this.options.title}</h5>\n                ${this.options.description?`<p>${this.options.description}</p>`:""}\n                ${t}\n            </div>\n        `}renderForTable(t=7){return`\n            <tr>\n                <td colspan="${t}" class="text-center text-muted py-4">\n                    <div class="d-flex align-items-center justify-content-center flex-column">\n                        <span class="material-icons mb-2" style="font-size: 2rem; opacity: 0.5;">${this.options.icon}</span>\n                        <div>${this.options.title}</div>\n                        ${this.options.description?`<small>${this.options.description}</small>`:""}\n                    </div>\n                </td>\n            </tr>\n        `}renderForCards(){const t=this.options.actionText?this.renderActionButton():"";return`\n            <div class="text-center text-muted p-4">\n                <div class="d-flex align-items-center justify-content-center flex-column">\n                    <span class="material-icons mb-3" style="font-size: 3rem; opacity: 0.5;">${this.options.icon}</span>\n                    <h6>${this.options.title}</h6>\n                    ${this.options.description?`<p class="small">${this.options.description}</p>`:""}\n                    ${t}\n                </div>\n            </div>\n        `}renderCompact(){return`\n            <div class="text-center text-muted py-3">\n                <span class="material-icons me-2" style="font-size: 1.5rem; opacity: 0.5;">${this.options.icon}</span>\n                <span>${this.options.title}</span>\n            </div>\n        `}renderActionButton(){return`\n            <button class="btn btn-primary mt-3" onclick="this.dispatchEvent(new CustomEvent('action'))">\n                ${this.options.actionText}\n            </button>\n        `}static forNoPatients(){return new s({title:"Nessun paziente trovato",description:"Non ci sono pazienti che corrispondono ai criteri di ricerca.",icon:"person_off",actionText:"Aggiungi nuovo paziente"})}static forNoDiagnosis(){return new s({title:"Nessuna diagnosi trovata",description:"Non ci sono diagnosi disponibili nel sistema.",icon:"medical_services",actionText:"Aggiungi diagnosi"})}static forSearchResults(t){return new s({title:"Nessun risultato",description:`Nessun paziente corrisponde alla ricerca "${t}".`,icon:"search_off"})}static forFilteredResults(){return new s({title:"Nessun risultato",description:"Nessun paziente corrisponde ai filtri applicati.",icon:"filter_list_off",actionText:"Rimuovi filtri"})}}const r=new Map;function o(t=[]){return t.map(t=>({id:t.id,nome:t.nome,cognome:t.cognome,codice_rad:t.codice_rad,stato:t.stato??t.status??null,nomeCompleto:[t.cognome,t.nome].filter(Boolean).join(" ")}))}async function a(n,{activeOnly:s=!1,limit:a=20}={}){try{const e=function(t,e){return`${(t||"").trim().toLowerCase()}::${e?"1":"0"}`}(n,s),c=function(t){const e=r.get(t);return e?Date.now()>e.expiresAt?(r.delete(t),null):e.data:null}(e);if(c)return t?.log?.("🔍 patientSearchService cache hit",{term:n,activeOnly:s,count:c.length}),c;const l=await i.searchPatients(n,s),u=o(Array.isArray(l)?l.slice(0,a):[]);return!function(t,e,n=45e3){r.set(t,{data:e,expiresAt:Date.now()+n})}(e,u),u}catch(c){throw t?.error?.("❌ patientSearchService.search error",c),e?.error?.(`Errore ricerca pazienti: ${c.message||c}`),c}}const c={search:a,searchRealtime:function(t,{activeOnly:e=!1,debounceMs:n=250,onUpdate:i,onError:s}={}){let r=!1;const o=setTimeout(async()=>{if(!r)try{const n=await a(t,{activeOnly:e});r||i?.(n)}catch(n){r||s?.(n)}},Math.max(0,n));return{cancel(){r=!0,clearTimeout(o)}}},_normalize:o};function l(t=""){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function u(t="",e=""){const i=e.trim();if(!i)return l(t);try{const e=i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=new RegExp(`(${e})`,"ig"),r=l(t).replace(s,"<mark>$1</mark>");return n.sanitize(r,{ALLOWED_TAGS:["mark"]})}catch{return l(t)}}class p{constructor({input:t,resultsContainer:e,onSelect:n,activeOnly:i=!1,minChars:s=2,debounceMs:r=250}={}){this.input=t,this.results=e,this.onSelect=n,this.activeOnly=!!i,this.minChars=Math.max(0,s),this.debounceMs=Math.max(0,r),this._cleanup=[],this._currentCancel=null}attach(){if(!this.input||!this.results)return{destroy:()=>{}};this.results.style.display="none",this.input.setAttribute("autocomplete","off"),this.input.setAttribute("aria-autocomplete","list");const e=function(t,e=250){let n;return function(...i){clearTimeout(n),n=setTimeout(()=>t.apply(this,i),Math.max(0,e))}}(async e=>{const n=(e.target.value||"").trim();if(n.length<this.minChars)return this._clearResults(),void 0;this._showLoading();try{const t=await c.search(n,{activeOnly:this.activeOnly});this._renderList(t,n)}catch(i){t.error("PatientAutocomplete search error",i),this._renderEmpty("Errore durante la ricerca.")}},this.debounceMs),n=()=>{this.results.childElementCount>0&&this._open()},i=t=>{"Escape"===t.key&&this._close()},s=t=>{setTimeout(()=>this._close(),100)};return this.input.addEventListener("input",e),this.input.addEventListener("focus",n),this.input.addEventListener("keydown",i),this.input.addEventListener("blur",s),this._cleanup.push(()=>this.input.removeEventListener("input",e)),this._cleanup.push(()=>this.input.removeEventListener("focus",n)),this._cleanup.push(()=>this.input.removeEventListener("keydown",i)),this._cleanup.push(()=>this.input.removeEventListener("blur",s)),{destroy:()=>this.destroy()}}destroy(){this._cleanup.forEach(t=>t()),this._cleanup=[],this._clearResults()}_clearResults(){this.results.innerHTML="",this.results.style.display="none"}_open(){this.results.style.display="block"}_close(){this.results.style.display="none"}_showLoading(){this.results.innerHTML='\n      <div class="px-3 py-2 text-muted small d-flex align-items-center">\n        <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>\n        <span>Ricerca in corso...</span>\n      </div>',this._open()}_renderEmpty(t="Nessun risultato"){const e=s.forSearchResults(this.input.value||"");e.options.description=t||e.options.description,this.results.innerHTML=`<div class="px-2">${e.render()}</div>`,this._open()}_renderList(t=[],e=""){if(!t.length)return this._renderEmpty(),void 0;const n=t.map((t,n)=>{const i=u(`${t.cognome||""} ${t.nome||""}`.trim(),e),s=t.codice_rad?u(`RAD: ${t.codice_rad}`,e):"";return`\n        <button type="button" class="dropdown-item d-flex flex-column" data-id="${t.id}">\n          <span>${i}</span>\n          ${s?`<small class="text-muted">${s}</small>`:""}\n        </button>`}).join("");this.results.innerHTML=n,this._open(),Array.from(this.results.querySelectorAll(".dropdown-item")).forEach(e=>{const n=n=>{n.preventDefault(),n.stopPropagation();const i=e.getAttribute("data-id"),s=t.find(t=>String(t.id)===String(i));if(s){const t=`${s.cognome||""} ${s.nome||""}`.trim();this.input.value=t,this.input.dataset.patientId=s.id,this._close(),this.onSelect?.(s)}};e.addEventListener("mousedown",n),e.addEventListener("click",n)})}}function d(t){return new p(t).attach()}export{d as a};
