const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BREIM5RS.js","assets/lookupService-C6AnCCoa.js","assets/index-BuiCByAB.js","assets/supabase-AmyKTmiY.js","assets/vendor-BU6HxVpN.js","assets/index-CIUH-r2y.css"])))=>i.map(i=>d[i]);
import{patientService as e}from"./patientService-CqipPSCT.js";import{l as i,s as n,n as t}from"./index-BuiCByAB.js";import{_ as o}from"./supabase-AmyKTmiY.js";import{l as s}from"./lookupService-C6AnCCoa.js";import a from"./CustomDatepicker-6By5cdaM.js";import{i as r}from"./CustomSelect-DXLs-_CB.js";import{a as c}from"./PatientAutocomplete-B93zsu08.js";import{f as d}from"./formatting-C7G90sDQ.js";import"./infectionDataManager-QhPomSuF.js";import"./vendor-BU6HxVpN.js";import"./utils-BtSsRyB2.js";async function l(e,t){const o=function(e){const i=[];e.data_dimissione||i.push("La data di dimissione è obbligatoria");e.tipo_dimissione||i.push("Il tipo di dimissione è obbligatorio");"decesso"===e.tipo_dimissione||e.codice_dimissione||i.push("Il codice dimissione è obbligatorio");const n=["dimissione","trasferimento_interno","trasferimento_esterno","decesso"];e.tipo_dimissione&&!n.includes(e.tipo_dimissione)&&i.push("Tipo di dimissione non valido");const t=["0","3","6"];e.codice_dimissione&&!t.includes(e.codice_dimissione)&&i.push("Codice dimissione non valido");"trasferimento_interno"===e.tipo_dimissione&&(e.reparto_destinazione&&""!==e.reparto_destinazione.trim()||i.push("Il reparto di destinazione è obbligatorio per i trasferimenti interni"));if("trasferimento_esterno"===e.tipo_dimissione){e.clinica_destinazione&&""!==e.clinica_destinazione.trim()||i.push("La clinica di destinazione è obbligatoria per i trasferimenti esterni"),e.codice_clinica||i.push("Il codice clinica è obbligatorio per i trasferimenti esterni");e.codice_clinica&&!["56","60"].includes(e.codice_clinica)&&i.push("Codice clinica non valido")}if(e.data_dimissione){/^\d{2}\/\d{2}\/\d{4}$/.test(e.data_dimissione)||i.push("Formato data dimissione non valido (utilizzare gg/mm/aaaa)")}return{isValid:0===i.length,errors:i}}(t);if(!o.isValid)throw new Error(`Dati di dimissione non validi: ${o.errors.join(", ")}`);try{i.group("[DimissioneAPI] Input validato"),i.log({patientId:e,...t}),i.groupEnd()}catch(l){}const{data:s,error:a}=await n.from("pazienti").select("id, data_dimissione, data_ricovero").eq("id",e).is("data_dimissione",null).single();if(a){if(console.error("Errore durante la verifica del paziente:",a),"PGRST116"===a.code)throw new Error("Paziente non trovato o già dimesso.");throw new Error("Errore durante la verifica del paziente.")}if(!s)throw new Error("Paziente non trovato o già dimesso.");const r=function(e,i){let n=e.data_dimissione;if("string"==typeof n&&n.includes("/")){const[e,i,t]=n.split("/");n=`${t}-${i}-${e}`}if(i.data_ricovero){const e=new Date(i.data_ricovero),t=n?new Date(`${n}T00:00:00Z`):null;if(!Number.isNaN(e.getTime())&&t&&!Number.isNaN(t.getTime())&&t<e)throw new Error("La data di dimissione non può essere precedente alla data di ricovero")}const t=e=>""===e||null==e?null:Number(e),o={dimissione:0,trasferimento_interno:3,trasferimento_esterno:6},s="decesso"===e.tipo_dimissione?null:o[e.tipo_dimissione],a={data_dimissione:n,tipo_dimissione:e.tipo_dimissione,codice_dimissione:s};"trasferimento_interno"===e.tipo_dimissione?(a.reparto_destinazione=e.reparto_destinazione,a.clinica_destinazione=null,a.codice_clinica=null):"trasferimento_esterno"===e.tipo_dimissione?(a.clinica_destinazione=e.clinica_destinazione,a.codice_clinica=t(e.codice_clinica),a.reparto_destinazione=null):(a.reparto_destinazione=null,a.clinica_destinazione=null,a.codice_clinica=null);return a}(t,s);try{i.group("[DimissioneAPI] Update payload"),i.log(r),i.groupEnd()}catch(l){}const{data:c,error:d}=await n.from("pazienti").update(r).eq("id",e).select();if(d)throw console.error("Errore durante la dimissione:",d),new Error("Errore durante l'aggiornamento del paziente.");if(!c||0===c.length)throw new Error("Paziente non trovato durante l'aggiornamento.");try{const e=c[0]||{};i.group("[DimissioneAPI] Update result"),i.log({id:e.id,tipo_dimissione:e.tipo_dimissione,codice_clinica:e.codice_clinica,codice_dimissione:e.codice_dimissione}),i.groupEnd()}catch(l){}return c[0]}let m=null,u=null;const p={get searchInput(){return document.getElementById("search-paziente")},get searchButton(){return document.getElementById("search-button")},get resultsContainer(){return document.getElementById("search-results")},get dischargeForm(){return document.getElementById("form-dimissione")},get selectedPatientName(){return document.getElementById("selected-paziente-nome")},get selectedPatientRicovero(){return document.getElementById("selected-paziente-ricovero")},get dataDimissioneInput(){return document.getElementById("data_dimissione")},get backButton(){return document.querySelector('.view[data-view-name="dimissione"] .btn-back-menu')},get messageContainer(){return document.getElementById("messaggio-container-dimissione")},get tipoDimissioneSelect(){return document.getElementById("tipo_dimissione")},get repartoDestinazioneInput(){return document.getElementById("reparto_destinazione")},get clinicaDestinazioneInput(){return document.getElementById("clinica_destinazione")},get codiceClinicaSelect(){return document.getElementById("codice_clinica")},get codiceDimissioneSelect(){return document.getElementById("codice_dimissione")},get internalTransferFields(){return document.getElementById("internal-transfer-fields")},get externalTransferFields(){return document.getElementById("external-transfer-fields")}};async function _(e){if(m=new a("[data-datepicker]",{dateFormat:"d/m/Y"}),await async function(){try{const e=[];p.codiceDimissioneSelect&&e.push(s.populateCodiciDimissioneSelect(p.codiceDimissioneSelect)),p.repartoDestinazioneInput&&e.push(async function(){p.repartoDestinazioneInput&&"SELECT"===p.repartoDestinazioneInput.tagName&&await s.populateRepartiSelect(p.repartoDestinazioneInput,null,"interno")}()),p.codiceClinicaSelect&&e.push(s.populateClinicheSelect(p.codiceClinicaSelect)),await Promise.all(e)}catch(e){console.error("Errore nel caricamento dati lookup:",e),t.error("Errore nel caricamento delle opzioni del form")}}(),r('.form-select[data-custom="true"]'),p.searchInput&&p.resultsContainer){const i=c({input:p.searchInput,resultsContainer:p.resultsContainer,activeOnly:!0,minChars:2,debounceMs:250,onSelect:i=>{e?.(i)}});u=i}void(p.tipoDimissioneSelect&&(p.tipoDimissioneSelect.addEventListener("change",e=>{I(e.target.value)}),I(p.tipoDimissioneSelect.value))),f()}function f(){p.dischargeForm&&p.dischargeForm.classList.add("d-none"),p.resultsContainer&&(p.resultsContainer.innerHTML=""),p.searchInput&&(p.searchInput.value=""),p.dataDimissioneInput&&(p.dataDimissioneInput.value=""),p.tipoDimissioneSelect&&(p.tipoDimissioneSelect.value="dimissione",p.tipoDimissioneSelect.customSelectInstance&&p.tipoDimissioneSelect.customSelectInstance.setValue("dimissione")),p.repartoDestinazioneInput&&(p.repartoDestinazioneInput.value=""),p.clinicaDestinazioneInput&&(p.clinicaDestinazioneInput.value=""),p.codiceClinicaSelect&&(p.codiceClinicaSelect.value="",p.codiceClinicaSelect.customSelectInstance&&p.codiceClinicaSelect.customSelectInstance.setValue("")),p.codiceDimissioneSelect&&(p.codiceDimissioneSelect.value="",p.codiceDimissioneSelect.customSelectInstance&&p.codiceDimissioneSelect.customSelectInstance.setValue("")),I("dimissione")}function g(e,i){switch(i){case"success":t.success(e);break;case"error":t.error(e);break;case"warning":t.warning(e);break;default:t.info(e)}}function I(e){const i=p.internalTransferFields,n=p.externalTransferFields;if(!i||!n)return console.warn("Transfer fields containers not found"),void 0;switch(i.classList.add("d-none"),n.classList.add("d-none"),[p.repartoDestinazioneInput,p.clinicaDestinazioneInput,p.codiceClinicaSelect].forEach(e=>{e&&(e.required=!1,e.value="")}),e){case"trasferimento_interno":i.classList.remove("d-none"),p.repartoDestinazioneInput&&(p.repartoDestinazioneInput.required=!0);break;case"trasferimento_esterno":n.classList.remove("d-none"),p.clinicaDestinazioneInput&&(p.clinicaDestinazioneInput.required=!0),p.codiceClinicaSelect&&(p.codiceClinicaSelect.required=!0)}p.codiceDimissioneSelect&&(p.codiceDimissioneSelect.required="decesso"!==e)}async function z(){const e={data_dimissione:p.dataDimissioneInput?.value,tipo_dimissione:p.tipoDimissioneSelect?.value,codice_dimissione:p.codiceDimissioneSelect?.value},i=e.tipo_dimissione;return"trasferimento_interno"===i?e.reparto_destinazione=p.repartoDestinazioneInput?.value:"trasferimento_esterno"===i&&(e.clinica_destinazione=p.clinicaDestinazioneInput?.value,e.codice_clinica=p.codiceClinicaSelect?.value),await async function(e){try{const{codiciDimissioneService:i,repartiService:n,clinicheService:t}=await o(async()=>{const{codiciDimissioneService:e,repartiService:i,clinicheService:n}=await import("./index-BREIM5RS.js");return{codiciDimissioneService:e,repartiService:i,clinicheService:n}},__vite__mapDeps([0,1,2,3,4,5]));if(e.codice_dimissione&&!isNaN(e.codice_dimissione)){const n=await i.getById(parseInt(e.codice_dimissione));n&&(e.codice_dimissione_id=parseInt(e.codice_dimissione),e.codice_dimissione=n.codice)}if(e.reparto_destinazione&&isNaN(e.reparto_destinazione)){const i=await n.getByNome(e.reparto_destinazione);i&&(e.reparto_destinazione_id=i.id)}else if(e.reparto_destinazione&&!isNaN(e.reparto_destinazione)){const i=await n.getById(parseInt(e.reparto_destinazione));i&&(e.reparto_destinazione_id=parseInt(e.reparto_destinazione),e.reparto_destinazione=i.nome)}if(e.codice_clinica&&!isNaN(e.codice_clinica)){const i=await t.getById(parseInt(e.codice_clinica));i&&(e.clinica_destinazione_id=parseInt(e.codice_clinica),e.codice_clinica=i.codice)}}catch(i){console.error("Errore nella conversione campi normalizzati:",i)}}(e),e}let v=null;async function h(e){if(e.preventDefault(),!v)return g("Seleziona un paziente prima di procedere.","warning"),void 0;const i=function(){const e=[],i=p.dataDimissioneInput?.value,n=p.tipoDimissioneSelect?.value,t=p.codiceDimissioneSelect?.value;if(i||e.push("La data di dimissione è obbligatoria"),n||e.push("Il tipo di dimissione è obbligatorio"),"decesso"===n||t||e.push("Il codice dimissione è obbligatorio"),"trasferimento_interno"===n){const i=p.repartoDestinazioneInput?.value;i&&""!==i.trim()||e.push("Il reparto di destinazione è obbligatorio per i trasferimenti interni")}else if("trasferimento_esterno"===n){const i=p.clinicaDestinazioneInput?.value,n=p.codiceClinicaSelect?.value;i&&""!==i.trim()||e.push("La clinica di destinazione è obbligatoria per i trasferimenti esterni"),n||e.push("Il codice clinica è obbligatorio per i trasferimenti esterni"),n&&!["56","60"].includes(n)&&e.push("Codice clinica non valido: consentiti solo 56 (Riab. Motoria) o 60 (Lunga Degenza)")}return{isValid:0===e.length,errors:e}}();if(!i.isValid)return g(`Errori di validazione: ${i.errors.join(", ")}`,"error"),void 0;const n=await z();try{await l(v.id,n);let e="Paziente dimesso con successo!";"trasferimento_interno"===n.tipo_dimissione?e=`Paziente trasferito con successo al reparto ${n.reparto_destinazione}!`:"trasferimento_esterno"===n.tipo_dimissione&&(e=`Paziente trasferito con successo alla clinica ${n.clinica_destinazione}!`),g(e,"success"),v=null,f(),setTimeout(()=>{window.location.hash="home"},1500)}catch(t){g(t.message,"error")}}async function D(){return await _(async i=>{try{const n=await e.getPatientById(i.id);v={...i,...n}}catch(n){v=i}!function(e){if(!(p.selectedPatientName&&p.selectedPatientRicovero&&p.dischargeForm&&p.resultsContainer&&p.searchInput&&p.dataDimissioneInput))return console.error("Elementi DOM mancanti per displayDischargeForm"),void 0;p.selectedPatientName.textContent=`${e.cognome} ${e.nome}`,p.selectedPatientRicovero.textContent=d(e.data_ricovero),p.dischargeForm.classList.remove("d-none"),p.resultsContainer.innerHTML="",p.searchInput.value="",p.dataDimissioneInput.focus()}(v)}),p.dischargeForm&&p.dischargeForm.addEventListener("submit",h),p.searchInput&&p.searchInput.focus(),()=>{m&&(m.destroy(),m=null),u&&"function"==typeof u.destroy&&(u.destroy(),u=null),void document.querySelectorAll('.form-select[data-custom="true"]').forEach(e=>{e.customSelectInstance&&e.customSelectInstance.destroy()}),v=null}}export{D as initDimissioneView};
