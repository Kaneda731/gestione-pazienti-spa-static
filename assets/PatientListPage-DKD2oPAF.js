import{j as e}from"./ui-vendor-CgDpQ-gO.js";import{s as t,l as i,e as a,f as n,h as s,k as r}from"./index-CVNWsCbc.js";import{u as o}from"./useQuery-DzLDvhd6.js";import{u as l}from"./useMutation-Dz_kYsgE.js";import{u as c,R as d,b as m}from"./react-vendor-bU8fvvPN.js";import{u as p}from"./useNotification-BejZYInR.js";import{B as u}from"./Button-CI4eP2cr.js";import{u as h}from"./useResponsive-DDHaZ65L.js";import{p as v}from"./patientService-BW9WhanX.js";import{c as x}from"./CentralizedStatisticsService-BvhPVcrC.js";import{a as b,b as f,l as g,c as j}from"./filterQueryService-plZUndKF.js";import{C as N}from"./CustomSelect-B7RP0tgS.js";import{C as _}from"./ConfirmModal-DqvvpUVX.js";import"./supabase-DpMRTrmd.js";async function y(){try{const e=await b("pazienti","tipo_dimissione"),t=["dimissione","trasferimento_interno","trasferimento_esterno","decesso"],i=e.map(e=>null==e?null:String(e)).filter(e=>!!e&&t.includes(e));return Array.from(new Set(i))}catch(e){throw i.error("Error loading transfer values:",e),new Error("Impossibile caricare le opzioni di trasferimento.")}}async function D(){try{const[e,i]=await Promise.all([t.from("pazienti").select("id",{count:"exact",head:!0}).is("data_dimissione",null),t.from("pazienti").select("id",{count:"exact",head:!0}).not("data_dimissione","is",null)]);if(e.error)throw e.error;if(i.error)throw i.error;return{hasActive:(e.count??0)>0,hasDimesso:(i.count??0)>0}}catch(e){throw i.error("Error loading patient status availability:",e),new Error("Impossibile caricare le opzioni di stato.")}}const w={search:"Ricerca",reparto:"Reparto appartenenza",diagnosi:"Diagnosi",stato:"Stato",infetto:"Infetto",trasferimento:"Trasferimento"},C={true:"SÃ¬",false:"No"},z={dimissione:"Dimissione",trasferimento_interno:"Trasferimento interno",trasferimento_esterno:"Trasferimento esterno",decesso:"Decesso"},P=["search","reparto","diagnosi","stato","infetto","trasferimento"];function I(e){return P.map(t=>{const i=e[t];if(null==i||""===i)return null;const a=function(e,t){if(null==t)return"";if("object"==typeof t&&null!==t)return console.warn(`Filter value for "${e}" is an object, skipping:`,t),"";try{const i=String(t);return"search"===e?i.trim():"infetto"===e?C[i]||C[String("true"===i)]||i:"stato"===e?"attivo"===i?"Attivo":"dimesso"===i?"Dimesso":i:"trasferimento"===e&&z[i]||i}catch(i){return console.error(`Error converting filter value for "${e}":`,i,t),""}}(t,i);return a?{key:t,label:w[t]||t,value:a}:null}).filter(e=>null!==e)}const k=({filters:t,onClearFilter:i})=>{const a=I(t);return 0===a.length?null:e.jsxs("div",{className:"d-flex gap-2 mb-3 align-items-center",children:[e.jsx("span",{className:"text-muted small",children:"Filtri attivi:"}),e.jsx("ul",{className:"list-unstyled d-flex gap-2 mb-0 flex-wrap",children:a.map(({key:t,label:a,value:n})=>e.jsxs("li",{className:"badge rounded-pill bg-secondary d-inline-flex align-items-center",children:[a,": ",n,e.jsx("button",{type:"button",className:"btn-close btn-close-white ms-2","aria-label":`Rimuovi filtro ${a}`,onClick:()=>i(t)})]},t))})]})},T=["Chirurgia Ortopedica","Chirurgia Plastica","Chirurgia Vascolare","Chirurgia Generale","Altro"],$=7,O=30,S="danger",A="warning",E="info",R="success";function F(e){if(!e)return null;if(e instanceof Date)return isNaN(e.getTime())?null:e;if("string"==typeof e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)){const t=new Date(e+"T00:00:00.000Z");return isNaN(t.getTime())?null:t}if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(e)){const t=e.split("/"),i=parseInt(t[0],10),a=parseInt(t[1],10)-1,n=parseInt(t[2],10),s=new Date(n,a,i);return isNaN(s.getTime())?null:s}const t=new Date(e);return isNaN(t.getTime())?null:t}return null}function q(e,t){const i=t.getTime()-e.getTime(),a=Math.floor(i/864e5);return Math.max(0,a)}function M(e){return 0===e?"Giorno dell'intervento":1===e?"Giorno post-operatorio 1":`Giorno post-operatorio ${e}`}const V=new class{interventionTypes;constructor(){this.interventionTypes=T}calculatePostOperativeDays(e,t=new Date){try{if(!Array.isArray(e))throw new Error("eventiClinici must be an array");const i=F(t);if(!i)throw new Error("Invalid reference date");const a=function(e){return e.filter(e=>"intervento"===e.tipo_evento&&e.data_evento&&e.tipo_intervento)}(e);if(0===a.length)return{hasInterventions:!1,postOperativeDays:null,lastIntervention:null,displayText:null,allInterventions:[]};const n=function(e){return[...e].sort((e,t)=>{const i=F(e.data_evento),a=F(t.data_evento);return i&&a?a.getTime()-i.getTime():0})}(a),s=n[0],r=F(s.data_evento);if(!r)throw new Error("Invalid intervention date");const o=q(r,i);return{hasInterventions:!0,postOperativeDays:o,lastIntervention:s,displayText:M(o),allInterventions:n}}catch(i){const e=i instanceof Error?i.message:String(i);return window.appLogger?.error("Error calculating post-operative days:",i),{hasInterventions:!1,postOperativeDays:null,lastIntervention:null,displayText:null,allInterventions:[],error:e}}}calculateForMultiplePatients(e,t=new Date){const i=new Map;return Array.isArray(e)?(e.forEach(e=>{if(e.id&&e.eventi_clinici){const a=this.calculatePostOperativeDays(e.eventi_clinici,t);i.set(e.id,a)}}),i):i}getPostOperativeStatus(e,t=new Date){const i=this.calculatePostOperativeDays(e,t);if(!i.hasInterventions||null==i.postOperativeDays)return{hasStatus:!1,statusText:"",statusClass:"",badgeText:""};const a=i.postOperativeDays,n=this.hasActiveInfection(e);let s=R,r=`PO ${a}`;return n?(s=S,r=`PO ${a} ðŸ¦ `):a<=$?s=S:a<=O?s=A:a<=90&&(s=E),{hasStatus:!0,statusText:i.displayText??"",statusClass:s,badgeText:r,days:a,lastIntervention:i.lastIntervention||void 0,hasActiveInfection:n}}getDetailedPostOperativeInfo(e,t=new Date){const i=this.calculatePostOperativeDays(e,t);if(!i.hasInterventions)return{hasInterventions:!1,summary:"Nessun intervento chirurgico registrato",details:[]};const a=F(t);if(!a)return{hasInterventions:!1,summary:"Data riferimento non valida",details:[]};const n=i.allInterventions.map((e,t)=>{const i=F(e.data_evento),n=i?q(i,a):0;return{date:e.data_evento,type:e.tipo_intervento||"N/A",description:e.descrizione||"",daysSince:n,displayText:M(n),isLatest:0===t}});return{hasInterventions:!0,currentPostOpDay:i.postOperativeDays??void 0,currentDisplayText:i.displayText??void 0,lastInterventionDate:i.lastIntervention?.data_evento,lastInterventionType:i.lastIntervention?.tipo_intervento??void 0,totalInterventions:i.allInterventions.length,summary:`${i.displayText} (${i.allInterventions.length} interventi totali)`,details:n}}isInCriticalPostOpPeriod(e,t=$,i=new Date){const a=this.calculatePostOperativeDays(e,i);if(!a.hasInterventions)return{isCritical:!1,reason:"No interventions recorded"};const n=a.postOperativeDays||0,s=n<=t;return{isCritical:s,postOpDays:n,criticalThreshold:t,reason:s?`Patient is ${n} days post-operative (â‰¤${t} days)`:`Patient is ${n} days post-operative (>${t} days)`}}validateInterventionEvent(e){const t=[];if(!e)return t.push("Event object is required"),{isValid:!1,errors:t};if("intervento"!==e.tipo_evento&&t.push('Event type must be "intervento"'),e.data_evento){const i=F(e.data_evento);i?i>new Date&&t.push("Event date cannot be in the future"):t.push("Invalid event date format")}else t.push("Event date is required");return e.tipo_intervento||t.push("Intervention type is required"),{isValid:0===t.length,errors:t}}getPostOperativeStatistics(e,t=new Date){if(!Array.isArray(e))return{totalPatients:0,patientsWithInterventions:0,criticalPeriod:0,earlyRecovery:0,lateRecovery:0,averagePostOpDays:0};let i=0,a=0,n=0,s=0,r=0;return e.forEach(e=>{if(e.eventi_clinici){const o=this.calculatePostOperativeDays(e.eventi_clinici,t);o.hasInterventions&&null!==o.postOperativeDays&&(i++,r+=o.postOperativeDays,o.postOperativeDays<=$?a++:o.postOperativeDays<=O?n++:s++)}}),{totalPatients:e.length,patientsWithInterventions:i,criticalPeriod:a,earlyRecovery:n,lateRecovery:s,averagePostOpDays:i>0?Math.round(r/i):0}}hasActiveInfection(e){return function(e){return!!Array.isArray(e)&&e.some(e=>"infezione"===e.tipo_evento&&e.data_evento&&!e.data_fine_evento)}(e)}formatDisplayText(e){return M(e)}};const G=new Map;function K(e){if(!e)return!1;if(G.has(e.id))return G.get(e.id);let t=!1;return!0===e.infetto?t=!0:e.eventi_clinici&&Array.isArray(e.eventi_clinici)&&(t=V.hasActiveInfection(e.eventi_clinici)),G.set(e.id,t),t}const B=({patient:t,onEdit:i,onDelete:a,onDischarge:n,onReactivate:s,onAddIntervention:r,onAddInfection:o,onViewEvents:l})=>{const d=c(),m=(p=t.eventi_clinici??[],h=new Date,V.getPostOperativeStatus(p,h));var p,h;const v=function(e){return K(e)?"patient-card-infected":""}(t),x=Boolean(t.data_dimissione);return e.jsxs("div",{className:`patient-card-mobile patient-card-mobile--${x?"discharged":"active"} ${v?"patient-card-mobile--infected":""}`,title:v?"Paziente con infezione attiva":void 0,children:[e.jsx("div",{className:"patient-card-mobile__status-strip"}),e.jsxs("div",{className:"patient-card-mobile__content",children:[e.jsxs("div",{className:"patient-card-mobile__header",children:[e.jsx("div",{className:"patient-card-mobile__avatar",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"person"})}),e.jsxs("div",{className:"patient-card-mobile__title-group",children:[e.jsxs("button",{type:"button",className:"patient-card-mobile__name patient-card-mobile__name--clickable",onClick:()=>{d(`/patient/${t.id}`)},title:`Visualizza profilo di ${t.nome} ${t.cognome}`,children:[t.nome," ",t.cognome]}),e.jsxs("div",{className:"patient-card-mobile__badges",children:[v&&e.jsxs("span",{className:"patient-card-mobile__badge patient-card-mobile__badge--infection",children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"coronavirus"}),"Infezione"]}),x&&e.jsxs("span",{className:"patient-card-mobile__badge patient-card-mobile__badge--discharged",children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"check_circle"}),"Dimesso"]}),m?.hasStatus&&e.jsx("span",{className:`patient-card-mobile__badge patient-card-mobile__badge--postop patient-card-mobile__badge--${m.statusClass??"success"}`,children:m.badgeText??""})]})]})]}),e.jsxs("div",{className:"patient-card-mobile__info",children:[e.jsxs("div",{className:"patient-card-mobile__info-row",children:[e.jsx("span",{className:"material-icons patient-card-mobile__info-icon","aria-hidden":"true",children:"local_hospital"}),e.jsx("span",{className:"patient-card-mobile__info-text",children:t.diagnosi||"Diagnosi non specificata"})]}),e.jsxs("div",{className:"patient-card-mobile__info-row",children:[e.jsx("span",{className:"material-icons patient-card-mobile__info-icon","aria-hidden":"true",children:"apartment"}),e.jsx("span",{className:"patient-card-mobile__info-text",children:t.reparto_appartenenza||"Reparto non specificato"})]})]}),e.jsxs("div",{className:"patient-card-mobile__quick-actions",children:[l&&e.jsx("button",{className:"patient-card-mobile__quick-btn patient-card-mobile__quick-btn--timeline",onClick:()=>l(t),"aria-label":"Timeline eventi",title:"Timeline eventi",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"timeline"})}),r&&e.jsx("button",{className:"patient-card-mobile__quick-btn patient-card-mobile__quick-btn--intervention",onClick:()=>r(t),"aria-label":"Aggiungi intervento",title:"Aggiungi intervento",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"add_circle"})}),o&&e.jsx("button",{className:"patient-card-mobile__quick-btn patient-card-mobile__quick-btn--infection",onClick:()=>o(t),"aria-label":"Aggiungi infezione",title:"Aggiungi infezione",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"bug_report"})}),i&&e.jsx("button",{className:"patient-card-mobile__quick-btn patient-card-mobile__quick-btn--edit",onClick:()=>i(t),"aria-label":"Modifica paziente",title:"Modifica paziente",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"edit"})})]}),e.jsxs("div",{className:"patient-card-mobile__actions",children:[n&&!x&&e.jsxs(u,{variant:"warning",className:"patient-card-mobile__action-btn patient-card-mobile__action-btn--discharge",onClick:()=>n(t),children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"logout"}),"Dimetti"]}),s&&x&&e.jsxs(u,{variant:"success",className:"patient-card-mobile__action-btn patient-card-mobile__action-btn--reactivate",onClick:()=>s(t),children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"replay"}),"Riattiva"]}),a&&e.jsxs(u,{variant:"outline-danger",className:"patient-card-mobile__action-btn patient-card-mobile__action-btn--delete",onClick:()=>a(t),children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"delete"}),"Elimina"]})]})]})]})},J=e=>{if(!e)return"-";const t="string"==typeof e?new Date(e):e;return Number.isNaN(t.getTime())?"-":t.toLocaleDateString("it-IT")},L=({patient:t,onSelect:i,onDelete:a,onEdit:n,onDischarge:s,onReactivate:r,showActions:o=!1})=>{const l=c(),d=!!t.data_dimissione,m=function(e){return K(e)?"table-row-infected":""}(t),p=e=>{e.stopPropagation(),l(`/patient/${t.id}`)};return e.jsxs("tr",{className:m,onClick:()=>i?.(t),onKeyDown:e=>{!i||"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),i(t))},tabIndex:i?0:void 0,role:i?"button":void 0,style:{cursor:i?"pointer":"default"},title:m?"Paziente con infezione attiva":void 0,children:[e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn btn-link patient-name-link p-0",onClick:p,title:`Visualizza profilo di ${t.cognome}`,children:t.cognome||"-"})}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn btn-link patient-name-link p-0",onClick:p,title:`Visualizza profilo di ${t.nome}`,children:t.nome||"-"})}),e.jsx("td",{children:J(t.data_nascita)}),e.jsx("td",{children:J(t.data_ricovero)}),e.jsx("td",{children:t.diagnosi||"-"}),e.jsx("td",{children:t.reparto_appartenenza||"-"}),e.jsx("td",{children:(()=>{const i=(e=>{const t=e.eventi_clinici?.filter(e=>"intervento"===e.tipo_evento)?.sort((e,t)=>{const i=new Date(e.data_evento).getTime();return new Date(t.data_evento).getTime()-i})[0];if(!t?.data_evento)return"-";const i=new Date(t.data_evento);if(Number.isNaN(i.getTime()))return"-";const a=(new Date).getTime()-i.getTime(),n=Math.floor(a/864e5);return n>=0?`PO ${n}`:"-"})(t);return"-"===i?"-":e.jsx("span",{className:"badge bg-info text-dark",title:`Giorno post-operatorio ${i.replace("PO ","")}`,children:i})})()}),e.jsx("td",{children:e.jsx("span",d?{className:"badge bg-secondary",children:"Dimesso"}:{className:"badge bg-success",children:"Attivo"})}),e.jsx("td",{children:(()=>{const i=(e=>{if(!e.data_dimissione)return null;let t="";"trasferimento_esterno"===e.tipo_dimissione?t="Esterno":"trasferimento_interno"===e.tipo_dimissione?t="Interno":"decesso"===e.tipo_dimissione?t="Decesso":"dimissione"===e.tipo_dimissione&&(t="Dimissione");let i="";return e.reparto_destinazione?i=e.reparto_destinazione:e.clinica_destinazione&&(i=e.clinica_destinazione),{type:t,destination:i,note:e.note||void 0}})(t);return i?e.jsxs("div",{className:"small",children:[e.jsx("strong",{children:i.type}),i.destination&&e.jsxs(e.Fragment,{children:[" â†’ ",e.jsx("span",{children:i.destination})]}),i.note&&e.jsxs("div",{className:"text-muted",children:["(",i.note,")"]})]}):"-"})()}),o&&e.jsx("td",{children:e.jsxs("div",{className:"patient-table-actions d-flex gap-2",children:[n&&e.jsx(u,{variant:"link",onClick:()=>n(t),title:`Modifica paziente ${t.nome} ${t.cognome}`,"aria-label":`Modifica paziente ${t.nome} ${t.cognome}`,className:"patient-table-action-btn",children:e.jsx("span",{className:"material-icons fs-5","aria-hidden":"true",children:"edit"})}),s&&!d&&e.jsx(u,{variant:"link",onClick:()=>s(t),title:`Dimetti paziente ${t.nome} ${t.cognome}`,"aria-label":`Dimetti paziente ${t.nome} ${t.cognome}`,className:"patient-table-action-btn text-warning",children:e.jsx("span",{className:"material-icons fs-5","aria-hidden":"true",children:"event_available"})}),r&&d&&e.jsx(u,{variant:"link",onClick:()=>r(t),title:`Riattiva paziente ${t.nome} ${t.cognome}`,"aria-label":`Riattiva paziente ${t.nome} ${t.cognome}`,className:"patient-table-action-btn text-success",children:e.jsx("span",{className:"material-icons fs-5","aria-hidden":"true",children:"undo"})}),a&&e.jsx(u,{variant:"link",onClick:()=>a(t),title:`Elimina paziente ${t.nome} ${t.cognome}`,"aria-label":`Elimina paziente ${t.nome} ${t.cognome}`,className:"patient-table-action-btn text-danger",children:e.jsx("span",{className:"material-icons fs-5","aria-hidden":"true",children:"delete"})})]})})]},t.id)},Q=({patients:t,loading:i=!1,onSelect:a,onDelete:n,onEdit:s,onDischarge:r,onReactivate:o,onAddIntervention:l,onAddInfection:c,onViewEvents:d,onResetFilters:m,showActions:p=!1,emptyMessage:v="Nessun paziente disponibile"})=>{const x=h().isDesktop;return i?e.jsxs("div",{className:"text-center p-5",role:"status","aria-live":"polite","aria-busy":"true",children:[e.jsx("div",{className:"spinner-border text-primary mb-3",role:"presentation",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento pazienti in corso..."})}),e.jsx("p",{className:"text-muted mb-0",children:"Caricamento pazienti in corso..."}),e.jsx("div",{className:"mt-4",children:[1,2,3].map(t=>e.jsx("div",{className:"card mb-2 placeholder-glow",children:e.jsxs("div",{className:"card-body",children:[e.jsx("span",{className:"placeholder col-7"}),e.jsx("span",{className:"placeholder col-4 ms-2"}),e.jsx("span",{className:"placeholder col-6"})]})},t))})]}):t.length?e.jsx("div",x?{className:"table-responsive",style:{maxHeight:"70vh",overflowY:"auto"},children:e.jsxs("table",{className:"table table-striped table-hover align-middle","aria-label":"Elenco pazienti",children:[e.jsx("thead",{className:"table-light",style:{position:"sticky",top:0,zIndex:10},children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",children:"Cognome"}),e.jsx("th",{scope:"col",children:"Nome"}),e.jsx("th",{scope:"col",children:"Data Nascita"}),e.jsx("th",{scope:"col",children:"Data Ricovero"}),e.jsx("th",{scope:"col",children:"Diagnosi"}),e.jsx("th",{scope:"col",children:"Reparto appartenenza"}),e.jsx("th",{scope:"col",children:"Post-Op"}),e.jsx("th",{scope:"col",children:"Stato"}),e.jsx("th",{scope:"col",children:"Trasferimento"}),p&&e.jsx("th",{scope:"col",children:"Azioni"})]})}),e.jsx("tbody",{children:t.map(t=>e.jsx(L,{patient:t,onSelect:a,onDelete:n,onEdit:s,onDischarge:r,onReactivate:o,showActions:p},t.id))})]})}:{children:t.map(t=>e.jsx(B,{patient:t,onEdit:s,onDelete:n,onDischarge:r,onReactivate:o,onAddIntervention:l,onAddInfection:c,onViewEvents:d},t.id))}):e.jsxs("div",{className:"empty-state text-center py-5",children:[e.jsx("span",{className:"material-icons fs-1","aria-hidden":"true",children:"group_off"}),e.jsx("p",{className:"mb-1",children:v}),e.jsx("p",{className:"text-muted mb-3",children:"Aggiorna i filtri o reimposta la ricerca per visualizzare nuovi risultati."}),m&&e.jsxs(u,{variant:"outline-primary",size:"sm",onClick:m,children:[e.jsx("span",{className:"material-icons me-1",style:{verticalAlign:"text-bottom"},children:"refresh"}),"Resetta filtri"]})]})};const W=new class{async getPatientStats(e={}){try{const t={search:e.search,repartoAppartenenza:e.reparto,diagnosi:e.diagnosi,stato:e.stato,infetto:"true"===e.infetto||"false"!==e.infetto&&void 0,trasferimento:e.trasferimento},i=await x.getPatientStatistics(t),a={total:i.total,ricoverati:i.ricoverati,dimessi:i.dimessi};return e.reparto&&(a.perReparto=i.filteredCount),a}catch(t){throw i.error("Error loading patient statistics:",t),t}}},H=[{value:void 0,label:"Tutti"},{value:"attivo",label:"Attivi"},{value:"dimesso",label:"Dimessi"}],U=[{value:void 0,label:"Tutti"},{value:"dimissione",label:"Dimissioni"},{value:"trasferimento_interno",label:"Trasferimenti interni"},{value:"trasferimento_esterno",label:"Trasferimenti esterni"},{value:"decesso",label:"Decessi"}],Y=[{value:"data_ricovero",label:"Data ricovero"},{value:"cognome",label:"Cognome"},{value:"nome",label:"Nome"},{value:"data_nascita",label:"Data nascita"}],Z=()=>{const t=c(),{notify:i}=p(),d=a(),{filters:h,setFilters:x,setPage:b,setSort:w,resetFilters:C,user:z}=n(),[P,I]=m.useState(h.search||""),[T,$]=m.useState(!1),[O,S]=m.useState({title:"",body:"",onConfirm:()=>{}}),[A,E]=m.useState(null),R=m.useRef(null),{data:F,isPending:q,isError:M,isFetching:V}=o({queryKey:["patients",h],queryFn:()=>{const{page:e,sortColumn:t,sortDirection:i,...a}=h;return v.getPatientsWithClinicalEvents(a,{page:e,limit:10,sortColumn:t,sortDirection:i})},placeholderData:r}),{data:G}=o({queryKey:["patientStats",h],queryFn:()=>W.getPatientStats(h),initialData:{total:0,ricoverati:0,dimessi:0}}),{data:K}=o({queryKey:["patientFilterOptions"],queryFn:async()=>{const[e,t,i,a,n]=await Promise.all([f(),g(),D(),y(),j()]);return{diagnosiOptions:e,repartoOptions:t,statusOptions:ne(i),transferOptions:se(a),infectionOptions:re(n)}},staleTime:3e5}),B=(e,t)=>l({mutationFn:t=>v[e](t),onSuccess:()=>{d.invalidateQueries({queryKey:["patients"]})},onError:()=>{},onSettled:()=>{$(!1)}}),J=B("deletePatient"),L=B("dischargePatient"),H=B("reactivatePatient"),U=e=>{x({...e,page:0})},Z=()=>{I(""),C(),i.info("Filtri resettati").quick().show(),setTimeout(()=>R.current?.focus(),100)},X=m.useMemo(()=>s(e=>{U({search:e})},500),[]),ee=e=>{if(!F)return;const t=h.page??0,i="prev"===e?Math.max(t-1,0):t+1;"prev"===e&&!F.hasPrevPage||"next"===e&&!F.hasNextPage||b(i)},te=(e,t,i)=>{S({title:e,body:t,onConfirm:i}),$(!0)},ie=(e,i)=>{const{id:a}=i;switch(e){case"add-intervention":t(`/eventi-clinici?action=add&type=intervento&paziente=${a}`);break;case"add-infection":t(`/eventi-clinici?action=add&type=infezione&paziente=${a}`);break;case"view-events":t(`/eventi-clinici?paziente=${a}`)}},ae=async e=>{E(e);try{await("csv"===e?v.exportPatients(h):v.exportPatientsJSON(h)),i.success(`File ${e.toUpperCase()} scaricato con successo`).show()}catch(t){const e=t instanceof Error?t.message:"Errore durante l'esportazione";i.error(e).show()}finally{E(null)}},oe=m.useMemo(()=>{let e=0;return h.search&&e++,h.reparto&&e++,h.diagnosi&&e++,h.stato&&e++,void 0!==h.infetto&&e++,h.trasferimento&&e++,e},[h]);return e.jsxs("div",{className:"patient-list-page-container",children:[e.jsx(_,{isOpen:T,title:O.title,body:O.body,onConfirm:O.onConfirm,onCancel:()=>$(!1)}),e.jsx("div",{className:"patient-list-hero",children:e.jsxs("div",{className:"patient-list-hero-content",children:[e.jsx("h1",{className:"patient-list-title",children:"Elenco Pazienti"}),e.jsx("p",{className:"patient-list-subtitle",children:"Gestisci pazienti, filtra per stato e esporta la lista"})]})}),G&&e.jsxs("div",{className:"patient-stats-grid",children:[e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"people"})}),e.jsx("div",{className:"stat-value",children:G.total}),e.jsx("div",{className:"stat-label",children:"Totale Pazienti"})]}),e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"hotel"})}),e.jsx("div",{className:"stat-value",children:G.ricoverati}),e.jsx("div",{className:"stat-label",children:"Ricoverati"})]}),e.jsxs("div",{className:"patient-stat-card stat-discharged",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"logout"})}),e.jsx("div",{className:"stat-value",children:G.dimessi}),e.jsx("div",{className:"stat-label",children:"Dimessi"})]}),h.reparto&&void 0!==G.perReparto&&e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"business"})}),e.jsx("div",{className:"stat-value",children:G.perReparto}),e.jsxs("div",{className:"stat-label",children:["In ",h.reparto]})]})]}),e.jsxs("section",{className:"patient-filters-card",role:"search","aria-label":"Filtri ricerca pazienti",children:[e.jsxs("div",{className:"patient-filters-header",children:[e.jsxs("div",{className:"filters-title-wrapper",children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"filter_list"}),e.jsx("h2",{className:"filters-title",children:"Filtri Ricerca"})]}),oe>0&&e.jsxs("span",{className:"active-filters-badge",children:[oe," attivi"]})]}),e.jsxs("div",{className:"patient-filters-body",children:[e.jsxs("div",{className:"row g-3 align-items-end patient-filters",children:[e.jsxs("div",{className:"col-12 col-md-6 col-xl-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-search",children:"Cerca paziente"}),e.jsx("input",{ref:R,id:"patient-search",type:"search",className:"form-control",value:P,onChange:e=>{const t=e.target.value;I(t),X(t)},placeholder:"Nome, cognome, RAD\\u2026"})]}),e.jsxs("div",{className:"col-12 col-md-6 col-xl-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-department",children:"Reparto"}),e.jsx(N,{id:"patient-department",value:h.reparto??"",options:[{value:"",label:"Tutti"},...(K?.repartoOptions??[]).map(e=>({value:e,label:e}))],onChange:e=>U({reparto:e||void 0}),placeholder:"Tutti"})]}),e.jsxs("div",{className:"col-12 col-md-6 col-xl-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-diagnosis",children:"Diagnosi"}),e.jsx(N,{id:"patient-diagnosis",value:h.diagnosi??"",options:[{value:"",label:"Tutti"},...(K?.diagnosiOptions??[]).map(e=>({value:e.nome,label:e.nome}))],onChange:e=>U({diagnosi:e||void 0}),placeholder:"Tutti"})]}),e.jsxs("div",{className:"col-12 col-md-6 col-xl-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-status",children:"Stato"}),e.jsx(N,{id:"patient-status",value:h.stato??"",options:(K?.statusOptions??[]).map(e=>({value:e.value??"",label:e.label})),onChange:e=>U({stato:e||void 0}),placeholder:"Tutti"})]})]}),e.jsx("div",{className:"filters-actions",children:e.jsxs(u,{variant:"outline-secondary",onClick:Z,children:[e.jsx("span",{className:"material-icons me-1","aria-hidden":"true",children:"refresh"}),"Resetta Filtri"]})})]})]}),e.jsxs("section",{className:"mb-3",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2",children:[e.jsx(k,{filters:h,onClearFilter:e=>{"search"===e&&I(""),x({[e]:void 0})}}),F&&F.totalCount>0&&e.jsxs("div",{className:"text-muted small",children:["Mostrando ",e.jsx("strong",{children:F.patients.length})," di ",e.jsx("strong",{children:F.totalCount}),F.totalCount>10&&e.jsxs("span",{children:[" (pagina ",(h.page??0)+1," di ",F.totalPages,")"]})]})]}),e.jsxs("div",{className:"sort-controls-card",children:[e.jsxs("div",{className:"sort-selector",children:[e.jsx("label",{className:"sort-control-label",id:"sort-selector-label",children:"Ordina per:"}),e.jsx("div",{className:"sort-selector-buttons",role:"group","aria-labelledby":"sort-selector-label",children:Y.map(t=>{const i=h.sortColumn===t.value,a=i?"asc"===h.sortDirection?"arrow_upward":"arrow_downward":"unfold_more",n=i?"asc"===h.sortDirection?"in ordine crescente":"in ordine decrescente":"senza ordine applicato";return e.jsxs("button",{type:"button",className:"btn sort-selector-button"+(i?" sort-selector-button--active":""),onClick:()=>(e=>{w(e)})(t.value),"aria-pressed":i,"aria-label":`Ordina per ${t.label} ${n}`,children:[t.label,e.jsxs("span",{className:"visually-hidden",children:[" ",n]}),e.jsx("span",{className:"material-icons","aria-hidden":"true",children:a})]},t.value)})})]}),F&&F.totalCount>0&&e.jsxs("div",{className:"export-controls",children:[e.jsx("label",{className:"sort-control-label",id:"export-controls-label",children:"Esporta:"}),e.jsxs("div",{className:"export-buttons",role:"group","aria-labelledby":"export-controls-label",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary export-button",onClick:()=>ae("csv"),disabled:null!==A,children:e.jsxs(e.Fragment,"csv"===A?{children:[e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"}),e.jsx("span",{children:"CSV"})]}:{children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"download"}),e.jsx("span",{children:"CSV"})]})}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary export-button",onClick:()=>ae("json"),disabled:null!==A,children:e.jsxs(e.Fragment,"json"===A?{children:[e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"}),e.jsx("span",{children:"JSON"})]}:{children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"code"}),e.jsx("span",{children:"JSON"})]})})]})]})]})]}),M&&e.jsx("div",{className:"alert alert-danger",children:"Errore nel caricamento."}),e.jsx(Q,{patients:F?.patients??[],loading:q||V,onDelete:"admin"===z?.role?e=>{if("admin"!==z?.role)return i.error("Non hai i permessi per eliminare pazienti").show(),void 0;te("Conferma Eliminazione",`Sei sicuro di voler eliminare il paziente ${e.nome} ${e.cognome}?`,()=>J.mutate(e.id))}:void 0,onDischarge:e=>{te("Conferma Dimissione",`Sei sicuro di voler dimettere il paziente ${e.nome} ${e.cognome}?`,()=>L.mutate(e.id))},onReactivate:e=>{te("Conferma Riattivazione",`Sei sicuro di voler riattivare il paziente ${e.nome} ${e.cognome}?`,()=>H.mutate(e.id))},onEdit:e=>{sessionStorage.setItem("editPazienteId",e.id),t(`/inserimento?id=${e.id}`)},onAddIntervention:e=>ie("add-intervention",e),onAddInfection:e=>ie("add-infection",e),onViewEvents:e=>ie("view-events",e),onResetFilters:Z,showActions:!0}),F&&F.totalPages>1&&e.jsx("nav",{className:"patient-pagination",children:e.jsxs("ul",{className:"pagination mb-0",children:[e.jsx("li",{className:"page-item "+(F.hasPrevPage?"":"disabled"),children:e.jsx("button",{className:"page-link",onClick:()=>ee("prev"),disabled:!F.hasPrevPage,"aria-label":"Pagina precedente",children:"â€¹"})}),e.jsx("li",{className:"page-item active",children:e.jsxs("span",{className:"page-link",children:["Pagina ",(h.page??0)+1," di ",F.totalPages]})}),e.jsx("li",{className:"page-item "+(F.hasNextPage?"":"disabled"),children:e.jsx("button",{className:"page-link",onClick:()=>ee("next"),disabled:!F.hasNextPage,"aria-label":"Pagina successiva",children:"â€º"})})]})})]})},X={attivo:"Attivi",dimesso:"Dimessi"},ee={dimissione:"Dimissioni",trasferimento_interno:"Trasferimenti interni",trasferimento_esterno:"Trasferimenti esterni",decesso:"Decessi"},te=["dimissione","trasferimento_interno","trasferimento_esterno","decesso"],ie={true:"SÃ¬",false:"No"},ae=[{value:void 0,label:"Tutti"},{value:"true",label:ie.true},{value:"false",label:ie.false}];function ne(e){if(!e)return H;const t=[{value:void 0,label:"Tutti"}];return e.hasActive&&t.push({value:"attivo",label:X.attivo}),e.hasDimesso&&t.push({value:"dimesso",label:X.dimesso}),t.length>1?t:H}function se(e){if(!e||0===e.length)return U;const t=Array.from(new Set(e));return t.sort((e,t)=>te.indexOf(e)-te.indexOf(t)),[{value:void 0,label:"Tutti"},...t.map(e=>({value:e,label:ee[e]??e}))]}function re(e){if(!e||0===e.length)return ae;const t=Array.from(new Set(e)),i=["true","false"].filter(e=>t.includes(e)),a=[{value:void 0,label:"Tutti"}];return i.forEach(e=>{a.push({value:e,label:ie[e]})}),a}const oe=d.memo(Z);export{Z as PatientListPage,oe as default};
