import{r as t,j as e,R as s}from"./auth-feature-BcTinZZO.js";import{l as a,s as i}from"./core-services-qaelRMFP.js";import{D as r,C as n,l as o,a as l,b as c,c as u,d as h}from"./shared-CpQNZA6K.js";import{C as d}from"./charts-vendor-BWtMAC_w.js";var p=class{constructor(){this.listeners=new Set,this.subscribe=this.subscribe.bind(this)}subscribe(t){return this.listeners.add(t),this.onSubscribe(),()=>{this.listeners.delete(t),this.onUnsubscribe()}}hasListeners(){return this.listeners.size>0}onSubscribe(){}onUnsubscribe(){}},f={setTimeout:(t,e)=>setTimeout(t,e),clearTimeout:t=>clearTimeout(t),setInterval:(t,e)=>setInterval(t,e),clearInterval:t=>clearInterval(t)},m=new class{#t=f;#e=!1;setTimeoutProvider(t){this.#t=t}setTimeout(t,e){return this.#t.setTimeout(t,e)}clearTimeout(t){this.#t.clearTimeout(t)}setInterval(t,e){return this.#t.setInterval(t,e)}clearInterval(t){this.#t.clearInterval(t)}};var g="undefined"==typeof window||"Deno"in globalThis;function y(){}function b(t){return"number"==typeof t&&t>=0&&t!==1/0}function v(t,e){return Math.max(t+(e||0)-Date.now(),0)}function C(t,e){return"function"==typeof t?t(e):t}function _(t,e){return"function"==typeof t?t(e):t}function w(t,e){const{type:s="all",exact:a,fetchStatus:i,predicate:r,queryKey:n,stale:o}=t;if(n)if(a){if(e.queryHash!==D(n,e.options))return!1}else if(!O(e.queryKey,n))return!1;if("all"!==s){const t=e.isActive();if("active"===s&&!t)return!1;if("inactive"===s&&t)return!1}return("boolean"!=typeof o||e.isStale()===o)&&((!i||i===e.state.fetchStatus)&&!(r&&!r(e)))}function R(t,e){const{exact:s,status:a,predicate:i,mutationKey:r}=t;if(r){if(!e.options.mutationKey)return!1;if(s){if(x(e.options.mutationKey)!==x(r))return!1}else if(!O(e.options.mutationKey,r))return!1}return(!a||e.state.status===a)&&!(i&&!i(e))}function D(t,e){return(e?.queryKeyHashFn||x)(t)}function x(t){return JSON.stringify(t,(t,e)=>E(e)?Object.keys(e).sort().reduce((t,s)=>(t[s]=e[s],t),{}):e)}function O(t,e){return t===e||typeof t==typeof e&&(!(!t||!e||"object"!=typeof t||"object"!=typeof e)&&Object.keys(e).every(s=>O(t[s],e[s])))}var A=Object.prototype.hasOwnProperty;function S(t,e){if(t===e)return t;const s=j(t)&&j(e);if(!(s||E(t)&&E(e)))return e;const a=(s?t:Object.keys(t)).length,i=s?e:Object.keys(e),r=i.length,n=s?new Array(r):{};let o=0;for(let l=0;l<r;l++){const r=s?l:i[l],c=t[r],u=e[r];if(c===u){n[r]=c,(s?l<a:A.call(t,r))&&o++;continue}if(null===c||null===u||"object"!=typeof c||"object"!=typeof u){n[r]=u;continue}const h=S(c,u);n[r]=h,h===c&&o++}return a===r&&o===a?t:n}function N(t,e){if(!e||Object.keys(t).length!==Object.keys(e).length)return!1;for(const s in t)if(t[s]!==e[s])return!1;return!0}function j(t){return Array.isArray(t)&&t.length===Object.keys(t).length}function E(t){if(!T(t))return!1;const e=t.constructor;if(void 0===e)return!0;const s=e.prototype;return!!T(s)&&(!!s.hasOwnProperty("isPrototypeOf")&&Object.getPrototypeOf(t)===Object.prototype)}function T(t){return"[object Object]"===Object.prototype.toString.call(t)}function F(t,e,s){return"function"==typeof s.structuralSharing?s.structuralSharing(t,e):!1!==s.structuralSharing?S(t,e):e}function P(t){return t}function I(t,e,s=0){const a=[...t,e];return s&&a.length>s?a.slice(1):a}function k(t,e,s=0){const a=[e,...t];return s&&a.length>s?a.slice(0,-1):a}var z=Symbol();function q(t,e){return!t.queryFn&&e?.initialPromise?()=>e.initialPromise:t.queryFn&&t.queryFn!==z?t.queryFn:()=>Promise.reject(new Error(`Missing queryFn: '${t.queryHash}'`))}function M(t,e){return"function"==typeof t?t(...e):!!t}var Q=new class extends p{#s;#a;#i;constructor(){super(),this.#i=t=>{if(!g&&window.addEventListener){const e=()=>t();return window.addEventListener("visibilitychange",e,!1),()=>{window.removeEventListener("visibilitychange",e)}}}}onSubscribe(){this.#a||this.setEventListener(this.#i)}onUnsubscribe(){this.hasListeners()||(this.#a?.(),this.#a=void 0)}setEventListener(t){this.#i=t,this.#a?.(),this.#a=t(t=>{"boolean"==typeof t?this.setFocused(t):this.onFocus()})}setFocused(t){this.#s!==t&&(this.#s=t,this.onFocus())}onFocus(){const t=this.isFocused();this.listeners.forEach(e=>{e(t)})}isFocused(){return"boolean"==typeof this.#s?this.#s:"hidden"!==globalThis.document?.visibilityState}};function L(){let t,e;const s=new Promise((s,a)=>{t=s,e=a});function a(t){Object.assign(s,t),delete s.resolve,delete s.reject}return s.status="pending",s.catch(()=>{}),s.resolve=e=>{a({status:"fulfilled",value:e}),t(e)},s.reject=t=>{a({status:"rejected",reason:t}),e(t)},s}var $=function(t){setTimeout(t,0)};var U=function(){let t=[],e=0,s=t=>{t()},a=t=>{t()},i=$;const r=a=>{e?t.push(a):i(()=>{s(a)})};return{batch:r=>{let n;e++;try{n=r()}finally{e--,e||(()=>{const e=t;t=[],e.length&&i(()=>{a(()=>{e.forEach(t=>{s(t)})})})})()}return n},batchCalls:t=>(...e)=>{r(()=>{t(...e)})},schedule:r,setNotifyFunction:t=>{s=t},setBatchNotifyFunction:t=>{a=t},setScheduler:t=>{i=t}}}(),B=new class extends p{#r=!0;#a;#i;constructor(){super(),this.#i=t=>{if(!g&&window.addEventListener){const e=()=>t(!0),s=()=>t(!1);return window.addEventListener("online",e,!1),window.addEventListener("offline",s,!1),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",s)}}}}onSubscribe(){this.#a||this.setEventListener(this.#i)}onUnsubscribe(){this.hasListeners()||(this.#a?.(),this.#a=void 0)}setEventListener(t){this.#i=t,this.#a?.(),this.#a=t(this.setOnline.bind(this))}setOnline(t){this.#r!==t&&(this.#r=t,this.listeners.forEach(e=>{e(t)}))}isOnline(){return this.#r}};function K(t){return Math.min(1e3*2**t,3e4)}function H(t){return"online"!==(t??"online")||B.isOnline()}var W=class extends Error{constructor(t){super("CancelledError"),this.revert=t?.revert,this.silent=t?.silent}};function G(t){let e,s=!1,a=0;const i=L(),r=()=>"pending"!==i.status,n=()=>Q.isFocused()&&("always"===t.networkMode||B.isOnline())&&t.canRun(),o=()=>H(t.networkMode)&&t.canRun(),l=t=>{r()||(e?.(),i.resolve(t))},c=t=>{r()||(e?.(),i.reject(t))},u=()=>new Promise(s=>{e=t=>{(r()||n())&&s(t)},t.onPause?.()}).then(()=>{e=void 0,r()||t.onContinue?.()}),h=()=>{if(r())return;let e;const i=0===a?t.initialPromise:void 0;try{e=i??t.fn()}catch(o){e=Promise.reject(o)}Promise.resolve(e).then(l).catch(e=>{if(r())return;const i=t.retry??(g?0:3),o=t.retryDelay??K,l="function"==typeof o?o(a,e):o,d=!0===i||"number"==typeof i&&a<i||"function"==typeof i&&i(a,e);if(s||!d)return c(e),void 0;var p;a++,t.onFail?.(a,e),(p=l,new Promise(t=>{m.setTimeout(t,p)})).then(()=>n()?void 0:u()).then(()=>{s?c(e):h()})})};return{promise:i,status:()=>i.status,cancel:e=>{if(!r()){const s=new W(e);c(s),t.onCancel?.(s)}},continue:()=>(e?.(),i),cancelRetry:()=>{s=!0},continueRetry:()=>{s=!1},canStart:o,start:()=>(o()?h():u().then(h),i)}}var J=class{#n;destroy(){this.clearGcTimeout()}scheduleGc(){this.clearGcTimeout(),b(this.gcTime)&&(this.#n=m.setTimeout(()=>{this.optionalRemove()},this.gcTime))}updateGcTime(t){this.gcTime=Math.max(this.gcTime||0,t??(g?1/0:3e5))}clearGcTimeout(){this.#n&&(m.clearTimeout(this.#n),this.#n=void 0)}},V=class extends J{#o;#l;#c;#u;#h;#d;#p;constructor(t){super(),this.#p=!1,this.#d=t.defaultOptions,this.setOptions(t.options),this.observers=[],this.#u=t.client,this.#c=this.#u.getQueryCache(),this.queryKey=t.queryKey,this.queryHash=t.queryHash,this.#o=Y(this.options),this.state=t.state??this.#o,this.scheduleGc()}get meta(){return this.options.meta}get promise(){return this.#h?.promise}setOptions(t){if(this.options={...this.#d,...t},this.updateGcTime(this.options.gcTime),this.state&&void 0===this.state.data){const t=Y(this.options);void 0!==t.data&&(this.setData(t.data,{updatedAt:t.dataUpdatedAt,manual:!0}),this.#o=t)}}optionalRemove(){this.observers.length||"idle"!==this.state.fetchStatus||this.#c.remove(this)}setData(t,e){const s=F(this.state.data,t,this.options);return this.#f({data:s,type:"success",dataUpdatedAt:e?.updatedAt,manual:e?.manual}),s}setState(t,e){this.#f({type:"setState",state:t,setStateOptions:e})}cancel(t){const e=this.#h?.promise;return this.#h?.cancel(t),e?e.then(y).catch(y):Promise.resolve()}destroy(){super.destroy(),this.cancel({silent:!0})}reset(){this.destroy(),this.setState(this.#o)}isActive(){return this.observers.some(t=>!1!==_(t.options.enabled,this))}isDisabled(){return this.getObserversCount()>0?!this.isActive():this.options.queryFn===z||this.state.dataUpdateCount+this.state.errorUpdateCount===0}isStatic(){return this.getObserversCount()>0&&this.observers.some(t=>"static"===C(t.options.staleTime,this))}isStale(){return this.getObserversCount()>0?this.observers.some(t=>t.getCurrentResult().isStale):void 0===this.state.data||this.state.isInvalidated}isStaleByTime(t=0){return void 0===this.state.data||"static"!==t&&(!!this.state.isInvalidated||!v(this.state.dataUpdatedAt,t))}onFocus(){const t=this.observers.find(t=>t.shouldFetchOnWindowFocus());t?.refetch({cancelRefetch:!1}),this.#h?.continue()}onOnline(){const t=this.observers.find(t=>t.shouldFetchOnReconnect());t?.refetch({cancelRefetch:!1}),this.#h?.continue()}addObserver(t){this.observers.includes(t)||(this.observers.push(t),this.clearGcTimeout(),this.#c.notify({type:"observerAdded",query:this,observer:t}))}removeObserver(t){this.observers.includes(t)&&(this.observers=this.observers.filter(e=>e!==t),this.observers.length||(this.#h&&(this.#p?this.#h.cancel({revert:!0}):this.#h.cancelRetry()),this.scheduleGc()),this.#c.notify({type:"observerRemoved",query:this,observer:t}))}getObserversCount(){return this.observers.length}invalidate(){this.state.isInvalidated||this.#f({type:"invalidate"})}async fetch(t,e){if("idle"!==this.state.fetchStatus&&"rejected"!==this.#h?.status())if(void 0!==this.state.data&&e?.cancelRefetch)this.cancel({silent:!0});else if(this.#h)return this.#h.continueRetry(),this.#h.promise;if(t&&this.setOptions(t),!this.options.queryFn){const t=this.observers.find(t=>t.options.queryFn);t&&this.setOptions(t.options)}const s=new AbortController,a=t=>{Object.defineProperty(t,"signal",{enumerable:!0,get:()=>(this.#p=!0,s.signal)})},i=()=>{const t=q(this.options,e),s=(()=>{const t={client:this.#u,queryKey:this.queryKey,meta:this.meta};return a(t),t})();return this.#p=!1,this.options.persister?this.options.persister(t,s,this):t(s)},r=(()=>{const t={fetchOptions:e,options:this.options,queryKey:this.queryKey,client:this.#u,state:this.state,fetchFn:i};return a(t),t})();this.options.behavior?.onFetch(r,this),this.#l=this.state,"idle"!==this.state.fetchStatus&&this.state.fetchMeta===r.fetchOptions?.meta||this.#f({type:"fetch",meta:r.fetchOptions?.meta}),this.#h=G({initialPromise:e?.initialPromise,fn:r.fetchFn,onCancel:t=>{t instanceof W&&t.revert&&this.setState({...this.#l,fetchStatus:"idle"}),s.abort()},onFail:(t,e)=>{this.#f({type:"failed",failureCount:t,error:e})},onPause:()=>{this.#f({type:"pause"})},onContinue:()=>{this.#f({type:"continue"})},retry:r.options.retry,retryDelay:r.options.retryDelay,networkMode:r.options.networkMode,canRun:()=>!0});try{const t=await this.#h.start();if(void 0===t)throw 0,new Error(`${this.queryHash} data is undefined`);return this.setData(t),this.#c.config.onSuccess?.(t,this),this.#c.config.onSettled?.(t,this.state.error,this),t}catch(n){if(n instanceof W){if(n.silent)return this.#h.promise;if(n.revert){if(void 0===this.state.data)throw n;return this.state.data}}throw this.#f({type:"error",error:n}),this.#c.config.onError?.(n,this),this.#c.config.onSettled?.(this.state.data,n,this),n}finally{this.scheduleGc()}}#f(t){this.state=(e=>{switch(t.type){case"failed":return{...e,fetchFailureCount:t.failureCount,fetchFailureReason:t.error};case"pause":return{...e,fetchStatus:"paused"};case"continue":return{...e,fetchStatus:"fetching"};case"fetch":return{...e,...Z(e.data,this.options),fetchMeta:t.meta??null};case"success":const s={...e,data:t.data,dataUpdateCount:e.dataUpdateCount+1,dataUpdatedAt:t.dataUpdatedAt??Date.now(),error:null,isInvalidated:!1,status:"success",...!t.manual&&{fetchStatus:"idle",fetchFailureCount:0,fetchFailureReason:null}};return this.#l=t.manual?s:void 0,s;case"error":const a=t.error;return{...e,error:a,errorUpdateCount:e.errorUpdateCount+1,errorUpdatedAt:Date.now(),fetchFailureCount:e.fetchFailureCount+1,fetchFailureReason:a,fetchStatus:"idle",status:"error"};case"invalidate":return{...e,isInvalidated:!0};case"setState":return{...e,...t.state}}})(this.state),U.batch(()=>{this.observers.forEach(t=>{t.onQueryUpdate()}),this.#c.notify({query:this,type:"updated",action:t})})}};function Z(t,e){return{fetchFailureCount:0,fetchFailureReason:null,fetchStatus:H(e.networkMode)?"fetching":"paused",...void 0===t&&{error:null,status:"pending"}}}function Y(t){const e="function"==typeof t.initialData?t.initialData():t.initialData,s=void 0!==e,a=s?"function"==typeof t.initialDataUpdatedAt?t.initialDataUpdatedAt():t.initialDataUpdatedAt:0;return{data:e,dataUpdateCount:0,dataUpdatedAt:s?a??Date.now():0,error:null,errorUpdateCount:0,errorUpdatedAt:0,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:null,isInvalidated:!1,status:s?"success":"pending",fetchStatus:"idle"}}var X=class extends p{constructor(t,e){super(),this.options=e,this.#u=t,this.#m=null,this.#g=L(),this.bindMethods(),this.setOptions(e)}#u;#y=void 0;#b=void 0;#v=void 0;#C;#_;#g;#m;#w;#R;#D;#x;#O;#A;#S=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){1===this.listeners.size&&(this.#y.addObserver(this),tt(this.#y,this.options)?this.#N():this.updateResult(),this.#j())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return et(this.#y,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return et(this.#y,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#E(),this.#T(),this.#y.removeObserver(this)}setOptions(t){const e=this.options,s=this.#y;if(this.options=this.#u.defaultQueryOptions(t),void 0!==this.options.enabled&&"boolean"!=typeof this.options.enabled&&"function"!=typeof this.options.enabled&&"boolean"!=typeof _(this.options.enabled,this.#y))throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#F(),this.#y.setOptions(this.options),e._defaulted&&!N(this.options,e)&&this.#u.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#y,observer:this});const a=this.hasListeners();a&&st(this.#y,s,this.options,e)&&this.#N(),this.updateResult(),!a||this.#y===s&&_(this.options.enabled,this.#y)===_(e.enabled,this.#y)&&C(this.options.staleTime,this.#y)===C(e.staleTime,this.#y)||this.#P();const i=this.#I();!a||this.#y===s&&_(this.options.enabled,this.#y)===_(e.enabled,this.#y)&&i===this.#A||this.#k(i)}getOptimisticResult(t){const e=this.#u.getQueryCache().build(this.#u,t),s=this.createResult(e,t);return function(t,e){if(!N(t.getCurrentResult(),e))return!0;return!1}(this,s)&&(this.#v=s,this.#_=this.options,this.#C=this.#y.state),s}getCurrentResult(){return this.#v}trackResult(t,e){return new Proxy(t,{get:(t,s)=>(this.trackProp(s),e?.(s),"promise"===s&&(this.trackProp("data"),this.options.experimental_prefetchInRender||"pending"!==this.#g.status||this.#g.reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(t,s))})}trackProp(t){this.#S.add(t)}getCurrentQuery(){return this.#y}refetch({...t}={}){return this.fetch({...t})}fetchOptimistic(t){const e=this.#u.defaultQueryOptions(t),s=this.#u.getQueryCache().build(this.#u,e);return s.fetch().then(()=>this.createResult(s,e))}fetch(t){return this.#N({...t,cancelRefetch:t.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#v))}#N(t){this.#F();let e=this.#y.fetch(this.options,t);return t?.throwOnError||(e=e.catch(y)),e}#P(){this.#E();const t=C(this.options.staleTime,this.#y);if(g||this.#v.isStale||!b(t))return;const e=v(this.#v.dataUpdatedAt,t);this.#x=m.setTimeout(()=>{this.#v.isStale||this.updateResult()},e+1)}#I(){return("function"==typeof this.options.refetchInterval?this.options.refetchInterval(this.#y):this.options.refetchInterval)??!1}#k(t){this.#T(),this.#A=t,!g&&!1!==_(this.options.enabled,this.#y)&&b(this.#A)&&0!==this.#A&&(this.#O=m.setInterval(()=>{(this.options.refetchIntervalInBackground||Q.isFocused())&&this.#N()},this.#A))}#j(){this.#P(),this.#k(this.#I())}#E(){this.#x&&(m.clearTimeout(this.#x),this.#x=void 0)}#T(){this.#O&&(m.clearInterval(this.#O),this.#O=void 0)}createResult(t,e){const s=this.#y,a=this.options,i=this.#v,r=this.#C,n=this.#_,o=t!==s?t.state:this.#b,{state:l}=t;let c,u={...l},h=!1;if(e._optimisticResults){const i=this.hasListeners(),r=!i&&tt(t,e),n=i&&st(t,s,e,a);(r||n)&&(u={...u,...Z(l.data,t.options)}),"isRestoring"===e._optimisticResults&&(u.fetchStatus="idle")}let{error:d,errorUpdatedAt:p,status:f}=u;c=u.data;let m=!1;if(void 0!==e.placeholderData&&void 0===c&&"pending"===f){let t;i?.isPlaceholderData&&e.placeholderData===n?.placeholderData?(t=i.data,m=!0):t="function"==typeof e.placeholderData?e.placeholderData(this.#D?.state.data,this.#D):e.placeholderData,void 0!==t&&(f="success",c=F(i?.data,t,e),h=!0)}if(e.select&&void 0!==c&&!m)if(i&&c===r?.data&&e.select===this.#w)c=this.#R;else try{this.#w=e.select,c=e.select(c),c=F(i?.data,c,e),this.#R=c,this.#m=null}catch(R){this.#m=R}this.#m&&(d=this.#m,c=this.#R,p=Date.now(),f="error");const g="fetching"===u.fetchStatus,y="pending"===f,b="error"===f,v=y&&g,C=void 0!==c,w={status:f,fetchStatus:u.fetchStatus,isPending:y,isSuccess:"success"===f,isError:b,isInitialLoading:v,isLoading:v,data:c,dataUpdatedAt:u.dataUpdatedAt,error:d,errorUpdatedAt:p,failureCount:u.fetchFailureCount,failureReason:u.fetchFailureReason,errorUpdateCount:u.errorUpdateCount,isFetched:u.dataUpdateCount>0||u.errorUpdateCount>0,isFetchedAfterMount:u.dataUpdateCount>o.dataUpdateCount||u.errorUpdateCount>o.errorUpdateCount,isFetching:g,isRefetching:g&&!y,isLoadingError:b&&!C,isPaused:"paused"===u.fetchStatus,isPlaceholderData:h,isRefetchError:b&&C,isStale:at(t,e),refetch:this.refetch,promise:this.#g,isEnabled:!1!==_(e.enabled,t)};if(this.options.experimental_prefetchInRender){const e=t=>{"error"===w.status?t.reject(w.error):void 0!==w.data&&t.resolve(w.data)},a=()=>{const t=this.#g=w.promise=L();e(t)},i=this.#g;switch(i.status){case"pending":t.queryHash===s.queryHash&&e(i);break;case"fulfilled":"error"!==w.status&&w.data===i.value||a();break;case"rejected":"error"===w.status&&w.error===i.reason||a()}}return w}updateResult(){const t=this.#v,e=this.createResult(this.#y,this.options);if(this.#C=this.#y.state,this.#_=this.options,void 0!==this.#C.data&&(this.#D=this.#y),N(e,t))return;this.#v=e;this.#z({listeners:(()=>{if(!t)return!0;const{notifyOnChangeProps:e}=this.options,s="function"==typeof e?e():e;if("all"===s||!s&&!this.#S.size)return!0;const a=new Set(s??this.#S);return this.options.throwOnError&&a.add("error"),Object.keys(this.#v).some(e=>this.#v[e]!==t[e]&&a.has(e))})()})}#F(){const t=this.#u.getQueryCache().build(this.#u,this.options);if(t===this.#y)return;const e=this.#y;this.#y=t,this.#b=t.state,this.hasListeners()&&(e?.removeObserver(this),t.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#j()}#z(t){U.batch(()=>{t.listeners&&this.listeners.forEach(t=>{t(this.#v)}),this.#u.getQueryCache().notify({query:this.#y,type:"observerResultsUpdated"})})}};function tt(t,e){return function(t,e){return!1!==_(e.enabled,t)&&void 0===t.state.data&&!("error"===t.state.status&&!1===e.retryOnMount)}(t,e)||void 0!==t.state.data&&et(t,e,e.refetchOnMount)}function et(t,e,s){if(!1!==_(e.enabled,t)&&"static"!==C(e.staleTime,t)){const a="function"==typeof s?s(t):s;return"always"===a||!1!==a&&at(t,e)}return!1}function st(t,e,s,a){return(t!==e||!1===_(a.enabled,t))&&(!s.suspense||"error"!==t.state.status)&&at(t,s)}function at(t,e){return!1!==_(e.enabled,t)&&t.isStaleByTime(C(e.staleTime,t))}function it(t){return{onFetch:(e,s)=>{const a=e.options,i=e.fetchOptions?.meta?.fetchMore?.direction,r=e.state.data?.pages||[],n=e.state.data?.pageParams||[];let o={pages:[],pageParams:[]},l=0;const c=async()=>{let s=!1;const c=q(e.options,e.fetchOptions),u=async(t,a,i)=>{if(s)return Promise.reject();if(null==a&&t.pages.length)return Promise.resolve(t);const r=(()=>{const t={client:e.client,queryKey:e.queryKey,pageParam:a,direction:i?"backward":"forward",meta:e.options.meta};return void Object.defineProperty(t,"signal",{enumerable:!0,get:()=>(e.signal.aborted?s=!0:e.signal.addEventListener("abort",()=>{s=!0}),e.signal)}),t})(),n=await c(r),{maxPages:o}=e.options,l=i?k:I;return{pages:l(t.pages,n,o),pageParams:l(t.pageParams,a,o)}};if(i&&r.length){const t="backward"===i,e={pages:r,pageParams:n},s=(t?nt:rt)(a,e);o=await u(e,s,t)}else{const e=t??r.length;do{const t=0===l?n[0]??a.initialPageParam:rt(a,o);if(l>0&&null==t)break;o=await u(o,t),l++}while(l<e)}return o};e.fetchFn=e.options.persister?()=>e.options.persister?.(c,{client:e.client,queryKey:e.queryKey,meta:e.options.meta,signal:e.signal},s):c}}}function rt(t,{pages:e,pageParams:s}){const a=e.length-1;return e.length>0?t.getNextPageParam(e[a],e,s[a],s):void 0}function nt(t,{pages:e,pageParams:s}){return e.length>0?t.getPreviousPageParam?.(e[0],e,s[0],s):void 0}var ot=class extends J{#u;#q;#M;#h;constructor(t){super(),this.#u=t.client,this.mutationId=t.mutationId,this.#M=t.mutationCache,this.#q=[],this.state=t.state||{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0},this.setOptions(t.options),this.scheduleGc()}setOptions(t){this.options=t,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(t){this.#q.includes(t)||(this.#q.push(t),this.clearGcTimeout(),this.#M.notify({type:"observerAdded",mutation:this,observer:t}))}removeObserver(t){this.#q=this.#q.filter(e=>e!==t),this.scheduleGc(),this.#M.notify({type:"observerRemoved",mutation:this,observer:t})}optionalRemove(){this.#q.length||("pending"===this.state.status?this.scheduleGc():this.#M.remove(this))}continue(){return this.#h?.continue()??this.execute(this.state.variables)}async execute(t){const e=()=>{this.#f({type:"continue"})},s={client:this.#u,meta:this.options.meta,mutationKey:this.options.mutationKey};this.#h=G({fn:()=>this.options.mutationFn?this.options.mutationFn(t,s):Promise.reject(new Error("No mutationFn found")),onFail:(t,e)=>{this.#f({type:"failed",failureCount:t,error:e})},onPause:()=>{this.#f({type:"pause"})},onContinue:e,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>this.#M.canRun(this)});const a="pending"===this.state.status,i=!this.#h.canStart();try{if(a)e();else{this.#f({type:"pending",variables:t,isPaused:i}),await(this.#M.config.onMutate?.(t,this,s));const e=await(this.options.onMutate?.(t,s));e!==this.state.context&&this.#f({type:"pending",context:e,variables:t,isPaused:i})}const r=await this.#h.start();return await(this.#M.config.onSuccess?.(r,t,this.state.context,this,s)),await(this.options.onSuccess?.(r,t,this.state.context,s)),await(this.#M.config.onSettled?.(r,null,this.state.variables,this.state.context,this,s)),await(this.options.onSettled?.(r,null,t,this.state.context,s)),this.#f({type:"success",data:r}),r}catch(r){try{throw await(this.#M.config.onError?.(r,t,this.state.context,this,s)),await(this.options.onError?.(r,t,this.state.context,s)),await(this.#M.config.onSettled?.(void 0,r,this.state.variables,this.state.context,this,s)),await(this.options.onSettled?.(void 0,r,t,this.state.context,s)),r}finally{this.#f({type:"error",error:r})}}finally{this.#M.runNext(this)}}#f(t){this.state=(e=>{switch(t.type){case"failed":return{...e,failureCount:t.failureCount,failureReason:t.error};case"pause":return{...e,isPaused:!0};case"continue":return{...e,isPaused:!1};case"pending":return{...e,context:t.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:t.isPaused,status:"pending",variables:t.variables,submittedAt:Date.now()};case"success":return{...e,data:t.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...e,data:void 0,error:t.error,failureCount:e.failureCount+1,failureReason:t.error,isPaused:!1,status:"error"}}})(this.state),U.batch(()=>{this.#q.forEach(e=>{e.onMutationUpdate(t)}),this.#M.notify({mutation:this,type:"updated",action:t})})}};var lt=class extends p{constructor(t={}){super(),this.config=t,this.#Q=new Set,this.#L=new Map,this.#$=0}#Q;#L;#$;build(t,e,s){const a=new ot({client:t,mutationCache:this,mutationId:++this.#$,options:t.defaultMutationOptions(e),state:s});return this.add(a),a}add(t){this.#Q.add(t);const e=ct(t);if("string"==typeof e){const s=this.#L.get(e);s?s.push(t):this.#L.set(e,[t])}this.notify({type:"added",mutation:t})}remove(t){if(this.#Q.delete(t)){const e=ct(t);if("string"==typeof e){const s=this.#L.get(e);if(s)if(s.length>1){const e=s.indexOf(t);-1!==e&&s.splice(e,1)}else s[0]===t&&this.#L.delete(e)}}this.notify({type:"removed",mutation:t})}canRun(t){const e=ct(t);if("string"==typeof e){const s=this.#L.get(e),a=s?.find(t=>"pending"===t.state.status);return!a||a===t}return!0}runNext(t){const e=ct(t);if("string"==typeof e){const s=this.#L.get(e)?.find(e=>e!==t&&e.state.isPaused);return s?.continue()??Promise.resolve()}return Promise.resolve()}clear(){U.batch(()=>{this.#Q.forEach(t=>{this.notify({type:"removed",mutation:t})}),this.#Q.clear(),this.#L.clear()})}getAll(){return Array.from(this.#Q)}find(t){const e={exact:!0,...t};return this.getAll().find(t=>R(e,t))}findAll(t={}){return this.getAll().filter(e=>R(t,e))}notify(t){U.batch(()=>{this.listeners.forEach(e=>{e(t)})})}resumePausedMutations(){const t=this.getAll().filter(t=>t.state.isPaused);return U.batch(()=>Promise.all(t.map(t=>t.continue().catch(y))))}};function ct(t){return t.options.scope?.id}var ut=class extends p{#u;#v=void 0;#U;#B;constructor(t,e){super(),this.#u=t,this.setOptions(e),this.bindMethods(),this.#K()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(t){const e=this.options;this.options=this.#u.defaultMutationOptions(t),N(this.options,e)||this.#u.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#U,observer:this}),e?.mutationKey&&this.options.mutationKey&&x(e.mutationKey)!==x(this.options.mutationKey)?this.reset():"pending"===this.#U?.state.status&&this.#U.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#U?.removeObserver(this)}onMutationUpdate(t){this.#K(),this.#z(t)}getCurrentResult(){return this.#v}reset(){this.#U?.removeObserver(this),this.#U=void 0,this.#K(),this.#z()}mutate(t,e){return this.#B=e,this.#U?.removeObserver(this),this.#U=this.#u.getMutationCache().build(this.#u,this.options),this.#U.addObserver(this),this.#U.execute(t)}#K(){const t=this.#U?.state??{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0};this.#v={...t,isPending:"pending"===t.status,isSuccess:"success"===t.status,isError:"error"===t.status,isIdle:"idle"===t.status,mutate:this.mutate,reset:this.reset}}#z(t){U.batch(()=>{if(this.#B&&this.hasListeners()){const e=this.#v.variables,s=this.#v.context,a={client:this.#u,meta:this.options.meta,mutationKey:this.options.mutationKey};"success"===t?.type?(this.#B.onSuccess?.(t.data,e,s,a),this.#B.onSettled?.(t.data,null,e,s,a)):"error"===t?.type&&(this.#B.onError?.(t.error,e,s,a),this.#B.onSettled?.(void 0,t.error,e,s,a))}this.listeners.forEach(t=>{t(this.#v)})})}},ht=class extends p{constructor(t={}){super(),this.config=t,this.#H=new Map}#H;build(t,e,s){const a=e.queryKey,i=e.queryHash??D(a,e);let r=this.get(i);return r||(r=new V({client:t,queryKey:a,queryHash:i,options:t.defaultQueryOptions(e),state:s,defaultOptions:t.getQueryDefaults(a)}),this.add(r)),r}add(t){this.#H.has(t.queryHash)||(this.#H.set(t.queryHash,t),this.notify({type:"added",query:t}))}remove(t){const e=this.#H.get(t.queryHash);e&&(t.destroy(),e===t&&this.#H.delete(t.queryHash),this.notify({type:"removed",query:t}))}clear(){U.batch(()=>{this.getAll().forEach(t=>{this.remove(t)})})}get(t){return this.#H.get(t)}getAll(){return[...this.#H.values()]}find(t){const e={exact:!0,...t};return this.getAll().find(t=>w(e,t))}findAll(t={}){const e=this.getAll();return Object.keys(t).length>0?e.filter(e=>w(t,e)):e}notify(t){U.batch(()=>{this.listeners.forEach(e=>{e(t)})})}onFocus(){U.batch(()=>{this.getAll().forEach(t=>{t.onFocus()})})}onOnline(){U.batch(()=>{this.getAll().forEach(t=>{t.onOnline()})})}},dt=class{#W;#M;#d;#G;#J;#V;#Z;#Y;constructor(t={}){this.#W=t.queryCache||new ht,this.#M=t.mutationCache||new lt,this.#d=t.defaultOptions||{},this.#G=new Map,this.#J=new Map,this.#V=0}mount(){this.#V++,1===this.#V&&(this.#Z=Q.subscribe(async t=>{t&&(await this.resumePausedMutations(),this.#W.onFocus())}),this.#Y=B.subscribe(async t=>{t&&(await this.resumePausedMutations(),this.#W.onOnline())}))}unmount(){this.#V--,0===this.#V&&(this.#Z?.(),this.#Z=void 0,this.#Y?.(),this.#Y=void 0)}isFetching(t){return this.#W.findAll({...t,fetchStatus:"fetching"}).length}isMutating(t){return this.#M.findAll({...t,status:"pending"}).length}getQueryData(t){const e=this.defaultQueryOptions({queryKey:t});return this.#W.get(e.queryHash)?.state.data}ensureQueryData(t){const e=this.defaultQueryOptions(t),s=this.#W.build(this,e),a=s.state.data;return void 0===a?this.fetchQuery(t):(t.revalidateIfStale&&s.isStaleByTime(C(e.staleTime,s))&&void this.prefetchQuery(e),Promise.resolve(a))}getQueriesData(t){return this.#W.findAll(t).map(({queryKey:t,state:e})=>[t,e.data])}setQueryData(t,e,s){const a=this.defaultQueryOptions({queryKey:t}),i=this.#W.get(a.queryHash),r=i?.state.data,n=function(t,e){return"function"==typeof t?t(e):t}(e,r);if(void 0!==n)return this.#W.build(this,a).setData(n,{...s,manual:!0})}setQueriesData(t,e,s){return U.batch(()=>this.#W.findAll(t).map(({queryKey:t})=>[t,this.setQueryData(t,e,s)]))}getQueryState(t){const e=this.defaultQueryOptions({queryKey:t});return this.#W.get(e.queryHash)?.state}removeQueries(t){const e=this.#W;U.batch(()=>{e.findAll(t).forEach(t=>{e.remove(t)})})}resetQueries(t,e){const s=this.#W;return U.batch(()=>(s.findAll(t).forEach(t=>{t.reset()}),this.refetchQueries({type:"active",...t},e)))}cancelQueries(t,e={}){const s={revert:!0,...e},a=U.batch(()=>this.#W.findAll(t).map(t=>t.cancel(s)));return Promise.all(a).then(y).catch(y)}invalidateQueries(t,e={}){return U.batch(()=>(this.#W.findAll(t).forEach(t=>{t.invalidate()}),"none"===t?.refetchType?Promise.resolve():this.refetchQueries({...t,type:t?.refetchType??t?.type??"active"},e)))}refetchQueries(t,e={}){const s={...e,cancelRefetch:e.cancelRefetch??!0},a=U.batch(()=>this.#W.findAll(t).filter(t=>!t.isDisabled()&&!t.isStatic()).map(t=>{let e=t.fetch(void 0,s);return s.throwOnError||(e=e.catch(y)),"paused"===t.state.fetchStatus?Promise.resolve():e}));return Promise.all(a).then(y)}fetchQuery(t){const e=this.defaultQueryOptions(t);void 0===e.retry&&(e.retry=!1);const s=this.#W.build(this,e);return s.isStaleByTime(C(e.staleTime,s))?s.fetch(e):Promise.resolve(s.state.data)}prefetchQuery(t){return this.fetchQuery(t).then(y).catch(y)}fetchInfiniteQuery(t){return t.behavior=it(t.pages),this.fetchQuery(t)}prefetchInfiniteQuery(t){return this.fetchInfiniteQuery(t).then(y).catch(y)}ensureInfiniteQueryData(t){return t.behavior=it(t.pages),this.ensureQueryData(t)}resumePausedMutations(){return B.isOnline()?this.#M.resumePausedMutations():Promise.resolve()}getQueryCache(){return this.#W}getMutationCache(){return this.#M}getDefaultOptions(){return this.#d}setDefaultOptions(t){this.#d=t}setQueryDefaults(t,e){this.#G.set(x(t),{queryKey:t,defaultOptions:e})}getQueryDefaults(t){const e=[...this.#G.values()],s={};return e.forEach(e=>{O(t,e.queryKey)&&Object.assign(s,e.defaultOptions)}),s}setMutationDefaults(t,e){this.#J.set(x(t),{mutationKey:t,defaultOptions:e})}getMutationDefaults(t){const e=[...this.#J.values()],s={};return e.forEach(e=>{O(t,e.mutationKey)&&Object.assign(s,e.defaultOptions)}),s}defaultQueryOptions(t){if(t._defaulted)return t;const e={...this.#d.queries,...this.getQueryDefaults(t.queryKey),...t,_defaulted:!0};return e.queryHash||(e.queryHash=D(e.queryKey,e)),void 0===e.refetchOnReconnect&&(e.refetchOnReconnect="always"!==e.networkMode),void 0===e.throwOnError&&(e.throwOnError=!!e.suspense),!e.networkMode&&e.persister&&(e.networkMode="offlineFirst"),e.queryFn===z&&(e.enabled=!1),e}defaultMutationOptions(t){return t?._defaulted?t:{...this.#d.mutations,...t?.mutationKey&&this.getMutationDefaults(t.mutationKey),...t,_defaulted:!0}}clear(){this.#W.clear(),this.#M.clear()}},pt=t.createContext(void 0),ft=e=>{const s=t.useContext(pt);if(!s)throw new Error("No QueryClient set, use QueryClientProvider to set one");return s},mt=({client:s,children:a})=>(t.useEffect(()=>(s.mount(),()=>{s.unmount()}),[s]),e.jsx(pt.Provider,{value:s,children:a})),gt=t.createContext(!1);gt.Provider;var yt=t.createContext(function(){let t=!1;return{clearReset:()=>{t=!1},reset:()=>{t=!0},isReset:()=>t}}()),bt=(t,e,s)=>e.fetchOptimistic(t).catch(()=>{s.clearReset()});function vt(e,s,a){const i=t.useContext(gt),r=t.useContext(yt),n=ft(),o=n.defaultQueryOptions(e);n.getDefaultOptions().queries?._experimental_beforeQuery?.(o),o._optimisticResults=i?"isRestoring":"optimistic",(t=>{if(t.suspense){const e=1e3,s=t=>"static"===t?t:Math.max(t??e,e),a=t.staleTime;t.staleTime="function"==typeof a?(...t)=>s(a(...t)):s(a),"number"==typeof t.gcTime&&(t.gcTime=Math.max(t.gcTime,e))}})(o),((t,e)=>{(t.suspense||t.throwOnError||t.experimental_prefetchInRender)&&(e.isReset()||(t.retryOnMount=!1))})(o,r),(e=>{t.useEffect(()=>{e.clearReset()},[e])})(r);const l=!n.getQueryCache().get(o.queryHash),[c]=t.useState(()=>new s(n,o)),u=c.getOptimisticResult(o),h=!i&&!1!==e.subscribed;if(t.useSyncExternalStore(t.useCallback(t=>{const e=h?c.subscribe(U.batchCalls(t)):y;return c.updateResult(),e},[c,h]),()=>c.getCurrentResult(),()=>c.getCurrentResult()),t.useEffect(()=>{c.setOptions(o)},[o,c]),((t,e)=>t?.suspense&&e.isPending)(o,u))throw bt(o,c,r);if((({result:t,errorResetBoundary:e,throwOnError:s,query:a,suspense:i})=>t.isError&&!e.isReset()&&!t.isFetching&&a&&(i&&void 0===t.data||M(s,[t.error,a])))({result:u,errorResetBoundary:r,throwOnError:o.throwOnError,query:n.getQueryCache().get(o.queryHash),suspense:o.suspense}))throw u.error;if(n.getDefaultOptions().queries?._experimental_afterQuery?.(o,u),o.experimental_prefetchInRender&&!g&&((t,e)=>t.isLoading&&t.isFetching&&!e)(u,i)){const t=l?bt(o,c,r):n.getQueryCache().get(o.queryHash)?.promise;t?.catch(y).finally(()=>{c.updateResult()})}return o.notifyOnChangeProps?u:c.trackResult(u)}function Ct(t,e){return vt(t,X)}function _t(e,s){const a=ft(),[i]=t.useState(()=>new ut(a,e));t.useEffect(()=>{i.setOptions(e)},[i,e]);const r=t.useSyncExternalStore(t.useCallback(t=>i.subscribe(U.batchCalls(t)),[i]),()=>i.getCurrentResult(),()=>i.getCurrentResult()),n=t.useCallback((t,e)=>{i.mutate(t,e).catch(y)},[i]);if(r.error&&M(i.options.throwOnError,[r.error]))throw r.error;return{...r,mutate:n,mutateAsync:r.mutate}}const wt=({viewMode:s,filters:a,diagnosiOptions:i,repartoOptions:o,repartoProvenienzaOptions:l,infectionOptions:c,onApplyFilters:u,onReset:h,onApplyClick:d})=>{const p=t.useId(),[f,m]=t.useState(()=>"undefined"!=typeof window&&window.innerWidth<=767),g=(t,e)=>{u({...a,[t]:e})},y=(t,e)=>{u({...a,dateRange:{startDate:"startDate"===t?e:a.dateRange?.startDate||"",endDate:"endDate"===t?e:a.dateRange?.endDate||"",preset:a.dateRange?.preset||"custom"}})};return e.jsxs("div",{className:"charts-filters-card charts-collapsible "+(f?"is-collapsed":""),children:[e.jsxs("div",{className:"charts-filters-header charts-collapsible-header",children:[e.jsxs("div",{className:"charts-filters-title-wrapper",children:[e.jsx("span",{className:"material-icons",children:"filter_list"}),e.jsx("h3",{className:"charts-filters-title",children:"Filtri"})]}),e.jsx("button",{type:"button",className:"charts-collapse-toggle","aria-expanded":!f,"aria-controls":p,"aria-label":f?"Espandi filtri":"Comprimi filtri",onClick:()=>m(t=>!t),children:e.jsx("span",{"aria-hidden":"true",className:"material-icons",children:f?"expand_more":"expand_less"})})]}),e.jsxs("div",{className:"charts-filters-content charts-collapsible-content",id:p,hidden:f,children:[e.jsx("div",{className:"charts-filter-row",children:e.jsx(r,{startDate:a.dateRange?.startDate||"",endDate:a.dateRange?.endDate||"",onStartDateChange:t=>y("startDate",t||""),onEndDateChange:t=>y("endDate",t||""),startLabel:"Data Inizio",endLabel:"Data Fine",startPlaceholder:"gg/mm/aaaa",endPlaceholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})}),("filtered"===s||"analysis"===s)&&e.jsxs("div",{className:"charts-filter-row",children:[e.jsxs("div",{className:"charts-filter-column",children:[e.jsx("label",{htmlFor:"filter-reparto-appartenenza",className:"charts-filter-label",children:"Reparto Appartenenza"}),e.jsx(n,{id:"filter-reparto-appartenenza",value:a.repartoAppartenenza||"",options:[{value:"",label:"Tutti"},...o.map(t=>({value:t,label:t}))],onChange:t=>g("repartoAppartenenza",t||""),placeholder:"Seleziona..."})]}),e.jsxs("div",{className:"charts-filter-column",children:[e.jsx("label",{htmlFor:"filter-reparto-provenienza",className:"charts-filter-label",children:"Reparto Provenienza"}),e.jsx(n,{id:"filter-reparto-provenienza",value:a.repartoProvenienza||"",options:[{value:"",label:"Tutti"},...l.map(t=>({value:t,label:t}))],onChange:t=>g("repartoProvenienza",t||""),placeholder:"Seleziona..."})]})]}),("filtered"===s||"analysis"===s)&&e.jsxs("div",{className:"charts-filter-row",children:["filtered"===s&&e.jsxs("div",{className:"charts-filter-column",children:[e.jsx("label",{htmlFor:"filter-diagnosi",className:"charts-filter-label",children:"Diagnosi"}),e.jsx(n,{id:"filter-diagnosi",value:a.diagnosi||"",options:[{value:"",label:"Tutte"},...i.map(t=>({value:t.nome,label:t.nome}))],onChange:t=>g("diagnosi",t||""),placeholder:"Seleziona..."})]}),e.jsxs("div",{className:"charts-filter-column",children:[e.jsx("label",{htmlFor:"filter-livello-assistenza",className:"charts-filter-label",children:"Livello Assistenza"}),e.jsx(n,{id:"filter-livello-assistenza",value:a.livelloAssistenza||"",options:[{value:"",label:"Tutti"},{value:"Bassa",label:"Bassa"},{value:"Media",label:"Media"},{value:"Alta",label:"Alta"}],onChange:t=>g("livelloAssistenza",t||null),placeholder:"Seleziona..."})]}),e.jsxs("div",{className:"charts-filter-column",children:[e.jsx("label",{htmlFor:"filter-infetto",className:"charts-filter-label",children:"Infetto"}),e.jsx(n,{id:"filter-infetto",value:null!=a.infetto?a.infetto.toString():"",options:c.map(t=>({value:t.value?.toString()??"",label:t.label})),onChange:t=>g("infetto","true"===t||"false"!==t&&void 0),placeholder:"Seleziona..."})]})]}),e.jsxs("div",{className:"charts-filter-actions",children:[e.jsx("button",{type:"button",className:"btn btn-primary",onClick:d,children:"Applica Filtri"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:h,children:"Reset"})]})]})]})};class Rt{labels;datasets;totalRecords;aggregationType;filters;generatedAt;constructor(t={}){this.labels=t.labels??[],this.datasets=t.datasets??[],this.totalRecords=t.totalRecords??0,this.aggregationType=t.aggregationType??"count",this.filters=t.filters??null,this.generatedAt="string"==typeof t.generatedAt?new Date(t.generatedAt):t.generatedAt??new Date}validate(){const t=[];return Array.isArray(this.labels)&&0!==this.labels.length||t.push({field:"labels",message:"Labels array must not be empty"}),Array.isArray(this.datasets)&&0!==this.datasets.length||t.push({field:"datasets",message:"Datasets array must not be empty"}),this.datasets.forEach((e,s)=>{Array.isArray(e.data)?e.data.length!==this.labels.length&&t.push({field:`datasets[${s}].data`,message:"Dataset data length must match labels length"}):t.push({field:`datasets[${s}].data`,message:"Dataset data must be an array"})}),this.totalRecords>1e4&&t.push({field:"totalRecords",message:"Total records exceeds 10,000 limit"}),{valid:0===t.length,errors:t}}toChartJS(){return{labels:this.labels,datasets:this.datasets}}toJSON(){return{labels:this.labels,datasets:this.datasets,totalRecords:this.totalRecords,aggregationType:this.aggregationType,filters:this.filters,generatedAt:this.generatedAt.toISOString()}}}const Dt=[{label:"Minori (0-17)",color:"#4299E1"},{label:"Giovani (18-30)",color:"#48BB78"},{label:"Adulti (31-50)",color:"#ECC94B"},{label:"Anziani (51-70)",color:"#F6AD55"},{label:"Grandi anziani (70+)",color:"#FC8181"}],xt=["#48BB78","#ECC94B","#F56565","#4299E1","#FC8181"],Ot={"Dimissione Ordinaria":"#48BB78","Trasferimento Interno":"#4299E1","Trasferimento Esterno":"#ECC94B",Decesso:"#E53E3E","Non specificato":"#A0AEC0"};const At=new class{cache;CACHE_TTL;constructor(){this.cache=new Map,this.CACHE_TTL=6e5}async getAgeDistribution(t={}){const e=`age_dist_${JSON.stringify(t)}`,s=this._getFromCache(e);if(s)return a.debug("Returning cached age distribution"),s;try{const{data:s,error:a}=await i.rpc("get_age_distribution",{filters:JSON.stringify(t)});if(a)throw a;const r=this._buildAgeDistributionChart(s,t);return this._setCache(e,r),r}catch(r){a.warn("RPC get_age_distribution failed, falling back to direct query",r);const s=await this._fetchAgeDistributionFallback(t);return this._setCache(e,s),s}}async getAgeStatistics(t={}){const e=`age_stats_${JSON.stringify(t)}`,s=this._getFromCache(e);if(s)return s;try{let s=i.from("pazienti").select("data_nascita").not("data_nascita","is",null);s=this._applyFilters(s,t);const{data:a,error:r}=await s;if(r)throw r;const n=new Date,o=a.map(t=>{const e=new Date(t.data_nascita);return n.getFullYear()-e.getFullYear()}).sort((t,e)=>t-e),l={min:Math.min(...o),max:Math.max(...o),avg:o.reduce((t,e)=>t+e,0)/o.length,median:o[Math.floor(o.length/2)],count:o.length};return this._setCache(e,l),l}catch(r){throw a.error("Error fetching age statistics",r),r}}async getAssistanceLevelDistribution(t={}){const e=`assistance_${JSON.stringify(t)}`,s=this._getFromCache(e);if(s)return s;try{const{data:s,error:a}=await i.rpc("get_assistance_level_distribution",{filters:JSON.stringify(t)});if(a)throw a;const r=this._buildAssistanceLevelChart(s,t);return this._setCache(e,r),r}catch(r){a.warn("RPC get_assistance_level_distribution failed, using fallback",r);const s=await this._fetchAssistanceLevelFallback(t);return this._setCache(e,s),s}}async getDismissalTypeDistribution(t={}){const e=`dismissal_${JSON.stringify(t)}`,s=this._getFromCache(e);if(s)return s;try{const{data:s,error:a}=await i.rpc("get_dismissal_type_distribution",{filters:JSON.stringify(t)});if(a)throw a;const r=this._buildDismissalTypeChart(s,t);return this._setCache(e,r),r}catch(r){a.warn("RPC get_dismissal_type_distribution failed, using fallback",r);const s=await this._fetchDismissalTypeFallback(t);return this._setCache(e,s),s}}async getInfectionRateByDiagnosis(t={}){const{minPatients:e=3,limit:s=15,filters:r={}}=t,n=`infection_rate_${e}_${s}_${JSON.stringify(r)}`,o=this._getFromCache(n);if(o)return o;try{a.debug("Calling get_infection_rate_by_diagnosis RPC with filters:",JSON.stringify(r,null,2));const{data:t,error:o}=await i.rpc("get_infection_rate_by_diagnosis",{p_min_patients:e,p_result_limit:s,filters:JSON.stringify(r)});if(o)throw o;const l=this._buildInfectionRateChart(t,{minPatients:e,limit:s,filters:r});return this._setCache(n,l),l}catch(l){a.warn("RPC get_infection_rate_by_diagnosis failed, using fallback",l);const t=await this._fetchInfectionRateFallback(e,s,r);return this._setCache(n,t),t}}_applyFilters(t,e){const s=e.dateRange;return s&&(s.startDate&&""!==s.startDate&&(t=t.gte("data_ricovero",s.startDate)),s.endDate&&""!==s.endDate&&(t=t.lte("data_ricovero",s.endDate))),e.repartoAppartenenza&&(t=t.eq("reparto_appartenenza",e.repartoAppartenenza)),e.repartoProvenienza&&(t=t.eq("reparto_provenienza",e.repartoProvenienza)),e.diagnosi&&(t=t.eq("diagnosi",e.diagnosi)),e.livelloAssistenza&&(t=t.eq("livello_assistenza",e.livelloAssistenza)),null!=e.infetto&&(t=t.eq("infetto",e.infetto)),t}_buildAgeDistributionChart(t=[],e){const s=Dt.reduce((t,e)=>(t[e.label]=0,t),{});t.forEach(t=>{const e=t.age_range||t.label;e&&void 0!==s[e]&&(s[e]=Number(t.patient_count??t.count??0))});const a=Dt.map(t=>t.label),i=a.map(t=>s[t]||0),r=i.reduce((t,e)=>t+e,0);return new Rt({labels:a,datasets:[{label:"Distribuzione per Fascia d'EtÃ ",data:i,backgroundColor:Dt.map(t=>{const e=t.color;return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:r,aggregationType:"age_distribution",filters:null,generatedAt:new Date})}async _fetchAgeDistributionFallback(t){try{let e=i.from("pazienti").select("data_nascita").not("data_nascita","is",null);e=this._applyFilters(e,t);const{data:s,error:a}=await e;if(a)throw a;const r=Dt.reduce((t,e)=>(t[e.label]=0,t),{}),n=new Date;s.forEach(t=>{const e=new Date(t.data_nascita),s=n.getFullYear()-e.getFullYear();s<18?r["Minori (0-17)"]++:s<=30?r["Giovani (18-30)"]++:s<=50?r["Adulti (31-50)"]++:s<=70?r["Anziani (51-70)"]++:r["Grandi anziani (70+)"]++});const o=Object.entries(r).map(([t,e])=>({age_range:t,patient_count:e}));return this._buildAgeDistributionChart(o,t)}catch(e){throw a.error("Fallback age distribution query failed",e),e}}_buildAssistanceLevelChart(t=[],e){const s=[...t].map(t=>({assistance_level:t.assistance_level||t.label||"Non specificato",patient_count:Number(t.patient_count??t.count??0)})).sort((t,e)=>e.patient_count-t.patient_count||t.assistance_level.localeCompare(e.assistance_level)),a=s.map(t=>t.assistance_level),i=s.map(t=>t.patient_count),r=a.map((t,e)=>xt[e%xt.length]),n=i.reduce((t,e)=>t+e,0);return new Rt({labels:a,datasets:[{label:"Distribuzione Livelli Assistenza",data:i,backgroundColor:r.map(t=>{const e=t;return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"assistance_level",filters:null,generatedAt:new Date})}async _fetchAssistanceLevelFallback(t){try{let e=i.from("pazienti").select("livello_assistenza").not("livello_assistenza","is",null);e=this._applyFilters(e,t);const{data:s,error:a}=await e;if(a)throw a;const r=s.reduce((t,e)=>{const s=e.livello_assistenza||"Non specificato";return t[s]=(t[s]||0)+1,t},{}),n=Object.entries(r).map(([t,e])=>({assistance_level:t,patient_count:e}));return this._buildAssistanceLevelChart(n,t)}catch(e){throw a.error("Fallback assistance level query failed",e),e}}_buildDismissalTypeChart(t=[],e){const s=t.map(t=>{const e=t.dismissal_type||t.label||"Non specificato";return{dismissal_type:(Object.keys(Ot).includes(e),e),patient_count:Number(t.patient_count??t.count??0)}}).sort((t,e)=>e.patient_count-t.patient_count||t.dismissal_type.localeCompare(e.dismissal_type)),a=s.map(t=>t.dismissal_type),i=s.map(t=>t.patient_count),r=a.map(t=>Ot[t]||"#CBD5F5"),n=i.reduce((t,e)=>t+e,0);return new Rt({labels:a,datasets:[{label:"Distribuzione Tipi Dimissione",data:i,backgroundColor:r.map(t=>{const e=t;return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"dismissal_type",filters:null,generatedAt:new Date})}async _fetchDismissalTypeFallback(t){try{let e=i.from("pazienti").select("tipo_dimissione");e=this._applyFilters(e,t);const{data:s,error:a}=await e;if(a)throw a;const r={dimissione:"Dimissione Ordinaria",trasferimento_interno:"Trasferimento Interno",trasferimento_esterno:"Trasferimento Esterno",decesso:"Decesso"},n=s.reduce((t,e)=>{const s=e.tipo_dimissione||"Non specificato",a=r[s]||s;return t[a]=(t[a]||0)+1,t},{}),o=Object.entries(n).map(([t,e])=>({dismissal_type:t,patient_count:e}));return this._buildDismissalTypeChart(o,t)}catch(e){throw a.error("Fallback dismissal type query failed",e),e}}_buildInfectionRateChart(t=[],e){const s=[...t].map(t=>({diagnosi:t.diagnosi||t.diagnosis||"Non specificata",infection_rate:Number(t.infection_rate??t.rate??0),total_pazienti:Number(t.total_pazienti??t.total??0),infected_pazienti:Number(t.infected_pazienti??t.infected??0)})),a=s.map(t=>t.diagnosi),i=s.map(t=>Number(t.infection_rate.toFixed(2))),r=s.map(t=>{const e=t.infection_rate;return 0===e?"#48BB78":e<5?"#ECC94B":e<10?"#F6AD55":"#F56565"}),n=s.reduce((t,e)=>t+e.total_pazienti,0);return new Rt({labels:a,datasets:[{label:"Tasso Infezione (%)",data:i,backgroundColor:r.map(t=>{const e=t;return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"infection_rate",filters:null,generatedAt:new Date})}async _fetchInfectionRateFallback(t,e,s){try{let a=i.from("pazienti").select("diagnosi, infetto");a=this._applyFilters(a,s);const{data:r,error:n}=await a;if(n)throw n;const o=r.reduce((t,e)=>{const s=e.diagnosi||"Non specificata";return t[s]||(t[s]={total:0,infected:0}),t[s].total+=1,e.infetto&&(t[s].infected+=1),t},{}),l=Object.entries(o).filter(([,e])=>e.total>=t).map(([t,e])=>({diagnosi:t,infection_rate:e.infected/e.total*100,total_pazienti:e.total,infected_pazienti:e.infected})).sort((t,e)=>e.infection_rate-t.infection_rate).slice(0,e);return this._buildInfectionRateChart(l,{minPatients:t,limit:e,filters:s})}catch(r){throw a.error("Fallback infection rate query failed",r),r}}_getFromCache(t){const e=this.cache.get(t);return e?Date.now()-e.timestamp>this.CACHE_TTL?(this.cache.delete(t),null):e.data:null}_setCache(t,e){if(this.cache.set(t,{data:e,timestamp:Date.now()}),this.cache.size>50){const t=this.cache.keys().next().value;void 0!==t&&this.cache.delete(t)}}clearCache(){this.cache.clear()}};const St=new class{cache;CACHE_TTL;constructor(){this.cache=new Map,this.CACHE_TTL=3e5}async getMonthlyAdmissionTrends(t={}){const{months:e=12,includeInfections:s=!0,includeDismissals:r=!0,filters:n={}}=t,o=`monthly_trends_${e}_${s}_${r}_${JSON.stringify(n)}`,l=this._getFromCache(o);if(l)return a.debug("Returning cached monthly trends"),l;try{const{data:t,error:a}=await i.rpc("get_monthly_admission_trends",{p_num_months:e,p_include_infections:s,p_include_dismissals:r,filters:JSON.stringify(n)});if(a)return await this._getMonthlyTrendsDirectQuery(e,s,r,n);const l=this._formatMonthlyTrendsData(t,{months:e,includeInfections:s,includeDismissals:r});return this._setCache(o,l),l}catch(c){return a.error("Error fetching monthly admission trends",c),await this._getMonthlyTrendsDirectQuery(e,s,r,n)}}async getSeasonalDistribution(t={}){const e=`seasonal_${JSON.stringify(t)}`,s=this._getFromCache(e);if(s)return s;try{const{data:s,error:a}=await i.rpc("get_seasonal_distribution",{filters:JSON.stringify(t)});if(a)throw a;const r=this._buildSeasonalDistributionChart(s,t);return this._setCache(e,r),r}catch(r){a.warn("RPC get_seasonal_distribution failed, using fallback",r);const s=await this._getSeasonalDistributionFallback(t);return this._setCache(e,s),s}}async getAverageLengthOfStay(t={}){const{minPatients:e=3,limit:s=15,filters:r={}}=t,n=`avg_los_${e}_${s}_${JSON.stringify(r)}`,o=this._getFromCache(n);if(o)return a.debug("Returning cached average length of stay"),o;try{a.debug("Calling get_avg_length_of_stay RPC with filters:",JSON.stringify(r,null,2));const{data:t,error:o}=await i.rpc("get_avg_length_of_stay",{min_patients:e,result_limit:s,filters:JSON.stringify(r)});if(o)return a.warn("RPC get_avg_length_of_stay failed, using fallback",o),await this._getAvgLOSDirectQuery(e,s,r);const l=this._formatLengthOfStayData(t);return this._setCache(n,l),l}catch(l){return a.error("Error fetching average length of stay",l),await this._getAvgLOSDirectQuery(e,s,r)}}async _getMonthlyTrendsDirectQuery(t,e,s,r={}){try{const a=new Date;a.setMonth(a.getMonth()-t);let n=i.from("pazienti").select("data_ricovero, infetto, data_dimissione").gte("data_ricovero",a.toISOString().split("T")[0]).order("data_ricovero",{ascending:!0});n=this._applyFilters(n,r);const{data:o,error:l}=await n;if(l)throw l;const c={};o.forEach(t=>{const a=new Date(t.data_ricovero),i=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`;c[i]||(c[i]={admissions:0,infections:0,dismissals:0}),c[i].admissions++,e&&t.infetto&&c[i].infections++,s&&t.data_dimissione&&c[i].dismissals++});const u=Object.keys(c).sort(),h=[{label:"Ricoveri",data:u.map(t=>c[t].admissions),borderColor:"#4299E1",backgroundColor:"rgba(66, 153, 225, 0.3)",borderWidth:2}];e&&h.push({label:"Infezioni",data:u.map(t=>c[t].infections),borderColor:"#F56565",backgroundColor:"rgba(245, 101, 101, 0.3)",borderWidth:2}),s&&h.push({label:"Dimissioni",data:u.map(t=>c[t].dismissals),borderColor:"#48BB78",backgroundColor:"rgba(72, 187, 120, 0.3)",borderWidth:2});return new Rt({labels:u.map(t=>{const[e,s]=t.split("-");return new Date(parseInt(e),parseInt(s)-1).toLocaleDateString("it-IT",{month:"short",year:"numeric"})}),datasets:h,totalRecords:o.length,aggregationType:"monthly_trends",filters:null,generatedAt:new Date})}catch(n){throw a.error("Error in direct monthly trends query",n),n}}async _getAvgLOSDirectQuery(t,e,s={}){try{let a=i.from("pazienti").select("diagnosi, data_ricovero, data_dimissione").not("data_dimissione","is",null).not("data_ricovero","is",null);a=this._applyFilters(a,s);const{data:r,error:n}=await a;if(n)throw n;const o={};r.forEach(t=>{const e=new Date(t.data_ricovero),s=new Date(t.data_dimissione);if(s.getTime()>=e.getTime()){const a=(s.getTime()-e.getTime())/864e5,i=t.diagnosi||"Non specificata";o[i]||(o[i]={total:0,count:0}),o[i].total+=a,o[i].count++}});const l=Object.entries(o).filter(([,e])=>e.count>=t).map(([t,e])=>({diagnosi:t,avg_days:e.total/e.count,total_pazienti:e.count})).sort((t,e)=>e.avg_days-t.avg_days).slice(0,e);return this._formatLengthOfStayData(l)}catch(r){throw a.error("Error in direct avg LOS query",r),r}}_formatMonthlyTrendsData(t=[],e={}){const{months:s=12,includeInfections:a=!0,includeDismissals:i=!0}=e;if(!Array.isArray(t)||0===t.length)return new Rt({labels:[],datasets:[],totalRecords:0,aggregationType:"monthly_trends",filters:null,generatedAt:new Date});const r=[...t].sort((t,e)=>{const s=new Date(t.month_start??t.month_start_date??t.month??""),a=new Date(e.month_start??e.month_start_date??e.month??"");return s.getTime()-a.getTime()}),n=r.map(t=>{const e=new Date(t.month_start??t.month_start_date??t.month??"");return Number.isNaN(e.getTime())?t.month_label??"n/d":e.toLocaleDateString("it-IT",{month:"short",year:"numeric"})}),o=r.map(t=>Number(t.admissions)||0),l=r.map(t=>Number(t.infections)||0),c=r.map(t=>Number(t.dismissals)||0),u=[{label:"Ricoveri",data:o,borderColor:"#4299E1",backgroundColor:"rgba(66, 153, 225, 0.3)",borderWidth:2}];a&&u.push({label:"Infezioni",data:l,borderColor:"#F56565",backgroundColor:"rgba(245, 101, 101, 0.3)",borderWidth:2}),i&&u.push({label:"Dimissioni",data:c,borderColor:"#48BB78",backgroundColor:"rgba(72, 187, 120, 0.3)",borderWidth:2});const h=o.reduce((t,e)=>t+e,0);return new Rt({labels:n,datasets:u,totalRecords:h,aggregationType:"monthly_trends",filters:null,generatedAt:new Date})}_buildSeasonalDistributionChart(t=[],e={}){const s=[{label:"Inverno",color:"#4299E1"},{label:"Primavera",color:"#48BB78"},{label:"Estate",color:"#F6AD55"},{label:"Autunno",color:"#ED8936"}],a=s.reduce((t,e)=>(t[e.label]=0,t),{});t.forEach(t=>{const e=t.season||t.label;e&&void 0!==a[e]&&(a[e]=Number(t.patient_count??t.count??0))});const i=s.map(t=>t.label),r=i.map(t=>a[t]||0),n=r.reduce((t,e)=>t+e,0);return new Rt({labels:i,datasets:[{label:"Ricoveri per Stagione",data:r,backgroundColor:s.map(t=>t.color),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"seasonal",filters:null,generatedAt:new Date})}async _getSeasonalDistributionFallback(t={}){try{let e=i.from("pazienti").select("data_ricovero");e=this._applyFilters(e,t);const{data:s,error:a}=await e;if(a)throw a;const r={Inverno:0,Primavera:0,Estate:0,Autunno:0};s.forEach(t=>{const e=new Date(t.data_ricovero).getMonth()+1;12===e||e<=2?r.Inverno+=1:e<=5?r.Primavera+=1:e<=8?r.Estate+=1:r.Autunno+=1});const n=Object.entries(r).map(([t,e])=>({season:t,patient_count:e}));return this._buildSeasonalDistributionChart(n,t)}catch(e){throw a.error("Fallback seasonal distribution query failed",e),e}}_formatLengthOfStayData(t){const e=t.sort((t,e)=>e.avg_days-t.avg_days);return new Rt({labels:e.map(t=>t.diagnosi),datasets:[{label:"Degenza Media (giorni)",data:e.map(t=>parseFloat(t.avg_days.toFixed(1))),backgroundColor:e.map((t,s)=>{const a=s/e.length;return`rgb(${Math.floor(245-100*a)}, ${Math.floor(101+100*a)}, 101)`}),borderColor:"#333",borderWidth:1}],totalRecords:e.reduce((t,e)=>t+e.total_pazienti,0),aggregationType:"length_of_stay",filters:null,generatedAt:new Date})}_applyFilters(t,e){const s=e.dateRange;s&&(s.startDate&&""!==s.startDate&&(t=t.gte("data_ricovero",s.startDate)),s.endDate&&""!==s.endDate&&(t=t.lte("data_ricovero",s.endDate)));const a=e.repartoAppartenenza;a&&(t=t.eq("reparto_appartenenza",a));const i=e.repartoProvenienza;i&&(t=t.eq("reparto_provenienza",i));const r=e.diagnosi;r&&(t=t.eq("diagnosi",r));const n=e.livelloAssistenza;n&&(t=t.eq("livello_assistenza",n));const o=e.infetto;return null!=o&&(t=t.eq("infetto",o)),t}_getFromCache(t){const e=this.cache.get(t);if(!e)return null;return Date.now()-e.timestamp>this.CACHE_TTL?(this.cache.delete(t),null):e.data}_setCache(t,e){if(this.cache.set(t,{data:e,timestamp:Date.now()}),this.cache.size>50){const t=this.cache.keys().next().value;void 0!==t&&this.cache.delete(t)}}clearCache(){this.cache.clear()}};var Nt=(t=>(t.PIE="pie",t.BAR="bar",t.LINE="line",t.DOUGHNUT="doughnut",t.HORIZONTAL_BAR="horizontalBar",t))(Nt||{});const jt=s.memo(({filters:s,onAnalysisTypeChange:i,className:r=""})=>{const[n,o]=t.useState("monthly_trends"),[l,c]=t.useState(!1),[u,h]=t.useState(!1),[p,f]=t.useState(""),[m,g]=t.useState(null),[y,b]=t.useState(Nt.LINE),v=t.useRef(null),C=t.useRef(null),_=t.useRef(!1),w=t=>{switch(t){case"monthly_trends":return Nt.LINE;case"age_distribution":case"seasonal":case"assistance_level":case"dismissal_type":return Nt.PIE;case"length_of_stay":case"infection_rate":return Nt.HORIZONTAL_BAR;default:return Nt.BAR}},R=t.useCallback(async(t,e)=>{try{let s;switch(c(!0),h(!1),f(""),a.info(`ð Loading analysis: ${t}`),a.info("ð Filters being passed to analysis:",JSON.stringify(e,null,2)),t){case"monthly_trends":s=await St.getMonthlyAdmissionTrends({months:12,includeInfections:!0,includeDismissals:!0,filters:e});break;case"age_distribution":s=await At.getAgeDistribution(e);break;case"length_of_stay":s=await St.getAverageLengthOfStay({minPatients:3,limit:15,filters:e});break;case"seasonal":s=await St.getSeasonalDistribution(e);break;case"assistance_level":s=await At.getAssistanceLevelDistribution(e);break;case"dismissal_type":s=await At.getDismissalTypeDistribution(e);break;case"infection_rate":s=await At.getInfectionRateByDiagnosis({minPatients:3,limit:10,filters:e});break;default:throw new Error(`Unknown analysis type: ${t}`)}const i=w(t);C.current&&(C.current.destroy(),C.current=null);const r=v.current;if(!r)throw new Error("Canvas non trovato per il rendering del grafico");const n={type:i,data:{labels:s.labels,datasets:s.datasets.map(t=>({label:t.label,data:t.data,backgroundColor:t.backgroundColor,borderColor:t.borderColor,borderWidth:t.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:i===Nt.HORIZONTAL_BAR?"y":"x",plugins:{legend:{display:i===Nt.PIE||i===Nt.DOUGHNUT,position:"bottom",labels:{font:{size:12},padding:15}},tooltip:{enabled:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:14,weight:"bold"},bodyFont:{size:12},padding:10}},scales:i!==Nt.PIE&&i!==Nt.DOUGHNUT?{y:{beginAtZero:!0,title:{display:!0,text:"length_of_stay"===t?"Giorni":"infection_rate"===t?"Tasso (%)":"Numero Pazienti"},grid:{display:!0,color:"rgba(0, 0, 0, 0.1)"}},x:{title:{display:!0,text:"monthly_trends"===t?"Mese":"length_of_stay"===t||"infection_rate"===t?"Diagnosi":"Categoria"},grid:{display:!1}}}:void 0,animation:{duration:500,easing:"easeInOutQuart"}}};C.current=new d(r,n),g(s),b(i),a.info(`â Analysis loaded: ${t}`,{recordCount:s.totalRecords})}catch(s){a.error("â Error loading analysis",s),h(!0),f(s instanceof Error?s.message:"Errore durante il caricamento dell'analisi"),console.error("Errore durante il caricamento dell'analisi:",s)}finally{c(!1)}},[]),D=t.useCallback(t=>{o(t),b(w(t)),i&&i(t),a.info(`ð Analysis type changed to: ${t}`)},[i]),x=t.useCallback(t=>{if(m)try{h(!1),f(""),C.current&&(C.current.destroy(),C.current=null);const e=v.current;if(!e)return;const s={type:t,data:{labels:m.labels,datasets:m.datasets.map(t=>({label:t.label,data:t.data,backgroundColor:t.backgroundColor,borderColor:t.borderColor,borderWidth:t.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:t===Nt.HORIZONTAL_BAR?"y":"x",plugins:{legend:{display:t===Nt.PIE||t===Nt.DOUGHNUT,position:"bottom"}},scales:t!==Nt.PIE&&t!==Nt.DOUGHNUT?{y:{beginAtZero:!0}}:void 0}};C.current=new d(e,s),b(t),a.info(`Chart type changed to: ${t}`)}catch(e){a.error("Error changing chart type",e),h(!0),f(e instanceof Error?e.message:"Errore durante il cambio tipo grafico")}},[m]);t.useEffect(()=>{_.current||(_.current=!0,R(n,s))},[]),t.useEffect(()=>{_.current&&R(n,s)},[n,s,R]),t.useEffect(()=>()=>{C.current&&(C.current.destroy(),C.current=null)},[]);return e.jsxs("div",{className:`analysis-view ${r}`,children:[e.jsx("div",{className:"analysis-type-selector mb-4",id:"analysis-type-selector",children:e.jsxs("div",{className:"btn-group",role:"group","aria-label":"Tipo di analisi",children:[e.jsx("button",{type:"button",className:"btn "+("monthly_trends"===n?"btn-primary":"btn-outline-primary"),"data-analysis":"monthly_trends",onClick:()=>D("monthly_trends"),children:"Trend Mensili"}),e.jsx("button",{type:"button",className:"btn "+("age_distribution"===n?"btn-primary":"btn-outline-primary"),"data-analysis":"age_distribution",onClick:()=>D("age_distribution"),children:"Distribuzione EtÃ "}),e.jsx("button",{type:"button",className:"btn "+("length_of_stay"===n?"btn-primary":"btn-outline-primary"),"data-analysis":"length_of_stay",onClick:()=>D("length_of_stay"),children:"Durata Degenza"}),e.jsx("button",{type:"button",className:"btn "+("seasonal"===n?"btn-primary":"btn-outline-primary"),"data-analysis":"seasonal",onClick:()=>D("seasonal"),children:"Stagionale"}),e.jsx("button",{type:"button",className:"btn "+("assistance_level"===n?"btn-primary":"btn-outline-primary"),"data-analysis":"assistance_level",onClick:()=>D("assistance_level"),children:"Livello Assistenza"}),e.jsx("button",{type:"button",className:"btn "+("dismissal_type"===n?"btn-primary":"btn-outline-primary"),"data-analysis":"dismissal_type",onClick:()=>D("dismissal_type"),children:"Tipo Dimissione"}),e.jsx("button",{type:"button",className:"btn "+("infection_rate"===n?"btn-primary":"btn-outline-primary"),"data-analysis":"infection_rate",onClick:()=>D("infection_rate"),children:"Tasso Infezione"})]})}),e.jsx("div",{className:"chart-controls mb-3",children:e.jsxs("div",{className:"btn-group",role:"group","aria-label":"Tipo grafico",children:[e.jsx("button",{type:"button",className:"btn "+(y===Nt.PIE?"btn-primary":"btn-outline-secondary"),onClick:()=>x(Nt.PIE),disabled:!m,children:"Torta"}),e.jsx("button",{type:"button",className:"btn "+(y===Nt.BAR?"btn-primary":"btn-outline-secondary"),onClick:()=>x(Nt.BAR),disabled:!m,children:"Barre"}),e.jsx("button",{type:"button",className:"btn "+(y===Nt.LINE?"btn-primary":"btn-outline-secondary"),onClick:()=>x(Nt.LINE),disabled:!m,children:"Linee"}),e.jsx("button",{type:"button",className:"btn "+(y===Nt.HORIZONTAL_BAR?"btn-primary":"btn-outline-secondary"),onClick:()=>x(Nt.HORIZONTAL_BAR),disabled:!m,children:"Barre Oriz."})]})}),e.jsxs("div",{className:"charts-container-wrapper",children:[m&&e.jsxs("div",{className:"charts-record-count",children:["Trovati ",m.totalRecords," record"]}),e.jsxs("div",{className:"charts-chart-wrapper",style:{position:"relative"},children:[e.jsx("canvas",{ref:v,className:l||u?"d-none":"","aria-label":`Grafico analisi ${n}`}),l?e.jsxs("div",{className:"text-center p-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"mt-2",children:"Caricamento analisi in corso..."})]}):null,u?e.jsxs("div",{className:"alert alert-danger",role:"alert",children:[e.jsx("h5",{className:"alert-heading",children:"Errore"}),e.jsx("p",{children:p}),e.jsx("button",{className:"btn btn-outline-danger",onClick:()=>R(n,s),children:"Riprova"})]}):null]})]})]})});jt.displayName="AnalysisView";const Et=s.memo(({chartType:s,onChartTypeChange:a,hasData:i,onExport:r})=>{const n=t.useId(),[o,l]=t.useState(()=>"undefined"!=typeof window&&window.innerWidth<=767);return e.jsxs("div",{className:"charts-controls charts-collapsible "+(o?"is-collapsed":""),children:[e.jsxs("div",{className:"charts-controls-header charts-collapsible-header",children:[e.jsxs("div",{className:"charts-controls-title-wrapper",children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"insights"}),e.jsx("h3",{className:"charts-controls-title",children:"Tipo Grafico"})]}),e.jsx("button",{type:"button",className:"charts-collapse-toggle","aria-expanded":!o,"aria-controls":n,"aria-label":o?"Espandi controlli grafico":"Comprimi controlli grafico",onClick:()=>l(t=>!t),children:e.jsx("span",{"aria-hidden":"true",className:"material-icons",children:o?"expand_more":"expand_less"})})]}),e.jsxs("div",{className:"charts-collapsible-content",id:n,hidden:o,children:[e.jsxs("div",{className:"charts-type-selector",children:[e.jsx("label",{className:"charts-control-label",children:"Tipo Grafico:"}),e.jsxs("div",{className:"btn-group charts-segmented-group",role:"group",children:[e.jsx("button",{type:"button",className:"btn "+(s===Nt.PIE?"btn-primary":"btn-outline-secondary"),onClick:()=>a(Nt.PIE),"aria-pressed":s===Nt.PIE,children:"Torta"}),e.jsx("button",{type:"button",className:"btn "+(s===Nt.BAR?"btn-primary":"btn-outline-secondary"),onClick:()=>a(Nt.BAR),"aria-pressed":s===Nt.BAR,children:"Barre"}),e.jsx("button",{type:"button",className:"btn "+(s===Nt.LINE?"btn-primary":"btn-outline-secondary"),onClick:()=>a(Nt.LINE),"aria-pressed":s===Nt.LINE,children:"Linee"})]})]}),i&&e.jsxs("div",{className:"charts-export-controls",children:[e.jsx("label",{className:"charts-control-label",children:"Esporta:"}),e.jsxs("div",{className:"btn-group charts-segmented-group",role:"group",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>r("image"),children:"Immagine"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>r("json"),children:"JSON"})]})]})]})]})}),Tt=({totalPatients:t,uniqueDiagnoses:s,totalDepartments:a})=>e.jsxs("div",{className:"charts-statistics",children:[e.jsx("h4",{children:"Statistiche"}),e.jsxs("div",{className:"charts-stat-grid",children:[e.jsxs("div",{className:"charts-stat-item",children:[e.jsx("span",{className:"charts-stat-label",children:"Totale Pazienti:"}),e.jsx("span",{className:"charts-stat-value",children:t})]}),void 0!==s&&e.jsxs("div",{className:"charts-stat-item",children:[e.jsx("span",{className:"charts-stat-label",children:"Diagnosi Uniche:"}),e.jsx("span",{className:"charts-stat-value",children:s})]}),void 0!==a&&e.jsxs("div",{className:"charts-stat-item",children:[e.jsx("span",{className:"charts-stat-label",children:"Reparti Totali:"}),e.jsx("span",{className:"charts-stat-value",children:a})]})]})]}),Ft=s.forwardRef(({className:s="",politeness:a="polite"},i)=>{const r=t.useRef(null),n=(t,e=a)=>{r.current&&(r.current.getAttribute("aria-live")!==e&&r.current.setAttribute("aria-live",e),r.current.textContent="",requestAnimationFrame(()=>{r.current&&(r.current.textContent=t)}))};return t.useImperativeHandle(i,()=>({announce:n})),e.jsx("div",{ref:r,className:`live-region ${s}`,"aria-live":a,"aria-atomic":"true",role:"status"})});Ft.displayName="LiveRegion";const Pt={filtered:{label:"Vista Filtrata",shortLabel:"Filtrata",icon:"filter_list",description:"Visualizza i dati filtrati per diagnosi"},comparison:{label:"Confronto Reparti",shortLabel:"Confronto",icon:"compare_arrows",description:"Confronta i dati tra i diversi reparti"},analysis:{label:"Analisi Avanzate",shortLabel:"Analisi",icon:"analytics",description:"Visualizza analisi avanzate e insight"}},It=t.forwardRef(({initialViewMode:i="filtered",onViewModeChange:r,containerId:n="view-mode-tabs",className:o="",compactMode:l=!1},c)=>{const[u,h]=t.useState(i),[d,p]=t.useState({filtered:!1,comparison:!1,analysis:!1}),[f,m]=t.useState(!1),g=t.useRef(null),y=t.useRef(null),b=t.useRef(null),v=t.useRef({filtered:null,comparison:null,analysis:null});t.useEffect(()=>{const t=()=>{m(window.innerWidth<=640)};let e;t();const s=()=>{clearTimeout(e),e=setTimeout(t,150)};return window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s),clearTimeout(e)}},[]);const C=l||f,_=t=>{if(t===u)return;if(b.current=document.activeElement,h(t),y.current){y.current.announce(`Tab ${{filtered:"Vista Filtrata",comparison:"Confronto Reparti",analysis:"Analisi Avanzate"}[t]} attivata`)}const e=v.current[t];e&&setTimeout(()=>{e.focus()},0),r&&r(t),a.debug("View mode tab activated",{viewMode:t})},w=(t,e)=>{p(s=>({...s,[t]:e}))};t.useEffect(()=>{i!==u&&h(i)},[i]),s.useImperativeHandle(c,()=>({getCurrentViewMode:()=>u,setActiveTab:_,setLoadingState:w,setLoadingStates:p}));const R=(t,s=!1)=>{const a=Pt[t],i=u===t,r=d[t];return e.jsx("div",{className:"nav-item",role:"presentation",children:e.jsx("button",{ref:e=>{e&&(v.current[t]=e)},className:`nav-link ${i?"active":""} ${r?"loading":""} ${s?"nav-link--icon":""}`,id:`${t}-tab`,"data-view-mode":t,type:"button",role:"tab","aria-controls":`${t}-panel`,"aria-selected":i,"aria-busy":r,"aria-label":a.description,title:a.label,onClick:()=>_(t),onKeyDown:e=>((t,e)=>{const s=["filtered","comparison","analysis"],a=s.indexOf(e);let i=null;switch(t.key){case"Enter":case" ":t.preventDefault(),_(e);break;case"ArrowLeft":case"ArrowUp":t.preventDefault(),i=s[(a-1+s.length)%s.length],_(i);break;case"ArrowRight":case"ArrowDown":t.preventDefault(),i=s[(a+1)%s.length],_(i);break;case"Home":t.preventDefault(),_(s[0]);break;case"End":t.preventDefault(),_(s[s.length-1])}})(e,t),disabled:r,children:e.jsxs(e.Fragment,s?{children:[e.jsx("span",{className:"material-icons nav-link--icon__symbol",children:a.icon}),e.jsx("span",{className:"nav-link--icon__label",children:a.shortLabel})]}:{children:[r&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"tab-loading-spinner","aria-hidden":"true"}),e.jsxs("span",{className:"visually-hidden",children:["Caricamento ",a.label,"..."]})]}),!r&&a.label]})})},t)};return e.jsxs(e.Fragment,{children:[e.jsx(Ft,{ref:y,className:"visually-hidden",politeness:"polite"}),e.jsxs("div",{ref:g,id:n,className:`nav nav-tabs ${o} ${C?"nav-tabs--compact":""}`,role:"tablist","aria-label":"ModalitÃ  visualizzazione grafici",children:[R("filtered",C),R("comparison",C),R("analysis",C)]})]})});It.displayName="ViewModeTabs";const kt=i;class zt{async fetchChartData(t){try{a.debug("Fetching filtered chart data from Supabase",{filters:t});let e=kt.from("pazienti").select("diagnosi");t.dateRange?.startDate&&(e=e.gte("data_ricovero",t.dateRange.startDate)),t.dateRange?.endDate&&(e=e.lte("data_ricovero",t.dateRange.endDate)),t.repartoAppartenenza&&(e=e.eq("reparto_appartenenza",t.repartoAppartenenza)),t.repartoProvenienza&&(e=e.eq("reparto_provenienza",t.repartoProvenienza)),t.diagnosi&&(e=e.eq("diagnosi",t.diagnosi)),t.livelloAssistenza&&(e=e.eq("livello_assistenza",t.livelloAssistenza)),null!=t.infetto&&(e=e.eq("infetto",t.infetto));const{data:s,error:i}=await e;if(i)throw a.error("Error fetching filtered chart data from Supabase",i),new Error("Impossibile caricare i dati filtrati");const r={};s.forEach(t=>{t.diagnosi&&(r[t.diagnosi]=(r[t.diagnosi]||0)+1)});const n=Object.keys(r),o=Object.values(r),l=this.generateColors(n.length),c=l.map(t=>this.darkenColor(t,20)),u={labels:n,datasets:[{label:"Diagnosi",data:o,backgroundColor:l,borderColor:c,borderWidth:1}],totalRecords:o.reduce((t,e)=>t+e,0),aggregationType:"diagnosis",filters:t,generatedAt:new Date};return a.debug("Filtered chart data fetched successfully from Supabase",{recordCount:u.totalRecords,diagnosesCount:u.labels.length}),u}catch(e){throw a.error("Error fetching filtered chart data",e),new Error("Impossibile caricare i dati filtrati")}}formatForDisplay(t,e){if(!t||!t.labels||0===t.labels.length)throw new Error("No chart data to format for display");const s=this.getStatistics(t),a={type:e,data:{labels:t.labels,datasets:t.datasets.map(t=>({label:t.label,data:t.data,backgroundColor:t.backgroundColor,borderColor:t.borderColor,borderWidth:t.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:e===Nt.PIE,position:"right"},tooltip:{callbacks:{label:t=>{const e=t.label||"",s="number"==typeof t.parsed?t.parsed:t.parsed?.y??0;return`${e}: ${s} (${(s/t.dataset.data.reduce((t,e)=>t+e,0)*100).toFixed(1)}%)`}}}},scales:e!==Nt.PIE?{y:{beginAtZero:!0,title:{display:!0,text:"Numero Pazienti"}},x:{title:{display:!0,text:"Diagnosi"}}}:void 0}},i=this.generateSuggestions(t,e);return{chartConfig:a,statistics:s,suggestions:i.length>0?{suggestNarrowing:!0,suggestions:i}:void 0}}getStatistics(t){if(!t||!t.datasets||0===t.datasets.length)return{totalPatients:0,uniqueDiagnoses:0};return{totalPatients:t.datasets.reduce((t,e)=>t+e.data.reduce((t,e)=>t+e,0),0),uniqueDiagnoses:t.labels.length}}generateColors(t){const e=["#0d6efd","#dc3545","#198754","#ffc107","#fd7e14","#6f42c1","#20c997","#6c757d","#0dcaf0","#d63384"],s=[];for(let a=0;a<t;a++)s.push(e[a%e.length]);return s}darkenColor(t,e){return t+"CC"}generateSuggestions(t,e){const s=[],a=t.labels.length;return t.totalRecords>100&&s.push("Considera di restringere il range di date per visualizzare meno dati"),a>10&&s.push("Prova a filtrare per diagnosi specifiche per risultati piÃ¹ chiari"),e===Nt.PIE&&a>8&&s.push("Per molti dati, il grafico a barre potrebbe essere piÃ¹ leggibile"),e===Nt.BAR&&a>15&&s.push("Considera di raggruppare alcune diagnosi simili"),s}}class qt{async fetchChartData(t){try{a.debug("Fetching comparison chart data from Supabase",{filters:t});let e=kt.from("pazienti").select("reparto_appartenenza");t.dateRange?.startDate&&(e=e.gte("data_ricovero",t.dateRange.startDate)),t.dateRange?.endDate&&(e=e.lte("data_ricovero",t.dateRange.endDate)),t.repartoAppartenenza&&(e=e.eq("reparto_appartenenza",t.repartoAppartenenza)),t.repartoProvenienza&&(e=e.eq("reparto_provenienza",t.repartoProvenienza)),t.diagnosi&&(e=e.eq("diagnosi",t.diagnosi)),t.livelloAssistenza&&(e=e.eq("livello_assistenza",t.livelloAssistenza)),null!=t.infetto&&(e=e.eq("infetto",t.infetto));const{data:s,error:i}=await e;if(i)throw a.error("Error fetching comparison chart data from Supabase",i),new Error("Impossibile caricare i dati comparativi");const r={};s.forEach(t=>{t.reparto_appartenenza&&(r[t.reparto_appartenenza]=(r[t.reparto_appartenenza]||0)+1)});const n=Object.keys(r),o=Object.values(r),l=this.generateColors(n.length),c=l.map(t=>this.darkenColor(t,20)),u={labels:n,datasets:[{label:"Reparti",data:o,backgroundColor:l,borderColor:c,borderWidth:1}],totalRecords:o.reduce((t,e)=>t+e,0),aggregationType:"department",filters:t,generatedAt:new Date};return a.debug("Comparison chart data fetched successfully from Supabase",{recordCount:u.totalRecords,departmentsCount:u.labels.length}),u}catch(e){throw a.error("Error fetching comparison chart data",e),new Error("Impossibile caricare i dati comparativi")}}formatForDisplay(t,e){if(!t||!t.labels||0===t.labels.length)throw new Error("No chart data to format for display");const s=this.getStatistics(t),a=this.generateInsights(t,e),i=this.performStatisticalAnalysis(t);return{chartConfig:{type:e,data:{labels:t.labels,datasets:t.datasets.map(t=>({label:t.label,data:t.data,backgroundColor:t.backgroundColor,borderColor:t.borderColor,borderWidth:t.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:e===Nt.PIE,position:"right"},tooltip:{callbacks:{label:t=>{const e=t.label||"",s="number"==typeof t.parsed?t.parsed:t.parsed?.y??0;return`${e}: ${s} (${(s/t.dataset.data.reduce((t,e)=>t+e,0)*100).toFixed(1)}%)`}}}},scales:e!==Nt.PIE?{y:{beginAtZero:!0,title:{display:!0,text:"Numero Pazienti"}},x:{title:{display:!0,text:"Reparto"}}}:void 0}},statistics:s,insights:a,analysis:i}}getStatistics(t){if(!t||!t.datasets||0===t.datasets.length)return{totalPatients:0,totalDepartments:0};return{totalPatients:t.datasets.reduce((t,e)=>t+e.data.reduce((t,e)=>t+e,0),0),totalDepartments:t.labels.length}}generateInsights(t,e){const s=[],a=t.datasets[0].data,i=t.labels,r=Math.max(...a),n=Math.min(...a),o=a.indexOf(r),l=a.indexOf(n);s.push(`${i[o]} ha il maggior numero di pazienti (${r})`),s.push(`${i[l]} ha il minor numero di pazienti (${n})`);const c=a.reduce((t,e)=>t+e,0)/a.length;s.push(`La media dei pazienti per reparto Ã¨ ${c.toFixed(1)}`);const u=a.filter(t=>t>c).length;return s.push(`${u} reparti sono sopra la media`),s}performStatisticalAnalysis(t){const e=t.datasets[0].data,s=e.reduce((t,e)=>t+e,0)/e.length,a=e.map(t=>Math.pow(t-s,2)).reduce((t,e)=>t+e,0)/e.length,i=Math.sqrt(a),r=2*i,n=[];return e.forEach((e,a)=>{Math.abs(e-s)>r&&n.push(t.labels[a])}),{statistics:{mean:s.toFixed(1),stdDev:i.toFixed(1)},hasOutliers:n.length>0,outliers:n}}generateColors(t){const e=["#0d6efd","#dc3545","#198754","#ffc107","#fd7e14","#6f42c1","#20c997","#6c757d","#0dcaf0","#d63384"],s=[];for(let a=0;a<t;a++)s.push(e[a%e.length]);return s}darkenColor(t,e){return t+"CC"}}const Mt=new zt,Qt=new qt,Lt={filtered:Mt,comparison:Qt};async function $t(){try{const[t,e,s,i]=await Promise.all([o(),l(),c(),u()]),r=h(s);return a.debug("Filter options loaded successfully",{diagnosisCount:t.length,repartoCount:e.length,provenienzaCount:i.length}),{diagnosiOptions:t,repartoOptions:e,repartoProvenienzaOptions:i,infectionOptions:r}}catch(t){const e=t instanceof Error?t.message:"Errore nel caricamento delle opzioni di filtro";throw a.error(e,t),new Error(e)}}const Ut=({initialViewMode:s="filtered",initialChartType:i=Nt.PIE,initialFilters:r={}})=>{const[n,o]=t.useState(s),[l,c]=t.useState(i),[u,h]=t.useState(r),{diagnosiOptions:p,repartoOptions:f,repartoProvenienzaOptions:m,infectionOptions:g,isLoading:y,error:b}=(()=>{const{data:t,isLoading:e,error:s}=Ct({queryKey:["chartFilterOptions"],queryFn:$t,initialData:{diagnosiOptions:[],repartoOptions:[],repartoProvenienzaOptions:[],infectionOptions:[{value:"",label:"Tutti"},{value:"true",label:"SÃ¬"},{value:"false",label:"No"}]}});return{diagnosiOptions:t.diagnosiOptions,repartoOptions:t.repartoOptions,repartoProvenienzaOptions:t.repartoProvenienzaOptions,infectionOptions:t.infectionOptions,isLoaded:!e,isLoading:e,error:s}})(),{canvasRef:v,chartData:C,statistics:_,suggestions:w,insights:R,isLoading:D,isError:x,errorMessage:O,fetchData:A}=((e,s,i)=>{const r=t.useRef(null),n=t.useRef(null);ft();const{data:o,isLoading:l,isError:c,error:u,refetch:h}=Ct({queryKey:["chartData",e,s,i],queryFn:async()=>{const t={dateRange:{startDate:i.dateRange?.startDate||"",endDate:i.dateRange?.endDate||"",preset:i.dateRange?.preset||"custom"},repartoAppartenenza:i.repartoAppartenenza||"",repartoProvenienza:i.repartoProvenienza||"",diagnosi:i.diagnosi||"",livelloAssistenza:i.livelloAssistenza||null,infetto:void 0!==i.infetto&&i.infetto};let o;if("filtered"===e)o=await Mt.fetchChartData(t);else{if("comparison"!==e)return null;o=await Qt.fetchChartData(t)}const l="filtered"===e?Mt.formatForDisplay(o,s):Qt.formatForDisplay(o,s);n.current&&(n.current.destroy(),n.current=null);const c=r.current;if(!c)throw new Error("Canvas non trovato per il rendering del grafico");return n.current=new d(c,l.chartConfig),a.info("Chart rendered successfully",{viewMode:e,chartType:s,recordCount:o.totalRecords}),{fetchedData:o,displayData:l}},enabled:"analysis"!==e,select:t=>{if(!t)return null;const{fetchedData:s,displayData:a}=t;let i=null,r=null;return"filtered"===e&&"suggestions"in a&&a.suggestions?i=a.suggestions.suggestions:"comparison"===e&&"insights"in a&&a.insights&&(r=a.insights),{chartData:s,statistics:a.statistics,suggestions:i,insights:r}}}),p=t.useCallback(()=>{n.current&&(n.current.destroy(),n.current=null)},[]);return t.useEffect(()=>()=>{p()},[p]),{canvasRef:r,chartData:o?.chartData??null,statistics:o?.statistics??null,suggestions:o?.suggestions??null,insights:o?.insights??null,isLoading:l,isError:c,errorMessage:u?.message??"",fetchData:h,cleanup:p}})(n,l,u),S=t.useCallback(t=>{o(t),"filtered"===t?c(Nt.PIE):"comparison"===t&&c(Nt.BAR)},[]),N=t.useCallback(t=>{c(t)},[]),j=t.useCallback(t=>{h(t)},[]),E=t.useCallback(()=>{h({dateRange:{startDate:"",endDate:"",preset:"custom"}})},[]),T=t.useCallback(async t=>{try{if(!C)throw new Error("Nessun grafico disponibile per l'esportazione");if(a.info("Chart export requested",{format:t}),"image"===t){const t=v.current;if(t){const e=t.toDataURL("image/png"),s=document.createElement("a");s.download=`chart-${Date.now()}.png`,s.href=e,s.click()}}else if("json"===t){const t=JSON.stringify(C,null,2),e=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(e),a=document.createElement("a");a.download=`chart-data-${Date.now()}.json`,a.href=s,a.click(),URL.revokeObjectURL(s)}}catch(e){a.error("Error exporting chart",e)}},[C,v]),F=t.useCallback(()=>{A()},[A]);return e.jsxs("div",{className:"charts-page-container",children:[e.jsx("div",{className:"charts-hero",children:e.jsxs("div",{className:"charts-hero-content",children:[e.jsx("h1",{className:"charts-title",children:"Grafici Pazienti"}),e.jsx("p",{className:"charts-subtitle",children:"Visualizza grafici, applica filtri avanzati ed esporta dati in vari formati."})]})}),e.jsx(It,{initialViewMode:s,onViewModeChange:S,containerId:"charts-view-mode-tabs"}),!y&&e.jsx(wt,{viewMode:n,filters:u,diagnosiOptions:p,repartoOptions:f,repartoProvenienzaOptions:m,infectionOptions:g,onApplyFilters:j,onReset:E,onApplyClick:F}),"analysis"!==n&&e.jsx(Et,{chartType:l,onChartTypeChange:N,hasData:!!C,onExport:T}),e.jsx("div",{className:"charts-container-wrapper",children:"analysis"===n?e.jsx(jt,{filters:u,onAnalysisTypeChange:t=>a.debug("Analysis type changed:",t)}):e.jsxs(e.Fragment,{children:[C&&e.jsxs("div",{className:"charts-record-count",children:["Trovati ",C.totalRecords," record"]}),e.jsxs("div",{className:"charts-chart-wrapper",children:[e.jsx("canvas",{ref:v,className:"charts-canvas "+(D||x?"charts-canvas--hidden":"charts-canvas--visible"),"aria-label":`Grafico a ${l===Nt.PIE?"torta":l===Nt.BAR?"barre":"linee"} ${"filtered"===n?"delle diagnosi":"dei reparti"}`}),D||y?e.jsxs("div",{className:"charts-loading",children:[e.jsx("div",{className:"charts-spinner",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"charts-loading-text",children:"Caricamento dati in corso..."})]}):null,(()=>{if(!x&&!b)return null;const t=O||b?.message||"Errore sconosciuto";return e.jsxs("div",{className:"charts-error",children:[e.jsxs("svg",{className:"charts-error-icon",width:"80",height:"80",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"15"})]}),e.jsx("h5",{className:"charts-error-title",children:"Errore"}),e.jsx("p",{className:"charts-error-message",children:t}),e.jsx("button",{className:"btn btn-outline-primary charts-action-button",onClick:()=>A(),children:"Riprova"})]})})()]}),_&&e.jsx(Tt,{totalPatients:_.totalPatients,uniqueDiagnoses:_.uniqueDiagnoses,totalDepartments:_.totalDepartments}),w&&0!==w.length?e.jsx("div",{className:"charts-suggestions",children:e.jsxs("div",{className:"charts-alert info",role:"alert",children:[e.jsx("h6",{className:"charts-alert-title",children:"Suggerimenti:"}),e.jsx("ul",{className:"charts-alert-list",children:w.map((t,s)=>e.jsx("li",{children:t},s))})]})}):null,R&&0!==R.length?e.jsx("div",{className:"charts-insights",children:e.jsxs("div",{className:"charts-alert info",role:"alert",children:[e.jsx("h6",{className:"charts-alert-title",children:"Insights:"}),e.jsx("ul",{className:"charts-alert-list",children:R.map((t,s)=>e.jsx("li",{children:t},s))})]})}):null]})})]})};Ut.displayName="ChartsPage";const Bt=Object.freeze(Object.defineProperty({__proto__:null,ChartsPage:Ut,ComparisonChartDataService:qt,FilteredChartDataService:zt,chartDataService:Lt,comparisonChartService:Qt,demographicAnalysisService:At,filteredChartService:Mt,temporalAnalysisService:St},Symbol.toStringTag,{value:"Module"}));export{dt as Q,ft as a,_t as b,mt as c,Bt as i,P as k,Ct as u};
