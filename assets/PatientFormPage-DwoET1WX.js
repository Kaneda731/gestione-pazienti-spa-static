import{j as e,M as a}from"./ui-vendor-CgDpQ-gO.js";import{b as i,i as n,u as s,j as t}from"./react-vendor-bU8fvvPN.js";import{B as r}from"./Button-CI4eP2cr.js";import{C as l}from"./CustomSelect-DOAxtOpH.js";import{D as o}from"./DateRangePicker-BUDmSS8F.js";import{s as c,l as d}from"./index-ChYFFTDP.js";import{I as m,a as u}from"./InterventionForm-C2Y3dB9B.js";import{g as p,a as h,b as g,p as v}from"./patientService-DmE1w8ss.js";import{c as x,e as f}from"./helpers-tjW-n5mW.js";import{u as j}from"./useNotification-RHVhxw-c.js";import{l as b}from"./filterQueryService-BvMMegqz.js";import{u as N,a as w,b as z,W as y}from"./WizardStepper-hBeYqTh9.js";import{u as _}from"./useResponsive-CUIx72uV.js";import"./dropdownPositioner-CpLmXRgY.js";import"./CentralizedStatisticsService-hzzukO-0.js";import"./supabase-DpMRTrmd.js";const C=[{value:"dimissione",label:"Dimissione"},{value:"trasferimento_interno",label:"Trasferimento interno"},{value:"trasferimento_esterno",label:"Trasferimento esterno"},{value:"decesso",label:"Decesso"}],S=[{value:"0",label:"0 - Ordinaria"},{value:"6",label:"6 - Protetta"}],D=[{value:"",label:"Seleziona..."},{value:"56",label:"56 - Riabilitazione Motoria"},{value:"60",label:"60 - Lunga Degenza"}],I=[{value:"",label:"Seleziona..."},{value:"Cardiologia",label:"Cardiologia"},{value:"CR1",label:"CR1"},{value:"CR3",label:"CR3"},{value:"Gastroenterologia",label:"Gastroenterologia"},{value:"Ginecologia",label:"Ginecologia"},{value:"Medicina Interna",label:"Medicina Interna"},{value:"Neurologia",label:"Neurologia"},{value:"Pediatria",label:"Pediatria"},{value:"Pneumologia",label:"Pneumologia"},{value:"UGI",label:"UGI"},{value:"Urologia",label:"Urologia"}],k={data_dimissione:"",tipo_dimissione:"dimissione",codice_dimissione:"0"},P=({patientName:a,onDischargeSubmit:n})=>{const[s,t]=i.useState(!1),[c,d]=i.useState(k),[m,u]=i.useState(!1),p=e=>a=>{d("tipo_dimissione"===e?i=>{const n={...i,[e]:a};return"dimissione"===a?n.codice_dimissione="0":"trasferimento_esterno"===a?n.codice_dimissione="3":"trasferimento_interno"!==a&&"decesso"!==a||(n.codice_dimissione=null),n}:i=>({...i,[e]:a}))};return e.jsxs("div",{className:"discharge-section card mt-4",children:[e.jsx("div",{className:"card-header bg-light",children:e.jsxs("button",{type:"button",onClick:()=>t(!s),className:"btn btn-link w-100 text-start p-0 d-flex justify-content-between align-items-center",style:{textDecoration:"none",color:"inherit"},children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1.5rem"},children:s?"expand_less":"expand_more"}),e.jsx("strong",{children:"Dimissione / Trasferimento"}),e.jsx("span",{className:"badge bg-info",style:{fontSize:"0.75rem"},children:"Opzionale"})]}),s&&e.jsxs("span",{style:{fontSize:"0.875rem",color:"#6c757d"},children:["Paziente: ",a]})]})}),s&&e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"alert alert-info mb-3",children:[e.jsx("strong",{children:"Nota:"})," Registra i dati di dimissione o trasferimento del paziente. Questa sezione è facoltativa e può essere completata anche in un secondo momento."]}),e.jsxs("form",{id:"discharge-section",onSubmit:async e=>{if(e.preventDefault(),!m&&n){u(!0);try{await n(c),d(k),t(!1)}finally{u(!1)}}},className:"d-flex flex-column gap-3",children:[e.jsx(o,{label:"Data dimissione",value:c.data_dimissione,onChange:e=>{d(a=>({...a,data_dimissione:e||""}))},isRequired:s,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-type",children:["Tipo dimissione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(l,{id:"discharge-dismissal-type",value:c.tipo_dimissione,options:C.map(e=>({value:e.value,label:e.label})),onChange:p("tipo_dimissione"),placeholder:"Seleziona..."})]}),"dimissione"===c.tipo_dimissione&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"discharge-dismissal-code",children:"Codice dimissione"}),e.jsx(l,{id:"discharge-dismissal-code",value:c.codice_dimissione??"",options:S.map(e=>({value:e.value,label:e.label})),onChange:p("codice_dimissione"),placeholder:"Seleziona..."})]}),"trasferimento_interno"===c.tipo_dimissione&&e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-dept",children:["Reparto destinazione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(l,{id:"discharge-dismissal-dept",value:c.reparto_destinazione??"",options:I.map(e=>({value:e.value,label:e.label})),onChange:p("reparto_destinazione"),placeholder:"Seleziona..."})]}),"trasferimento_esterno"===c.tipo_dimissione&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-clinic",children:["Clinica destinazione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{id:"discharge-dismissal-clinic",name:"clinica_destinazione",className:"form-control",value:c.clinica_destinazione??"",onChange:e=>{const{name:a,value:i}=e.target;d(e=>({...e,[a]:i}))},required:s&&"trasferimento_esterno"===c.tipo_dimissione})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-clinic-code",children:["Codice clinica ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(l,{id:"discharge-dismissal-clinic-code",value:c.codice_clinica??"",options:D.map(e=>({value:e.value,label:e.label})),onChange:p("codice_clinica"),placeholder:"Seleziona..."})]})]}),e.jsxs("div",{className:"d-flex gap-2 pt-2",children:[e.jsx(r,{type:"submit",disabled:m,children:m?"Registrazione in corso...":"Registra dimissione"}),e.jsx(r,{type:"button",variant:"secondary",onClick:()=>{d(k),t(!1)},children:"Annulla"})]})]})]})]})},E=["AR","PO","CO","CR","PS"],R=["Bassa","Media","Alta"],B=({values:a,onChange:i})=>e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-name",children:"Nome"}),e.jsx("input",{id:"patient-name",name:"nome",className:"form-control",value:a.nome,onChange:i,required:!0})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-surname",children:"Cognome"}),e.jsx("input",{id:"patient-surname",name:"cognome",className:"form-control",value:a.cognome,onChange:i,required:!0})]})]}),F=({values:a,onChange:i})=>{const n=e=>a=>{i({target:{name:e,value:a||""}})};return e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6",children:e.jsx(o,{id:"patient-birth-date",value:a.data_nascita,onChange:n("data_nascita"),label:"Data nascita",placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})}),e.jsx("div",{className:"col-md-6",children:e.jsx(o,{id:"patient-admission-date",value:a.data_ricovero,onChange:n("data_ricovero"),label:"Data ricovero",placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})})]})},M=({values:a,onChange:n,diagnosiOptions:s,repartoOptions:t,loadingDiagnosi:r,loadingReparti:o})=>{const c=e=>a=>{n({target:{name:e,value:a}})},d=i.useMemo(()=>[{value:"",label:"Seleziona diagnosi..."},...s.map(e=>({value:e.nome,label:e.nome}))],[s]),m=i.useMemo(()=>0===s.length?"empty":s.map(e=>e.id).sort().join("-"),[s]),u=i.useMemo(()=>[{value:"",label:"Seleziona..."},...t.map(e=>({value:e,label:e}))],[t]);return e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-diagnosis",children:"Diagnosi"}),e.jsx(l,{id:"patient-diagnosis",value:a.diagnosi,options:d,onChange:c("diagnosi"),disabled:r,placeholder:"Seleziona diagnosi..."},`diagnosis-${m}`),r&&e.jsx("small",{className:"form-text text-muted",children:"Caricamento diagnosi in corso..."})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-ward",children:"Reparto Appartenenza"}),e.jsx(l,{id:"patient-ward",value:a.reparto_appartenenza,options:u,onChange:c("reparto_appartenenza"),disabled:o,placeholder:"Seleziona..."},`ward-${t.length}`),o&&e.jsx("small",{className:"form-text text-muted",children:"Caricamento reparti in corso..."})]})]})},V=({values:a,onChange:n})=>{const s=e=>a=>{n({target:{name:e,value:a}})},t=i.useMemo(()=>[{value:"",label:"Seleziona..."},...E.map(e=>({value:e,label:e}))],[]),r=i.useMemo(()=>[{value:"",label:"Seleziona..."},...R.map(e=>({value:e,label:e}))],[]);return e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-codice-rad",children:"Codice RAD"}),e.jsx("input",{id:"patient-codice-rad",name:"codice_rad",className:"form-control",value:a.codice_rad,onChange:n})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-reparto-provenienza",children:"Reparto Provenienza"}),e.jsx(l,{id:"patient-reparto-provenienza",value:a.reparto_provenienza,options:t,onChange:s("reparto_provenienza"),placeholder:"Seleziona..."},"reparto-provenienza")]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-livello-assistenza",children:"Livello Assistenza"}),e.jsx(l,{id:"patient-livello-assistenza",value:a.livello_assistenza,options:r,onChange:s("livello_assistenza"),placeholder:"Seleziona..."},"livello-assistenza")]})]})},A=({values:a,onCheckboxChange:i,onEditInfection:n,onEditSurgery:s,infectionBadge:t,surgeryBadge:r,renderBadge:l})=>e.jsxs("div",{className:"row mt-3",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"patient-infetto",name:"infetto",checked:a.infetto,onChange:i}),e.jsxs("label",{className:"form-check-label",htmlFor:"patient-infetto",children:["Paziente Infetto",l(t)]})]}),e.jsxs("button",{type:"button",className:"btn btn-link px-0",onClick:()=>{void n()},children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"edit"}),"Modifica dati infezione"]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"patient-ha-intervento",name:"ha_intervento",checked:a.ha_intervento,onChange:i}),e.jsxs("label",{className:"form-check-label",htmlFor:"patient-ha-intervento",children:["Intervento Chirurgico",l(r)]})]}),e.jsxs("button",{type:"button",className:"btn btn-link px-0",onClick:()=>{void s()},children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"edit"}),"Modifica dati intervento"]})]})]}),O=({values:a,onChange:i})=>e.jsxs("div",{children:[e.jsx("label",{className:"form-label",htmlFor:"patient-notes",children:"Note"}),e.jsx("textarea",{id:"patient-notes",name:"note",className:"form-control",value:a.note,onChange:i,rows:3})]}),$=({submitting:a,submitLabel:i,onCancel:n})=>e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(r,{type:"submit",disabled:a,children:i}),e.jsx(r,{type:"button",variant:"secondary",onClick:n,children:"Annulla"})]}),L=({patientId:n,patientName:s="Paziente",event:t,onSubmit:r,onClose:l})=>{const[o,c]=i.useState(!1),d=i.useRef(`infection-event-modal-${Date.now()}`).current,u=i.useRef(null),p=i.useRef(null),h=i.useRef(null),g=i.useRef(null);i.useEffect(()=>{const e=u.current;if(!e)return;g.current=document.activeElement;let i=requestAnimationFrame(()=>{if(u.current)try{const i=new a(e);p.current=i;const n=()=>{h.current=null;const e=g.current;g.current=null,e&&document.contains(e)&&queueMicrotask(()=>e.focus()),l()};h.current=n,e.addEventListener("hidden.bs.modal",n),i.show()}catch(i){console.error("Error initializing modal:",i)}});return()=>{null!==i&&(cancelAnimationFrame(i),i=null);const a=p.current;if(p.current=null,e&&h.current&&(e.removeEventListener("hidden.bs.modal",h.current),h.current=null),a)try{a.dispose()}catch(n){console.error("Error disposing modal:",n)}}},[l]);const v=i.useCallback(()=>{const e=p.current;if(e){const a=u.current,i=document.activeElement;i&&a?.contains(i)&&i.blur(),e.hide()}else l()},[l]);return e.jsx("div",{className:"modal fade modal-themed-coral",id:d,ref:u,tabIndex:-1,"aria-labelledby":`${d}-label`,"aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{className:"modal-header-hero",children:[e.jsx("div",{className:"modal-header-icon",children:e.jsx("span",{className:"material-icons",children:"coronavirus"})}),e.jsxs("div",{className:"modal-header-text",children:[e.jsx("h5",{className:"modal-title",id:`${d}-label`,children:t?"Modifica Evento":"Registra Infezione"}),e.jsxs("p",{className:"modal-subtitle",children:[e.jsx("span",{className:"material-icons",children:"person"}),s]})]})]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white","aria-label":"Chiudi","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body",children:e.jsx(m,{event:t,patientId:n,onSubmit:async e=>{c(!0);try{await r(e),v()}finally{c(!1)}},onCancel:v,isSubmitting:o})})]})})})},T={hasData:!1,isValid:!1,tooltip:""};const q=({patientId:n,patientName:s="Paziente",event:t,onSubmit:r,onClose:l})=>{const[o,c]=i.useState(!1),d=i.useRef(`intervention-event-modal-${Date.now()}`).current,m=i.useRef(null),p=i.useRef(null),h=i.useRef(null);i.useEffect(()=>{const e=m.current;if(!e)return;let i=requestAnimationFrame(()=>{if(m.current)try{const i=new a(e);p.current=i;const n=()=>{h.current=null,l()};h.current=n,e.addEventListener("hidden.bs.modal",n),i.show()}catch(i){console.error("Error initializing modal:",i)}});return()=>{null!==i&&(cancelAnimationFrame(i),i=null);const a=p.current;if(p.current=null,e&&h.current&&(e.removeEventListener("hidden.bs.modal",h.current),h.current=null),a)try{a.dispose()}catch(n){console.error("Error disposing modal:",n)}}},[l]);const g=i.useCallback(()=>{const e=p.current;e?e.hide():l()},[l]);return e.jsx("div",{className:"modal fade modal-themed-coral",id:d,ref:m,tabIndex:-1,"aria-labelledby":`${d}-label`,"aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{className:"modal-header-hero",children:[e.jsx("div",{className:"modal-header-icon",children:e.jsx("span",{className:"material-icons",children:"medical_services"})}),e.jsxs("div",{className:"modal-header-text",children:[e.jsx("h5",{className:"modal-title",id:`${d}-label`,children:t?"Modifica Evento":"Registra Intervento"}),e.jsxs("p",{className:"modal-subtitle",children:[e.jsx("span",{className:"material-icons",children:"person"}),s]})]})]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white","aria-label":"Chiudi","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body",children:e.jsx(u,{event:t,patientId:n,onSubmit:async e=>{c(!0);try{await r(e),g()}finally{c(!1)}},onCancel:g,isSubmitting:o})})]})})})},G={hasData:!1,isValid:!1,tooltip:""};function W({values:a,setValues:s,patientDisplayName:t,patientId:r=""}){const l=function({setValues:a,patientDisplayName:s,patientId:t=""}){const[r,l]=i.useState(T),[o,c]=i.useState(!1),d=i.useCallback(async()=>{const e=await p();if(!e.hasInfectionData())return T;const a=e.getInfectionData(),i=[];return a?.data_evento&&i.push(`Data: ${a.data_evento}`),a?.agente_patogeno&&i.push(`Agente: ${a.agente_patogeno}`),a?.descrizione&&i.push(`Note: ${a.descrizione}`),{hasData:!0,isValid:0===(e.getValidationErrors?.()?.length??0),tooltip:i.join("\n")}},[]),m=i.useCallback(async()=>{const e=await d();l(e)},[d]),u=i.useCallback(async e=>{const i=await p();i.setInfectionData({data_evento:e.data_evento,agente_patogeno_id:e.agente_patogeno_id,tipo_patogeno:e.tipo_patogeno,data_fine_evento:e.data_fine_evento,note:e.note}),c(!1);const n=i.hasInfectionData();a(e=>({...e,infetto:n})),await m()},[a,m]),h=i.useCallback(async e=>{e?c(!0):((await p()).clearInfectionData(),a(e=>({...e,infetto:!1})),await m())},[a,m]),g=i.useCallback(async e=>{const{name:a,checked:i}=e.target;"infetto"===a&&await h(i)},[h]),v=i.useCallback(()=>{c(!0)},[]);return{badge:r,renderBadge:i.useCallback(a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),handleCheckboxChange:g,handleEditInfection:v,modalsPortal:n.createPortal(e.jsx(e.Fragment,{children:o&&e.jsx(L,{patientId:t,patientName:s||"Nuovo Paziente",onSubmit:u,onClose:()=>c(!1)})}),document.body),refreshSummary:m}}({values:a,setValues:s,patientDisplayName:t,patientId:r}),o=function({setValues:a,patientDisplayName:s,patientId:t=""}){const[r,l]=i.useState(G),[o,c]=i.useState(!1),d=i.useCallback(async()=>{const e=await h();if(!e.hasSurgeryData())return G;const a=e.getValidationErrors?.()?.length??0,i=e.getDataSummary?.(),n=[];return i?.dataIntervento&&n.push(`Intervento: ${i.dataIntervento}`),i?.tipoIntervento&&n.push(`Tipo: ${i.tipoIntervento}`),i?.hasInfection&&n.push("Infezione associata"),{hasData:!0,isValid:0===a,tooltip:n.join("\n")}},[]),m=i.useCallback(async()=>{const e=await d();l(e)},[d]),u=i.useCallback(async e=>{const i=await h();i.setSurgeryData({data_evento:e.data_evento,tipo_intervento_id:e.tipo_intervento_id,descrizione:e.descrizione_intervento}),c(!1);const n=i.hasSurgeryData();a(e=>({...e,ha_intervento:n})),await m()},[a,m]),p=i.useCallback(async e=>{e?c(!0):((await h()).clearSurgeryData(),a(e=>({...e,ha_intervento:!1})),await m())},[a,m]),g=i.useCallback(async e=>{const{name:a,checked:i}=e.target;"ha_intervento"===a&&await p(i)},[p]),v=i.useCallback(()=>{c(!0)},[]);return{badge:r,renderBadge:i.useCallback(a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),handleCheckboxChange:g,handleEditSurgery:v,modalsPortal:n.createPortal(e.jsx(e.Fragment,{children:o&&e.jsx(q,{patientId:t,patientName:s||"Nuovo Paziente",onSubmit:u,onClose:()=>c(!1)})}),document.body),refreshSummary:m}}({values:a,setValues:s,patientDisplayName:t,patientId:r});i.useEffect(()=>{(async()=>{await l.refreshSummary(),await o.refreshSummary()})()},[]),i.useEffect(()=>()=>{g().then(({infection:e,surgery:a})=>{e.clearInfectionData(),a.clearSurgeryData()})},[]);const c=i.useCallback(async e=>{const{name:a}=e.target;return"infetto"===a?(await l.handleCheckboxChange(e),void 0):"ha_intervento"===a?(await o.handleCheckboxChange(e),void 0):(s(i=>({...i,[a]:e.target.checked})),void 0)},[l,o,s]),d=i.useMemo(()=>a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),m=i.useMemo(()=>e.jsxs(e.Fragment,{children:[l.modalsPortal,o.modalsPortal]}),[l.modalsPortal,o.modalsPortal]);return{infectionBadge:l.badge,surgeryBadge:o.badge,renderBadge:d,handleCheckboxChange:c,handleEditInfection:l.handleEditInfection,handleEditSurgery:o.handleEditSurgery,modalsPortal:m}}const U=["data_nascita","data_ricovero","data_dimissione"];function Q({initialPatient:e}){const[a,n]=i.useState(()=>x());i.useEffect(()=>{if(!e)return n(x()),void 0;const a={id:e.id??null,nome:e.nome??"",cognome:e.cognome??"",data_nascita:f(e.data_nascita??""),data_ricovero:f(e.data_ricovero??""),data_dimissione:f(e.data_dimissione??""),diagnosi:e.diagnosi??"",reparto_appartenenza:e.reparto_appartenenza??"",reparto_provenienza:e.reparto_provenienza??"",livello_assistenza:e.livello_assistenza??"",codice_rad:e.codice_rad??"",note:e.note??"",tipo_dimissione:e.tipo_dimissione??"",codice_dimissione:e.codice_dimissione??"",reparto_destinazione:e.reparto_destinazione??"",clinica_destinazione:e.clinica_destinazione??"",codice_clinica:e.codice_clinica??"",infetto:e.infetto??!1,ha_intervento:!1};n(a)},[e]);const s=i.useCallback(e=>{const{name:a,value:i,type:s}=e.target,t="checkbox"===s?e.target.checked:i;n(e=>{if("string"==typeof t&&U.includes(a)){const i=f(t);return{...e,[a]:i}}return{...e,[a]:t}})},[]);return{values:a,setValues:n,handleChange:s}}function H(){const{notify:e}=j(),[a,n]=i.useState([]),[s,t]=i.useState([]),[r,l]=i.useState(!1),[o,m]=i.useState(!1);return i.useEffect(()=>{void(async()=>{l(!0);try{const{data:a,error:i}=await c.from("diagnosi").select("id, nome").order("nome",{ascending:!0});if(i)d.error("Errore nel caricamento delle diagnosi",{error:i}),e.error("Impossibile caricare le diagnosi disponibili").withDuration(5e3).show();else{const e=(a||[]).map(e=>({id:String(e.id),nome:e.nome}));n(e)}}catch(a){d.error("Errore imprevisto nel caricamento delle diagnosi",{error:a}),e.error("Errore nel caricamento delle diagnosi").withDuration(5e3).show()}finally{l(!1)}})()},[]),i.useEffect(()=>{void(async()=>{m(!0);try{const e=await b();t(e)}catch(a){d.error("Errore nel caricamento dei reparti",{error:a}),e.error("Impossibile caricare i reparti disponibili").withDuration(5e3).show()}finally{m(!1)}})()},[]),{diagnosiOptions:a,repartoOptions:s,loadingDiagnosi:r,loadingReparti:o}}function J({values:e,surgeryDataManager:a,infectionDataManager:i,isPatientCurrentlyInfected:n}){const s={nome:e.nome?.trim()||"",cognome:e.cognome?.trim()||"",data_nascita:e.data_nascita||"",data_ricovero:e.data_ricovero||"",data_dimissione:e.data_dimissione||null,diagnosi:e.diagnosi?.trim()||"",reparto_appartenenza:e.reparto_appartenenza?.trim()||"",reparto_provenienza:e.reparto_provenienza?.trim()||null,livello_assistenza:e.livello_assistenza?.trim()||null,codice_rad:e.codice_rad?.trim()||null,tipo_dimissione:e.tipo_dimissione||null,codice_dimissione:e.codice_dimissione?.trim()||null,reparto_destinazione:e.reparto_destinazione?.trim()||null,clinica_destinazione:e.clinica_destinazione?.trim()||null,codice_clinica:e.codice_clinica?.trim()||null,note:e.note?.trim()||null,infetto:e.infetto||!1,_hasInfectionData:!1,_hasSurgeryData:!1};if(i.hasInfectionData()){const e=i.getInfectionData();e&&(s._hasInfectionData=!0,s._infectionData=e)}if(a.hasSurgeryData()){const e=a.getSurgeryData();e&&(s._hasSurgeryData=!0,s._surgeryData=e)}return n&&n()&&(s.infetto=!0),s}const K=({patient:a,mode:n,onSubmit:s,onCancel:t,onValidate:r})=>{const{values:l,setValues:o,handleChange:c}=Q({initialPatient:a}),[d,m]=i.useState(!1),u=i.useRef(null),p=i.useMemo(()=>[l.nome?.trim(),l.cognome?.trim()].filter(Boolean).join(" ").trim(),[l.nome,l.cognome]),{diagnosiOptions:h,repartoOptions:v,loadingDiagnosi:x,loadingReparti:f}=H(),{infectionBadge:j,surgeryBadge:b,renderBadge:N,handleCheckboxChange:w,handleEditInfection:z,handleEditSurgery:y,modalsPortal:_}=W({values:l,setValues:o,patientDisplayName:p,patientId:a?.id??""}),C=i.useCallback(async e=>{if(e.preventDefault(),!d){m(!0);try{const{infection:e,surgery:a}=await g(),i=J({values:l,infectionDataManager:e,surgeryDataManager:a});if(r){if(!r(i).valid)return m(!1),void 0}await s(i)}finally{m(!1)}}},[s,r,d,l]),S="create"===n?"Salva paziente":"Aggiorna paziente";return e.jsxs(e.Fragment,{children:[e.jsxs("form",{id:"patient-form",ref:u,onSubmit:C,className:"d-flex flex-column gap-3",noValidate:!0,children:[e.jsx(B,{values:l,onChange:c}),e.jsx(F,{values:l,onChange:c}),e.jsx(M,{values:l,onChange:c,diagnosiOptions:h,repartoOptions:v,loadingDiagnosi:x,loadingReparti:f}),e.jsx(V,{values:l,onChange:c}),e.jsx(A,{values:l,onCheckboxChange:w,onEditInfection:z,onEditSurgery:y,infectionBadge:j,surgeryBadge:b,renderBadge:N}),e.jsx(O,{values:l,onChange:c}),e.jsx($,{submitting:d,submitLabel:S,onCancel:t})]}),_]})},X=["personal-info","admission-dates","diagnosis","provenance","clinical-flags","notes","review"],Y={"personal-info":"Dati Personali","admission-dates":"Date Ricovero",diagnosis:"Diagnosi",provenance:"Provenienza","clinical-flags":"Dati Clinici",notes:"Note",review:"Riepilogo"},Z=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Dati Personali"}),e.jsx("p",{className:"wizard-step-description",children:"Inserisci i dati anagrafici del paziente"}),e.jsx(B,{values:a,onChange:i})]})}),ee=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Date Importanti"}),e.jsx("p",{className:"wizard-step-description",children:"Inserisci la data di nascita e ricovero"}),e.jsx(F,{values:a,onChange:i})]})}),ae=({values:a,onChange:i,diagnosiOptions:n,repartoOptions:s,loadingDiagnosi:t,loadingReparti:r})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Diagnosi"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona la diagnosi e il reparto"}),e.jsx(M,{values:a,onChange:i,diagnosiOptions:n||[],repartoOptions:s||[],loadingDiagnosi:t??!1,loadingReparti:r??!1})]})}),ie=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Provenienza e Assistenza"}),e.jsx("p",{className:"wizard-step-description",children:"Informazioni sulla provenienza del paziente (opzionale)"}),e.jsx(V,{values:a,onChange:i})]})}),ne=({values:a,onCheckboxChange:i,onEditInfection:n,onEditSurgery:s,infectionBadge:t,surgeryBadge:r,renderBadge:l})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Dati Clinici"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona i flag clinici del paziente"}),e.jsx(A,{values:a,onCheckboxChange:i??(async()=>{}),onEditInfection:n??(async()=>{}),onEditSurgery:s??(async()=>{}),infectionBadge:t,surgeryBadge:r,renderBadge:l})]})}),se=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Note Aggiuntive"}),e.jsx("p",{className:"wizard-step-description",children:"Aggiungi eventuali note (opzionale)"}),e.jsx(O,{values:a,onChange:i})]})}),te=({values:a})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Riepilogo"}),e.jsx("p",{className:"wizard-step-description",children:"Verifica i dati inseriti prima di confermare"}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Dati Personali"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Nome:"}),e.jsx("span",{className:"review-value",children:a.nome})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Cognome:"}),e.jsx("span",{className:"review-value",children:a.cognome})]})]})]}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Date"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Data Nascita:"}),e.jsx("span",{className:"review-value",children:a.data_nascita})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Data Ricovero:"}),e.jsx("span",{className:"review-value",children:a.data_ricovero})]})]})]}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Clinico"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Diagnosi:"}),e.jsx("span",{className:"review-value",children:a.diagnosi||"Non specificato"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Reparto:"}),e.jsx("span",{className:"review-value",children:a.reparto_appartenenza||"Non specificato"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Paziente Infetto:"}),e.jsx("span",{className:"review-value",children:a.infetto?"Sì":"No"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Intervento Chirurgico:"}),e.jsx("span",{className:"review-value",children:a.ha_intervento?"Sì":"No"})]})]})]}),a.note&&e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Note"}),e.jsx("p",{className:"review-notes",children:a.note})]})]})}),re=({patient:a,mode:n,onSubmit:s,onCancel:t,onValidate:r})=>{const{values:l,setValues:o,handleChange:c}=Q({initialPatient:a}),[d,m]=i.useState(!1),u=i.useRef(null),p=((e="personal-info")=>N({steps:X,labels:Y,initialStep:e}))("personal-info"),h=w({currentStep:p.currentStep,getStepLabel:p.getStepLabel,totalSteps:p.totalSteps,currentStepNumber:p.getStepNumber(p.currentStep)});z();const v=i.useMemo(()=>[l.nome?.trim(),l.cognome?.trim()].filter(Boolean).join(" ").trim(),[l.nome,l.cognome]),{diagnosiOptions:x,repartoOptions:f,loadingDiagnosi:j,loadingReparti:b}=H(),{infectionBadge:_,surgeryBadge:C,renderBadge:S,handleCheckboxChange:D,handleEditInfection:I,handleEditSurgery:k,modalsPortal:P}=W({values:l,setValues:o,patientDisplayName:v,patientId:a?.id??""}),E=i.useCallback(async e=>{if(e.preventDefault(),!d){m(!0);try{const{infection:e,surgery:a}=await g(),i=J({values:l,infectionDataManager:e,surgeryDataManager:a});if(r){if(!r(i).valid)return m(!1),void 0}await s(i)}finally{m(!1)}}},[s,r,d,l]),R="create"===n?"Salva paziente":"Aggiorna paziente",B=i.useCallback(()=>{switch(p.currentStep){case"personal-info":return!!l.nome?.trim()&&!!l.cognome?.trim();case"admission-dates":return!!l.data_nascita&&!!l.data_ricovero;case"diagnosis":return!!l.diagnosi&&!!l.reparto_appartenenza;case"provenance":case"clinical-flags":case"notes":case"review":return!0;default:return!1}},[p.currentStep,l.nome,l.cognome,l.data_nascita,l.data_ricovero,l.diagnosi,l.reparto_appartenenza]);return e.jsxs(e.Fragment,{children:[e.jsxs("form",{id:"patient-form-wizard",ref:u,onSubmit:E,className:"wizard-form",noValidate:!0,children:[e.jsxs("div",{className:"wizard-form-header",children:[e.jsx("button",{type:"button",className:"wizard-back-button",onClick:t,"aria-label":"Torna alla lista pazienti",children:e.jsx("i",{className:"bi bi-arrow-left"})}),e.jsx("h1",{className:"wizard-form-title",children:"Inserimento Nuovo Paziente"})]}),e.jsx(y,{currentStep:p.currentStep,totalSteps:p.totalSteps,getStepLabel:p.getStepLabel,getStepNumber:p.getStepNumber,stepOrder:X,themeColor:"patients"}),e.jsx("div",{ref:h,className:"wizard-form-content",children:(()=>{const a={values:l,onChange:c,diagnosiOptions:x,repartoOptions:f,loadingDiagnosi:j,loadingReparti:b,onCheckboxChange:D,onEditInfection:I,onEditSurgery:k,infectionBadge:_,surgeryBadge:C,renderBadge:S};switch(p.currentStep){case"personal-info":return e.jsx(Z,{...a});case"admission-dates":return e.jsx(ee,{...a});case"diagnosis":return e.jsx(ae,{...a});case"provenance":return e.jsx(ie,{...a});case"clinical-flags":return e.jsx(ne,{...a});case"notes":return e.jsx(se,{...a});case"review":return e.jsx(te,{values:l});default:return null}})()}),e.jsxs("div",{className:"wizard-form-actions",children:[e.jsxs("button",{type:"button",className:"btn btn-secondary btn-block",onClick:p.prevStep,disabled:!p.canGoPrev,children:[e.jsx("i",{className:"bi bi-chevron-left"}),"Indietro"]}),"review"!==p.currentStep?e.jsxs("button",{type:"button",className:"btn btn-primary btn-block",onClick:p.nextStep,disabled:!p.canGoNext||!B(),title:B()?void 0:"Completa i campi obbligatori per continuare",children:["Avanti",e.jsx("i",{className:"bi bi-chevron-right"})]}):e.jsx(e.Fragment,{children:e.jsx("button",{type:"submit",className:"btn btn-success btn-block",disabled:d,children:e.jsxs(e.Fragment,d?{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio in corso..."]}:{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),R]})})})]})]}),P]})},le=()=>{const a=s(),{notify:n}=j(),[r]=t(),l=r.get("id"),[o,c]=i.useState("create"),[m,u]=i.useState(void 0),[p,h]=i.useState(!1);i.useEffect(()=>{void(async()=>{const e=sessionStorage.getItem("editPazienteId"),a=l??e;if(!a)return sessionStorage.removeItem("editPazienteId"),c("create"),u(void 0),void 0;h(!0);try{const e=await v.getPatientById(a);e?(u(e),c("edit")):(d.warn("Patient not found",{id:a}),n.warning("Paziente non trovato").show())}catch(i){d.error("Error loading patient for edit",i),n.error("Errore nel caricamento del paziente").show()}finally{h(!1),!l&&e&&sessionStorage.removeItem("editPazienteId")}})()},[l]),i.useEffect(()=>()=>{sessionStorage.removeItem("editPazienteId")},[]);const g=i.useCallback(async e=>{try{if("edit"===o&&m?.id)d.info("Updating existing patient",{id:m.id,data:e}),await v.updatePatient(m.id,e);else{d.info("Creating new patient",{data:e});const a=e._hasInfectionData&&e._infectionData,i=e._hasSurgeryData&&e._surgeryData;a&&i?await v.createPatientWithSurgeryAndInfection(e,e._surgeryData,e._infectionData):a?await v.createPatientWithInfection(e,e._infectionData):i?await v.createPatientWithSurgery(e,e._surgeryData):await v.createPatient(e)}a("/list")}catch(i){throw d.error("Error submitting patient form",i),i}},[a,o,m?.id]),x=i.useCallback(async e=>{if(m?.id)try{d.info("Registering patient discharge",{patientId:m.id,data:e}),await v.dischargePatientWithTransfer(m.id,e)}catch(a){throw d.error("Error registering patient discharge",a),n.error("Errore nella registrazione della dimissione").show(),a}},[m?.id,n]),f=i.useCallback(()=>{sessionStorage.removeItem("editPazienteId"),u(void 0),c("create"),a("/list")},[a]),b=_();return e.jsxs("div",{className:"patient-form-page-container",children:[b.isMobile&&e.jsx(e.Fragment,{children:p?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("div",{className:"spinner-border mb-3",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"text-muted",children:"Caricamento dati paziente in corso..."})]}):e.jsx(re,{patient:m,mode:o,onSubmit:g,onCancel:f})}),!b.isMobile&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"patient-form-hero",children:e.jsx("div",{className:"patient-form-hero-content",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"patient-form-title",children:p?"Caricamento...":"edit"===o?"Modifica Paziente":"Inserimento Nuovo Paziente"}),e.jsx("p",{className:"patient-form-subtitle",children:p?"Attendere il caricamento dei dati...":"edit"===o?`Modifica i dati di ${m?.nome} ${m?.cognome}`:"Compila il form per aggiungere un nuovo paziente al sistema"})]}),e.jsxs("button",{type:"button",className:"patient-form-back-button",onClick:f,disabled:p,"aria-label":"Torna alla lista",children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"arrow_back"}),e.jsx("span",{className:"back-button-text",children:"Torna alla lista"})]})]})})}),e.jsx("div",{className:"row",children:e.jsxs("div",{className:"col-12 col-lg-10 col-xl-8 mx-auto",children:[e.jsxs("div",{className:"patient-form-card",children:[e.jsx("div",{className:"patient-form-card-header",children:e.jsxs("div",{className:"patient-form-card-title-wrapper",children:[e.jsx("div",{className:"patient-form-card-icon",children:e.jsx("span",{className:"material-icons",children:"edit"===o?"edit":"person_add"})}),e.jsxs("h2",{className:"patient-form-card-title",style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"1rem"},children:[e.jsx("span",{children:"Modifica Dati Paziente"}),"edit"===o&&m&&e.jsxs("span",{style:{fontSize:"1.3rem",fontWeight:"700",color:"#0d6efd"},children:[m.nome," ",m.cognome]})]})]})}),e.jsxs("div",{className:"patient-form-card-body",children:[p?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("div",{className:"spinner-border mb-3",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"text-muted",children:"Caricamento dati paziente in corso..."})]}):e.jsx(K,{patient:m,mode:o,onSubmit:g,onCancel:f}),!p&&"edit"===o&&m&&e.jsx(P,{patientId:m.id,patientName:`${m.nome} ${m.cognome}`,onDischargeSubmit:x})]})]}),e.jsx("div",{className:"patient-form-help-card card",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"patient-form-help-header",children:[e.jsx("div",{className:"help-icon",children:e.jsx("span",{className:"material-icons",children:"info"})}),e.jsx("h3",{className:"help-title",children:"Informazioni"})]}),e.jsxs("ul",{className:"patient-form-help-list",children:[e.jsx("li",{children:"I campi contrassegnati sono obbligatori"}),e.jsx("li",{children:"La data di ricovero non può essere futura"}),e.jsx("li",{children:"Il codice RAD deve essere univoco se specificato"}),e.jsx("li",{children:"I dati possono essere modificati successivamente dalla pagina di dettaglio"})]})]})})]})})]})]})};export{le as PatientFormPage,le as default};
