import{j as e}from"./ui-vendor-CgDpQ-gO.js";import{u as t}from"./useQuery-ALaIRWKn.js";import{e as i,u as a}from"./index-Co0ngb9X.js";import{u as n}from"./useMutation-BKOYR29v.js";import{R as s,b as l,u as r,j as o}from"./react-vendor-bU8fvvPN.js";import{B as c}from"./Button-CI4eP2cr.js";import{C as d}from"./CustomSelect-DnSFe6iV.js";import{a as m}from"./DateRangePicker-DYiF-aI-.js";import{P as h,E as v}from"./EventFormWizard-CsiAvVYL.js";import{e as u}from"./patientService-DSsJrdX8.js";import{a as p,I as x}from"./InterventionForm-BwWwDRQK.js";import{u as g}from"./useNotification-63vWFAKd.js";import{C as j}from"./ConfirmModal-DqvvpUVX.js";import{u as f}from"./useResponsive-DDHaZ65L.js";import"./supabase-DpMRTrmd.js";import"./CentralizedStatisticsService-Cnr3KuoH.js";import"./WizardStepper-hBeYqTh9.js";function N(e){const t=new Map;return e.forEach(e=>{t.set(e.id,e.nome)}),t}function b(e,t,i){if("intervento"===e.tipo_evento)return e.tipo_intervento_id&&t?.has(e.tipo_intervento_id)?t.get(e.tipo_intervento_id)||"-":e.tipo_intervento||"-";if("infezione"===e.tipo_evento){if(e.agente_patogeno_id&&i?.has(e.agente_patogeno_id)){const t=i.get(e.agente_patogeno_id)||"";return e.tipo_patogeno?`${t} (${e.tipo_patogeno})`:t}return e.tipo_batterio||"-"}return"-"}const _=s.memo(({event:t,patient:i,tipiInterventoMap:a,agentiPatogeniMap:n,onEdit:s,onDelete:l,onResolve:r})=>{const o="infezione"===t.tipo_evento,d=o&&Boolean(t.data_fine_evento),m=b(t,a,n),h=new Date(t.data_evento).toLocaleDateString("it-IT"),v=`event-card ${o?"event-card--infezione":"event-card--intervento"} ${d?"event-card--resolved":""}`.trim();return e.jsxs("div",{className:v,children:[e.jsx("div",{className:"event-card__status-strip"}),e.jsxs("div",{className:"event-card__content",children:[e.jsxs("div",{className:"event-card__header",children:[e.jsx("div",{className:"event-card__icon-container",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:o?"coronavirus":"medical_services"})}),e.jsxs("div",{className:"event-card__title-group",children:[e.jsx("h5",{className:"event-card__patient-name",children:i?`${i.nome} ${i.cognome}`:t.paziente_id}),e.jsxs("div",{className:"event-card__meta",children:[e.jsxs("span",{className:"event-card__badge "+(o?"event-card__badge--infezione":"event-card__badge--intervento"),role:"status","aria-label":o?"Infezione":"Intervento",children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:o?"bug_report":"healing"}),o?"Infezione":"Intervento"]}),e.jsx("time",{dateTime:t.data_evento,className:"event-card__date",title:h,children:h})]})]})]}),e.jsxs("div",{className:"event-card__details",children:[i?.codice_rad&&e.jsxs("div",{className:"event-card__detail-row",children:[e.jsx("span",{className:"material-icons event-card__detail-icon","aria-hidden":"true",children:"badge"}),e.jsxs("span",{className:"event-card__detail-label",children:[e.jsx("abbr",{title:"Codice RAD",children:"RAD"}),":"]}),e.jsx("span",{className:"event-card__detail-value",children:i.codice_rad})]}),e.jsxs("div",{className:"event-card__detail-row",children:[e.jsx("span",{className:"material-icons event-card__detail-icon","aria-hidden":"true",children:o?"science":"assignment"}),e.jsx("span",{className:"event-card__detail-label",children:"Dettagli:"}),e.jsx("span",{className:"event-card__detail-value",children:"-"!==m?m:"Nessun dettaglio"})]})]}),(t.note||t.data_fine_evento)&&e.jsxs("div",{className:"event-card__notes",children:[t.note&&e.jsxs("div",{className:"event-card__note-row",children:[e.jsx("strong",{children:"Note:"})," ",t.note]}),t.data_fine_evento&&e.jsxs("div",{className:"event-card__note-row",children:[e.jsx("strong",{children:"Data fine:"})," ",e.jsx("time",{dateTime:t.data_fine_evento,title:new Date(t.data_fine_evento).toLocaleDateString("it-IT"),children:new Date(t.data_fine_evento).toLocaleDateString("it-IT")})]})]}),e.jsxs("div",{className:"event-card__actions",children:[e.jsxs(c,{variant:"secondary",className:"event-card__action-btn",onClick:()=>s(t),"aria-label":`Modifica evento ${o?"infezione":"intervento"} del ${h}`,children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"edit"}),"Modifica"]}),l&&e.jsxs(c,{variant:"danger",className:"event-card__action-btn",onClick:()=>l(t.id),"aria-label":`Elimina evento ${o?"infezione":"intervento"} del ${h}`,children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"delete"}),"Elimina"]}),o&&!t.data_fine_evento&&e.jsxs(c,{variant:"success",className:"event-card__action-btn",onClick:()=>r(t.id),"aria-label":"Segna infezione come risolta",children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"check_circle"}),"Risolvi"]})]})]})]})});_.displayName="EventCard";const z=({hasFilters:t,onCreateClick:i})=>e.jsxs("div",{className:"events-empty-state",role:"status","aria-live":"polite","aria-label":t?"Nessun evento corrisponde ai filtri selezionati":"Nessun evento clinico registrato",children:[e.jsx("div",{className:"empty-icon",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:t?"filter_list_off":"event_busy"})}),e.jsx("h3",{className:"empty-title",children:t?"Nessun evento trovato":"Nessun evento registrato"}),e.jsx("p",{className:"empty-description",children:t?"Nessun evento clinico corrisponde ai criteri di ricerca selezionati. Prova a modificare i filtri o a rimuovere alcuni di essi.":"Non hai ancora registrato alcun evento clinico per i pazienti. Inizia creando il primo evento."}),!t&&e.jsxs(c,{variant:"clinical",onClick:i,className:"mt-3","aria-label":"Crea il primo evento clinico",children:[e.jsx("span",{className:"material-icons me-1",children:"add"}),"Crea Primo Evento"]})]}),y=({count:t=5})=>e.jsx("div",{className:"event-card-skeletons",children:[...Array(t)].map((t,i)=>e.jsxs("div",{className:"event-card-skeleton",children:[e.jsx("div",{className:"event-card-skeleton__strip"}),e.jsxs("div",{className:"event-card-skeleton__content",children:[e.jsxs("div",{className:"event-card-skeleton__header",children:[e.jsx("div",{className:"event-card-skeleton__avatar"}),e.jsxs("div",{className:"event-card-skeleton__lines",children:[e.jsx("div",{className:"event-card-skeleton__line event-card-skeleton__line--title"}),e.jsx("div",{className:"event-card-skeleton__line event-card-skeleton__line--badge"})]})]}),e.jsxs("div",{className:"event-card-skeleton__details",children:[e.jsx("div",{className:"event-card-skeleton__line event-card-skeleton__line--detail"}),e.jsx("div",{className:"event-card-skeleton__line event-card-skeleton__line--short"})]}),e.jsxs("div",{className:"event-card-skeleton__actions",children:[e.jsx("div",{className:"event-card-skeleton__button"}),e.jsx("div",{className:"event-card-skeleton__button"}),e.jsx("div",{className:"event-card-skeleton__button"})]})]})]},i))}),C=({rows:t=5})=>e.jsx("div",{className:"skeleton-table",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})})]})}),e.jsx("tbody",{children:[...Array(t)].map((t,i)=>e.jsxs("tr",{className:"skeleton-row",children:[e.jsx("td",{children:e.jsx("div",{className:"skeleton-text"})}),e.jsx("td",{children:e.jsx("div",{className:"skeleton-text"})}),e.jsx("td",{children:e.jsx("div",{className:"skeleton-text skeleton-short"})}),e.jsx("td",{children:e.jsx("div",{className:"skeleton-text skeleton-medium"})}),e.jsxs("td",{children:[e.jsx("div",{className:"skeleton-badge"}),e.jsx("div",{className:"skeleton-badge"})]})]},i))})]})}),w={tipo_evento:[],paziente_id:void 0,paziente_search:"",data_inizio:void 0,data_fine:void 0};function k({initialFilters:e={},debounceMs:t=300,onFiltersChange:i,batchUpdateDelay:a=100}={}){const[n,s]=l.useState(()=>({...w,...e})),[r,o]=l.useState({}),[c,d]=l.useState(!1),[m,h]=l.useState(!1),v=l.useRef(),u=l.useRef(),p=l.useCallback(e=>{h(!0),v.current&&clearTimeout(v.current),v.current=setTimeout(()=>{s(e),h(!1),i&&i(e)},t)},[t,i]),x=l.useCallback((e,t)=>{const i={...n,[e]:t};p(i)},[n,p]),g=l.useCallback(e=>{const t={...n,...e};p(t)},[n,p]),j=l.useCallback(e=>{s(e),i&&i(e)},[i]),f=l.useCallback(()=>{v.current&&(clearTimeout(v.current),v.current=void 0);const e={...w};s(e),h(!1),i&&i(e)},[i]);l.useCallback((e,t)=>{o(i=>({...i,[e]:t})),d(!0),u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{N()},a)},[a]);const N=l.useCallback(()=>{if(c){const e={...n,...r};p(e),o({}),d(!1),u.current&&clearTimeout(u.current)}},[n,r,c,p]),b=l.useCallback(()=>{o({}),d(!1),u.current&&clearTimeout(u.current)},[]);return l.useEffect(()=>()=>{v.current&&clearTimeout(v.current),u.current&&clearTimeout(u.current)},[]),{filters:n,pendingFilters:r,hasPendingChanges:c,updateFilter:x,updateFilters:g,setFilters:j,resetFilters:f,applyPendingFilters:N,discardPendingFilters:b,isDebouncing:m}}const S=["intervento","infezione"],I={intervento:"Intervento",infezione:"Infezione"},E=s.memo(({initialFilters:t,onFiltersChange:i,debounceMs:a=300,showQuickFilters:n=!0,showBatchControls:r=!1,compact:o=!1,compactToggleOverride:v})=>{const{filters:u,hasPendingChanges:p,updateFilter:x,updateFilters:g,resetFilters:j,applyPendingFilters:f,discardPendingFilters:N,isDebouncing:b}=k({initialFilters:t,debounceMs:a,onFiltersChange:i}),[_,z]=l.useState(u.paziente_search||""),[y,C]=l.useState(u.data_inizio||""),[w,E]=l.useState(u.data_fine||""),[M,P]=l.useState(null),[D,R]=l.useState(!1);l.useEffect(()=>{z(u.paziente_search||""),C(u.data_inizio||""),E(u.data_fine||""),u.paziente_id||P(null)},[u]);const T=l.useCallback(e=>{C(e||""),x("data_inizio",e||void 0)},[x]),F=l.useCallback(e=>{E(e||""),x("data_fine",e||void 0)},[x]),O=l.useCallback(e=>{x("tipo_evento",e?[e]:[])},[x]),$=l.useCallback(e=>{const t=new Date;let i,a;switch(t.setHours(0,0,0,0),e){case"today":i=a=t.toISOString().split("T")[0];break;case"week":const e=new Date(t);e.setDate(t.getDate()-7),i=e.toISOString().split("T")[0],a=t.toISOString().split("T")[0];break;case"month":const n=new Date(t);n.setDate(t.getDate()-30),i=n.toISOString().split("T")[0],a=t.toISOString().split("T")[0]}C(i),E(a),g({data_inizio:i,data_fine:a})},[g]),A=l.useCallback(()=>{j(),z(""),C(""),E("")},[j]),B=s.useMemo(()=>{let e=0;return u.paziente_search&&e++,u.tipo_evento&&u.tipo_evento.length>0&&e++,u.data_inizio&&e++,u.data_fine&&e++,e},[u]),L=l.useCallback(e=>{switch(e){case"paziente_search":x("paziente_id",void 0),z("");break;case"tipo_evento":x("tipo_evento",[]);break;case"data_inizio":T(null);break;case"data_fine":F(null)}},[x,T,F]);if(o){const t=Boolean(v),i=t&&v?v.expanded:D;return e.jsxs("div",{className:"debounced-event-filters compact "+(i?"is-expanded":"is-collapsed"),children:[!t&&e.jsxs("div",{className:"filters-header-bar",children:[e.jsxs("div",{className:"filters-summary",children:[e.jsxs("button",{type:"button",className:"filters-toggle-btn",onClick:()=>{t&&v?v.onToggle():R(e=>!e)},"aria-expanded":i,"aria-label":i?"Nascondi filtri":"Mostra filtri",children:[e.jsx("span",{className:"filters-toggle-icon material-icons","aria-hidden":"true",children:"filter_list"}),e.jsxs("span",{className:"filters-label",children:["Filtri ",B>0&&`(${B})`]}),e.jsx("span",{className:"filters-toggle-chevron material-icons","aria-hidden":"true",children:i?"expand_less":"expand_more"})]}),b&&e.jsx("span",{className:"spinner-border spinner-border-sm ms-2",role:"status","aria-label":"Caricamento filtri"})]}),B>0&&e.jsx(c,{variant:"link",size:"sm",onClick:A,className:"btn-reset-link",children:"Cancella tutto"})]}),B>0&&e.jsxs("div",{className:"active-filter-chips",hidden:!i,children:[u.paziente_search&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["Paziente: ",u.paziente_search]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>L("paziente_search"),"aria-label":"Rimuovi filtro paziente",children:"✕"})]}),u.tipo_evento&&u.tipo_evento.length>0&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["Tipo: ",u.tipo_evento.map(e=>I[e]).join(", ")]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>L("tipo_evento"),"aria-label":"Rimuovi filtro tipo evento",children:"✕"})]}),u.data_inizio&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["Da: ",u.data_inizio]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>L("data_inizio"),"aria-label":"Rimuovi filtro data inizio",children:"✕"})]}),u.data_fine&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["A: ",u.data_fine]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>L("data_fine"),"aria-label":"Rimuovi filtro data fine",children:"✕"})]})]}),i&&e.jsxs("div",{className:"filters-content",children:[t&&e.jsxs("div",{className:"filters-compact-actions d-flex justify-content-end align-items-center mb-2 gap-2",children:[b&&e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-label":"Caricamento filtri"}),B>0&&e.jsx(c,{variant:"link",size:"sm",onClick:A,className:"btn-reset-link",children:"Cancella tutto"})]}),e.jsxs("div",{className:"row g-2 align-items-end",children:[e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"patient-search-compact",className:"form-label",children:"Paziente"}),e.jsx(h,{value:M,onChange:e=>{P(e),x("paziente_id",e?e.id:void 0)},placeholder:"Cerca paziente per nome, cognome o codice...",className:"form-control form-control-sm"})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"event-type-compact",className:"form-label",children:"Tipo Evento"}),e.jsx(d,{id:"event-type-compact",value:u.tipo_evento?.[0]||"",options:[{value:"",label:"Tutti"},...S.map(e=>({value:e,label:I[e]}))],onChange:O,placeholder:"Tutti"})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{className:"form-label",children:"Periodo"}),e.jsx("div",{className:"date-range-expanded",children:e.jsx(m,{startDate:y,endDate:w,onStartDateChange:T,onEndDateChange:F,startLabel:"Data Inizio",endLabel:"Data Fine",startPlaceholder:"Data inizio",endPlaceholder:"Data fine",size:"sm",clearable:!0,allowInput:!0})})]})]})]})]})}return e.jsxs("div",{className:"debounced-event-filters",children:[n&&e.jsx("div",{className:"quick-filters mb-3",children:e.jsxs("div",{className:"btn-group",role:"group",children:[e.jsx(c,{variant:"outline-primary",size:"sm",onClick:()=>$("today"),children:"Oggi"}),e.jsx(c,{variant:"outline-primary",size:"sm",onClick:()=>$("week"),children:"Ultima settimana"}),e.jsx(c,{variant:"outline-primary",size:"sm",onClick:()=>$("month"),children:"Ultimo mese"})]})}),e.jsxs("div",{className:"row g-2",children:[e.jsxs("div",{className:"col-12 col-md-5 col-lg-7",children:[e.jsx("label",{htmlFor:"patient-search",className:"form-label",children:"Paziente"}),e.jsx(h,{value:M,onChange:e=>{P(e),x("paziente_id",e?e.id:void 0)},placeholder:"Cerca paziente per nome, cognome o codice...",className:"form-control"})]}),e.jsxs("div",{className:"col-12 col-md-6 col-lg-5",children:[e.jsx("label",{htmlFor:"event-type",className:"form-label",children:"Tipo Evento"}),e.jsx(d,{id:"event-type",value:u.tipo_evento?.[0]||"",options:[{value:"",label:"Tutti"},...S.map(e=>({value:e,label:I[e]}))],onChange:O,placeholder:"Tutti",className:"form-control-sm"})]}),e.jsx("div",{className:"col-12 col-md- col-lg-5",children:e.jsx(m,{startDate:y,endDate:w,onStartDateChange:T,onEndDateChange:F,startLabel:"Data Inizio",endLabel:"Data Fine",startPlaceholder:"gg/mm/aaaa",endPlaceholder:"gg/mm/aaaa",clearable:!0,allowInput:!0})}),e.jsx("div",{className:"col-12 col-lg-6 d-flex align-items-end",children:e.jsxs("div",{className:"w-100",children:[e.jsx("div",{className:"form-label",children:" "}),e.jsx(c,{id:"reset-filters",variant:"outline-primary",size:"lg",onClick:A,disabled:0===B,className:"w-100",children:"Resetta Filtri"})]})})]}),r&&p&&e.jsx("div",{className:"batch-controls mt-3 p-2 bg-light rounded",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("small",{className:"text-muted",children:"Ci sono modifiche non applicate"}),e.jsxs("div",{className:"btn-group btn-group-sm",children:[e.jsx(c,{variant:"success",onClick:f,children:"Applica"}),e.jsx(c,{variant:"outline-secondary",onClick:N,"aria-label":"Scarta le modifiche ai filtri",children:"Scarta modifiche"})]})]})})]})}),M=({statistics:t,loading:i})=>i?e.jsx("div",{className:"patient-stats-grid",children:[...Array(4)].map((t,i)=>e.jsxs("div",{className:"patient-stat-card is-loading",children:[e.jsx("div",{className:"stat-icon"}),e.jsx("div",{className:"stat-value"}),e.jsx("div",{className:"stat-label"})]},i))}):e.jsxs("div",{className:"patient-stats-grid",children:[e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"timeline"})}),e.jsx("div",{className:"stat-value",children:t.total}),e.jsx("div",{className:"stat-label",children:"Totale Eventi"})]}),e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"healing"})}),e.jsx("div",{className:"stat-value",children:t.interventi}),e.jsx("div",{className:"stat-label",children:"Interventi"})]}),e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"bug_report"})}),e.jsx("div",{className:"stat-value",children:t.infezioni}),e.jsx("div",{className:"stat-label",children:"Infezioni"})]}),e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"date_range"})}),e.jsx("div",{className:"stat-value",children:t.ultimoMese}),e.jsx("div",{className:"stat-label",children:"Nell'ultimo mese"})]})]}),P=typeof window<"u"?l.useLayoutEffect:l.useEffect;function D(e){if(void 0!==e)switch(typeof e){case"number":return e;case"string":if(e.endsWith("px"))return parseFloat(e)}}function R({scrollOffset:e}){return e}function T(e,t="Assertion error"){if(!e)throw console.error(t),Error(t)}function F(e,t){if(e===t)return!0;if(!!e!=!!t||(T(void 0!==e),T(void 0!==t),Object.keys(e).length!==Object.keys(t).length))return!1;for(const i in e)if(!Object.is(t[i],e[i]))return!1;return!0}function O({cachedBounds:e,itemCount:t,itemSize:i}){if(0===t)return 0;if("number"==typeof i)return t*i;{const i=e.get(0===e.size?0:e.size-1);T(void 0!==i,"Unexpected bounds cache miss");return t*((i.scrollOffset+i.size)/e.size)}}function $({cachedBounds:e,containerScrollOffset:t,containerSize:i,itemCount:a,overscanCount:n}){const s=a-1;let l=0,r=-1,o=0,c=-1,d=0;for(;d<s;){const i=e.get(d);if(i.scrollOffset+i.size>t)break;d++}for(l=d,o=Math.max(0,l-n);d<s;){const a=e.get(d);if(a.scrollOffset+a.size>=t+i)break;d++}return r=Math.min(s,d),c=Math.min(a-1,r+n),l<0&&(l=0,r=-1,o=0,c=-1),{startIndexVisible:l,stopIndexVisible:r,startIndexOverscan:o,stopIndexOverscan:c}}function A({itemCount:e,itemProps:t,itemSize:i}){return l.useMemo(()=>function({itemCount:e,itemProps:t,itemSize:i}){const a=new Map;return{get(n){for(T(n<e,`Invalid index ${n}`);a.size-1<n;){const e=a.size;let s;switch(typeof i){case"function":s=i(e,t);break;case"number":s=i}if(0===e)a.set(e,{size:s,scrollOffset:0});else{const t=a.get(e-1);T(void 0!==t,`Unexpected bounds cache miss for index ${n}`),a.set(e,{scrollOffset:t.scrollOffset+t.size,size:s})}}const s=a.get(n);return T(void 0!==s,`Unexpected bounds cache miss for index ${n}`),s},set(e,t){a.set(e,t)},get size(){return a.size}}}({itemCount:e,itemProps:t,itemSize:i}),[e,t,i])}function B({containerElement:e,containerStyle:t,defaultContainerSize:i=0,direction:a,isRtl:n=!1,itemCount:s,itemProps:r,itemSize:o,onResize:c,overscanCount:d}){const[m,h]=l.useState({startIndexVisible:0,startIndexOverscan:0,stopIndexVisible:-1,stopIndexOverscan:-1}),{startIndexVisible:v,startIndexOverscan:u,stopIndexVisible:p,stopIndexOverscan:x}={startIndexVisible:Math.min(s-1,m.startIndexVisible),startIndexOverscan:Math.min(s-1,m.startIndexOverscan),stopIndexVisible:Math.min(s-1,m.stopIndexVisible),stopIndexOverscan:Math.min(s-1,m.stopIndexOverscan)},{height:g=i,width:j=i}=function({box:e,defaultHeight:t,defaultWidth:i,disabled:a,element:n,mode:s,style:r}){const{styleHeight:o,styleWidth:c}=l.useMemo(()=>({styleHeight:D(r?.height),styleWidth:D(r?.width)}),[r?.height,r?.width]),[d,m]=l.useState({height:t,width:i}),h=a||void 0!==o||"only-width"===s||void 0!==o&&void 0!==c;return P(()=>{if(null===n||h)return;const t=new ResizeObserver(e=>{for(const t of e){const{contentRect:e,target:i}=t;n===i&&m(t=>t.height===e.height&&t.width===e.width?t:{height:e.height,width:e.width})}});return t.observe(n,{box:e}),()=>{t?.unobserve(n)}},[e,h,n,o,c]),l.useMemo(()=>({height:o??d.height,width:c??d.width}),[d,o,c])}({defaultHeight:i,defaultWidth:void 0,element:e,mode:"only-height",style:t}),f=l.useRef({height:0,width:0}),N=g,b=function({containerSize:e,itemSize:t}){let i;"string"==typeof t?(T(t.endsWith("%"),`Invalid item size: "${t}"; string values must be percentages (e.g. "100%")`),T(void 0!==e,"Container size must be defined if a percentage item size is specified"),i=e*parseInt(t)/100):i=t;return i}({containerSize:N,itemSize:o});l.useLayoutEffect(()=>{if("function"==typeof c){const e=f.current;(e.height!==g||e.width!==j)&&(c({height:g,width:j},{...e}),e.height=g,e.width=j)}},[g,c,j]);const _=A({itemCount:s,itemProps:r,itemSize:b}),z=l.useCallback(e=>_.get(e),[_]),y=l.useCallback(()=>O({cachedBounds:_,itemCount:s,itemSize:b}),[_,s,b]),C=l.useCallback(t=>{const i=R({containerElement:e,direction:a,isRtl:n,scrollOffset:t});return $({cachedBounds:_,containerScrollOffset:i,containerSize:N,itemCount:s,overscanCount:d})},[_,e,N,a,n,s,d]);P(()=>{h(C(e?.scrollTop??0))},[e,a,C]),P(()=>{if(!e)return;const t=()=>{h(t=>{const{scrollTop:i}=e,l=R({containerElement:e,direction:a,isRtl:n,scrollOffset:i}),r=$({cachedBounds:_,containerScrollOffset:l,containerSize:N,itemCount:s,overscanCount:d});return F(r,t)?t:r})};return e.addEventListener("scroll",t),()=>{e.removeEventListener("scroll",t)}},[_,e,N,a,s,d]);const w=function(e){const t=l.useRef(()=>{throw new Error("Cannot call during render.")});return P(()=>{t.current=e},[e]),l.useCallback(e=>t.current?.(e),[t])}(({align:t="auto",containerScrollOffset:i,index:l})=>{let r=function({align:e,cachedBounds:t,index:i,itemCount:a,itemSize:n,containerScrollOffset:s,containerSize:l}){if(i<0||i>=a)throw RangeError(`Invalid index specified: ${i}`,{cause:`Index ${i} is not within the range of 0 - ${a-1}`});const r=O({cachedBounds:t,itemCount:a,itemSize:n}),o=t.get(i),c=Math.max(0,Math.min(r-l,o.scrollOffset)),d=Math.max(0,o.scrollOffset-l+o.size);switch("smart"===e&&(e=s>=d&&s<=c?"auto":"center"),e){case"start":return c;case"end":return d;case"center":return o.scrollOffset<=l/2?0:o.scrollOffset+o.size/2>=r-l/2?r-l:o.scrollOffset+o.size/2-l/2;default:return s>=d&&s<=c?s:s<d?d:c}}({align:t,cachedBounds:_,containerScrollOffset:i,containerSize:N,index:l,itemCount:s,itemSize:b});if(e){if(r=R({containerElement:e,direction:a,isRtl:n,scrollOffset:r}),"function"!=typeof e.scrollTo){const e=C(r);F(m,e)||h(e)}return r}});return{getCellBounds:z,getEstimatedSize:y,scrollToIndex:w,startIndexOverscan:u,startIndexVisible:v,stopIndexOverscan:x,stopIndexVisible:p}}function L(e,t){const{ariaAttributes:i,style:a,...n}=e,{ariaAttributes:s,style:l,...r}=t;return F(i,s)&&F(a,l)&&F(n,r)}function V({children:t,className:i,defaultHeight:a=0,listRef:n,onResize:s,onRowsRendered:r,overscanCount:o=3,rowComponent:c,rowCount:d,rowHeight:m,rowProps:h,tagName:v="div",style:u,...p}){const x=function(e){return l.useMemo(()=>e,Object.values(e))}(h),g=l.useMemo(()=>l.memo(c,L),[c]),[j,f]=l.useState(null),N=function(e){return null!=e&&"object"==typeof e&&"getAverageRowHeight"in e&&"function"==typeof e.getAverageRowHeight}(m),b=l.useMemo(()=>N?e=>m.getRowHeight(e)??m.getAverageRowHeight():m,[N,m]),{getCellBounds:_,getEstimatedSize:z,scrollToIndex:y,startIndexOverscan:C,startIndexVisible:w,stopIndexOverscan:k,stopIndexVisible:S}=B({containerElement:j,containerStyle:u,defaultContainerSize:a,direction:"vertical",itemCount:d,itemProps:x,itemSize:b,onResize:s,overscanCount:o});l.useImperativeHandle(n,()=>({get element(){return j},scrollToRow({align:e="auto",behavior:t="auto",index:i}){const a=y({align:e,containerScrollOffset:j?.scrollTop??0,index:i});"function"==typeof j?.scrollTo&&j.scrollTo({behavior:t,top:a})}}),[j,y]),P(()=>{if(!j)return;const e=Array.from(j.children).filter((e,t)=>{if(e.hasAttribute("aria-hidden"))return!1;return e.setAttribute("data-react-window-index",`${C+t}`),!0});return N?m.observeRowElements(e):void 0},[j,N,m,C,k]),l.useEffect(()=>{C>=0&&k>=0&&r&&r({startIndex:w,stopIndex:S},{startIndex:C,stopIndex:k})},[r,C,w,k,S]);const I=l.useMemo(()=>{const e=[];if(d>0)for(let t=C;t<=k;t++){const i=_(t);e.push(l.createElement(g,{...x,ariaAttributes:{"aria-posinset":t+1,"aria-setsize":d,role:"listitem"},key:t,index:t,style:{position:"absolute",left:0,transform:`translateY(${i.scrollOffset}px)`,height:N?void 0:i.size,width:"100%"}}))}return e},[g,_,N,d,x,C,k]),E=e.jsx("div",{"aria-hidden":!0,style:{height:z(),width:"100%",zIndex:-1}});return l.createElement(v,{role:"list",...p,className:i,ref:f,style:{position:"relative",maxHeight:"100%",flexGrow:1,overflowY:"auto",...u}},I,t,E)}const W=({index:t,style:i,events:a,patients:n,onEdit:s,onDelete:l,onResolve:r,tipiInterventoMap:o,agentiPatogeniMap:c})=>{const d=a[t],m=d?n.get(d.paziente_id):void 0;return e.jsx("div",d?{style:{...i,paddingBottom:"0.5rem"},children:e.jsx(_,{event:d,patient:m,tipiInterventoMap:o,agentiPatogeniMap:c,onEdit:s,onDelete:l,onResolve:r})}:{style:i})},q=({currentPage:t,totalPages:i,totalCount:a,eventsLength:n,onPageChange:s})=>e.jsx("nav",{"aria-label":"Paginazione eventi clinici",className:"mt-3",children:e.jsxs("div",{className:"d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2",children:[e.jsxs("div",{className:"text-muted small text-center text-sm-start",role:"status","aria-live":"polite","aria-atomic":"true",children:["Pagina ",t," di ",i," • ",a??n," eventi totali"]}),e.jsxs("div",{className:"d-flex gap-2",role:"group","aria-label":"Navigazione pagine",children:[e.jsxs("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>s(Math.max(1,t-1)),disabled:t<=1,"aria-label":`Vai alla pagina precedente (attualmente a pagina ${t} di ${i})`,children:[e.jsx("span",{className:"material-icons me-1 align-middle","aria-hidden":"true",children:"chevron_left"}),"Precedente"]}),e.jsxs("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>s(Math.min(i,t+1)),disabled:t>=i,"aria-label":`Vai alla pagina successiva (attualmente a pagina ${t} di ${i})`,children:["Successivo",e.jsx("span",{className:"material-icons ms-1 align-middle","aria-hidden":"true",children:"chevron_right"})]})]})]})}),H=({events:t,patients:i,loading:a,hasFilters:n=!1,onEdit:s,onDelete:r,onResolve:o,onCreateEvent:c,tipiInterventoMap:d,agentiPatogeniMap:m,currentPage:h,totalPages:v,totalCount:u,onPageChange:p})=>{const x=t.length>50,g=l.useMemo(()=>({events:t,patients:i,onEdit:s,onDelete:r,onResolve:o,tipiInterventoMap:d,agentiPatogeniMap:m}),[t,i,s,r,o,d,m]);return a?e.jsx(y,{count:10}):0===t.length?e.jsx(z,{hasFilters:n,onCreateClick:c||(()=>{})}):e.jsxs("div",{className:"virtualized-event-list",children:[e.jsx("div",{className:"mb-2 d-flex justify-content-between align-items-center",children:e.jsxs("div",{className:"text-muted small",children:[x&&e.jsxs("span",{className:"badge bg-info text-dark me-2",title:"Virtual scrolling attivo per performance ottimali",children:[e.jsx("span",{className:"material-icons align-middle me-1",style:{fontSize:"0.85rem"},children:"speed"}),"Virtual"]}),t.length," eventi"]})}),x?e.jsx(V,{rowComponent:W,rowCount:t.length,rowHeight:220,rowProps:g,overscanCount:5,style:{height:Math.min(220*t.length,600)}}):e.jsx("div",{className:"virtualized-event-list-container",children:t.map(t=>{const a=i.get(t.paziente_id);return e.jsx("div",{children:e.jsx(_,{event:t,patient:a,tipiInterventoMap:d,agentiPatogeniMap:m,onEdit:s,onDelete:r,onResolve:o})},t.id)})}),t.length>0&&"number"==typeof h&&"number"==typeof v&&p?e.jsx(q,{currentPage:h,totalPages:v,totalCount:u??t.length,eventsLength:t.length,onPageChange:p}):t.length>0&&e.jsx("div",{className:"text-center mt-3",children:e.jsxs("div",{className:"text-muted small",children:[t.length," eventi totali"]})})]})},K=({index:t,style:i,events:a,patients:n,onEdit:s,onDelete:l,onResolve:r,tipiInterventoMap:o,agentiPatogeniMap:d})=>{const m=a[t],h=m?n.get(m.paziente_id):void 0;return m?e.jsxs("div",{style:i,className:"d-flex align-items-center border-bottom px-3 "+(t%2==0?"":"bg-light"),role:"row",children:[e.jsxs("div",{className:"flex-grow-1 me-3",style:{minWidth:"180px"},children:[e.jsx("div",{className:"fw-semibold text-truncate",children:h?`${h.nome} ${h.cognome}`:m.paziente_id}),h?.codice_rad&&e.jsxs("div",{className:"small text-muted",children:["RAD: ",h.codice_rad]})]}),e.jsx("div",{className:"me-3",style:{minWidth:"100px"},children:e.jsx("span",{className:"badge "+("intervento"===m.tipo_evento?"bg-primary":"bg-danger"),children:"intervento"===m.tipo_evento?"Intervento":"Infezione"})}),e.jsx("div",{className:"me-3 text-nowrap",style:{minWidth:"100px"},children:new Date(m.data_evento).toLocaleDateString("it-IT")}),e.jsx("div",{className:"me-3 flex-grow-1 text-truncate",style:{minWidth:"120px"},children:b(m,o,d)}),e.jsxs("div",{className:"d-flex gap-1",style:{minWidth:"120px"},children:[e.jsx(c,{variant:"link",size:"sm",onClick:()=>s(m),title:"Modifica evento",className:"p-1",children:e.jsx("span",{className:"material-icons fs-5",children:"edit"})}),l&&e.jsx(c,{variant:"link",size:"sm",onClick:()=>l(m.id),title:"Elimina evento",className:"p-1 text-danger",children:e.jsx("span",{className:"material-icons fs-5",children:"delete"})}),"infezione"===m.tipo_evento&&!m.data_fine_evento&&e.jsx(c,{variant:"link",size:"sm",onClick:()=>r(m.id),title:"Risolvi infezione",className:"p-1 text-success",children:e.jsx("span",{className:"material-icons fs-5",children:"check_circle"})})]})]}):e.jsx("div",{style:i})},Q=({event:t,patient:i,onEdit:a,onDelete:n,onResolve:s,tipiInterventoMap:l,agentiPatogeniMap:r})=>e.jsxs("tr",{className:"event-row",children:[e.jsx("td",{children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("div",{className:"fw-semibold",children:i?`${i.nome} ${i.cognome}`:t.paziente_id}),i?.codice_rad&&e.jsxs("div",{className:"small text-muted",children:["RAD: ",i.codice_rad]})]})}),e.jsx("td",{children:e.jsx("span",{className:"badge "+("intervento"===t.tipo_evento?"bg-primary":"bg-danger"),children:"intervento"===t.tipo_evento?"Intervento":"Infezione"})}),e.jsx("td",{children:e.jsx("div",{className:"text-nowrap",children:new Date(t.data_evento).toLocaleDateString("it-IT")})}),e.jsx("td",{children:b(t,l,r)}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(c,{variant:"link",size:"sm",onClick:()=>a(t),title:"Modifica evento",className:"p-1",children:e.jsx("span",{className:"material-icons fs-5",children:"edit"})}),n&&e.jsx(c,{variant:"link",size:"sm",onClick:()=>n(t.id),title:"Elimina evento",className:"p-1 text-danger",children:e.jsx("span",{className:"material-icons fs-5",children:"delete"})}),"infezione"===t.tipo_evento&&!t.data_fine_evento&&e.jsx(c,{variant:"link",size:"sm",onClick:()=>s(t.id),title:"Risolvi infezione",className:"p-1 text-success",children:e.jsx("span",{className:"material-icons fs-5",children:"check_circle"})})]})})]},t.id),U=({currentPage:t,totalPages:i,eventsCount:a,onPageChange:n})=>e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-3",children:[e.jsxs("div",{className:"text-muted small",children:["Pagina ",t," di ",i," • ",a," eventi"]}),e.jsx("nav",{"aria-label":"Navigazione pagine",children:e.jsxs("ul",{className:"pagination pagination-sm mb-0",children:[e.jsx("li",{className:"page-item "+(1===t?"disabled":""),children:e.jsx("button",{className:"page-link",onClick:()=>n(t-1),disabled:1===t,children:e.jsx("span",{className:"material-icons",children:"chevron_left"})})}),[...Array(Math.min(5,i)).keys()].map(a=>{let s=a+1;return i>5&&(s=t<=3?a+1:t>=i-2?i-4+a:t-2+a),e.jsx("li",{className:"page-item "+(t===s?"active":""),children:e.jsx("button",{className:"page-link",onClick:()=>n(s),"aria-current":t===s?"page":void 0,children:s})},s)}),e.jsx("li",{className:"page-item "+(t===i?"disabled":""),children:e.jsx("button",{className:"page-link",onClick:()=>n(t+1),disabled:t===i,children:e.jsx("span",{className:"material-icons",children:"chevron_right"})})})]})})]}),Y=({events:t,patients:i,loading:a,hasFilters:n=!1,onEdit:s,onDelete:r,onResolve:o,onCreateEvent:c,currentPage:d,totalPages:m,pageSize:h,onPageChange:v,onPageSizeChange:u,tipiInterventoMap:p,agentiPatogeniMap:x})=>{const g=t.length>50,j=l.useMemo(()=>({events:t,patients:i,onEdit:s,onDelete:r,onResolve:o,tipiInterventoMap:p,agentiPatogeniMap:x}),[t,i,s,r,o,p,x]);return a?e.jsx(C,{rows:h}):0===t.length?e.jsx(z,{hasFilters:n,onCreateClick:c||(()=>{})}):e.jsxs("div",{className:"virtualized-events-table",children:[e.jsxs("div",{className:"mb-2 d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"text-muted small",children:[g&&e.jsxs("span",{className:"badge bg-info text-dark me-2",title:"Virtual scrolling attivo per performance ottimali",children:[e.jsx("span",{className:"material-icons align-middle me-1",style:{fontSize:"0.85rem"},children:"speed"}),"Virtual"]}),t.length," eventi"]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"vs-page-size",className:"visually-hidden",children:"Elementi per pagina"}),e.jsx("select",{id:"vs-page-size",value:h,onChange:e=>u(Number(e.target.value)),className:"form-select form-select-sm",style:{width:"auto"},children:[10,20,50,100].map(t=>e.jsxs("option",{value:t,children:["Mostra ",t]},t))})]})]}),g?e.jsxs("div",{className:"border rounded",role:"table","aria-label":"Elenco eventi clinici",children:[e.jsxs("div",{className:"d-flex align-items-center border-bottom bg-light fw-bold px-3 py-2",role:"row",children:[e.jsx("div",{className:"flex-grow-1 me-3",style:{minWidth:"180px"},role:"columnheader",children:"Paziente"}),e.jsx("div",{className:"me-3",style:{minWidth:"100px"},role:"columnheader",children:"Tipo"}),e.jsx("div",{className:"me-3",style:{minWidth:"100px"},role:"columnheader",children:"Data"}),e.jsx("div",{className:"me-3 flex-grow-1",style:{minWidth:"120px"},role:"columnheader",children:"Dettagli"}),e.jsx("div",{style:{minWidth:"120px"},role:"columnheader",children:"Azioni"})]}),e.jsx(V,{rowComponent:K,rowCount:t.length,rowHeight:64,rowProps:j,overscanCount:10,style:{height:Math.min(64*t.length,500)}})]}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-striped table-hover","aria-label":"Elenco eventi clinici",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",children:"Paziente"}),e.jsx("th",{scope:"col",children:"Tipo Evento"}),e.jsx("th",{scope:"col",children:"Data"}),e.jsx("th",{scope:"col",children:"Dettagli"}),e.jsx("th",{scope:"col",children:"Azioni"})]})}),e.jsx("tbody",{children:t.map(t=>e.jsx(Q,{event:t,patient:i.get(t.paziente_id),onEdit:s,onDelete:r,onResolve:o,tipiInterventoMap:p,agentiPatogeniMap:x},t.id))})]})}),e.jsx(U,{currentPage:d,totalPages:m,eventsCount:t.length,onPageChange:v})]})},G={intervento:"Intervento Chirurgico",infezione:"Infezione"},J=["intervento","infezione"],X=({event:t,patientId:i,onSubmit:a,onCancel:n,initialEventType:s,allowedTypes:r,isSubmitting:o=!1})=>{const[c,d]=l.useState(()=>{if(t?.tipo_evento)return t.tipo_evento;if(s&&(!r||r.includes(s)))return s;return(r||J)[0]}),[m,v]=l.useState(i),[u,g]=l.useState(null);l.useEffect(()=>{t?.tipo_evento&&d(t.tipo_evento)},[t?.tipo_evento]);const j=r||J,f=!t&&j.length>1,N=t||m;return e.jsxs("div",{className:"typed-event-form",children:[!t&&e.jsx("div",{className:"card mb-4",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("h5",{className:"card-title mb-3",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1.25rem",marginRight:"0.5rem",verticalAlign:"middle"},children:"person_search"}),"Seleziona Paziente"]}),e.jsx(h,{value:u,onChange:e=>{e?(v(e.id),g(e)):(v(""),g(null))},placeholder:"Cerca per nome, cognome o RAD...",disabled:o,activeOnly:!1,maxResults:10,minSearchLength:1,debounceDelay:300,showPatientInfo:!0,highlightMatch:!0}),m&&u&&e.jsxs("div",{className:"alert alert-success mt-2 mb-0",role:"alert",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"check_circle"}),"Paziente selezionato: ",e.jsxs("strong",{children:[u.cognome," ",u.nome]})]}),!m&&e.jsxs("div",{className:"alert alert-info mt-2 mb-0",role:"alert",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"info"}),"Seleziona un paziente per continuare"]})]})}),f&&N&&e.jsx("div",{className:"card mb-4",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"card-title mb-3",children:"Seleziona Tipo Evento"}),e.jsx("div",{className:"btn-group w-100",role:"group",children:j.map(t=>e.jsx("button",{type:"button",className:"btn "+(c===t?"btn-primary active":"btn-outline-primary"),onClick:()=>{d(t)},disabled:o,children:G[t]},t))}),e.jsx("div",{className:"mt-2 text-center",children:e.jsxs("small",{className:"text-muted",children:["Tipo selezionato: ",e.jsx("strong",{children:G[c]})]})})]})}),N&&e.jsx("intervento"===c?p:x,{event:t,patientId:m,onSubmit:a,onCancel:n,isSubmitting:o})]})},Z=()=>{const s=r(),{notify:d}=g(),m=i(),{user:h}=a(),p=f(),x=p.isMobile;l.useEffect(()=>{const e=document.documentElement.style.scrollBehavior;document.documentElement.style.scrollBehavior="auto",window.scrollTo(0,0);const t=setTimeout(()=>{window.scrollTo(0,0)},100),i=setTimeout(()=>{window.scrollTo(0,0),document.documentElement.style.scrollBehavior=e},300);return()=>{clearTimeout(t),clearTimeout(i),document.documentElement.style.scrollBehavior=e}},[]);const[b,_]=o(),[z,y]=l.useState(null),[C,w]=l.useState(null),[S,I]=l.useState(1),[P,D]=l.useState(10),[R,T]=l.useState(!1),[F,O]=l.useState("create"),[$,A]=l.useState(null),[B,L]=l.useState(!1),[V,W]=l.useState({title:"",body:"",onConfirm:()=>{}}),[q,K]=l.useState(!p.isMobile),Q=l.useCallback(()=>{K(e=>!e)},[]),{filters:U,updateFilters:G}=k({onFiltersChange:()=>I(1)});l.useEffect(()=>{const e=b.get("action"),t=b.get("type"),i=b.get("paziente");i&&(w(i),G({paziente_id:i})),"add"===e&&t&&i&&(y(t),setTimeout(()=>{x?s(`/eventi-clinici/nuovo?patientId=${i}&type=${t}`):(O("create"),T(!0))},100)),(e||t||i)&&_({},{replace:!0})},[]);const J=l.useMemo(()=>["eventi",JSON.stringify(U),S,P],[U,S,P]),{data:Z,isLoading:ee,error:te}=t({queryKey:J,queryFn:()=>u.getAllEventi(U,{page:S,limit:P})}),{data:ie,isLoading:ae}=t({queryKey:["eventiStats"],queryFn:u.getEventiStats,initialData:{total:0,interventi:0,infezioni:0,ultimoMese:0}}),{data:ne}=t({queryKey:["tipiIntervento"],queryFn:u.getListaTipiIntervento}),{data:se}=t({queryKey:["agentiPatogeni"],queryFn:u.getListaAgentiPatogeno}),le=l.useMemo(()=>ne?N(ne):new Map,[ne]),re=l.useMemo(()=>se?N(se):new Map,[se]),{eventi:oe=[],totalPages:ce=1,totalCount:de=0}=Z||{},me=l.useMemo(()=>{const e=new Map;return oe.forEach(t=>{e.has(t.paziente_id)||e.set(t.paziente_id,t.pazienti)}),e},[oe]),he=l.useMemo(()=>{let e=0;return(U.paziente_search||U.paziente_id)&&e++,U.tipo_evento&&U.tipo_evento.length>0&&e++,U.data_inizio&&e++,U.data_fine&&e++,e},[U]),ve={onSuccess:()=>{m.invalidateQueries({queryKey:["eventi"]}),m.invalidateQueries({queryKey:["eventiStats"]}),_e()},onError:e=>{d.error(e.message||"Si è verificato un errore").show()}},ue=n({mutationFn:e=>u.createEvento(e),...ve}),pe=n({mutationFn:e=>u.updateEvento(e.id,e.eventData),...ve}),xe=n({mutationFn:e=>u.deleteEvento(e),onSuccess:()=>{m.invalidateQueries({queryKey:["eventi"]}),m.invalidateQueries({queryKey:["eventiStats"]}),L(!1)},onError:ve.onError}),ge=n({mutationFn:e=>u.resolveInfezione(e.id,e.dataFine),onSuccess:()=>{m.invalidateQueries({queryKey:["eventi"]}),L(!1)},onError:ve.onError}),je=async e=>{"create"===F?await ue.mutateAsync(e):$&&await pe.mutateAsync({id:$.id,eventData:e})},fe=e=>{if("viewer"===h?.role)return d.error("Non hai i permessi per eliminare eventi").show(),void 0;ze("Conferma Eliminazione","Sei sicuro di voler eliminare questo evento?",()=>{xe.mutate(e)})},Ne=e=>{const t=prompt("Inserisci la data di risoluzione (YYYY-MM-DD):");t&&ze("Conferma Risoluzione",`Sei sicuro di voler risolvere l'infezione in data ${t}?`,()=>{ge.mutate({id:e,dataFine:t})})},be=(e,t)=>{if("create"===e&&x)return s("/eventi-clinici/nuovo"),void 0;O(e),A(t||null),T(!0)},_e=()=>{T(!1),A(null),O("create")};l.useEffect(()=>{R&&x&&requestAnimationFrame(()=>{window.scrollTo(0,0)})},[R,x]);const ze=(e,t,i)=>{W({title:e,body:t,onConfirm:i}),L(!0)};return e.jsxs(e.Fragment,{children:[e.jsx(j,{...V,isOpen:B,onCancel:()=>L(!1)}),e.jsxs("div",{className:"clinical-events-page",children:[e.jsx("div",{className:"patient-list-hero clinical-hero",children:e.jsxs("div",{className:"patient-list-hero-content",children:[e.jsxs("h1",{className:"patient-list-title",children:[e.jsx("span",{className:"material-icons me-2",children:"timeline"}),"Eventi Clinici"]}),e.jsx("p",{className:"patient-list-subtitle",children:"Gestisci eventi clinici, filtra per tipo e data, esporta i risultati"})]})}),te&&e.jsx("div",{className:"alert alert-danger",children:"Errore nel caricamento degli eventi. Riprova."}),e.jsx(M,{statistics:ie,loading:ae}),e.jsxs("section",{className:"patient-filters-card"+(x?" clinical-filters-collapsible":""),children:[e.jsxs("div",{className:"patient-filters-header",children:[e.jsxs("div",{className:"filters-title-wrapper",children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"filter_list"}),e.jsx("h2",{className:"filters-title",children:"Filtri Eventi"}),x&&he>0&&e.jsx("span",{className:"filters-active-count","aria-label":`${he} filtri attivi`,children:he})]}),x&&e.jsx("button",{type:"button",className:"filters-collapse-toggle",onClick:Q,"aria-expanded":q,"aria-controls":"clinical-event-filters","aria-label":q?"Nascondi filtri eventi clinici":"Mostra filtri eventi clinici",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:q?"expand_less":"expand_more"})})]}),e.jsx("div",{className:"patient-filters-body",id:"clinical-event-filters",hidden:x&&!q,children:e.jsx(E,{initialFilters:U,onFiltersChange:G,compact:x,compactToggleOverride:x?{expanded:q,onToggle:Q}:void 0})})]}),e.jsxs("section",{className:"patient-results-card",children:[e.jsx("div",{className:"patient-results-header",children:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%"},children:[e.jsxs("h2",{className:"results-title",children:[e.jsx("span",{className:"material-icons",children:"list"}),"Eventi (",de,")"]}),"viewer"!==h?.role&&!x&&e.jsxs(c,{variant:"clinical",onClick:()=>be("create"),className:"btn-nuovo-evento",style:{padding:"0.65rem 1.5rem",fontSize:"1rem",fontWeight:"600",whiteSpace:"nowrap"},children:[e.jsx("span",{className:"material-icons align-middle",style:{marginRight:"0.5rem",fontSize:"1.3rem"},children:"add"}),"Nuovo Evento"]})]})}),e.jsx("div",{className:"patient-results-body",children:"cards"===p.viewMode?e.jsx(H,{events:oe,patients:me,loading:ee,hasFilters:he>0,onEdit:e=>be("edit",e),onDelete:"viewer"!==h?.role?fe:void 0,onResolve:Ne,onCreateEvent:()=>be("create"),tipiInterventoMap:le,agentiPatogeniMap:re,currentPage:S,totalPages:ce,totalCount:de,onPageChange:I}):e.jsx(Y,{events:oe,patients:me,loading:ee,hasFilters:he>0,onEdit:e=>be("edit",e),onDelete:"viewer"!==h?.role?fe:void 0,onResolve:Ne,onCreateEvent:()=>be("create"),currentPage:S,totalPages:ce,pageSize:P,onPageChange:I,onPageSizeChange:D,tipiInterventoMap:le,agentiPatogeniMap:re})})]}),"viewer"!==h?.role&&x&&e.jsxs("button",{type:"button",className:"fab-nuovo-evento",onClick:()=>be("create"),"aria-label":"Nuovo Evento",children:[e.jsx("span",{className:"material-icons",children:"add"}),e.jsx("span",{className:"fab-nuovo-evento__label",children:"Nuovo"})]}),R&&x&&e.jsxs("div",{className:"event-wizard-mobile-overlay",children:[e.jsxs("div",{className:"event-wizard-mobile-overlay__header",children:[e.jsx("span",{className:"event-wizard-mobile-overlay__title",children:"create"===F?"Nuovo Evento":"Modifica Evento"}),e.jsx("button",{type:"button",className:"event-wizard-mobile-overlay__close",onClick:_e,"aria-label":"Chiudi wizard",children:e.jsx("span",{className:"material-icons",children:"close"})})]}),e.jsx(v,{patientId:$?.paziente_id||"",event:$||void 0,onSubmit:je,onCancel:_e})]}),R&&!x&&e.jsx("div",{className:"modal fade show modal-themed-purple",style:{display:"block"},tabIndex:-1,children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{className:"modal-header-hero",children:[e.jsx("div",{className:"modal-header-icon",children:e.jsx("span",{className:"material-icons",children:"timeline"})}),e.jsxs("div",{className:"modal-header-text",children:[e.jsx("h5",{className:"modal-title",children:"create"===F?"Nuovo Evento":"Modifica Evento"}),$&&me.get($.paziente_id)&&e.jsxs("p",{className:"modal-subtitle",children:[e.jsx("span",{className:"material-icons",children:"person"}),me.get($.paziente_id)?.cognome," ",me.get($.paziente_id)?.nome]})]})]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:_e})]}),e.jsx("div",{className:"modal-body",children:e.jsx(X,{event:$||void 0,patientId:$?.paziente_id||C||"",onSubmit:je,onCancel:_e,isSubmitting:ue.isPending||pe.isPending,initialEventType:z||void 0})})]})})})]}),"    "]})};export{Z as EventsPage,Z as default};
