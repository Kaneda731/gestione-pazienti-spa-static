import{j as e,M as a}from"./ui-vendor-S6RcKJ66.js";import{b as i,i as n,j as s,u as t}from"./react-vendor-Bp2pLdQf.js";import{B as r,g as o,a as l,b as c,p as d}from"./patientService-BDMwQoHp.js";import{C as m}from"./CustomSelect-CF-Ac0bs.js";import{D as p}from"./DateRangePicker-jVjeFj7b.js";import{s as u,l as h}from"./index-ZtYnyUUS.js";import{I as g,a as v}from"./InterventionForm-Brfr3bDw.js";import{n as x,a as f,b}from"./notificationErrorHandler-D46pQKbv.js";import{l as j}from"./filterQueryService-ico5Tk_8.js";import{u as N,a as w,b as z}from"./wizard-DwN_BpxF.js";import"./supabase-Zkii_ZbW.js";const _=[{value:"dimissione",label:"Dimissione"},{value:"trasferimento_interno",label:"Trasferimento interno"},{value:"trasferimento_esterno",label:"Trasferimento esterno"},{value:"decesso",label:"Decesso"}],y=[{value:"0",label:"0 - Ordinaria"},{value:"6",label:"6 - Protetta"}],C=[{value:"",label:"Seleziona..."},{value:"56",label:"56 - Riabilitazione Motoria"},{value:"60",label:"60 - Lunga Degenza"}],S=[{value:"",label:"Seleziona..."},{value:"Cardiologia",label:"Cardiologia"},{value:"CR1",label:"CR1"},{value:"CR3",label:"CR3"},{value:"Gastroenterologia",label:"Gastroenterologia"},{value:"Ginecologia",label:"Ginecologia"},{value:"Medicina Interna",label:"Medicina Interna"},{value:"Neurologia",label:"Neurologia"},{value:"Pediatria",label:"Pediatria"},{value:"Pneumologia",label:"Pneumologia"},{value:"UGI",label:"UGI"},{value:"Urologia",label:"Urologia"}],D={data_dimissione:"",tipo_dimissione:"dimissione",codice_dimissione:"0"},I=({patientName:a,onDischargeSubmit:n})=>{const[s,t]=i.useState(!1),[o,l]=i.useState(D),[c,d]=i.useState(!1),u=e=>a=>{l("tipo_dimissione"===e?i=>{const n={...i,[e]:a};return"dimissione"===a?n.codice_dimissione="0":"trasferimento_esterno"===a?n.codice_dimissione="3":"trasferimento_interno"!==a&&"decesso"!==a||(n.codice_dimissione=null),n}:i=>({...i,[e]:a}))};return e.jsxs("div",{className:"discharge-section card mt-4",children:[e.jsx("div",{className:"card-header bg-light",children:e.jsxs("button",{type:"button",onClick:()=>t(!s),className:"btn btn-link w-100 text-start p-0 d-flex justify-content-between align-items-center",style:{textDecoration:"none",color:"inherit"},children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1.5rem"},children:s?"expand_less":"expand_more"}),e.jsx("strong",{children:"Dimissione / Trasferimento"}),e.jsx("span",{className:"badge bg-info",style:{fontSize:"0.75rem"},children:"Opzionale"})]}),s&&e.jsxs("span",{style:{fontSize:"0.875rem",color:"#6c757d"},children:["Paziente: ",a]})]})}),s&&e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"alert alert-info mb-3",children:[e.jsx("strong",{children:"Nota:"})," Registra i dati di dimissione o trasferimento del paziente. Questa sezione è facoltativa e può essere completata anche in un secondo momento."]}),e.jsxs("form",{id:"discharge-section",onSubmit:async e=>{if(e.preventDefault(),!c&&n){d(!0);try{await n(o),l(D),t(!1)}finally{d(!1)}}},className:"d-flex flex-column gap-3",children:[e.jsx(p,{label:"Data dimissione",value:o.data_dimissione,onChange:e=>{l(a=>({...a,data_dimissione:e||""}))},isRequired:s,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-type",children:["Tipo dimissione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(m,{id:"discharge-dismissal-type",value:o.tipo_dimissione,options:_.map(e=>({value:e.value,label:e.label})),onChange:u("tipo_dimissione"),placeholder:"Seleziona..."})]}),"dimissione"===o.tipo_dimissione&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"discharge-dismissal-code",children:"Codice dimissione"}),e.jsx(m,{id:"discharge-dismissal-code",value:o.codice_dimissione??"",options:y.map(e=>({value:e.value,label:e.label})),onChange:u("codice_dimissione"),placeholder:"Seleziona..."})]}),"trasferimento_interno"===o.tipo_dimissione&&e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-dept",children:["Reparto destinazione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(m,{id:"discharge-dismissal-dept",value:o.reparto_destinazione??"",options:S.map(e=>({value:e.value,label:e.label})),onChange:u("reparto_destinazione"),placeholder:"Seleziona..."})]}),"trasferimento_esterno"===o.tipo_dimissione&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-clinic",children:["Clinica destinazione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{id:"discharge-dismissal-clinic",name:"clinica_destinazione",className:"form-control",value:o.clinica_destinazione??"",onChange:e=>{const{name:a,value:i}=e.target;l(e=>({...e,[a]:i}))},required:s&&"trasferimento_esterno"===o.tipo_dimissione})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-clinic-code",children:["Codice clinica ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(m,{id:"discharge-dismissal-clinic-code",value:o.codice_clinica??"",options:C.map(e=>({value:e.value,label:e.label})),onChange:u("codice_clinica"),placeholder:"Seleziona..."})]})]}),e.jsxs("div",{className:"d-flex gap-2 pt-2",children:[e.jsx(r,{type:"submit",disabled:c,children:c?"Registrazione in corso...":"Registra dimissione"}),e.jsx(r,{type:"button",variant:"secondary",onClick:()=>{l(D),t(!1)},children:"Annulla"})]})]})]})]})},k=["AR","PO","CO","CR","PS"],E=["Bassa","Media","Alta"],P=({values:a,onChange:i})=>e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-name",children:"Nome"}),e.jsx("input",{id:"patient-name",name:"nome",className:"form-control",value:a.nome,onChange:i,required:!0})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-surname",children:"Cognome"}),e.jsx("input",{id:"patient-surname",name:"cognome",className:"form-control",value:a.cognome,onChange:i,required:!0})]})]}),R=({values:a,onChange:i})=>{const n=e=>a=>{i({target:{name:e,value:a||""}})};return e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6",children:e.jsx(p,{id:"patient-birth-date",value:a.data_nascita,onChange:n("data_nascita"),label:"Data nascita",placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})}),e.jsx("div",{className:"col-md-6",children:e.jsx(p,{id:"patient-admission-date",value:a.data_ricovero,onChange:n("data_ricovero"),label:"Data ricovero",placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})})]})},F=({values:a,onChange:n,diagnosiOptions:s,repartoOptions:t,loadingDiagnosi:r,loadingReparti:o})=>{const l=e=>a=>{n({target:{name:e,value:a}})},c=i.useMemo(()=>[{value:"",label:"Seleziona diagnosi..."},...s.map(e=>({value:e.nome,label:e.nome}))],[s]),d=i.useMemo(()=>0===s.length?"empty":s.map(e=>e.id).sort().join("-"),[s]),p=i.useMemo(()=>[{value:"",label:"Seleziona..."},...t.map(e=>({value:e,label:e}))],[t]);return e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-diagnosis",children:"Diagnosi"}),e.jsx(m,{id:"patient-diagnosis",value:a.diagnosi,options:c,onChange:l("diagnosi"),disabled:r,placeholder:"Seleziona diagnosi..."},`diagnosis-${d}`),r&&e.jsx("small",{className:"form-text text-muted",children:"Caricamento diagnosi in corso..."})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-ward",children:"Reparto Appartenenza"}),e.jsx(m,{id:"patient-ward",value:a.reparto_appartenenza,options:p,onChange:l("reparto_appartenenza"),disabled:o,placeholder:"Seleziona..."},`ward-${t.length}`),o&&e.jsx("small",{className:"form-text text-muted",children:"Caricamento reparti in corso..."})]})]})},B=({values:a,onChange:n})=>{const s=e=>a=>{n({target:{name:e,value:a}})},t=i.useMemo(()=>[{value:"",label:"Seleziona..."},...k.map(e=>({value:e,label:e}))],[]),r=i.useMemo(()=>[{value:"",label:"Seleziona..."},...E.map(e=>({value:e,label:e}))],[]);return e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-codice-rad",children:"Codice RAD"}),e.jsx("input",{id:"patient-codice-rad",name:"codice_rad",className:"form-control",value:a.codice_rad,onChange:n})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-reparto-provenienza",children:"Reparto Provenienza"}),e.jsx(m,{id:"patient-reparto-provenienza",value:a.reparto_provenienza,options:t,onChange:s("reparto_provenienza"),placeholder:"Seleziona..."},"reparto-provenienza")]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-livello-assistenza",children:"Livello Assistenza"}),e.jsx(m,{id:"patient-livello-assistenza",value:a.livello_assistenza,options:r,onChange:s("livello_assistenza"),placeholder:"Seleziona..."},"livello-assistenza")]})]})},M=({values:a,onCheckboxChange:i,onEditInfection:n,onEditSurgery:s,infectionBadge:t,surgeryBadge:r,renderBadge:o})=>e.jsxs("div",{className:"row mt-3",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"patient-infetto",name:"infetto",checked:a.infetto,onChange:i}),e.jsxs("label",{className:"form-check-label",htmlFor:"patient-infetto",children:["Paziente Infetto",o(t)]})]}),e.jsxs("button",{type:"button",className:"btn btn-link px-0",onClick:()=>{void n()},children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"edit"}),"Modifica dati infezione"]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"patient-ha-intervento",name:"ha_intervento",checked:a.ha_intervento,onChange:i}),e.jsxs("label",{className:"form-check-label",htmlFor:"patient-ha-intervento",children:["Intervento Chirurgico",o(r)]})]}),e.jsxs("button",{type:"button",className:"btn btn-link px-0",onClick:()=>{void s()},children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"edit"}),"Modifica dati intervento"]})]})]}),$=({values:a,onChange:i})=>e.jsxs("div",{children:[e.jsx("label",{className:"form-label",htmlFor:"patient-notes",children:"Note"}),e.jsx("textarea",{id:"patient-notes",name:"note",className:"form-control",value:a.note,onChange:i,rows:3})]}),V=({submitting:a,submitLabel:i,onCancel:n})=>e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(r,{type:"submit",disabled:a,children:i}),e.jsx(r,{type:"button",variant:"secondary",onClick:n,children:"Annulla"})]}),A=({patientId:n,patientName:s="Paziente",event:t,onSubmit:r,onClose:o})=>{const[l,c]=i.useState(!1),d=i.useRef(`infection-event-modal-${Date.now()}`).current,m=i.useRef(null),p=i.useRef(null),u=i.useRef(null),h=i.useRef(null);i.useEffect(()=>{const e=m.current;if(!e)return;h.current=document.activeElement;let i=requestAnimationFrame(()=>{if(m.current)try{const i=new a(e);p.current=i;const n=()=>{u.current=null;const e=h.current;h.current=null,e&&document.contains(e)&&queueMicrotask(()=>e.focus()),o()};u.current=n,e.addEventListener("hidden.bs.modal",n),i.show()}catch(i){console.error("Error initializing modal:",i)}});return()=>{null!==i&&(cancelAnimationFrame(i),i=null);const a=p.current;if(p.current=null,e&&u.current&&(e.removeEventListener("hidden.bs.modal",u.current),u.current=null),a)try{a.dispose()}catch(n){console.error("Error disposing modal:",n)}}},[o]);const v=i.useCallback(()=>{const e=p.current;if(e){const a=m.current,i=document.activeElement;i&&a?.contains(i)&&i.blur(),e.hide()}else o()},[o]);return e.jsx("div",{className:"modal fade",id:d,ref:m,tabIndex:-1,"aria-labelledby":`${d}-label`,"aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"modal-title mb-1",id:`${d}-label`,children:t?"Modifica Evento":"Registra Infezione"}),e.jsxs("p",{className:"text-muted mb-0 small",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"person"}),s]})]}),e.jsx("button",{type:"button",className:"btn-close","aria-label":"Chiudi","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body",children:e.jsx(g,{event:t,patientId:n,onSubmit:async e=>{c(!0);try{await r(e),v()}finally{c(!1)}},onCancel:v,isSubmitting:l})})]})})})},O={hasData:!1,isValid:!1,tooltip:""};const L=({patientId:n,patientName:s="Paziente",event:t,onSubmit:r,onClose:o})=>{const[l,c]=i.useState(!1),d=i.useRef(`intervention-event-modal-${Date.now()}`).current,m=i.useRef(null),p=i.useRef(null),u=i.useRef(null);i.useEffect(()=>{const e=m.current;if(!e)return;let i=requestAnimationFrame(()=>{if(m.current)try{const i=new a(e);p.current=i;const n=()=>{u.current=null,o()};u.current=n,e.addEventListener("hidden.bs.modal",n),i.show()}catch(i){console.error("Error initializing modal:",i)}});return()=>{null!==i&&(cancelAnimationFrame(i),i=null);const a=p.current;if(p.current=null,e&&u.current&&(e.removeEventListener("hidden.bs.modal",u.current),u.current=null),a)try{a.dispose()}catch(n){console.error("Error disposing modal:",n)}}},[o]);const h=i.useCallback(()=>{const e=p.current;e?e.hide():o()},[o]);return e.jsx("div",{className:"modal fade",id:d,ref:m,tabIndex:-1,"aria-labelledby":`${d}-label`,"aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"modal-title mb-1",id:`${d}-label`,children:t?"Modifica Evento":"Registra Intervento"}),e.jsxs("p",{className:"text-muted mb-0 small",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"person"}),s]})]}),e.jsx("button",{type:"button",className:"btn-close","aria-label":"Chiudi","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body",children:e.jsx(v,{event:t,patientId:n,onSubmit:async e=>{c(!0);try{await r(e),h()}finally{c(!1)}},onCancel:h,isSubmitting:l})})]})})})},T={hasData:!1,isValid:!1,tooltip:""};function G({values:a,setValues:s,patientDisplayName:t,patientId:r=""}){const d=function({setValues:a,patientDisplayName:s,patientId:t=""}){const[r,l]=i.useState(O),[c,d]=i.useState(!1),m=i.useCallback(async()=>{const e=await o();if(!e.hasInfectionData())return O;const a=e.getInfectionData(),i=[];return a?.data_evento&&i.push(`Data: ${a.data_evento}`),a?.agente_patogeno&&i.push(`Agente: ${a.agente_patogeno}`),a?.descrizione&&i.push(`Note: ${a.descrizione}`),{hasData:!0,isValid:0===(e.getValidationErrors?.()?.length??0),tooltip:i.join("\n")}},[]),p=i.useCallback(async()=>{const e=await m();l(e)},[m]),u=i.useCallback(async e=>{const i=await o();i.setInfectionData({data_evento:e.data_evento,agente_patogeno_id:e.agente_patogeno_id,tipo_patogeno:e.tipo_patogeno,data_fine_evento:e.data_fine_evento,note:e.note}),d(!1);const n=i.hasInfectionData();a(e=>({...e,infetto:n})),await p()},[a,p]),h=i.useCallback(async e=>{e?d(!0):((await o()).clearInfectionData(),a(e=>({...e,infetto:!1})),await p())},[a,p]),g=i.useCallback(async e=>{const{name:a,checked:i}=e.target;"infetto"===a&&await h(i)},[h]),v=i.useCallback(()=>{d(!0)},[]);return{badge:r,renderBadge:i.useCallback(a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),handleCheckboxChange:g,handleEditInfection:v,modalsPortal:n.createPortal(e.jsx(e.Fragment,{children:c&&e.jsx(A,{patientId:t,patientName:s||"Nuovo Paziente",onSubmit:u,onClose:()=>d(!1)})}),document.body),refreshSummary:p}}({values:a,setValues:s,patientDisplayName:t,patientId:r}),m=function({setValues:a,patientDisplayName:s,patientId:t=""}){const[r,o]=i.useState(T),[c,d]=i.useState(!1),m=i.useCallback(async()=>{const e=await l();if(!e.hasSurgeryData())return T;const a=e.getValidationErrors?.()?.length??0,i=e.getDataSummary?.(),n=[];return i?.dataIntervento&&n.push(`Intervento: ${i.dataIntervento}`),i?.tipoIntervento&&n.push(`Tipo: ${i.tipoIntervento}`),i?.hasInfection&&n.push("Infezione associata"),{hasData:!0,isValid:0===a,tooltip:n.join("\n")}},[]),p=i.useCallback(async()=>{const e=await m();o(e)},[m]),u=i.useCallback(async e=>{const i=await l();i.setSurgeryData({data_evento:e.data_evento,tipo_intervento_id:e.tipo_intervento_id,descrizione:e.descrizione_intervento}),d(!1);const n=i.hasSurgeryData();a(e=>({...e,ha_intervento:n})),await p()},[a,p]),h=i.useCallback(async e=>{e?d(!0):((await l()).clearSurgeryData(),a(e=>({...e,ha_intervento:!1})),await p())},[a,p]),g=i.useCallback(async e=>{const{name:a,checked:i}=e.target;"ha_intervento"===a&&await h(i)},[h]),v=i.useCallback(()=>{d(!0)},[]);return{badge:r,renderBadge:i.useCallback(a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),handleCheckboxChange:g,handleEditSurgery:v,modalsPortal:n.createPortal(e.jsx(e.Fragment,{children:c&&e.jsx(L,{patientId:t,patientName:s||"Nuovo Paziente",onSubmit:u,onClose:()=>d(!1)})}),document.body),refreshSummary:p}}({values:a,setValues:s,patientDisplayName:t,patientId:r});i.useEffect(()=>{(async()=>{await d.refreshSummary(),await m.refreshSummary()})()},[d,m]),i.useEffect(()=>()=>{c().then(({infection:e,surgery:a})=>{e.clearInfectionData(),a.clearSurgeryData()})},[]);const p=i.useCallback(async e=>{const{name:a}=e.target;return"infetto"===a?(await d.handleCheckboxChange(e),void 0):"ha_intervento"===a?(await m.handleCheckboxChange(e),void 0):(s(i=>({...i,[a]:e.target.checked})),void 0)},[d,m,s]),u=i.useMemo(()=>a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),h=i.useMemo(()=>e.jsxs(e.Fragment,{children:[d.modalsPortal,m.modalsPortal]}),[d.modalsPortal,m.modalsPortal]);return{infectionBadge:d.badge,surgeryBadge:m.badge,renderBadge:u,handleCheckboxChange:p,handleEditInfection:d.handleEditInfection,handleEditSurgery:m.handleEditSurgery,modalsPortal:h}}const U=e=>{if(null==e||""===e)return"";if(e instanceof Date)return e.toISOString().split("T")[0];const a=String(e);if(a.match(/^\d{4}-\d{2}-\d{2}$/))return a;try{const e=function(e){if(!e)return null;if(e.match(/^\d{4}-\d{2}-\d{2}$/))return e;if(!e.includes("/"))throw new Error("Formato data non valido. Utilizzare il formato gg/mm/aaaa");const a=e.split("/");if(3!==a.length)throw new Error("Formato data non valido. Utilizzare il formato gg/mm/aaaa");const[i,n,s]=a,t=parseInt(i,10),r=parseInt(n,10),o=parseInt(s,10);if(isNaN(t)||isNaN(r)||isNaN(o))throw new Error("Formato data non valido. Utilizzare numeri validi");if(t<1||t>31)throw new Error("Giorno non valido (1-31)");if(r<1||r>12)throw new Error("Mese non valido (1-12)");if(o<1900||o>2100)throw new Error("Anno non valido");const l=new Date(o,r-1,t);if(l.getDate()!==t||l.getMonth()!==r-1||l.getFullYear()!==o)throw new Error("Data non valida (es. 31/02/2025)");return`${s}-${n.padStart(2,"0")}-${i.padStart(2,"0")}`}(a);if(e)return e}catch(i){const e=new Date(a);if(!Number.isNaN(e.getTime()))return e.toISOString().split("T")[0]}return a},q=["data_nascita","data_ricovero","data_dimissione"];function W({initialPatient:e}){const[a,n]=i.useState(()=>({nome:"",cognome:"",data_nascita:"",data_ricovero:"",data_dimissione:"",diagnosi:"",reparto_appartenenza:"",reparto_provenienza:"",livello_assistenza:"",codice_rad:"",note:"",tipo_dimissione:"",codice_dimissione:"",reparto_destinazione:"",clinica_destinazione:"",codice_clinica:"",infetto:!1,ha_intervento:!1}));i.useEffect(()=>{if(!e)return n({nome:"",cognome:"",data_nascita:"",data_ricovero:"",data_dimissione:"",diagnosi:"",reparto_appartenenza:"",reparto_provenienza:"",livello_assistenza:"",codice_rad:"",note:"",tipo_dimissione:"",codice_dimissione:"",reparto_destinazione:"",clinica_destinazione:"",codice_clinica:"",infetto:!1,ha_intervento:!1}),void 0;const a={id:e.id??null,nome:e.nome??"",cognome:e.cognome??"",data_nascita:U(e.data_nascita??""),data_ricovero:U(e.data_ricovero??""),data_dimissione:U(e.data_dimissione??""),diagnosi:e.diagnosi??"",reparto_appartenenza:e.reparto_appartenenza??"",reparto_provenienza:e.reparto_provenienza??"",livello_assistenza:e.livello_assistenza??"",codice_rad:e.codice_rad??"",note:e.note??"",tipo_dimissione:e.tipo_dimissione??"",codice_dimissione:e.codice_dimissione??"",reparto_destinazione:e.reparto_destinazione??"",clinica_destinazione:e.clinica_destinazione??"",codice_clinica:e.codice_clinica??"",infetto:e.infetto??!1,ha_intervento:!1};n(a)},[e]);const s=i.useCallback(e=>{const{name:a,value:i,type:s}=e.target,t="checkbox"===s?e.target.checked:i;n(e=>{if("string"==typeof t&&q.includes(a)){const i=U(t);return{...e,[a]:i}}return{...e,[a]:t}})},[]);return{values:a,setValues:n,handleChange:s}}function Q(){const[e,a]=i.useState([]),[n,s]=i.useState([]),[t,r]=i.useState(!1),[o,l]=i.useState(!1);return i.useEffect(()=>{void(async()=>{r(!0);try{const{data:e,error:i}=await u.from("diagnosi").select("id, nome").order("nome",{ascending:!0});if(i)h.error("Errore nel caricamento delle diagnosi",{error:i}),x("Impossibile caricare le diagnosi disponibili",{duration:5e3});else{const i=(e||[]).map(e=>({id:String(e.id),nome:e.nome}));a(i)}}catch(e){h.error("Errore imprevisto nel caricamento delle diagnosi",{error:e}),x("Errore nel caricamento delle diagnosi",{duration:5e3})}finally{r(!1)}})()},[]),i.useEffect(()=>{void(async()=>{l(!0);try{const e=await j();s(e)}catch(e){h.error("Errore nel caricamento dei reparti",{error:e}),x("Impossibile caricare i reparti disponibili",{duration:5e3})}finally{l(!1)}})()},[]),{diagnosiOptions:e,repartoOptions:n,loadingDiagnosi:t,loadingReparti:o}}function H({values:e,surgeryDataManager:a,infectionDataManager:i,isPatientCurrentlyInfected:n}){const s={nome:e.nome?.trim()||"",cognome:e.cognome?.trim()||"",data_nascita:e.data_nascita||"",data_ricovero:e.data_ricovero||"",data_dimissione:e.data_dimissione||null,diagnosi:e.diagnosi?.trim()||"",reparto_appartenenza:e.reparto_appartenenza?.trim()||"",reparto_provenienza:e.reparto_provenienza?.trim()||null,livello_assistenza:e.livello_assistenza?.trim()||null,codice_rad:e.codice_rad?.trim()||null,tipo_dimissione:e.tipo_dimissione||null,codice_dimissione:e.codice_dimissione?.trim()||null,reparto_destinazione:e.reparto_destinazione?.trim()||null,clinica_destinazione:e.clinica_destinazione?.trim()||null,codice_clinica:e.codice_clinica?.trim()||null,note:e.note?.trim()||null,infetto:e.infetto||!1,_hasInfectionData:!1,_hasSurgeryData:!1};if(i.hasInfectionData()){const e=i.getInfectionData();e&&(s._hasInfectionData=!0,s._infectionData=e)}if(a.hasSurgeryData()){const e=a.getSurgeryData();e&&(s._hasSurgeryData=!0,s._surgeryData=e)}return n&&n()&&(s.infetto=!0),s}const Y=({patient:a,mode:n,onSubmit:s,onCancel:t,onValidate:r})=>{const{values:o,setValues:l,handleChange:d}=W({initialPatient:a}),[m,p]=i.useState(!1),u=i.useRef(null),h=i.useMemo(()=>[o.nome?.trim(),o.cognome?.trim()].filter(Boolean).join(" ").trim(),[o.nome,o.cognome]),{diagnosiOptions:g,repartoOptions:v,loadingDiagnosi:x,loadingReparti:f}=Q(),{infectionBadge:b,surgeryBadge:j,renderBadge:N,handleCheckboxChange:w,handleEditInfection:z,handleEditSurgery:_,modalsPortal:y}=G({values:o,setValues:l,patientDisplayName:h,patientId:a?.id??""}),C=i.useCallback(async e=>{if(e.preventDefault(),!m){p(!0);try{const{infection:e,surgery:a}=await c(),i=H({values:o,infectionDataManager:e,surgeryDataManager:a});if(r){if(!r(i).valid)return p(!1),void 0}await s(i)}finally{p(!1)}}},[s,r,m,o]),S="create"===n?"Salva paziente":"Aggiorna paziente";return e.jsxs(e.Fragment,{children:[e.jsxs("form",{id:"patient-form",ref:u,onSubmit:C,className:"d-flex flex-column gap-3",noValidate:!0,children:[e.jsx(P,{values:o,onChange:d}),e.jsx(R,{values:o,onChange:d}),e.jsx(F,{values:o,onChange:d,diagnosiOptions:g,repartoOptions:v,loadingDiagnosi:x,loadingReparti:f}),e.jsx(B,{values:o,onChange:d}),e.jsx(M,{values:o,onCheckboxChange:w,onEditInfection:z,onEditSurgery:_,infectionBadge:b,surgeryBadge:j,renderBadge:N}),e.jsx($,{values:o,onChange:d}),e.jsx(V,{submitting:m,submitLabel:S,onCancel:t})]}),y]})},J=["personal-info","admission-dates","diagnosis","provenance","clinical-flags","notes","review"],K={"personal-info":"Dati Personali","admission-dates":"Date Ricovero",diagnosis:"Diagnosi",provenance:"Provenienza","clinical-flags":"Dati Clinici",notes:"Note",review:"Riepilogo"},X=["personal-info","admission-dates","diagnosis","provenance","clinical-flags","notes","review"],Z=({currentStep:a,totalSteps:i,getStepLabel:n,getStepNumber:s})=>{const t=X.indexOf(a),r=s(a);return e.jsxs("div",{className:"wizard-stepper",children:[e.jsx("div",{className:"wizard-stepper-progress",children:e.jsx("div",{className:"wizard-stepper-progress-bar",children:e.jsx("div",{className:"wizard-stepper-progress-fill",style:{width:r/i*100+"%"},role:"progressbar","aria-valuenow":r,"aria-valuemin":1,"aria-valuemax":i,"aria-label":`Progresso: ${r} di ${i}`})})}),e.jsxs("div",{className:"wizard-stepper-info",children:[e.jsx("span",{className:"wizard-stepper-label",children:n(a)}),e.jsxs("span",{className:"wizard-stepper-counter",children:[r," di ",i]})]}),e.jsx("div",{className:"wizard-stepper-dots d-md-none",children:X.map((i,s)=>e.jsx("div",{className:`wizard-stepper-dot ${i===a?"active":""} ${s<t?"completed":""}`,"aria-label":`Step ${s+1}: ${n(i)}`},i))})]})},ee=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Dati Personali"}),e.jsx("p",{className:"wizard-step-description",children:"Inserisci i dati anagrafici del paziente"}),e.jsx(P,{values:a,onChange:i})]})}),ae=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Date Importanti"}),e.jsx("p",{className:"wizard-step-description",children:"Inserisci la data di nascita e ricovero"}),e.jsx(R,{values:a,onChange:i})]})}),ie=({values:a,onChange:i,diagnosiOptions:n,repartoOptions:s,loadingDiagnosi:t,loadingReparti:r})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Diagnosi"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona la diagnosi e il reparto"}),e.jsx(F,{values:a,onChange:i,diagnosiOptions:n||[],repartoOptions:s||[],loadingDiagnosi:t??!1,loadingReparti:r??!1})]})}),ne=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Provenienza e Assistenza"}),e.jsx("p",{className:"wizard-step-description",children:"Informazioni sulla provenienza del paziente (opzionale)"}),e.jsx(B,{values:a,onChange:i})]})}),se=({values:a,onCheckboxChange:i,onEditInfection:n,onEditSurgery:s,infectionBadge:t,surgeryBadge:r,renderBadge:o})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Dati Clinici"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona i flag clinici del paziente"}),e.jsx(M,{values:a,onCheckboxChange:i??(async()=>{}),onEditInfection:n??(async()=>{}),onEditSurgery:s??(async()=>{}),infectionBadge:t,surgeryBadge:r,renderBadge:o})]})}),te=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Note Aggiuntive"}),e.jsx("p",{className:"wizard-step-description",children:"Aggiungi eventuali note (opzionale)"}),e.jsx($,{values:a,onChange:i})]})}),re=({values:a})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Riepilogo"}),e.jsx("p",{className:"wizard-step-description",children:"Verifica i dati inseriti prima di confermare"}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Dati Personali"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Nome:"}),e.jsx("span",{className:"review-value",children:a.nome})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Cognome:"}),e.jsx("span",{className:"review-value",children:a.cognome})]})]})]}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Date"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Data Nascita:"}),e.jsx("span",{className:"review-value",children:a.data_nascita})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Data Ricovero:"}),e.jsx("span",{className:"review-value",children:a.data_ricovero})]})]})]}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Clinico"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Diagnosi:"}),e.jsx("span",{className:"review-value",children:a.diagnosi||"Non specificato"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Reparto:"}),e.jsx("span",{className:"review-value",children:a.reparto_appartenenza||"Non specificato"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Paziente Infetto:"}),e.jsx("span",{className:"review-value",children:a.infetto?"Sì":"No"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Intervento Chirurgico:"}),e.jsx("span",{className:"review-value",children:a.ha_intervento?"Sì":"No"})]})]})]}),a.note&&e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Note"}),e.jsx("p",{className:"review-notes",children:a.note})]})]})}),oe=({patient:a,mode:n,onSubmit:s,onCancel:t,onValidate:r})=>{const{values:o,setValues:l,handleChange:d}=W({initialPatient:a}),[m,p]=i.useState(!1),u=i.useRef(null),h=((e="personal-info")=>N({steps:J,labels:K,initialStep:e}))("personal-info"),g=w({currentStep:h.currentStep,getStepLabel:h.getStepLabel,totalSteps:h.totalSteps,currentStepNumber:h.getStepNumber(h.currentStep)});z();const v=i.useMemo(()=>[o.nome?.trim(),o.cognome?.trim()].filter(Boolean).join(" ").trim(),[o.nome,o.cognome]),{diagnosiOptions:x,repartoOptions:f,loadingDiagnosi:b,loadingReparti:j}=Q(),{infectionBadge:_,surgeryBadge:y,renderBadge:C,handleCheckboxChange:S,handleEditInfection:D,handleEditSurgery:I,modalsPortal:k}=G({values:o,setValues:l,patientDisplayName:v,patientId:a?.id??""}),E=i.useCallback(async e=>{if(e.preventDefault(),!m){p(!0);try{const{infection:e,surgery:a}=await c(),i=H({values:o,infectionDataManager:e,surgeryDataManager:a});if(r){if(!r(i).valid)return p(!1),void 0}await s(i)}finally{p(!1)}}},[s,r,m,o]),P="create"===n?"Salva paziente":"Aggiorna paziente",R=i.useCallback(()=>{switch(h.currentStep){case"personal-info":return!!o.nome?.trim()&&!!o.cognome?.trim();case"admission-dates":return!!o.data_nascita&&!!o.data_ricovero;case"diagnosis":return!!o.diagnosi&&!!o.reparto_appartenenza;case"provenance":case"clinical-flags":case"notes":case"review":return!0;default:return!1}},[h.currentStep,o.nome,o.cognome,o.data_nascita,o.data_ricovero,o.diagnosi,o.reparto_appartenenza]);return e.jsxs(e.Fragment,{children:[e.jsxs("form",{id:"patient-form-wizard",ref:u,onSubmit:E,className:"wizard-form",noValidate:!0,children:[e.jsxs("div",{className:"wizard-form-header",children:[e.jsx("button",{type:"button",className:"wizard-back-button",onClick:t,"aria-label":"Torna alla lista pazienti",children:e.jsx("i",{className:"bi bi-arrow-left"})}),e.jsx("h1",{className:"wizard-form-title",children:"Inserimento Nuovo Paziente"})]}),e.jsx(Z,{currentStep:h.currentStep,totalSteps:h.totalSteps,getStepLabel:h.getStepLabel,getStepNumber:h.getStepNumber}),e.jsx("div",{ref:g,className:"wizard-form-content",children:(()=>{const a={values:o,onChange:d,diagnosiOptions:x,repartoOptions:f,loadingDiagnosi:b,loadingReparti:j,onCheckboxChange:S,onEditInfection:D,onEditSurgery:I,infectionBadge:_,surgeryBadge:y,renderBadge:C};switch(h.currentStep){case"personal-info":return e.jsx(ee,{...a});case"admission-dates":return e.jsx(ae,{...a});case"diagnosis":return e.jsx(ie,{...a});case"provenance":return e.jsx(ne,{...a});case"clinical-flags":return e.jsx(se,{...a});case"notes":return e.jsx(te,{...a});case"review":return e.jsx(re,{values:o});default:return null}})()}),e.jsxs("div",{className:"wizard-form-actions",children:[e.jsxs("button",{type:"button",className:"btn btn-secondary btn-block",onClick:h.prevStep,disabled:!h.canGoPrev,children:[e.jsx("i",{className:"bi bi-chevron-left"}),"Indietro"]}),"review"!==h.currentStep?e.jsxs("button",{type:"button",className:"btn btn-primary btn-block",onClick:h.nextStep,disabled:!h.canGoNext||!R(),title:R()?void 0:"Completa i campi obbligatori per continuare",children:["Avanti",e.jsx("i",{className:"bi bi-chevron-right"})]}):e.jsx(e.Fragment,{children:e.jsx("button",{type:"submit",className:"btn btn-success btn-block",disabled:m,children:e.jsxs(e.Fragment,m?{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio in corso..."]}:{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),P]})})})]})]}),k]})};const le=()=>{const a=function(){const e=t();return i.useCallback(a=>{if(e)return e(a),void 0;const i=a.startsWith("/")?a.slice(1):a;window.location.hash=i||"home"},[e])}(),[n]=s(),r=n.get("id"),[o,l]=i.useState("create"),[c,m]=i.useState(void 0),[p,u]=i.useState(!1);i.useEffect(()=>{void(async()=>{const e=sessionStorage.getItem("editPazienteId"),a=r??e;if(!a)return l("create"),m(void 0),void 0;u(!0);try{const e=await d.getPatientById(a);e?(m(e),l("edit")):(h.warn("Patient not found",{id:a}),b("Paziente non trovato"))}catch(i){h.error("Error loading patient for edit",i),x("Errore nel caricamento del paziente")}finally{u(!1),!r&&e&&sessionStorage.removeItem("editPazienteId")}})()},[r]);const g=i.useCallback(async e=>{try{"edit"===o&&c?.id?(h.info("Updating existing patient",{id:c.id,data:e}),await d.updatePatient(c.id,e),f("Paziente aggiornato con successo")):(h.info("Creating new patient",{data:e}),await d.createPatient(e),f("Paziente creato con successo")),a("/list")}catch(i){throw h.error("Error submitting patient form",i),i}},[a,o,c?.id]),v=i.useCallback(async e=>{if(c?.id)try{h.info("Registering patient discharge",{patientId:c.id,data:e}),await d.dischargePatientWithTransfer(c.id,e),f("Dimissione registrata con successo")}catch(a){throw h.error("Error registering patient discharge",a),x("Errore nella registrazione della dimissione"),a}},[c?.id]),j=i.useCallback(()=>{a("/list")},[a]),N=i.useMemo(()=>"undefined"!=typeof window&&window.innerWidth<992,[]);return e.jsxs("div",{className:"patient-form-page-container",children:[N&&e.jsx(e.Fragment,{children:p?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("div",{className:"spinner-border mb-3",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"text-muted",children:"Caricamento dati paziente in corso..."})]}):e.jsx(oe,{patient:c,mode:o,onSubmit:g,onCancel:j})}),!N&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"patient-form-hero",children:e.jsx("div",{className:"patient-form-hero-content",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"patient-form-title",children:p?"Caricamento...":"edit"===o?"Modifica Paziente":"Inserimento Nuovo Paziente"}),e.jsx("p",{className:"patient-form-subtitle",children:p?"Attendere il caricamento dei dati...":"edit"===o?`Modifica i dati di ${c?.nome} ${c?.cognome}`:"Compila il form per aggiungere un nuovo paziente al sistema"})]}),e.jsxs("button",{type:"button",className:"patient-form-back-button",onClick:j,disabled:p,"aria-label":"Torna alla lista",children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"arrow_back"}),e.jsx("span",{className:"back-button-text",children:"Torna alla lista"})]})]})})}),e.jsx("div",{className:"row",children:e.jsxs("div",{className:"col-12 col-lg-10 col-xl-8 mx-auto",children:[e.jsxs("div",{className:"patient-form-card",children:[e.jsx("div",{className:"patient-form-card-header",children:e.jsxs("div",{className:"patient-form-card-title-wrapper",children:[e.jsx("div",{className:"patient-form-card-icon",children:e.jsx("span",{className:"material-icons",children:"edit"===o?"edit":"person_add"})}),e.jsxs("h2",{className:"patient-form-card-title",style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"1rem"},children:[e.jsx("span",{children:"Modifica Dati Paziente"}),"edit"===o&&c&&e.jsxs("span",{style:{fontSize:"1.3rem",fontWeight:"700",color:"#0d6efd"},children:[c.nome," ",c.cognome]})]})]})}),e.jsxs("div",{className:"patient-form-card-body",children:[p?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("div",{className:"spinner-border mb-3",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"text-muted",children:"Caricamento dati paziente in corso..."})]}):e.jsx(Y,{patient:c,mode:o,onSubmit:g,onCancel:j}),!p&&"edit"===o&&c&&e.jsx(I,{patientId:c.id,patientName:`${c.nome} ${c.cognome}`,onDischargeSubmit:v})]})]}),e.jsx("div",{className:"patient-form-help-card card",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"patient-form-help-header",children:[e.jsx("div",{className:"help-icon",children:e.jsx("span",{className:"material-icons",children:"info"})}),e.jsx("h3",{className:"help-title",children:"Informazioni"})]}),e.jsxs("ul",{className:"patient-form-help-list",children:[e.jsx("li",{children:"I campi contrassegnati sono obbligatori"}),e.jsx("li",{children:"La data di ricovero non può essere futura"}),e.jsx("li",{children:"Il codice RAD deve essere univoco se specificato"}),e.jsx("li",{children:"I dati possono essere modificati successivamente dalla pagina di dettaglio"})]})]})})]})})]})]})};export{le as PatientFormPage,le as default};
