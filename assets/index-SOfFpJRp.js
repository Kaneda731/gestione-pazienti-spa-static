import{j as e}from"./ui-vendor-S6RcKJ66.js";import{R as i,u as t,b as a}from"./react-vendor-Bp2pLdQf.js";import{u as s,a as n,s as r,b as o,l as c,c as l}from"./index-DueKZyms.js";import{p as d}from"./patientService-BPYYDGXe.js";import"./supabase-Zkii_ZbW.js";import"./CentralizedStatisticsService-CBpCaSti.js";const m=i.memo(({icon:i,title:t,description:a,meta:s,variant:n,onClick:r,showAdminBadge:o=!1})=>e.jsx("div",{className:`home-card card-${n}`,onClick:r,role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),r())},"aria-label":`Vai a ${t}`,children:e.jsxs("div",{className:"home-card-body",children:[e.jsx("div",{className:"home-card-icon",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:i})}),e.jsxs("h5",{className:"home-card-title",children:[t,o&&e.jsx("span",{className:"badge-admin","aria-label":"Solo amministratori",children:"Admin"})]}),e.jsx("p",{className:"home-card-text",children:a}),e.jsx("p",{className:"home-card-meta",children:s})]})}));m.displayName="HomeCard";const h=({stats:i,isAdmin:a})=>{const s=t();return e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"home-section","aria-labelledby":"quick-actions-section",children:[e.jsxs("h2",{className:"section-title",id:"quick-actions-section",children:[e.jsx("span",{className:"section-icon","aria-hidden":"true",children:"âš¡"}),"Azioni Rapide"]}),e.jsxs("div",{className:"home-cards-grid",children:[e.jsx(m,{icon:"person_add",title:"Inserimento Pazienti",description:"Registra un nuovo paziente nel sistema",meta:`Pazienti recenti: ${i.patientsThisWeek} questa settimana`,variant:"action-primary",onClick:()=>s("/inserimento")}),e.jsx(m,{icon:"medical_services",title:"Evento Clinico",description:"Registra un nuovo evento clinico",meta:`Ultimi 7 giorni: ${i.eventsLastDays} eventi`,variant:"action-secondary",onClick:()=>s("/eventi-clinici")}),e.jsx(m,{icon:"logout",title:"Dimissioni",description:"Processa le dimissioni pazienti",meta:`In sospeso: ${i.pendingDismissals}`,variant:"action-tertiary",onClick:()=>s("/dimissione")})]})]}),e.jsxs("section",{className:"home-section","aria-labelledby":"support-section",children:[e.jsxs("h2",{className:"section-title",id:"support-section",children:[e.jsx("span",{className:"section-icon","aria-hidden":"true",children:"ðŸ“Š"}),"Consultazione"]}),e.jsxs("div",{className:"home-cards-grid",children:[e.jsx(m,{icon:"list",title:"Elenco Pazienti",description:"Visualizza e ricerca pazienti ricoverati",meta:`Pazienti attuali: ${i.totalActivePatients}`,variant:"support-primary",onClick:()=>s("/list")}),e.jsx(m,{icon:"query_stats",title:"Grafici & Analisi",description:"Visualizza trend e statistiche cliniche",meta:"Analisi dati e trend",variant:"support-secondary",onClick:()=>s("/unified-charts")})]})]}),a&&e.jsxs("section",{className:"home-section","aria-labelledby":"admin-section",children:[e.jsxs("h2",{className:"section-title",id:"admin-section",children:[e.jsx("span",{className:"section-icon","aria-hidden":"true",children:"âš™ï¸"}),"Amministrazione"]}),e.jsx("div",{className:"home-cards-grid",children:e.jsx(m,{icon:"medical_information",title:"Gestione Diagnosi",description:"Configura le diagnosi disponibili",meta:"Configurazione sistema",variant:"admin",onClick:()=>s("/diagnosi"),showAdminBadge:!0})})]})]})};function p(e){return`${e.cognome} ${e.nome}`.trim()}function u(e){return e.codice_rad||e.id?.slice(0,6)||"N/A"}function x(e){if(!e)return"Data non disponibile";try{const i=new Date(e+"T00:00:00");if(isNaN(i.getTime()))return e;const t=new Date,a=new Date(t);a.setDate(a.getDate()-1);const s=i.toDateString()===t.toDateString(),n=i.toDateString()===a.toDateString(),r=i.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"}),o=i.toLocaleDateString("it-IT",{month:"2-digit",day:"2-digit"});return s?`Oggi ${r}`:n?`Ieri ${r}`:o}catch{return e}}function g(){const e=new Date,i=e.getMinutes(),t=e.getHours();return 0===i?"Adesso":1===i?"1 min fa":i<5?`${i} min fa`:i<60?5*Math.floor(i/5)+" min fa":1===t?"1 ora fa":`${t} ore fa`}const f=()=>{const{user:i,isAuthenticated:l}=s(),[d,m]=n(),[h,p]=a.useState(d),[u,x]=a.useState(!1),g=a.useRef(null),f=t();if(a.useEffect(()=>{const e=e=>{g.current&&!g.current.contains(e.target)&&x(!1)};if(u)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[u]),!l||!i)return null;const v=i.ruolo??i.role??"caricamento...",j=i.email?.split("@")[0]||"User",y=j.charAt(0).toUpperCase(),b=e=>({admin:"#6366f1",medico:"#0891b2",infermiere:"#059669",operatore:"#ea580c",lettore:"#8b5cf6"}[e.toLowerCase()]||"#64748b"),N="dark"===h?"light_mode":"dark_mode",k="dark"===h?"Tema chiaro":"Tema scuro";return e.jsxs("div",{ref:g,className:"user-avatar-menu",style:{position:"relative"},children:[e.jsx("button",{className:"user-avatar-button",onClick:()=>x(!u),"aria-label":"Menu utente",style:{width:"48px",height:"48px",borderRadius:"50%",border:"none",background:`linear-gradient(135deg, ${b(v)}, ${b(v)}dd)`,color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"18px",fontWeight:"bold",cursor:"pointer",transition:"all 0.3s ease",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)"},onMouseEnter:e=>{e.currentTarget.style.transform="scale(1.05)",e.currentTarget.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.25)"},onMouseLeave:e=>{e.currentTarget.style.transform="scale(1)",e.currentTarget.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.15)"},children:y}),u&&e.jsxs("div",{className:"user-avatar-dropdown",style:{position:"absolute",top:"56px",right:"0",background:"#fff",borderRadius:"8px",boxShadow:"0 8px 24px rgba(0, 0, 0, 0.12)",minWidth:"280px",zIndex:1e3,overflow:"hidden",animation:"fadeIn 0.2s ease-out"},children:[e.jsxs("div",{style:{background:`linear-gradient(135deg, ${b(v)}, ${b(v)}dd)`,color:"#fff",padding:"16px",display:"flex",alignItems:"center",gap:"12px"},children:[e.jsx("div",{style:{width:"40px",height:"40px",borderRadius:"50%",background:"rgba(255, 255, 255, 0.2)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"20px",fontWeight:"bold"},children:y}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontWeight:"600",fontSize:"14px"},children:j}),e.jsx("div",{style:{fontSize:"12px",opacity:.9},children:i.email}),e.jsx("div",{style:{display:"inline-block",marginTop:"4px",fontSize:"10px",fontWeight:"600",background:"rgba(255, 255, 255, 0.25)",padding:"2px 8px",borderRadius:"4px",textTransform:"uppercase"},children:v})]})]}),e.jsxs("div",{style:{padding:"8px 0"},children:[e.jsxs("button",{onClick:()=>{const e="dark"===h?"light":"dark";m(e),r(e),p(e)},style:{width:"100%",border:"none",background:"none",padding:"12px 16px",textAlign:"left",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",color:"#1f2937",fontSize:"14px",transition:"background-color 0.2s ease"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#f3f4f6"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},title:k,children:[e.jsx("span",{className:"material-icons",style:{fontSize:"20px"},children:N}),e.jsx("span",{children:k})]}),e.jsx("div",{style:{height:"1px",background:"#e5e7eb",margin:"4px 0"}}),e.jsxs("button",{onClick:async()=>{try{await o(),f("/login")}catch(e){c.error("Logout failed",e)}},style:{width:"100%",border:"none",background:"none",padding:"12px 16px",textAlign:"left",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",color:"#ef4444",fontSize:"14px",fontWeight:"500",transition:"background-color 0.2s ease"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#fee2e2"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},children:[e.jsx("span",{className:"material-icons",style:{fontSize:"20px"},children:"logout"}),e.jsx("span",{children:"Esci"})]})]})]}),e.jsx("style",{children:"\n        @keyframes fadeIn {\n          from {\n            opacity: 0;\n            transform: translateY(-8px);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0);\n          }\n        }\n      "})]})},v=({title:i,icon:t,patients:a,isLoading:s,dateField:n})=>e.jsxs("div",s?{className:"hero-recent-section",children:[e.jsxs("h2",{className:"hero-section-title",children:[t," ",i]}),e.jsx("div",{className:"hero-recent-list",children:e.jsx("div",{className:"hero-recent-item",style:{opacity:.6},children:e.jsx("div",{className:"hero-recent-name",children:"Caricamento..."})})})]}:0===a.length?{className:"hero-recent-section",children:[e.jsxs("h2",{className:"hero-section-title",children:[t," ",i]}),e.jsx("div",{className:"hero-recent-list",children:e.jsx("div",{className:"hero-recent-item",style:{opacity:.5},children:e.jsx("div",{className:"hero-recent-name",children:"Nessun paziente"})})})]}:{className:"hero-recent-section",children:[e.jsxs("h2",{className:"hero-section-title",children:[t," ",i]}),e.jsx("div",{className:"hero-recent-list",children:a.map(i=>e.jsxs("div",{className:"hero-recent-item",children:[e.jsx("div",{className:"hero-recent-name",children:p(i)}),e.jsxs("div",{className:"hero-recent-meta",children:["ID: ",u(i)," â€¢ ",x(i[n])]})]},i.id))})]}),j=({recentPatients:i,recentDismissals:a,isLoading:s,lastUpdate:n})=>{const r=t();return e.jsxs("div",{className:"home-hero",style:{position:"relative"},children:[e.jsx("div",{style:{position:"absolute",top:"20px",right:"20px",zIndex:100},children:e.jsx(f,{})}),e.jsxs("div",{className:"home-hero-content",children:[e.jsxs("h1",{className:"home-title",style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1.5rem"},children:[e.jsx("img",{src:"/favicon.png",alt:"PATIENTRAK Logo",width:"144",height:"144"}),"PATIENTRAK"]}),e.jsxs("div",{className:"hero-cta-group",children:[e.jsxs("button",{className:"hero-cta hero-cta-primary",onClick:()=>r("/inserimento"),"aria-label":"Registra nuovo paziente",children:[e.jsx("span",{className:"material-icons",children:"person_add"}),"Registra Nuovo Paziente"]}),e.jsxs("button",{className:"hero-cta hero-cta-secondary",onClick:()=>r("/eventi-clinici"),"aria-label":"Registra evento clinico",children:[e.jsx("span",{className:"material-icons",children:"add_circle"}),"Evento Clinico"]})]}),e.jsx("div",{className:"hero-divider"}),e.jsx(v,{title:"Ultimi Registrati",icon:"ðŸ“¥",patients:i,isLoading:s,dateField:"data_ricovero"}),e.jsx("div",{className:"hero-divider"}),e.jsx(v,{title:"Ultimi Dimessi",icon:"ðŸ“¤",patients:a,isLoading:s,dateField:"data_dimissione"}),e.jsxs("div",{className:"hero-footer",children:[e.jsx("span",{className:"material-icons",children:"schedule"}),"Ultimo aggiornamento: ",n]})]})]})},y={patientsThisWeek:0,eventsLastDays:0,pendingDismissals:0,totalActivePatients:0};async function b(){return(await d.getPatients({stato:"attivo"},{limit:3,sortColumn:"data_ricovero",sortDirection:"desc",page:0})).patients.map(e=>({id:e.id||"",nome:e.nome||"",cognome:e.cognome||"",codice_rad:e.codice_rad,data_ricovero:e.data_ricovero,data_dimissione:e.data_dimissione}))}async function N(){return(await d.getPatients({stato:"dimesso"},{limit:2,sortColumn:"data_ricovero",sortDirection:"desc",page:0})).patients.map(e=>({id:e.id||"",nome:e.nome||"",cognome:e.cognome||"",codice_rad:e.codice_rad,data_ricovero:e.data_ricovero,data_dimissione:e.data_dimissione}))}function k(){const{user:e}=s(),[i,t]=a.useState([]),[n,r]=a.useState([]),[o,m]=a.useState(y),[h,p]=a.useState("Caricamento..."),[u,x]=a.useState(!0);return a.useEffect(()=>{if(!e)return;(async()=>{try{x(!0);const[i,a]=await Promise.all([b(),N()]);t(i),r(a);try{const e=await d.getPatients({stato:"attivo"},{limit:1,page:0}),i=await async function(e){const i=new Date;i.setDate(i.getDate()-7);const t=i.toISOString().split("T")[0],[a,s,n]=await Promise.all([l.from("pazienti").select("id",{count:"exact"}).gte("data_ricovero",t).is("data_dimissione",null),l.from("eventi_clinici").select("id",{count:"exact"}).gte("data_evento",t),l.from("pazienti").select("id",{count:"exact"}).not("data_dimissione","is",null).is("codice_dimissione",null)]);return{patientsThisWeek:a.error?0:a.data?.length||0,eventsLastDays:s.error?0:s.data?.length||0,pendingDismissals:n.error?0:n.data?.length||0,totalActivePatients:e}}(e.totalCount);m(i)}catch(e){c.warn("Errore caricamento statistiche:",e)}p(g())}catch(i){c.error("Errore caricamento dati home:",i),p("Errore caricamento"),t([]),r([])}finally{x(!1)}})();const i=setInterval(()=>{p(g())},6e4);return()=>clearInterval(i)},[e]),{recentPatients:i,recentDismissals:n,stats:o,lastUpdate:h,isLoading:u}}const C=()=>{const{user:i}=s(),{recentPatients:t,recentDismissals:n,stats:r,lastUpdate:o,isLoading:c}=k(),l="admin"===a.useMemo(()=>i?i.ruolo??i.role??null:null,[i]);return e.jsxs("div",{className:"home-page-container",children:[e.jsx(j,{recentPatients:t,recentDismissals:n,isLoading:c,lastUpdate:o}),e.jsx(h,{stats:r,isAdmin:l})]})};export{m as HomeCard,h as HomeCardsGrid,j as HomeHero,C as HomePage,C as default,x as formatDateTime,g as formatLastUpdate,u as formatPatientId,p as formatPatientName,k as useHomeData};
