class t{constructor(t={}){this.options={storageKey:"notification-data",settingsKey:"notification-settings",statsKey:"notification-stats",maxStoredNotifications:50,retentionDays:7,enableStats:!0,...t},this.storage=this.getStorageEngine(),this.isAvailable=!!this.storage,this.isAvailable&&this.init()}init(){this.cleanupOldNotifications(),this.options.enableStats&&this.initializeStats()}getStorageEngine(){try{if("undefined"!=typeof localStorage)return localStorage.setItem("test","test"),localStorage.removeItem("test"),localStorage}catch(t){console.warn("localStorage non disponibile:",t)}try{if("undefined"!=typeof sessionStorage)return sessionStorage.setItem("test","test"),sessionStorage.removeItem("test"),sessionStorage}catch(t){console.warn("sessionStorage non disponibile:",t)}return console.warn("Storage non disponibile, usando memoria temporanea"),new Map}saveNotification(t){if(!this.isAvailable||!t.persistent)return!1;try{const e=this.getStoredNotifications(),s={...t,savedAt:(new Date).toISOString(),id:t.id||this.generateId()};return e.unshift(s),e.length>this.options.maxStoredNotifications&&e.splice(this.options.maxStoredNotifications),this.setItem(this.options.storageKey,JSON.stringify(e)),this.options.enableStats&&this.updateStats("saved",t.type),!0}catch(e){return console.error("Errore salvataggio notifica:",e),!1}}getStoredNotifications(){try{const t=this.getItem(this.options.storageKey);return t?JSON.parse(t):[]}catch(t){return console.error("Errore recupero notifiche salvate:",t),[]}}removeStoredNotification(t){if(!this.isAvailable)return!1;try{const e=this.getStoredNotifications(),s=e.filter(e=>e.id!==t);return s.length!==e.length&&(this.setItem(this.options.storageKey,JSON.stringify(s)),!0)}catch(e){return console.error("Errore rimozione notifica salvata:",e),!1}}clearStoredNotifications(){if(!this.isAvailable)return!1;try{return this.removeItem(this.options.storageKey),!0}catch(t){return console.error("Errore pulizia notifiche salvate:",t),!1}}saveSettings(t){if(!this.isAvailable)return!1;try{const e={...this.getSettings(),...t,updatedAt:(new Date).toISOString()};return this.setItem(this.options.settingsKey,JSON.stringify(e)),!0}catch(e){return console.error("Errore salvataggio impostazioni:",e),!1}}getSettings(){try{const t=this.getItem(this.options.settingsKey);return t?JSON.parse(t):this.getDefaultSettings()}catch(t){return console.error("Errore recupero impostazioni:",t),this.getDefaultSettings()}}getDefaultSettings(){return{position:"top-right",maxVisible:5,enableSounds:!0,soundVolume:.5,enableAnimations:!0,autoClose:{success:4e3,info:5e3,warning:6e3,error:0},theme:"auto",createdAt:(new Date).toISOString()}}resetSettings(){if(!this.isAvailable)return!1;try{return this.removeItem(this.options.settingsKey),!0}catch(t){return console.error("Errore reset impostazioni:",t),!1}}initializeStats(){const t=this.getStats();t.createdAt||this.saveStats({...t,createdAt:(new Date).toISOString()})}updateStats(t,e=null){if(this.options.enableStats&&this.isAvailable)try{const s=this.getStats(),i=(new Date).toISOString().split("T")[0];s.daily||(s.daily={}),s.daily[i]||(s.daily[i]={}),s.total||(s.total={}),s.byType||(s.byType={}),s.daily[i][t]=(s.daily[i][t]||0)+1,s.total[t]=(s.total[t]||0)+1,e&&(s.byType[e]||(s.byType[e]={}),s.byType[e][t]=(s.byType[e][t]||0)+1),s.lastUpdated=(new Date).toISOString(),this.saveStats(s)}catch(s){console.error("Errore aggiornamento statistiche:",s)}}getStats(){try{const t=this.getItem(this.options.statsKey);return t?JSON.parse(t):{}}catch(t){return console.error("Errore recupero statistiche:",t),{}}}saveStats(t){if(!this.isAvailable)return!1;try{return this.setItem(this.options.statsKey,JSON.stringify(t)),!0}catch(e){return console.error("Errore salvataggio statistiche:",e),!1}}getStatsReport(){const t=this.getStats(),e={totalNotifications:t.total?.shown||0,totalSaved:t.total?.saved||0,totalDismissed:t.total?.dismissed||0,byType:t.byType||{},dailyAverage:0,createdAt:t.createdAt,lastUpdated:t.lastUpdated};if(t.daily&&Object.keys(t.daily).length>0){const s=Object.keys(t.daily).length,i=Object.values(t.daily).reduce((t,e)=>t+(e.shown||0),0);e.dailyAverage=Math.round(i/s)}return e}cleanupOldNotifications(){if(this.isAvailable)try{const t=this.getStoredNotifications(),e=new Date;e.setDate(e.getDate()-this.options.retentionDays);const s=t.filter(t=>new Date(t.savedAt)>e);s.length!==t.length&&this.setItem(this.options.storageKey,JSON.stringify(s))}catch(t){console.error("Errore pulizia notifiche vecchie:",t)}}cleanupOldStats(){if(this.isAvailable&&this.options.enableStats)try{const t=this.getStats();if(!t.daily)return;const e=new Date;e.setDate(e.getDate()-30);const s=e.toISOString().split("T")[0],i={};Object.keys(t.daily).forEach(e=>{e>=s&&(i[e]=t.daily[e])}),t.daily=i,this.saveStats(t)}catch(t){console.error("Errore pulizia statistiche vecchie:",t)}}exportData(){if(!this.isAvailable)return null;try{return{notifications:this.getStoredNotifications(),settings:this.getSettings(),stats:this.getStats(),exportedAt:(new Date).toISOString(),version:"1.0"}}catch(t){return console.error("Errore export dati:",t),null}}importData(t){if(!this.isAvailable||!t)return!1;try{return t.notifications&&this.setItem(this.options.storageKey,JSON.stringify(t.notifications)),t.settings&&this.setItem(this.options.settingsKey,JSON.stringify(t.settings)),t.stats&&this.options.enableStats&&this.setItem(this.options.statsKey,JSON.stringify(t.stats)),!0}catch(e){return console.error("Errore import dati:",e),!1}}setItem(t,e){this.storage instanceof Map?this.storage.set(t,e):this.storage.setItem(t,e)}getItem(t){return this.storage instanceof Map?this.storage.get(t):this.storage.getItem(t)}removeItem(t){this.storage instanceof Map?this.storage.delete(t):this.storage.removeItem(t)}generateId(){return`notification-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getStorageInfo(){if(!this.isAvailable)return{available:!1};try{const t=this.getStoredNotifications(),e=this.getSettings(),s=this.getStats();return{available:!0,storageType:this.storage instanceof Map?"memory":"localStorage",notificationsCount:t.length,hasSettings:Object.keys(e).length>0,hasStats:Object.keys(s).length>0,lastCleanup:(new Date).toISOString()}}catch(t){return{available:!1,error:t.message}}}destroy(){this.storage=null,this.isAvailable=!1}}let e=null;const s=()=>(e||(e=new t),e);export{t as NotificationPersistence,t as default,s as getPersistenceManager};
