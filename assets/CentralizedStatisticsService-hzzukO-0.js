import{s as t,l as e}from"./index-ChYFFTDP.js";const i=t=>{if(!t)return"";if("string"==typeof t&&/^\d{4}-\d{2}-\d{2}/.test(t))return t.split("T")[0];try{const e="string"==typeof t?new Date(t):t;if(isNaN(e.getTime()))return"";const i=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0");return`${i}-${r}-${String(e.getDate()).padStart(2,"0")}`}catch{return""}},r=(t,e="it-IT",i={})=>{if(!t)return"-";let r=t;if("string"==typeof r){const t=r.trim();if(0===t.length)return"-";let e=t.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})$/);if(e){const[,t,i,n]=e,s=String(t).padStart(2,"0");r=`${n}-${String(i).padStart(2,"0")}-${s}`}else if(e=t.match(/^(\d{4})[/-](\d{1,2})[/-](\d{1,2})(?:[ T](\d{2}:\d{2}:\d{2}))?$/),e){const[,t,i,n,s]=e,a=String(n).padStart(2,"0");r=`${t}-${String(i).padStart(2,"0")}-${a}${s?"T"+s:""}`}else r=t.includes(" ")&&!t.includes("T")?t.replace(" ","T"):t}const n=r instanceof Date?r:new Date(r);return Number.isNaN(n.getTime())?"-":n.toLocaleDateString(e,i)};function n(t){if(!t)return"";const e=t.match(/^(\d{4})-(\d{2})-(\d{2})/);if(!e)return"";const[,i,r,n]=e;return`${n}/${r}/${i}`}const s=()=>{const t=new Date;return t.setHours(0,0,0,0),t},a=t=>{if(!t)return!1;try{const[e,i,r]=t.split("-");if(!e||!i||!r)return!1;const n=parseInt(e),s=parseInt(i),a=parseInt(r);if(s<1||s>12)return!1;if(a<1||a>31)return!1;const c=new Date(n,s-1,a);return c.getFullYear()===n&&c.getMonth()===s-1&&c.getDate()===a}catch{return!1}},c=t=>{if(null==t||""===t)return;if(t instanceof Date){if(Number.isNaN(t.getTime()))return;return t.toISOString().split("T")[0]}const e=String(t).trim();if(!e)return;if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const i=e.match(/^(\d{2})[\/-](\d{2})[\/-](\d{4})$/);if(i){const[,t,e,r]=i;return o(r,e,t)}const r=e.match(/^(\d{2})[\/-](\d{2})[\/-](\d{2})$/);if(r){const[,t,e,i]=r,n=function(t){if(Number.isNaN(t))return(new Date).getFullYear();return t>=70?1900+t:2e3+t}(Number.parseInt(i,10));return o(n.toString(),e,t)}const n=new Date(e);return Number.isNaN(n.getTime())?void 0:n.toISOString().split("T")[0]};function o(t,e,i){return`${t.padStart(4,"0")}-${e.padStart(2,"0")}-${i.padStart(2,"0")}`}class l{supabaseClient;query;constructor(t){this.supabaseClient=t}select(t="*"){return this.query=this.supabaseClient.from("eventi_clinici").select(t),this}count(){return this.query=this.supabaseClient.from("eventi_clinici").select("id",{count:"exact",head:!0}),this}byTipo(t){if(!this.query)throw new Error("Query not initialized. Call select() or count() first.");return this.query=this.query.eq("tipo_evento",t),this}byDateRange(t,e){if(!this.query)throw new Error("Query not initialized. Call select() or count() first.");return t&&(this.query=this.query.gte("data_evento",t)),e&&(this.query=this.query.lte("data_evento",e)),this}fromLastDays(t){const e=new Date;e.setDate(e.getDate()-t);const i=e.toISOString().split("T")[0];return this.byDateRange(i)}fromLastMonth(){return this.fromLastDays(30)}byPaziente(t){if(!this.query)throw new Error("Query not initialized. Call select() or count() first.");return this.query=this.query.eq("paziente_id",t),this}withPatientData(){if(!this.query)throw new Error("Query not initialized. Call select() or count() first.");return this}build(){if(!this.query)throw new Error("Query not initialized. Call select() or count() first.");return this.query}async execute(){return this.build()}async selectAndExecute(t="*"){return this.select(t).execute()}async countAndExecute(){return this.count().execute()}}class h{supabaseClient;query;filters={};constructor(t){this.supabaseClient=t}select(t="id"){return this.query=this.supabaseClient.from("pazienti").select(t),this}count(){return this.query=this.supabaseClient.from("pazienti").select("id",{count:"exact",head:!0}),this}withFilters(t){return this.filters=t,this}applyFilters(){if(!this.query)throw new Error("Query not initialized. Call select() or count() first.");if(this.filters.dateRange?.startDate&&(this.query=this.query.gte("data_ricovero",this.filters.dateRange.startDate)),this.filters.dateRange?.endDate&&(this.query=this.query.lte("data_ricovero",this.filters.dateRange.endDate)),this.filters.repartoAppartenenza&&(this.query=this.query.eq("reparto_appartenenza",this.filters.repartoAppartenenza)),this.filters.repartoProvenienza&&(this.query=this.query.eq("reparto_provenienza",this.filters.repartoProvenienza)),this.filters.diagnosi&&(this.query=this.query.eq("diagnosi",this.filters.diagnosi)),this.filters.livelloAssistenza&&(this.query=this.query.eq("livello_assistenza",this.filters.livelloAssistenza)),null!=this.filters.infetto&&(this.query=this.query.eq("infetto",this.filters.infetto)),void 0!==this.filters.stato&&("attivo"===this.filters.stato?this.query=this.query.is("data_dimissione",null):"dimesso"===this.filters.stato&&(this.query=this.query.not("data_dimissione","is",null))),this.filters.trasferimento&&(this.query=this.query.eq("tipo_dimissione",this.filters.trasferimento)),this.filters.search){const t=`%${this.filters.search}%`;this.query=this.query.or(`nome.ilike.${t},cognome.ilike.${t},codice_rad.ilike.${t}`)}return this}build(){if(!this.query)throw new Error("Query not initialized. Call select() or count() first.");return this.query}async execute(){return this.build()}async selectWithFilters(t,e="id"){return this.select(e).withFilters(t).applyFilters().execute()}async countWithFilters(t){return this.count().withFilters(t).applyFilters().execute()}}function u(t){return new h(t)}const d=new class{supabaseClient;patientQueryBuilder;eventQueryBuilder;cache=new Map;cacheConfig={enabled:!0,defaultTtl:3e5,ttlByService:{patients:3e5,charts:12e4,"clinical-events":6e5}};constructor(t){this.supabaseClient=t,this.patientQueryBuilder=new h(t),this.eventQueryBuilder=new l(t)}generateCacheKey(t,e){const i=JSON.stringify(e);return`${t}:${this.hashString(i)}`}hashString(t){let e=0;for(let i=0;i<t.length;i++){e=(e<<5)-e+t.charCodeAt(i),e&=e}return`h${Math.abs(e).toString(16)}`}getCached(t){if(!this.cacheConfig.enabled)return null;const e=this.cache.get(t);if(!e)return null;return Date.now()-e.createdAt>e.ttl?(this.cache.delete(t),null):e.data}setCached(t,e,i){this.cacheConfig.enabled&&this.cache.set(t,{data:e,createdAt:Date.now(),ttl:i,isExpired:!1})}clearCache(){this.cache.clear()}clearCacheForService(t){const e=[];for(const[i]of this.cache.entries())i.startsWith(`${t}:`)&&e.push(i);e.forEach(t=>this.cache.delete(t))}async getPatientStatistics(t={}){const i=this.generateCacheKey("patients:stats",t),r=this.getCached(i);if(r)return e.debug("Patient statistics retrieved from cache",{filters:t}),r;try{e.debug("Fetching patient statistics via RPC (server-side)",{filters:t});const{data:r,error:n}=await this.supabaseClient.rpc("get_patient_statistics",{p_data_ricovero_start:t.dateRange?.startDate||null,p_data_ricovero_end:t.dateRange?.endDate||null,p_reparto_appartenenza:t.repartoAppartenenza||null,p_reparto_provenienza:t.repartoProvenienza||null,p_diagnosi:t.diagnosi||null,p_livello_assistenza:t.livelloAssistenza||null,p_infetto:t.infetto||null});if(n)return e.warn("RPC get_patient_statistics failed, falling back to client-side",n),await this.getPatientStatisticsFallback(t);if(!r||0===r.length)throw new Error("No statistics data returned");const s=r[0],a={total:s.total_patients||0,ricoverati:s.ricoverati||0,dimessi:s.dimessi||0,filteredCount:s.filtered_patients||0,surgicalCount:s.surgical_patients||0,infectedCount:s.infected_patients||0},c=this.cacheConfig.ttlByService.patients;return this.setCached(i,a,c),e.debug("Patient statistics fetched via RPC and cached",{stats:a,ttl:c}),a}catch(n){throw e.error("Error fetching patient statistics",n),n}}async getPatientStatisticsFallback(t={}){e.debug("Using client-side fallback for patient statistics",{filters:t});const{count:i}=await this.patientQueryBuilder.count().build(),{data:r}=await this.patientQueryBuilder.select("id, data_dimissione").withFilters(t).applyFilters().build(),n=r||[],s=n.length;return{total:i||0,ricoverati:n.filter(t=>!t.data_dimissione).length,dimessi:n.filter(t=>t.data_dimissione).length,filteredCount:s,surgicalCount:await this.getSurgicalPatientCount(t),infectedCount:await this.getInfectedPatientCount(t)}}async getFilteredPatientCount(t={}){const i=this.generateCacheKey("patients:filtered-count",t),r=this.getCached(i);if(null!==r)return r;try{const{data:e,error:r}=await this.patientQueryBuilder.select("id").withFilters(t).applyFilters().build();if(r)throw new Error(`Failed to count filtered patients: ${r.message}`);const n=e?.length||0;return this.setCached(i,n,this.cacheConfig.ttlByService.patients),n}catch(n){throw e.error("Error getting filtered patient count",n),n}}async getSurgicalPatientCount(t={}){const i=this.generateCacheKey("charts:surgical-count",t),r=this.getCached(i);if(null!==r)return r;try{const{data:e,error:r}=await this.patientQueryBuilder.select("id").withFilters(t).applyFilters().build();if(r)throw new Error(`Failed to get filtered patients: ${r.message}`);const n=new Set(e?.map(t=>t.id)||[]),{data:s,error:a}=await this.eventQueryBuilder.select("paziente_id").byTipo("intervento").build();if(a)throw new Error(`Failed to get surgical events: ${a.message}`);const c=new Set(s?.map(t=>t.paziente_id)||[]),o=Array.from(c).filter(t=>n.has(t)).length;return this.setCached(i,o,this.cacheConfig.ttlByService.charts),o}catch(n){throw e.error("Error getting surgical patient count",n),n}}async getInfectedPatientCount(t={}){const i=this.generateCacheKey("charts:infected-count",t),r=this.getCached(i);if(null!==r)return r;try{const{data:e,error:r}=await this.patientQueryBuilder.select("id").withFilters(t).applyFilters().build();if(r)throw new Error(`Failed to get filtered patients: ${r.message}`);const n=new Set(e?.map(t=>t.id)||[]),{data:s,error:a}=await this.eventQueryBuilder.select("paziente_id").byTipo("infezione").build();if(a)throw new Error(`Failed to get infection events: ${a.message}`);const c=new Set(s?.map(t=>t.paziente_id)||[]),o=Array.from(c).filter(t=>n.has(t)).length;return this.setCached(i,o,this.cacheConfig.ttlByService.charts),o}catch(n){throw e.error("Error getting infected patient count",n),n}}async getEventiStats(){const t=this.generateCacheKey("eventi:stats",{}),i=this.getCached(t);if(i)return e.debug("Event statistics retrieved from cache"),i;try{e.debug("Fetching event statistics via RPC (server-side)");const{data:i,error:r}=await this.supabaseClient.rpc("get_event_statistics");if(r)return e.warn("RPC get_event_statistics failed, falling back to client-side",r),await this.getEventiStatsFallback();if(!i||0===i.length)throw new Error("No event statistics data returned");const n=i[0],s={total:n.total_events||0,interventi:n.interventions||0,infezioni:n.infections||0,ultimoMese:n.last_month_events||0},a=this.cacheConfig.ttlByService["clinical-events"];return this.setCached(t,s,a),e.debug("Event statistics fetched via RPC and cached",{stats:s,ttl:a}),s}catch(r){throw e.error("Error fetching event statistics",r),r}}async getEventiStatsFallback(){e.debug("Using client-side fallback for event statistics");const{data:t}=await this.eventQueryBuilder.select("tipo_evento, data_evento, pazienti!inner(id)").build(),i=t||[],r={total:i.length,interventi:i.filter(t=>"intervento"===t.tipo_evento).length,infezioni:i.filter(t=>"infezione"===t.tipo_evento).length,ultimoMese:0},n=new Date;return n.setMonth(n.getMonth()-1),r.ultimoMese=i.filter(t=>new Date(t.data_evento)>=n).length,r}async getEventiCount(){const t=this.generateCacheKey("eventi:count",{}),i=this.getCached(t);if(null!==i)return i;try{const{count:e,error:i}=await this.eventQueryBuilder.count().build();if(i)throw new Error(`Failed to count events: ${i.message}`);return this.setCached(t,e||0,this.cacheConfig.ttlByService["clinical-events"]),e||0}catch(r){throw e.error("Error getting event count",r),r}}async getInterventiCount(){const t=this.generateCacheKey("eventi:interventi",{}),i=this.getCached(t);if(null!==i)return i;try{const{data:e,error:i}=await this.eventQueryBuilder.select("id").byTipo("intervento").build();if(i)throw new Error(`Failed to count interventions: ${i.message}`);const r=e?.length||0;return this.setCached(t,r,this.cacheConfig.ttlByService["clinical-events"]),r}catch(r){throw e.error("Error getting intervention count",r),r}}async getInfezioniCount(){const t=this.generateCacheKey("eventi:infezioni",{}),i=this.getCached(t);if(null!==i)return i;try{const{data:e,error:i}=await this.eventQueryBuilder.select("id").byTipo("infezione").build();if(i)throw new Error(`Failed to count infections: ${i.message}`);const r=e?.length||0;return this.setCached(t,r,this.cacheConfig.ttlByService["clinical-events"]),r}catch(r){throw e.error("Error getting infection count",r),r}}setCacheConfig(t){this.cacheConfig={...this.cacheConfig,...t}}getCacheConfig(){return this.cacheConfig}}(t);export{u as a,i as b,d as c,n as d,r as f,s as g,a as i,c as n};
