import{j as e}from"./ui-vendor-S6RcKJ66.js";import{b as t,R as a}from"./react-vendor-Bp2pLdQf.js";import{C as s}from"./CustomSelect-_IRV9l44.js";import{a as i}from"./DateRangePicker-DUtwU8_8.js";import{C as r}from"./charts-vendor-BWtMAC_w.js";import{l as n,c as o,e as l}from"./index-PMJ-Az3h.js";import{a as c,c as d}from"./CentralizedStatisticsService-B70v23eF.js";import{u as h}from"./useQuery-CWG4A72J.js";import{b as u,l as p,c as g,d as m,e as b}from"./filterQueryService-DlxQrhft.js";import"./dropdownPositioner-CpLmXRgY.js";import"./supabase-Zkii_ZbW.js";const f=({viewMode:a,filters:r,diagnosiOptions:n,repartoOptions:o,repartoProvenienzaOptions:l,infectionOptions:c,onApplyFilters:d,onReset:h,onApplyClick:u})=>{const p=t.useId(),[g,m]=t.useState(()=>"undefined"!=typeof window&&window.innerWidth<=767),b=(e,t)=>{d({...r,[e]:t})},f=(e,t)=>{d({...r,dateRange:{startDate:"startDate"===e?t:r.dateRange?.startDate||"",endDate:"endDate"===e?t:r.dateRange?.endDate||"",preset:r.dateRange?.preset||"custom"}})};return e.jsxs("div",{className:"charts-filters-card charts-collapsible "+(g?"is-collapsed":""),children:[e.jsxs("div",{className:"charts-filters-header charts-collapsible-header",children:[e.jsxs("div",{className:"charts-filters-title-wrapper",children:[e.jsx("span",{className:"material-icons",children:"filter_list"}),e.jsx("h3",{className:"charts-filters-title",children:"Filtri"})]}),e.jsx("button",{type:"button",className:"charts-collapse-toggle","aria-expanded":!g,"aria-controls":p,"aria-label":g?"Espandi filtri":"Comprimi filtri",onClick:()=>m(e=>!e),children:e.jsx("span",{"aria-hidden":"true",className:"material-icons",children:g?"expand_more":"expand_less"})})]}),e.jsxs("div",{className:"charts-filters-content charts-collapsible-content",id:p,hidden:g,children:[e.jsx("div",{className:"charts-filter-row",children:e.jsx(i,{startDate:r.dateRange?.startDate||"",endDate:r.dateRange?.endDate||"",onStartDateChange:e=>f("startDate",e||""),onEndDateChange:e=>f("endDate",e||""),startLabel:"Data Inizio",endLabel:"Data Fine",startPlaceholder:"gg/mm/aaaa",endPlaceholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})}),("filtered"===a||"analysis"===a)&&e.jsxs("div",{className:"charts-filter-row",children:[e.jsxs("div",{className:"charts-filter-column",children:[e.jsx("label",{htmlFor:"filter-reparto-appartenenza",className:"charts-filter-label",children:"Reparto Appartenenza"}),e.jsx(s,{id:"filter-reparto-appartenenza",value:r.repartoAppartenenza||"",options:[{value:"",label:"Tutti"},...o.map(e=>({value:e,label:e}))],onChange:e=>b("repartoAppartenenza",e||""),placeholder:"Seleziona..."})]}),e.jsxs("div",{className:"charts-filter-column",children:[e.jsx("label",{htmlFor:"filter-reparto-provenienza",className:"charts-filter-label",children:"Reparto Provenienza"}),e.jsx(s,{id:"filter-reparto-provenienza",value:r.repartoProvenienza||"",options:[{value:"",label:"Tutti"},...l.map(e=>({value:e,label:e}))],onChange:e=>b("repartoProvenienza",e||""),placeholder:"Seleziona..."})]})]}),("filtered"===a||"analysis"===a)&&e.jsxs("div",{className:"charts-filter-row",children:["filtered"===a&&e.jsxs("div",{className:"charts-filter-column",children:[e.jsx("label",{htmlFor:"filter-diagnosi",className:"charts-filter-label",children:"Diagnosi"}),e.jsx(s,{id:"filter-diagnosi",value:r.diagnosi||"",options:[{value:"",label:"Tutte"},...n.map(e=>({value:e.nome,label:e.nome}))],onChange:e=>b("diagnosi",e||""),placeholder:"Seleziona..."})]}),e.jsxs("div",{className:"charts-filter-column",children:[e.jsx("label",{htmlFor:"filter-livello-assistenza",className:"charts-filter-label",children:"Livello Assistenza"}),e.jsx(s,{id:"filter-livello-assistenza",value:r.livelloAssistenza||"",options:[{value:"",label:"Tutti"},{value:"Bassa",label:"Bassa"},{value:"Media",label:"Media"},{value:"Alta",label:"Alta"}],onChange:e=>b("livelloAssistenza",e||null),placeholder:"Seleziona..."})]}),e.jsxs("div",{className:"charts-filter-column",children:[e.jsx("label",{htmlFor:"filter-infetto",className:"charts-filter-label",children:"Infetto"}),e.jsx(s,{id:"filter-infetto",value:null!=r.infetto?r.infetto.toString():"",options:c.map(e=>({value:e.value?.toString()??"",label:e.label})),onChange:e=>b("infetto","true"===e||"false"!==e&&void 0),placeholder:"Seleziona..."})]})]}),e.jsxs("div",{className:"charts-filter-actions",children:[e.jsx("button",{type:"button",className:"btn btn-primary",onClick:u,children:"Applica Filtri"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:h,children:"Reset"})]})]})]})};class y{labels;datasets;totalRecords;aggregationType;filters;generatedAt;constructor(e={}){this.labels=e.labels??[],this.datasets=e.datasets??[],this.totalRecords=e.totalRecords??0,this.aggregationType=e.aggregationType??"count",this.filters=e.filters??null,this.generatedAt="string"==typeof e.generatedAt?new Date(e.generatedAt):e.generatedAt??new Date}validate(){const e=[];return Array.isArray(this.labels)&&0!==this.labels.length||e.push({field:"labels",message:"Labels array must not be empty"}),Array.isArray(this.datasets)&&0!==this.datasets.length||e.push({field:"datasets",message:"Datasets array must not be empty"}),this.datasets.forEach((t,a)=>{Array.isArray(t.data)?t.data.length!==this.labels.length&&e.push({field:`datasets[${a}].data`,message:"Dataset data length must match labels length"}):e.push({field:`datasets[${a}].data`,message:"Dataset data must be an array"})}),this.totalRecords>1e4&&e.push({field:"totalRecords",message:"Total records exceeds 10,000 limit"}),{valid:0===e.length,errors:e}}toChartJS(){return{labels:this.labels,datasets:this.datasets}}toJSON(){return{labels:this.labels,datasets:this.datasets,totalRecords:this.totalRecords,aggregationType:this.aggregationType,filters:this.filters,generatedAt:this.generatedAt.toISOString()}}}const _=[{label:"Minori (0-17)",color:"#4299E1"},{label:"Giovani (18-30)",color:"#48BB78"},{label:"Adulti (31-50)",color:"#ECC94B"},{label:"Anziani (51-70)",color:"#F6AD55"},{label:"Grandi anziani (70+)",color:"#FC8181"}],v=["#48BB78","#ECC94B","#F56565","#4299E1","#FC8181"],C={"Dimissione Ordinaria":"#48BB78","Trasferimento Interno":"#4299E1","Trasferimento Esterno":"#ECC94B",Decesso:"#E53E3E","Non specificato":"#A0AEC0"};const w=new class{cache;CACHE_TTL;constructor(){this.cache=new Map,this.CACHE_TTL=6e5}async getAgeDistribution(e={}){const t=`age_dist_${JSON.stringify(e)}`,a=this._getFromCache(t);if(a)return n.debug("Returning cached age distribution"),a;try{const{data:a,error:s}=await o.rpc("get_age_distribution",{filters:JSON.stringify(e)});if(s)throw s;const i=this._buildAgeDistributionChart(a,e);return this._setCache(t,i),i}catch(s){n.warn("RPC get_age_distribution failed, falling back to direct query",s);const a=await this._fetchAgeDistributionFallback(e);return this._setCache(t,a),a}}async getAgeStatistics(e={}){const t=`age_stats_${JSON.stringify(e)}`,a=this._getFromCache(t);if(a)return a;try{const a=c(o).select("data_nascita").withFilters(e).build().not("data_nascita","is",null),{data:s,error:i}=await a;if(i)throw i;const r=new Date,n=s.map(e=>{const t=new Date(e.data_nascita);return r.getFullYear()-t.getFullYear()}).sort((e,t)=>e-t),l={min:Math.min(...n),max:Math.max(...n),avg:n.reduce((e,t)=>e+t,0)/n.length,median:n[Math.floor(n.length/2)],count:n.length};return this._setCache(t,l),l}catch(s){throw n.error("Error fetching age statistics",s),s}}async getAssistanceLevelDistribution(e={}){const t=`assistance_${JSON.stringify(e)}`,a=this._getFromCache(t);if(a)return a;try{const{data:a,error:s}=await o.rpc("get_assistance_level_distribution",{filters:JSON.stringify(e)});if(s)throw s;const i=this._buildAssistanceLevelChart(a,e);return this._setCache(t,i),i}catch(s){n.warn("RPC get_assistance_level_distribution failed, using fallback",s);const a=await this._fetchAssistanceLevelFallback(e);return this._setCache(t,a),a}}async getDismissalTypeDistribution(e={}){const t=`dismissal_${JSON.stringify(e)}`,a=this._getFromCache(t);if(a)return a;try{const{data:a,error:s}=await o.rpc("get_dismissal_type_distribution",{filters:JSON.stringify(e)});if(s)throw s;const i=this._buildDismissalTypeChart(a,e);return this._setCache(t,i),i}catch(s){n.warn("RPC get_dismissal_type_distribution failed, using fallback",s);const a=await this._fetchDismissalTypeFallback(e);return this._setCache(t,a),a}}async getInfectionRateByDiagnosis(e={}){const{minPatients:t=3,limit:a=15,filters:s={}}=e,i=`infection_rate_${t}_${a}_${JSON.stringify(s)}`,r=this._getFromCache(i);if(r)return r;try{n.debug("Calling get_infection_rate_by_diagnosis RPC with filters:",JSON.stringify(s,null,2));const{data:e,error:r}=await o.rpc("get_infection_rate_by_diagnosis",{p_min_patients:t,p_result_limit:a,filters:JSON.stringify(s)});if(r)throw r;const l=this._buildInfectionRateChart(e,{minPatients:t,limit:a,filters:s});return this._setCache(i,l),l}catch(l){n.warn("RPC get_infection_rate_by_diagnosis failed, using fallback",l);const e=await this._fetchInfectionRateFallback(t,a,s);return this._setCache(i,e),e}}_buildAgeDistributionChart(e=[],t){const a=_.reduce((e,t)=>(e[t.label]=0,e),{});e.forEach(e=>{const t=e.age_range||e.label;t&&void 0!==a[t]&&(a[t]=Number(e.patient_count??e.count??0))});const s=_.map(e=>e.label),i=s.map(e=>a[e]||0),r=i.reduce((e,t)=>e+t,0);return new y({labels:s,datasets:[{label:"Distribuzione per Fascia d'EtÃ ",data:i,backgroundColor:_.map(e=>{const t=e.color;return`rgba(${parseInt(t.slice(1,3),16)}, ${parseInt(t.slice(3,5),16)}, ${parseInt(t.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:r,aggregationType:"age_distribution",filters:null,generatedAt:new Date})}async _fetchAgeDistributionFallback(e){try{const t=c(o).select("data_nascita").withFilters(e).build().not("data_nascita","is",null),{data:a,error:s}=await t;if(s)throw s;const i=_.reduce((e,t)=>(e[t.label]=0,e),{}),r=new Date;a.forEach(e=>{const t=new Date(e.data_nascita),a=r.getFullYear()-t.getFullYear();a<18?i["Minori (0-17)"]++:a<=30?i["Giovani (18-30)"]++:a<=50?i["Adulti (31-50)"]++:a<=70?i["Anziani (51-70)"]++:i["Grandi anziani (70+)"]++});const n=Object.entries(i).map(([e,t])=>({age_range:e,patient_count:t}));return this._buildAgeDistributionChart(n,e)}catch(t){throw n.error("Fallback age distribution query failed",t),t}}_buildAssistanceLevelChart(e=[],t){const a=[...e].map(e=>({assistance_level:e.assistance_level||e.label||"Non specificato",patient_count:Number(e.patient_count??e.count??0)})).sort((e,t)=>t.patient_count-e.patient_count||e.assistance_level.localeCompare(t.assistance_level)),s=a.map(e=>e.assistance_level),i=a.map(e=>e.patient_count),r=s.map((e,t)=>v[t%v.length]),n=i.reduce((e,t)=>e+t,0);return new y({labels:s,datasets:[{label:"Distribuzione Livelli Assistenza",data:i,backgroundColor:r.map(e=>{const t=e;return`rgba(${parseInt(t.slice(1,3),16)}, ${parseInt(t.slice(3,5),16)}, ${parseInt(t.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"assistance_level",filters:null,generatedAt:new Date})}async _fetchAssistanceLevelFallback(e){try{const t=c(o).select("livello_assistenza").withFilters(e).build().not("livello_assistenza","is",null),{data:a,error:s}=await t;if(s)throw s;const i=a.reduce((e,t)=>{const a=t.livello_assistenza||"Non specificato";return e[a]=(e[a]||0)+1,e},{}),r=Object.entries(i).map(([e,t])=>({assistance_level:e,patient_count:t}));return this._buildAssistanceLevelChart(r,e)}catch(t){throw n.error("Fallback assistance level query failed",t),t}}_buildDismissalTypeChart(e=[],t){const a=e.map(e=>{const t=e.dismissal_type||e.label||"Non specificato";return{dismissal_type:(Object.keys(C).includes(t),t),patient_count:Number(e.patient_count??e.count??0)}}).sort((e,t)=>t.patient_count-e.patient_count||e.dismissal_type.localeCompare(t.dismissal_type)),s=a.map(e=>e.dismissal_type),i=a.map(e=>e.patient_count),r=s.map(e=>C[e]||"#CBD5F5"),n=i.reduce((e,t)=>e+t,0);return new y({labels:s,datasets:[{label:"Distribuzione Tipi Dimissione",data:i,backgroundColor:r.map(e=>{const t=e;return`rgba(${parseInt(t.slice(1,3),16)}, ${parseInt(t.slice(3,5),16)}, ${parseInt(t.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"dismissal_type",filters:null,generatedAt:new Date})}async _fetchDismissalTypeFallback(e){try{const t=c(o).select("tipo_dimissione").withFilters(e).build(),{data:a,error:s}=await t;if(s)throw s;const i={dimissione:"Dimissione Ordinaria",trasferimento_interno:"Trasferimento Interno",trasferimento_esterno:"Trasferimento Esterno",decesso:"Decesso"},r=a.reduce((e,t)=>{const a=t.tipo_dimissione||"Non specificato",s=i[a]||a;return e[s]=(e[s]||0)+1,e},{}),n=Object.entries(r).map(([e,t])=>({dismissal_type:e,patient_count:t}));return this._buildDismissalTypeChart(n,e)}catch(t){throw n.error("Fallback dismissal type query failed",t),t}}_buildInfectionRateChart(e=[],t){const a=[...e].map(e=>({diagnosi:e.diagnosi||e.diagnosis||"Non specificata",infection_rate:Number(e.infection_rate??e.rate??0),total_pazienti:Number(e.total_pazienti??e.total??0),infected_pazienti:Number(e.infected_pazienti??e.infected??0)})),s=a.map(e=>e.diagnosi),i=a.map(e=>Number(e.infection_rate.toFixed(2))),r=a.map(e=>{const t=e.infection_rate;return 0===t?"#48BB78":t<5?"#ECC94B":t<10?"#F6AD55":"#F56565"}),n=a.reduce((e,t)=>e+t.total_pazienti,0);return new y({labels:s,datasets:[{label:"Tasso Infezione (%)",data:i,backgroundColor:r.map(e=>{const t=e;return`rgba(${parseInt(t.slice(1,3),16)}, ${parseInt(t.slice(3,5),16)}, ${parseInt(t.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"infection_rate",filters:null,generatedAt:new Date})}async _fetchInfectionRateFallback(e,t,a){try{const s=c(o).select("diagnosi, infetto").withFilters(a).build(),{data:i,error:r}=await s;if(r)throw r;const n=i.reduce((e,t)=>{const a=t.diagnosi||"Non specificata";return e[a]||(e[a]={total:0,infected:0}),e[a].total+=1,t.infetto&&(e[a].infected+=1),e},{}),l=Object.entries(n).filter(([,t])=>t.total>=e).map(([e,t])=>({diagnosi:e,infection_rate:t.infected/t.total*100,total_pazienti:t.total,infected_pazienti:t.infected})).sort((e,t)=>t.infection_rate-e.infection_rate).slice(0,t);return this._buildInfectionRateChart(l,{minPatients:e,limit:t,filters:a})}catch(s){throw n.error("Fallback infection rate query failed",s),s}}_getFromCache(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>this.CACHE_TTL?(this.cache.delete(e),null):t.data:null}_setCache(e,t){if(this.cache.set(e,{data:t,timestamp:Date.now()}),this.cache.size>50){const e=this.cache.keys().next().value;void 0!==e&&this.cache.delete(e)}}clearCache(){this.cache.clear()}};const x=new class{cache;CACHE_TTL;constructor(){this.cache=new Map,this.CACHE_TTL=3e5}async getMonthlyAdmissionTrends(e={}){const{months:t=12,includeInfections:a=!0,includeDismissals:s=!0,filters:i={}}=e,r=`monthly_trends_${t}_${a}_${s}_${JSON.stringify(i)}`,l=this._getFromCache(r);if(l)return n.debug("Returning cached monthly trends"),l;try{const{data:e,error:n}=await o.rpc("get_monthly_admission_trends",{num_months:t,include_infections:a,include_dismissals:s,filters:JSON.stringify(i)});if(n)return await this._getMonthlyTrendsDirectQuery(t,a,s,i);const l=this._formatMonthlyTrendsData(e,{months:t,includeInfections:a,includeDismissals:s});return this._setCache(r,l),l}catch(c){return n.error("Error fetching monthly admission trends",c),await this._getMonthlyTrendsDirectQuery(t,a,s,i)}}async getSeasonalDistribution(e={}){const t=`seasonal_${JSON.stringify(e)}`,a=this._getFromCache(t);if(a)return a;try{const{data:a,error:s}=await o.rpc("get_seasonal_distribution",{filters:JSON.stringify(e)});if(s)throw s;const i=this._buildSeasonalDistributionChart(a,e);return this._setCache(t,i),i}catch(s){n.warn("RPC get_seasonal_distribution failed, using fallback",s);const a=await this._getSeasonalDistributionFallback(e);return this._setCache(t,a),a}}async getAverageLengthOfStay(e={}){const{minPatients:t=3,limit:a=15,filters:s={}}=e,i=`avg_los_${t}_${a}_${JSON.stringify(s)}`,r=this._getFromCache(i);if(r)return n.debug("Returning cached average length of stay"),r;try{n.debug("Calling get_avg_length_of_stay RPC with filters:",JSON.stringify(s,null,2));const{data:e,error:r}=await o.rpc("get_avg_length_of_stay",{p_min_patients:t,p_result_limit:a,p_filters:JSON.stringify(s)});if(r)return n.warn("RPC get_avg_length_of_stay failed, using fallback",r),await this._getAvgLOSDirectQuery(t,a,s);const l=this._formatLengthOfStayData(e);return this._setCache(i,l),l}catch(l){return n.error("Error fetching average length of stay",l),await this._getAvgLOSDirectQuery(t,a,s)}}async _getMonthlyTrendsDirectQuery(e,t,a,s={}){try{const i=new Date;i.setMonth(i.getMonth()-e);let r=c(o).select("data_ricovero, infetto, data_dimissione").withFilters(s).build().gte("data_ricovero",i.toISOString().split("T")[0]).order("data_ricovero",{ascending:!0});const{data:n,error:l}=await r;if(l)throw l;const d={};n.forEach(e=>{const s=new Date(e.data_ricovero),i=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`;d[i]||(d[i]={admissions:0,infections:0,dismissals:0}),d[i].admissions++,t&&e.infetto&&d[i].infections++,a&&e.data_dimissione&&d[i].dismissals++});const h=Object.keys(d).sort(),u=[{label:"Ricoveri",data:h.map(e=>d[e].admissions),borderColor:"#4299E1",backgroundColor:"rgba(66, 153, 225, 0.3)",borderWidth:2}];t&&u.push({label:"Infezioni",data:h.map(e=>d[e].infections),borderColor:"#F56565",backgroundColor:"rgba(245, 101, 101, 0.3)",borderWidth:2}),a&&u.push({label:"Dimissioni",data:h.map(e=>d[e].dismissals),borderColor:"#48BB78",backgroundColor:"rgba(72, 187, 120, 0.3)",borderWidth:2});return new y({labels:h.map(e=>{const[t,a]=e.split("-");return new Date(parseInt(t),parseInt(a)-1).toLocaleDateString("it-IT",{month:"short",year:"numeric"})}),datasets:u,totalRecords:n.length,aggregationType:"monthly_trends",filters:null,generatedAt:new Date})}catch(i){throw n.error("Error in direct monthly trends query",i),i}}async _getAvgLOSDirectQuery(e,t,a={}){try{let s=c(o).select("diagnosi, data_ricovero, data_dimissione").withFilters(a).build().not("data_dimissione","is",null).not("data_ricovero","is",null);const{data:i,error:r}=await s;if(r)throw r;const n={};i.forEach(e=>{const t=new Date(e.data_ricovero),a=new Date(e.data_dimissione);if(a.getTime()>=t.getTime()){const s=(a.getTime()-t.getTime())/864e5,i=e.diagnosi||"Non specificata";n[i]||(n[i]={total:0,count:0}),n[i].total+=s,n[i].count++}});const l=Object.entries(n).filter(([,t])=>t.count>=e).map(([e,t])=>({diagnosi:e,avg_days:t.total/t.count,total_pazienti:t.count})).sort((e,t)=>t.avg_days-e.avg_days).slice(0,t);return this._formatLengthOfStayData(l)}catch(s){throw n.error("Error in direct avg LOS query",s),s}}_formatMonthlyTrendsData(e=[],t={}){const{months:a=12,includeInfections:s=!0,includeDismissals:i=!0}=t;if(!Array.isArray(e)||0===e.length)return new y({labels:[],datasets:[],totalRecords:0,aggregationType:"monthly_trends",filters:null,generatedAt:new Date});const r=[...e].sort((e,t)=>{const a=new Date(e.month_start??e.month_start_date??e.month??""),s=new Date(t.month_start??t.month_start_date??t.month??"");return a.getTime()-s.getTime()}),n=r.map(e=>{const t=new Date(e.month_start??e.month_start_date??e.month??"");return Number.isNaN(t.getTime())?e.month_label??"n/d":t.toLocaleDateString("it-IT",{month:"short",year:"numeric"})}),o=r.map(e=>Number(e.admissions)||0),l=r.map(e=>Number(e.infections)||0),c=r.map(e=>Number(e.dismissals)||0),d=[{label:"Ricoveri",data:o,borderColor:"#4299E1",backgroundColor:"rgba(66, 153, 225, 0.3)",borderWidth:2}];s&&d.push({label:"Infezioni",data:l,borderColor:"#F56565",backgroundColor:"rgba(245, 101, 101, 0.3)",borderWidth:2}),i&&d.push({label:"Dimissioni",data:c,borderColor:"#48BB78",backgroundColor:"rgba(72, 187, 120, 0.3)",borderWidth:2});const h=o.reduce((e,t)=>e+t,0);return new y({labels:n,datasets:d,totalRecords:h,aggregationType:"monthly_trends",filters:null,generatedAt:new Date})}_buildSeasonalDistributionChart(e=[],t={}){const a=[{label:"Inverno",color:"#4299E1"},{label:"Primavera",color:"#48BB78"},{label:"Estate",color:"#F6AD55"},{label:"Autunno",color:"#ED8936"}],s=a.reduce((e,t)=>(e[t.label]=0,e),{});e.forEach(e=>{const t=e.season||e.label;t&&void 0!==s[t]&&(s[t]=Number(e.patient_count??e.count??0))});const i=a.map(e=>e.label),r=i.map(e=>s[e]||0),n=r.reduce((e,t)=>e+t,0);return new y({labels:i,datasets:[{label:"Ricoveri per Stagione",data:r,backgroundColor:a.map(e=>e.color),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"seasonal",filters:null,generatedAt:new Date})}async _getSeasonalDistributionFallback(e={}){try{let t=c(o).select("data_ricovero").withFilters(e).build();const{data:a,error:s}=await t;if(s)throw s;const i={Inverno:0,Primavera:0,Estate:0,Autunno:0};a.forEach(e=>{const t=new Date(e.data_ricovero).getMonth()+1;12===t||t<=2?i.Inverno+=1:t<=5?i.Primavera+=1:t<=8?i.Estate+=1:i.Autunno+=1});const r=Object.entries(i).map(([e,t])=>({season:e,patient_count:t}));return this._buildSeasonalDistributionChart(r,e)}catch(t){throw n.error("Fallback seasonal distribution query failed",t),t}}_formatLengthOfStayData(e){const t=e.sort((e,t)=>t.avg_days-e.avg_days);return new y({labels:t.map(e=>e.diagnosi),datasets:[{label:"Degenza Media (giorni)",data:t.map(e=>parseFloat(e.avg_days.toFixed(1))),backgroundColor:t.map((e,a)=>{const s=a/t.length;return`rgb(${Math.floor(245-100*s)}, ${Math.floor(101+100*s)}, 101)`}),borderColor:"#333",borderWidth:1}],totalRecords:t.reduce((e,t)=>e+t.total_pazienti,0),aggregationType:"length_of_stay",filters:null,generatedAt:new Date})}_getFromCache(e){const t=this.cache.get(e);if(!t)return null;return Date.now()-t.timestamp>this.CACHE_TTL?(this.cache.delete(e),null):t.data}_setCache(e,t){if(this.cache.set(e,{data:t,timestamp:Date.now()}),this.cache.size>50){const e=this.cache.keys().next().value;void 0!==e&&this.cache.delete(e)}}clearCache(){this.cache.clear()}};var N=(e=>(e.PIE="pie",e.BAR="bar",e.LINE="line",e.DOUGHNUT="doughnut",e.HORIZONTAL_BAR="horizontalBar",e))(N||{});function j(e){return"horizontalBar"===e?"bar":e}const D=a.memo(({filters:a,onAnalysisTypeChange:s,className:i=""})=>{const[o,l]=t.useState("monthly_trends"),[c,d]=t.useState(!1),[h,u]=t.useState(!1),[p,g]=t.useState(""),[m,b]=t.useState(null),[f,y]=t.useState(N.LINE),_=t.useRef(null),v=t.useRef(null),C=t.useRef(!1),D=e=>{switch(e){case"monthly_trends":return N.LINE;case"age_distribution":case"seasonal":case"assistance_level":case"dismissal_type":return N.PIE;case"length_of_stay":case"infection_rate":return N.HORIZONTAL_BAR;default:return N.BAR}},A=t.useCallback(async(e,t)=>{try{let a;switch(d(!0),u(!1),g(""),n.info(`ðŸ” Loading analysis: ${e}`),n.info("ðŸ“Š Filters being passed to analysis:",JSON.stringify(t,null,2)),e){case"monthly_trends":a=await x.getMonthlyAdmissionTrends({months:12,includeInfections:!0,includeDismissals:!0,filters:t});break;case"age_distribution":a=await w.getAgeDistribution(t);break;case"length_of_stay":a=await x.getAverageLengthOfStay({minPatients:3,limit:15,filters:t});break;case"seasonal":a=await x.getSeasonalDistribution(t);break;case"assistance_level":a=await w.getAssistanceLevelDistribution(t);break;case"dismissal_type":a=await w.getDismissalTypeDistribution(t);break;case"infection_rate":a=await w.getInfectionRateByDiagnosis({minPatients:3,limit:10,filters:t});break;default:throw new Error(`Unknown analysis type: ${e}`)}const s=D(e);v.current&&(v.current.destroy(),v.current=null);const i=_.current;if(!i)throw new Error("Canvas non trovato per il rendering del grafico");const o={type:j(s),data:{labels:a.labels,datasets:a.datasets.map(e=>({label:e.label,data:e.data,backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:e.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:s===N.HORIZONTAL_BAR?"y":"x",plugins:{legend:{display:s===N.PIE||s===N.DOUGHNUT,position:"bottom",labels:{font:{size:12},padding:15}},tooltip:{enabled:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:14,weight:"bold"},bodyFont:{size:12},padding:10}},scales:s!==N.PIE&&s!==N.DOUGHNUT?{y:{beginAtZero:!0,title:{display:!0,text:"length_of_stay"===e?"Giorni":"infection_rate"===e?"Tasso (%)":"Numero Pazienti"},grid:{display:!0,color:"rgba(0, 0, 0, 0.1)"}},x:{title:{display:!0,text:"monthly_trends"===e?"Mese":"length_of_stay"===e||"infection_rate"===e?"Diagnosi":"Categoria"},grid:{display:!1}}}:void 0,animation:{duration:500,easing:"easeInOutQuart"}}};v.current=new r(i,o),b(a),y(s),n.info(`âœ… Analysis loaded: ${e}`,{recordCount:a.totalRecords})}catch(a){n.error("âŒ Error loading analysis",a),u(!0),g(a instanceof Error?a.message:"Errore durante il caricamento dell'analisi"),console.error("Errore durante il caricamento dell'analisi:",a)}finally{d(!1)}},[]),R=t.useCallback(e=>{l(e),y(D(e)),s&&s(e),n.info(`ðŸ”„ Analysis type changed to: ${e}`)},[s]),z=t.useCallback(e=>{if(m)try{u(!1),g(""),v.current&&(v.current.destroy(),v.current=null);const t=_.current;if(!t)return;const a={type:j(e),data:{labels:m.labels,datasets:m.datasets.map(e=>({label:e.label,data:e.data,backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:e.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:e===N.HORIZONTAL_BAR?"y":"x",plugins:{legend:{display:e===N.PIE||e===N.DOUGHNUT,position:"bottom"}},scales:e!==N.PIE&&e!==N.DOUGHNUT?{y:{beginAtZero:!0}}:void 0}};v.current=new r(t,a),y(e),n.info(`Chart type changed to: ${e}`)}catch(t){n.error("Error changing chart type",t),u(!0),g(t instanceof Error?t.message:"Errore durante il cambio tipo grafico")}},[m]);t.useEffect(()=>{C.current||(C.current=!0,A(o,a))},[]),t.useEffect(()=>{C.current&&A(o,a)},[o,a,A]),t.useEffect(()=>()=>{v.current&&(v.current.destroy(),v.current=null)},[]);return e.jsxs("div",{className:`analysis-view ${i}`,children:[e.jsx("div",{className:"analysis-type-selector mb-4",id:"analysis-type-selector",children:e.jsxs("div",{className:"btn-group",role:"group","aria-label":"Tipo di analisi",children:[e.jsx("button",{type:"button",className:"btn "+("monthly_trends"===o?"btn-primary":"btn-outline-primary"),"data-analysis":"monthly_trends",onClick:()=>R("monthly_trends"),children:"Trend Mensili"}),e.jsx("button",{type:"button",className:"btn "+("age_distribution"===o?"btn-primary":"btn-outline-primary"),"data-analysis":"age_distribution",onClick:()=>R("age_distribution"),children:"Distribuzione EtÃ "}),e.jsx("button",{type:"button",className:"btn "+("length_of_stay"===o?"btn-primary":"btn-outline-primary"),"data-analysis":"length_of_stay",onClick:()=>R("length_of_stay"),children:"Durata Degenza"}),e.jsx("button",{type:"button",className:"btn "+("seasonal"===o?"btn-primary":"btn-outline-primary"),"data-analysis":"seasonal",onClick:()=>R("seasonal"),children:"Stagionale"}),e.jsx("button",{type:"button",className:"btn "+("assistance_level"===o?"btn-primary":"btn-outline-primary"),"data-analysis":"assistance_level",onClick:()=>R("assistance_level"),children:"Livello Assistenza"}),e.jsx("button",{type:"button",className:"btn "+("dismissal_type"===o?"btn-primary":"btn-outline-primary"),"data-analysis":"dismissal_type",onClick:()=>R("dismissal_type"),children:"Tipo Dimissione"}),e.jsx("button",{type:"button",className:"btn "+("infection_rate"===o?"btn-primary":"btn-outline-primary"),"data-analysis":"infection_rate",onClick:()=>R("infection_rate"),children:"Tasso Infezione"})]})}),e.jsx("div",{className:"chart-controls mb-3",children:e.jsxs("div",{className:"btn-group",role:"group","aria-label":"Tipo grafico",children:[e.jsx("button",{type:"button",className:"btn "+(f===N.PIE?"btn-primary":"btn-outline-secondary"),onClick:()=>z(N.PIE),disabled:!m,children:"Torta"}),e.jsx("button",{type:"button",className:"btn "+(f===N.BAR?"btn-primary":"btn-outline-secondary"),onClick:()=>z(N.BAR),disabled:!m,children:"Barre"}),e.jsx("button",{type:"button",className:"btn "+(f===N.LINE?"btn-primary":"btn-outline-secondary"),onClick:()=>z(N.LINE),disabled:!m,children:"Linee"}),e.jsx("button",{type:"button",className:"btn "+(f===N.HORIZONTAL_BAR?"btn-primary":"btn-outline-secondary"),onClick:()=>z(N.HORIZONTAL_BAR),disabled:!m,children:"Barre Oriz."})]})}),e.jsxs("div",{className:"charts-container-wrapper",children:[m&&e.jsxs("div",{className:"charts-record-count",children:["Trovati ",m.totalRecords," record"]}),e.jsxs("div",{className:"charts-chart-wrapper",style:{position:"relative"},children:[e.jsx("canvas",{ref:_,className:c||h?"d-none":"","aria-label":`Grafico analisi ${o}`}),c?e.jsxs("div",{className:"text-center p-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"mt-2",children:"Caricamento analisi in corso..."})]}):null,h?e.jsxs("div",{className:"alert alert-danger",role:"alert",children:[e.jsx("h5",{className:"alert-heading",children:"Errore"}),e.jsx("p",{children:p}),e.jsx("button",{className:"btn btn-outline-danger",onClick:()=>A(o,a),children:"Riprova"})]}):null]})]})]})});D.displayName="AnalysisView";const A=a.memo(({chartType:a,onChartTypeChange:s,hasData:i,onExport:r})=>{const n=t.useId(),[o,l]=t.useState(()=>"undefined"!=typeof window&&window.innerWidth<=767);return e.jsxs("div",{className:"charts-controls charts-collapsible "+(o?"is-collapsed":""),children:[e.jsxs("div",{className:"charts-controls-header charts-collapsible-header",children:[e.jsxs("div",{className:"charts-controls-title-wrapper",children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"insights"}),e.jsx("h3",{className:"charts-controls-title",children:"Tipo Grafico"})]}),e.jsx("button",{type:"button",className:"charts-collapse-toggle","aria-expanded":!o,"aria-controls":n,"aria-label":o?"Espandi controlli grafico":"Comprimi controlli grafico",onClick:()=>l(e=>!e),children:e.jsx("span",{"aria-hidden":"true",className:"material-icons",children:o?"expand_more":"expand_less"})})]}),e.jsxs("div",{className:"charts-collapsible-content",id:n,hidden:o,children:[e.jsxs("div",{className:"charts-type-selector",children:[e.jsx("label",{className:"charts-control-label",children:"Tipo Grafico:"}),e.jsxs("div",{className:"btn-group charts-segmented-group",role:"group",children:[e.jsx("button",{type:"button",className:"btn "+(a===N.PIE?"btn-primary":"btn-outline-secondary"),onClick:()=>s(N.PIE),"aria-pressed":a===N.PIE,children:"Torta"}),e.jsx("button",{type:"button",className:"btn "+(a===N.BAR?"btn-primary":"btn-outline-secondary"),onClick:()=>s(N.BAR),"aria-pressed":a===N.BAR,children:"Barre"}),e.jsx("button",{type:"button",className:"btn "+(a===N.LINE?"btn-primary":"btn-outline-secondary"),onClick:()=>s(N.LINE),"aria-pressed":a===N.LINE,children:"Linee"})]})]}),i&&e.jsxs("div",{className:"charts-export-controls",children:[e.jsx("label",{className:"charts-control-label",children:"Esporta:"}),e.jsxs("div",{className:"btn-group charts-segmented-group",role:"group",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>r("image"),children:"Immagine"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>r("json"),children:"JSON"})]})]})]})]})}),R=({totalPatients:t,uniqueDiagnoses:a,totalDepartments:s})=>e.jsxs("div",{className:"charts-statistics",children:[e.jsx("h4",{children:"Statistiche"}),e.jsxs("div",{className:"charts-stat-grid",children:[e.jsxs("div",{className:"charts-stat-item",children:[e.jsx("span",{className:"charts-stat-label",children:"Totale Pazienti:"}),e.jsx("span",{className:"charts-stat-value",children:t})]}),void 0!==a&&e.jsxs("div",{className:"charts-stat-item",children:[e.jsx("span",{className:"charts-stat-label",children:"Diagnosi Uniche:"}),e.jsx("span",{className:"charts-stat-value",children:a})]}),void 0!==s&&e.jsxs("div",{className:"charts-stat-item",children:[e.jsx("span",{className:"charts-stat-label",children:"Reparti Totali:"}),e.jsx("span",{className:"charts-stat-value",children:s})]})]})]}),z=({filteredPatientsCount:t,surgicalCount:a,infectedCount:s,isLoading:i=!1})=>e.jsxs("div",{className:"charts-stats-grid",children:[e.jsxs("div",{className:"charts-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"people"})}),e.jsx("div",{className:"stat-value",children:i?"-":t}),e.jsx("div",{className:"stat-label",children:"Totale Filtrati"})]}),e.jsxs("div",{className:"charts-stat-card stat-surgical",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"medical_services"})}),e.jsx("div",{className:"stat-value",children:i?"-":a}),e.jsx("div",{className:"stat-label",children:"Operati"})]}),e.jsxs("div",{className:"charts-stat-card stat-infected",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"coronavirus"})}),e.jsx("div",{className:"stat-value",children:i?"-":s}),e.jsx("div",{className:"stat-label",children:"Infetti"})]})]}),E=a.forwardRef(({className:a="",politeness:s="polite"},i)=>{const r=t.useRef(null),n=(e,t=s)=>{r.current&&(r.current.getAttribute("aria-live")!==t&&r.current.setAttribute("aria-live",t),r.current.textContent="",requestAnimationFrame(()=>{r.current&&(r.current.textContent=e)}))};return t.useImperativeHandle(i,()=>({announce:n})),e.jsx("div",{ref:r,className:`live-region ${a}`,"aria-live":s,"aria-atomic":"true",role:"status"})});E.displayName="LiveRegion";const k={filtered:{label:"Vista Filtrata",shortLabel:"Filtrata",icon:"filter_list",description:"Visualizza i dati filtrati per diagnosi"},comparison:{label:"Confronto Reparti",shortLabel:"Confronto",icon:"compare_arrows",description:"Confronta i dati tra i diversi reparti"},analysis:{label:"Analisi Avanzate",shortLabel:"Analisi",icon:"analytics",description:"Visualizza analisi avanzate e insight"}},T=t.forwardRef(({initialViewMode:s="filtered",onViewModeChange:i,containerId:r="view-mode-tabs",className:o="",compactMode:l=!1},c)=>{const[d,h]=t.useState(s),[u,p]=t.useState({filtered:!1,comparison:!1,analysis:!1}),[g,m]=t.useState(!1),b=t.useRef(null),f=t.useRef(null),y=t.useRef(null),_=t.useRef({filtered:null,comparison:null,analysis:null});t.useEffect(()=>{const e=()=>{m(window.innerWidth<=640)};let t;e();const a=()=>{clearTimeout(t),t=setTimeout(e,150)};return window.addEventListener("resize",a),()=>{window.removeEventListener("resize",a),clearTimeout(t)}},[]);const v=l||g,C=e=>{if(e===d)return;if(y.current=document.activeElement,h(e),f.current){f.current.announce(`Tab ${{filtered:"Vista Filtrata",comparison:"Confronto Reparti",analysis:"Analisi Avanzate"}[e]} attivata`)}const t=_.current[e];t&&setTimeout(()=>{t.focus()},0),i&&i(e),n.debug("View mode tab activated",{viewMode:e})},w=(e,t)=>{p(a=>({...a,[e]:t}))};t.useEffect(()=>{s!==d&&h(s)},[s]),a.useImperativeHandle(c,()=>({getCurrentViewMode:()=>d,setActiveTab:C,setLoadingState:w,setLoadingStates:p}));const x=(t,a=!1)=>{const s=k[t],i=d===t,r=u[t];return e.jsx("div",{className:"nav-item",role:"presentation",children:e.jsx("button",{ref:e=>{e&&(_.current[t]=e)},className:`nav-link ${i?"active":""} ${r?"loading":""} ${a?"nav-link--icon":""}`,id:`${t}-tab`,"data-view-mode":t,type:"button",role:"tab","aria-controls":`${t}-panel`,"aria-selected":i,"aria-busy":r,"aria-label":s.description,title:s.label,onClick:()=>C(t),onKeyDown:e=>((e,t)=>{const a=["filtered","comparison","analysis"],s=a.indexOf(t);let i=null;switch(e.key){case"Enter":case" ":e.preventDefault(),C(t);break;case"ArrowLeft":case"ArrowUp":e.preventDefault(),i=a[(s-1+a.length)%a.length],C(i);break;case"ArrowRight":case"ArrowDown":e.preventDefault(),i=a[(s+1)%a.length],C(i);break;case"Home":e.preventDefault(),C(a[0]);break;case"End":e.preventDefault(),C(a[a.length-1])}})(e,t),disabled:r,children:e.jsxs(e.Fragment,a?{children:[e.jsx("span",{className:"material-icons nav-link--icon__symbol",children:s.icon}),e.jsx("span",{className:"nav-link--icon__label",children:s.shortLabel})]}:{children:[r&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"tab-loading-spinner","aria-hidden":"true"}),e.jsxs("span",{className:"visually-hidden",children:["Caricamento ",s.label,"..."]})]}),!r&&s.label]})})},t)};return e.jsxs(e.Fragment,{children:[e.jsx(E,{ref:f,className:"visually-hidden",politeness:"polite"}),e.jsxs("div",{ref:b,id:r,className:`nav nav-tabs ${o} ${v?"nav-tabs--compact":""}`,role:"tablist","aria-label":"ModalitÃ  visualizzazione grafici",children:[x("filtered",v),x("comparison",v),x("analysis",v)]})]})});T.displayName="ViewModeTabs";const O=o;class S{async fetchChartData(e){try{n.debug("Fetching filtered chart data from Supabase",{filters:e});let t=O.from("pazienti").select("diagnosi");e.dateRange?.startDate&&(t=t.gte("data_ricovero",e.dateRange.startDate)),e.dateRange?.endDate&&(t=t.lte("data_ricovero",e.dateRange.endDate)),e.repartoAppartenenza&&(t=t.eq("reparto_appartenenza",e.repartoAppartenenza)),e.repartoProvenienza&&(t=t.eq("reparto_provenienza",e.repartoProvenienza)),e.diagnosi&&(t=t.eq("diagnosi",e.diagnosi)),e.livelloAssistenza&&(t=t.eq("livello_assistenza",e.livelloAssistenza)),null!=e.infetto&&(t=t.eq("infetto",e.infetto));const{data:a,error:s}=await t;if(s)throw n.error("Error fetching filtered chart data from Supabase",s),new Error("Impossibile caricare i dati filtrati");const i={};a.forEach(e=>{e.diagnosi&&(i[e.diagnosi]=(i[e.diagnosi]||0)+1)});const r=Object.keys(i),o=Object.values(i),l=this.generateColors(r.length),c=l.map(e=>this.darkenColor(e,20)),d={labels:r,datasets:[{label:"Diagnosi",data:o,backgroundColor:l,borderColor:c,borderWidth:1}],totalRecords:o.reduce((e,t)=>e+t,0),aggregationType:"diagnosis",filters:e,generatedAt:new Date};return n.debug("Filtered chart data fetched successfully from Supabase",{recordCount:d.totalRecords,diagnosesCount:d.labels.length}),d}catch(t){throw n.error("Error fetching filtered chart data",t),new Error("Impossibile caricare i dati filtrati")}}async fetchPatientStats(e){try{n.debug("Fetching patient statistics (delegated to centralized service)",{filters:e});const t=await d.getFilteredPatientCount(e),a=await d.getSurgicalPatientCount(e),s=await d.getInfectedPatientCount(e);return n.debug("Patient statistics fetched successfully",{filteredPatientsCount:t,surgicalCount:a,infectedCount:s}),{filteredPatientsCount:t,surgicalCount:a,infectedCount:s}}catch(t){throw n.error("Error fetching patient statistics",t),new Error("Impossibile caricare le statistiche pazienti")}}async formatForDisplay(e,t,a){if(!e||!e.labels||0===e.labels.length)throw new Error("No chart data to format for display");let s=this.getStatistics(e);if(a)try{const e=await this.fetchPatientStats(a);s={...s,filteredPatientsCount:e.filteredPatientsCount,surgicalCount:e.surgicalCount,infectedCount:e.infectedCount}}catch(o){n.warn("Could not fetch additional patient statistics",o)}const i={type:t,data:{labels:e.labels,datasets:e.datasets.map(e=>({label:e.label,data:e.data,backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:e.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:t===N.PIE,position:"right"},tooltip:{callbacks:{label:e=>{const t=e.label||"",a="number"==typeof e.parsed?e.parsed:e.parsed?.y??0;return`${t}: ${a} (${(a/e.dataset.data.reduce((e,t)=>e+t,0)*100).toFixed(1)}%)`}}}},scales:t!==N.PIE?{y:{beginAtZero:!0,title:{display:!0,text:"Numero Pazienti"}},x:{title:{display:!0,text:"Diagnosi"}}}:void 0}},r=this.generateSuggestions(e,t);return{chartConfig:i,statistics:s,suggestions:r.length>0?{suggestNarrowing:!0,suggestions:r}:void 0}}getStatistics(e){if(!e||!e.datasets||0===e.datasets.length)return{totalPatients:0,uniqueDiagnoses:0};return{totalPatients:e.datasets.reduce((e,t)=>e+t.data.reduce((e,t)=>e+t,0),0),uniqueDiagnoses:e.labels.length}}generateColors(e){const t=["#0d6efd","#dc3545","#198754","#ffc107","#fd7e14","#6f42c1","#20c997","#6c757d","#0dcaf0","#d63384"],a=[];for(let s=0;s<e;s++)a.push(t[s%t.length]);return a}darkenColor(e,t){return e+"CC"}generateSuggestions(e,t){const a=[],s=e.labels.length;return e.totalRecords>100&&a.push("Considera di restringere il range di date per visualizzare meno dati"),s>10&&a.push("Prova a filtrare per diagnosi specifiche per risultati piÃ¹ chiari"),t===N.PIE&&s>8&&a.push("Per molti dati, il grafico a barre potrebbe essere piÃ¹ leggibile"),t===N.BAR&&s>15&&a.push("Considera di raggruppare alcune diagnosi simili"),a}}class F{async fetchChartData(e){try{n.debug("Fetching comparison chart data from Supabase",{filters:e});let t=O.from("pazienti").select("reparto_appartenenza");e.dateRange?.startDate&&(t=t.gte("data_ricovero",e.dateRange.startDate)),e.dateRange?.endDate&&(t=t.lte("data_ricovero",e.dateRange.endDate)),e.repartoAppartenenza&&(t=t.eq("reparto_appartenenza",e.repartoAppartenenza)),e.repartoProvenienza&&(t=t.eq("reparto_provenienza",e.repartoProvenienza)),e.diagnosi&&(t=t.eq("diagnosi",e.diagnosi)),e.livelloAssistenza&&(t=t.eq("livello_assistenza",e.livelloAssistenza)),null!=e.infetto&&(t=t.eq("infetto",e.infetto));const{data:a,error:s}=await t;if(s)throw n.error("Error fetching comparison chart data from Supabase",s),new Error("Impossibile caricare i dati comparativi");const i={};a.forEach(e=>{e.reparto_appartenenza&&(i[e.reparto_appartenenza]=(i[e.reparto_appartenenza]||0)+1)});const r=Object.keys(i),o=Object.values(i),l=this.generateColors(r.length),c=l.map(e=>this.darkenColor(e,20)),d={labels:r,datasets:[{label:"Reparti",data:o,backgroundColor:l,borderColor:c,borderWidth:1}],totalRecords:o.reduce((e,t)=>e+t,0),aggregationType:"department",filters:e,generatedAt:new Date};return n.debug("Comparison chart data fetched successfully from Supabase",{recordCount:d.totalRecords,departmentsCount:d.labels.length}),d}catch(t){throw n.error("Error fetching comparison chart data",t),new Error("Impossibile caricare i dati comparativi")}}async formatForDisplay(e,t,a){if(!e||!e.labels||0===e.labels.length)throw new Error("No chart data to format for display");let s=this.getStatistics(e);if(a)try{const e=await I.fetchPatientStats(a);s={...s,filteredPatientsCount:e.filteredPatientsCount,surgicalCount:e.surgicalCount,infectedCount:e.infectedCount}}catch(o){n.warn("Could not fetch additional patient statistics",o)}const i=this.generateInsights(e,t),r=this.performStatisticalAnalysis(e);return{chartConfig:{type:t,data:{labels:e.labels,datasets:e.datasets.map(e=>({label:e.label,data:e.data,backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:e.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:t===N.PIE,position:"right"},tooltip:{callbacks:{label:e=>{const t=e.label||"",a="number"==typeof e.parsed?e.parsed:e.parsed?.y??0;return`${t}: ${a} (${(a/e.dataset.data.reduce((e,t)=>e+t,0)*100).toFixed(1)}%)`}}}},scales:t!==N.PIE?{y:{beginAtZero:!0,title:{display:!0,text:"Numero Pazienti"}},x:{title:{display:!0,text:"Reparto"}}}:void 0}},statistics:s,insights:i,analysis:r}}getStatistics(e){if(!e||!e.datasets||0===e.datasets.length)return{totalPatients:0,totalDepartments:0};return{totalPatients:e.datasets.reduce((e,t)=>e+t.data.reduce((e,t)=>e+t,0),0),totalDepartments:e.labels.length}}generateInsights(e,t){const a=[],s=e.datasets[0].data,i=e.labels,r=Math.max(...s),n=Math.min(...s),o=s.indexOf(r),l=s.indexOf(n);a.push(`${i[o]} ha il maggior numero di pazienti (${r})`),a.push(`${i[l]} ha il minor numero di pazienti (${n})`);const c=s.reduce((e,t)=>e+t,0)/s.length;a.push(`La media dei pazienti per reparto Ã¨ ${c.toFixed(1)}`);const d=s.filter(e=>e>c).length;return a.push(`${d} reparti sono sopra la media`),a}performStatisticalAnalysis(e){const t=e.datasets[0].data,a=t.reduce((e,t)=>e+t,0)/t.length,s=t.map(e=>Math.pow(e-a,2)).reduce((e,t)=>e+t,0)/t.length,i=Math.sqrt(s),r=2*i,n=[];return t.forEach((t,s)=>{Math.abs(t-a)>r&&n.push(e.labels[s])}),{statistics:{mean:a.toFixed(1),stdDev:i.toFixed(1)},hasOutliers:n.length>0,outliers:n}}generateColors(e){const t=["#0d6efd","#dc3545","#198754","#ffc107","#fd7e14","#6f42c1","#20c997","#6c757d","#0dcaf0","#d63384"],a=[];for(let s=0;s<e;s++)a.push(t[s%t.length]);return a}darkenColor(e,t){return e+"CC"}}const I=new S,P=new F,L={filtered:I,comparison:P};async function $(){try{const[e,t,a,s]=await Promise.all([u(),p(),g(),m()]),i=b(a);return n.debug("Filter options loaded successfully",{diagnosisCount:e.length,repartoCount:t.length,provenienzaCount:s.length}),{diagnosiOptions:e,repartoOptions:t,repartoProvenienzaOptions:s,infectionOptions:i}}catch(e){const t=e instanceof Error?e.message:"Errore nel caricamento delle opzioni di filtro";throw n.error(t,e),new Error(t)}}const B=({initialViewMode:a="filtered",initialChartType:s=N.PIE,initialFilters:i={}})=>{const[o,c]=t.useState(a),[d,u]=t.useState(s),[p,g]=t.useState(i),{diagnosiOptions:m,repartoOptions:b,repartoProvenienzaOptions:y,infectionOptions:_,isLoading:v,error:C}=(()=>{const{data:e,isLoading:t,error:a}=h({queryKey:["chartFilterOptions"],queryFn:$,initialData:{diagnosiOptions:[],repartoOptions:[],repartoProvenienzaOptions:[],infectionOptions:[{value:"",label:"Tutti"},{value:"true",label:"SÃ¬"},{value:"false",label:"No"}]}});return{diagnosiOptions:e.diagnosiOptions,repartoOptions:e.repartoOptions,repartoProvenienzaOptions:e.repartoProvenienzaOptions,infectionOptions:e.infectionOptions,isLoaded:!t,isLoading:t,error:a}})(),{canvasRef:w,chartData:x,statistics:j,suggestions:E,insights:k,isLoading:O,isError:S,errorMessage:F,fetchData:L}=((e,a,s)=>{const i=t.useRef(null),o=t.useRef(null);l();const{data:c,isLoading:d,isError:u,error:p,refetch:g}=h({queryKey:["chartData",e,a,s],queryFn:async()=>{const t={dateRange:{startDate:s.dateRange?.startDate||"",endDate:s.dateRange?.endDate||"",preset:s.dateRange?.preset||"custom"},repartoAppartenenza:s.repartoAppartenenza||"",repartoProvenienza:s.repartoProvenienza||"",diagnosi:s.diagnosi||"",livelloAssistenza:s.livelloAssistenza||null,infetto:void 0!==s.infetto?s.infetto:void 0};let l;if("filtered"===e)l=await I.fetchChartData(t);else{if("comparison"!==e)return null;l=await P.fetchChartData(t)}const c="filtered"===e?await I.formatForDisplay(l,a,t):await P.formatForDisplay(l,a,t);o.current&&(o.current.destroy(),o.current=null);const d=i.current;if(!d)throw new Error("Canvas non trovato per il rendering del grafico");return o.current=new r(d,c.chartConfig),n.info("Chart rendered successfully",{viewMode:e,chartType:a,recordCount:l.totalRecords}),{fetchedData:l,displayData:c}},enabled:"analysis"!==e,select:t=>{if(!t)return null;const{fetchedData:a,displayData:s}=t;let i=null,r=null;return"filtered"===e&&"suggestions"in s&&s.suggestions?i=s.suggestions.suggestions:"comparison"===e&&"insights"in s&&s.insights&&(r=s.insights),{chartData:a,statistics:s.statistics,suggestions:i,insights:r}}}),m=t.useCallback(()=>{o.current&&(o.current.destroy(),o.current=null)},[]);return t.useEffect(()=>()=>{m()},[m]),{canvasRef:i,chartData:c?.chartData??null,statistics:c?.statistics??null,suggestions:c?.suggestions??null,insights:c?.insights??null,isLoading:d,isError:u,errorMessage:p?.message??"",fetchData:g,cleanup:m}})(o,d,p),B=t.useCallback(e=>{c(e),"filtered"===e?u(N.PIE):"comparison"===e&&u(N.BAR)},[]),M=t.useCallback(e=>{u(e)},[]),q=t.useCallback(e=>{g(e)},[]),W=t.useCallback(()=>{g({dateRange:{startDate:"",endDate:"",preset:"custom"}})},[]),J=t.useCallback(async e=>{try{if(!x)throw new Error("Nessun grafico disponibile per l'esportazione");if(n.info("Chart export requested",{format:e}),"image"===e){const e=w.current;if(e){const t=e.toDataURL("image/png"),a=document.createElement("a");a.download=`chart-${Date.now()}.png`,a.href=t,a.click()}}else if("json"===e){const e=JSON.stringify(x,null,2),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),s=document.createElement("a");s.download=`chart-data-${Date.now()}.json`,s.href=a,s.click(),URL.revokeObjectURL(a)}}catch(t){n.error("Error exporting chart",t)}},[x,w]),H=t.useCallback(()=>{L()},[L]);return e.jsxs("div",{className:"charts-page-container",children:[e.jsx("div",{className:"charts-hero",children:e.jsxs("div",{className:"charts-hero-content",children:[e.jsx("h1",{className:"charts-title",children:"Grafici Pazienti"}),e.jsx("p",{className:"charts-subtitle",children:"Visualizza grafici, applica filtri avanzati ed esporta dati in vari formati."})]})}),j&&"analysis"!==o&&e.jsx(z,{filteredPatientsCount:j.filteredPatientsCount??0,surgicalCount:j.surgicalCount??0,infectedCount:j.infectedCount??0,isLoading:O}),e.jsx(T,{initialViewMode:a,onViewModeChange:B,containerId:"charts-view-mode-tabs"}),!v&&e.jsx(f,{viewMode:o,filters:p,diagnosiOptions:m,repartoOptions:b,repartoProvenienzaOptions:y,infectionOptions:_,onApplyFilters:q,onReset:W,onApplyClick:H}),"analysis"!==o&&e.jsx(A,{chartType:d,onChartTypeChange:M,hasData:!!x,onExport:J}),e.jsx("div",{className:"charts-container-wrapper",children:"analysis"===o?e.jsx(D,{filters:p,onAnalysisTypeChange:e=>n.debug("Analysis type changed:",e)}):e.jsxs(e.Fragment,{children:[x&&e.jsxs("div",{className:"charts-record-count",children:["Trovati ",x.totalRecords," record"]}),e.jsxs("div",{className:"charts-chart-wrapper",children:[e.jsx("canvas",{ref:w,className:"charts-canvas "+(O||S?"charts-canvas--hidden":"charts-canvas--visible"),"aria-label":`Grafico a ${d===N.PIE?"torta":d===N.BAR?"barre":"linee"} ${"filtered"===o?"delle diagnosi":"dei reparti"}`}),O||v?e.jsxs("div",{className:"charts-loading",children:[e.jsx("div",{className:"charts-spinner",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"charts-loading-text",children:"Caricamento dati in corso..."})]}):null,(()=>{if(!S&&!C)return null;const t=F||C?.message||"Errore sconosciuto";return e.jsxs("div",{className:"charts-error",children:[e.jsxs("svg",{className:"charts-error-icon",width:"80",height:"80",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"15"})]}),e.jsx("h5",{className:"charts-error-title",children:"Errore"}),e.jsx("p",{className:"charts-error-message",children:t}),e.jsx("button",{className:"btn btn-outline-primary charts-action-button",onClick:()=>L(),children:"Riprova"})]})})()]}),j&&e.jsx(R,{totalPatients:j.totalPatients,uniqueDiagnoses:j.uniqueDiagnoses,totalDepartments:j.totalDepartments}),E&&0!==E.length?e.jsx("div",{className:"charts-suggestions",children:e.jsxs("div",{className:"charts-alert info",role:"alert",children:[e.jsx("h6",{className:"charts-alert-title",children:"Suggerimenti:"}),e.jsx("ul",{className:"charts-alert-list",children:E.map((t,a)=>e.jsx("li",{children:t},a))})]})}):null,k&&0!==k.length?e.jsx("div",{className:"charts-insights",children:e.jsxs("div",{className:"charts-alert info",role:"alert",children:[e.jsx("h6",{className:"charts-alert-title",children:"Insights:"}),e.jsx("ul",{className:"charts-alert-list",children:k.map((t,a)=>e.jsx("li",{children:t},a))})]})}):null]})})]})};B.displayName="ChartsPage";export{B as ChartsPage,F as ComparisonChartDataService,S as FilteredChartDataService,L as chartDataService,P as comparisonChartService,w as demographicAnalysisService,I as filteredChartService,x as temporalAnalysisService};
