import{s as e,a as t}from"./index-DQxU47Fk.js";import{g as r,p as n}from"./helpers-Bkz1pB3K.js";import{_ as a}from"./supabase-AmyKTmiY.js";import i from"./CustomDatepicker-6By5cdaM.js";import{i as o,u as l}from"./CustomSelect-DfitD7K3.js";import{R as s,c,g as d,a as u,d as p,b as f}from"./chartjsService-hpVxDqbm.js";import"./vendor-BU6HxVpN.js";import"./utils-BtSsRyB2.js";async function m(){try{const[e,t,n]=await Promise.all([r("reparto_appartenenza"),r("reparto_provenienza"),r("diagnosi")]);return{repartoOptions:e,provenienzaOptions:t,diagnosiOptions:n}}catch(e){throw console.error("Errore nel recuperare le opzioni dei filtri:",e),new Error("Impossibile caricare le opzioni per i filtri.")}}const g=Object.freeze(Object.defineProperty({__proto__:null,getChartData:async function(t){let r=e.from("pazienti").select("diagnosi");t.reparto&&(r=r.eq("reparto_appartenenza",t.reparto)),t.provenienza&&(r=r.eq("reparto_provenienza",t.provenienza)),t.diagnosi&&(r=r.eq("diagnosi",t.diagnosi)),t.assistenza&&(r=r.eq("livello_assistenza",t.assistenza)),"true"===t.infetto&&(r=r.eq("infetto",!0)),"false"===t.infetto&&(r=r.eq("infetto",!1)),t.startDate&&(r=r.gte("data_ricovero",t.startDate)),t.endDate&&(r=r.lte("data_ricovero",t.endDate));const{data:n,error:a}=await r;if(a)throw console.error("Errore nel recuperare i dati del grafico:",a),new Error("Impossibile caricare i dati per il grafico.");return(n||[]).filter(e=>e&&"object"==typeof e&&e.diagnosi&&null!==e.diagnosi&&""!==String(e.diagnosi).trim())},getFilterOptionsForChart:m},Symbol.toStringTag,{value:"Module"}));let h=null,v=null,y="pie",z=null;const E={get chartContainer(){return document.getElementById("chart-container")},get chartControls(){return document.getElementById("chart-controls")},get chartTypeSelector(){return document.getElementById("chart-type-selector")},get chartExportBtn(){return document.getElementById("chart-export-btn")},get chartShareBtn(){return document.getElementById("chart-share-btn")},get repartoFilter(){return document.getElementById("filter-reparto")},get provenienzaFilter(){return document.getElementById("filter-provenienza")},get diagnosiFilter(){return document.getElementById("filter-diagnosi")},get assistenzaFilter(){return document.getElementById("filter-assistenza")},get infettoFilter(){return document.getElementById("filter-infetto")},get startDateFilter(){return document.getElementById("filter-start-date")},get endDateFilter(){return document.getElementById("filter-end-date")},get applyButton(){return document.getElementById("apply-filters-btn")},get resetButton(){return document.getElementById("reset-filters-btn")}};async function b(){try{const t=[{id:"chart-container",name:"Container del grafico"},{id:"filter-reparto",name:"Filtro reparto"},{id:"filter-provenienza",name:"Filtro provenienza"},{id:"filter-diagnosi",name:"Filtro diagnosi"}];for(const e of t)document.getElementById(e.id)||console.warn(`Elemento ${e.name} (${e.id}) non trovato nel DOM`);document.querySelector("#filter-reparto, #filter-provenienza, #filter-diagnosi, #filter-assistenza, #filter-infetto")&&o("#filter-reparto, #filter-provenienza, #filter-diagnosi, #filter-assistenza, #filter-infetto");if(document.querySelectorAll("[data-datepicker]").length>0&&(h=new i("[data-datepicker]",{dateFormat:"d/m/Y"})),z=new s,await async function(){await async function(){try{const e=await d();if(!E.chartTypeSelector){const t=document.querySelector(".filters-fieldset .row.mt-3 .col-12.d-flex.justify-content-center"),r=document.createElement("div");r.className="chart-type-selector-container ms-0 ms-md-3 mt-3 mt-md-0";const n=document.createElement("select");n.id="chart-type-selector",n.className="form-select form-select-sm",n.setAttribute("data-custom","true"),e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,t.setAttribute("data-icon",e.icon),n.appendChild(t)}),n.value=y,n.addEventListener("change",w),r.appendChild(n),t&&t.appendChild(r),o("#chart-type-selector"),setTimeout(()=>{l("#chart-type-selector")},100),document.addEventListener("chartTypeChange",C)}}catch(e){console.error("Errore nell'inizializzazione del selettore del tipo di grafico:",e)}}(),function(){const e=document.getElementById("chart-buttons-container");if(!e)return;const t=document.createElement("div");t.className="chart-export-buttons d-inline-flex gap-2";const r=document.createElement("button");r.id="chart-export-btn",r.className="btn btn-sm btn-outline-primary",r.innerHTML='<span class="material-icons">download</span> Esporta',r.addEventListener("click",F);const n=document.createElement("button");n.id="chart-share-btn",n.className="btn btn-sm btn-outline-secondary",n.innerHTML='<span class="material-icons">share</span> Condividi',n.addEventListener("click",I),t.appendChild(r),t.appendChild(n),e.appendChild(t)}()}(),E.chartContainer)try{z.adaptLayout(E.chartContainer)}catch(e){console.error("Errore nell'adattamento del layout:",e)}else console.warn("Container del grafico non trovato, impossibile adattare il layout");T()}catch(t){console.error("Errore nell'inizializzazione della UI del grafico:",t),k(`Errore nell'inizializzazione: ${t.message}`)}}function w(e){if(y=e.target.value,v){L(D())}}function C(e){const t=e.detail.direction,r=["pie","bar","line"],n=r.indexOf(y);let a;a="next"===t?(n+1)%r.length:0===n?r.length-1:n-1;const i=r[a];y=i;const o=E.chartTypeSelector;if(o&&(o.value=i,o.customSelectInstance?o.customSelectInstance.setValue(i):l("#chart-type-selector")),v){L(D())}}async function F(){if(!v)return alert("Nessun grafico da esportare. Genera prima un grafico."),void 0;try{const e=D(),t={timestamp:(new Date).toLocaleString(),filters:e};await p(v,"grafico-pazienti",t)}catch(e){console.error("Errore nell'esportazione del grafico:",e),alert(`Errore nell'esportazione: ${e.message}`)}}async function I(){if(!v)return alert("Nessun grafico da condividere. Genera prima un grafico."),void 0;try{const e=D(),t=await f(e,y);await navigator.clipboard.writeText(t),alert("Link copiato negli appunti!")}catch(e){console.error("Errore nella condivisione del grafico:",e),alert(`Errore nella condivisione: ${e.message}`)}}function B(){h&&(h.destroy(),h=null),document.removeEventListener("chartTypeChange",C),c(),v&&(v.destroy(),v=null)}function D(){return{reparto:E.repartoFilter.value,provenienza:E.provenienzaFilter.value,diagnosi:E.diagnosiFilter.value,assistenza:E.assistenzaFilter.value,infetto:E.infettoFilter.value,startDate:E.startDateFilter.value,endDate:E.endDateFilter.value}}function S(){["filter-reparto","filter-provenienza","filter-diagnosi","filter-assistenza","filter-infetto"].forEach(e=>{const t=document.getElementById(e);t&&(t.value="",t.customSelectInstance&&t.customSelectInstance.setValue(""))}),E.startDateFilter.value="",E.endDateFilter.value="",T()}async function x(e){if(!E.chartContainer)return console.error("Container del grafico non trovato"),null;if(!e||!Array.isArray(e))return console.warn("Dati non validi per il grafico:",e),_("Dati non validi per visualizzare il grafico."),null;const{labels:t,dataPoints:r}=function(e){if(!e||0===e.length)return{labels:[],dataPoints:[]};const t=new Map;return e.forEach(({diagnosi:e})=>{const r=e?String(e).trim():"Non specificata";r&&t.set(r,(t.get(r)||0)+1)}),{labels:Array.from(t.keys()),dataPoints:Array.from(t.values())}}(e);if(0===t.length)return _("Nessun dato valido per visualizzare il grafico."),null;const n={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!1,text:"",font:{size:18,weight:"bold"}},legend:{position:z&&"function"==typeof z.detectDevice&&"desktop"===z.detectDevice()?"right":"top",onHover:function(e,t,r){},onClick:function(e,t,r){}}}};"bar"===y&&(n.scales={y:{beginAtZero:!0,ticks:{precision:0}},x:{ticks:{maxRotation:45,minRotation:0}}},n.plugins.tooltip={enabled:!1});try{if(v)try{v.destroy()}catch(a){console.warn("Errore durante la distruzione del grafico precedente:",a)}if(v=await u(E.chartContainer,{labels:t,datasets:[{label:"Numero di Pazienti",data:r}]},n,y),z&&v)try{"function"==typeof z.handleResize&&z.handleResize(v,n),v.update()}catch(i){console.error("Errore durante l'adattamento del grafico:",i)}E.chartExportBtn&&(E.chartExportBtn.disabled=!1),E.chartShareBtn&&(E.chartShareBtn.disabled=!1);try{document.dispatchEvent(new CustomEvent("chartUpdated",{detail:{chart:v}}))}catch(o){console.warn("Errore durante la generazione dell'evento chartUpdated:",o)}return v}catch(l){return console.error("Errore durante la creazione del grafico:",l),k(`Errore nella visualizzazione del grafico: ${l.message}`),null}}async function L(e){void(E.chartContainer.innerHTML=t('<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>'));try{const{getChartData:t}=await a(async()=>{const{getChartData:e}=await Promise.resolve().then(()=>g);return{getChartData:e}},void 0),r=await t(e);await x(r)}catch(r){console.error("Errore nel ridisegno del grafico:",r);try{const e=[{diagnosi:"Influenza"},{diagnosi:"Polmonite"},{diagnosi:"Frattura"},{diagnosi:"Influenza"},{diagnosi:"Polmonite"},{diagnosi:"Frattura"},{diagnosi:"Infarto"},{diagnosi:"Ictus"},{diagnosi:"Diabete"}];await x(e)}catch(n){console.error("Errore anche con i dati di fallback:",n),k(`Errore nell'aggiornamento del grafico: ${r.message}`)}}}function T(){E.chartContainer.innerHTML=t('<p class="text-muted">Seleziona i filtri e clicca "Applica" per visualizzare il grafico.</p>')}function _(e){E.chartContainer.innerHTML=t(`<p class="text-muted">${e}</p>`)}function k(e){E.chartContainer.innerHTML=t(`<div class="alert alert-danger">${e}</div>`)}async function j(){const e=D();try{await L(e)}catch(t){k(t.message)}}async function O(){b();try{!function(e){n(E.repartoFilter,e.repartoOptions),l("#filter-reparto"),n(E.provenienzaFilter,e.provenienzaOptions),l("#filter-provenienza"),n(E.diagnosiFilter,e.diagnosiOptions),l("#filter-diagnosi"),E.infettoFilter&&(E.infettoFilter.innerHTML=t('\n            <option value="">Tutti</option>\n            <option value="true">Sì</option>\n            <option value="false">No</option>\n        '),l("#filter-infetto"))}(await m())}catch(e){console.error("Errore durante l'inizializzazione della vista grafico:",e),k(e.message||"Errore durante il caricamento dei filtri.")}return E.applyButton.addEventListener("click",j),void E.resetButton.addEventListener("click",S),B}export{O as initGraficoView};
