import{j as e,B as t,C as a,e as i,m as s}from"./shared-DM1owLfs.js";import{u as n}from"./useQuery-25yGgNuF.js";import{u as l}from"./index-BQsIu8x0.js";import{u as o}from"./useMutation-B5mVti9M.js";import{m as r,a as c,A as d,z as m}from"./core-services-CSrwUk3W.js";import{u as h}from"./react-vendor-DMMrM9kC.js";import{e as v}from"./patientService-BUKaJ6EC.js";import{P as u,E as p}from"./EventFormWizard-Bv1Dto_A.js";import"./PatientListPage---HZuWA-.js";/* empty css               */import{a as x,I as j}from"./InterventionForm-SHeRVJ6n.js";import"./ui-vendor-CKm97sqn.js";import"./supabase-D6dgNb7x.js";function g(e){const t=new Map;return e.forEach(e=>{t.set(e.id,e.nome)}),t}function b(e,t,a){if("intervento"===e.tipo_evento)return e.tipo_intervento_id&&t?.has(e.tipo_intervento_id)?t.get(e.tipo_intervento_id)||"-":e.tipo_intervento||"-";if("infezione"===e.tipo_evento){if(e.agente_patogeno_id&&a?.has(e.agente_patogeno_id)){const t=a.get(e.agente_patogeno_id)||"";return e.tipo_patogeno?`${t} (${e.tipo_patogeno})`:t}return e.tipo_batterio||"-"}return"-"}const N=r.memo(({event:t,patient:a,tipiInterventoMap:i,agentiPatogeniMap:s,onEdit:n,onDelete:l,onResolve:o})=>{const r="infezione"===t.tipo_evento;return e.jsx("div",{className:`card h-100 ${r?"border-danger":"border-success"}`,children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-2",children:[e.jsx("span",{className:"badge "+(r?"bg-danger":"bg-primary"),role:"status","aria-label":r?"Infezione":"Intervento",children:r?"Infezione":"Intervento"}),e.jsx("time",{dateTime:t.data_evento,className:"text-muted small",title:new Date(t.data_evento).toLocaleDateString("it-IT"),children:new Date(t.data_evento).toLocaleDateString("it-IT")})]}),e.jsx("h5",{className:"card-title mb-1",children:a?`${a.nome} ${a.cognome}`:t.paziente_id}),a?.codice_rad&&e.jsxs("div",{className:"small text-muted mb-2",children:[e.jsx("abbr",{title:"Codice RAD",children:"RAD"}),": ",a.codice_rad]}),e.jsxs("div",{className:"card-text",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Dettagli:"})," ","-"!==b(t,i,s)?b(t,i,s):"Nessun dettaglio"]}),t.note&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Note:"})," ",t.note]}),t.data_fine_evento&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Data fine:"})," ",e.jsx("time",{dateTime:t.data_fine_evento,title:new Date(t.data_fine_evento).toLocaleDateString("it-IT"),children:new Date(t.data_fine_evento).toLocaleDateString("it-IT")})]})]}),e.jsxs("div",{className:"d-flex gap-2",role:"group","aria-label":"Azioni evento",children:[e.jsx("button",{type:"button",className:"btn btn-secondary btn-sm",onClick:()=>n(t),"aria-label":`Modifica evento ${r?"infezione":"intervento"} del ${new Date(t.data_evento).toLocaleDateString("it-IT")}`,children:"Modifica"}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm",onClick:()=>l(t.id),"aria-label":`Elimina evento ${r?"infezione":"intervento"} del ${new Date(t.data_evento).toLocaleDateString("it-IT")}`,children:"Elimina"}),r&&!t.data_fine_evento&&e.jsx("button",{type:"button",className:"btn btn-success btn-sm",onClick:()=>o(t.id),"aria-label":"Segna infezione come risolta",children:"Risolvi"})]})]})})});N.displayName="EventCard";const f=({hasFilters:a,onCreateClick:i})=>e.jsxs("div",{className:"events-empty-state",role:"status","aria-live":"polite","aria-label":a?"Nessun evento corrisponde ai filtri selezionati":"Nessun evento clinico registrato",children:[e.jsx("div",{className:"empty-icon",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:a?"filter_list_off":"event_busy"})}),e.jsx("h3",{className:"empty-title",children:a?"Nessun evento trovato":"Nessun evento registrato"}),e.jsx("p",{className:"empty-description",children:a?"Nessun evento clinico corrisponde ai criteri di ricerca selezionati. Prova a modificare i filtri o a rimuovere alcuni di essi.":"Non hai ancora registrato alcun evento clinico per i pazienti. Inizia creando il primo evento."}),!a&&e.jsxs(t,{variant:"clinical",onClick:i,className:"mt-3","aria-label":"Crea il primo evento clinico",children:[e.jsx("span",{className:"material-icons me-1",children:"add"}),"Crea Primo Evento"]})]}),_=({count:t=5})=>e.jsx("div",{className:"skeleton-cards",children:[...Array(t)].map((t,a)=>e.jsx("div",{className:"skeleton-card card mb-3",children:e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"skeleton-text skeleton-title mb-3"}),e.jsx("div",{className:"skeleton-text skeleton-subtitle mb-2"}),e.jsx("div",{className:"skeleton-text skeleton-text-line mb-2"}),e.jsx("div",{className:"skeleton-text skeleton-text-line"}),e.jsxs("div",{className:"skeleton-buttons mt-3",children:[e.jsx("div",{className:"skeleton-button"}),e.jsx("div",{className:"skeleton-button"}),e.jsx("div",{className:"skeleton-button"})]})]})},a))}),z=({rows:t=5})=>e.jsx("div",{className:"skeleton-table",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})})]})}),e.jsx("tbody",{children:[...Array(t)].map((t,a)=>e.jsxs("tr",{className:"skeleton-row",children:[e.jsx("td",{children:e.jsx("div",{className:"skeleton-text"})}),e.jsx("td",{children:e.jsx("div",{className:"skeleton-text"})}),e.jsx("td",{children:e.jsx("div",{className:"skeleton-text skeleton-short"})}),e.jsx("td",{children:e.jsx("div",{className:"skeleton-text skeleton-medium"})}),e.jsxs("td",{children:[e.jsx("div",{className:"skeleton-badge"}),e.jsx("div",{className:"skeleton-badge"})]})]},a))})]})}),y={tipo_evento:[],paziente_id:void 0,paziente_search:"",data_inizio:void 0,data_fine:void 0};function k({initialFilters:e={},debounceMs:t=300,onFiltersChange:a,batchUpdateDelay:i=100}={}){const[s,n]=c.useState(()=>({...y,...e})),[l,o]=c.useState({}),[r,d]=c.useState(!1),[m,h]=c.useState(!1),v=c.useRef(),u=c.useRef(),p=c.useCallback(e=>{console.log("â±ï¸ applyFiltersWithDebounce called with:",e,"- will apply in",t,"ms"),h(!0),v.current&&clearTimeout(v.current),v.current=setTimeout(()=>{console.log("âœ… Debounce timeout fired! Applying filters:",e),n(e),h(!1),console.log("ðŸ“¢ Calling onFiltersChange callback"),a&&a(e)},t)},[t,a]),x=c.useCallback((e,t)=>{console.log("ðŸ”„ updateFilter called:",{key:e,value:t,currentValue:s[e]});const a={...s,[e]:t};console.log("ðŸ“¦ New filters object:",a),p(a)},[s,p]),j=c.useCallback(e=>{const t={...s,...e};p(t)},[s,p]),g=c.useCallback(e=>{n(e),a&&a(e)},[a]),b=c.useCallback(()=>{const t={...y,...e};p(t)},[e,p]);c.useCallback((e,t)=>{o(a=>({...a,[e]:t})),d(!0),u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{N()},i)},[i]);const N=c.useCallback(()=>{if(r){const e={...s,...l};p(e),o({}),d(!1),u.current&&clearTimeout(u.current)}},[s,l,r,p]),f=c.useCallback(()=>{o({}),d(!1),u.current&&clearTimeout(u.current)},[]);return c.useEffect(()=>()=>{v.current&&clearTimeout(v.current),u.current&&clearTimeout(u.current)},[]),{filters:s,pendingFilters:l,hasPendingChanges:r,updateFilter:x,updateFilters:j,setFilters:g,resetFilters:b,applyPendingFilters:N,discardPendingFilters:f,isDebouncing:m}}const C=["intervento","infezione"],S={intervento:"Intervento",infezione:"Infezione"},w=r.memo(({initialFilters:s,onFiltersChange:n,debounceMs:l=300,showQuickFilters:o=!0,showBatchControls:d=!1,compact:m=!1,compactToggleOverride:h})=>{console.log("ðŸŽ¯ DebouncedEventFilters RENDERED with initialFilters:",s),c.useRef(".debounced-event-filters");const{filters:v,hasPendingChanges:p,updateFilter:x,updateFilters:j,resetFilters:g,applyPendingFilters:b,discardPendingFilters:N,isDebouncing:f}=k({initialFilters:s,debounceMs:l,onFiltersChange:n}),[_,z]=c.useState(v.paziente_search||""),[y,w]=c.useState(v.data_inizio||""),[D,E]=c.useState(v.data_fine||""),[F,P]=c.useState(null),[I,T]=c.useState(!1);c.useEffect(()=>{z(v.paziente_search||""),w(v.data_inizio||""),E(v.data_fine||""),v.paziente_id||P(null)},[v]),c.useCallback(e=>{const t=e.target.value;z(t),x("paziente_search",t)},[x]);const M=c.useCallback(e=>{w(e||""),x("data_inizio",e||void 0)},[x]),R=c.useCallback(e=>{E(e||""),x("data_fine",e||void 0)},[x]),A=c.useCallback(e=>{x("tipo_evento",e?[e]:[])},[x]),$=c.useCallback(e=>{const t=new Date;let a,i;switch(t.setHours(0,0,0,0),e){case"today":a=i=t.toISOString().split("T")[0];break;case"week":const e=new Date(t);e.setDate(t.getDate()-7),a=e.toISOString().split("T")[0],i=t.toISOString().split("T")[0];break;case"month":const s=new Date(t);s.setDate(t.getDate()-30),a=s.toISOString().split("T")[0],i=t.toISOString().split("T")[0]}w(a),E(i),j({data_inizio:a,data_fine:i})},[j]),L=c.useCallback(()=>{g(),z(""),w(""),E("")},[g]),q=r.useMemo(()=>{let e=0;return v.paziente_search&&e++,v.tipo_evento&&v.tipo_evento.length>0&&e++,v.data_inizio&&e++,v.data_fine&&e++,e},[v]),O=c.useCallback(e=>{switch(e){case"paziente_search":x("paziente_id",void 0),z("");break;case"tipo_evento":x("tipo_evento",[]);break;case"data_inizio":M(null);break;case"data_fine":R(null)}},[x]);if(m){const s=Boolean(h),n=s?h.expanded:I;return e.jsxs("div",{className:"debounced-event-filters compact "+(n?"is-expanded":"is-collapsed"),children:[!s&&e.jsxs("div",{className:"filters-header-bar",children:[e.jsxs("div",{className:"filters-summary",children:[e.jsxs("button",{type:"button",className:"filters-toggle-btn",onClick:()=>{s?h.onToggle():T(e=>!e)},"aria-expanded":n,"aria-label":n?"Nascondi filtri":"Mostra filtri",children:[e.jsx("span",{className:"filters-toggle-icon material-icons","aria-hidden":"true",children:"filter_list"}),e.jsxs("span",{className:"filters-label",children:["Filtri ",q>0&&`(${q})`]}),e.jsx("span",{className:"filters-toggle-chevron material-icons","aria-hidden":"true",children:n?"expand_less":"expand_more"})]}),f&&e.jsx("span",{className:"spinner-border spinner-border-sm ms-2",role:"status","aria-label":"Caricamento filtri"})]}),q>0&&e.jsx(t,{variant:"link",size:"sm",onClick:L,className:"btn-reset-link",children:"Cancella tutto"})]}),q>0&&e.jsxs("div",{className:"active-filter-chips",hidden:!n,children:[v.paziente_search&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["Paziente: ",v.paziente_search]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>O("paziente_search"),"aria-label":"Rimuovi filtro paziente",children:"âœ•"})]}),v.tipo_evento&&v.tipo_evento.length>0&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["Tipo: ",v.tipo_evento.map(e=>S[e]).join(", ")]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>O("tipo_evento"),"aria-label":"Rimuovi filtro tipo evento",children:"âœ•"})]}),v.data_inizio&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["Da: ",v.data_inizio]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>O("data_inizio"),"aria-label":"Rimuovi filtro data inizio",children:"âœ•"})]}),v.data_fine&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["A: ",v.data_fine]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>O("data_fine"),"aria-label":"Rimuovi filtro data fine",children:"âœ•"})]})]}),n&&e.jsxs("div",{className:"filters-content",children:[s&&e.jsxs("div",{className:"filters-compact-actions d-flex justify-content-end align-items-center mb-2 gap-2",children:[f&&e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-label":"Caricamento filtri"}),q>0&&e.jsx(t,{variant:"link",size:"sm",onClick:L,className:"btn-reset-link",children:"Cancella tutto"})]}),e.jsxs("div",{className:"row g-2 align-items-end",children:[e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"patient-search-compact",className:"form-label",children:"Paziente"}),e.jsx(u,{value:F,onChange:e=>{P(e),x("paziente_id",e?e.id:void 0)},placeholder:"Cerca paziente per nome, cognome o codice...",className:"form-control form-control-sm"})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"event-type-compact",className:"form-label",children:"Tipo Evento"}),e.jsx(a,{id:"event-type-compact",value:v.tipo_evento?.[0]||"",options:[{value:"",label:"Tutti"},...C.map(e=>({value:e,label:S[e]}))],onChange:A,placeholder:"Tutti"})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{className:"form-label",children:"Periodo"}),e.jsx("div",{className:"date-range-expanded",children:e.jsx(i,{startDate:y,endDate:D,onStartDateChange:M,onEndDateChange:R,startLabel:"Data Inizio",endLabel:"Data Fine",startPlaceholder:"Data inizio",endPlaceholder:"Data fine",size:"sm",clearable:!0,allowInput:!0})})]})]})]})]})}return e.jsxs("div",{className:"debounced-event-filters",children:[o&&e.jsx("div",{className:"quick-filters mb-3",children:e.jsxs("div",{className:"btn-group",role:"group",children:[e.jsx(t,{variant:"outline-primary",size:"sm",onClick:()=>$("today"),children:"Oggi"}),e.jsx(t,{variant:"outline-primary",size:"sm",onClick:()=>$("week"),children:"Ultima settimana"}),e.jsx(t,{variant:"outline-primary",size:"sm",onClick:()=>$("month"),children:"Ultimo mese"})]})}),e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{htmlFor:"patient-search",className:"form-label",children:"Paziente"}),e.jsx(u,{value:F,onChange:e=>{P(e),x("paziente_id",e?e.id:void 0)},placeholder:"Cerca paziente per nome, cognome o codice...",className:"form-control"})]}),e.jsxs("div",{className:"col-md-2",children:[e.jsx("label",{htmlFor:"event-type",className:"form-label",children:"Tipo Evento"}),e.jsx(a,{id:"event-type",value:v.tipo_evento?.[0]||"",options:[{value:"",label:"Tutti"},...C.map(e=>({value:e,label:S[e]}))],onChange:A,placeholder:"Tutti",className:"form-control-sm"})]}),e.jsx("div",{className:"col-md-6",children:e.jsx(i,{startDate:y,endDate:D,onStartDateChange:M,onEndDateChange:R,startLabel:"Data Inizio",endLabel:"Data Fine",startPlaceholder:"gg/mm/aaaa",endPlaceholder:"gg/mm/aaaa",clearable:!0,allowInput:!0})})]}),d&&p&&e.jsx("div",{className:"batch-controls mt-3 p-2 bg-light rounded",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("small",{className:"text-muted",children:"Ci sono modifiche non applicate"}),e.jsxs("div",{className:"btn-group btn-group-sm",children:[e.jsx(t,{variant:"success",onClick:b,children:"Applica"}),e.jsx(t,{variant:"outline-secondary",onClick:N,children:"Annulla"})]})]})}),e.jsxs("div",{className:"filter-actions mt-3 d-flex justify-content-end",children:[f&&e.jsx("div",{className:"debouncing-indicator me-2",children:e.jsx("div",{className:"spinner-border spinner-border-sm",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Aggiornamento filtri..."})})}),e.jsx(t,{variant:"outline-secondary",onClick:L,disabled:0===q,children:"Resetta Filtri"})]})]})}),D=({statistics:t,loading:a})=>a?e.jsx("div",{className:"patient-stats-grid",children:[...Array(4)].map((t,a)=>e.jsxs("div",{className:"patient-stat-card is-loading",children:[e.jsx("div",{className:"stat-icon"}),e.jsx("div",{className:"stat-value"}),e.jsx("div",{className:"stat-label"})]},a))}):e.jsxs("div",{className:"patient-stats-grid",children:[e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"timeline"})}),e.jsx("div",{className:"stat-value",children:t.total}),e.jsx("div",{className:"stat-label",children:"Totale Eventi"})]}),e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"healing"})}),e.jsx("div",{className:"stat-value",children:t.interventi}),e.jsx("div",{className:"stat-label",children:"Interventi"})]}),e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"bug_report"})}),e.jsx("div",{className:"stat-value",children:t.infezioni}),e.jsx("div",{className:"stat-label",children:"Infezioni"})]}),e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"date_range"})}),e.jsx("div",{className:"stat-value",children:t.ultimoMese}),e.jsx("div",{className:"stat-label",children:"Nell'ultimo mese"})]})]}),E=({events:t,patients:a,loading:i,hasFilters:s=!1,onEdit:n,onDelete:l,onResolve:o,onCreateEvent:r,tipiInterventoMap:c,agentiPatogeniMap:d,currentPage:m,totalPages:h,totalCount:v,onPageChange:u})=>i?e.jsx(_,{count:10}):0===t.length?e.jsx(f,{hasFilters:s,onCreateClick:r||(()=>{})}):e.jsxs("div",{className:"virtualized-event-list",children:[e.jsx("div",{className:"mb-2 d-flex justify-content-between align-items-center",children:e.jsxs("div",{className:"text-muted small",children:["Visualizzazione ottimizzata: ",t.length," eventi"]})}),e.jsx("div",{className:"row",children:t.map(t=>{const i=a.get(t.paziente_id);return e.jsx("div",{className:"col-12 col-md-6 col-lg-4 mb-3",children:e.jsx(N,{event:t,patient:i,tipiInterventoMap:c,agentiPatogeniMap:d,onEdit:n,onDelete:l,onResolve:o})},t.id)})}),t.length>0&&"number"==typeof m&&"number"==typeof h&&u?e.jsx("nav",{"aria-label":"Paginazione eventi clinici",className:"mt-3",children:e.jsxs("div",{className:"d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2",children:[e.jsxs("div",{className:"text-muted small text-center text-sm-start",role:"status","aria-live":"polite","aria-atomic":"true",children:["Pagina ",m," di ",h," â€¢ ",v??t.length," eventi totali"]}),e.jsxs("div",{className:"d-flex gap-2",role:"group","aria-label":"Navigazione pagine",children:[e.jsxs("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>u(Math.max(1,m-1)),disabled:m<=1,"aria-label":`Vai alla pagina precedente (attualmente a pagina ${m} di ${h})`,"aria-pressed":!1,children:[e.jsx("span",{className:"material-icons me-1 align-middle","aria-hidden":"true",children:"chevron_left"}),"Precedente"]}),e.jsxs("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>u(Math.min(h,m+1)),disabled:m>=h,"aria-label":`Vai alla pagina successiva (attualmente a pagina ${m} di ${h})`,"aria-pressed":!1,children:["Successivo",e.jsx("span",{className:"material-icons ms-1 align-middle","aria-hidden":"true",children:"chevron_right"})]})]})]})}):t.length>0&&e.jsx("div",{className:"text-center mt-3",children:e.jsxs("div",{className:"text-muted small",children:[t.length," eventi totali"]})})]}),F=({events:a,patients:i,loading:s,hasFilters:n=!1,onEdit:l,onDelete:o,onResolve:r,onCreateEvent:c,currentPage:d,totalPages:m,pageSize:h,onPageChange:v,onPageSizeChange:u,tipiInterventoMap:p,agentiPatogeniMap:x})=>s?e.jsx(z,{rows:h}):0===a.length?e.jsx(f,{hasFilters:n,onCreateClick:c||(()=>{})}):e.jsxs("div",{className:"virtualized-events-table",children:[e.jsxs("div",{className:"mb-2 d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"text-muted small",children:["Visualizzazione ottimizzata: ",a.length," eventi"]}),e.jsx("div",{children:e.jsx("select",{value:h,onChange:e=>u(Number(e.target.value)),className:"form-select form-select-sm",style:{width:"auto"},children:[10,20,50,100].map(t=>e.jsxs("option",{value:t,children:["Mostra ",t]},t))})})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-striped table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Paziente"}),e.jsx("th",{children:"Tipo Evento"}),e.jsx("th",{children:"Data"}),e.jsx("th",{children:"Dettagli"}),e.jsx("th",{children:"Azioni"})]})}),e.jsx("tbody",{children:a.map(a=>{const s=i.get(a.paziente_id),n=s&&s.eventi_clinici?.some(e=>"infezione"===e.tipo_evento&&!e.data_fine_evento);return e.jsxs("tr",{className:`event-row ${n?"event-row-infected-patient":""}`,title:n?"Evento di paziente con infezione attiva":void 0,children:[e.jsx("td",{children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("div",{className:"fw-semibold",children:s?`${s.nome} ${s.cognome}`:a.paziente_id}),s?.codice_rad&&e.jsxs("div",{className:"small text-muted",children:["RAD: ",s.codice_rad]}),n&&e.jsxs("div",{className:"small text-danger",children:[e.jsx("span",{className:"material-icons fs-6 me-1",style:{verticalAlign:"middle"},children:"coronavirus"}),"Infezione Attiva"]})]})}),e.jsx("td",{children:e.jsx("span",{className:"badge "+("intervento"===a.tipo_evento?"bg-primary":"bg-danger"),children:"intervento"===a.tipo_evento?"Intervento":"Infezione"})}),e.jsx("td",{children:e.jsx("div",{className:"text-nowrap",children:new Date(a.data_evento).toLocaleDateString("it-IT")})}),e.jsx("td",{children:b(a,p,x)}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(t,{variant:"link",size:"sm",onClick:()=>l(a),title:"Modifica evento",className:"p-1",children:e.jsx("span",{className:"material-icons fs-5",children:"edit"})}),e.jsx(t,{variant:"link",size:"sm",onClick:()=>o(a.id),title:"Elimina evento",className:"p-1 text-danger",children:e.jsx("span",{className:"material-icons fs-5",children:"delete"})}),"infezione"===a.tipo_evento&&!a.data_fine_evento&&e.jsx(t,{variant:"link",size:"sm",onClick:()=>r(a.id),title:"Risolvi infezione",className:"p-1 text-success",children:e.jsx("span",{className:"material-icons fs-5",children:"check_circle"})})]})})]},a.id)})})]})}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-3",children:[e.jsxs("div",{className:"text-muted small",children:["Pagina ",d," di ",m," â€¢ ",a.length," eventi totali"]}),e.jsx("nav",{children:e.jsxs("ul",{className:"pagination pagination-sm mb-0",children:[e.jsx("li",{className:"page-item "+(1===d?"disabled":""),children:e.jsx("button",{className:"page-link",onClick:()=>v(d-1),disabled:1===d,children:e.jsx("span",{className:"material-icons",children:"chevron_left"})})}),[...Array(Math.min(5,m)).keys()].map(t=>{const a=t+1;let i=a;return m>5&&(i=d<=3?a:d>=m-2?m-4+a:d-2+a),e.jsx("li",{className:"page-item "+(d===i?"active":""),children:e.jsx("button",{className:"page-link",onClick:()=>v(i),children:i})},i)}),e.jsx("li",{className:"page-item "+(d===m?"disabled":""),children:e.jsx("button",{className:"page-link",onClick:()=>v(d+1),disabled:d===m,children:e.jsx("span",{className:"material-icons",children:"chevron_right"})})})]})})]})]}),P={intervento:"Intervento Chirurgico",infezione:"Infezione"},I=["intervento","infezione"],T=({event:t,patientId:a,onSubmit:i,onCancel:s,initialEventType:n,allowedTypes:l,isSubmitting:o=!1})=>{const[r,d]=c.useState(()=>{if(t?.tipo_evento)return t.tipo_evento;if(n&&(!l||l.includes(n)))return n;return(l||I)[0]}),[m,h]=c.useState(a),[v,p]=c.useState(null);c.useEffect(()=>{t?.tipo_evento&&d(t.tipo_evento)},[t?.tipo_evento]);const g=l||I,b=!t&&g.length>1,N=t||m;return e.jsxs("div",{className:"typed-event-form",children:[!t&&e.jsx("div",{className:"card mb-4",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("h5",{className:"card-title mb-3",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1.25rem",marginRight:"0.5rem",verticalAlign:"middle"},children:"person_search"}),"Seleziona Paziente"]}),e.jsx(u,{value:v,onChange:e=>{e?(h(e.id),p(e)):(h(""),p(null))},placeholder:"Cerca per nome, cognome o RAD...",disabled:o,activeOnly:!1,maxResults:10,minSearchLength:1,debounceDelay:300,showPatientInfo:!0,highlightMatch:!0}),m&&v&&e.jsxs("div",{className:"alert alert-success mt-2 mb-0",role:"alert",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"check_circle"}),"Paziente selezionato: ",e.jsxs("strong",{children:[v.cognome," ",v.nome]})]}),!m&&e.jsxs("div",{className:"alert alert-info mt-2 mb-0",role:"alert",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"info"}),"Seleziona un paziente per continuare"]})]})}),b&&N&&e.jsx("div",{className:"card mb-4",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"card-title mb-3",children:"Seleziona Tipo Evento"}),e.jsx("div",{className:"btn-group w-100",role:"group",children:g.map(t=>e.jsx("button",{type:"button",className:"btn "+(r===t?"btn-primary active":"btn-outline-primary"),onClick:()=>{d(t)},disabled:o,children:P[t]},t))}),e.jsx("div",{className:"mt-2 text-center",children:e.jsxs("small",{className:"text-muted",children:["Tipo selezionato: ",e.jsx("strong",{children:P[r]})]})})]})}),N&&e.jsx("intervento"===r?x:j,{event:t,patientId:m,onSubmit:i,onCancel:s,isSubmitting:o})]})},M=()=>{const a=h(),i=l(),r=c.useMemo(()=>{if("undefined"==typeof window)return!1;const e=window.innerWidth<992;return console.log("ðŸ“± Mobile detection:",{width:window.innerWidth,breakpoint:992,isMobile:e}),e},[]);c.useEffect(()=>{const e=document.documentElement.style.scrollBehavior;document.documentElement.style.scrollBehavior="auto",window.scrollTo(0,0);const t=setTimeout(()=>{window.scrollTo(0,0)},100),a=setTimeout(()=>{window.scrollTo(0,0),document.documentElement.style.scrollBehavior=e},300);return()=>{clearTimeout(t),clearTimeout(a),document.documentElement.style.scrollBehavior=e}},[]);const[u,x]=c.useState(1),[j,b]=c.useState(10),[N,f]=c.useState(!1),[_,z]=c.useState("create"),[y,C]=c.useState(null),[S,P]=c.useState(!1),[I,M]=c.useState({title:"",body:"",onConfirm:()=>{}}),[R,A]=c.useState(!r),$=c.useCallback(()=>{A(e=>!e)},[]),{filters:L,updateFilters:q}=k({onFiltersChange:()=>x(1)}),O=c.useMemo(()=>["eventi",JSON.stringify(L),u,j],[L,u,j]),{data:K,isLoading:B,error:Q}=n({queryKey:O,queryFn:()=>v.getAllEventi(L,{page:u,limit:j})}),{data:V,isLoading:W}=n({queryKey:["eventiStats"],queryFn:v.getEventiStats,initialData:{total:0,interventi:0,infezioni:0,ultimoMese:0}}),{data:Y}=n({queryKey:["tipiIntervento"],queryFn:v.getListaTipiIntervento}),{data:U}=n({queryKey:["agentiPatogeni"],queryFn:v.getListaAgentiPatogeno}),G=c.useMemo(()=>Y?g(Y):new Map,[Y]),H=c.useMemo(()=>U?g(U):new Map,[U]),{eventi:J=[],totalPages:X=1,totalCount:Z=0}=K||{},ee=c.useMemo(()=>{const e=new Map;return J.forEach(t=>{e.has(t.paziente_id)||e.set(t.paziente_id,t.pazienti)}),e},[J]),te=c.useMemo(()=>{let e=0;return(L.paziente_search||L.paziente_id)&&e++,L.tipo_evento&&L.tipo_evento.length>0&&e++,L.data_inizio&&e++,L.data_fine&&e++,e},[L]),ae={onSuccess:()=>{i.invalidateQueries({queryKey:["eventi"]}),i.invalidateQueries({queryKey:["eventiStats"]}),me()},onError:e=>{m(e.message||"Si Ã¨ verificato un errore")}},ie=o({mutationFn:e=>v.createEvento(e),...ae,onSuccess:()=>{d("Evento creato con successo"),ae.onSuccess()}}),se=o({mutationFn:e=>v.updateEvento(e.id,e.eventData),...ae,onSuccess:()=>{d("Evento aggiornato con successo"),ae.onSuccess()}}),ne=o({mutationFn:e=>v.deleteEvento(e),onSuccess:()=>{d("Evento eliminato con successo"),i.invalidateQueries({queryKey:["eventi"]}),i.invalidateQueries({queryKey:["eventiStats"]}),P(!1)},onError:ae.onError}),le=o({mutationFn:e=>v.resolveInfezione(e.id,e.dataFine),onSuccess:()=>{d("Infezione risolta con successo"),i.invalidateQueries({queryKey:["eventi"]}),P(!1)},onError:ae.onError}),oe=async e=>{"create"===_?await ie.mutateAsync(e):y&&await se.mutateAsync({id:y.id,eventData:e})},re=e=>{he("Conferma Eliminazione","Sei sicuro di voler eliminare questo evento?",()=>{ne.mutate(e)})},ce=e=>{const t=prompt("Inserisci la data di risoluzione (YYYY-MM-DD):");t&&he("Conferma Risoluzione",`Sei sicuro di voler risolvere l'infezione in data ${t}?`,()=>{le.mutate({id:e,dataFine:t})})},de=(e,t)=>{if(console.log("ðŸ”¥ handleOpenModal called:",{mode:e,event:t,isMobile:r}),"create"===e&&r)return a("/eventi-clinici/nuovo"),void 0;z(e),C(t||null),f(!0)},me=()=>{f(!1),C(null),z("create")};c.useEffect(()=>{N&&r&&requestAnimationFrame(()=>{window.scrollTo(0,0)})},[N,r]);const he=(e,t,a)=>{M({title:e,body:t,onConfirm:a}),P(!0)};return e.jsxs(e.Fragment,{children:[e.jsx(s,{...I,isOpen:S,onCancel:()=>P(!1)}),e.jsxs("div",{className:"clinical-events-page",children:[e.jsx("div",{className:"patient-list-hero clinical-hero",children:e.jsxs("div",{className:"patient-list-hero-content",children:[e.jsxs("h1",{className:"patient-list-title",children:[e.jsx("span",{className:"material-icons me-2",children:"timeline"}),"Eventi Clinici"]}),e.jsx("p",{className:"patient-list-subtitle",children:"Gestisci eventi clinici, filtra per tipo e data, esporta i risultati"})]})}),Q&&e.jsx("div",{className:"alert alert-danger",children:"Errore nel caricamento degli eventi. Riprova."}),e.jsx(D,{statistics:V,loading:W}),e.jsxs("section",{className:"patient-filters-card"+(r?" clinical-filters-collapsible":""),children:[e.jsxs("div",{className:"patient-filters-header",children:[e.jsxs("div",{className:"filters-title-wrapper",children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"filter_list"}),e.jsx("h2",{className:"filters-title",children:"Filtri Eventi"}),r&&te>0&&e.jsx("span",{className:"filters-active-count","aria-label":`${te} filtri attivi`,children:te})]}),r&&e.jsx("button",{type:"button",className:"filters-collapse-toggle",onClick:$,"aria-expanded":R,"aria-controls":"clinical-event-filters","aria-label":R?"Nascondi filtri eventi clinici":"Mostra filtri eventi clinici",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:R?"expand_less":"expand_more"})})]}),e.jsx("div",{className:"patient-filters-body",id:"clinical-event-filters",hidden:r&&!R,children:e.jsx(w,{initialFilters:L,onFiltersChange:q,compact:r,compactToggleOverride:r?{expanded:R,onToggle:$}:void 0})})]}),e.jsxs("section",{className:"patient-results-card",children:[e.jsx("div",{className:"patient-results-header",children:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%"},children:[e.jsxs("h2",{className:"results-title",children:[e.jsx("span",{className:"material-icons",children:"list"}),"Eventi (",Z,")"]}),e.jsxs(t,{variant:"clinical",onClick:()=>de("create"),className:"btn-nuovo-evento",style:{padding:"0.65rem 1.5rem",fontSize:"1rem",fontWeight:"600",whiteSpace:"nowrap"},children:[e.jsx("span",{className:"material-icons align-middle",style:{marginRight:"0.5rem",fontSize:"1.3rem"},children:"add"}),"Nuovo Evento"]})]})}),e.jsx("div",{className:"patient-results-body",children:r?e.jsx(E,{events:J,patients:ee,loading:B,hasFilters:te>0,onEdit:e=>de("edit",e),onDelete:re,onResolve:ce,onCreateEvent:()=>de("create"),tipiInterventoMap:G,agentiPatogeniMap:H,currentPage:u,totalPages:X,totalCount:Z,onPageChange:x}):e.jsx(F,{events:J,patients:ee,loading:B,hasFilters:te>0,onEdit:e=>de("edit",e),onDelete:re,onResolve:ce,onCreateEvent:()=>de("create"),currentPage:u,totalPages:X,pageSize:j,onPageChange:x,onPageSizeChange:b,tipiInterventoMap:G,agentiPatogeniMap:H})})]}),N&&r&&e.jsx("div",{className:"event-wizard-mobile-overlay",children:e.jsx(p,{patientId:y?.paziente_id||"",event:y||void 0,onSubmit:oe,onCancel:me})}),N&&!r&&e.jsx("div",{className:"modal fade show",style:{display:"block"},tabIndex:-1,children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"modal-title mb-1",children:"create"===_?"Nuovo Evento":"Modifica Evento"}),y&&ee.get(y.paziente_id)&&e.jsxs("p",{className:"text-muted mb-0 small",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"person"}),ee.get(y.paziente_id)?.cognome," ",ee.get(y.paziente_id)?.nome]})]}),e.jsx("button",{type:"button",className:"btn-close",onClick:me})]}),e.jsx("div",{className:"modal-body",children:e.jsx(T,{event:y||void 0,patientId:y?.paziente_id||"",onSubmit:oe,onCancel:me,isSubmitting:ie.isPending||se.isPending})})]})})})]}),"    "]})};export{M as EventsPage,M as default};
