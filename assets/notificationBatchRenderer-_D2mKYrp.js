class t{constructor(t={}){this.options={batchSize:10,renderDelay:16,maxConcurrentAnimations:5,useDocumentFragment:!0,...t},this.renderQueue=[],this.animationQueue=[],this.isRendering=!1,this.frameId=null,this.init()}init(){this.processRenderQueue=this.processRenderQueue.bind(this),this.processAnimationQueue=this.processAnimationQueue.bind(this)}queueNotifications(t){Array.isArray(t)||(t=[t]),t.forEach(t=>{const e={notification:t,priority:this.calculatePriority(t),timestamp:Date.now(),retries:0};this.renderQueue.push(e)}),this.renderQueue.sort((t,e)=>e.priority-t.priority),this.isRendering||this.startRendering()}calculatePriority(t){let e=0;return e+={error:100,warning:75,success:50,info:25}[t.type]||0,t.persistent&&(e+=50),t.actions&&t.actions.length>0&&(e+=25),e}startRendering(){this.isRendering||(this.isRendering=!0,this.scheduleNextRender())}scheduleNextRender(){this.frameId&&cancelAnimationFrame(this.frameId),this.frameId=requestAnimationFrame(()=>{this.processRenderQueue(),this.renderQueue.length>0?setTimeout(()=>{this.scheduleNextRender()},this.options.renderDelay):this.isRendering=!1})}processRenderQueue(){if(0===this.renderQueue.length)return;const t=this.renderQueue.splice(0,this.options.batchSize);try{this.renderBatch(t)}catch(e){console.error("Errore rendering batch notifiche:",e),t.forEach(t=>{t.retries<3&&(t.retries++,this.renderQueue.push(t))})}}renderBatch(t){if(0===t.length)return;const e=this.options.useDocumentFragment?document.createDocumentFragment():null,i=[];if(t.forEach(t=>{try{const n=this.renderSingleNotification(t.notification);n&&(e&&e.appendChild(n),i.push({element:n,notification:t.notification}))}catch(n){console.error("Errore rendering singola notifica:",n)}}),e&&i.length>0){const t=this.getNotificationContainer();t&&t.appendChild(e)}this.queueAnimations(i)}renderSingleNotification(t){const e=document.createElement("div");return e.className=`notification notification--${t.type}`,e.setAttribute("role","error"===t.type?"alert":"status"),e.setAttribute("aria-atomic","true"),e.setAttribute("data-notification-id",t.id),e.style.cssText="\n            opacity: 0;\n            transform: translateX(100%);\n            transition: none;\n        ",e.innerHTML=this.generateNotificationHTML(t),this.attachEventListeners(e,t),e}generateNotificationHTML(t){const e={success:"check_circle",error:"error",warning:"warning",info:"info"}[t.type]||"info",i=this.escapeHtml(t.message),n=t.timestamp?this.formatTimestamp(t.timestamp):"";let s="";return t.actions&&t.actions.length>0&&(s=`\n                <div class="notification__custom-actions">\n                    ${t.actions.map(t=>`\n                        <button class="notification__action notification__action--${t.style||"secondary"}" \n                                data-action="${t.id||"custom"}">\n                            ${this.escapeHtml(t.label)}\n                        </button>\n                    `).join("")}\n                </div>\n            `),`\n            <div class="notification__content">\n                <span class="notification__icon material-icons">${e}</span>\n                <div class="notification__body">\n                    <div class="notification__message">${i}</div>\n                    ${n?`<div class="notification__timestamp">${n}</div>`:""}\n                </div>\n            </div>\n            ${s}\n            <div class="notification__actions">\n                <button class="notification__close" aria-label="Chiudi notifica" data-action="close">\n                    <span class="material-icons">close</span>\n                </button>\n            </div>\n            ${!t.persistent&&t.duration>0?'\n                <div class="notification__progress" aria-hidden="true">\n                    <div class="notification__progress-bar"></div>\n                </div>\n            ':""}\n        `}attachEventListeners(t,e){const i=t.querySelector('[data-action="close"]');i&&i.addEventListener("click",i=>{i.preventDefault(),this.removeNotification(t,e)});t.querySelectorAll(".notification__action").forEach(i=>{i.addEventListener("click",n=>{n.preventDefault();const s=i.getAttribute("data-action");this.handleCustomAction(s,e,t)})}),!e.persistent&&e.duration>0&&(t.addEventListener("mouseenter",()=>{this.pauseTimer(e.id)}),t.addEventListener("mouseleave",()=>{this.resumeTimer(e.id)}),t.addEventListener("focusin",()=>{this.pauseTimer(e.id)}),t.addEventListener("focusout",()=>{this.resumeTimer(e.id)}))}queueAnimations(t){t.forEach(({element:t,notification:e})=>{this.animationQueue.push({element:t,notification:e,type:"entrance",timestamp:Date.now()})}),this.processAnimationQueue()}processAnimationQueue(){const t=this.options.maxConcurrentAnimations,e=this.animationQueue.filter(t=>t.active);if(e.length>=t)return;this.animationQueue.filter(t=>!t.active).slice(0,t-e.length).forEach(t=>{t.active=!0,this.animateElement(t)})}animateElement(t){const{element:e,type:i}=t;"entrance"===i?this.animateEntrance(e,t):"exit"===i&&this.animateExit(e,t)}animateEntrance(t,e){t.offsetHeight,t.style.transition="opacity 0.3s ease-out, transform 0.3s ease-out",t.style.opacity="1",t.style.transform="translateX(0)",setTimeout(()=>{this.cleanupAnimation(e),!e.notification.persistent&&e.notification.duration>0&&this.startAutoCloseTimer(e.notification,t)},300)}animateExit(t,e){t.style.transition="opacity 0.3s ease-in, transform 0.3s ease-in",t.style.opacity="0",t.style.transform="translateX(100%)",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),this.cleanupAnimation(e)},300)}cleanupAnimation(t){const e=this.animationQueue.indexOf(t);-1!==e&&this.animationQueue.splice(e,1),setTimeout(()=>{this.processAnimationQueue()},50)}removeNotification(t,e){this.animationQueue.push({element:t,notification:e,type:"exit",timestamp:Date.now()}),this.processAnimationQueue(),this.notifyRemoval(e)}handleCustomAction(t,e,i){const n=e.actions?.find(e=>(e.id||"custom")===t);if(n&&"function"==typeof n.action)try{n.action(e,i)}catch(s){console.error("Errore esecuzione azione personalizzata:",s)}}startAutoCloseTimer(t,e){const i=setTimeout(()=>{this.removeNotification(e,t)},t.duration);e.setAttribute("data-timer-id",i)}pauseTimer(t){const e=document.querySelector(`[data-notification-id="${t}"]`);if(e){const t=e.getAttribute("data-timer-id");t&&(clearTimeout(parseInt(t)),e.setAttribute("data-timer-paused","true"))}}resumeTimer(t){const e=document.querySelector(`[data-notification-id="${t}"]`);if(e&&"true"===e.getAttribute("data-timer-paused")){e.removeAttribute("data-timer-paused");const i=this.getNotificationById(t);i&&this.startAutoCloseTimer(i,e)}}getNotificationContainer(){return document.querySelector(".notification-container")||document.querySelector("#notification-container")||document.body}getNotificationById(t){return null}notifyRemoval(t){const e=new CustomEvent("notification-removed",{detail:{notification:t}});document.dispatchEvent(e)}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}formatTimestamp(t){return new Date(t).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})}clear(){this.renderQueue=[],this.animationQueue=[],this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=null),this.isRendering=!1}pause(){this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=null),this.isRendering=!1}resume(){this.renderQueue.length>0&&!this.isRendering&&this.startRendering()}getStats(){return{queueLength:this.renderQueue.length,animationQueueLength:this.animationQueue.length,isRendering:this.isRendering,activeAnimations:this.animationQueue.filter(t=>t.active).length}}destroy(){this.clear(),this.renderQueue=null,this.animationQueue=null,this.options=null}}export{t as NotificationBatchRenderer,t as default};
