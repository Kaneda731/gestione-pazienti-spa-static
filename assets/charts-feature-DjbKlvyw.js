import{l as t,s as e}from"./core-services-BI3G_WoH.js";import{D as s,C as r,l as a,a as i,b as n,c as o,d as l}from"./shared-BGQg7biK.js";import{C as c}from"./charts-vendor-BWtMAC_w.js";function u(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function h(t){if(Object.prototype.hasOwnProperty.call(t,"__esModule"))return t;var e=t.default;if("function"==typeof e){var s=function t(){var s=!1;try{s=this instanceof t}catch{}return s?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};s.prototype=e.prototype}else s={};return Object.defineProperty(s,"__esModule",{value:!0}),Object.keys(t).forEach(function(e){var r=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(s,e,r.get?r:{enumerable:!0,get:function(){return t[e]}})}),s}var d,p,f,y,m={exports:{}},g={},b={exports:{}},v={};function _(){if(d)return v;d=1;var t=Symbol.for("react.element"),e=Symbol.for("react.portal"),s=Symbol.for("react.fragment"),r=Symbol.for("react.strict_mode"),a=Symbol.for("react.profiler"),i=Symbol.for("react.provider"),n=Symbol.for("react.context"),o=Symbol.for("react.forward_ref"),l=Symbol.for("react.suspense"),c=Symbol.for("react.memo"),u=Symbol.for("react.lazy"),h=Symbol.iterator;var p={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},f=Object.assign,y={};function m(t,e,s){this.props=t,this.context=e,this.refs=y,this.updater=s||p}function g(){}function b(t,e,s){this.props=t,this.context=e,this.refs=y,this.updater=s||p}m.prototype.isReactComponent={},m.prototype.setState=function(t,e){if("object"!=typeof t&&"function"!=typeof t&&null!=t)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,t,e,"setState")},m.prototype.forceUpdate=function(t){this.updater.enqueueForceUpdate(this,t,"forceUpdate")},g.prototype=m.prototype;var _=b.prototype=new g;_.constructor=b,f(_,m.prototype),_.isPureReactComponent=!0;var C=Array.isArray,w=Object.prototype.hasOwnProperty,R={current:null},O={key:!0,ref:!0,__self:!0,__source:!0};function x(e,s,r){var a,i={},n=null,o=null;if(null!=s)for(a in void 0!==s.ref&&(o=s.ref),void 0!==s.key&&(n=""+s.key),s)w.call(s,a)&&!O.hasOwnProperty(a)&&(i[a]=s[a]);var l=arguments.length-2;if(1===l)i.children=r;else if(1<l){for(var c=Array(l),u=0;u<l;u++)c[u]=arguments[u+2];i.children=c}if(e&&e.defaultProps)for(a in l=e.defaultProps)void 0===i[a]&&(i[a]=l[a]);return{$$typeof:t,type:e,key:n,ref:o,props:i,_owner:R.current}}function D(e){return"object"==typeof e&&null!==e&&e.$$typeof===t}var S=/\/+/g;function j(t,e){return"object"==typeof t&&null!==t&&null!=t.key?function(t){var e={"=":"=0",":":"=2"};return"$"+t.replace(/[=:]/g,function(t){return e[t]})}(""+t.key):e.toString(36)}function E(s,r,a,i,n){var o=typeof s;"undefined"!==o&&"boolean"!==o||(s=null);var l=!1;if(null===s)l=!0;else switch(o){case"string":case"number":l=!0;break;case"object":switch(s.$$typeof){case t:case e:l=!0}}if(l)return n=n(l=s),s=""===i?"."+j(l,0):i,C(n)?(a="",null!=s&&(a=s.replace(S,"$&/")+"/"),E(n,r,a,"",function(t){return t})):null!=n&&(D(n)&&(n=function(e,s){return{$$typeof:t,type:e.type,key:s,ref:e.ref,props:e.props,_owner:e._owner}}(n,a+(!n.key||l&&l.key===n.key?"":(""+n.key).replace(S,"$&/")+"/")+s)),r.push(n)),1;if(l=0,i=""===i?".":i+":",C(s))for(var c=0;c<s.length;c++){var u=i+j(o=s[c],c);l+=E(o,r,a,u,n)}else if(u=function(t){return null===t||"object"!=typeof t?null:"function"==typeof(t=h&&t[h]||t["@@iterator"])?t:null}(s),"function"==typeof u)for(s=u.call(s),c=0;!(o=s.next()).done;)l+=E(o=o.value,r,a,u=i+j(o,c++),n);else if("object"===o)throw r=String(s),Error("Objects are not valid as a React child (found: "+("[object Object]"===r?"object with keys {"+Object.keys(s).join(", ")+"}":r)+"). If you meant to render a collection of children, use an array instead.");return l}function A(t,e,s){if(null==t)return t;var r=[],a=0;return E(t,r,"","",function(t){return e.call(s,t,a++)}),r}function N(t){if(-1===t._status){var e=t._result;(e=e()).then(function(e){0!==t._status&&-1!==t._status||(t._status=1,t._result=e)},function(e){0!==t._status&&-1!==t._status||(t._status=2,t._result=e)}),-1===t._status&&(t._status=0,t._result=e)}if(1===t._status)return t._result.default;throw t._result}var T={current:null},P={transition:null},k={ReactCurrentDispatcher:T,ReactCurrentBatchConfig:P,ReactCurrentOwner:R};function F(){throw Error("act(...) is not supported in production builds of React.")}return v.Children={map:A,forEach:function(t,e,s){A(t,function(){e.apply(this,arguments)},s)},count:function(t){var e=0;return A(t,function(){e++}),e},toArray:function(t){return A(t,function(t){return t})||[]},only:function(t){if(!D(t))throw Error("React.Children.only expected to receive a single React element child.");return t}},v.Component=m,v.Fragment=s,v.Profiler=a,v.PureComponent=b,v.StrictMode=r,v.Suspense=l,v.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=k,v.act=F,v.cloneElement=function(e,s,r){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var a=f({},e.props),i=e.key,n=e.ref,o=e._owner;if(null!=s){if(void 0!==s.ref&&(n=s.ref,o=R.current),void 0!==s.key&&(i=""+s.key),e.type&&e.type.defaultProps)var l=e.type.defaultProps;for(c in s)w.call(s,c)&&!O.hasOwnProperty(c)&&(a[c]=void 0===s[c]&&void 0!==l?l[c]:s[c])}var c=arguments.length-2;if(1===c)a.children=r;else if(1<c){l=Array(c);for(var u=0;u<c;u++)l[u]=arguments[u+2];a.children=l}return{$$typeof:t,type:e.type,key:i,ref:n,props:a,_owner:o}},v.createContext=function(t){return(t={$$typeof:n,_currentValue:t,_currentValue2:t,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:i,_context:t},t.Consumer=t},v.createElement=x,v.createFactory=function(t){var e=x.bind(null,t);return e.type=t,e},v.createRef=function(){return{current:null}},v.forwardRef=function(t){return{$$typeof:o,render:t}},v.isValidElement=D,v.lazy=function(t){return{$$typeof:u,_payload:{_status:-1,_result:t},_init:N}},v.memo=function(t,e){return{$$typeof:c,type:t,compare:void 0===e?null:e}},v.startTransition=function(t){var e=P.transition;P.transition={};try{t()}finally{P.transition=e}},v.unstable_act=F,v.useCallback=function(t,e){return T.current.useCallback(t,e)},v.useContext=function(t){return T.current.useContext(t)},v.useDebugValue=function(){},v.useDeferredValue=function(t){return T.current.useDeferredValue(t)},v.useEffect=function(t,e){return T.current.useEffect(t,e)},v.useId=function(){return T.current.useId()},v.useImperativeHandle=function(t,e,s){return T.current.useImperativeHandle(t,e,s)},v.useInsertionEffect=function(t,e){return T.current.useInsertionEffect(t,e)},v.useLayoutEffect=function(t,e){return T.current.useLayoutEffect(t,e)},v.useMemo=function(t,e){return T.current.useMemo(t,e)},v.useReducer=function(t,e,s){return T.current.useReducer(t,e,s)},v.useRef=function(t){return T.current.useRef(t)},v.useState=function(t){return T.current.useState(t)},v.useSyncExternalStore=function(t,e,s){return T.current.useSyncExternalStore(t,e,s)},v.useTransition=function(){return T.current.useTransition()},v.version="18.3.1",v}function C(){return p||(p=1,b.exports=_()),b.exports}var w=(y||(y=1,m.exports=function(){if(f)return g;f=1;var t=C(),e=Symbol.for("react.element"),s=Symbol.for("react.fragment"),r=Object.prototype.hasOwnProperty,a=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function n(t,s,n){var o,l={},c=null,u=null;for(o in void 0!==n&&(c=""+n),void 0!==s.key&&(c=""+s.key),void 0!==s.ref&&(u=s.ref),s)r.call(s,o)&&!i.hasOwnProperty(o)&&(l[o]=s[o]);if(t&&t.defaultProps)for(o in s=t.defaultProps)void 0===l[o]&&(l[o]=s[o]);return{$$typeof:e,type:t,key:c,ref:u,props:l,_owner:a.current}}return g.Fragment=s,g.jsx=n,g.jsxs=n,g}()),m.exports),R=C();const O=u(R),x=function(t,e){for(var s=0;s<e.length;s++){const r=e[s];if("string"!=typeof r&&!Array.isArray(r))for(const e in r)if("default"!==e&&!(e in t)){const s=Object.getOwnPropertyDescriptor(r,e);s&&Object.defineProperty(t,e,s.get?s:{enumerable:!0,get:()=>r[e]})}}return Object.freeze(Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}))}({__proto__:null,default:O},[R]);var D=class{constructor(){this.listeners=new Set,this.subscribe=this.subscribe.bind(this)}subscribe(t){return this.listeners.add(t),this.onSubscribe(),()=>{this.listeners.delete(t),this.onUnsubscribe()}}hasListeners(){return this.listeners.size>0}onSubscribe(){}onUnsubscribe(){}},S={setTimeout:(t,e)=>setTimeout(t,e),clearTimeout:t=>clearTimeout(t),setInterval:(t,e)=>setInterval(t,e),clearInterval:t=>clearInterval(t)},j=new class{#t=S;#e=!1;setTimeoutProvider(t){this.#t=t}setTimeout(t,e){return this.#t.setTimeout(t,e)}clearTimeout(t){this.#t.clearTimeout(t)}setInterval(t,e){return this.#t.setInterval(t,e)}clearInterval(t){this.#t.clearInterval(t)}};var E="undefined"==typeof window||"Deno"in globalThis;function A(){}function N(t){return"number"==typeof t&&t>=0&&t!==1/0}function T(t,e){return Math.max(t+(e||0)-Date.now(),0)}function P(t,e){return"function"==typeof t?t(e):t}function k(t,e){return"function"==typeof t?t(e):t}function F(t,e){const{type:s="all",exact:r,fetchStatus:a,predicate:i,queryKey:n,stale:o}=t;if(n)if(r){if(e.queryHash!==z(n,e.options))return!1}else if(!M(e.queryKey,n))return!1;if("all"!==s){const t=e.isActive();if("active"===s&&!t)return!1;if("inactive"===s&&t)return!1}return("boolean"!=typeof o||e.isStale()===o)&&((!a||a===e.state.fetchStatus)&&!(i&&!i(e)))}function I(t,e){const{exact:s,status:r,predicate:a,mutationKey:i}=t;if(i){if(!e.options.mutationKey)return!1;if(s){if(q(e.options.mutationKey)!==q(i))return!1}else if(!M(e.options.mutationKey,i))return!1}return(!r||e.state.status===r)&&!(a&&!a(e))}function z(t,e){return(e?.queryKeyHashFn||q)(t)}function q(t){return JSON.stringify(t,(t,e)=>B(e)?Object.keys(e).sort().reduce((t,s)=>(t[s]=e[s],t),{}):e)}function M(t,e){return t===e||typeof t==typeof e&&(!(!t||!e||"object"!=typeof t||"object"!=typeof e)&&Object.keys(e).every(s=>M(t[s],e[s])))}var Q=Object.prototype.hasOwnProperty;function L(t,e){if(t===e)return t;const s=U(t)&&U(e);if(!(s||B(t)&&B(e)))return e;const r=(s?t:Object.keys(t)).length,a=s?e:Object.keys(e),i=a.length,n=s?new Array(i):{};let o=0;for(let l=0;l<i;l++){const i=s?l:a[l],c=t[i],u=e[i];if(c===u){n[i]=c,(s?l<r:Q.call(t,i))&&o++;continue}if(null===c||null===u||"object"!=typeof c||"object"!=typeof u){n[i]=u;continue}const h=L(c,u);n[i]=h,h===c&&o++}return r===i&&o===r?t:n}function $(t,e){if(!e||Object.keys(t).length!==Object.keys(e).length)return!1;for(const s in t)if(t[s]!==e[s])return!1;return!0}function U(t){return Array.isArray(t)&&t.length===Object.keys(t).length}function B(t){if(!H(t))return!1;const e=t.constructor;if(void 0===e)return!0;const s=e.prototype;return!!H(s)&&(!!s.hasOwnProperty("isPrototypeOf")&&Object.getPrototypeOf(t)===Object.prototype)}function H(t){return"[object Object]"===Object.prototype.toString.call(t)}function K(t,e,s){return"function"==typeof s.structuralSharing?s.structuralSharing(t,e):!1!==s.structuralSharing?L(t,e):e}function W(t){return t}function G(t,e,s=0){const r=[...t,e];return s&&r.length>s?r.slice(1):r}function J(t,e,s=0){const r=[e,...t];return s&&r.length>s?r.slice(0,-1):r}var V=Symbol();function Z(t,e){return!t.queryFn&&e?.initialPromise?()=>e.initialPromise:t.queryFn&&t.queryFn!==V?t.queryFn:()=>Promise.reject(new Error(`Missing queryFn: '${t.queryHash}'`))}function Y(t,e){return"function"==typeof t?t(...e):!!t}var X=new class extends D{#s;#r;#a;constructor(){super(),this.#a=t=>{if(!E&&window.addEventListener){const e=()=>t();return window.addEventListener("visibilitychange",e,!1),()=>{window.removeEventListener("visibilitychange",e)}}}}onSubscribe(){this.#r||this.setEventListener(this.#a)}onUnsubscribe(){this.hasListeners()||(this.#r?.(),this.#r=void 0)}setEventListener(t){this.#a=t,this.#r?.(),this.#r=t(t=>{"boolean"==typeof t?this.setFocused(t):this.onFocus()})}setFocused(t){this.#s!==t&&(this.#s=t,this.onFocus())}onFocus(){const t=this.isFocused();this.listeners.forEach(e=>{e(t)})}isFocused(){return"boolean"==typeof this.#s?this.#s:"hidden"!==globalThis.document?.visibilityState}};function tt(){let t,e;const s=new Promise((s,r)=>{t=s,e=r});function r(t){Object.assign(s,t),delete s.resolve,delete s.reject}return s.status="pending",s.catch(()=>{}),s.resolve=e=>{r({status:"fulfilled",value:e}),t(e)},s.reject=t=>{r({status:"rejected",reason:t}),e(t)},s}var et=function(t){setTimeout(t,0)};var st=function(){let t=[],e=0,s=t=>{t()},r=t=>{t()},a=et;const i=r=>{e?t.push(r):a(()=>{s(r)})};return{batch:i=>{let n;e++;try{n=i()}finally{e--,e||(()=>{const e=t;t=[],e.length&&a(()=>{r(()=>{e.forEach(t=>{s(t)})})})})()}return n},batchCalls:t=>(...e)=>{i(()=>{t(...e)})},schedule:i,setNotifyFunction:t=>{s=t},setBatchNotifyFunction:t=>{r=t},setScheduler:t=>{a=t}}}(),rt=new class extends D{#i=!0;#r;#a;constructor(){super(),this.#a=t=>{if(!E&&window.addEventListener){const e=()=>t(!0),s=()=>t(!1);return window.addEventListener("online",e,!1),window.addEventListener("offline",s,!1),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",s)}}}}onSubscribe(){this.#r||this.setEventListener(this.#a)}onUnsubscribe(){this.hasListeners()||(this.#r?.(),this.#r=void 0)}setEventListener(t){this.#a=t,this.#r?.(),this.#r=t(this.setOnline.bind(this))}setOnline(t){this.#i!==t&&(this.#i=t,this.listeners.forEach(e=>{e(t)}))}isOnline(){return this.#i}};function at(t){return Math.min(1e3*2**t,3e4)}function it(t){return"online"!==(t??"online")||rt.isOnline()}var nt=class extends Error{constructor(t){super("CancelledError"),this.revert=t?.revert,this.silent=t?.silent}};function ot(t){let e,s=!1,r=0;const a=tt(),i=()=>"pending"!==a.status,n=()=>X.isFocused()&&("always"===t.networkMode||rt.isOnline())&&t.canRun(),o=()=>it(t.networkMode)&&t.canRun(),l=t=>{i()||(e?.(),a.resolve(t))},c=t=>{i()||(e?.(),a.reject(t))},u=()=>new Promise(s=>{e=t=>{(i()||n())&&s(t)},t.onPause?.()}).then(()=>{e=void 0,i()||t.onContinue?.()}),h=()=>{if(i())return;let e;const a=0===r?t.initialPromise:void 0;try{e=a??t.fn()}catch(o){e=Promise.reject(o)}Promise.resolve(e).then(l).catch(e=>{if(i())return;const a=t.retry??(E?0:3),o=t.retryDelay??at,l="function"==typeof o?o(r,e):o,d=!0===a||"number"==typeof a&&r<a||"function"==typeof a&&a(r,e);if(s||!d)return c(e),void 0;var p;r++,t.onFail?.(r,e),(p=l,new Promise(t=>{j.setTimeout(t,p)})).then(()=>n()?void 0:u()).then(()=>{s?c(e):h()})})};return{promise:a,status:()=>a.status,cancel:e=>{if(!i()){const s=new nt(e);c(s),t.onCancel?.(s)}},continue:()=>(e?.(),a),cancelRetry:()=>{s=!0},continueRetry:()=>{s=!1},canStart:o,start:()=>(o()?h():u().then(h),a)}}var lt=class{#n;destroy(){this.clearGcTimeout()}scheduleGc(){this.clearGcTimeout(),N(this.gcTime)&&(this.#n=j.setTimeout(()=>{this.optionalRemove()},this.gcTime))}updateGcTime(t){this.gcTime=Math.max(this.gcTime||0,t??(E?1/0:3e5))}clearGcTimeout(){this.#n&&(j.clearTimeout(this.#n),this.#n=void 0)}},ct=class extends lt{#o;#l;#c;#u;#h;#d;#p;constructor(t){super(),this.#p=!1,this.#d=t.defaultOptions,this.setOptions(t.options),this.observers=[],this.#u=t.client,this.#c=this.#u.getQueryCache(),this.queryKey=t.queryKey,this.queryHash=t.queryHash,this.#o=ht(this.options),this.state=t.state??this.#o,this.scheduleGc()}get meta(){return this.options.meta}get promise(){return this.#h?.promise}setOptions(t){if(this.options={...this.#d,...t},this.updateGcTime(this.options.gcTime),this.state&&void 0===this.state.data){const t=ht(this.options);void 0!==t.data&&(this.setData(t.data,{updatedAt:t.dataUpdatedAt,manual:!0}),this.#o=t)}}optionalRemove(){this.observers.length||"idle"!==this.state.fetchStatus||this.#c.remove(this)}setData(t,e){const s=K(this.state.data,t,this.options);return this.#f({data:s,type:"success",dataUpdatedAt:e?.updatedAt,manual:e?.manual}),s}setState(t,e){this.#f({type:"setState",state:t,setStateOptions:e})}cancel(t){const e=this.#h?.promise;return this.#h?.cancel(t),e?e.then(A).catch(A):Promise.resolve()}destroy(){super.destroy(),this.cancel({silent:!0})}reset(){this.destroy(),this.setState(this.#o)}isActive(){return this.observers.some(t=>!1!==k(t.options.enabled,this))}isDisabled(){return this.getObserversCount()>0?!this.isActive():this.options.queryFn===V||this.state.dataUpdateCount+this.state.errorUpdateCount===0}isStatic(){return this.getObserversCount()>0&&this.observers.some(t=>"static"===P(t.options.staleTime,this))}isStale(){return this.getObserversCount()>0?this.observers.some(t=>t.getCurrentResult().isStale):void 0===this.state.data||this.state.isInvalidated}isStaleByTime(t=0){return void 0===this.state.data||"static"!==t&&(!!this.state.isInvalidated||!T(this.state.dataUpdatedAt,t))}onFocus(){const t=this.observers.find(t=>t.shouldFetchOnWindowFocus());t?.refetch({cancelRefetch:!1}),this.#h?.continue()}onOnline(){const t=this.observers.find(t=>t.shouldFetchOnReconnect());t?.refetch({cancelRefetch:!1}),this.#h?.continue()}addObserver(t){this.observers.includes(t)||(this.observers.push(t),this.clearGcTimeout(),this.#c.notify({type:"observerAdded",query:this,observer:t}))}removeObserver(t){this.observers.includes(t)&&(this.observers=this.observers.filter(e=>e!==t),this.observers.length||(this.#h&&(this.#p?this.#h.cancel({revert:!0}):this.#h.cancelRetry()),this.scheduleGc()),this.#c.notify({type:"observerRemoved",query:this,observer:t}))}getObserversCount(){return this.observers.length}invalidate(){this.state.isInvalidated||this.#f({type:"invalidate"})}async fetch(t,e){if("idle"!==this.state.fetchStatus&&"rejected"!==this.#h?.status())if(void 0!==this.state.data&&e?.cancelRefetch)this.cancel({silent:!0});else if(this.#h)return this.#h.continueRetry(),this.#h.promise;if(t&&this.setOptions(t),!this.options.queryFn){const t=this.observers.find(t=>t.options.queryFn);t&&this.setOptions(t.options)}const s=new AbortController,r=t=>{Object.defineProperty(t,"signal",{enumerable:!0,get:()=>(this.#p=!0,s.signal)})},a=()=>{const t=Z(this.options,e),s=(()=>{const t={client:this.#u,queryKey:this.queryKey,meta:this.meta};return r(t),t})();return this.#p=!1,this.options.persister?this.options.persister(t,s,this):t(s)},i=(()=>{const t={fetchOptions:e,options:this.options,queryKey:this.queryKey,client:this.#u,state:this.state,fetchFn:a};return r(t),t})();this.options.behavior?.onFetch(i,this),this.#l=this.state,"idle"!==this.state.fetchStatus&&this.state.fetchMeta===i.fetchOptions?.meta||this.#f({type:"fetch",meta:i.fetchOptions?.meta}),this.#h=ot({initialPromise:e?.initialPromise,fn:i.fetchFn,onCancel:t=>{t instanceof nt&&t.revert&&this.setState({...this.#l,fetchStatus:"idle"}),s.abort()},onFail:(t,e)=>{this.#f({type:"failed",failureCount:t,error:e})},onPause:()=>{this.#f({type:"pause"})},onContinue:()=>{this.#f({type:"continue"})},retry:i.options.retry,retryDelay:i.options.retryDelay,networkMode:i.options.networkMode,canRun:()=>!0});try{const t=await this.#h.start();if(void 0===t)throw 0,new Error(`${this.queryHash} data is undefined`);return this.setData(t),this.#c.config.onSuccess?.(t,this),this.#c.config.onSettled?.(t,this.state.error,this),t}catch(n){if(n instanceof nt){if(n.silent)return this.#h.promise;if(n.revert){if(void 0===this.state.data)throw n;return this.state.data}}throw this.#f({type:"error",error:n}),this.#c.config.onError?.(n,this),this.#c.config.onSettled?.(this.state.data,n,this),n}finally{this.scheduleGc()}}#f(t){this.state=(e=>{switch(t.type){case"failed":return{...e,fetchFailureCount:t.failureCount,fetchFailureReason:t.error};case"pause":return{...e,fetchStatus:"paused"};case"continue":return{...e,fetchStatus:"fetching"};case"fetch":return{...e,...ut(e.data,this.options),fetchMeta:t.meta??null};case"success":const s={...e,data:t.data,dataUpdateCount:e.dataUpdateCount+1,dataUpdatedAt:t.dataUpdatedAt??Date.now(),error:null,isInvalidated:!1,status:"success",...!t.manual&&{fetchStatus:"idle",fetchFailureCount:0,fetchFailureReason:null}};return this.#l=t.manual?s:void 0,s;case"error":const r=t.error;return{...e,error:r,errorUpdateCount:e.errorUpdateCount+1,errorUpdatedAt:Date.now(),fetchFailureCount:e.fetchFailureCount+1,fetchFailureReason:r,fetchStatus:"idle",status:"error"};case"invalidate":return{...e,isInvalidated:!0};case"setState":return{...e,...t.state}}})(this.state),st.batch(()=>{this.observers.forEach(t=>{t.onQueryUpdate()}),this.#c.notify({query:this,type:"updated",action:t})})}};function ut(t,e){return{fetchFailureCount:0,fetchFailureReason:null,fetchStatus:it(e.networkMode)?"fetching":"paused",...void 0===t&&{error:null,status:"pending"}}}function ht(t){const e="function"==typeof t.initialData?t.initialData():t.initialData,s=void 0!==e,r=s?"function"==typeof t.initialDataUpdatedAt?t.initialDataUpdatedAt():t.initialDataUpdatedAt:0;return{data:e,dataUpdateCount:0,dataUpdatedAt:s?r??Date.now():0,error:null,errorUpdateCount:0,errorUpdatedAt:0,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:null,isInvalidated:!1,status:s?"success":"pending",fetchStatus:"idle"}}var dt=class extends D{constructor(t,e){super(),this.options=e,this.#u=t,this.#y=null,this.#m=tt(),this.bindMethods(),this.setOptions(e)}#u;#g=void 0;#b=void 0;#v=void 0;#_;#C;#m;#y;#w;#R;#O;#x;#D;#S;#j=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){1===this.listeners.size&&(this.#g.addObserver(this),pt(this.#g,this.options)?this.#E():this.updateResult(),this.#A())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return ft(this.#g,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return ft(this.#g,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#N(),this.#T(),this.#g.removeObserver(this)}setOptions(t){const e=this.options,s=this.#g;if(this.options=this.#u.defaultQueryOptions(t),void 0!==this.options.enabled&&"boolean"!=typeof this.options.enabled&&"function"!=typeof this.options.enabled&&"boolean"!=typeof k(this.options.enabled,this.#g))throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#P(),this.#g.setOptions(this.options),e._defaulted&&!$(this.options,e)&&this.#u.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#g,observer:this});const r=this.hasListeners();r&&yt(this.#g,s,this.options,e)&&this.#E(),this.updateResult(),!r||this.#g===s&&k(this.options.enabled,this.#g)===k(e.enabled,this.#g)&&P(this.options.staleTime,this.#g)===P(e.staleTime,this.#g)||this.#k();const a=this.#F();!r||this.#g===s&&k(this.options.enabled,this.#g)===k(e.enabled,this.#g)&&a===this.#S||this.#I(a)}getOptimisticResult(t){const e=this.#u.getQueryCache().build(this.#u,t),s=this.createResult(e,t);return function(t,e){if(!$(t.getCurrentResult(),e))return!0;return!1}(this,s)&&(this.#v=s,this.#C=this.options,this.#_=this.#g.state),s}getCurrentResult(){return this.#v}trackResult(t,e){return new Proxy(t,{get:(t,s)=>(this.trackProp(s),e?.(s),"promise"===s&&(this.trackProp("data"),this.options.experimental_prefetchInRender||"pending"!==this.#m.status||this.#m.reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(t,s))})}trackProp(t){this.#j.add(t)}getCurrentQuery(){return this.#g}refetch({...t}={}){return this.fetch({...t})}fetchOptimistic(t){const e=this.#u.defaultQueryOptions(t),s=this.#u.getQueryCache().build(this.#u,e);return s.fetch().then(()=>this.createResult(s,e))}fetch(t){return this.#E({...t,cancelRefetch:t.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#v))}#E(t){this.#P();let e=this.#g.fetch(this.options,t);return t?.throwOnError||(e=e.catch(A)),e}#k(){this.#N();const t=P(this.options.staleTime,this.#g);if(E||this.#v.isStale||!N(t))return;const e=T(this.#v.dataUpdatedAt,t);this.#x=j.setTimeout(()=>{this.#v.isStale||this.updateResult()},e+1)}#F(){return("function"==typeof this.options.refetchInterval?this.options.refetchInterval(this.#g):this.options.refetchInterval)??!1}#I(t){this.#T(),this.#S=t,!E&&!1!==k(this.options.enabled,this.#g)&&N(this.#S)&&0!==this.#S&&(this.#D=j.setInterval(()=>{(this.options.refetchIntervalInBackground||X.isFocused())&&this.#E()},this.#S))}#A(){this.#k(),this.#I(this.#F())}#N(){this.#x&&(j.clearTimeout(this.#x),this.#x=void 0)}#T(){this.#D&&(j.clearInterval(this.#D),this.#D=void 0)}createResult(t,e){const s=this.#g,r=this.options,a=this.#v,i=this.#_,n=this.#C,o=t!==s?t.state:this.#b,{state:l}=t;let c,u={...l},h=!1;if(e._optimisticResults){const a=this.hasListeners(),i=!a&&pt(t,e),n=a&&yt(t,s,e,r);(i||n)&&(u={...u,...ut(l.data,t.options)}),"isRestoring"===e._optimisticResults&&(u.fetchStatus="idle")}let{error:d,errorUpdatedAt:p,status:f}=u;c=u.data;let y=!1;if(void 0!==e.placeholderData&&void 0===c&&"pending"===f){let t;a?.isPlaceholderData&&e.placeholderData===n?.placeholderData?(t=a.data,y=!0):t="function"==typeof e.placeholderData?e.placeholderData(this.#O?.state.data,this.#O):e.placeholderData,void 0!==t&&(f="success",c=K(a?.data,t,e),h=!0)}if(e.select&&void 0!==c&&!y)if(a&&c===i?.data&&e.select===this.#w)c=this.#R;else try{this.#w=e.select,c=e.select(c),c=K(a?.data,c,e),this.#R=c,this.#y=null}catch(w){this.#y=w}this.#y&&(d=this.#y,c=this.#R,p=Date.now(),f="error");const m="fetching"===u.fetchStatus,g="pending"===f,b="error"===f,v=g&&m,_=void 0!==c,C={status:f,fetchStatus:u.fetchStatus,isPending:g,isSuccess:"success"===f,isError:b,isInitialLoading:v,isLoading:v,data:c,dataUpdatedAt:u.dataUpdatedAt,error:d,errorUpdatedAt:p,failureCount:u.fetchFailureCount,failureReason:u.fetchFailureReason,errorUpdateCount:u.errorUpdateCount,isFetched:u.dataUpdateCount>0||u.errorUpdateCount>0,isFetchedAfterMount:u.dataUpdateCount>o.dataUpdateCount||u.errorUpdateCount>o.errorUpdateCount,isFetching:m,isRefetching:m&&!g,isLoadingError:b&&!_,isPaused:"paused"===u.fetchStatus,isPlaceholderData:h,isRefetchError:b&&_,isStale:mt(t,e),refetch:this.refetch,promise:this.#m,isEnabled:!1!==k(e.enabled,t)};if(this.options.experimental_prefetchInRender){const e=t=>{"error"===C.status?t.reject(C.error):void 0!==C.data&&t.resolve(C.data)},r=()=>{const t=this.#m=C.promise=tt();e(t)},a=this.#m;switch(a.status){case"pending":t.queryHash===s.queryHash&&e(a);break;case"fulfilled":"error"!==C.status&&C.data===a.value||r();break;case"rejected":"error"===C.status&&C.error===a.reason||r()}}return C}updateResult(){const t=this.#v,e=this.createResult(this.#g,this.options);if(this.#_=this.#g.state,this.#C=this.options,void 0!==this.#_.data&&(this.#O=this.#g),$(e,t))return;this.#v=e;this.#z({listeners:(()=>{if(!t)return!0;const{notifyOnChangeProps:e}=this.options,s="function"==typeof e?e():e;if("all"===s||!s&&!this.#j.size)return!0;const r=new Set(s??this.#j);return this.options.throwOnError&&r.add("error"),Object.keys(this.#v).some(e=>this.#v[e]!==t[e]&&r.has(e))})()})}#P(){const t=this.#u.getQueryCache().build(this.#u,this.options);if(t===this.#g)return;const e=this.#g;this.#g=t,this.#b=t.state,this.hasListeners()&&(e?.removeObserver(this),t.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#A()}#z(t){st.batch(()=>{t.listeners&&this.listeners.forEach(t=>{t(this.#v)}),this.#u.getQueryCache().notify({query:this.#g,type:"observerResultsUpdated"})})}};function pt(t,e){return function(t,e){return!1!==k(e.enabled,t)&&void 0===t.state.data&&!("error"===t.state.status&&!1===e.retryOnMount)}(t,e)||void 0!==t.state.data&&ft(t,e,e.refetchOnMount)}function ft(t,e,s){if(!1!==k(e.enabled,t)&&"static"!==P(e.staleTime,t)){const r="function"==typeof s?s(t):s;return"always"===r||!1!==r&&mt(t,e)}return!1}function yt(t,e,s,r){return(t!==e||!1===k(r.enabled,t))&&(!s.suspense||"error"!==t.state.status)&&mt(t,s)}function mt(t,e){return!1!==k(e.enabled,t)&&t.isStaleByTime(P(e.staleTime,t))}function gt(t){return{onFetch:(e,s)=>{const r=e.options,a=e.fetchOptions?.meta?.fetchMore?.direction,i=e.state.data?.pages||[],n=e.state.data?.pageParams||[];let o={pages:[],pageParams:[]},l=0;const c=async()=>{let s=!1;const c=Z(e.options,e.fetchOptions),u=async(t,r,a)=>{if(s)return Promise.reject();if(null==r&&t.pages.length)return Promise.resolve(t);const i=(()=>{const t={client:e.client,queryKey:e.queryKey,pageParam:r,direction:a?"backward":"forward",meta:e.options.meta};return void Object.defineProperty(t,"signal",{enumerable:!0,get:()=>(e.signal.aborted?s=!0:e.signal.addEventListener("abort",()=>{s=!0}),e.signal)}),t})(),n=await c(i),{maxPages:o}=e.options,l=a?J:G;return{pages:l(t.pages,n,o),pageParams:l(t.pageParams,r,o)}};if(a&&i.length){const t="backward"===a,e={pages:i,pageParams:n},s=(t?vt:bt)(r,e);o=await u(e,s,t)}else{const e=t??i.length;do{const t=0===l?n[0]??r.initialPageParam:bt(r,o);if(l>0&&null==t)break;o=await u(o,t),l++}while(l<e)}return o};e.fetchFn=e.options.persister?()=>e.options.persister?.(c,{client:e.client,queryKey:e.queryKey,meta:e.options.meta,signal:e.signal},s):c}}}function bt(t,{pages:e,pageParams:s}){const r=e.length-1;return e.length>0?t.getNextPageParam(e[r],e,s[r],s):void 0}function vt(t,{pages:e,pageParams:s}){return e.length>0?t.getPreviousPageParam?.(e[0],e,s[0],s):void 0}var _t=class extends lt{#u;#q;#M;#h;constructor(t){super(),this.#u=t.client,this.mutationId=t.mutationId,this.#M=t.mutationCache,this.#q=[],this.state=t.state||{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0},this.setOptions(t.options),this.scheduleGc()}setOptions(t){this.options=t,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(t){this.#q.includes(t)||(this.#q.push(t),this.clearGcTimeout(),this.#M.notify({type:"observerAdded",mutation:this,observer:t}))}removeObserver(t){this.#q=this.#q.filter(e=>e!==t),this.scheduleGc(),this.#M.notify({type:"observerRemoved",mutation:this,observer:t})}optionalRemove(){this.#q.length||("pending"===this.state.status?this.scheduleGc():this.#M.remove(this))}continue(){return this.#h?.continue()??this.execute(this.state.variables)}async execute(t){const e=()=>{this.#f({type:"continue"})},s={client:this.#u,meta:this.options.meta,mutationKey:this.options.mutationKey};this.#h=ot({fn:()=>this.options.mutationFn?this.options.mutationFn(t,s):Promise.reject(new Error("No mutationFn found")),onFail:(t,e)=>{this.#f({type:"failed",failureCount:t,error:e})},onPause:()=>{this.#f({type:"pause"})},onContinue:e,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>this.#M.canRun(this)});const r="pending"===this.state.status,a=!this.#h.canStart();try{if(r)e();else{this.#f({type:"pending",variables:t,isPaused:a}),await(this.#M.config.onMutate?.(t,this,s));const e=await(this.options.onMutate?.(t,s));e!==this.state.context&&this.#f({type:"pending",context:e,variables:t,isPaused:a})}const i=await this.#h.start();return await(this.#M.config.onSuccess?.(i,t,this.state.context,this,s)),await(this.options.onSuccess?.(i,t,this.state.context,s)),await(this.#M.config.onSettled?.(i,null,this.state.variables,this.state.context,this,s)),await(this.options.onSettled?.(i,null,t,this.state.context,s)),this.#f({type:"success",data:i}),i}catch(i){try{throw await(this.#M.config.onError?.(i,t,this.state.context,this,s)),await(this.options.onError?.(i,t,this.state.context,s)),await(this.#M.config.onSettled?.(void 0,i,this.state.variables,this.state.context,this,s)),await(this.options.onSettled?.(void 0,i,t,this.state.context,s)),i}finally{this.#f({type:"error",error:i})}}finally{this.#M.runNext(this)}}#f(t){this.state=(e=>{switch(t.type){case"failed":return{...e,failureCount:t.failureCount,failureReason:t.error};case"pause":return{...e,isPaused:!0};case"continue":return{...e,isPaused:!1};case"pending":return{...e,context:t.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:t.isPaused,status:"pending",variables:t.variables,submittedAt:Date.now()};case"success":return{...e,data:t.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...e,data:void 0,error:t.error,failureCount:e.failureCount+1,failureReason:t.error,isPaused:!1,status:"error"}}})(this.state),st.batch(()=>{this.#q.forEach(e=>{e.onMutationUpdate(t)}),this.#M.notify({mutation:this,type:"updated",action:t})})}};var Ct=class extends D{constructor(t={}){super(),this.config=t,this.#Q=new Set,this.#L=new Map,this.#$=0}#Q;#L;#$;build(t,e,s){const r=new _t({client:t,mutationCache:this,mutationId:++this.#$,options:t.defaultMutationOptions(e),state:s});return this.add(r),r}add(t){this.#Q.add(t);const e=wt(t);if("string"==typeof e){const s=this.#L.get(e);s?s.push(t):this.#L.set(e,[t])}this.notify({type:"added",mutation:t})}remove(t){if(this.#Q.delete(t)){const e=wt(t);if("string"==typeof e){const s=this.#L.get(e);if(s)if(s.length>1){const e=s.indexOf(t);-1!==e&&s.splice(e,1)}else s[0]===t&&this.#L.delete(e)}}this.notify({type:"removed",mutation:t})}canRun(t){const e=wt(t);if("string"==typeof e){const s=this.#L.get(e),r=s?.find(t=>"pending"===t.state.status);return!r||r===t}return!0}runNext(t){const e=wt(t);if("string"==typeof e){const s=this.#L.get(e)?.find(e=>e!==t&&e.state.isPaused);return s?.continue()??Promise.resolve()}return Promise.resolve()}clear(){st.batch(()=>{this.#Q.forEach(t=>{this.notify({type:"removed",mutation:t})}),this.#Q.clear(),this.#L.clear()})}getAll(){return Array.from(this.#Q)}find(t){const e={exact:!0,...t};return this.getAll().find(t=>I(e,t))}findAll(t={}){return this.getAll().filter(e=>I(t,e))}notify(t){st.batch(()=>{this.listeners.forEach(e=>{e(t)})})}resumePausedMutations(){const t=this.getAll().filter(t=>t.state.isPaused);return st.batch(()=>Promise.all(t.map(t=>t.continue().catch(A))))}};function wt(t){return t.options.scope?.id}var Rt=class extends D{#u;#v=void 0;#U;#B;constructor(t,e){super(),this.#u=t,this.setOptions(e),this.bindMethods(),this.#H()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(t){const e=this.options;this.options=this.#u.defaultMutationOptions(t),$(this.options,e)||this.#u.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#U,observer:this}),e?.mutationKey&&this.options.mutationKey&&q(e.mutationKey)!==q(this.options.mutationKey)?this.reset():"pending"===this.#U?.state.status&&this.#U.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#U?.removeObserver(this)}onMutationUpdate(t){this.#H(),this.#z(t)}getCurrentResult(){return this.#v}reset(){this.#U?.removeObserver(this),this.#U=void 0,this.#H(),this.#z()}mutate(t,e){return this.#B=e,this.#U?.removeObserver(this),this.#U=this.#u.getMutationCache().build(this.#u,this.options),this.#U.addObserver(this),this.#U.execute(t)}#H(){const t=this.#U?.state??{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0};this.#v={...t,isPending:"pending"===t.status,isSuccess:"success"===t.status,isError:"error"===t.status,isIdle:"idle"===t.status,mutate:this.mutate,reset:this.reset}}#z(t){st.batch(()=>{if(this.#B&&this.hasListeners()){const e=this.#v.variables,s=this.#v.context,r={client:this.#u,meta:this.options.meta,mutationKey:this.options.mutationKey};"success"===t?.type?(this.#B.onSuccess?.(t.data,e,s,r),this.#B.onSettled?.(t.data,null,e,s,r)):"error"===t?.type&&(this.#B.onError?.(t.error,e,s,r),this.#B.onSettled?.(void 0,t.error,e,s,r))}this.listeners.forEach(t=>{t(this.#v)})})}},Ot=class extends D{constructor(t={}){super(),this.config=t,this.#K=new Map}#K;build(t,e,s){const r=e.queryKey,a=e.queryHash??z(r,e);let i=this.get(a);return i||(i=new ct({client:t,queryKey:r,queryHash:a,options:t.defaultQueryOptions(e),state:s,defaultOptions:t.getQueryDefaults(r)}),this.add(i)),i}add(t){this.#K.has(t.queryHash)||(this.#K.set(t.queryHash,t),this.notify({type:"added",query:t}))}remove(t){const e=this.#K.get(t.queryHash);e&&(t.destroy(),e===t&&this.#K.delete(t.queryHash),this.notify({type:"removed",query:t}))}clear(){st.batch(()=>{this.getAll().forEach(t=>{this.remove(t)})})}get(t){return this.#K.get(t)}getAll(){return[...this.#K.values()]}find(t){const e={exact:!0,...t};return this.getAll().find(t=>F(e,t))}findAll(t={}){const e=this.getAll();return Object.keys(t).length>0?e.filter(e=>F(t,e)):e}notify(t){st.batch(()=>{this.listeners.forEach(e=>{e(t)})})}onFocus(){st.batch(()=>{this.getAll().forEach(t=>{t.onFocus()})})}onOnline(){st.batch(()=>{this.getAll().forEach(t=>{t.onOnline()})})}},xt=class{#W;#M;#d;#G;#J;#V;#Z;#Y;constructor(t={}){this.#W=t.queryCache||new Ot,this.#M=t.mutationCache||new Ct,this.#d=t.defaultOptions||{},this.#G=new Map,this.#J=new Map,this.#V=0}mount(){this.#V++,1===this.#V&&(this.#Z=X.subscribe(async t=>{t&&(await this.resumePausedMutations(),this.#W.onFocus())}),this.#Y=rt.subscribe(async t=>{t&&(await this.resumePausedMutations(),this.#W.onOnline())}))}unmount(){this.#V--,0===this.#V&&(this.#Z?.(),this.#Z=void 0,this.#Y?.(),this.#Y=void 0)}isFetching(t){return this.#W.findAll({...t,fetchStatus:"fetching"}).length}isMutating(t){return this.#M.findAll({...t,status:"pending"}).length}getQueryData(t){const e=this.defaultQueryOptions({queryKey:t});return this.#W.get(e.queryHash)?.state.data}ensureQueryData(t){const e=this.defaultQueryOptions(t),s=this.#W.build(this,e),r=s.state.data;return void 0===r?this.fetchQuery(t):(t.revalidateIfStale&&s.isStaleByTime(P(e.staleTime,s))&&void this.prefetchQuery(e),Promise.resolve(r))}getQueriesData(t){return this.#W.findAll(t).map(({queryKey:t,state:e})=>[t,e.data])}setQueryData(t,e,s){const r=this.defaultQueryOptions({queryKey:t}),a=this.#W.get(r.queryHash),i=a?.state.data,n=function(t,e){return"function"==typeof t?t(e):t}(e,i);if(void 0!==n)return this.#W.build(this,r).setData(n,{...s,manual:!0})}setQueriesData(t,e,s){return st.batch(()=>this.#W.findAll(t).map(({queryKey:t})=>[t,this.setQueryData(t,e,s)]))}getQueryState(t){const e=this.defaultQueryOptions({queryKey:t});return this.#W.get(e.queryHash)?.state}removeQueries(t){const e=this.#W;st.batch(()=>{e.findAll(t).forEach(t=>{e.remove(t)})})}resetQueries(t,e){const s=this.#W;return st.batch(()=>(s.findAll(t).forEach(t=>{t.reset()}),this.refetchQueries({type:"active",...t},e)))}cancelQueries(t,e={}){const s={revert:!0,...e},r=st.batch(()=>this.#W.findAll(t).map(t=>t.cancel(s)));return Promise.all(r).then(A).catch(A)}invalidateQueries(t,e={}){return st.batch(()=>(this.#W.findAll(t).forEach(t=>{t.invalidate()}),"none"===t?.refetchType?Promise.resolve():this.refetchQueries({...t,type:t?.refetchType??t?.type??"active"},e)))}refetchQueries(t,e={}){const s={...e,cancelRefetch:e.cancelRefetch??!0},r=st.batch(()=>this.#W.findAll(t).filter(t=>!t.isDisabled()&&!t.isStatic()).map(t=>{let e=t.fetch(void 0,s);return s.throwOnError||(e=e.catch(A)),"paused"===t.state.fetchStatus?Promise.resolve():e}));return Promise.all(r).then(A)}fetchQuery(t){const e=this.defaultQueryOptions(t);void 0===e.retry&&(e.retry=!1);const s=this.#W.build(this,e);return s.isStaleByTime(P(e.staleTime,s))?s.fetch(e):Promise.resolve(s.state.data)}prefetchQuery(t){return this.fetchQuery(t).then(A).catch(A)}fetchInfiniteQuery(t){return t.behavior=gt(t.pages),this.fetchQuery(t)}prefetchInfiniteQuery(t){return this.fetchInfiniteQuery(t).then(A).catch(A)}ensureInfiniteQueryData(t){return t.behavior=gt(t.pages),this.ensureQueryData(t)}resumePausedMutations(){return rt.isOnline()?this.#M.resumePausedMutations():Promise.resolve()}getQueryCache(){return this.#W}getMutationCache(){return this.#M}getDefaultOptions(){return this.#d}setDefaultOptions(t){this.#d=t}setQueryDefaults(t,e){this.#G.set(q(t),{queryKey:t,defaultOptions:e})}getQueryDefaults(t){const e=[...this.#G.values()],s={};return e.forEach(e=>{M(t,e.queryKey)&&Object.assign(s,e.defaultOptions)}),s}setMutationDefaults(t,e){this.#J.set(q(t),{mutationKey:t,defaultOptions:e})}getMutationDefaults(t){const e=[...this.#J.values()],s={};return e.forEach(e=>{M(t,e.mutationKey)&&Object.assign(s,e.defaultOptions)}),s}defaultQueryOptions(t){if(t._defaulted)return t;const e={...this.#d.queries,...this.getQueryDefaults(t.queryKey),...t,_defaulted:!0};return e.queryHash||(e.queryHash=z(e.queryKey,e)),void 0===e.refetchOnReconnect&&(e.refetchOnReconnect="always"!==e.networkMode),void 0===e.throwOnError&&(e.throwOnError=!!e.suspense),!e.networkMode&&e.persister&&(e.networkMode="offlineFirst"),e.queryFn===V&&(e.enabled=!1),e}defaultMutationOptions(t){return t?._defaulted?t:{...this.#d.mutations,...t?.mutationKey&&this.getMutationDefaults(t.mutationKey),...t,_defaulted:!0}}clear(){this.#W.clear(),this.#M.clear()}},Dt=R.createContext(void 0),St=t=>{const e=R.useContext(Dt);if(!e)throw new Error("No QueryClient set, use QueryClientProvider to set one");return e},jt=({client:t,children:e})=>(R.useEffect(()=>(t.mount(),()=>{t.unmount()}),[t]),w.jsx(Dt.Provider,{value:t,children:e})),Et=R.createContext(!1);Et.Provider;var At=R.createContext(function(){let t=!1;return{clearReset:()=>{t=!1},reset:()=>{t=!0},isReset:()=>t}}()),Nt=(t,e,s)=>e.fetchOptimistic(t).catch(()=>{s.clearReset()});function Tt(t,e,s){const r=R.useContext(Et),a=R.useContext(At),i=St(),n=i.defaultQueryOptions(t);i.getDefaultOptions().queries?._experimental_beforeQuery?.(n),n._optimisticResults=r?"isRestoring":"optimistic",(t=>{if(t.suspense){const e=1e3,s=t=>"static"===t?t:Math.max(t??e,e),r=t.staleTime;t.staleTime="function"==typeof r?(...t)=>s(r(...t)):s(r),"number"==typeof t.gcTime&&(t.gcTime=Math.max(t.gcTime,e))}})(n),((t,e)=>{(t.suspense||t.throwOnError||t.experimental_prefetchInRender)&&(e.isReset()||(t.retryOnMount=!1))})(n,a),(t=>{R.useEffect(()=>{t.clearReset()},[t])})(a);const o=!i.getQueryCache().get(n.queryHash),[l]=R.useState(()=>new e(i,n)),c=l.getOptimisticResult(n),u=!r&&!1!==t.subscribed;if(R.useSyncExternalStore(R.useCallback(t=>{const e=u?l.subscribe(st.batchCalls(t)):A;return l.updateResult(),e},[l,u]),()=>l.getCurrentResult(),()=>l.getCurrentResult()),R.useEffect(()=>{l.setOptions(n)},[n,l]),((t,e)=>t?.suspense&&e.isPending)(n,c))throw Nt(n,l,a);if((({result:t,errorResetBoundary:e,throwOnError:s,query:r,suspense:a})=>t.isError&&!e.isReset()&&!t.isFetching&&r&&(a&&void 0===t.data||Y(s,[t.error,r])))({result:c,errorResetBoundary:a,throwOnError:n.throwOnError,query:i.getQueryCache().get(n.queryHash),suspense:n.suspense}))throw c.error;if(i.getDefaultOptions().queries?._experimental_afterQuery?.(n,c),n.experimental_prefetchInRender&&!E&&((t,e)=>t.isLoading&&t.isFetching&&!e)(c,r)){const t=o?Nt(n,l,a):i.getQueryCache().get(n.queryHash)?.promise;t?.catch(A).finally(()=>{l.updateResult()})}return n.notifyOnChangeProps?c:l.trackResult(c)}function Pt(t,e){return Tt(t,dt)}function kt(t,e){const s=St(),[r]=R.useState(()=>new Rt(s,t));R.useEffect(()=>{r.setOptions(t)},[r,t]);const a=R.useSyncExternalStore(R.useCallback(t=>r.subscribe(st.batchCalls(t)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),i=R.useCallback((t,e)=>{r.mutate(t,e).catch(A)},[r]);if(a.error&&Y(r.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:i,mutateAsync:a.mutate}}const Ft=({viewMode:t,filters:e,diagnosiOptions:a,repartoOptions:i,repartoProvenienzaOptions:n,infectionOptions:o,onApplyFilters:l,onReset:c,onApplyClick:u})=>{const h=R.useId(),[d,p]=R.useState(()=>"undefined"!=typeof window&&window.innerWidth<=767),f=(t,s)=>{l({...e,[t]:s})},y=(t,s)=>{l({...e,dateRange:{startDate:"startDate"===t?s:e.dateRange?.startDate||"",endDate:"endDate"===t?s:e.dateRange?.endDate||"",preset:e.dateRange?.preset||"custom"}})};return w.jsxs("div",{className:"charts-filters-card charts-collapsible "+(d?"is-collapsed":""),children:[w.jsxs("div",{className:"charts-filters-header charts-collapsible-header",children:[w.jsxs("div",{className:"charts-filters-title-wrapper",children:[w.jsx("span",{className:"material-icons",children:"filter_list"}),w.jsx("h3",{className:"charts-filters-title",children:"Filtri"})]}),w.jsx("button",{type:"button",className:"charts-collapse-toggle","aria-expanded":!d,"aria-controls":h,"aria-label":d?"Espandi filtri":"Comprimi filtri",onClick:()=>p(t=>!t),children:w.jsx("span",{"aria-hidden":"true",className:"material-icons",children:d?"expand_more":"expand_less"})})]}),w.jsxs("div",{className:"charts-filters-content charts-collapsible-content",id:h,hidden:d,children:[w.jsx("div",{className:"charts-filter-row",children:w.jsx(s,{startDate:e.dateRange?.startDate||"",endDate:e.dateRange?.endDate||"",onStartDateChange:t=>y("startDate",t||""),onEndDateChange:t=>y("endDate",t||""),startLabel:"Data Inizio",endLabel:"Data Fine",startPlaceholder:"gg/mm/aaaa",endPlaceholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})}),("filtered"===t||"analysis"===t)&&w.jsxs("div",{className:"charts-filter-row",children:[w.jsxs("div",{className:"charts-filter-column",children:[w.jsx("label",{htmlFor:"filter-reparto-appartenenza",className:"charts-filter-label",children:"Reparto Appartenenza"}),w.jsx(r,{id:"filter-reparto-appartenenza",value:e.repartoAppartenenza||"",options:[{value:"",label:"Tutti"},...i.map(t=>({value:t,label:t}))],onChange:t=>f("repartoAppartenenza",t||""),placeholder:"Seleziona..."})]}),w.jsxs("div",{className:"charts-filter-column",children:[w.jsx("label",{htmlFor:"filter-reparto-provenienza",className:"charts-filter-label",children:"Reparto Provenienza"}),w.jsx(r,{id:"filter-reparto-provenienza",value:e.repartoProvenienza||"",options:[{value:"",label:"Tutti"},...n.map(t=>({value:t,label:t}))],onChange:t=>f("repartoProvenienza",t||""),placeholder:"Seleziona..."})]})]}),("filtered"===t||"analysis"===t)&&w.jsxs("div",{className:"charts-filter-row",children:["filtered"===t&&w.jsxs("div",{className:"charts-filter-column",children:[w.jsx("label",{htmlFor:"filter-diagnosi",className:"charts-filter-label",children:"Diagnosi"}),w.jsx(r,{id:"filter-diagnosi",value:e.diagnosi||"",options:[{value:"",label:"Tutte"},...a.map(t=>({value:t.nome,label:t.nome}))],onChange:t=>f("diagnosi",t||""),placeholder:"Seleziona..."})]}),w.jsxs("div",{className:"charts-filter-column",children:[w.jsx("label",{htmlFor:"filter-livello-assistenza",className:"charts-filter-label",children:"Livello Assistenza"}),w.jsx(r,{id:"filter-livello-assistenza",value:e.livelloAssistenza||"",options:[{value:"",label:"Tutti"},{value:"Bassa",label:"Bassa"},{value:"Media",label:"Media"},{value:"Alta",label:"Alta"}],onChange:t=>f("livelloAssistenza",t||null),placeholder:"Seleziona..."})]}),w.jsxs("div",{className:"charts-filter-column",children:[w.jsx("label",{htmlFor:"filter-infetto",className:"charts-filter-label",children:"Infetto"}),w.jsx(r,{id:"filter-infetto",value:null!=e.infetto?e.infetto.toString():"",options:o.map(t=>({value:t.value?.toString()??"",label:t.label})),onChange:t=>f("infetto","true"===t||"false"!==t&&void 0),placeholder:"Seleziona..."})]})]}),w.jsxs("div",{className:"charts-filter-actions",children:[w.jsx("button",{type:"button",className:"btn btn-primary",onClick:u,children:"Applica Filtri"}),w.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:c,children:"Reset"})]})]})]})};class It{labels;datasets;totalRecords;aggregationType;filters;generatedAt;constructor(t={}){this.labels=t.labels??[],this.datasets=t.datasets??[],this.totalRecords=t.totalRecords??0,this.aggregationType=t.aggregationType??"count",this.filters=t.filters??null,this.generatedAt="string"==typeof t.generatedAt?new Date(t.generatedAt):t.generatedAt??new Date}validate(){const t=[];return Array.isArray(this.labels)&&0!==this.labels.length||t.push({field:"labels",message:"Labels array must not be empty"}),Array.isArray(this.datasets)&&0!==this.datasets.length||t.push({field:"datasets",message:"Datasets array must not be empty"}),this.datasets.forEach((e,s)=>{Array.isArray(e.data)?e.data.length!==this.labels.length&&t.push({field:`datasets[${s}].data`,message:"Dataset data length must match labels length"}):t.push({field:`datasets[${s}].data`,message:"Dataset data must be an array"})}),this.totalRecords>1e4&&t.push({field:"totalRecords",message:"Total records exceeds 10,000 limit"}),{valid:0===t.length,errors:t}}toChartJS(){return{labels:this.labels,datasets:this.datasets}}toJSON(){return{labels:this.labels,datasets:this.datasets,totalRecords:this.totalRecords,aggregationType:this.aggregationType,filters:this.filters,generatedAt:this.generatedAt.toISOString()}}}const zt=[{label:"Minori (0-17)",color:"#4299E1"},{label:"Giovani (18-30)",color:"#48BB78"},{label:"Adulti (31-50)",color:"#ECC94B"},{label:"Anziani (51-70)",color:"#F6AD55"},{label:"Grandi anziani (70+)",color:"#FC8181"}],qt=["#48BB78","#ECC94B","#F56565","#4299E1","#FC8181"],Mt={"Dimissione Ordinaria":"#48BB78","Trasferimento Interno":"#4299E1","Trasferimento Esterno":"#ECC94B",Decesso:"#E53E3E","Non specificato":"#A0AEC0"};const Qt=new class{cache;CACHE_TTL;constructor(){this.cache=new Map,this.CACHE_TTL=6e5}async getAgeDistribution(s={}){const r=`age_dist_${JSON.stringify(s)}`,a=this._getFromCache(r);if(a)return t.debug("Returning cached age distribution"),a;try{const{data:t,error:a}=await e.rpc("get_age_distribution",{filters:JSON.stringify(s)});if(a)throw a;const i=this._buildAgeDistributionChart(t,s);return this._setCache(r,i),i}catch(i){t.warn("RPC get_age_distribution failed, falling back to direct query",i);const e=await this._fetchAgeDistributionFallback(s);return this._setCache(r,e),e}}async getAgeStatistics(s={}){const r=`age_stats_${JSON.stringify(s)}`,a=this._getFromCache(r);if(a)return a;try{let t=e.from("pazienti").select("data_nascita").not("data_nascita","is",null);t=this._applyFilters(t,s);const{data:a,error:i}=await t;if(i)throw i;const n=new Date,o=a.map(t=>{const e=new Date(t.data_nascita);return n.getFullYear()-e.getFullYear()}).sort((t,e)=>t-e),l={min:Math.min(...o),max:Math.max(...o),avg:o.reduce((t,e)=>t+e,0)/o.length,median:o[Math.floor(o.length/2)],count:o.length};return this._setCache(r,l),l}catch(i){throw t.error("Error fetching age statistics",i),i}}async getAssistanceLevelDistribution(s={}){const r=`assistance_${JSON.stringify(s)}`,a=this._getFromCache(r);if(a)return a;try{const{data:t,error:a}=await e.rpc("get_assistance_level_distribution",{filters:JSON.stringify(s)});if(a)throw a;const i=this._buildAssistanceLevelChart(t,s);return this._setCache(r,i),i}catch(i){t.warn("RPC get_assistance_level_distribution failed, using fallback",i);const e=await this._fetchAssistanceLevelFallback(s);return this._setCache(r,e),e}}async getDismissalTypeDistribution(s={}){const r=`dismissal_${JSON.stringify(s)}`,a=this._getFromCache(r);if(a)return a;try{const{data:t,error:a}=await e.rpc("get_dismissal_type_distribution",{filters:JSON.stringify(s)});if(a)throw a;const i=this._buildDismissalTypeChart(t,s);return this._setCache(r,i),i}catch(i){t.warn("RPC get_dismissal_type_distribution failed, using fallback",i);const e=await this._fetchDismissalTypeFallback(s);return this._setCache(r,e),e}}async getInfectionRateByDiagnosis(s={}){const{minPatients:r=3,limit:a=15,filters:i={}}=s,n=`infection_rate_${r}_${a}_${JSON.stringify(i)}`,o=this._getFromCache(n);if(o)return o;try{t.debug("Calling get_infection_rate_by_diagnosis RPC with filters:",JSON.stringify(i,null,2));const{data:s,error:o}=await e.rpc("get_infection_rate_by_diagnosis",{p_min_patients:r,p_result_limit:a,filters:JSON.stringify(i)});if(o)throw o;const l=this._buildInfectionRateChart(s,{minPatients:r,limit:a,filters:i});return this._setCache(n,l),l}catch(l){t.warn("RPC get_infection_rate_by_diagnosis failed, using fallback",l);const e=await this._fetchInfectionRateFallback(r,a,i);return this._setCache(n,e),e}}_applyFilters(t,e){const s=e.dateRange;return s&&(s.startDate&&""!==s.startDate&&(t=t.gte("data_ricovero",s.startDate)),s.endDate&&""!==s.endDate&&(t=t.lte("data_ricovero",s.endDate))),e.repartoAppartenenza&&(t=t.eq("reparto_appartenenza",e.repartoAppartenenza)),e.repartoProvenienza&&(t=t.eq("reparto_provenienza",e.repartoProvenienza)),e.diagnosi&&(t=t.eq("diagnosi",e.diagnosi)),e.livelloAssistenza&&(t=t.eq("livello_assistenza",e.livelloAssistenza)),null!=e.infetto&&(t=t.eq("infetto",e.infetto)),t}_buildAgeDistributionChart(t=[],e){const s=zt.reduce((t,e)=>(t[e.label]=0,t),{});t.forEach(t=>{const e=t.age_range||t.label;e&&void 0!==s[e]&&(s[e]=Number(t.patient_count??t.count??0))});const r=zt.map(t=>t.label),a=r.map(t=>s[t]||0),i=a.reduce((t,e)=>t+e,0);return new It({labels:r,datasets:[{label:"Distribuzione per Fascia d'Et",data:a,backgroundColor:zt.map(t=>{const e=t.color;return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:i,aggregationType:"age_distribution",filters:null,generatedAt:new Date})}async _fetchAgeDistributionFallback(s){try{let t=e.from("pazienti").select("data_nascita").not("data_nascita","is",null);t=this._applyFilters(t,s);const{data:r,error:a}=await t;if(a)throw a;const i=zt.reduce((t,e)=>(t[e.label]=0,t),{}),n=new Date;r.forEach(t=>{const e=new Date(t.data_nascita),s=n.getFullYear()-e.getFullYear();s<18?i["Minori (0-17)"]++:s<=30?i["Giovani (18-30)"]++:s<=50?i["Adulti (31-50)"]++:s<=70?i["Anziani (51-70)"]++:i["Grandi anziani (70+)"]++});const o=Object.entries(i).map(([t,e])=>({age_range:t,patient_count:e}));return this._buildAgeDistributionChart(o,s)}catch(r){throw t.error("Fallback age distribution query failed",r),r}}_buildAssistanceLevelChart(t=[],e){const s=[...t].map(t=>({assistance_level:t.assistance_level||t.label||"Non specificato",patient_count:Number(t.patient_count??t.count??0)})).sort((t,e)=>e.patient_count-t.patient_count||t.assistance_level.localeCompare(e.assistance_level)),r=s.map(t=>t.assistance_level),a=s.map(t=>t.patient_count),i=r.map((t,e)=>qt[e%qt.length]),n=a.reduce((t,e)=>t+e,0);return new It({labels:r,datasets:[{label:"Distribuzione Livelli Assistenza",data:a,backgroundColor:i.map(t=>{const e=t;return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"assistance_level",filters:null,generatedAt:new Date})}async _fetchAssistanceLevelFallback(s){try{let t=e.from("pazienti").select("livello_assistenza").not("livello_assistenza","is",null);t=this._applyFilters(t,s);const{data:r,error:a}=await t;if(a)throw a;const i=r.reduce((t,e)=>{const s=e.livello_assistenza||"Non specificato";return t[s]=(t[s]||0)+1,t},{}),n=Object.entries(i).map(([t,e])=>({assistance_level:t,patient_count:e}));return this._buildAssistanceLevelChart(n,s)}catch(r){throw t.error("Fallback assistance level query failed",r),r}}_buildDismissalTypeChart(t=[],e){const s=t.map(t=>{const e=t.dismissal_type||t.label||"Non specificato";return{dismissal_type:(Object.keys(Mt).includes(e),e),patient_count:Number(t.patient_count??t.count??0)}}).sort((t,e)=>e.patient_count-t.patient_count||t.dismissal_type.localeCompare(e.dismissal_type)),r=s.map(t=>t.dismissal_type),a=s.map(t=>t.patient_count),i=r.map(t=>Mt[t]||"#CBD5F5"),n=a.reduce((t,e)=>t+e,0);return new It({labels:r,datasets:[{label:"Distribuzione Tipi Dimissione",data:a,backgroundColor:i.map(t=>{const e=t;return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"dismissal_type",filters:null,generatedAt:new Date})}async _fetchDismissalTypeFallback(s){try{let t=e.from("pazienti").select("tipo_dimissione");t=this._applyFilters(t,s);const{data:r,error:a}=await t;if(a)throw a;const i={dimissione:"Dimissione Ordinaria",trasferimento_interno:"Trasferimento Interno",trasferimento_esterno:"Trasferimento Esterno",decesso:"Decesso"},n=r.reduce((t,e)=>{const s=e.tipo_dimissione||"Non specificato",r=i[s]||s;return t[r]=(t[r]||0)+1,t},{}),o=Object.entries(n).map(([t,e])=>({dismissal_type:t,patient_count:e}));return this._buildDismissalTypeChart(o,s)}catch(r){throw t.error("Fallback dismissal type query failed",r),r}}_buildInfectionRateChart(t=[],e){const s=[...t].map(t=>({diagnosi:t.diagnosi||t.diagnosis||"Non specificata",infection_rate:Number(t.infection_rate??t.rate??0),total_pazienti:Number(t.total_pazienti??t.total??0),infected_pazienti:Number(t.infected_pazienti??t.infected??0)})),r=s.map(t=>t.diagnosi),a=s.map(t=>Number(t.infection_rate.toFixed(2))),i=s.map(t=>{const e=t.infection_rate;return 0===e?"#48BB78":e<5?"#ECC94B":e<10?"#F6AD55":"#F56565"}),n=s.reduce((t,e)=>t+e.total_pazienti,0);return new It({labels:r,datasets:[{label:"Tasso Infezione (%)",data:a,backgroundColor:i.map(t=>{const e=t;return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, 0.8)`}),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"infection_rate",filters:null,generatedAt:new Date})}async _fetchInfectionRateFallback(s,r,a){try{let t=e.from("pazienti").select("diagnosi, infetto");t=this._applyFilters(t,a);const{data:i,error:n}=await t;if(n)throw n;const o=i.reduce((t,e)=>{const s=e.diagnosi||"Non specificata";return t[s]||(t[s]={total:0,infected:0}),t[s].total+=1,e.infetto&&(t[s].infected+=1),t},{}),l=Object.entries(o).filter(([,t])=>t.total>=s).map(([t,e])=>({diagnosi:t,infection_rate:e.infected/e.total*100,total_pazienti:e.total,infected_pazienti:e.infected})).sort((t,e)=>e.infection_rate-t.infection_rate).slice(0,r);return this._buildInfectionRateChart(l,{minPatients:s,limit:r,filters:a})}catch(i){throw t.error("Fallback infection rate query failed",i),i}}_getFromCache(t){const e=this.cache.get(t);return e?Date.now()-e.timestamp>this.CACHE_TTL?(this.cache.delete(t),null):e.data:null}_setCache(t,e){if(this.cache.set(t,{data:e,timestamp:Date.now()}),this.cache.size>50){const t=this.cache.keys().next().value;void 0!==t&&this.cache.delete(t)}}clearCache(){this.cache.clear()}};const Lt=new class{cache;CACHE_TTL;constructor(){this.cache=new Map,this.CACHE_TTL=3e5}async getMonthlyAdmissionTrends(s={}){const{months:r=12,includeInfections:a=!0,includeDismissals:i=!0,filters:n={}}=s,o=`monthly_trends_${r}_${a}_${i}_${JSON.stringify(n)}`,l=this._getFromCache(o);if(l)return t.debug("Returning cached monthly trends"),l;try{const{data:t,error:s}=await e.rpc("get_monthly_admission_trends",{p_num_months:r,p_include_infections:a,p_include_dismissals:i,filters:JSON.stringify(n)});if(s)return await this._getMonthlyTrendsDirectQuery(r,a,i,n);const l=this._formatMonthlyTrendsData(t,{months:r,includeInfections:a,includeDismissals:i});return this._setCache(o,l),l}catch(c){return t.error("Error fetching monthly admission trends",c),await this._getMonthlyTrendsDirectQuery(r,a,i,n)}}async getSeasonalDistribution(s={}){const r=`seasonal_${JSON.stringify(s)}`,a=this._getFromCache(r);if(a)return a;try{const{data:t,error:a}=await e.rpc("get_seasonal_distribution",{filters:JSON.stringify(s)});if(a)throw a;const i=this._buildSeasonalDistributionChart(t,s);return this._setCache(r,i),i}catch(i){t.warn("RPC get_seasonal_distribution failed, using fallback",i);const e=await this._getSeasonalDistributionFallback(s);return this._setCache(r,e),e}}async getAverageLengthOfStay(s={}){const{minPatients:r=3,limit:a=15,filters:i={}}=s,n=`avg_los_${r}_${a}_${JSON.stringify(i)}`,o=this._getFromCache(n);if(o)return t.debug("Returning cached average length of stay"),o;try{t.debug("Calling get_avg_length_of_stay RPC with filters:",JSON.stringify(i,null,2));const{data:s,error:o}=await e.rpc("get_avg_length_of_stay",{min_patients:r,result_limit:a,filters:JSON.stringify(i)});if(o)return t.warn("RPC get_avg_length_of_stay failed, using fallback",o),await this._getAvgLOSDirectQuery(r,a,i);const l=this._formatLengthOfStayData(s);return this._setCache(n,l),l}catch(l){return t.error("Error fetching average length of stay",l),await this._getAvgLOSDirectQuery(r,a,i)}}async _getMonthlyTrendsDirectQuery(s,r,a,i={}){try{const t=new Date;t.setMonth(t.getMonth()-s);let n=e.from("pazienti").select("data_ricovero, infetto, data_dimissione").gte("data_ricovero",t.toISOString().split("T")[0]).order("data_ricovero",{ascending:!0});n=this._applyFilters(n,i);const{data:o,error:l}=await n;if(l)throw l;const c={};o.forEach(t=>{const e=new Date(t.data_ricovero),s=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`;c[s]||(c[s]={admissions:0,infections:0,dismissals:0}),c[s].admissions++,r&&t.infetto&&c[s].infections++,a&&t.data_dimissione&&c[s].dismissals++});const u=Object.keys(c).sort(),h=[{label:"Ricoveri",data:u.map(t=>c[t].admissions),borderColor:"#4299E1",backgroundColor:"rgba(66, 153, 225, 0.3)",borderWidth:2}];r&&h.push({label:"Infezioni",data:u.map(t=>c[t].infections),borderColor:"#F56565",backgroundColor:"rgba(245, 101, 101, 0.3)",borderWidth:2}),a&&h.push({label:"Dimissioni",data:u.map(t=>c[t].dismissals),borderColor:"#48BB78",backgroundColor:"rgba(72, 187, 120, 0.3)",borderWidth:2});return new It({labels:u.map(t=>{const[e,s]=t.split("-");return new Date(parseInt(e),parseInt(s)-1).toLocaleDateString("it-IT",{month:"short",year:"numeric"})}),datasets:h,totalRecords:o.length,aggregationType:"monthly_trends",filters:null,generatedAt:new Date})}catch(n){throw t.error("Error in direct monthly trends query",n),n}}async _getAvgLOSDirectQuery(s,r,a={}){try{let t=e.from("pazienti").select("diagnosi, data_ricovero, data_dimissione").not("data_dimissione","is",null).not("data_ricovero","is",null);t=this._applyFilters(t,a);const{data:i,error:n}=await t;if(n)throw n;const o={};i.forEach(t=>{const e=new Date(t.data_ricovero),s=new Date(t.data_dimissione);if(s.getTime()>=e.getTime()){const r=(s.getTime()-e.getTime())/864e5,a=t.diagnosi||"Non specificata";o[a]||(o[a]={total:0,count:0}),o[a].total+=r,o[a].count++}});const l=Object.entries(o).filter(([,t])=>t.count>=s).map(([t,e])=>({diagnosi:t,avg_days:e.total/e.count,total_pazienti:e.count})).sort((t,e)=>e.avg_days-t.avg_days).slice(0,r);return this._formatLengthOfStayData(l)}catch(i){throw t.error("Error in direct avg LOS query",i),i}}_formatMonthlyTrendsData(t=[],e={}){const{months:s=12,includeInfections:r=!0,includeDismissals:a=!0}=e;if(!Array.isArray(t)||0===t.length)return new It({labels:[],datasets:[],totalRecords:0,aggregationType:"monthly_trends",filters:null,generatedAt:new Date});const i=[...t].sort((t,e)=>{const s=new Date(t.month_start??t.month_start_date??t.month??""),r=new Date(e.month_start??e.month_start_date??e.month??"");return s.getTime()-r.getTime()}),n=i.map(t=>{const e=new Date(t.month_start??t.month_start_date??t.month??"");return Number.isNaN(e.getTime())?t.month_label??"n/d":e.toLocaleDateString("it-IT",{month:"short",year:"numeric"})}),o=i.map(t=>Number(t.admissions)||0),l=i.map(t=>Number(t.infections)||0),c=i.map(t=>Number(t.dismissals)||0),u=[{label:"Ricoveri",data:o,borderColor:"#4299E1",backgroundColor:"rgba(66, 153, 225, 0.3)",borderWidth:2}];r&&u.push({label:"Infezioni",data:l,borderColor:"#F56565",backgroundColor:"rgba(245, 101, 101, 0.3)",borderWidth:2}),a&&u.push({label:"Dimissioni",data:c,borderColor:"#48BB78",backgroundColor:"rgba(72, 187, 120, 0.3)",borderWidth:2});const h=o.reduce((t,e)=>t+e,0);return new It({labels:n,datasets:u,totalRecords:h,aggregationType:"monthly_trends",filters:null,generatedAt:new Date})}_buildSeasonalDistributionChart(t=[],e={}){const s=[{label:"Inverno",color:"#4299E1"},{label:"Primavera",color:"#48BB78"},{label:"Estate",color:"#F6AD55"},{label:"Autunno",color:"#ED8936"}],r=s.reduce((t,e)=>(t[e.label]=0,t),{});t.forEach(t=>{const e=t.season||t.label;e&&void 0!==r[e]&&(r[e]=Number(t.patient_count??t.count??0))});const a=s.map(t=>t.label),i=a.map(t=>r[t]||0),n=i.reduce((t,e)=>t+e,0);return new It({labels:a,datasets:[{label:"Ricoveri per Stagione",data:i,backgroundColor:s.map(t=>t.color),borderColor:"#333",borderWidth:1}],totalRecords:n,aggregationType:"seasonal",filters:null,generatedAt:new Date})}async _getSeasonalDistributionFallback(s={}){try{let t=e.from("pazienti").select("data_ricovero");t=this._applyFilters(t,s);const{data:r,error:a}=await t;if(a)throw a;const i={Inverno:0,Primavera:0,Estate:0,Autunno:0};r.forEach(t=>{const e=new Date(t.data_ricovero).getMonth()+1;12===e||e<=2?i.Inverno+=1:e<=5?i.Primavera+=1:e<=8?i.Estate+=1:i.Autunno+=1});const n=Object.entries(i).map(([t,e])=>({season:t,patient_count:e}));return this._buildSeasonalDistributionChart(n,s)}catch(r){throw t.error("Fallback seasonal distribution query failed",r),r}}_formatLengthOfStayData(t){const e=t.sort((t,e)=>e.avg_days-t.avg_days);return new It({labels:e.map(t=>t.diagnosi),datasets:[{label:"Degenza Media (giorni)",data:e.map(t=>parseFloat(t.avg_days.toFixed(1))),backgroundColor:e.map((t,s)=>{const r=s/e.length;return`rgb(${Math.floor(245-100*r)}, ${Math.floor(101+100*r)}, 101)`}),borderColor:"#333",borderWidth:1}],totalRecords:e.reduce((t,e)=>t+e.total_pazienti,0),aggregationType:"length_of_stay",filters:null,generatedAt:new Date})}_applyFilters(t,e){const s=e.dateRange;s&&(s.startDate&&""!==s.startDate&&(t=t.gte("data_ricovero",s.startDate)),s.endDate&&""!==s.endDate&&(t=t.lte("data_ricovero",s.endDate)));const r=e.repartoAppartenenza;r&&(t=t.eq("reparto_appartenenza",r));const a=e.repartoProvenienza;a&&(t=t.eq("reparto_provenienza",a));const i=e.diagnosi;i&&(t=t.eq("diagnosi",i));const n=e.livelloAssistenza;n&&(t=t.eq("livello_assistenza",n));const o=e.infetto;return null!=o&&(t=t.eq("infetto",o)),t}_getFromCache(t){const e=this.cache.get(t);if(!e)return null;return Date.now()-e.timestamp>this.CACHE_TTL?(this.cache.delete(t),null):e.data}_setCache(t,e){if(this.cache.set(t,{data:e,timestamp:Date.now()}),this.cache.size>50){const t=this.cache.keys().next().value;void 0!==t&&this.cache.delete(t)}}clearCache(){this.cache.clear()}};var $t=(t=>(t.PIE="pie",t.BAR="bar",t.LINE="line",t.DOUGHNUT="doughnut",t.HORIZONTAL_BAR="horizontalBar",t))($t||{});const Ut=O.memo(({filters:e,onAnalysisTypeChange:s,className:r=""})=>{const[a,i]=R.useState("monthly_trends"),[n,o]=R.useState(!1),[l,u]=R.useState(!1),[h,d]=R.useState(""),[p,f]=R.useState(null),[y,m]=R.useState($t.LINE),g=R.useRef(null),b=R.useRef(null),v=R.useRef(!1),_=t=>{switch(t){case"monthly_trends":return $t.LINE;case"age_distribution":case"seasonal":case"assistance_level":case"dismissal_type":return $t.PIE;case"length_of_stay":case"infection_rate":return $t.HORIZONTAL_BAR;default:return $t.BAR}},C=R.useCallback(async(e,s)=>{try{let r;switch(o(!0),u(!1),d(""),t.info(` Loading analysis: ${e}`),t.info(" Filters being passed to analysis:",JSON.stringify(s,null,2)),e){case"monthly_trends":r=await Lt.getMonthlyAdmissionTrends({months:12,includeInfections:!0,includeDismissals:!0,filters:s});break;case"age_distribution":r=await Qt.getAgeDistribution(s);break;case"length_of_stay":r=await Lt.getAverageLengthOfStay({minPatients:3,limit:15,filters:s});break;case"seasonal":r=await Lt.getSeasonalDistribution(s);break;case"assistance_level":r=await Qt.getAssistanceLevelDistribution(s);break;case"dismissal_type":r=await Qt.getDismissalTypeDistribution(s);break;case"infection_rate":r=await Qt.getInfectionRateByDiagnosis({minPatients:3,limit:10,filters:s});break;default:throw new Error(`Unknown analysis type: ${e}`)}const a=_(e);b.current&&(b.current.destroy(),b.current=null);const i=g.current;if(!i)throw new Error("Canvas non trovato per il rendering del grafico");const n={type:a,data:{labels:r.labels,datasets:r.datasets.map(t=>({label:t.label,data:t.data,backgroundColor:t.backgroundColor,borderColor:t.borderColor,borderWidth:t.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:a===$t.HORIZONTAL_BAR?"y":"x",plugins:{legend:{display:a===$t.PIE||a===$t.DOUGHNUT,position:"bottom",labels:{font:{size:12},padding:15}},tooltip:{enabled:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:14,weight:"bold"},bodyFont:{size:12},padding:10}},scales:a!==$t.PIE&&a!==$t.DOUGHNUT?{y:{beginAtZero:!0,title:{display:!0,text:"length_of_stay"===e?"Giorni":"infection_rate"===e?"Tasso (%)":"Numero Pazienti"},grid:{display:!0,color:"rgba(0, 0, 0, 0.1)"}},x:{title:{display:!0,text:"monthly_trends"===e?"Mese":"length_of_stay"===e||"infection_rate"===e?"Diagnosi":"Categoria"},grid:{display:!1}}}:void 0,animation:{duration:500,easing:"easeInOutQuart"}}};b.current=new c(i,n),f(r),m(a),t.info(` Analysis loaded: ${e}`,{recordCount:r.totalRecords})}catch(r){t.error(" Error loading analysis",r),u(!0),d(r instanceof Error?r.message:"Errore durante il caricamento dell'analisi"),console.error("Errore durante il caricamento dell'analisi:",r)}finally{o(!1)}},[]),O=R.useCallback(e=>{i(e),m(_(e)),s&&s(e),t.info(` Analysis type changed to: ${e}`)},[s]),x=R.useCallback(e=>{if(p)try{u(!1),d(""),b.current&&(b.current.destroy(),b.current=null);const s=g.current;if(!s)return;const r={type:e,data:{labels:p.labels,datasets:p.datasets.map(t=>({label:t.label,data:t.data,backgroundColor:t.backgroundColor,borderColor:t.borderColor,borderWidth:t.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:e===$t.HORIZONTAL_BAR?"y":"x",plugins:{legend:{display:e===$t.PIE||e===$t.DOUGHNUT,position:"bottom"}},scales:e!==$t.PIE&&e!==$t.DOUGHNUT?{y:{beginAtZero:!0}}:void 0}};b.current=new c(s,r),m(e),t.info(`Chart type changed to: ${e}`)}catch(s){t.error("Error changing chart type",s),u(!0),d(s instanceof Error?s.message:"Errore durante il cambio tipo grafico")}},[p]);R.useEffect(()=>{v.current||(v.current=!0,C(a,e))},[]),R.useEffect(()=>{v.current&&C(a,e)},[a,e,C]),R.useEffect(()=>()=>{b.current&&(b.current.destroy(),b.current=null)},[]);return w.jsxs("div",{className:`analysis-view ${r}`,children:[w.jsx("div",{className:"analysis-type-selector mb-4",id:"analysis-type-selector",children:w.jsxs("div",{className:"btn-group",role:"group","aria-label":"Tipo di analisi",children:[w.jsx("button",{type:"button",className:"btn "+("monthly_trends"===a?"btn-primary":"btn-outline-primary"),"data-analysis":"monthly_trends",onClick:()=>O("monthly_trends"),children:"Trend Mensili"}),w.jsx("button",{type:"button",className:"btn "+("age_distribution"===a?"btn-primary":"btn-outline-primary"),"data-analysis":"age_distribution",onClick:()=>O("age_distribution"),children:"Distribuzione Et"}),w.jsx("button",{type:"button",className:"btn "+("length_of_stay"===a?"btn-primary":"btn-outline-primary"),"data-analysis":"length_of_stay",onClick:()=>O("length_of_stay"),children:"Durata Degenza"}),w.jsx("button",{type:"button",className:"btn "+("seasonal"===a?"btn-primary":"btn-outline-primary"),"data-analysis":"seasonal",onClick:()=>O("seasonal"),children:"Stagionale"}),w.jsx("button",{type:"button",className:"btn "+("assistance_level"===a?"btn-primary":"btn-outline-primary"),"data-analysis":"assistance_level",onClick:()=>O("assistance_level"),children:"Livello Assistenza"}),w.jsx("button",{type:"button",className:"btn "+("dismissal_type"===a?"btn-primary":"btn-outline-primary"),"data-analysis":"dismissal_type",onClick:()=>O("dismissal_type"),children:"Tipo Dimissione"}),w.jsx("button",{type:"button",className:"btn "+("infection_rate"===a?"btn-primary":"btn-outline-primary"),"data-analysis":"infection_rate",onClick:()=>O("infection_rate"),children:"Tasso Infezione"})]})}),w.jsx("div",{className:"chart-controls mb-3",children:w.jsxs("div",{className:"btn-group",role:"group","aria-label":"Tipo grafico",children:[w.jsx("button",{type:"button",className:"btn "+(y===$t.PIE?"btn-primary":"btn-outline-secondary"),onClick:()=>x($t.PIE),disabled:!p,children:"Torta"}),w.jsx("button",{type:"button",className:"btn "+(y===$t.BAR?"btn-primary":"btn-outline-secondary"),onClick:()=>x($t.BAR),disabled:!p,children:"Barre"}),w.jsx("button",{type:"button",className:"btn "+(y===$t.LINE?"btn-primary":"btn-outline-secondary"),onClick:()=>x($t.LINE),disabled:!p,children:"Linee"}),w.jsx("button",{type:"button",className:"btn "+(y===$t.HORIZONTAL_BAR?"btn-primary":"btn-outline-secondary"),onClick:()=>x($t.HORIZONTAL_BAR),disabled:!p,children:"Barre Oriz."})]})}),w.jsxs("div",{className:"charts-container-wrapper",children:[p&&w.jsxs("div",{className:"charts-record-count",children:["Trovati ",p.totalRecords," record"]}),w.jsxs("div",{className:"charts-chart-wrapper",style:{position:"relative"},children:[w.jsx("canvas",{ref:g,className:n||l?"d-none":"","aria-label":`Grafico analisi ${a}`}),n?w.jsxs("div",{className:"text-center p-4",children:[w.jsx("div",{className:"spinner-border text-primary",role:"status",children:w.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),w.jsx("p",{className:"mt-2",children:"Caricamento analisi in corso..."})]}):null,l?w.jsxs("div",{className:"alert alert-danger",role:"alert",children:[w.jsx("h5",{className:"alert-heading",children:"Errore"}),w.jsx("p",{children:h}),w.jsx("button",{className:"btn btn-outline-danger",onClick:()=>C(a,e),children:"Riprova"})]}):null]})]})]})});Ut.displayName="AnalysisView";const Bt=O.memo(({chartType:t,onChartTypeChange:e,hasData:s,onExport:r})=>{const a=R.useId(),[i,n]=R.useState(()=>"undefined"!=typeof window&&window.innerWidth<=767);return w.jsxs("div",{className:"charts-controls charts-collapsible "+(i?"is-collapsed":""),children:[w.jsxs("div",{className:"charts-controls-header charts-collapsible-header",children:[w.jsxs("div",{className:"charts-controls-title-wrapper",children:[w.jsx("span",{className:"material-icons","aria-hidden":"true",children:"insights"}),w.jsx("h3",{className:"charts-controls-title",children:"Tipo Grafico"})]}),w.jsx("button",{type:"button",className:"charts-collapse-toggle","aria-expanded":!i,"aria-controls":a,"aria-label":i?"Espandi controlli grafico":"Comprimi controlli grafico",onClick:()=>n(t=>!t),children:w.jsx("span",{"aria-hidden":"true",className:"material-icons",children:i?"expand_more":"expand_less"})})]}),w.jsxs("div",{className:"charts-collapsible-content",id:a,hidden:i,children:[w.jsxs("div",{className:"charts-type-selector",children:[w.jsx("label",{className:"charts-control-label",children:"Tipo Grafico:"}),w.jsxs("div",{className:"btn-group charts-segmented-group",role:"group",children:[w.jsx("button",{type:"button",className:"btn "+(t===$t.PIE?"btn-primary":"btn-outline-secondary"),onClick:()=>e($t.PIE),"aria-pressed":t===$t.PIE,children:"Torta"}),w.jsx("button",{type:"button",className:"btn "+(t===$t.BAR?"btn-primary":"btn-outline-secondary"),onClick:()=>e($t.BAR),"aria-pressed":t===$t.BAR,children:"Barre"}),w.jsx("button",{type:"button",className:"btn "+(t===$t.LINE?"btn-primary":"btn-outline-secondary"),onClick:()=>e($t.LINE),"aria-pressed":t===$t.LINE,children:"Linee"})]})]}),s&&w.jsxs("div",{className:"charts-export-controls",children:[w.jsx("label",{className:"charts-control-label",children:"Esporta:"}),w.jsxs("div",{className:"btn-group charts-segmented-group",role:"group",children:[w.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>r("image"),children:"Immagine"}),w.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>r("json"),children:"JSON"})]})]})]})]})}),Ht=({totalPatients:t,uniqueDiagnoses:e,totalDepartments:s})=>w.jsxs("div",{className:"charts-statistics",children:[w.jsx("h4",{children:"Statistiche"}),w.jsxs("div",{className:"charts-stat-grid",children:[w.jsxs("div",{className:"charts-stat-item",children:[w.jsx("span",{className:"charts-stat-label",children:"Totale Pazienti:"}),w.jsx("span",{className:"charts-stat-value",children:t})]}),void 0!==e&&w.jsxs("div",{className:"charts-stat-item",children:[w.jsx("span",{className:"charts-stat-label",children:"Diagnosi Uniche:"}),w.jsx("span",{className:"charts-stat-value",children:e})]}),void 0!==s&&w.jsxs("div",{className:"charts-stat-item",children:[w.jsx("span",{className:"charts-stat-label",children:"Reparti Totali:"}),w.jsx("span",{className:"charts-stat-value",children:s})]})]})]}),Kt=O.forwardRef(({className:t="",politeness:e="polite"},s)=>{const r=R.useRef(null),a=(t,s=e)=>{r.current&&(r.current.getAttribute("aria-live")!==s&&r.current.setAttribute("aria-live",s),r.current.textContent="",requestAnimationFrame(()=>{r.current&&(r.current.textContent=t)}))};return R.useImperativeHandle(s,()=>({announce:a})),w.jsx("div",{ref:r,className:`live-region ${t}`,"aria-live":e,"aria-atomic":"true",role:"status"})});Kt.displayName="LiveRegion";const Wt={filtered:{label:"Vista Filtrata",shortLabel:"Filtrata",icon:"filter_list",description:"Visualizza i dati filtrati per diagnosi"},comparison:{label:"Confronto Reparti",shortLabel:"Confronto",icon:"compare_arrows",description:"Confronta i dati tra i diversi reparti"},analysis:{label:"Analisi Avanzate",shortLabel:"Analisi",icon:"analytics",description:"Visualizza analisi avanzate e insight"}},Gt=R.forwardRef(({initialViewMode:e="filtered",onViewModeChange:s,containerId:r="view-mode-tabs",className:a="",compactMode:i=!1},n)=>{const[o,l]=R.useState(e),[c,u]=R.useState({filtered:!1,comparison:!1,analysis:!1}),[h,d]=R.useState(!1),p=R.useRef(null),f=R.useRef(null),y=R.useRef(null),m=R.useRef({filtered:null,comparison:null,analysis:null});R.useEffect(()=>{const t=()=>{d(window.innerWidth<=640)};let e;t();const s=()=>{clearTimeout(e),e=setTimeout(t,150)};return window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s),clearTimeout(e)}},[]);const g=i||h,b=e=>{if(e===o)return;if(y.current=document.activeElement,l(e),f.current){f.current.announce(`Tab ${{filtered:"Vista Filtrata",comparison:"Confronto Reparti",analysis:"Analisi Avanzate"}[e]} attivata`)}const r=m.current[e];r&&setTimeout(()=>{r.focus()},0),s&&s(e),t.debug("View mode tab activated",{viewMode:e})},v=(t,e)=>{u(s=>({...s,[t]:e}))};R.useEffect(()=>{e!==o&&l(e)},[e]),O.useImperativeHandle(n,()=>({getCurrentViewMode:()=>o,setActiveTab:b,setLoadingState:v,setLoadingStates:u}));const _=(t,e=!1)=>{const s=Wt[t],r=o===t,a=c[t];return w.jsx("div",{className:"nav-item",role:"presentation",children:w.jsx("button",{ref:e=>{e&&(m.current[t]=e)},className:`nav-link ${r?"active":""} ${a?"loading":""} ${e?"nav-link--icon":""}`,id:`${t}-tab`,"data-view-mode":t,type:"button",role:"tab","aria-controls":`${t}-panel`,"aria-selected":r,"aria-busy":a,"aria-label":s.description,title:s.label,onClick:()=>b(t),onKeyDown:e=>((t,e)=>{const s=["filtered","comparison","analysis"],r=s.indexOf(e);let a=null;switch(t.key){case"Enter":case" ":t.preventDefault(),b(e);break;case"ArrowLeft":case"ArrowUp":t.preventDefault(),a=s[(r-1+s.length)%s.length],b(a);break;case"ArrowRight":case"ArrowDown":t.preventDefault(),a=s[(r+1)%s.length],b(a);break;case"Home":t.preventDefault(),b(s[0]);break;case"End":t.preventDefault(),b(s[s.length-1])}})(e,t),disabled:a,children:w.jsxs(w.Fragment,e?{children:[w.jsx("span",{className:"material-icons nav-link--icon__symbol",children:s.icon}),w.jsx("span",{className:"nav-link--icon__label",children:s.shortLabel})]}:{children:[a&&w.jsxs(w.Fragment,{children:[w.jsx("span",{className:"tab-loading-spinner","aria-hidden":"true"}),w.jsxs("span",{className:"visually-hidden",children:["Caricamento ",s.label,"..."]})]}),!a&&s.label]})})},t)};return w.jsxs(w.Fragment,{children:[w.jsx(Kt,{ref:f,className:"visually-hidden",politeness:"polite"}),w.jsxs("div",{ref:p,id:r,className:`nav nav-tabs ${a} ${g?"nav-tabs--compact":""}`,role:"tablist","aria-label":"Modalit visualizzazione grafici",children:[_("filtered",g),_("comparison",g),_("analysis",g)]})]})});Gt.displayName="ViewModeTabs";const Jt=e;class Vt{async fetchChartData(e){try{t.debug("Fetching filtered chart data from Supabase",{filters:e});let s=Jt.from("pazienti").select("diagnosi");e.dateRange?.startDate&&(s=s.gte("data_ricovero",e.dateRange.startDate)),e.dateRange?.endDate&&(s=s.lte("data_ricovero",e.dateRange.endDate)),e.repartoAppartenenza&&(s=s.eq("reparto_appartenenza",e.repartoAppartenenza)),e.repartoProvenienza&&(s=s.eq("reparto_provenienza",e.repartoProvenienza)),e.diagnosi&&(s=s.eq("diagnosi",e.diagnosi)),e.livelloAssistenza&&(s=s.eq("livello_assistenza",e.livelloAssistenza)),null!=e.infetto&&(s=s.eq("infetto",e.infetto));const{data:r,error:a}=await s;if(a)throw t.error("Error fetching filtered chart data from Supabase",a),new Error("Impossibile caricare i dati filtrati");const i={};r.forEach(t=>{t.diagnosi&&(i[t.diagnosi]=(i[t.diagnosi]||0)+1)});const n=Object.keys(i),o=Object.values(i),l=this.generateColors(n.length),c=l.map(t=>this.darkenColor(t,20)),u={labels:n,datasets:[{label:"Diagnosi",data:o,backgroundColor:l,borderColor:c,borderWidth:1}],totalRecords:o.reduce((t,e)=>t+e,0),aggregationType:"diagnosis",filters:e,generatedAt:new Date};return t.debug("Filtered chart data fetched successfully from Supabase",{recordCount:u.totalRecords,diagnosesCount:u.labels.length}),u}catch(s){throw t.error("Error fetching filtered chart data",s),new Error("Impossibile caricare i dati filtrati")}}formatForDisplay(t,e){if(!t||!t.labels||0===t.labels.length)throw new Error("No chart data to format for display");const s=this.getStatistics(t),r={type:e,data:{labels:t.labels,datasets:t.datasets.map(t=>({label:t.label,data:t.data,backgroundColor:t.backgroundColor,borderColor:t.borderColor,borderWidth:t.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:e===$t.PIE,position:"right"},tooltip:{callbacks:{label:t=>{const e=t.label||"",s="number"==typeof t.parsed?t.parsed:t.parsed?.y??0;return`${e}: ${s} (${(s/t.dataset.data.reduce((t,e)=>t+e,0)*100).toFixed(1)}%)`}}}},scales:e!==$t.PIE?{y:{beginAtZero:!0,title:{display:!0,text:"Numero Pazienti"}},x:{title:{display:!0,text:"Diagnosi"}}}:void 0}},a=this.generateSuggestions(t,e);return{chartConfig:r,statistics:s,suggestions:a.length>0?{suggestNarrowing:!0,suggestions:a}:void 0}}getStatistics(t){if(!t||!t.datasets||0===t.datasets.length)return{totalPatients:0,uniqueDiagnoses:0};return{totalPatients:t.datasets.reduce((t,e)=>t+e.data.reduce((t,e)=>t+e,0),0),uniqueDiagnoses:t.labels.length}}generateColors(t){const e=["#0d6efd","#dc3545","#198754","#ffc107","#fd7e14","#6f42c1","#20c997","#6c757d","#0dcaf0","#d63384"],s=[];for(let r=0;r<t;r++)s.push(e[r%e.length]);return s}darkenColor(t,e){return t+"CC"}generateSuggestions(t,e){const s=[],r=t.labels.length;return t.totalRecords>100&&s.push("Considera di restringere il range di date per visualizzare meno dati"),r>10&&s.push("Prova a filtrare per diagnosi specifiche per risultati pi chiari"),e===$t.PIE&&r>8&&s.push("Per molti dati, il grafico a barre potrebbe essere pi leggibile"),e===$t.BAR&&r>15&&s.push("Considera di raggruppare alcune diagnosi simili"),s}}class Zt{async fetchChartData(e){try{t.debug("Fetching comparison chart data from Supabase",{filters:e});let s=Jt.from("pazienti").select("reparto_appartenenza");e.dateRange?.startDate&&(s=s.gte("data_ricovero",e.dateRange.startDate)),e.dateRange?.endDate&&(s=s.lte("data_ricovero",e.dateRange.endDate)),e.repartoAppartenenza&&(s=s.eq("reparto_appartenenza",e.repartoAppartenenza)),e.repartoProvenienza&&(s=s.eq("reparto_provenienza",e.repartoProvenienza)),e.diagnosi&&(s=s.eq("diagnosi",e.diagnosi)),e.livelloAssistenza&&(s=s.eq("livello_assistenza",e.livelloAssistenza)),null!=e.infetto&&(s=s.eq("infetto",e.infetto));const{data:r,error:a}=await s;if(a)throw t.error("Error fetching comparison chart data from Supabase",a),new Error("Impossibile caricare i dati comparativi");const i={};r.forEach(t=>{t.reparto_appartenenza&&(i[t.reparto_appartenenza]=(i[t.reparto_appartenenza]||0)+1)});const n=Object.keys(i),o=Object.values(i),l=this.generateColors(n.length),c=l.map(t=>this.darkenColor(t,20)),u={labels:n,datasets:[{label:"Reparti",data:o,backgroundColor:l,borderColor:c,borderWidth:1}],totalRecords:o.reduce((t,e)=>t+e,0),aggregationType:"department",filters:e,generatedAt:new Date};return t.debug("Comparison chart data fetched successfully from Supabase",{recordCount:u.totalRecords,departmentsCount:u.labels.length}),u}catch(s){throw t.error("Error fetching comparison chart data",s),new Error("Impossibile caricare i dati comparativi")}}formatForDisplay(t,e){if(!t||!t.labels||0===t.labels.length)throw new Error("No chart data to format for display");const s=this.getStatistics(t),r=this.generateInsights(t,e),a=this.performStatisticalAnalysis(t);return{chartConfig:{type:e,data:{labels:t.labels,datasets:t.datasets.map(t=>({label:t.label,data:t.data,backgroundColor:t.backgroundColor,borderColor:t.borderColor,borderWidth:t.borderWidth||1}))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:e===$t.PIE,position:"right"},tooltip:{callbacks:{label:t=>{const e=t.label||"",s="number"==typeof t.parsed?t.parsed:t.parsed?.y??0;return`${e}: ${s} (${(s/t.dataset.data.reduce((t,e)=>t+e,0)*100).toFixed(1)}%)`}}}},scales:e!==$t.PIE?{y:{beginAtZero:!0,title:{display:!0,text:"Numero Pazienti"}},x:{title:{display:!0,text:"Reparto"}}}:void 0}},statistics:s,insights:r,analysis:a}}getStatistics(t){if(!t||!t.datasets||0===t.datasets.length)return{totalPatients:0,totalDepartments:0};return{totalPatients:t.datasets.reduce((t,e)=>t+e.data.reduce((t,e)=>t+e,0),0),totalDepartments:t.labels.length}}generateInsights(t,e){const s=[],r=t.datasets[0].data,a=t.labels,i=Math.max(...r),n=Math.min(...r),o=r.indexOf(i),l=r.indexOf(n);s.push(`${a[o]} ha il maggior numero di pazienti (${i})`),s.push(`${a[l]} ha il minor numero di pazienti (${n})`);const c=r.reduce((t,e)=>t+e,0)/r.length;s.push(`La media dei pazienti per reparto  ${c.toFixed(1)}`);const u=r.filter(t=>t>c).length;return s.push(`${u} reparti sono sopra la media`),s}performStatisticalAnalysis(t){const e=t.datasets[0].data,s=e.reduce((t,e)=>t+e,0)/e.length,r=e.map(t=>Math.pow(t-s,2)).reduce((t,e)=>t+e,0)/e.length,a=Math.sqrt(r),i=2*a,n=[];return e.forEach((e,r)=>{Math.abs(e-s)>i&&n.push(t.labels[r])}),{statistics:{mean:s.toFixed(1),stdDev:a.toFixed(1)},hasOutliers:n.length>0,outliers:n}}generateColors(t){const e=["#0d6efd","#dc3545","#198754","#ffc107","#fd7e14","#6f42c1","#20c997","#6c757d","#0dcaf0","#d63384"],s=[];for(let r=0;r<t;r++)s.push(e[r%e.length]);return s}darkenColor(t,e){return t+"CC"}}const Yt=new Vt,Xt=new Zt,te={filtered:Yt,comparison:Xt};async function ee(){try{const[e,s,r,c]=await Promise.all([a(),i(),n(),o()]),u=l(r);return t.debug("Filter options loaded successfully",{diagnosisCount:e.length,repartoCount:s.length,provenienzaCount:c.length}),{diagnosiOptions:e,repartoOptions:s,repartoProvenienzaOptions:c,infectionOptions:u}}catch(e){const s=e instanceof Error?e.message:"Errore nel caricamento delle opzioni di filtro";throw t.error(s,e),new Error(s)}}const se=({initialViewMode:e="filtered",initialChartType:s=$t.PIE,initialFilters:r={}})=>{const[a,i]=R.useState(e),[n,o]=R.useState(s),[l,u]=R.useState(r),{diagnosiOptions:h,repartoOptions:d,repartoProvenienzaOptions:p,infectionOptions:f,isLoading:y,error:m}=(()=>{const{data:t,isLoading:e,error:s}=Pt({queryKey:["chartFilterOptions"],queryFn:ee,initialData:{diagnosiOptions:[],repartoOptions:[],repartoProvenienzaOptions:[],infectionOptions:[{value:"",label:"Tutti"},{value:"true",label:"S"},{value:"false",label:"No"}]}});return{diagnosiOptions:t.diagnosiOptions,repartoOptions:t.repartoOptions,repartoProvenienzaOptions:t.repartoProvenienzaOptions,infectionOptions:t.infectionOptions,isLoaded:!e,isLoading:e,error:s}})(),{canvasRef:g,chartData:b,statistics:v,suggestions:_,insights:C,isLoading:O,isError:x,errorMessage:D,fetchData:S}=((e,s,r)=>{const a=R.useRef(null),i=R.useRef(null);St();const{data:n,isLoading:o,isError:l,error:u,refetch:h}=Pt({queryKey:["chartData",e,s,r],queryFn:async()=>{const n={dateRange:{startDate:r.dateRange?.startDate||"",endDate:r.dateRange?.endDate||"",preset:r.dateRange?.preset||"custom"},repartoAppartenenza:r.repartoAppartenenza||"",repartoProvenienza:r.repartoProvenienza||"",diagnosi:r.diagnosi||"",livelloAssistenza:r.livelloAssistenza||null,infetto:void 0!==r.infetto&&r.infetto};let o;if("filtered"===e)o=await Yt.fetchChartData(n);else{if("comparison"!==e)return null;o=await Xt.fetchChartData(n)}const l="filtered"===e?Yt.formatForDisplay(o,s):Xt.formatForDisplay(o,s);i.current&&(i.current.destroy(),i.current=null);const u=a.current;if(!u)throw new Error("Canvas non trovato per il rendering del grafico");return i.current=new c(u,l.chartConfig),t.info("Chart rendered successfully",{viewMode:e,chartType:s,recordCount:o.totalRecords}),{fetchedData:o,displayData:l}},enabled:"analysis"!==e,select:t=>{if(!t)return null;const{fetchedData:s,displayData:r}=t;let a=null,i=null;return"filtered"===e&&"suggestions"in r&&r.suggestions?a=r.suggestions.suggestions:"comparison"===e&&"insights"in r&&r.insights&&(i=r.insights),{chartData:s,statistics:r.statistics,suggestions:a,insights:i}}}),d=R.useCallback(()=>{i.current&&(i.current.destroy(),i.current=null)},[]);return R.useEffect(()=>()=>{d()},[d]),{canvasRef:a,chartData:n?.chartData??null,statistics:n?.statistics??null,suggestions:n?.suggestions??null,insights:n?.insights??null,isLoading:o,isError:l,errorMessage:u?.message??"",fetchData:h,cleanup:d}})(a,n,l),j=R.useCallback(t=>{i(t),"filtered"===t?o($t.PIE):"comparison"===t&&o($t.BAR)},[]),E=R.useCallback(t=>{o(t)},[]),A=R.useCallback(t=>{u(t)},[]),N=R.useCallback(()=>{u({dateRange:{startDate:"",endDate:"",preset:"custom"}})},[]),T=R.useCallback(async e=>{try{if(!b)throw new Error("Nessun grafico disponibile per l'esportazione");if(t.info("Chart export requested",{format:e}),"image"===e){const t=g.current;if(t){const e=t.toDataURL("image/png"),s=document.createElement("a");s.download=`chart-${Date.now()}.png`,s.href=e,s.click()}}else if("json"===e){const t=JSON.stringify(b,null,2),e=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(e),r=document.createElement("a");r.download=`chart-data-${Date.now()}.json`,r.href=s,r.click(),URL.revokeObjectURL(s)}}catch(s){t.error("Error exporting chart",s)}},[b,g]),P=R.useCallback(()=>{S()},[S]);return w.jsxs("div",{className:"charts-page-container",children:[w.jsx("div",{className:"charts-hero",children:w.jsxs("div",{className:"charts-hero-content",children:[w.jsx("h1",{className:"charts-title",children:"Grafici Pazienti"}),w.jsx("p",{className:"charts-subtitle",children:"Visualizza grafici, applica filtri avanzati ed esporta dati in vari formati."})]})}),w.jsx(Gt,{initialViewMode:e,onViewModeChange:j,containerId:"charts-view-mode-tabs"}),!y&&w.jsx(Ft,{viewMode:a,filters:l,diagnosiOptions:h,repartoOptions:d,repartoProvenienzaOptions:p,infectionOptions:f,onApplyFilters:A,onReset:N,onApplyClick:P}),"analysis"!==a&&w.jsx(Bt,{chartType:n,onChartTypeChange:E,hasData:!!b,onExport:T}),w.jsx("div",{className:"charts-container-wrapper",children:"analysis"===a?w.jsx(Ut,{filters:l,onAnalysisTypeChange:e=>t.debug("Analysis type changed:",e)}):w.jsxs(w.Fragment,{children:[b&&w.jsxs("div",{className:"charts-record-count",children:["Trovati ",b.totalRecords," record"]}),w.jsxs("div",{className:"charts-chart-wrapper",children:[w.jsx("canvas",{ref:g,className:"charts-canvas "+(O||x?"charts-canvas--hidden":"charts-canvas--visible"),"aria-label":`Grafico a ${n===$t.PIE?"torta":n===$t.BAR?"barre":"linee"} ${"filtered"===a?"delle diagnosi":"dei reparti"}`}),O||y?w.jsxs("div",{className:"charts-loading",children:[w.jsx("div",{className:"charts-spinner",role:"status",children:w.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),w.jsx("p",{className:"charts-loading-text",children:"Caricamento dati in corso..."})]}):null,(()=>{if(!x&&!m)return null;const t=D||m?.message||"Errore sconosciuto";return w.jsxs("div",{className:"charts-error",children:[w.jsxs("svg",{className:"charts-error-icon",width:"80",height:"80",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[w.jsx("circle",{cx:"12",cy:"12",r:"10"}),w.jsx("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),w.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"15"})]}),w.jsx("h5",{className:"charts-error-title",children:"Errore"}),w.jsx("p",{className:"charts-error-message",children:t}),w.jsx("button",{className:"btn btn-outline-primary charts-action-button",onClick:()=>S(),children:"Riprova"})]})})()]}),v&&w.jsx(Ht,{totalPatients:v.totalPatients,uniqueDiagnoses:v.uniqueDiagnoses,totalDepartments:v.totalDepartments}),_&&0!==_.length?w.jsx("div",{className:"charts-suggestions",children:w.jsxs("div",{className:"charts-alert info",role:"alert",children:[w.jsx("h6",{className:"charts-alert-title",children:"Suggerimenti:"}),w.jsx("ul",{className:"charts-alert-list",children:_.map((t,e)=>w.jsx("li",{children:t},e))})]})}):null,C&&0!==C.length?w.jsx("div",{className:"charts-insights",children:w.jsxs("div",{className:"charts-alert info",role:"alert",children:[w.jsx("h6",{className:"charts-alert-title",children:"Insights:"}),w.jsx("ul",{className:"charts-alert-list",children:C.map((t,e)=>w.jsx("li",{children:t},e))})]})}):null]})})]})};se.displayName="ChartsPage";const re=Object.freeze(Object.defineProperty({__proto__:null,ChartsPage:se,ComparisonChartDataService:Zt,FilteredChartDataService:Vt,chartDataService:te,comparisonChartService:Xt,demographicAnalysisService:Qt,filteredChartService:Yt,temporalAnalysisService:Lt},Symbol.toStringTag,{value:"Module"}));export{xt as Q,O as R,St as a,kt as b,C as c,x as d,h as e,jt as f,u as g,re as i,w as j,W as k,R as r,Pt as u};
