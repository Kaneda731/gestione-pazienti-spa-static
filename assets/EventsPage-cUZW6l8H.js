import{j as e}from"./ui-vendor-CgDpQ-gO.js";import{u as a}from"./useQuery-CQTM08br.js";import{e as t,u as i}from"./index-CV8IAmz6.js";import{u as s}from"./useMutation-DBVWNDbK.js";import{R as n,b as l,u as r,j as o}from"./react-vendor-bU8fvvPN.js";import{B as c}from"./Button-CI4eP2cr.js";import{C as d}from"./CustomSelect-CyoSibfr.js";import{a as m}from"./DateRangePicker-BPmvM0J9.js";import{P as h,E as v}from"./EventFormWizard-CZKx2HDg.js";import{e as p}from"./patientService-Q1TXkVs4.js";import{a as u,I as x}from"./InterventionForm-Dtc8y6Cz.js";import{u as j}from"./useNotification-DRPixuBw.js";import{C as g}from"./ConfirmModal-DpnO8lBa.js";import{u as N}from"./useResponsive-CUIx72uV.js";import"./supabase-DpMRTrmd.js";import"./CentralizedStatisticsService-Bqj2zWIm.js";import"./WizardStepper-hBeYqTh9.js";function b(e){const a=new Map;return e.forEach(e=>{a.set(e.id,e.nome)}),a}function f(e,a,t){if("intervento"===e.tipo_evento)return e.tipo_intervento_id&&a?.has(e.tipo_intervento_id)?a.get(e.tipo_intervento_id)||"-":e.tipo_intervento||"-";if("infezione"===e.tipo_evento){if(e.agente_patogeno_id&&t?.has(e.agente_patogeno_id)){const a=t.get(e.agente_patogeno_id)||"";return e.tipo_patogeno?`${a} (${e.tipo_patogeno})`:a}return e.tipo_batterio||"-"}return"-"}const _=n.memo(({event:a,patient:t,tipiInterventoMap:i,agentiPatogeniMap:s,onEdit:n,onDelete:l,onResolve:r})=>{const o="infezione"===a.tipo_evento,d=o?"border-danger":"border-success",m=f(a,i,s),h=new Date(a.data_evento).toLocaleDateString("it-IT");return e.jsx("div",{className:`card mb-3 ${d}`,children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"card-title mb-1",children:t?`${t.nome} ${t.cognome}`:a.paziente_id}),e.jsx("span",{className:"badge "+(o?"bg-danger":"bg-primary"),role:"status","aria-label":o?"Infezione":"Intervento",children:o?"Infezione":"Intervento"})]}),e.jsx("time",{dateTime:a.data_evento,className:"text-muted small",title:h,children:h})]}),e.jsxs("p",{className:"card-text mb-2",children:[t?.codice_rad&&e.jsxs(e.Fragment,{children:[e.jsx("abbr",{title:"Codice RAD",children:"RAD"}),": ",t.codice_rad," •"," "]}),e.jsx("strong",{children:"Dettagli:"})," ","-"!==m?m:"Nessun dettaglio"]}),(a.note||a.data_fine_evento)&&e.jsxs("div",{className:"card-text small text-muted mb-3",children:[a.note&&e.jsxs("div",{className:"mb-1",children:[e.jsx("strong",{children:"Note:"})," ",a.note]}),a.data_fine_evento&&e.jsxs("div",{children:[e.jsx("strong",{children:"Data fine:"})," ",e.jsx("time",{dateTime:a.data_fine_evento,title:new Date(a.data_fine_evento).toLocaleDateString("it-IT"),children:new Date(a.data_fine_evento).toLocaleDateString("it-IT")})]})]}),e.jsxs("div",{className:"event-card-actions d-flex gap-2 mb-2",children:[e.jsx(c,{variant:"secondary",className:"event-card-action-btn",onClick:()=>n(a),"aria-label":`Modifica evento ${o?"infezione":"intervento"} del ${h}`,children:"Modifica"}),l&&e.jsx(c,{variant:"danger",className:"event-card-action-btn",onClick:()=>l(a.id),"aria-label":`Elimina evento ${o?"infezione":"intervento"} del ${h}`,children:"Elimina"}),o&&!a.data_fine_evento&&e.jsx(c,{variant:"success",className:"event-card-action-btn",onClick:()=>r(a.id),"aria-label":"Segna infezione come risolta",children:"Riattiva"})]})]})})});_.displayName="EventCard";const z=({hasFilters:a,onCreateClick:t})=>e.jsxs("div",{className:"events-empty-state",role:"status","aria-live":"polite","aria-label":a?"Nessun evento corrisponde ai filtri selezionati":"Nessun evento clinico registrato",children:[e.jsx("div",{className:"empty-icon",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:a?"filter_list_off":"event_busy"})}),e.jsx("h3",{className:"empty-title",children:a?"Nessun evento trovato":"Nessun evento registrato"}),e.jsx("p",{className:"empty-description",children:a?"Nessun evento clinico corrisponde ai criteri di ricerca selezionati. Prova a modificare i filtri o a rimuovere alcuni di essi.":"Non hai ancora registrato alcun evento clinico per i pazienti. Inizia creando il primo evento."}),!a&&e.jsxs(c,{variant:"clinical",onClick:t,className:"mt-3","aria-label":"Crea il primo evento clinico",children:[e.jsx("span",{className:"material-icons me-1",children:"add"}),"Crea Primo Evento"]})]}),y=({count:a=5})=>e.jsx("div",{className:"skeleton-cards",children:[...Array(a)].map((a,t)=>e.jsx("div",{className:"skeleton-card card mb-3",children:e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"skeleton-text skeleton-title mb-3"}),e.jsx("div",{className:"skeleton-text skeleton-subtitle mb-2"}),e.jsx("div",{className:"skeleton-text skeleton-text-line mb-2"}),e.jsx("div",{className:"skeleton-text skeleton-text-line"}),e.jsxs("div",{className:"skeleton-buttons mt-3",children:[e.jsx("div",{className:"skeleton-button"}),e.jsx("div",{className:"skeleton-button"}),e.jsx("div",{className:"skeleton-button"})]})]})},t))}),C=({rows:a=5})=>e.jsx("div",{className:"skeleton-table",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})}),e.jsx("th",{children:e.jsx("div",{className:"skeleton-text skeleton-header"})})]})}),e.jsx("tbody",{children:[...Array(a)].map((a,t)=>e.jsxs("tr",{className:"skeleton-row",children:[e.jsx("td",{children:e.jsx("div",{className:"skeleton-text"})}),e.jsx("td",{children:e.jsx("div",{className:"skeleton-text"})}),e.jsx("td",{children:e.jsx("div",{className:"skeleton-text skeleton-short"})}),e.jsx("td",{children:e.jsx("div",{className:"skeleton-text skeleton-medium"})}),e.jsxs("td",{children:[e.jsx("div",{className:"skeleton-badge"}),e.jsx("div",{className:"skeleton-badge"})]})]},t))})]})}),k={tipo_evento:[],paziente_id:void 0,paziente_search:"",data_inizio:void 0,data_fine:void 0};function S({initialFilters:e={},debounceMs:a=300,onFiltersChange:t,batchUpdateDelay:i=100}={}){const[s,n]=l.useState(()=>({...k,...e})),[r,o]=l.useState({}),[c,d]=l.useState(!1),[m,h]=l.useState(!1),v=l.useRef(),p=l.useRef(),u=l.useCallback(e=>{h(!0),v.current&&clearTimeout(v.current),v.current=setTimeout(()=>{n(e),h(!1),t&&t(e)},a)},[a,t]),x=l.useCallback((e,a)=>{const t={...s,[e]:a};u(t)},[s,u]),j=l.useCallback(e=>{const a={...s,...e};u(a)},[s,u]),g=l.useCallback(e=>{n(e),t&&t(e)},[t]),N=l.useCallback(()=>{v.current&&(clearTimeout(v.current),v.current=void 0);const e={...k};n(e),h(!1),t&&t(e)},[t]);l.useCallback((e,a)=>{o(t=>({...t,[e]:a})),d(!0),p.current&&clearTimeout(p.current),p.current=setTimeout(()=>{b()},i)},[i]);const b=l.useCallback(()=>{if(c){const e={...s,...r};u(e),o({}),d(!1),p.current&&clearTimeout(p.current)}},[s,r,c,u]),f=l.useCallback(()=>{o({}),d(!1),p.current&&clearTimeout(p.current)},[]);return l.useEffect(()=>()=>{v.current&&clearTimeout(v.current),p.current&&clearTimeout(p.current)},[]),{filters:s,pendingFilters:r,hasPendingChanges:c,updateFilter:x,updateFilters:j,setFilters:g,resetFilters:N,applyPendingFilters:b,discardPendingFilters:f,isDebouncing:m}}const w=["intervento","infezione"],E={intervento:"Intervento",infezione:"Infezione"},D=n.memo(({initialFilters:a,onFiltersChange:t,debounceMs:i=300,showQuickFilters:s=!0,showBatchControls:r=!1,compact:o=!1,compactToggleOverride:v})=>{const{filters:p,hasPendingChanges:u,updateFilter:x,updateFilters:j,resetFilters:g,applyPendingFilters:N,discardPendingFilters:b,isDebouncing:f}=S({initialFilters:a,debounceMs:i,onFiltersChange:t}),[_,z]=l.useState(p.paziente_search||""),[y,C]=l.useState(p.data_inizio||""),[k,D]=l.useState(p.data_fine||""),[F,P]=l.useState(null),[T,I]=l.useState(!1);l.useEffect(()=>{z(p.paziente_search||""),C(p.data_inizio||""),D(p.data_fine||""),p.paziente_id||P(null)},[p]);const M=l.useCallback(e=>{C(e||""),x("data_inizio",e||void 0)},[x]),R=l.useCallback(e=>{D(e||""),x("data_fine",e||void 0)},[x]),A=l.useCallback(e=>{x("tipo_evento",e?[e]:[])},[x]),$=l.useCallback(e=>{const a=new Date;let t,i;switch(a.setHours(0,0,0,0),e){case"today":t=i=a.toISOString().split("T")[0];break;case"week":const e=new Date(a);e.setDate(a.getDate()-7),t=e.toISOString().split("T")[0],i=a.toISOString().split("T")[0];break;case"month":const s=new Date(a);s.setDate(a.getDate()-30),t=s.toISOString().split("T")[0],i=a.toISOString().split("T")[0]}C(t),D(i),j({data_inizio:t,data_fine:i})},[j]),q=l.useCallback(()=>{g(),z(""),C(""),D("")},[g]),L=n.useMemo(()=>{let e=0;return p.paziente_search&&e++,p.tipo_evento&&p.tipo_evento.length>0&&e++,p.data_inizio&&e++,p.data_fine&&e++,e},[p]),O=l.useCallback(e=>{switch(e){case"paziente_search":x("paziente_id",void 0),z("");break;case"tipo_evento":x("tipo_evento",[]);break;case"data_inizio":M(null);break;case"data_fine":R(null)}},[x,M,R]);if(o){const a=Boolean(v),t=a&&v?v.expanded:T;return e.jsxs("div",{className:"debounced-event-filters compact "+(t?"is-expanded":"is-collapsed"),children:[!a&&e.jsxs("div",{className:"filters-header-bar",children:[e.jsxs("div",{className:"filters-summary",children:[e.jsxs("button",{type:"button",className:"filters-toggle-btn",onClick:()=>{a&&v?v.onToggle():I(e=>!e)},"aria-expanded":t,"aria-label":t?"Nascondi filtri":"Mostra filtri",children:[e.jsx("span",{className:"filters-toggle-icon material-icons","aria-hidden":"true",children:"filter_list"}),e.jsxs("span",{className:"filters-label",children:["Filtri ",L>0&&`(${L})`]}),e.jsx("span",{className:"filters-toggle-chevron material-icons","aria-hidden":"true",children:t?"expand_less":"expand_more"})]}),f&&e.jsx("span",{className:"spinner-border spinner-border-sm ms-2",role:"status","aria-label":"Caricamento filtri"})]}),L>0&&e.jsx(c,{variant:"link",size:"sm",onClick:q,className:"btn-reset-link",children:"Cancella tutto"})]}),L>0&&e.jsxs("div",{className:"active-filter-chips",hidden:!t,children:[p.paziente_search&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["Paziente: ",p.paziente_search]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>O("paziente_search"),"aria-label":"Rimuovi filtro paziente",children:"✕"})]}),p.tipo_evento&&p.tipo_evento.length>0&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["Tipo: ",p.tipo_evento.map(e=>E[e]).join(", ")]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>O("tipo_evento"),"aria-label":"Rimuovi filtro tipo evento",children:"✕"})]}),p.data_inizio&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["Da: ",p.data_inizio]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>O("data_inizio"),"aria-label":"Rimuovi filtro data inizio",children:"✕"})]}),p.data_fine&&e.jsxs("span",{className:"filter-chip",children:[e.jsxs("span",{className:"chip-label",children:["A: ",p.data_fine]}),e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>O("data_fine"),"aria-label":"Rimuovi filtro data fine",children:"✕"})]})]}),t&&e.jsxs("div",{className:"filters-content",children:[a&&e.jsxs("div",{className:"filters-compact-actions d-flex justify-content-end align-items-center mb-2 gap-2",children:[f&&e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-label":"Caricamento filtri"}),L>0&&e.jsx(c,{variant:"link",size:"sm",onClick:q,className:"btn-reset-link",children:"Cancella tutto"})]}),e.jsxs("div",{className:"row g-2 align-items-end",children:[e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"patient-search-compact",className:"form-label",children:"Paziente"}),e.jsx(h,{value:F,onChange:e=>{P(e),x("paziente_id",e?e.id:void 0)},placeholder:"Cerca paziente per nome, cognome o codice...",className:"form-control form-control-sm"})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"event-type-compact",className:"form-label",children:"Tipo Evento"}),e.jsx(d,{id:"event-type-compact",value:p.tipo_evento?.[0]||"",options:[{value:"",label:"Tutti"},...w.map(e=>({value:e,label:E[e]}))],onChange:A,placeholder:"Tutti"})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{className:"form-label",children:"Periodo"}),e.jsx("div",{className:"date-range-expanded",children:e.jsx(m,{startDate:y,endDate:k,onStartDateChange:M,onEndDateChange:R,startLabel:"Data Inizio",endLabel:"Data Fine",startPlaceholder:"Data inizio",endPlaceholder:"Data fine",size:"sm",clearable:!0,allowInput:!0})})]})]})]})]})}return e.jsxs("div",{className:"debounced-event-filters",children:[s&&e.jsx("div",{className:"quick-filters mb-3",children:e.jsxs("div",{className:"btn-group",role:"group",children:[e.jsx(c,{variant:"outline-primary",size:"sm",onClick:()=>$("today"),children:"Oggi"}),e.jsx(c,{variant:"outline-primary",size:"sm",onClick:()=>$("week"),children:"Ultima settimana"}),e.jsx(c,{variant:"outline-primary",size:"sm",onClick:()=>$("month"),children:"Ultimo mese"})]})}),e.jsxs("div",{className:"row g-2",children:[e.jsxs("div",{className:"col-12 col-md-5 col-lg-7",children:[e.jsx("label",{htmlFor:"patient-search",className:"form-label",children:"Paziente"}),e.jsx(h,{value:F,onChange:e=>{P(e),x("paziente_id",e?e.id:void 0)},placeholder:"Cerca paziente per nome, cognome o codice...",className:"form-control"})]}),e.jsxs("div",{className:"col-12 col-md-6 col-lg-5",children:[e.jsx("label",{htmlFor:"event-type",className:"form-label",children:"Tipo Evento"}),e.jsx(d,{id:"event-type",value:p.tipo_evento?.[0]||"",options:[{value:"",label:"Tutti"},...w.map(e=>({value:e,label:E[e]}))],onChange:A,placeholder:"Tutti",className:"form-control-sm"})]}),e.jsx("div",{className:"col-12 col-md- col-lg-5",children:e.jsx(m,{startDate:y,endDate:k,onStartDateChange:M,onEndDateChange:R,startLabel:"Data Inizio",endLabel:"Data Fine",startPlaceholder:"gg/mm/aaaa",endPlaceholder:"gg/mm/aaaa",clearable:!0,allowInput:!0})}),e.jsx("div",{className:"col-12 col-lg-6 d-flex align-items-end",children:e.jsxs("div",{className:"w-100",children:[e.jsx("div",{className:"form-label",children:" "}),e.jsx(c,{id:"reset-filters",variant:"outline-primary",size:"lg",onClick:q,disabled:0===L,className:"w-100",children:"Resetta Filtri"})]})})]}),r&&u&&e.jsx("div",{className:"batch-controls mt-3 p-2 bg-light rounded",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("small",{className:"text-muted",children:"Ci sono modifiche non applicate"}),e.jsxs("div",{className:"btn-group btn-group-sm",children:[e.jsx(c,{variant:"success",onClick:N,children:"Applica"}),e.jsx(c,{variant:"outline-secondary",onClick:b,children:"Annulla"})]})]})})]})}),F=({statistics:a,loading:t})=>t?e.jsx("div",{className:"patient-stats-grid",children:[...Array(4)].map((a,t)=>e.jsxs("div",{className:"patient-stat-card is-loading",children:[e.jsx("div",{className:"stat-icon"}),e.jsx("div",{className:"stat-value"}),e.jsx("div",{className:"stat-label"})]},t))}):e.jsxs("div",{className:"patient-stats-grid",children:[e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"timeline"})}),e.jsx("div",{className:"stat-value",children:a.total}),e.jsx("div",{className:"stat-label",children:"Totale Eventi"})]}),e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"healing"})}),e.jsx("div",{className:"stat-value",children:a.interventi}),e.jsx("div",{className:"stat-label",children:"Interventi"})]}),e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"bug_report"})}),e.jsx("div",{className:"stat-value",children:a.infezioni}),e.jsx("div",{className:"stat-label",children:"Infezioni"})]}),e.jsxs("div",{className:"patient-stat-card",children:[e.jsx("div",{className:"stat-icon",children:e.jsx("span",{className:"material-icons",children:"date_range"})}),e.jsx("div",{className:"stat-value",children:a.ultimoMese}),e.jsx("div",{className:"stat-label",children:"Nell'ultimo mese"})]})]}),P=({events:a,patients:t,loading:i,hasFilters:s=!1,onEdit:n,onDelete:l,onResolve:r,onCreateEvent:o,tipiInterventoMap:c,agentiPatogeniMap:d,currentPage:m,totalPages:h,totalCount:v,onPageChange:p})=>i?e.jsx(y,{count:10}):0===a.length?e.jsx(z,{hasFilters:s,onCreateClick:o||(()=>{})}):e.jsxs("div",{className:"virtualized-event-list",children:[e.jsx("div",{className:"mb-2 d-flex justify-content-between align-items-center",children:e.jsxs("div",{className:"text-muted small",children:["Visualizzazione ottimizzata: ",a.length," eventi"]})}),e.jsx("div",{className:"virtualized-event-list-container",children:a.map(a=>{const i=t.get(a.paziente_id);return e.jsx("div",{children:e.jsx(_,{event:a,patient:i,tipiInterventoMap:c,agentiPatogeniMap:d,onEdit:n,onDelete:l,onResolve:r})},a.id)})}),a.length>0&&"number"==typeof m&&"number"==typeof h&&p?e.jsx("nav",{"aria-label":"Paginazione eventi clinici",className:"mt-3",children:e.jsxs("div",{className:"d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2",children:[e.jsxs("div",{className:"text-muted small text-center text-sm-start",role:"status","aria-live":"polite","aria-atomic":"true",children:["Pagina ",m," di ",h," • ",v??a.length," eventi totali"]}),e.jsxs("div",{className:"d-flex gap-2",role:"group","aria-label":"Navigazione pagine",children:[e.jsxs("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>p(Math.max(1,m-1)),disabled:m<=1,"aria-label":`Vai alla pagina precedente (attualmente a pagina ${m} di ${h})`,"aria-pressed":!1,children:[e.jsx("span",{className:"material-icons me-1 align-middle","aria-hidden":"true",children:"chevron_left"}),"Precedente"]}),e.jsxs("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>p(Math.min(h,m+1)),disabled:m>=h,"aria-label":`Vai alla pagina successiva (attualmente a pagina ${m} di ${h})`,"aria-pressed":!1,children:["Successivo",e.jsx("span",{className:"material-icons ms-1 align-middle","aria-hidden":"true",children:"chevron_right"})]})]})]})}):a.length>0&&e.jsx("div",{className:"text-center mt-3",children:e.jsxs("div",{className:"text-muted small",children:[a.length," eventi totali"]})})]}),T=({events:a,patients:t,loading:i,hasFilters:s=!1,onEdit:n,onDelete:l,onResolve:r,onCreateEvent:o,currentPage:d,totalPages:m,pageSize:h,onPageChange:v,onPageSizeChange:p,tipiInterventoMap:u,agentiPatogeniMap:x})=>i?e.jsx(C,{rows:h}):0===a.length?e.jsx(z,{hasFilters:s,onCreateClick:o||(()=>{})}):e.jsxs("div",{className:"virtualized-events-table",children:[e.jsxs("div",{className:"mb-2 d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"text-muted small",children:["Visualizzazione ottimizzata: ",a.length," eventi"]}),e.jsx("div",{children:e.jsx("select",{value:h,onChange:e=>p(Number(e.target.value)),className:"form-select form-select-sm",style:{width:"auto"},children:[10,20,50,100].map(a=>e.jsxs("option",{value:a,children:["Mostra ",a]},a))})})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-striped table-hover",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Paziente"}),e.jsx("th",{children:"Tipo Evento"}),e.jsx("th",{children:"Data"}),e.jsx("th",{children:"Dettagli"}),e.jsx("th",{children:"Azioni"})]})}),e.jsx("tbody",{children:a.map(a=>{const i=t.get(a.paziente_id),s=i&&i.eventi_clinici?.some(e=>"infezione"===e.tipo_evento&&!e.data_fine_evento);return e.jsxs("tr",{className:`event-row ${s?"event-row-infected-patient":""}`,title:s?"Evento di paziente con infezione attiva":void 0,children:[e.jsx("td",{children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("div",{className:"fw-semibold",children:i?`${i.nome} ${i.cognome}`:a.paziente_id}),i?.codice_rad&&e.jsxs("div",{className:"small text-muted",children:["RAD: ",i.codice_rad]}),s&&e.jsxs("div",{className:"small text-danger",children:[e.jsx("span",{className:"material-icons fs-6 me-1",style:{verticalAlign:"middle"},children:"coronavirus"}),"Infezione Attiva"]})]})}),e.jsx("td",{children:e.jsx("span",{className:"badge "+("intervento"===a.tipo_evento?"bg-primary":"bg-danger"),children:"intervento"===a.tipo_evento?"Intervento":"Infezione"})}),e.jsx("td",{children:e.jsx("div",{className:"text-nowrap",children:new Date(a.data_evento).toLocaleDateString("it-IT")})}),e.jsx("td",{children:f(a,u,x)}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(c,{variant:"link",size:"sm",onClick:()=>n(a),title:"Modifica evento",className:"p-1",children:e.jsx("span",{className:"material-icons fs-5",children:"edit"})}),l&&e.jsx(c,{variant:"link",size:"sm",onClick:()=>l(a.id),title:"Elimina evento",className:"p-1 text-danger",children:e.jsx("span",{className:"material-icons fs-5",children:"delete"})}),"infezione"===a.tipo_evento&&!a.data_fine_evento&&e.jsx(c,{variant:"link",size:"sm",onClick:()=>r(a.id),title:"Risolvi infezione",className:"p-1 text-success",children:e.jsx("span",{className:"material-icons fs-5",children:"check_circle"})})]})})]},a.id)})})]})}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-3",children:[e.jsxs("div",{className:"text-muted small",children:["Pagina ",d," di ",m," • ",a.length," eventi totali"]}),e.jsx("nav",{children:e.jsxs("ul",{className:"pagination pagination-sm mb-0",children:[e.jsx("li",{className:"page-item "+(1===d?"disabled":""),children:e.jsx("button",{className:"page-link",onClick:()=>v(d-1),disabled:1===d,children:e.jsx("span",{className:"material-icons",children:"chevron_left"})})}),[...Array(Math.min(5,m)).keys()].map(a=>{const t=a+1;let i=t;return m>5&&(i=d<=3?t:d>=m-2?m-4+t:d-2+t),e.jsx("li",{className:"page-item "+(d===i?"active":""),children:e.jsx("button",{className:"page-link",onClick:()=>v(i),children:i})},i)}),e.jsx("li",{className:"page-item "+(d===m?"disabled":""),children:e.jsx("button",{className:"page-link",onClick:()=>v(d+1),disabled:d===m,children:e.jsx("span",{className:"material-icons",children:"chevron_right"})})})]})})]})]}),I={intervento:"Intervento Chirurgico",infezione:"Infezione"},M=["intervento","infezione"],R=({event:a,patientId:t,onSubmit:i,onCancel:s,initialEventType:n,allowedTypes:r,isSubmitting:o=!1})=>{const[c,d]=l.useState(()=>{if(a?.tipo_evento)return a.tipo_evento;if(n&&(!r||r.includes(n)))return n;return(r||M)[0]}),[m,v]=l.useState(t),[p,j]=l.useState(null);l.useEffect(()=>{a?.tipo_evento&&d(a.tipo_evento)},[a?.tipo_evento]);const g=r||M,N=!a&&g.length>1,b=a||m;return e.jsxs("div",{className:"typed-event-form",children:[!a&&e.jsx("div",{className:"card mb-4",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("h5",{className:"card-title mb-3",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1.25rem",marginRight:"0.5rem",verticalAlign:"middle"},children:"person_search"}),"Seleziona Paziente"]}),e.jsx(h,{value:p,onChange:e=>{e?(v(e.id),j(e)):(v(""),j(null))},placeholder:"Cerca per nome, cognome o RAD...",disabled:o,activeOnly:!1,maxResults:10,minSearchLength:1,debounceDelay:300,showPatientInfo:!0,highlightMatch:!0}),m&&p&&e.jsxs("div",{className:"alert alert-success mt-2 mb-0",role:"alert",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"check_circle"}),"Paziente selezionato: ",e.jsxs("strong",{children:[p.cognome," ",p.nome]})]}),!m&&e.jsxs("div",{className:"alert alert-info mt-2 mb-0",role:"alert",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"info"}),"Seleziona un paziente per continuare"]})]})}),N&&b&&e.jsx("div",{className:"card mb-4",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"card-title mb-3",children:"Seleziona Tipo Evento"}),e.jsx("div",{className:"btn-group w-100",role:"group",children:g.map(a=>e.jsx("button",{type:"button",className:"btn "+(c===a?"btn-primary active":"btn-outline-primary"),onClick:()=>{d(a)},disabled:o,children:I[a]},a))}),e.jsx("div",{className:"mt-2 text-center",children:e.jsxs("small",{className:"text-muted",children:["Tipo selezionato: ",e.jsx("strong",{children:I[c]})]})})]})}),b&&e.jsx("intervento"===c?u:x,{event:a,patientId:m,onSubmit:i,onCancel:s,isSubmitting:o})]})},A=()=>{const n=r(),{notify:d}=j(),m=t(),{user:h}=i(),u=N(),x=u.isMobile;l.useEffect(()=>{const e=document.documentElement.style.scrollBehavior;document.documentElement.style.scrollBehavior="auto",window.scrollTo(0,0);const a=setTimeout(()=>{window.scrollTo(0,0)},100),t=setTimeout(()=>{window.scrollTo(0,0),document.documentElement.style.scrollBehavior=e},300);return()=>{clearTimeout(a),clearTimeout(t),document.documentElement.style.scrollBehavior=e}},[]);const[f,_]=o(),[z,y]=l.useState(null),[C,k]=l.useState(null),[w,E]=l.useState(1),[I,M]=l.useState(10),[A,$]=l.useState(!1),[q,L]=l.useState("create"),[O,K]=l.useState(null),[B,Q]=l.useState(!1),[V,Y]=l.useState({title:"",body:"",onConfirm:()=>{}}),[U,W]=l.useState(!u.isMobile),G=l.useCallback(()=>{W(e=>!e)},[]),{filters:H,updateFilters:J}=S({onFiltersChange:()=>E(1)});l.useEffect(()=>{const e=f.get("action"),a=f.get("type"),t=f.get("paziente");t&&(k(t),J({paziente_id:t})),"add"===e&&a&&t&&(y(a),setTimeout(()=>{x?n(`/eventi-clinici/nuovo?patientId=${t}&type=${a}`):(L("create"),$(!0))},100)),(e||a||t)&&_({},{replace:!0})},[]);const X=l.useMemo(()=>["eventi",JSON.stringify(H),w,I],[H,w,I]),{data:Z,isLoading:ee,error:ae}=a({queryKey:X,queryFn:()=>p.getAllEventi(H,{page:w,limit:I})}),{data:te,isLoading:ie}=a({queryKey:["eventiStats"],queryFn:p.getEventiStats,initialData:{total:0,interventi:0,infezioni:0,ultimoMese:0}}),{data:se}=a({queryKey:["tipiIntervento"],queryFn:p.getListaTipiIntervento}),{data:ne}=a({queryKey:["agentiPatogeni"],queryFn:p.getListaAgentiPatogeno}),le=l.useMemo(()=>se?b(se):new Map,[se]),re=l.useMemo(()=>ne?b(ne):new Map,[ne]),{eventi:oe=[],totalPages:ce=1,totalCount:de=0}=Z||{},me=l.useMemo(()=>{const e=new Map;return oe.forEach(a=>{e.has(a.paziente_id)||e.set(a.paziente_id,a.pazienti)}),e},[oe]),he=l.useMemo(()=>{let e=0;return(H.paziente_search||H.paziente_id)&&e++,H.tipo_evento&&H.tipo_evento.length>0&&e++,H.data_inizio&&e++,H.data_fine&&e++,e},[H]),ve={onSuccess:()=>{m.invalidateQueries({queryKey:["eventi"]}),m.invalidateQueries({queryKey:["eventiStats"]}),_e()},onError:e=>{d.error(e.message||"Si è verificato un errore").show()}},pe=s({mutationFn:e=>p.createEvento(e),...ve}),ue=s({mutationFn:e=>p.updateEvento(e.id,e.eventData),...ve}),xe=s({mutationFn:e=>p.deleteEvento(e),onSuccess:()=>{m.invalidateQueries({queryKey:["eventi"]}),m.invalidateQueries({queryKey:["eventiStats"]}),Q(!1)},onError:ve.onError}),je=s({mutationFn:e=>p.resolveInfezione(e.id,e.dataFine),onSuccess:()=>{m.invalidateQueries({queryKey:["eventi"]}),Q(!1)},onError:ve.onError}),ge=async e=>{"create"===q?await pe.mutateAsync(e):O&&await ue.mutateAsync({id:O.id,eventData:e})},Ne=e=>{if("viewer"===h?.role)return d.error("Non hai i permessi per eliminare eventi").show(),void 0;ze("Conferma Eliminazione","Sei sicuro di voler eliminare questo evento?",()=>{xe.mutate(e)})},be=e=>{const a=prompt("Inserisci la data di risoluzione (YYYY-MM-DD):");a&&ze("Conferma Risoluzione",`Sei sicuro di voler risolvere l'infezione in data ${a}?`,()=>{je.mutate({id:e,dataFine:a})})},fe=(e,a)=>{if("create"===e&&x)return n("/eventi-clinici/nuovo"),void 0;L(e),K(a||null),$(!0)},_e=()=>{$(!1),K(null),L("create")};l.useEffect(()=>{A&&x&&requestAnimationFrame(()=>{window.scrollTo(0,0)})},[A,x]);const ze=(e,a,t)=>{Y({title:e,body:a,onConfirm:t}),Q(!0)};return e.jsxs(e.Fragment,{children:[e.jsx(g,{...V,isOpen:B,onCancel:()=>Q(!1)}),e.jsxs("div",{className:"clinical-events-page",children:[e.jsx("div",{className:"patient-list-hero clinical-hero",children:e.jsxs("div",{className:"patient-list-hero-content",children:[e.jsxs("h1",{className:"patient-list-title",children:[e.jsx("span",{className:"material-icons me-2",children:"timeline"}),"Eventi Clinici"]}),e.jsx("p",{className:"patient-list-subtitle",children:"Gestisci eventi clinici, filtra per tipo e data, esporta i risultati"})]})}),ae&&e.jsx("div",{className:"alert alert-danger",children:"Errore nel caricamento degli eventi. Riprova."}),e.jsx(F,{statistics:te,loading:ie}),e.jsxs("section",{className:"patient-filters-card"+(x?" clinical-filters-collapsible":""),children:[e.jsxs("div",{className:"patient-filters-header",children:[e.jsxs("div",{className:"filters-title-wrapper",children:[e.jsx("span",{className:"material-icons","aria-hidden":"true",children:"filter_list"}),e.jsx("h2",{className:"filters-title",children:"Filtri Eventi"}),x&&he>0&&e.jsx("span",{className:"filters-active-count","aria-label":`${he} filtri attivi`,children:he})]}),x&&e.jsx("button",{type:"button",className:"filters-collapse-toggle",onClick:G,"aria-expanded":U,"aria-controls":"clinical-event-filters","aria-label":U?"Nascondi filtri eventi clinici":"Mostra filtri eventi clinici",children:e.jsx("span",{className:"material-icons","aria-hidden":"true",children:U?"expand_less":"expand_more"})})]}),e.jsx("div",{className:"patient-filters-body",id:"clinical-event-filters",hidden:x&&!U,children:e.jsx(D,{initialFilters:H,onFiltersChange:J,compact:x,compactToggleOverride:x?{expanded:U,onToggle:G}:void 0})})]}),e.jsxs("section",{className:"patient-results-card",children:[e.jsx("div",{className:"patient-results-header",children:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%"},children:[e.jsxs("h2",{className:"results-title",children:[e.jsx("span",{className:"material-icons",children:"list"}),"Eventi (",de,")"]}),"viewer"!==h?.role&&e.jsxs(c,{variant:"clinical",onClick:()=>fe("create"),className:"btn-nuovo-evento",style:{padding:"0.65rem 1.5rem",fontSize:"1rem",fontWeight:"600",whiteSpace:"nowrap"},children:[e.jsx("span",{className:"material-icons align-middle",style:{marginRight:"0.5rem",fontSize:"1.3rem"},children:"add"}),"Nuovo Evento"]})]})}),e.jsx("div",{className:"patient-results-body",children:"cards"===u.viewMode?e.jsx(P,{events:oe,patients:me,loading:ee,hasFilters:he>0,onEdit:e=>fe("edit",e),onDelete:"viewer"!==h?.role?Ne:void 0,onResolve:be,onCreateEvent:()=>fe("create"),tipiInterventoMap:le,agentiPatogeniMap:re,currentPage:w,totalPages:ce,totalCount:de,onPageChange:E}):e.jsx(T,{events:oe,patients:me,loading:ee,hasFilters:he>0,onEdit:e=>fe("edit",e),onDelete:"viewer"!==h?.role?Ne:void 0,onResolve:be,onCreateEvent:()=>fe("create"),currentPage:w,totalPages:ce,pageSize:I,onPageChange:E,onPageSizeChange:M,tipiInterventoMap:le,agentiPatogeniMap:re})})]}),A&&x&&e.jsx("div",{className:"event-wizard-mobile-overlay",children:e.jsx(v,{patientId:O?.paziente_id||"",event:O||void 0,onSubmit:ge,onCancel:_e})}),A&&!x&&e.jsx("div",{className:"modal fade show modal-themed-purple",style:{display:"block"},tabIndex:-1,children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{className:"modal-header-hero",children:[e.jsx("div",{className:"modal-header-icon",children:e.jsx("span",{className:"material-icons",children:"timeline"})}),e.jsxs("div",{className:"modal-header-text",children:[e.jsx("h5",{className:"modal-title",children:"create"===q?"Nuovo Evento":"Modifica Evento"}),O&&me.get(O.paziente_id)&&e.jsxs("p",{className:"modal-subtitle",children:[e.jsx("span",{className:"material-icons",children:"person"}),me.get(O.paziente_id)?.cognome," ",me.get(O.paziente_id)?.nome]})]})]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:_e})]}),e.jsx("div",{className:"modal-body",children:e.jsx(R,{event:O||void 0,patientId:O?.paziente_id||C||"",onSubmit:ge,onCancel:_e,isSubmitting:pe.isPending||ue.isPending,initialEventType:z||void 0})})]})})})]}),"    "]})};export{A as EventsPage,A as default};
