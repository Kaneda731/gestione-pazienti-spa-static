const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ConfirmModal-BGl6_Lcm.js","assets/index-3IpvjS9T.js","assets/supabase-AmyKTmiY.js","assets/vendor-BU6HxVpN.js","assets/index-CIUH-r2y.css"])))=>i.map(i=>d[i]);
import{_ as t}from"./supabase-AmyKTmiY.js";import{d as e,b as n,l as i,s as a,a as s,c as o}from"./index-3IpvjS9T.js";import{g as r,p as l}from"./helpers-ColeQN_T.js";import{patientService as c}from"./patientService-DKDslI8e.js";import{f as d}from"./formatting-C7G90sDQ.js";import{g as p}from"./post-operative-calculator-C3z7C_vm.js";import{i as u}from"./CustomSelect-BDJKwdbT.js";import"./vendor-BU6HxVpN.js";import"./infectionDataManager-BMqDmlOT.js";class m{constructor(t,e={}){this.patient=t,this.options={isMobile:!1,isTable:!1,...e}}render(){const t=this.patient.data_dimissione;return this.options.isTable?this.renderTableButtons(t):this.options.isMobile?this.renderMobileButtons(t):this.renderDesktopButtons(t)}renderTableButtons(t){return`\n            <button class="btn btn-sm btn-outline-primary me-1" data-action="edit" data-id="${this.patient.id}" title="Modifica">\n                <span class="material-icons" style="font-size: 1.1em; pointer-events: none;">edit</span>\n            </button>\n            ${t?`<button class="btn btn-sm btn-outline-success" data-action="riattiva" data-id="${this.patient.id}" title="Riattiva Paziente">\n                 <span class="material-icons" style="font-size: 1.1em; pointer-events: none;">undo</span>\n               </button>`:`<button class="btn btn-sm btn-outline-warning" data-action="dimetti" data-id="${this.patient.id}" title="Dimetti Paziente">\n                 <span class="material-icons" style="font-size: 1.1em; pointer-events: none;">event_available</span>\n               </button>`}\n            <button class="btn btn-sm btn-outline-danger ms-1" data-action="delete" data-id="${this.patient.id}" title="Elimina">\n                <span class="material-icons" style="font-size: 1.1em; pointer-events: none;">delete</span>\n            </button>\n        `}renderMobileButtons(t){return`\n            <button class="btn btn-outline-primary mobile-action-btn" data-action="edit" data-id="${this.patient.id}" title="Modifica">\n                <span class="material-icons">edit</span>\n                <span class="mobile-btn-text">Modifica</span>\n            </button>\n            ${t?`<button class="btn btn-outline-success mobile-action-btn" data-action="riattiva" data-id="${this.patient.id}" title="Riattiva">\n                 <span class="material-icons">undo</span>\n                 <span class="mobile-btn-text">Riattiva</span>\n               </button>`:`<button class="btn btn-outline-warning mobile-action-btn" data-action="dimetti" data-id="${this.patient.id}" title="Dimetti">\n                 <span class="material-icons">event_available</span>\n                 <span class="mobile-btn-text">Dimetti</span>\n               </button>`}\n            <button class="btn btn-outline-danger mobile-action-btn" data-action="delete" data-id="${this.patient.id}" title="Elimina">\n                <span class="material-icons">delete</span>\n                <span class="mobile-btn-text">Elimina</span>\n            </button>\n        `}renderDesktopButtons(t){return`\n            <button class="btn btn-outline-primary" data-action="edit" data-id="${this.patient.id}">\n                <span class="material-icons me-1" style="font-size: 1em;">edit</span>Modifica\n            </button>\n            ${t?`<button class="btn btn-outline-success" data-action="riattiva" data-id="${this.patient.id}" title="Riattiva Paziente">\n                 <span class="material-icons me-1" style="font-size: 1em;">undo</span>Riattiva\n               </button>`:`<button class="btn btn-outline-warning" data-action="dimetti" data-id="${this.patient.id}" title="Dimetti Paziente">\n                 <span class="material-icons me-1" style="font-size: 1em;">event_available</span>Dimetti\n               </button>`}\n            <button class="btn btn-outline-danger" data-action="delete" data-id="${this.patient.id}">\n                <span class="material-icons me-1" style="font-size: 1em;">delete</span>Elimina\n            </button>\n        `}}class v{constructor(t){this.patient=t}render(){return this.patient.data_dimissione?"decesso"===this.patient.tipo_dimissione?'<span class="badge bg-dark">Decesso</span>':'<span class="badge bg-secondary">Dimesso</span>':'<span class="badge bg-success">Attivo</span>'}renderForCard(){const t=this.patient.data_dimissione,e=t&&"decesso"===this.patient.tipo_dimissione;return`<span class="patient-status ${e?"decesso":t?"dimesso":"attivo"}">${e?"Decesso":t?"Dimesso":"Attivo"}</span>`}getStatusClass(){return this.patient.data_dimissione?"decesso"===this.patient.tipo_dimissione?"decesso":"dimesso":"attivo"}getStatusText(){return this.patient.data_dimissione?"decesso"===this.patient.tipo_dimissione?"Decesso":"Dimesso":"Attivo"}}class b{constructor(t,e={}){this.patient=t,this.options={isMobile:window.innerWidth<=767,showActions:!0,showClinicalEvents:!1,showPostOperativeDays:!0,...e}}render(){const t=this.patient.data_dimissione?"error":"success",n=e.profile?.role,i="admin"===n||"editor"===n;return this.options.isMobile?this.renderMobileCard(t,i):this.renderDesktopCard(t,i)}getLastInterventionDate(){if(!this.patient.eventi_clinici||0===this.patient.eventi_clinici.length)return null;const t=this.patient.eventi_clinici.filter(t=>"intervento"===t.tipo_evento).sort((t,e)=>new Date(e.data_evento)-new Date(t.data_evento));return t.length>0?new Date(t[0].data_evento).toLocaleDateString():null}isPatientInfected(){return!0===this.patient.infetto||"true"===this.patient.infetto}renderMobileCard(t,e){const n=this.options.showActions&&e?new m(this.patient,{isMobile:!0}).render():"",i=this.options.showPostOperativeDays&&this.patient.eventi_clinici?p(this.patient.eventi_clinici):null,a=i&&i.hasStatus?`<span class="badge bg-${i.statusClass} ms-1" style="font-size: 0.7em;">${i.badgeText}</span>`:"",s=this.getLastInterventionDate(),o=this.isPatientInfected(),r=o?'<span class="badge bg-warning text-dark ms-1" style="font-size: 0.7em;">\n                 <span class="material-icons" style="font-size: 0.6em;">warning</span> Infetto\n               </span>':"",l=[];i&&i.hasStatus&&l.push(i.statusText),s&&l.push(`Intervento: ${s}`);const c=this.options.showClinicalEvents&&e?this.renderMobileQuickActions():"";return`\n            <div class="card ${o?"card-list-compact status-infected":"card-list-compact"} status-${t}">\n                <div class="card-body">\n                    <div class="card-info">\n                        <div class="card-title d-flex align-items-center gap-2">\n                            <span class="material-icons text-primary" style="font-size:1.4em;">person</span>\n                            <span class="fw-bold">${this.patient.cognome} ${this.patient.nome}</span>\n                            ${a}${r}\n                        </div>\n                        <div class="card-meta mobile-text-sm">\n                            ${this.patient.diagnosi} ‚Ä¢ ${this.patient.reparto_appartenenza}\n                            ${l.length>0?` ‚Ä¢ ${l.join(" ‚Ä¢ ")}`:""}\n                        </div>\n                    </div>\n                    <div class="mobile-actions-container">\n                        ${n?`<div class="mobile-primary-actions">${n}</div>`:""}\n                        ${c}\n                    </div>\n                </div>\n            </div>\n        `}renderMobileQuickActions(){return`\n            <div class="mobile-quick-actions mt-2">\n                <div class="mobile-clinical-actions">\n                    <button type="button" class="btn btn-outline-primary mobile-clinical-btn btn-add-intervention" \n                            data-patient-id="${this.patient.id}" \n                            title="Aggiungi Intervento">\n                        <span class="material-icons">medical_services</span>\n                        <span class="mobile-clinical-text">Intervento</span>\n                    </button>\n                    <button type="button" class="btn btn-outline-warning mobile-clinical-btn btn-add-infection" \n                            data-patient-id="${this.patient.id}" \n                            title="Aggiungi Infezione">\n                        <span class="material-icons">warning</span>\n                        <span class="mobile-clinical-text">Infezione</span>\n                    </button>\n                    <button type="button" class="btn btn-outline-info mobile-clinical-btn btn-view-events" \n                            data-patient-id="${this.patient.id}" \n                            title="Timeline Eventi">\n                        <span class="material-icons">timeline</span>\n                        <span class="mobile-clinical-text">Timeline</span>\n                    </button>\n                </div>\n            </div>\n        `}renderDesktopCard(t,e){const n=new v(this.patient).renderForCard(),i=this.options.showActions&&e?new m(this.patient,{isMobile:!1}).render():"",a=this.options.showPostOperativeDays&&this.patient.eventi_clinici?p(this.patient.eventi_clinici):null,s=a&&a.hasStatus?`<span class="badge bg-${a.statusClass} ms-2" title="${a.statusText}">${a.badgeText}</span>`:"",o=this.isPatientInfected(),r=o?'<span class="badge bg-warning text-dark ms-2" title="Paziente infetto">\n                 <span class="material-icons" style="font-size: 0.8em;">warning</span> Infetto\n               </span>':"",l=this.options.showClinicalEvents&&this.patient.eventi_clinici?this.renderClinicalEventsTimeline():"",c=this.options.showClinicalEvents&&e?this.renderQuickActions():"";return`\n            <div class="${o?"patient-card patient-card-infected":"patient-card"}">\n                <div class="patient-card-header d-flex align-items-center gap-2">\n                    <span class="material-icons text-primary" style="font-size:1.7em;">person</span>\n                    <h6 class="patient-name fw-bold mb-0">${this.patient.cognome} ${this.patient.nome}</h6>\n                    ${s}${r}\n                    <span class="flex-grow-1"></span>\n                    ${n}\n                </div>\n                <div class="patient-details">\n                    <div class="patient-detail">\n                        <span class="patient-detail-label">Data Ricovero</span>\n                        <span class="patient-detail-value">${d(this.patient.data_ricovero)}</span>\n                    </div>\n                    <div class="patient-detail">\n                        <span class="patient-detail-label">Diagnosi</span>\n                        <span class="patient-detail-value">${this.patient.diagnosi}</span>\n                    </div>\n                    <div class="patient-detail">\n                        <span class="patient-detail-label">Reparto</span>\n                        <span class="patient-detail-value">${this.patient.reparto_appartenenza}</span>\n                    </div>\n                    <div class="patient-detail">\n                        <span class="patient-detail-label">Livello</span>\n                        <span class="patient-detail-value">${this.patient.livello_assistenza}</span>\n                    </div>\n                    ${o?'\n                    <div class="patient-detail">\n                        <span class="patient-detail-label">Stato Infezione</span>\n                        <span class="patient-detail-value text-warning fw-bold">\n                            <span class="material-icons" style="font-size: 1em; vertical-align: middle;">warning</span>\n                            Paziente Infetto\n                        </span>\n                    </div>\n                    ':""}\n                    ${a&&a.hasStatus?`\n                    <div class="patient-detail">\n                        <span class="patient-detail-label">Post-Operatorio</span>\n                        <span class="patient-detail-value">${a.statusText}</span>\n                    </div>\n                    `:""}\n                </div>\n                ${l}\n                ${c}\n                ${i?`<div class="patient-actions">${i}</div>`:""}\n            </div>\n        `}getTransferInfo(){if(!this.patient.data_dimissione||!this.patient.tipo_dimissione)return"-";switch(this.patient.tipo_dimissione){case"trasferimento_interno":return this.patient.reparto_destinazione?`<small class="text-info"><strong>‚Üí ${this.patient.reparto_destinazione}</strong></small>`:'<small class="text-muted">Interno</small>';case"trasferimento_esterno":let t='<small class="text-warning"><strong>Esterno</strong>';if(this.patient.clinica_destinazione&&(t+=`<br>‚Üí ${this.patient.clinica_destinazione}`),this.patient.codice_clinica){t+=`<br>(${"56"===this.patient.codice_clinica?"Riab. Motoria":"60"===this.patient.codice_clinica?"Lunga Degenza":`Cod. ${this.patient.codice_clinica}`})`}return t+="</small>",t;default:return'<small class="text-muted">-</small>'}}renderTableRow(){const t=new v(this.patient).render(),n=e.profile?.role,i=this.options.showActions&&("admin"===n||"editor"===n)?new m(this.patient,{isTable:!0}).render():"",a=this.options.showPostOperativeDays&&this.patient.eventi_clinici?p(this.patient.eventi_clinici):null,s=a&&a.hasStatus?`<span class="badge bg-${a.statusClass}" title="${a.statusText}">${a.badgeText}</span>`:"-",o=this.getTransferInfo(),r=this.isPatientInfected(),l=r?'<span class="badge bg-warning text-dark ms-1" title="Paziente infetto">\n                 <span class="material-icons" style="font-size: 0.8em;">warning</span> Infetto\n               </span>':"";return`\n            <tr class="${r?"table-warning":""}">\n                <td data-label="Cognome">${this.patient.cognome}</td>\n                <td data-label="Nome">${this.patient.nome}</td>\n                <td data-label="Data Nascita">${this.patient.data_nascita?d(this.patient.data_nascita):"-"}</td>\n                <td data-label="Data Ricovero">${d(this.patient.data_ricovero)}</td>\n                <td data-label="Diagnosi">${this.patient.diagnosi}</td>\n                <td data-label="Reparto">${this.patient.reparto_appartenenza}</td>\n                <td data-label="Post-Op">${s}</td>\n                <td data-label="Stato">${t}${l}</td>\n                <td data-label="Trasferimento">${o}</td>\n                <td class="text-nowrap">\n                    ${i}\n                </td>\n            </tr>\n        `}renderClinicalEventsTimeline(){if(!this.patient.eventi_clinici||0===this.patient.eventi_clinici.length)return'\n                <div class="clinical-events-section mt-3">\n                    <h6 class="clinical-events-title">Eventi Clinici</h6>\n                    <p class="text-muted small">Nessun evento clinico registrato</p>\n                </div>\n            ';const t=[...this.patient.eventi_clinici].sort((t,e)=>new Date(e.data_evento)-new Date(t.data_evento));return`\n            <div class="clinical-events-section mt-3">\n                <h6 class="clinical-events-title">Eventi Clinici Recenti</h6>\n                <div class="clinical-events-timeline">\n                    ${t.slice(0,3).map(t=>{const e=new Date(t.data_evento).toLocaleDateString();return`\n                <div class="clinical-event-item d-flex align-items-center mb-2">\n                    <span class="material-icons ${"intervento"===t.tipo_evento?"text-primary":"text-warning"} me-2" style="font-size: 16px;">${"intervento"===t.tipo_evento?"medical_services":"warning"}</span>\n                    <div class="flex-grow-1">\n                        <div class="event-type small fw-bold">${"intervento"===t.tipo_evento?"Intervento":"Infezione"}</div>\n                        <div class="event-details small text-muted">\n                            ${e} - ${t.tipo_intervento||t.agente_patogeno||"N/A"}\n                        </div>\n                    </div>\n                </div>\n            `}).join("")}\n                </div>\n                ${t.length>3?`<a href="#eventi-clinici?paziente=${this.patient.id}" class="small text-primary">Vedi tutti (${t.length})</a>`:""}\n            </div>\n        `}renderQuickActions(){return`\n            <div class="quick-actions-section mt-3">\n                <div class="btn-group btn-group-sm" role="group">\n                    <button type="button" class="btn btn-outline-primary btn-add-intervention" \n                            data-patient-id="${this.patient.id}" \n                            title="Aggiungi Intervento">\n                        <span class="material-icons" style="font-size: 14px;">medical_services</span>\n                        Intervento\n                    </button>\n                    <button type="button" class="btn btn-outline-warning btn-add-infection" \n                            data-patient-id="${this.patient.id}" \n                            title="Aggiungi Infezione">\n                        <span class="material-icons" style="font-size: 14px;">warning</span>\n                        Infezione\n                    </button>\n                    <button type="button" class="btn btn-outline-info btn-view-events" \n                            data-patient-id="${this.patient.id}" \n                            title="Vedi tutti gli eventi">\n                        <span class="material-icons" style="font-size: 14px;">timeline</span>\n                        Timeline\n                    </button>\n                </div>\n            </div>\n        `}}const g={};function f(){const t={reparto:g.repartoFilter?.value||"",diagnosi:g.diagnosiFilter?.value||"",stato:g.statoFilter?.value||"",infetto:g.infettoFilter?.value||"",trasferimento:g.trasferimentoFilter?.value||"",search:g.searchInput?.value||"",page:n.getFilters().page||0,sortColumn:n.getFilters().sortColumn||"data_ricovero",sortDirection:n.getFilters().sortDirection||"desc"};n.updateFilters(t)}function h(){n.resetFilters(),g.repartoFilter&&(g.repartoFilter.value=""),g.diagnosiFilter&&(g.diagnosiFilter.value=""),g.statoFilter&&(g.statoFilter.value=""),g.infettoFilter&&(g.infettoFilter.value=""),g.trasferimentoFilter&&(g.trasferimentoFilter.value=""),g.searchInput&&(g.searchInput.value=""),[g.repartoFilter,g.diagnosiFilter,g.statoFilter,g.infettoFilter,g.trasferimentoFilter].forEach(t=>{t?.customSelectInstance&&t.customSelectInstance.setValue("")})}function y(t){!function(t,e){const i=n.getFilters();n.updateFilters({...i,[t]:e})}("page",t)}function w(t,e){n.updateFilters({...n.getFilters(),sortColumn:t,sortDirection:e})}function $(){const t=n.getFilters();return{column:t.sortColumn||"data_ricovero",direction:t.sortDirection||"desc"}}const z={get currentPage(){return n.getFilters().page||0},set currentPage(t){y(t)},get sortColumn(){return $().column},set sortColumn(t){w(t,$().direction)},get sortDirection(){return $().direction},set sortDirection(t){w($().column,t)}};async function _(){i.log("üìä Iniziando fetchPazienti..."),i.log("üìä Stato corrente:",{currentPage:z.currentPage,sortColumn:z.sortColumn,sortDirection:z.sortDirection});let t=function(){i.log("üîç Costruendo query base...");let t=a.from("pazienti").select("*",{count:"exact"}).not("user_id","is",null);if(i.log('üîç Query iniziale creata per tabella "pazienti" con filtro user_id not null'),g.searchInput){const e=g.searchInput.value.trim();e&&(i.log("üîç Applicando filtro ricerca:",e),t=t.or(`nome.ilike.%${e}%,cognome.ilike.%${e}%,diagnosi.ilike.%${e}%,codice_rad.ilike.%${e}%,reparto_destinazione.ilike.%${e}%,clinica_destinazione.ilike.%${e}%`))}if(g.repartoFilter&&g.repartoFilter.value&&(i.log("üîç Applicando filtro reparto:",g.repartoFilter.value),t=t.eq("reparto_appartenenza",g.repartoFilter.value)),g.diagnosiFilter&&g.diagnosiFilter.value&&(i.log("üîç Applicando filtro diagnosi:",g.diagnosiFilter.value),t=t.eq("diagnosi",g.diagnosiFilter.value)),g.statoFilter&&("attivo"===g.statoFilter.value?(i.log("üîç Applicando filtro stato: attivo"),t=t.is("data_dimissione",null)):"dimesso"===g.statoFilter.value&&(i.log("üîç Applicando filtro stato: dimesso"),t=t.not("data_dimissione","is",null))),g.infettoFilter&&""!==g.infettoFilter.value){const e="true"===g.infettoFilter.value;i.log("üîç Applicando filtro infetto:",e),t=t.eq("infetto",e)}return g.trasferimentoFilter&&g.trasferimentoFilter.value&&(i.log("üîç Applicando filtro trasferimento:",g.trasferimentoFilter.value),t=t.eq("tipo_dimissione",g.trasferimentoFilter.value)),i.log("‚úÖ Query base costruita con successo"),t}();i.log("üìä Query base costruita");const e=10*z.currentPage,n=e+10-1;i.log("üìä Range paginazione:",{startIndex:e,endIndex:n}),t=t.order(z.sortColumn,{ascending:"asc"===z.sortDirection}).range(e,n),i.log("üìä Query finale preparata, eseguendo...");const{data:s,error:o,count:r}=await t;if(i.log("üìä Risposta Supabase:",{dataLength:s?.length,count:r,hasError:!!o,sampleData:s?.slice(0,2)}),o)throw console.error("‚ùå Errore Supabase:",o),o;if(s&&s.length>0){i.log("üìä Caricamento eventi clinici per i pazienti...");try{const t=s.map(t=>t.id),{data:e,error:n}=await a.from("eventi_clinici").select("*").in("paziente_id",t).order("data_evento",{ascending:!1});if(n)i.warn("‚ö†Ô∏è Errore nel caricamento eventi clinici:",n);else{const t={};e&&e.forEach(e=>{t[e.paziente_id]||(t[e.paziente_id]=[]),t[e.paziente_id].push(e)}),s.forEach(e=>{e.eventi_clinici=t[e.id]||[]}),i.log("‚úÖ Eventi clinici caricati per",Object.keys(t).length,"pazienti")}}catch(l){i.warn("‚ö†Ô∏è Errore nel caricamento eventi clinici:",l),s.forEach(t=>{t.eventi_clinici=[]})}}return s&&s.length>0&&i.log("üîç Data verification - First record:",{hasUserId:!!s[0].user_id,hasCreatedAt:!!s[0].created_at,hasEventiClinici:!!s[0].eventi_clinici,eventiCount:s[0].eventi_clinici?.length||0,tableName:"pazienti",sample:s[0]}),i.log("‚úÖ fetchPazienti completato con successo"),{data:s,count:r}}async function F(){if(!g.exportButton)return;const t=g.exportButton.innerHTML;g.exportButton.disabled=!0,g.exportButton.innerHTML=s('<span class="spinner-border spinner-border-sm"></span> Esportazione...');try{const t=n.getFilters();await c.exportPatients(t)}catch(e){i.error("Errore catturato in list-api durante l'esportazione CSV:",e)}finally{g.exportButton.disabled=!1,g.exportButton.innerHTML=s(t)}}async function E(t,e){try{e?await c.dischargePatient(t):await c.reactivatePatient(t)}catch(n){throw i.error(`‚ùå Errore durante l'aggiornamento dello stato del paziente ${t}:`,n),n}}function x(){g.tableHeaders&&0!==g.tableHeaders.length&&g.tableHeaders.forEach(t=>{if(!t)return;const e=t.querySelector(".sort-indicator");e&&(e.textContent=t.dataset.sort===z.sortColumn?"asc"===z.sortDirection?" ‚ñ≤":" ‚ñº":"")})}function I(t,e){!function(t){const e=document.getElementById("pazienti-table-body");if(!e)return;if(e.innerHTML="",0===t.length){const t=e.insertRow(),n=document.createElement("td");return n.colSpan=10,n.className="text-center text-muted",n.textContent="Nessun paziente trovato.",t.appendChild(n),void 0}const n=t.map(t=>new b(t,{showActions:!0,showPostOperativeDays:!0}).renderTableRow()).join("");e.innerHTML=n}(t),function(t){const e=document.getElementById("pazienti-cards-container");if(!e)return;if(0===t.length){e.innerHTML="";const t=document.createElement("div");return t.className="text-center text-muted p-4",t.textContent="Nessun paziente trovato.",e.appendChild(t),void 0}const n=t.map(t=>{const e=window.innerWidth<=767;return new b(t,{showActions:!0,showPostOperativeDays:!0,showClinicalEvents:!0,isMobile:e}).render()}).join("");e.innerHTML=s(n)}(t),function(t){const e=Math.ceil(t/10);g.pageInfo&&(g.pageInfo.textContent=`Pagina ${z.currentPage+1} di ${e||1}`);g.prevButton&&(g.prevButton.disabled=0===z.currentPage);g.nextButton&&(g.nextButton.disabled=z.currentPage>=e-1)}(e),x(),B()}function C(t){console.error("Errore dettagliato durante il fetch dei pazienti:",t),g.tableBody&&(g.tableBody.innerHTML=s('<tr><td colspan="10" class="text-center text-danger"><strong>Errore nel caricamento dei dati.</strong><br>Controlla la console per i dettagli.</td></tr>'));const e=document.getElementById("pazienti-cards-container");e&&(e.innerHTML=s('<div class="text-center text-danger p-4"><strong>Errore nel caricamento dei dati.</strong></div>'))}function B(){const t=document.querySelector(".table-responsive"),e=document.getElementById("pazienti-cards-container");t&&e&&(window.innerWidth>=1200?(t.style.display="block",e.style.display="none"):(t.style.display="none",e.style.display="block"))}let D=[];async function M(){!function(){g.tableBody&&(g.tableBody.innerHTML=s('<tr><td colspan="10" class="text-center"><div class="spinner-border"></div></td></tr>'));const t=document.getElementById("pazienti-cards-container");t&&(t.innerHTML=s('<div class="text-center p-4"><div class="spinner-border"></div></div>'))}();try{const{data:t,count:e}=await _();D=t||[],I(D,e)}catch(t){console.error("‚ùå Errore in fetchAndRender:",t),C(t)}}function P(){const e=()=>{z.currentPage=0,f(),M()};g.filterContainer.addEventListener("input",t=>{t.target.matches("input, select")&&e()}),g.filterContainer.addEventListener("change",t=>{t.target.matches("input, select")&&e()}),g.resetButton.addEventListener("click",()=>{h(),M()}),g.exportButton.addEventListener("click",F),g.prevButton.addEventListener("click",()=>{z.currentPage>0&&(z.currentPage--,f(),M())}),g.nextButton.addEventListener("click",()=>{z.currentPage++,f(),M()}),g.tableHeaders.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.sort;z.sortColumn===e?z.sortDirection="asc"===z.sortDirection?"desc":"asc":(z.sortColumn=e,z.sortDirection="asc"),z.currentPage=0,f(),M()})});const n=e=>{const n=e.target.closest("button[data-action]");if(n){const{action:e,id:a}=n.dataset;return!async function(e,n){switch(e){case"edit":sessionStorage.setItem("editPazienteId",n),o("inserimento");break;case"delete":const{ConfirmModal:e}=await t(async()=>{const{ConfirmModal:t}=await import("./ConfirmModal-BGl6_Lcm.js");return{ConfirmModal:t}},__vite__mapDeps([0,1,2,3,4])),a=e.forDeletion("questo paziente");await a.show()&&(await async function(t){try{await c.deletePatient(t),i.log("‚úÖ Chiamata a patientService.deletePatient completata per ID:",t)}catch(e){throw console.error("‚ùå Errore eliminazione paziente:",e),i.error("Errore catturato in list-api durante la cancellazione del paziente:",e.message),e}}(n),M());break;case"dimetti":const{ConfirmModal:s}=await t(async()=>{const{ConfirmModal:t}=await import("./ConfirmModal-BGl6_Lcm.js");return{ConfirmModal:t}},__vite__mapDeps([0,1,2,3,4])),r=D.find(t=>t.id===n),l=s.forDismissal(r?`${r.nome} ${r.cognome}`:"il paziente");await l.show()&&(await E(n,!0),await M());break;case"riattiva":const{ConfirmModal:d}=await t(async()=>{const{ConfirmModal:t}=await import("./ConfirmModal-BGl6_Lcm.js");return{ConfirmModal:t}},__vite__mapDeps([0,1,2,3,4])),p=D.find(t=>t.id===n),u=d.forReactivation(p?`${p.nome} ${p.cognome}`:"il paziente");await u.show()&&(await E(n,!1),await M())}}(e,a),void 0}const a=e.target.closest('button[class*="btn-add-"], button[class*="btn-view-"]');if(a){const t=a.dataset.patientId;a.classList.contains("btn-add-intervention")?k("add-intervention",t):a.classList.contains("btn-add-infection")?k("add-infection",t):a.classList.contains("btn-view-events")&&k("view-events",t)}};document.getElementById("pazienti-table-body").addEventListener("click",n),document.getElementById("pazienti-cards-container").addEventListener("click",n),g.backButton.addEventListener("click",()=>{o("home")}),window.removeEventListener("resize",B),window.addEventListener("resize",B)}async function k(t,e){switch(t){case"add-intervention":o(`eventi-clinici?action=add&type=intervento&paziente=${e}`);break;case"add-infection":o(`eventi-clinici?action=add&type=infezione&paziente=${e}`);break;case"view-events":o(`eventi-clinici?paziente=${e}`)}}async function T(){i.log("üì° Inizio caricamento dati per la vista lista...");try{!function(){const t=n.getFilters();g.repartoFilter&&t.reparto&&(g.repartoFilter.value=t.reparto),g.diagnosiFilter&&t.diagnosi&&(g.diagnosiFilter.value=t.diagnosi),g.statoFilter&&t.stato&&(g.statoFilter.value=t.stato),g.infettoFilter&&t.infetto&&(g.infettoFilter.value=t.infetto),g.trasferimentoFilter&&t.trasferimento&&(g.trasferimentoFilter.value=t.trasferimento),g.searchInput&&t.search&&(g.searchInput.value=t.search)}();const[t,e,a]=await Promise.all([_(),r("reparto_appartenenza"),r("diagnosi")]);return i.log("‚úÖ Dati per la lista caricati con successo."),{pazienti:t.data,count:t.count,repartoOptions:e,diagnosiOptions:a}}catch(t){throw console.error("‚ùå Errore durante il caricamento dei dati per la lista:",t),t}}async function L(t){if(i.log("üèóÔ∏è Inizializzazione vista lista pazienti con dati pre-caricati..."),!e.session)return i.log("‚ùå Accesso a #list bloccato: utente non autenticato."),void 0;const a=document.querySelector("#view-container .view");if(!a)return console.error("‚ùå View container non trovato"),void 0;try{!function(t){i.log("üóÇÔ∏è Caching DOM elements...",{viewContainer:t}),g.repartoFilter=document.getElementById("list-filter-reparto"),g.diagnosiFilter=document.getElementById("list-filter-diagnosi"),g.statoFilter=document.getElementById("list-filter-stato"),g.infettoFilter=document.getElementById("list-filter-infetto"),g.trasferimentoFilter=document.getElementById("list-filter-trasferimento"),g.searchInput=document.getElementById("list-search"),g.resetButton=document.getElementById("reset-filters-btn"),g.filterContainer=t.querySelector(".filters-container"),g.tableBody=document.getElementById("pazienti-table-body"),g.cardsContainer=document.getElementById("pazienti-cards-container"),g.tableHeaders=t.querySelectorAll("th[data-sort]"),g.prevButton=document.getElementById("prev-page-btn"),g.nextButton=document.getElementById("next-page-btn"),g.pageInfo=document.getElementById("page-info"),g.backButton=t.querySelector('button[data-view="home"]'),g.exportButton=document.getElementById("export-csv-btn"),i.log("üóÇÔ∏è DOM elements cached:",{tableBody:!!g.tableBody,cardsContainer:!!g.cardsContainer,repartoFilter:!!g.repartoFilter,diagnosiFilter:!!g.diagnosiFilter,statoFilter:!!g.statoFilter,infettoFilter:!!g.infettoFilter,trasferimentoFilter:!!g.trasferimentoFilter,searchInput:!!g.searchInput,resetButton:!!g.resetButton,filterContainer:!!g.filterContainer,tableHeaders:g.tableHeaders?.length||0,prevButton:!!g.prevButton,nextButton:!!g.nextButton,pageInfo:!!g.pageInfo,backButton:!!g.backButton,exportButton:!!g.exportButton}),g.tableBody&&g.cardsContainer?i.log("‚úÖ Elementi DOM critici trovati"):console.error("‚ùå Elementi DOM critici mancanti:",{tableBody:!!g.tableBody,cardsContainer:!!g.cardsContainer}),["tableBody","cardsContainer","repartoFilter","diagnosiFilter","statoFilter","infettoFilter","trasferimentoFilter"].forEach(t=>{g[t]||console.error(`Elemento DOM critico non trovato: ${t}`)})}(a);const{pazienti:e,count:s,repartoOptions:o,diagnosiOptions:r}=t;D=e||[],l(g.repartoFilter,o),l(g.diagnosiFilter,r);const c=n.getFilters();g.repartoFilter&&(g.repartoFilter.value=c.reparto||""),g.diagnosiFilter&&(g.diagnosiFilter.value=c.diagnosi||""),g.statoFilter&&(g.statoFilter.value=c.stato||""),g.infettoFilter&&(g.infettoFilter.value=c.infetto||""),g.trasferimentoFilter&&(g.trasferimentoFilter.value=c.trasferimento||""),g.searchInput&&(g.searchInput.value=c.search||""),u("#list-filter-reparto, #list-filter-diagnosi, #list-filter-stato, #list-filter-infetto, #list-filter-trasferimento"),P(),I(D,s),x()}catch(s){console.error("Errore durante l'inizializzazione della vista lista:",s),C(s)}}window.resetFiltersAndRefresh=function(){h(),M()};export{T as fetchListData,L as initListView};
