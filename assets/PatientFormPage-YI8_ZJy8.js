import{j as e,M as a}from"./ui-vendor-S6RcKJ66.js";import{b as i,i as n,u as t,j as s}from"./react-vendor-Bp2pLdQf.js";import{B as r}from"./Button-DebNsbwT.js";import{C as o}from"./CustomSelect-Bzh-yVs0.js";import{D as l}from"./DateRangePicker-P-HlhFhm.js";import{c,l as d}from"./index-WsCs6LtV.js";import{I as m,a as u}from"./InterventionForm-Dk9lrfrl.js";import{g as p,a as h,b as g,p as v}from"./patientService-CweswzXd.js";import{u as x}from"./useNotification-DoHihZwM.js";import{l as f}from"./filterQueryService-DXHKU3wK.js";import{u as b,a as j,b as N,W as _}from"./WizardStepper-wmT1Y9zi.js";import{u as w}from"./useResponsive-DNmHy4-N.js";import"./dropdownPositioner-CpLmXRgY.js";import"./CentralizedStatisticsService-CiR3fZSG.js";import"./supabase-Zkii_ZbW.js";const z=[{value:"dimissione",label:"Dimissione"},{value:"trasferimento_interno",label:"Trasferimento interno"},{value:"trasferimento_esterno",label:"Trasferimento esterno"},{value:"decesso",label:"Decesso"}],y=[{value:"0",label:"0 - Ordinaria"},{value:"6",label:"6 - Protetta"}],C=[{value:"",label:"Seleziona..."},{value:"56",label:"56 - Riabilitazione Motoria"},{value:"60",label:"60 - Lunga Degenza"}],S=[{value:"",label:"Seleziona..."},{value:"Cardiologia",label:"Cardiologia"},{value:"CR1",label:"CR1"},{value:"CR3",label:"CR3"},{value:"Gastroenterologia",label:"Gastroenterologia"},{value:"Ginecologia",label:"Ginecologia"},{value:"Medicina Interna",label:"Medicina Interna"},{value:"Neurologia",label:"Neurologia"},{value:"Pediatria",label:"Pediatria"},{value:"Pneumologia",label:"Pneumologia"},{value:"UGI",label:"UGI"},{value:"Urologia",label:"Urologia"}],D={data_dimissione:"",tipo_dimissione:"dimissione",codice_dimissione:"0"},I=({patientName:a,onDischargeSubmit:n})=>{const[t,s]=i.useState(!1),[c,d]=i.useState(D),[m,u]=i.useState(!1),p=e=>a=>{d("tipo_dimissione"===e?i=>{const n={...i,[e]:a};return"dimissione"===a?n.codice_dimissione="0":"trasferimento_esterno"===a?n.codice_dimissione="3":"trasferimento_interno"!==a&&"decesso"!==a||(n.codice_dimissione=null),n}:i=>({...i,[e]:a}))};return e.jsxs("div",{className:"discharge-section card mt-4",children:[e.jsx("div",{className:"card-header bg-light",children:e.jsxs("button",{type:"button",onClick:()=>s(!t),className:"btn btn-link w-100 text-start p-0 d-flex justify-content-between align-items-center",style:{textDecoration:"none",color:"inherit"},children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1.5rem"},children:t?"expand_less":"expand_more"}),e.jsx("strong",{children:"Dimissione / Trasferimento"}),e.jsx("span",{className:"badge bg-info",style:{fontSize:"0.75rem"},children:"Opzionale"})]}),t&&e.jsxs("span",{style:{fontSize:"0.875rem",color:"#6c757d"},children:["Paziente: ",a]})]})}),t&&e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"alert alert-info mb-3",children:[e.jsx("strong",{children:"Nota:"})," Registra i dati di dimissione o trasferimento del paziente. Questa sezione è facoltativa e può essere completata anche in un secondo momento."]}),e.jsxs("form",{id:"discharge-section",onSubmit:async e=>{if(e.preventDefault(),!m&&n){u(!0);try{await n(c),d(D),s(!1)}finally{u(!1)}}},className:"d-flex flex-column gap-3",children:[e.jsx(l,{label:"Data dimissione",value:c.data_dimissione,onChange:e=>{d(a=>({...a,data_dimissione:e||""}))},isRequired:t,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-type",children:["Tipo dimissione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(o,{id:"discharge-dismissal-type",value:c.tipo_dimissione,options:z.map(e=>({value:e.value,label:e.label})),onChange:p("tipo_dimissione"),placeholder:"Seleziona..."})]}),"dimissione"===c.tipo_dimissione&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"discharge-dismissal-code",children:"Codice dimissione"}),e.jsx(o,{id:"discharge-dismissal-code",value:c.codice_dimissione??"",options:y.map(e=>({value:e.value,label:e.label})),onChange:p("codice_dimissione"),placeholder:"Seleziona..."})]}),"trasferimento_interno"===c.tipo_dimissione&&e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-dept",children:["Reparto destinazione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(o,{id:"discharge-dismissal-dept",value:c.reparto_destinazione??"",options:S.map(e=>({value:e.value,label:e.label})),onChange:p("reparto_destinazione"),placeholder:"Seleziona..."})]}),"trasferimento_esterno"===c.tipo_dimissione&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-clinic",children:["Clinica destinazione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{id:"discharge-dismissal-clinic",name:"clinica_destinazione",className:"form-control",value:c.clinica_destinazione??"",onChange:e=>{const{name:a,value:i}=e.target;d(e=>({...e,[a]:i}))},required:t&&"trasferimento_esterno"===c.tipo_dimissione})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-clinic-code",children:["Codice clinica ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(o,{id:"discharge-dismissal-clinic-code",value:c.codice_clinica??"",options:C.map(e=>({value:e.value,label:e.label})),onChange:p("codice_clinica"),placeholder:"Seleziona..."})]})]}),e.jsxs("div",{className:"d-flex gap-2 pt-2",children:[e.jsx(r,{type:"submit",disabled:m,children:m?"Registrazione in corso...":"Registra dimissione"}),e.jsx(r,{type:"button",variant:"secondary",onClick:()=>{d(D),s(!1)},children:"Annulla"})]})]})]})]})},k=["AR","PO","CO","CR","PS"],E=["Bassa","Media","Alta"],P=({values:a,onChange:i})=>e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-name",children:"Nome"}),e.jsx("input",{id:"patient-name",name:"nome",className:"form-control",value:a.nome,onChange:i,required:!0})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-surname",children:"Cognome"}),e.jsx("input",{id:"patient-surname",name:"cognome",className:"form-control",value:a.cognome,onChange:i,required:!0})]})]}),R=({values:a,onChange:i})=>{const n=e=>a=>{i({target:{name:e,value:a||""}})};return e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6",children:e.jsx(l,{id:"patient-birth-date",value:a.data_nascita,onChange:n("data_nascita"),label:"Data nascita",placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})}),e.jsx("div",{className:"col-md-6",children:e.jsx(l,{id:"patient-admission-date",value:a.data_ricovero,onChange:n("data_ricovero"),label:"Data ricovero",placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})})]})},F=({values:a,onChange:n,diagnosiOptions:t,repartoOptions:s,loadingDiagnosi:r,loadingReparti:l})=>{const c=e=>a=>{n({target:{name:e,value:a}})},d=i.useMemo(()=>[{value:"",label:"Seleziona diagnosi..."},...t.map(e=>({value:e.nome,label:e.nome}))],[t]),m=i.useMemo(()=>0===t.length?"empty":t.map(e=>e.id).sort().join("-"),[t]),u=i.useMemo(()=>[{value:"",label:"Seleziona..."},...s.map(e=>({value:e,label:e}))],[s]);return e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-diagnosis",children:"Diagnosi"}),e.jsx(o,{id:"patient-diagnosis",value:a.diagnosi,options:d,onChange:c("diagnosi"),disabled:r,placeholder:"Seleziona diagnosi..."},`diagnosis-${m}`),r&&e.jsx("small",{className:"form-text text-muted",children:"Caricamento diagnosi in corso..."})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-ward",children:"Reparto Appartenenza"}),e.jsx(o,{id:"patient-ward",value:a.reparto_appartenenza,options:u,onChange:c("reparto_appartenenza"),disabled:l,placeholder:"Seleziona..."},`ward-${s.length}`),l&&e.jsx("small",{className:"form-text text-muted",children:"Caricamento reparti in corso..."})]})]})},B=({values:a,onChange:n})=>{const t=e=>a=>{n({target:{name:e,value:a}})},s=i.useMemo(()=>[{value:"",label:"Seleziona..."},...k.map(e=>({value:e,label:e}))],[]),r=i.useMemo(()=>[{value:"",label:"Seleziona..."},...E.map(e=>({value:e,label:e}))],[]);return e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-codice-rad",children:"Codice RAD"}),e.jsx("input",{id:"patient-codice-rad",name:"codice_rad",className:"form-control",value:a.codice_rad,onChange:n})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-reparto-provenienza",children:"Reparto Provenienza"}),e.jsx(o,{id:"patient-reparto-provenienza",value:a.reparto_provenienza,options:s,onChange:t("reparto_provenienza"),placeholder:"Seleziona..."},"reparto-provenienza")]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-livello-assistenza",children:"Livello Assistenza"}),e.jsx(o,{id:"patient-livello-assistenza",value:a.livello_assistenza,options:r,onChange:t("livello_assistenza"),placeholder:"Seleziona..."},"livello-assistenza")]})]})},M=({values:a,onCheckboxChange:i,onEditInfection:n,onEditSurgery:t,infectionBadge:s,surgeryBadge:r,renderBadge:o})=>e.jsxs("div",{className:"row mt-3",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"patient-infetto",name:"infetto",checked:a.infetto,onChange:i}),e.jsxs("label",{className:"form-check-label",htmlFor:"patient-infetto",children:["Paziente Infetto",o(s)]})]}),e.jsxs("button",{type:"button",className:"btn btn-link px-0",onClick:()=>{void n()},children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"edit"}),"Modifica dati infezione"]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"patient-ha-intervento",name:"ha_intervento",checked:a.ha_intervento,onChange:i}),e.jsxs("label",{className:"form-check-label",htmlFor:"patient-ha-intervento",children:["Intervento Chirurgico",o(r)]})]}),e.jsxs("button",{type:"button",className:"btn btn-link px-0",onClick:()=>{void t()},children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"edit"}),"Modifica dati intervento"]})]})]}),V=({values:a,onChange:i})=>e.jsxs("div",{children:[e.jsx("label",{className:"form-label",htmlFor:"patient-notes",children:"Note"}),e.jsx("textarea",{id:"patient-notes",name:"note",className:"form-control",value:a.note,onChange:i,rows:3})]}),A=({submitting:a,submitLabel:i,onCancel:n})=>e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(r,{type:"submit",disabled:a,children:i}),e.jsx(r,{type:"button",variant:"secondary",onClick:n,children:"Annulla"})]}),O=({patientId:n,patientName:t="Paziente",event:s,onSubmit:r,onClose:o})=>{const[l,c]=i.useState(!1),d=i.useRef(`infection-event-modal-${Date.now()}`).current,u=i.useRef(null),p=i.useRef(null),h=i.useRef(null),g=i.useRef(null);i.useEffect(()=>{const e=u.current;if(!e)return;g.current=document.activeElement;let i=requestAnimationFrame(()=>{if(u.current)try{const i=new a(e);p.current=i;const n=()=>{h.current=null;const e=g.current;g.current=null,e&&document.contains(e)&&queueMicrotask(()=>e.focus()),o()};h.current=n,e.addEventListener("hidden.bs.modal",n),i.show()}catch(i){console.error("Error initializing modal:",i)}});return()=>{null!==i&&(cancelAnimationFrame(i),i=null);const a=p.current;if(p.current=null,e&&h.current&&(e.removeEventListener("hidden.bs.modal",h.current),h.current=null),a)try{a.dispose()}catch(n){console.error("Error disposing modal:",n)}}},[o]);const v=i.useCallback(()=>{const e=p.current;if(e){const a=u.current,i=document.activeElement;i&&a?.contains(i)&&i.blur(),e.hide()}else o()},[o]);return e.jsx("div",{className:"modal fade",id:d,ref:u,tabIndex:-1,"aria-labelledby":`${d}-label`,"aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"modal-title mb-1",id:`${d}-label`,children:s?"Modifica Evento":"Registra Infezione"}),e.jsxs("p",{className:"text-muted mb-0 small",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"person"}),t]})]}),e.jsx("button",{type:"button",className:"btn-close","aria-label":"Chiudi","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body",children:e.jsx(m,{event:s,patientId:n,onSubmit:async e=>{c(!0);try{await r(e),v()}finally{c(!1)}},onCancel:v,isSubmitting:l})})]})})})},$={hasData:!1,isValid:!1,tooltip:""};const L=({patientId:n,patientName:t="Paziente",event:s,onSubmit:r,onClose:o})=>{const[l,c]=i.useState(!1),d=i.useRef(`intervention-event-modal-${Date.now()}`).current,m=i.useRef(null),p=i.useRef(null),h=i.useRef(null);i.useEffect(()=>{const e=m.current;if(!e)return;let i=requestAnimationFrame(()=>{if(m.current)try{const i=new a(e);p.current=i;const n=()=>{h.current=null,o()};h.current=n,e.addEventListener("hidden.bs.modal",n),i.show()}catch(i){console.error("Error initializing modal:",i)}});return()=>{null!==i&&(cancelAnimationFrame(i),i=null);const a=p.current;if(p.current=null,e&&h.current&&(e.removeEventListener("hidden.bs.modal",h.current),h.current=null),a)try{a.dispose()}catch(n){console.error("Error disposing modal:",n)}}},[o]);const g=i.useCallback(()=>{const e=p.current;e?e.hide():o()},[o]);return e.jsx("div",{className:"modal fade",id:d,ref:m,tabIndex:-1,"aria-labelledby":`${d}-label`,"aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"modal-title mb-1",id:`${d}-label`,children:s?"Modifica Evento":"Registra Intervento"}),e.jsxs("p",{className:"text-muted mb-0 small",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"person"}),t]})]}),e.jsx("button",{type:"button",className:"btn-close","aria-label":"Chiudi","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body",children:e.jsx(u,{event:s,patientId:n,onSubmit:async e=>{c(!0);try{await r(e),g()}finally{c(!1)}},onCancel:g,isSubmitting:l})})]})})})},T={hasData:!1,isValid:!1,tooltip:""};function G({values:a,setValues:t,patientDisplayName:s,patientId:r=""}){const o=function({setValues:a,patientDisplayName:t,patientId:s=""}){const[r,o]=i.useState($),[l,c]=i.useState(!1),d=i.useCallback(async()=>{const e=await p();if(!e.hasInfectionData())return $;const a=e.getInfectionData(),i=[];return a?.data_evento&&i.push(`Data: ${a.data_evento}`),a?.agente_patogeno&&i.push(`Agente: ${a.agente_patogeno}`),a?.descrizione&&i.push(`Note: ${a.descrizione}`),{hasData:!0,isValid:0===(e.getValidationErrors?.()?.length??0),tooltip:i.join("\n")}},[]),m=i.useCallback(async()=>{const e=await d();o(e)},[d]),u=i.useCallback(async e=>{const i=await p();i.setInfectionData({data_evento:e.data_evento,agente_patogeno_id:e.agente_patogeno_id,tipo_patogeno:e.tipo_patogeno,data_fine_evento:e.data_fine_evento,note:e.note}),c(!1);const n=i.hasInfectionData();a(e=>({...e,infetto:n})),await m()},[a,m]),h=i.useCallback(async e=>{e?c(!0):((await p()).clearInfectionData(),a(e=>({...e,infetto:!1})),await m())},[a,m]),g=i.useCallback(async e=>{const{name:a,checked:i}=e.target;"infetto"===a&&await h(i)},[h]),v=i.useCallback(()=>{c(!0)},[]);return{badge:r,renderBadge:i.useCallback(a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),handleCheckboxChange:g,handleEditInfection:v,modalsPortal:n.createPortal(e.jsx(e.Fragment,{children:l&&e.jsx(O,{patientId:s,patientName:t||"Nuovo Paziente",onSubmit:u,onClose:()=>c(!1)})}),document.body),refreshSummary:m}}({values:a,setValues:t,patientDisplayName:s,patientId:r}),l=function({setValues:a,patientDisplayName:t,patientId:s=""}){const[r,o]=i.useState(T),[l,c]=i.useState(!1),d=i.useCallback(async()=>{const e=await h();if(!e.hasSurgeryData())return T;const a=e.getValidationErrors?.()?.length??0,i=e.getDataSummary?.(),n=[];return i?.dataIntervento&&n.push(`Intervento: ${i.dataIntervento}`),i?.tipoIntervento&&n.push(`Tipo: ${i.tipoIntervento}`),i?.hasInfection&&n.push("Infezione associata"),{hasData:!0,isValid:0===a,tooltip:n.join("\n")}},[]),m=i.useCallback(async()=>{const e=await d();o(e)},[d]),u=i.useCallback(async e=>{const i=await h();i.setSurgeryData({data_evento:e.data_evento,tipo_intervento_id:e.tipo_intervento_id,descrizione:e.descrizione_intervento}),c(!1);const n=i.hasSurgeryData();a(e=>({...e,ha_intervento:n})),await m()},[a,m]),p=i.useCallback(async e=>{e?c(!0):((await h()).clearSurgeryData(),a(e=>({...e,ha_intervento:!1})),await m())},[a,m]),g=i.useCallback(async e=>{const{name:a,checked:i}=e.target;"ha_intervento"===a&&await p(i)},[p]),v=i.useCallback(()=>{c(!0)},[]);return{badge:r,renderBadge:i.useCallback(a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),handleCheckboxChange:g,handleEditSurgery:v,modalsPortal:n.createPortal(e.jsx(e.Fragment,{children:l&&e.jsx(L,{patientId:s,patientName:t||"Nuovo Paziente",onSubmit:u,onClose:()=>c(!1)})}),document.body),refreshSummary:m}}({values:a,setValues:t,patientDisplayName:s,patientId:r});i.useEffect(()=>{(async()=>{await o.refreshSummary(),await l.refreshSummary()})()},[]),i.useEffect(()=>()=>{g().then(({infection:e,surgery:a})=>{e.clearInfectionData(),a.clearSurgeryData()})},[]);const c=i.useCallback(async e=>{const{name:a}=e.target;return"infetto"===a?(await o.handleCheckboxChange(e),void 0):"ha_intervento"===a?(await l.handleCheckboxChange(e),void 0):(t(i=>({...i,[a]:e.target.checked})),void 0)},[o,l,t]),d=i.useMemo(()=>a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),m=i.useMemo(()=>e.jsxs(e.Fragment,{children:[o.modalsPortal,l.modalsPortal]}),[o.modalsPortal,l.modalsPortal]);return{infectionBadge:o.badge,surgeryBadge:l.badge,renderBadge:d,handleCheckboxChange:c,handleEditInfection:o.handleEditInfection,handleEditSurgery:l.handleEditSurgery,modalsPortal:m}}const q=e=>{if(null==e||""===e)return"";if(e instanceof Date)return e.toISOString().split("T")[0];const a=String(e);if(a.match(/^\d{4}-\d{2}-\d{2}$/))return a;try{const e=function(e){if(!e)return null;if(e.match(/^\d{4}-\d{2}-\d{2}$/))return e;if(!e.includes("/"))throw new Error("Formato data non valido. Utilizzare il formato gg/mm/aaaa");const a=e.split("/");if(3!==a.length)throw new Error("Formato data non valido. Utilizzare il formato gg/mm/aaaa");const[i,n,t]=a,s=parseInt(i,10),r=parseInt(n,10),o=parseInt(t,10);if(isNaN(s)||isNaN(r)||isNaN(o))throw new Error("Formato data non valido. Utilizzare numeri validi");if(s<1||s>31)throw new Error("Giorno non valido (1-31)");if(r<1||r>12)throw new Error("Mese non valido (1-12)");if(o<1900||o>2100)throw new Error("Anno non valido");const l=new Date(o,r-1,s);if(l.getDate()!==s||l.getMonth()!==r-1||l.getFullYear()!==o)throw new Error("Data non valida (es. 31/02/2025)");return`${t}-${n.padStart(2,"0")}-${i.padStart(2,"0")}`}(a);if(e)return e}catch(i){const e=new Date(a);if(!Number.isNaN(e.getTime()))return e.toISOString().split("T")[0]}return a},U=["data_nascita","data_ricovero","data_dimissione"];function W({initialPatient:e}){const[a,n]=i.useState(()=>({nome:"",cognome:"",data_nascita:"",data_ricovero:"",data_dimissione:"",diagnosi:"",reparto_appartenenza:"",reparto_provenienza:"",livello_assistenza:"",codice_rad:"",note:"",tipo_dimissione:"",codice_dimissione:"",reparto_destinazione:"",clinica_destinazione:"",codice_clinica:"",infetto:!1,ha_intervento:!1}));i.useEffect(()=>{if(!e)return n({nome:"",cognome:"",data_nascita:"",data_ricovero:"",data_dimissione:"",diagnosi:"",reparto_appartenenza:"",reparto_provenienza:"",livello_assistenza:"",codice_rad:"",note:"",tipo_dimissione:"",codice_dimissione:"",reparto_destinazione:"",clinica_destinazione:"",codice_clinica:"",infetto:!1,ha_intervento:!1}),void 0;const a={id:e.id??null,nome:e.nome??"",cognome:e.cognome??"",data_nascita:q(e.data_nascita??""),data_ricovero:q(e.data_ricovero??""),data_dimissione:q(e.data_dimissione??""),diagnosi:e.diagnosi??"",reparto_appartenenza:e.reparto_appartenenza??"",reparto_provenienza:e.reparto_provenienza??"",livello_assistenza:e.livello_assistenza??"",codice_rad:e.codice_rad??"",note:e.note??"",tipo_dimissione:e.tipo_dimissione??"",codice_dimissione:e.codice_dimissione??"",reparto_destinazione:e.reparto_destinazione??"",clinica_destinazione:e.clinica_destinazione??"",codice_clinica:e.codice_clinica??"",infetto:e.infetto??!1,ha_intervento:!1};n(a)},[e]);const t=i.useCallback(e=>{const{name:a,value:i,type:t}=e.target,s="checkbox"===t?e.target.checked:i;n(e=>{if("string"==typeof s&&U.includes(a)){const i=q(s);return{...e,[a]:i}}return{...e,[a]:s}})},[]);return{values:a,setValues:n,handleChange:t}}function Q(){const{notify:e}=x(),[a,n]=i.useState([]),[t,s]=i.useState([]),[r,o]=i.useState(!1),[l,m]=i.useState(!1);return i.useEffect(()=>{void(async()=>{o(!0);try{const{data:a,error:i}=await c.from("diagnosi").select("id, nome").order("nome",{ascending:!0});if(i)d.error("Errore nel caricamento delle diagnosi",{error:i}),e.error("Impossibile caricare le diagnosi disponibili").withDuration(5e3).show();else{const e=(a||[]).map(e=>({id:String(e.id),nome:e.nome}));n(e)}}catch(a){d.error("Errore imprevisto nel caricamento delle diagnosi",{error:a}),e.error("Errore nel caricamento delle diagnosi").withDuration(5e3).show()}finally{o(!1)}})()},[]),i.useEffect(()=>{void(async()=>{m(!0);try{const e=await f();s(e)}catch(a){d.error("Errore nel caricamento dei reparti",{error:a}),e.error("Impossibile caricare i reparti disponibili").withDuration(5e3).show()}finally{m(!1)}})()},[]),{diagnosiOptions:a,repartoOptions:t,loadingDiagnosi:r,loadingReparti:l}}function Y({values:e,surgeryDataManager:a,infectionDataManager:i,isPatientCurrentlyInfected:n}){const t={nome:e.nome?.trim()||"",cognome:e.cognome?.trim()||"",data_nascita:e.data_nascita||"",data_ricovero:e.data_ricovero||"",data_dimissione:e.data_dimissione||null,diagnosi:e.diagnosi?.trim()||"",reparto_appartenenza:e.reparto_appartenenza?.trim()||"",reparto_provenienza:e.reparto_provenienza?.trim()||null,livello_assistenza:e.livello_assistenza?.trim()||null,codice_rad:e.codice_rad?.trim()||null,tipo_dimissione:e.tipo_dimissione||null,codice_dimissione:e.codice_dimissione?.trim()||null,reparto_destinazione:e.reparto_destinazione?.trim()||null,clinica_destinazione:e.clinica_destinazione?.trim()||null,codice_clinica:e.codice_clinica?.trim()||null,note:e.note?.trim()||null,infetto:e.infetto||!1,_hasInfectionData:!1,_hasSurgeryData:!1};if(i.hasInfectionData()){const e=i.getInfectionData();e&&(t._hasInfectionData=!0,t._infectionData=e)}if(a.hasSurgeryData()){const e=a.getSurgeryData();e&&(t._hasSurgeryData=!0,t._surgeryData=e)}return n&&n()&&(t.infetto=!0),t}const H=({patient:a,mode:n,onSubmit:t,onCancel:s,onValidate:r})=>{const{values:o,setValues:l,handleChange:c}=W({initialPatient:a}),[d,m]=i.useState(!1),u=i.useRef(null),p=i.useMemo(()=>[o.nome?.trim(),o.cognome?.trim()].filter(Boolean).join(" ").trim(),[o.nome,o.cognome]),{diagnosiOptions:h,repartoOptions:v,loadingDiagnosi:x,loadingReparti:f}=Q(),{infectionBadge:b,surgeryBadge:j,renderBadge:N,handleCheckboxChange:_,handleEditInfection:w,handleEditSurgery:z,modalsPortal:y}=G({values:o,setValues:l,patientDisplayName:p,patientId:a?.id??""}),C=i.useCallback(async e=>{if(e.preventDefault(),!d){m(!0);try{const{infection:e,surgery:a}=await g(),i=Y({values:o,infectionDataManager:e,surgeryDataManager:a});if(r){if(!r(i).valid)return m(!1),void 0}await t(i)}finally{m(!1)}}},[t,r,d,o]),S="create"===n?"Salva paziente":"Aggiorna paziente";return e.jsxs(e.Fragment,{children:[e.jsxs("form",{id:"patient-form",ref:u,onSubmit:C,className:"d-flex flex-column gap-3",noValidate:!0,children:[e.jsx(P,{values:o,onChange:c}),e.jsx(R,{values:o,onChange:c}),e.jsx(F,{values:o,onChange:c,diagnosiOptions:h,repartoOptions:v,loadingDiagnosi:x,loadingReparti:f}),e.jsx(B,{values:o,onChange:c}),e.jsx(M,{values:o,onCheckboxChange:_,onEditInfection:w,onEditSurgery:z,infectionBadge:b,surgeryBadge:j,renderBadge:N}),e.jsx(V,{values:o,onChange:c}),e.jsx(A,{submitting:d,submitLabel:S,onCancel:s})]}),y]})},J=["personal-info","admission-dates","diagnosis","provenance","clinical-flags","notes","review"],K={"personal-info":"Dati Personali","admission-dates":"Date Ricovero",diagnosis:"Diagnosi",provenance:"Provenienza","clinical-flags":"Dati Clinici",notes:"Note",review:"Riepilogo"},X=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Dati Personali"}),e.jsx("p",{className:"wizard-step-description",children:"Inserisci i dati anagrafici del paziente"}),e.jsx(P,{values:a,onChange:i})]})}),Z=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Date Importanti"}),e.jsx("p",{className:"wizard-step-description",children:"Inserisci la data di nascita e ricovero"}),e.jsx(R,{values:a,onChange:i})]})}),ee=({values:a,onChange:i,diagnosiOptions:n,repartoOptions:t,loadingDiagnosi:s,loadingReparti:r})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Diagnosi"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona la diagnosi e il reparto"}),e.jsx(F,{values:a,onChange:i,diagnosiOptions:n||[],repartoOptions:t||[],loadingDiagnosi:s??!1,loadingReparti:r??!1})]})}),ae=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Provenienza e Assistenza"}),e.jsx("p",{className:"wizard-step-description",children:"Informazioni sulla provenienza del paziente (opzionale)"}),e.jsx(B,{values:a,onChange:i})]})}),ie=({values:a,onCheckboxChange:i,onEditInfection:n,onEditSurgery:t,infectionBadge:s,surgeryBadge:r,renderBadge:o})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Dati Clinici"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona i flag clinici del paziente"}),e.jsx(M,{values:a,onCheckboxChange:i??(async()=>{}),onEditInfection:n??(async()=>{}),onEditSurgery:t??(async()=>{}),infectionBadge:s,surgeryBadge:r,renderBadge:o})]})}),ne=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Note Aggiuntive"}),e.jsx("p",{className:"wizard-step-description",children:"Aggiungi eventuali note (opzionale)"}),e.jsx(V,{values:a,onChange:i})]})}),te=({values:a})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Riepilogo"}),e.jsx("p",{className:"wizard-step-description",children:"Verifica i dati inseriti prima di confermare"}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Dati Personali"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Nome:"}),e.jsx("span",{className:"review-value",children:a.nome})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Cognome:"}),e.jsx("span",{className:"review-value",children:a.cognome})]})]})]}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Date"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Data Nascita:"}),e.jsx("span",{className:"review-value",children:a.data_nascita})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Data Ricovero:"}),e.jsx("span",{className:"review-value",children:a.data_ricovero})]})]})]}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Clinico"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Diagnosi:"}),e.jsx("span",{className:"review-value",children:a.diagnosi||"Non specificato"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Reparto:"}),e.jsx("span",{className:"review-value",children:a.reparto_appartenenza||"Non specificato"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Paziente Infetto:"}),e.jsx("span",{className:"review-value",children:a.infetto?"Sì":"No"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Intervento Chirurgico:"}),e.jsx("span",{className:"review-value",children:a.ha_intervento?"Sì":"No"})]})]})]}),a.note&&e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Note"}),e.jsx("p",{className:"review-notes",children:a.note})]})]})}),se=({patient:a,mode:n,onSubmit:t,onCancel:s,onValidate:r})=>{const{values:o,setValues:l,handleChange:c}=W({initialPatient:a}),[d,m]=i.useState(!1),u=i.useRef(null),p=((e="personal-info")=>b({steps:J,labels:K,initialStep:e}))("personal-info"),h=j({currentStep:p.currentStep,getStepLabel:p.getStepLabel,totalSteps:p.totalSteps,currentStepNumber:p.getStepNumber(p.currentStep)});N();const v=i.useMemo(()=>[o.nome?.trim(),o.cognome?.trim()].filter(Boolean).join(" ").trim(),[o.nome,o.cognome]),{diagnosiOptions:x,repartoOptions:f,loadingDiagnosi:w,loadingReparti:z}=Q(),{infectionBadge:y,surgeryBadge:C,renderBadge:S,handleCheckboxChange:D,handleEditInfection:I,handleEditSurgery:k,modalsPortal:E}=G({values:o,setValues:l,patientDisplayName:v,patientId:a?.id??""}),P=i.useCallback(async e=>{if(e.preventDefault(),!d){m(!0);try{const{infection:e,surgery:a}=await g(),i=Y({values:o,infectionDataManager:e,surgeryDataManager:a});if(r){if(!r(i).valid)return m(!1),void 0}await t(i)}finally{m(!1)}}},[t,r,d,o]),R="create"===n?"Salva paziente":"Aggiorna paziente",F=i.useCallback(()=>{switch(p.currentStep){case"personal-info":return!!o.nome?.trim()&&!!o.cognome?.trim();case"admission-dates":return!!o.data_nascita&&!!o.data_ricovero;case"diagnosis":return!!o.diagnosi&&!!o.reparto_appartenenza;case"provenance":case"clinical-flags":case"notes":case"review":return!0;default:return!1}},[p.currentStep,o.nome,o.cognome,o.data_nascita,o.data_ricovero,o.diagnosi,o.reparto_appartenenza]);return e.jsxs(e.Fragment,{children:[e.jsxs("form",{id:"patient-form-wizard",ref:u,onSubmit:P,className:"wizard-form",noValidate:!0,children:[e.jsxs("div",{className:"wizard-form-header",children:[e.jsx("button",{type:"button",className:"wizard-back-button",onClick:s,"aria-label":"Torna alla lista pazienti",children:e.jsx("i",{className:"bi bi-arrow-left"})}),e.jsx("h1",{className:"wizard-form-title",children:"Inserimento Nuovo Paziente"})]}),e.jsx(_,{currentStep:p.currentStep,totalSteps:p.totalSteps,getStepLabel:p.getStepLabel,getStepNumber:p.getStepNumber,stepOrder:J,themeColor:"patients"}),e.jsx("div",{ref:h,className:"wizard-form-content",children:(()=>{const a={values:o,onChange:c,diagnosiOptions:x,repartoOptions:f,loadingDiagnosi:w,loadingReparti:z,onCheckboxChange:D,onEditInfection:I,onEditSurgery:k,infectionBadge:y,surgeryBadge:C,renderBadge:S};switch(p.currentStep){case"personal-info":return e.jsx(X,{...a});case"admission-dates":return e.jsx(Z,{...a});case"diagnosis":return e.jsx(ee,{...a});case"provenance":return e.jsx(ae,{...a});case"clinical-flags":return e.jsx(ie,{...a});case"notes":return e.jsx(ne,{...a});case"review":return e.jsx(te,{values:o});default:return null}})()}),e.jsxs("div",{className:"wizard-form-actions",children:[e.jsxs("button",{type:"button",className:"btn btn-secondary btn-block",onClick:p.prevStep,disabled:!p.canGoPrev,children:[e.jsx("i",{className:"bi bi-chevron-left"}),"Indietro"]}),"review"!==p.currentStep?e.jsxs("button",{type:"button",className:"btn btn-primary btn-block",onClick:p.nextStep,disabled:!p.canGoNext||!F(),title:F()?void 0:"Completa i campi obbligatori per continuare",children:["Avanti",e.jsx("i",{className:"bi bi-chevron-right"})]}):e.jsx(e.Fragment,{children:e.jsx("button",{type:"submit",className:"btn btn-success btn-block",disabled:d,children:e.jsxs(e.Fragment,d?{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio in corso..."]}:{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),R]})})})]})]}),E]})},re=()=>{const a=t(),{notify:n}=x(),[r]=s(),o=r.get("id"),[l,c]=i.useState("create"),[m,u]=i.useState(void 0),[p,h]=i.useState(!1);i.useEffect(()=>{void(async()=>{const e=sessionStorage.getItem("editPazienteId"),a=o??e;if(!a)return sessionStorage.removeItem("editPazienteId"),c("create"),u(void 0),void 0;h(!0);try{const e=await v.getPatientById(a);e?(u(e),c("edit")):(d.warn("Patient not found",{id:a}),n.warning("Paziente non trovato").show())}catch(i){d.error("Error loading patient for edit",i),n.error("Errore nel caricamento del paziente").show()}finally{h(!1),!o&&e&&sessionStorage.removeItem("editPazienteId")}})()},[o]),i.useEffect(()=>()=>{sessionStorage.removeItem("editPazienteId")},[]);const g=i.useCallback(async e=>{try{if("edit"===l&&m?.id)d.info("Updating existing patient",{id:m.id,data:e}),await v.updatePatient(m.id,e);else{d.info("Creating new patient",{data:e});const a=e._hasInfectionData&&e._infectionData,i=e._hasSurgeryData&&e._surgeryData;a&&i?await v.createPatientWithSurgeryAndInfection(e,e._surgeryData,e._infectionData):a?await v.createPatientWithInfection(e,e._infectionData):i?await v.createPatientWithSurgery(e,e._surgeryData):await v.createPatient(e)}a("/list")}catch(i){throw d.error("Error submitting patient form",i),i}},[a,l,m?.id]),f=i.useCallback(async e=>{if(m?.id)try{d.info("Registering patient discharge",{patientId:m.id,data:e}),await v.dischargePatientWithTransfer(m.id,e)}catch(a){throw d.error("Error registering patient discharge",a),n.error("Errore nella registrazione della dimissione").show(),a}},[m?.id,n]),b=i.useCallback(()=>{sessionStorage.removeItem("editPazienteId"),u(void 0),c("create"),a("/list")},[a]),j=w();return e.jsxs("div",{className:"patient-form-page-container",children:[j.isMobile&&e.jsx(e.Fragment,{children:p?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("div",{className:"spinner-border mb-3",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"text-muted",children:"Caricamento dati paziente in corso..."})]}):e.jsx(se,{patient:m,mode:l,onSubmit:g,onCancel:b})}),!j.isMobile&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"patient-form-hero",children:e.jsx("div",{className:"patient-form-hero-content",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"patient-form-title",children:p?"Caricamento...":"edit"===l?"Modifica Paziente":"Inserimento Nuovo Paziente"}),e.jsx("p",{className:"patient-form-subtitle",children:p?"Attendere il caricamento dei dati...":"edit"===l?`Modifica i dati di ${m?.nome} ${m?.cognome}`:"Compila il form per aggiungere un nuovo paziente al sistema"})]}),e.jsxs("button",{type:"button",className:"patient-form-back-button",onClick:b,disabled:p,"aria-label":"Torna alla lista",children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"arrow_back"}),e.jsx("span",{className:"back-button-text",children:"Torna alla lista"})]})]})})}),e.jsx("div",{className:"row",children:e.jsxs("div",{className:"col-12 col-lg-10 col-xl-8 mx-auto",children:[e.jsxs("div",{className:"patient-form-card",children:[e.jsx("div",{className:"patient-form-card-header",children:e.jsxs("div",{className:"patient-form-card-title-wrapper",children:[e.jsx("div",{className:"patient-form-card-icon",children:e.jsx("span",{className:"material-icons",children:"edit"===l?"edit":"person_add"})}),e.jsxs("h2",{className:"patient-form-card-title",style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"1rem"},children:[e.jsx("span",{children:"Modifica Dati Paziente"}),"edit"===l&&m&&e.jsxs("span",{style:{fontSize:"1.3rem",fontWeight:"700",color:"#0d6efd"},children:[m.nome," ",m.cognome]})]})]})}),e.jsxs("div",{className:"patient-form-card-body",children:[p?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("div",{className:"spinner-border mb-3",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"text-muted",children:"Caricamento dati paziente in corso..."})]}):e.jsx(H,{patient:m,mode:l,onSubmit:g,onCancel:b}),!p&&"edit"===l&&m&&e.jsx(I,{patientId:m.id,patientName:`${m.nome} ${m.cognome}`,onDischargeSubmit:f})]})]}),e.jsx("div",{className:"patient-form-help-card card",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"patient-form-help-header",children:[e.jsx("div",{className:"help-icon",children:e.jsx("span",{className:"material-icons",children:"info"})}),e.jsx("h3",{className:"help-title",children:"Informazioni"})]}),e.jsxs("ul",{className:"patient-form-help-list",children:[e.jsx("li",{children:"I campi contrassegnati sono obbligatori"}),e.jsx("li",{children:"La data di ricovero non può essere futura"}),e.jsx("li",{children:"Il codice RAD deve essere univoco se specificato"}),e.jsx("li",{children:"I dati possono essere modificati successivamente dalla pagina di dettaglio"})]})]})})]})})]})]})};export{re as PatientFormPage,re as default};
