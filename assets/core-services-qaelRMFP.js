const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/shared-CpQNZA6K.js","assets/auth-feature-BcTinZZO.js","assets/react-vendor-DjwQKAdz.js","assets/ui-vendor-DUoRcVAi.js","assets/shared-DOcGBqNV.css"])))=>i.map(i=>d[i]);
import{D as e,C as t,M as i}from"./ui-vendor-DUoRcVAi.js";import{R as r}from"./auth-feature-BcTinZZO.js";import{c as n}from"./supabase-B_x5r1Gl.js";import{N as o}from"./shared-CpQNZA6K.js";const s={},a=function(e,t,i){let r=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),n=i?.nonce||i?.getAttribute("nonce");r=e(t.map(e=>{if((e=function(e){return"/"+e}(e))in s)return;s[e]=!0;const t=e.endsWith(".css");if(document.querySelector(`link[href="${e}"]${t?'[rel="stylesheet"]':""}`))return;const i=document.createElement("link");return i.rel=t?"stylesheet":"modulepreload",t||(i.as="script"),i.crossOrigin="",i.href=e,n&&i.setAttribute("nonce",n),document.head.appendChild(i),t?new Promise((t,r)=>{i.addEventListener("load",t),i.addEventListener("error",()=>r(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function n(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return r.then(t=>{for(const e of t||[])"rejected"===e.status&&n(e.reason);return e().catch(n)})};(new class{components;constructor(){this.components={Modal:i,Collapse:t,Dropdown:e}}getComponents(){return this.components}initializeGlobal(){"undefined"!=typeof window&&(window.bootstrap=this.components)}}).initializeGlobal();const c=e=>{let t;const i=new Set,r=(e,r)=>{const n="function"==typeof e?e(t):e;if(!Object.is(n,t)){const e=t;t=(null!=r?r:"object"!=typeof n||null===n)?n:Object.assign({},t,n),i.forEach(i=>i(t,e))}},n=()=>t,o={setState:r,getState:n,getInitialState:()=>s,subscribe:e=>(i.add(e),()=>i.delete(e))},s=t=e(r,n,o);return o},l=e=>e;function u(e,t){let i;try{i=e()}catch(r){return}return{getItem:e=>{var t;const r=e=>null===e?null:JSON.parse(e,void 0),n=null!=(t=i.getItem(e))?t:null;return n instanceof Promise?n.then(r):r(n)},setItem:(e,t)=>i.setItem(e,JSON.stringify(t,void 0)),removeItem:e=>i.removeItem(e)}}const d=e=>t=>{try{const i=e(t);return i instanceof Promise?i:{then:e=>d(e)(i),catch(e){return this}}}catch(i){return{then(e){return this},catch:e=>d(e)(i)}}},h={user:null,session:null,currentPatient:null,currentDepartment:null,filters:{search:"",stato:void 0,reparto:void 0,diagnosi:void 0,infetto:void 0,trasferimento:void 0,page:0,sortColumn:"data_ricovero",sortDirection:"desc"},ui:{loading:!1,theme:"light",sidebarOpen:!1}},m=(e=>{const t=(e=>e?c(e):c)(e),i=e=>function(e,t=l){const i=r.useSyncExternalStore(e.subscribe,r.useCallback(()=>t(e.getState()),[e,t]),r.useCallback(()=>t(e.getInitialState()),[e,t]));return r.useDebugValue(i),i}(t,e);return Object.assign(i,t),i})(((e,t)=>(i,r,n)=>{let o={storage:u(()=>localStorage),partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...t},s=!1;const a=new Set,c=new Set;let l=o.storage;if(!l)return e((...e)=>{console.warn(`[zustand persist middleware] Unable to update item '${o.name}', the given storage is currently unavailable.`),i(...e)},r,n);const h=()=>{const e=o.partialize({...r()});return l.setItem(o.name,{state:e,version:o.version})},m=n.setState;n.setState=(e,t)=>(m(e,t),h());const g=e((...e)=>(i(...e),h()),r,n);let p;n.getInitialState=()=>g;const f=()=>{var e,t;if(!l)return;s=!1,a.forEach(e=>{var t;return e(null!=(t=r())?t:g)});const n=(null==(t=o.onRehydrateStorage)?void 0:t.call(o,null!=(e=r())?e:g))||void 0;return d(l.getItem.bind(l))(o.name).then(e=>{if(e){if("number"!=typeof e.version||e.version===o.version)return[!1,e.state];if(o.migrate){const t=o.migrate(e.state,e.version);return t instanceof Promise?t.then(e=>[!0,e]):[!0,t]}console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}return[!1,void 0]}).then(e=>{var t;const[n,s]=e;if(p=o.merge(s,null!=(t=r())?t:g),i(p,!0),n)return h()}).then(()=>{null==n?void 0:n(p,void 0),p=r(),s=!0,c.forEach(e=>e(p))}).catch(e=>{null==n?void 0:n(void 0,e)})};return n.persist={setOptions:e=>{o={...o,...e},e.storage&&(l=e.storage)},clearStorage:()=>{null==l?void 0:l.removeItem(o.name)},getOptions:()=>o,rehydrate:()=>f(),hasHydrated:()=>s,onHydrate:e=>(a.add(e),()=>{a.delete(e)}),onFinishHydration:e=>(c.add(e),()=>{c.delete(e)})},o.skipHydration||f(),p||g})((e,t)=>({...h,setState:(t,i)=>e({[t]:i}),setLoading:t=>e(e=>({ui:{...e.ui,loading:t}})),setTheme:t=>e(e=>({ui:{...e.ui,theme:t}})),toggleSidebar:()=>e(e=>({ui:{...e.ui,sidebarOpen:!e.ui.sidebarOpen}})),setUser:t=>e({user:t}),setSession:t=>e({session:t}),setFilters:t=>e(e=>({filters:{...e.filters,...t,page:0}})),setPage:t=>e(e=>({filters:{...e.filters,page:t}})),setSort:i=>{const{filters:r}=t(),n=r.sortColumn===i&&"desc"===r.sortDirection?"asc":"desc";e(e=>({filters:{...e.filters,sortColumn:i,sortDirection:n,page:0}}))},resetFilters:()=>e(e=>({...e,filters:h.filters}))}),{name:"app-storage",storage:u(()=>localStorage),partialize:e=>({ui:{...e.ui,loading:!1,sidebarOpen:!1},filters:e.filters})})),g=()=>{const{user:e,session:t,setUser:i,setSession:r}=m();return{user:e,session:t,isAuthenticated:!!t&&!!e,setUser:i,setSession:r}},p=()=>{const{ui:e,setLoading:t,toggleSidebar:i,setTheme:r}=m();return{uiState:e,setLoading:t,toggleSidebar:i,setTheme:r,currentRoute:m(e=>e.ui.currentRoute),setCurrentRoute:e=>{m.setState(t=>({ui:{...t.ui,currentRoute:e}}))}}},f=()=>[m(e=>e.ui.theme),m(e=>e.setTheme)],y=()=>[m(e=>e.ui.sidebarOpen),m(e=>e.toggleSidebar)],b={NODE_ENV:"production",SUPABASE_URL:"https://aiguzywadjzyrwandgba.supabase.co",SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZ3V6eXdhZGp6eXJ3YW5kZ2JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDM1MzQsImV4cCI6MjA2Njc3OTUzNH0.pezVt3-xxkHBYK2V6ryHUtj_givF_TA9xwEzuK2essw",OAUTH_DEBUG:!1,LOG_LEVEL:"warn",APP_NAME:"PatientTrack",APP_VERSION:"1.0.0",MOBILE_BREAKPOINT:767,FEATURES:{ROLE_BASED_ACCESS:!0}},v=b.LOG_LEVEL;const w=new class{level;levels;constructor(){this.levels={error:0,warn:1,info:2,debug:3};const e=v.toLowerCase();this.level=this.levels[e]??1}sanitizeArgs(e){const t=new Set(["password","token","auth","secret","nome","cognome","codice_fiscale","codice_rad","telefono","email","indirizzo","indirizzo_residenza","citta","cap","note","descrizione"]),i=e=>{if(null==e)return e;if("string"==typeof e)return e.length>200?e.slice(0,200)+"‚Ä¶":e;if(e instanceof Error)return{name:e.name,message:e.message};if(Array.isArray(e))return e.map(i);if("object"==typeof e){const r={};for(const[n,o]of Object.entries(e))r[n]=t.has(n)?"[REDACTED]":i(o);return r}return e};return e.map(i)}log(...e){}warn(...e){}error(...e){const t=this.sanitizeArgs(e);console.error(...t)}info(...e){}debug(...e){}group(e){}groupEnd(){}table(e){}time(e){}timeEnd(e){}};let S=null;function E(e){S=e}function M(){document.addEventListener("click",e=>{const t=e.target.closest(".btn-back-menu");if(t){e.preventDefault(),t.style.transform="scale(0.95)",t.style.transition="transform 0.1s ease",setTimeout(()=>{t.style.transform="",t.style.transition=""},150);const i=t.getAttribute("data-view")||"/home",r=i.startsWith("/")?i:`/${i}`;"/home"!==r&&"/"!==r||(sessionStorage.removeItem("editPazienteId"),sessionStorage.removeItem("formData"),sessionStorage.removeItem("currentFilters")),setTimeout(()=>{S?S(r):window.location.pathname=r},100)}})}function T(e){const t=e.startsWith("/")?e:`/${e}`;S?S(t):window.location.pathname=t}const _=n("https://aiguzywadjzyrwandgba.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZ3V6eXdhZGp6eXJ3YW5kZ2JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDM1MzQsImV4cCI6MjA2Njc3OTUzNH0.pezVt3-xxkHBYK2V6ryHUtj_givF_TA9xwEzuK2essw",{auth:{flowType:"pkce",detectSessionInUrl:!0,persistSession:!0,autoRefreshToken:!0,storage:window.localStorage,storageKey:"supabase.auth.token",debug:!1},global:{headers:{"X-Client-Info":"supabase-js-vite"}}});const A=new class{readyPromise;resolveReady;constructor(){this.readyPromise=new Promise(e=>{this.resolveReady=e}),this.init()}async init(){await this.waitForViteReady(),await this.waitForSupabaseReady(),this.notifyReady()}async waitForViteReady(){return new Promise(e=>{"complete"===document.readyState?(w.log("Vite √® pronto"),e()):window.addEventListener("load",()=>{setTimeout(()=>{w.log("Vite √® pronto (dopo load)"),e()},100)},{once:!0})})}async waitForSupabaseReady(){return new Promise(async e=>{try{await _.auth.getSession(),w.log("Supabase √® pronto"),e()}catch(t){w.error("Errore nell'inizializzazione Supabase:",t),this.clearCorruptedState(),setTimeout(async()=>{try{await _.auth.getSession(),w.log("Supabase √® pronto (dopo retry)"),e()}catch(t){w.error("Errore nel retry Supabase:",t),e()}},500)}})}clearCorruptedState(){w.log("Pulisco stato corrotto...");["supabase.auth.token","sb-aiguzywadjzyrwandgba-auth-token"].forEach(e=>{localStorage.removeItem(e),sessionStorage.removeItem(e)}),document.cookie.split(";").forEach(e=>{const t=e.indexOf("="),i=(t>-1?e.substring(0,t):e).trim();(i.includes("supabase")||i.includes("sb-"))&&(document.cookie=`${i}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`)})}onReady(e){return e?(void this.readyPromise.then(e),void 0):this.readyPromise}notifyReady(){w.log("Middleware Vite-Supabase pronto"),this.resolveReady()}};const C=new class{isInitialized=!1;authState="idle";errorState=null;constructor(){void this.init()}async init(){if(!this.isInitialized){await new Promise(e=>{A.onReady(e)});try{const e=new URLSearchParams(window.location.search),t=new URLSearchParams(window.location.hash.substring(1));t.has("access_token")||t.has("refresh_token")||e.has("code")||t.has("error")?(w.log("Rilevato redirect OAuth con parametri reali, gestisco la sessione..."),this.authState="authenticating",await this.handleOAuthCallback()):w.log("Nessun parametro OAuth rilevato, inizializzazione normale"),this.isInitialized=!0}catch(e){w.error("Errore nell'inizializzazione OAuth:",e),this.errorState=e,this.authState="error"}}}async handleOAuthCallback(){try{w.log("Gestisco callback OAuth...");if(new URLSearchParams(window.location.search).has("code")){w.log("Rilevato parametro code, eseguo exchangeCodeForSession...");const{error:e,data:t}=await _.auth.exchangeCodeForSession(window.location.href);if(e)throw w.error("Errore in exchangeCodeForSession:",e),this.clearCorruptedState(),e;w.log("exchangeCodeForSession completato:",!!t?.session)}const{data:e,error:t}=await _.auth.getSession();if(t)throw w.error("Errore nel callback OAuth:",t),this.clearCorruptedState(),t;const i=e.session;if(i){w.log("Sessione OAuth recuperata con successo"),this.authState="authenticated",this.cleanupOAuthUrl();const e=sessionStorage.getItem("redirectUrl");if(e){sessionStorage.removeItem("redirectUrl");T((e.startsWith("#")?e.slice(1):e)||"/home")}else sessionStorage.removeItem("editPazienteId"),sessionStorage.removeItem("formData"),sessionStorage.removeItem("currentFilters"),void T("/home")}return i}catch(e){throw w.error("Errore nella gestione del callback OAuth:",e),this.clearCorruptedState(),e}}clearCorruptedState(){w.log("Pulisco stato corrotto OAuth..."),A.clearCorruptedState(),this.cleanupOAuthUrl(),this.authState="idle",this.errorState=null}cleanupOAuthUrl(){if(window.location.hash.includes("access_token")||window.location.search.includes("code")){const e=window.location.hash.split("&")[0],t=window.location.pathname+(e&&"#"!==e?e:"");window.history.replaceState({},document.title,t),w.log("URL pulito da parametri OAuth, nuovo URL:",t)}}async signInWithGoogle(){try{await A.onReady(),"error"===this.authState&&(w.log("Stato di errore rilevato, pulisco..."),this.clearCorruptedState(),await new Promise(e=>setTimeout(e,100))),this.authState="authenticating";const e=window.location.origin+window.location.pathname+window.location.hash;w.log("Iniziando login OAuth con redirect:",e);const{data:t,error:i}=await _.auth.signInWithOAuth({provider:"google",options:{redirectTo:e,queryParams:{}}});if(i)throw w.error("Errore nella chiamata OAuth:",i),this.authState="error",this.errorState=i,i;return w.log("Login OAuth iniziato con successo:",t),{success:!0,data:t}}catch(e){w.error("Errore completo nel login OAuth:",e);const t=e;401===t?.status&&(w.log("Errore 401 rilevato, pulisco stato corrotto..."),this.clearCorruptedState()),this.authState="error",this.errorState=t??e;return{success:!1,error:t?.message||e?.message||"Errore sconosciuto"}}}getAuthState(){return{state:this.authState,error:this.errorState,isInitialized:this.isInitialized}}},N={session:null,profile:null,isLoading:!0};function I(e,t="editor"){const i=e.email?.split("@")[0]??e.user_metadata?.name??"utente";return{id:e.id,username:i,full_name:e.user_metadata?.full_name||e.user_metadata?.name||e.email||"Utente",role:t,email:e.email,fallback:!0}}async function x(e){try{if("undefined"!=typeof window&&window.__PW_E2E_AUTH_MOCK){e?.user?(N.session=e,N.profile=I(e.user,"admin")):(N.session=null,N.profile=null);try{window.dispatchEvent(new CustomEvent("auth:session-changed",{detail:{session:e}}))}catch{}return window.dispatchEvent(new CustomEvent("auth-profile-loaded")),void 0}}catch{}if(e?.user){const t=await async function(e){if(!e)return null;try{const{data:t,error:i,status:r}=await _.from("profiles").select("username, full_name, role").eq("id",e.id).maybeSingle();if(i&&406!==r)throw i;const n=t??null;return n?{id:e.id,username:n.username??e.email?.split("@")[0]??"utente",full_name:n.full_name??e.email??"Utente",role:n.role??"editor",email:e.email}:null}catch(t){w.error("Errore nel recuperare il profilo utente:",t),w.warn("üîÑ Uso profilo di fallback per utente:",e.email?.substring(0,3)+"***");try{const t=(await _.rpc("get_user_role_safe",{user_uuid:e.id})).data||"editor";return w.info("‚úÖ Ruolo recuperato con funzione sicura:",t),I(e,t)}catch(i){return w.error("‚ùå Errore nel recupero ruolo sicuro, uso fallback minimo:",i),I(e)}}}(e.user);N.session=e,t?N.profile=t:(w.warn("‚ö†Ô∏è Profilo non disponibile, uso fallback per utente:",e.user.email?.substring(0,3)+"***"),N.profile=I(e.user)),N.profile?.fallback?w.info("‚úÖ Utente autenticato con profilo di fallback:",N.profile.username):w.info("‚úÖ Utente autenticato:",N.profile?.username||"sconosciuto")}else N.session=null,N.profile=null;try{window.dispatchEvent(new CustomEvent("auth:session-changed",{detail:{session:e}}))}catch{}window.dispatchEvent(new CustomEvent("auth-profile-loaded"))}async function k(){return C.signInWithGoogle()}async function D(){try{N.session=null,N.profile=null;try{window.dispatchEvent(new CustomEvent("auth:session-changed",{detail:{session:null}}))}catch{}window.dispatchEvent(new CustomEvent("auth-profile-loaded"));try{const{error:e}=await _.auth.signOut();if(e&&"Auth session missing!"!==e.message)throw e}catch(e){const t=e;if("Auth session missing!"!==t?.message&&"AuthSessionMissingError"!==t?.name)throw e;w.warn("Sessione gi√† mancante durante logout, continuando...")}return{success:!0,data:void 0}}catch(t){w.error("Errore durante il signOut:",t),N.session=null,N.profile=null;try{window.dispatchEvent(new CustomEvent("auth:session-changed",{detail:{session:null}}))}catch{}window.dispatchEvent(new CustomEvent("auth-profile-loaded"));return{success:!1,error:(t instanceof Error?t.message:String(t))??"Logout fallito"}}}async function B(e,t){try{const i=t||function(e=32){const t=new Uint8Array(e);return crypto.getRandomValues(t),btoa(String.fromCharCode(...t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}(32),{data:r,error:n}=await _.auth.signInWithIdToken({provider:"google",token:e,nonce:i});if(n)throw n;return w.log("Login BYO Google (GIS) via ID token completato"),{success:!0,data:r}}catch(i){w.error("Errore login via ID token:",i);return{success:!1,error:(i instanceof Error?i.message:String(i))??"Errore ID token"}}}async function R(e){C.init(),N.isLoading=!0;try{if("undefined"!=typeof window&&window.__PW_E2E_AUTH_MOCK){const t={access_token:"e2e-token",token_type:"bearer",refresh_token:"e2e-refresh",expires_in:3600,expires_at:Math.floor(Date.now()/1e3)+3600,provider_token:null,provider_refresh_token:null,user:{id:"e2e-user-123",email:"e2e@example.com",app_metadata:{},user_metadata:{name:"E2E User"},aud:"authenticated",created_at:(new Date).toISOString(),confirmed_at:(new Date).toISOString(),email_confirmed_at:(new Date).toISOString(),last_sign_in_at:(new Date).toISOString(),role:"authenticated",is_anonymous:!1,phone:"",phone_confirmed_at:null,recovery_sent_at:null,email_change_sent_at:null,new_email:"",new_phone:"",factors:[],identities:[],raw_app_meta_data:{},raw_user_meta_data:{}}};return await x(t),N.isLoading=!1,e?.(t),w.log("E2E auth mock attivo: sessione e profilo impostati"),void 0}}catch{}let t=null,i=null;for(let n=1;n<=3;n+=1)try{const{data:{session:e},error:r}=await _.auth.getSession();if(!r){t=e;break}if(i=r,w.warn(`Tentativo ${n}/3 - Errore nel recupero sessione:`,r),n<3){await new Promise(e=>setTimeout(e,1e3*n));continue}}catch(r){if(i=r,w.warn(`Tentativo ${n}/3 - Errore critico:`,r),n<3){await new Promise(e=>setTimeout(e,1e3*n));continue}}i&&!t&&w.error("Fallimento definitivo nel recupero sessione dopo",3,"tentativi:",i),w.log("Sessione iniziale recuperata:",t),await x(t),N.isLoading=!1,e?.(t??null),_.auth.onAuthStateChange(async(t,i)=>{w.log("Auth event:",t,"Session:",i),"SIGNED_OUT"===t&&"error"===C.getAuthState().state&&C.clearCorruptedState(),i?.access_token!==N.session?.access_token&&(await x(i),e?.(i))}),w.log("Sistema di autenticazione inizializzato")}function P(){!function(){$(localStorage.getItem("theme")||"light");const e=document.getElementById("theme-toggle"),t=document.getElementById("theme-icon");if(!e||!t)return;e.addEventListener("click",()=>{$("dark"===(document.documentElement.getAttribute("data-bs-theme")||"light")?"light":"dark")})}(),function(){const e=document.getElementById("mobile-theme-toggle"),t=document.getElementById("mobile-theme-icon");if(!e||!t)return;function i(){if(!t||!e)return;"dark"===(document.documentElement.getAttribute("data-bs-theme")||"light")?(t.textContent="light_mode",e.setAttribute("title","Modalit√† chiara")):(t.textContent="dark_mode",e.setAttribute("title","Modalit√† scura"))}e.addEventListener("click",e=>{e.preventDefault();$("dark"===(document.documentElement.getAttribute("data-bs-theme")||"light")?"light":"dark")});new MutationObserver(i).observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]}),i()}()}function $(e){document.documentElement.setAttribute("data-bs-theme",e),localStorage.setItem("theme",e);const t=document.getElementById("theme-icon"),i=document.getElementById("theme-toggle");t&&i&&("dark"===e?(t.textContent="light_mode",i.setAttribute("title","Modalit√† chiara")):(t.textContent="dark_mode",i.setAttribute("title","Modalit√† scura")));const r=new CustomEvent("theme-change",{detail:{theme:e}});document.dispatchEvent(r),window.dispatchEvent(r)}function O(){return document.documentElement.getAttribute("data-bs-theme")||"light"}let z=null;async function L({clientId:e}){var t;await(t="https://accounts.google.com/gsi/client",z||(z=new Promise((e,i)=>{if("undefined"!=typeof window){const t=window.google;if(t?.accounts?.id)return e(),void 0}if("undefined"==typeof document)return i(new Error("Google Identity Services requires a browser environment")),void 0;const r=document.createElement("script");r.src=t,r.async=!0,r.defer=!0,r.onload=()=>e(),r.onerror=()=>i(new Error("Failed to load Google Identity Services script")),document.head.appendChild(r)}),z));const i=function(e=32){const t=new Uint8Array(e);return window.crypto.getRandomValues(t),btoa(String.fromCharCode(...t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}(32),r=window.google;return new Promise((t,n)=>{const o=setTimeout(()=>n(new Error("GIS prompt not available")),4e3),s=setTimeout(()=>n(new Error("Google One Tap timed out")),2e4);try{if(!r?.accounts?.id)throw new Error("Google Identity Services not available on window.google");r.accounts.id.initialize({client_id:e,ux_mode:"popup",itp_support:!0,use_fedcm_for_prompt:!1,callback:e=>{try{e&&e.credential?(clearTimeout(o),clearTimeout(s),t({idToken:e.credential,nonce:i})):e&&e.error&&(clearTimeout(o),clearTimeout(s),n(new Error(e.error)))}catch(r){clearTimeout(o),clearTimeout(s),n(r)}},nonce:i}),r.accounts.id.prompt(e=>{try{if(e?.isNotDisplayed?.()){const t=e.getNotDisplayedReason?.();clearTimeout(o),n(new Error(`GIS not displayed: ${t||"unknown"}`))}else if(e?.isSkippedMoment?.()){const t=e.getSkippedReason?.();clearTimeout(o),n(new Error(`GIS skipped: ${t||"unknown"}`))}else if(e?.isDismissedMoment?.()){const t=e.getDismissedReason?.();clearTimeout(o),n(new Error(`GIS dismissed: ${t||"unknown"}`))}}catch(t){}})}catch(a){clearTimeout(o),clearTimeout(s),n(a)}})}function F(){void window.addEventListener("error",e=>{if(["A listener indicated an asynchronous response by returning true","Extension context invalidated","Could not establish connection","chrome-extension://","moz-extension://"].some(t=>e.message&&e.message.includes(t)))return w.debug("Browser extension error ignored:",e.message),e.preventDefault(),!1;w.error("Application error:",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,error:e.error})}),window.addEventListener("unhandledrejection",e=>{const t=e.reason?.message||e.reason?.toString()||"";if(["A listener indicated an asynchronous response by returning true","message channel closed before a response was received","Extension context invalidated","Could not establish connection"].some(e=>t.includes(e)))return w.debug("Browser extension promise rejection ignored:",t),e.preventDefault(),void 0;w.error("Unhandled promise rejection:",e.reason)}),window.appLogger={info:(e,t=null)=>{w.log(`[APP] ${e}`,t||"")},warn:(e,t=null)=>{w.warn(`[APP WARNING] ${e}`,t||"")},error:(e,t=null)=>{w.error("[APP ERROR]",e,t||"")},debug:(e,t=null)=>{"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname||w.log(`[APP DEBUG] ${e}`,t||"")},log:(e,t=null)=>{w.log(`[APP LOG] ${e}`,t||"")}}}let V=null,U=null;async function j(){return V||(U||(U=(async()=>{try{const{notificationService:e}=await a(async()=>{const{notificationService:e}=await Promise.resolve().then(()=>Ae);return{notificationService:e}},void 0);return V=e,V&&"function"==typeof V.init&&await V.init(),V}catch(e){if(console.error("Failed to initialize NotificationService:",e),V)return V;throw e}})(),U))}const q=async(e,t)=>(await j()).success(e,t),G=async(e,t)=>(await j()).info(e,t),H=async(e,t)=>(await j()).warning(e,t),J=async(e,t)=>(await j()).error(e,t);const W=new class{notifications=[];settings;subscribers=new Map;cleanupTimer=null;constructor(){this.settings=this.getDefaultSettings(),this.loadPersistedSettings(),this.startAutoCleanup(),w.debug("NotificationStateManager initialized")}getDefaultSettings(){return{maxVisible:5,defaultDuration:5e3,position:"top-right",enableSounds:!1,enableAnimations:!0,autoCleanupInterval:3e5,maxStoredNotifications:50,persistentTypes:["error"],soundVolume:.5,customDurations:{success:4e3,info:5e3,warning:6e3,error:0}}}loadPersistedSettings(){try{const e=localStorage.getItem("notificationSettings");if(e){const t=JSON.parse(e);this.settings={...this.settings,...t}}}catch(e){w.warn("Failed to load persisted notification settings:",e)}}persistSettings(){try{localStorage.setItem("notificationSettings",JSON.stringify(this.settings))}catch(e){w.warn("Failed to persist notification settings:",e)}}subscribe(e){const t=Symbol("notificationSubscriber");return this.subscribers.set(t,e),()=>{this.subscribers.delete(t)}}notifySubscribers(){this.subscribers.forEach((e,t)=>{try{e(this.notifications,this.settings)}catch(i){w.error(`Error in notification subscriber ${String(t)}:`,i)}})}addNotification(e,t,i={}){"number"==typeof i&&(i={duration:i});const r=this.normalizeNotificationType(e),n=void 0!==this.settings.customDurations[r]?this.settings.customDurations[r]:this.settings.defaultDuration,o={id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:r,message:t,timestamp:new Date,isVisible:!0,isRemoving:!1,options:{duration:n,persistent:this.settings.persistentTypes.includes(r),...i}};return o.options.persistent&&(o.options.duration=0),w.debug(`[NotificationStateManager] Current notifications before adding: ${this.notifications.length}`,this.notifications),this.handleDeduplication(r,t)?"":(this.notifications=[...this.notifications,o],this.enforceMaxNotifications(),this.notifySubscribers(),w.debug(`[NotificationStateManager] Notification added. New notifications array length: ${this.notifications.length}`,this.notifications),o.id)}handleDeduplication(e,t){try{const i=Date.now(),r=1500;if("success"===e||"info"===e){const n=[...this.notifications].reverse().findIndex(n=>{const o=new Date(n.timestamp).getTime();return n.type===e&&n.message===t&&i-o<=r});if(-1!==n){const e=this.notifications.length-1-n,t=this.notifications[e],i={...t,timestamp:new Date,options:{...t.options,duplicateCount:(t.options.duplicateCount||1)+1}};return this.notifications=[...this.notifications],this.notifications[e]=i,this.notifySubscribers(),!0}}}catch(i){w.warn("Deduplication failed:",i)}return!1}enforceMaxNotifications(){if(this.notifications.length>this.settings.maxStoredNotifications){w.warn(`[NotificationStateManager] Max stored notifications (${this.settings.maxStoredNotifications}) exceeded. Trimming old notifications.`);const e=[...this.notifications].sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime()).slice(0,this.notifications.length-this.settings.maxStoredNotifications);this.notifications=this.notifications.filter(t=>!e.includes(t)||t.options.persistent&&"error"===t.type),w.debug(`[NotificationStateManager] Notifications after trimming: ${this.notifications.length}`,this.notifications)}}normalizeNotificationType(e){const t=String(e||"").toLowerCase().trim();return t?["error","errore","err","danger","fatal"].includes(t)?"error":["success","ok","successo"].includes(t)?"success":["warning","warn","avviso","alert"].includes(t)?"warning":(["info","informazione","notice"].includes(t),"info"):"info"}removeNotification(e){const t=this.notifications.length;this.notifications=this.notifications.filter(t=>t.id!==e),this.notifications.length!==t&&(w.debug(`[NotificationStateManager] Notification ${e} removed`),this.notifySubscribers())}clearAllNotifications(){this.notifications.length>0&&(this.notifications=[],this.notifySubscribers(),w.debug("[NotificationStateManager] All notifications cleared"))}clearNotificationsByType(e){const t=this.notifications.length;this.notifications=this.notifications.filter(t=>t.type!==e),this.notifications.length!==t&&(w.debug(`[NotificationStateManager] Notifications of type '${e}' cleared`),this.notifySubscribers())}updateSettings(e){const t={...this.settings,...e};this.settings=t,this.persistSettings(),void 0!==e.autoCleanupInterval&&this.startAutoCleanup(),this.notifySubscribers(),w.debug("[NotificationStateManager] Settings updated:",t)}getSettings(){return{...this.settings}}getNotifications(){return[...this.notifications]}getNotificationsByType(e){return this.notifications.filter(t=>t.type===e)}getVisibleNotifications(){return this.notifications.filter(e=>e.isVisible&&!e.isRemoving).slice(-this.settings.maxVisible)}hasErrorNotifications(){return this.notifications.some(e=>"error"===e.type)}getStats(){const e={success:0,error:0,warning:0,info:0};let t=0;return this.notifications.forEach(i=>{e[i.type]=(e[i.type]||0)+1,i.options.persistent&&t++}),{total:this.notifications.length,visible:this.getVisibleNotifications().length,byType:e,persistent:t}}clearOldNotifications(e=3e5){const t=Date.now(),i=this.notifications.length;this.notifications=this.notifications.filter(i=>{const r=new Date(i.timestamp).getTime();if(!Number.isFinite(r))return!0;return!(t-r>e&&!i.options.persistent)});const r=i-this.notifications.length;return r>0&&(w.debug(`[NotificationStateManager] Cleaned up ${r} old notifications`),this.notifySubscribers()),r}startAutoCleanup(){this.cleanupTimer&&clearInterval(this.cleanupTimer);const e=this.settings.autoCleanupInterval;e>0&&(this.cleanupTimer=setInterval(()=>{this.clearOldNotifications()},e),w.debug(`[NotificationStateManager] Auto cleanup started with interval: ${e}ms`))}exportSettings(){return{version:"2.0",timestamp:(new Date).toISOString(),settings:{...this.settings},exportedBy:"NotificationStateManager"}}importSettings(e){try{return!(!e||"object"!=typeof e||!e.settings)&&(e.version&&"2.0"!==e.version&&"1.0"!==e.version&&w.warn(`Unsupported backup version: ${e.version}`),this.settings={...this.getDefaultSettings(),...e.settings},this.persistSettings(),this.startAutoCleanup(),this.notifySubscribers(),w.debug("[NotificationStateManager] Settings imported successfully"),!0)}catch(t){return w.error("Failed to import notification settings:",t),!1}}destroy(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null),this.subscribers.clear(),this.notifications=[],w.debug("[NotificationStateManager] Destroyed")}};function Q(e,t){J(e,t).catch(e=>{console.error("Failed to show error notification:",e)})}function X(e,t){q(e,t).catch(e=>{console.error("Failed to show success notification:",e)})}function Z(e,t){G(e,t).catch(e=>{console.error("Failed to show info notification:",e)})}function K(e,t){H(e,t).catch(e=>{console.error("Failed to show warning notification:",e)})}const Y={SUCCESS:{icon:"check_circle",ariaRole:"status",ariaLive:"polite",defaultDuration:4e3},ERROR:{icon:"error",ariaRole:"alert",ariaLive:"assertive",defaultDuration:0},WARNING:{icon:"warning",ariaRole:"alert",ariaLive:"assertive",defaultDuration:6e3},INFO:{icon:"info",ariaRole:"status",ariaLive:"polite",defaultDuration:5e3}},ee={maxWidth:768};function te(e,t){if(void 0!==t)return t;const i=Y[e.toUpperCase()];return i?i.defaultDuration:5e3}class ie{element;duration;type;startTime;animationId;isPaused;pausedTime;isDestroyed;timing;progressBar;progressFill;pauseStartTime;lastLoggedProgress;constructor(e,t=4e3,i="success"){this.element=e,this.duration=t,this.type=i,this.startTime=null,this.animationId=null,this.isPaused=!1,this.pausedTime=0,this.isDestroyed=!1,this.timing=this.createEasingFunction("linear"),this.progressBar=null,this.progressFill=null,this.pauseStartTime=null,this.lastLoggedProgress=-1,this.init()}createEasingFunction(e="linear"){const t={linear:e=>e,easeOut:e=>1-Math.pow(1-e,3),easeIn:e=>Math.pow(e,3),easeInOut:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2};return t[e]||t.linear}init(){if(this.isDestroyed)return;const e=this.element.querySelector(".notification__progress--js-placeholder");e?this.replaceProgressBarPlaceholder(e):this.element.querySelector(".notification__progress")||this.createProgressBar(),this.progressBar=this.element.querySelector(".notification__progress"),this.progressFill=this.element.querySelector(".notification__progress-fill"),this.progressBar&&this.progressFill&&this.start()}replaceProgressBarPlaceholder(e){e.classList.remove("notification__progress--js-placeholder"),e.classList.add("notification__progress--js-controlled"),e.setAttribute("aria-valuenow","100");const t={success:"rgba(16, 185, 129, 0.2)",error:"rgba(239, 68, 68, 0.2)",warning:"rgba(245, 158, 11, 0.2)",info:"rgba(6, 182, 212, 0.2)"};e.style.cssText=`\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: ${t[this.type]||t.info};\n            border-radius: 0 0 8px 8px;\n            overflow: hidden;\n            opacity: 1;\n            z-index: 10;\n            will-change: transform;\n        `;const i=document.createElement("div");i.className="notification__progress-fill";const r={success:"linear-gradient(90deg, #10b981, #34d399)",error:"linear-gradient(90deg, #ef4444, #f87171)",warning:"linear-gradient(90deg, #f59e0b, #fbbf24)",info:"linear-gradient(90deg, #06b6d4, #22d3ee)"};i.style.cssText=`\n            position: absolute;\n            top: 0;\n            left: 0;\n            height: 100%;\n            width: 100%;\n            background: ${r[this.type]||r.info};\n            opacity: 0.9;\n            transform-origin: left;\n            transform: scaleX(1);\n            transition: none;\n            will-change: transform;\n            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);\n        `,e.innerHTML="",e.appendChild(i)}createProgressBar(){const e={success:"rgba(16, 185, 129, 0.2)",error:"rgba(239, 68, 68, 0.2)",warning:"rgba(245, 158, 11, 0.2)",info:"rgba(6, 182, 212, 0.2)"},t={success:"linear-gradient(90deg, #10b981, #34d399)",error:"linear-gradient(90deg, #ef4444, #f87171)",warning:"linear-gradient(90deg, #f59e0b, #fbbf24)",info:"linear-gradient(90deg, #06b6d4, #22d3ee)"},i=document.createElement("div");i.className="notification__progress notification__progress--js-controlled",i.setAttribute("role","progressbar"),i.setAttribute("aria-label","Tempo rimanente prima della chiusura automatica"),i.setAttribute("aria-valuemin","0"),i.setAttribute("aria-valuemax","100"),i.setAttribute("aria-valuenow","100"),i.style.cssText=`\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: ${e[this.type]||e.info};\n            border-radius: 0 0 8px 8px;\n            overflow: hidden;\n            opacity: 1;\n            z-index: 10;\n            will-change: transform;\n        `;const r=document.createElement("div");r.className="notification__progress-fill",r.style.cssText=`\n            position: absolute;\n            top: 0;\n            left: 0;\n            height: 100%;\n            width: 100%;\n            background: ${t[this.type]||t.info};\n            opacity: 0.9;\n            transform-origin: left;\n            transform: scaleX(1);\n            transition: none;\n            will-change: transform;\n            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);\n        `,i.appendChild(r),this.element.appendChild(i)}start(){this.isDestroyed||(this.startTime=performance.now(),this.lastLoggedProgress=-1,this.animate({timing:this.timing,draw:e=>this.draw(e),duration:this.duration}))}animate({timing:e,draw:t,duration:i}){if(this.isDestroyed)return;const r=this.startTime,n=o=>{if(this.isDestroyed)return;if(this.isPaused)return this.animationId=requestAnimationFrame(n),void 0;let s=(o-(r??0)-this.pausedTime)/i;s>1&&(s=1),s<0&&(s=0);let a=e(s);t(a),this.updateAccessibility(s),s<1?this.animationId=requestAnimationFrame(n):this.onComplete()};this.animationId=requestAnimationFrame(n)}draw(e){if(this.isDestroyed||!this.progressFill)return;this.progressFill.style.transform=`scaleX(${1-e})`}updateAccessibility(e){if(this.progressBar){const t=Math.round(100*(1-e));this.progressBar.setAttribute("aria-valuenow",t.toString())}}pause(){this.isPaused||this.isDestroyed||(this.isPaused=!0,this.pauseStartTime=performance.now())}resume(){this.isPaused&&!this.isDestroyed&&(this.isPaused=!1,this.pauseStartTime&&(this.pausedTime+=performance.now()-this.pauseStartTime,this.pauseStartTime=null))}stop(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.progressFill&&!this.isDestroyed&&(this.progressFill.style.transform="scaleX(0)")}onComplete(){if(this.isDestroyed)return;const e=new CustomEvent("progressComplete",{detail:{element:this.element,type:this.type,duration:this.duration}});this.element.dispatchEvent(e)}destroy(){this.isDestroyed=!0,this.stop(),this.progressBar&&this.progressBar.parentNode&&this.progressBar.parentNode.removeChild(this.progressBar),this.element=null,this.progressBar=null,this.progressFill=null}}function re(e,t,i){return new ie(e,t,i)}let ne=null;function oe(e,t,i=""){try{ne||(ne=o.getInstance({id:"notification-announcer"})),ne.announceNotification?.(e,t,i)}catch(r){const i=document.getElementById("notification-announcer");i&&(i.textContent=`${e}: ${t}`)}}function se(e,t,{removeNotification:i}){const r=e.querySelector(".notification__close");r&&r.addEventListener("click",e=>{e.stopPropagation(),i(t.id)}),e.addEventListener("keydown",e=>{"Escape"===e.key&&(e.preventDefault(),i(t.id))})}function ae(e,t,{pauseAutoCloseTimer:i}){let r=0;e.addEventListener("touchstart",()=>{r=Date.now()}),e.addEventListener("touchend",()=>{Date.now()-r>500&&i?.(t.id)})}class ce{static DEBUG=!1;static notificationQueue=[];static isDOMReady=!1;static domReadyCallbacks=[];static animationSupport=null;static reducedMotionPreference=null;static errorCounts={render:0,animation:0,dom:0,service:0,total:0};static init(){this.checkDOMReady(),this.checkAnimationSupport(),this.checkReducedMotionPreference(),this.setupErrorRecovery(),this.DEBUG&&w.debug("‚úÖ NotificationErrorHandler initialized")}static handleRenderError(e,t,i=null){if(this.errorCounts.render++,this.errorCounts.total++,w.error("‚ùå Notification render error:",e,t),"undefined"!=typeof window&&window.appLogger){const i=window.appLogger;i&&i.error("Notification render failed",{error:e.message,notificationId:t?.id,notificationType:t?.type,stack:e.stack})}try{return i&&"function"==typeof i?i(t):this.createSimpleFallback(t)}catch(r){return w.error("‚ùå Fallback renderer also failed:",r),this.showConsoleFallback(t),null}}static handleAnimationError(e,t,i="unknown"){if(this.errorCounts.animation++,this.errorCounts.total++,w.warn("‚ö†Ô∏è Animation error:",e,i),t)try{t.style.animation="none",t.style.transition="none","entrance"===i?(t.style.opacity="1",t.style.transform="translateX(0)",t.classList.add("notification--visible"),t.classList.remove("notification--entering")):"exit"===i&&(t.style.opacity="0",t.classList.add("notification--hidden"),t.classList.remove("notification--exiting")),this.DEBUG&&w.debug("‚úÖ Animation fallback applied to element")}catch(r){w.error("‚ùå Animation fallback failed:",r)}}static handleServiceError(e,t,i=null){if(this.errorCounts.service++,this.errorCounts.total++,this.errorCounts.service%10==1&&w.error(`‚ùå NotificationService error in ${t} (${this.errorCounts.service} total):`,e),"undefined"!=typeof window&&window.appLogger){const r=window.appLogger;r&&r.error(`NotificationService ${t} failed`,{error:e.message,operation:t,data:i,stack:e.stack})}try{switch(t){case"show":this.recoverFromShowError(i);break;case"remove":this.recoverFromRemoveError(i);break;case"clear":this.recoverFromClearError();break;case"init":this.recoverFromInitError();break;default:w.warn(`‚ö†Ô∏è No recovery strategy for operation: ${t}`)}}catch(r){w.error("‚ùå Error recovery failed:",r)}}static handleDOMError(e,t,i=null){return this.errorCounts.dom++,this.errorCounts.total++,w.error(`‚ùå DOM error in ${t}:`,e),!(!this.isDOMReady&&"render"===t)||(w.debug("üìã DOM not ready, queueing notification"),!1)}static queueNotification(e,t){if(this.isDOMReady)try{return e(t)}catch(i){return this.handleRenderError(i,t)}return this.notificationQueue.push({renderFunction:e,notification:t,timestamp:Date.now()}),this.DEBUG&&w.debug(`üìã Queued notification ${t?.id}, queue size: ${this.notificationQueue.length}`),null}static processNotificationQueue(){if(!this.isDOMReady||0===this.notificationQueue.length)return;w.debug(`üöÄ Processing ${this.notificationQueue.length} queued notifications`);const e=[...this.notificationQueue];this.notificationQueue=[],e.forEach(({renderFunction:e,notification:t,timestamp:i})=>{try{if(Date.now()-i>3e4)return w.warn("‚ö†Ô∏è Skipping old queued notification:",t?.id),void 0;e(t)}catch(r){this.handleRenderError(r,t)}})}static createSimpleFallback(e){const t=document.createElement("div");t.className=`notification notification--${e.type} notification--fallback`,t.setAttribute("data-id",e.id),t.setAttribute("role","error"===e.type?"alert":"status"),t.setAttribute("aria-live","error"===e.type?"assertive":"polite"),t.style.cssText="\n            position: relative;\n            padding: 12px 16px;\n            margin: 8px 0;\n            border-radius: 4px;\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            font-size: 14px;\n            line-height: 1.4;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n            max-width: 400px;\n            word-wrap: break-word;\n        ";const i={success:{bg:"#d4edda",text:"#155724",border:"#c3e6cb"},error:{bg:"#f8d7da",text:"#721c24",border:"#f5c6cb"},warning:{bg:"#fff3cd",text:"#856404",border:"#ffeaa7"},info:{bg:"#d1ecf1",text:"#0c5460",border:"#bee5eb"}},r=i[e.type]||i.info;t.style.backgroundColor=r.bg,t.style.color=r.text,t.style.border=`1px solid ${r.border}`;const n=document.createElement("div");n.style.cssText="display: flex; align-items: flex-start; gap: 8px;";const o=document.createElement("span");o.style.cssText="flex-shrink: 0; font-weight: bold; font-size: 16px;";const s={success:"‚úì",error:"‚úï",warning:"‚ö†",info:"‚Ñπ"};o.textContent=s[e.type]||s.info;const a=document.createElement("div");if(a.style.cssText="flex: 1; min-width: 0;",e.title){const t=document.createElement("div");t.style.cssText="font-weight: bold; margin-bottom: 4px;",t.textContent=e.title,a.appendChild(t)}const c=document.createElement("div");c.textContent=e.message||`Notifica ${e.type||"info"} - Messaggio non disponibile`,a.appendChild(c);const l=document.createElement("button");return l.style.cssText=`\n            background: none;\n            border: none;\n            font-size: 18px;\n            cursor: pointer;\n            padding: 0;\n            margin-left: 8px;\n            color: ${r.text};\n            opacity: 0.7;\n            flex-shrink: 0;\n        `,l.textContent="√ó",l.setAttribute("aria-label","Chiudi notifica"),l.onclick=()=>{t.remove();try{W&&"function"==typeof W.removeNotification&&W.removeNotification(e.id)}catch(i){w.debug("Could not remove from state:",i)}},n.appendChild(o),n.appendChild(a),n.appendChild(l),t.appendChild(n),this.DEBUG&&w.debug("‚úÖ Created simple fallback notification"),t}static showConsoleFallback(e){const t={success:"‚úÖ",error:"‚ùå",warning:"‚ö†Ô∏è",info:"‚ÑπÔ∏è"},i=`${t[e.type]||t.info} NOTIFICATION: ${e.message||`Notifica ${e.type||"info"} - Messaggio non disponibile`}`;"error"===e.type?w.error(i):"warning"===e.type?w.warn(i):w.info(i)}static checkDOMReady(){if("undefined"==typeof document)return this.isDOMReady=!1,void 0;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.isDOMReady=!0,this.processNotificationQueue(),this.domReadyCallbacks.forEach(e=>{try{e()}catch(t){w.error("‚ùå DOM ready callback error:",t)}}),this.domReadyCallbacks=[]}):this.isDOMReady=!0}static checkAnimationSupport(){if("undefined"==typeof window||"undefined"==typeof document)return this.animationSupport=!1,void 0;try{const e=document.createElement("div");e.style.animation="test 1s",this.animationSupport=""!==e.style.animation}catch(e){this.animationSupport=!1}this.DEBUG&&w.debug("üé¨ Animation support:",this.animationSupport)}static checkReducedMotionPreference(){if("undefined"==typeof window||!window.matchMedia)return this.reducedMotionPreference=!1,void 0;try{const e=window.matchMedia("(prefers-reduced-motion: reduce)");this.reducedMotionPreference=e.matches,e.addEventListener("change",e=>{this.reducedMotionPreference=e.matches,this.DEBUG&&w.debug("üé¨ Reduced motion preference changed:",this.reducedMotionPreference)})}catch(e){this.reducedMotionPreference=!1}this.DEBUG&&w.debug("üé¨ Reduced motion preference:",this.reducedMotionPreference)}static setupErrorRecovery(){setInterval(()=>{this.cleanupOldQueuedNotifications()},6e4),"undefined"!=typeof window&&window.addEventListener("error",e=>{e.message&&e.message.includes("notification")&&w.warn("‚ö†Ô∏è Possible notification-related error detected")})}static cleanupOldQueuedNotifications(){const e=Date.now(),t=this.notificationQueue.length;this.notificationQueue=this.notificationQueue.filter(t=>e-t.timestamp<6e4);const i=t-this.notificationQueue.length;i>0&&this.DEBUG&&w.debug(`üßπ Cleaned up ${i} old queued notifications`)}static recoverFromShowError(e){w.debug("üîÑ Attempting recovery from show error");try{const t=this.createSimpleFallback(e);if(t){const e=document.querySelector(".notification-container")||document.querySelector("#notification-container")||document.body;if(e)return e.appendChild(t),w.debug("‚úÖ Fallback notification added to DOM"),!0}}catch(t){w.error("‚ùå Show recovery failed:",t)}return this.showConsoleFallback(e),!1}static recoverFromRemoveError(e){w.debug("üîÑ Attempting recovery from remove error");try{const t=document.querySelector(`[data-id="${e}"]`);if(t)return t.remove(),w.debug("‚úÖ Notification removed via DOM recovery"),!0}catch(t){w.error("‚ùå Remove recovery failed:",t)}return!1}static recoverFromClearError(){w.debug("üîÑ Attempting recovery from clear error");try{const e=document.querySelectorAll('.notification, [class*="notification"]');return e.forEach(e=>{try{e.remove()}catch(t){w.debug("Could not remove notification element:",t)}}),w.debug(`‚úÖ Cleared ${e.length} notifications via DOM recovery`),!0}catch(e){w.error("‚ùå Clear recovery failed:",e)}return!1}static recoverFromInitError(){w.debug("üîÑ Attempting recovery from init error");try{let e=document.querySelector(".notification-container");if(!e)return e=document.createElement("div"),e.className="notification-container notification-container--fallback",e.style.cssText="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    z-index: 9999;\n                    pointer-events: none;\n                ",document.body.appendChild(e),w.debug("‚úÖ Fallback notification container created"),!0}catch(e){w.error("‚ùå Init recovery failed:",e)}return!1}static getErrorStats(){return{...this.errorCounts,queueSize:this.notificationQueue.length,isDOMReady:this.isDOMReady,animationSupport:this.animationSupport,reducedMotionPreference:this.reducedMotionPreference}}static resetErrorStats(){this.errorCounts={render:0,animation:0,dom:0,service:0,total:0}}static shouldDisableAnimations(){return!this.animationSupport||!0===this.reducedMotionPreference}static onDOMReady(e){if(this.isDOMReady)try{e()}catch(t){w.error("‚ùå DOM ready callback error:",t)}else this.domReadyCallbacks.push(e)}}function le(e,{allowHTML:t=!1}={}){if(!t){const t=document.createElement("div");return t.textContent=String(e??""),t.innerHTML}const i=document.createElement("div");i.innerHTML=String(e??"");const r=new Set(["b","strong","i","em","u","br","code","pre","span","p","ul","ol","li","a"]),n=e=>{if(e.nodeType===Node.COMMENT_NODE)return e.remove(),void 0;if(e.nodeType===Node.ELEMENT_NODE){const t=e;if(!r.has(t.tagName.toLowerCase())){const e=t.parentNode;if(!e)return;for(;t.firstChild;)e.insertBefore(t.firstChild,t);return e.removeChild(t),void 0}[...t.attributes].forEach(e=>{const i=e.name.toLowerCase(),r=String(e.value||"");if(i.startsWith("on")||"style"===i)t.removeAttribute(e.name);else if("a"===t.tagName.toLowerCase()&&"href"===i){/^(https?:|mailto:)/i.test(r)||t.removeAttribute("href")}else"href"!==i&&"title"!==i&&t.removeAttribute(e.name)})}let t=e.firstChild;for(;t;){const e=t.nextSibling;n(t),t=e}};return n(i),i.innerHTML}function ue({notification:e,_index:t=0,settings:i,timers:r,timerManager:n,progressBarManager:o,removeNotification:s,startAutoCloseTimer:a,pauseAutoCloseTimer:c,resumeAutoCloseTimer:l,announceNotification:u,attachNotificationEvents:d,attachTouchEvents:h,notificationContainer:m,errorHandler:g=ce}){try{const t=Y[e.type.toUpperCase()]||Y.INFO,E=e.options||{},M=te(e.type,E.duration),T=document.createElement("div");let _=`notification notification--${e.type}`;if(M>0&&!E.persistent&&(_+=" notification--autoclose"),T.className=_,T.dataset.id=e.id,T.setAttribute("role",t.ariaRole),T.setAttribute("aria-live",t.ariaLive),T.setAttribute("aria-atomic","true"),T.setAttribute("tabindex","0"),i.enableAnimations&&!g.shouldDisableAnimations())try{T.classList.add("notification--entering"),T.addEventListener("animationend",e=>{(e.animationName.includes("slideIn")||e.animationName.includes("fadeIn"))&&(T.classList.remove("notification--entering"),T.classList.add("notification--visible"))}),T.addEventListener("animationerror",e=>{g.handleAnimationError(new Error("Animation failed"),T,"entrance")})}catch(p){g.handleAnimationError(p instanceof Error?p:new Error(String(p)),T,"entrance")}else T.classList.add("notification--visible","notification--no-animations");let A="";try{A=`\n                <div class="notification__content">\n                    <span class="material-icons notification__icon" aria-hidden="true">${t.icon}</span>\n                    <div class="notification__body">\n                        ${E.title?`<div class="notification__title">${le(E.title,{allowHTML:!1})}</div>`:""}\n                        <div class="notification__message">${le(e.message,{allowHTML:!!E.allowHTML})}</div>\n                    </div>\n                </div>\n            `,E.duplicateCount&&E.duplicateCount>1&&(A=A.replace('<span class="material-icons notification__icon" aria-hidden="true">',`<span class="notification__count" aria-label="Ripetuta ${E.duplicateCount} volte">√ó${E.duplicateCount}</span><span class="material-icons notification__icon" aria-hidden="true">`)),(!1!==E.closable||E.actions)&&(A+='<div class="notification__actions">',E.actions&&Array.isArray(E.actions)&&E.actions.forEach((e,t)=>{A+=`\n                            <button class="notification__action-btn ${"primary"===e.style?"notification__action-btn--primary":"secondary"===e.style?"notification__action-btn--secondary":""}" \n                                    data-action-index="${t}"\n                                    aria-label="${le(e.label,{allowHTML:!1})}">\n                                ${le(e.label,{allowHTML:!1})}\n                            </button>\n                        `}),!1!==E.closable&&(A+='\n                        <button class="notification__close" \n                                aria-label="Chiudi notifica"\n                                title="Chiudi notifica">\n                            <span class="material-icons" aria-hidden="true">close</span>\n                        </button>\n                    '),A+="</div>");const i=M;i>0&&!E.persistent&&(w.debug(`üîß Creating progress bar placeholder for ${e.type} (${i}ms)`),A+=`\n                    <div class="notification__progress notification__progress--js-placeholder" \n                         aria-hidden="true" \n                         role="progressbar"\n                         aria-label="Tempo rimanente prima della chiusura automatica"\n                         data-duration="${i}"\n                         data-type="${e.type}"></div>\n                `),T.innerHTML=le(A,{allowHTML:!0})}catch(f){w.error("‚ùå Error building notification HTML:",f),T.innerHTML=le(`\n                <div class="notification__content">\n                    <span class="notification__icon">!</span>\n                    <div class="notification__body">\n                        <div class="notification__message">${e.message||"Notifica"}</div>\n                    </div>\n                    <button class="notification__close" aria-label="Chiudi">√ó</button>\n                </div>\n            `,{allowHTML:!1})}try{d(T,e,{timers:r,removeNotification:s,pauseAutoCloseTimer:c,resumeAutoCloseTimer:l,notificationContainer:m})}catch(y){w.error("‚ùå Error attaching notification events:",y);const t=T.querySelector(".notification__close");t&&t.addEventListener("click",()=>{try{s(e.id)}catch(t){T.remove()}})}try{window.innerWidth<=ee.maxWidth&&h(T,e,{pauseAutoCloseTimer:c,resumeAutoCloseTimer:l,removeNotification:s})}catch(b){w.error("‚ùå Error attaching touch events:",b)}try{const t=M;if(t>0&&!E.persistent){const i=T.querySelector(".notification__progress--js-placeholder");if(w.debug("üîç Looking for progress bar placeholder:",i),n&&o)window.innerWidth>768&&(T.addEventListener("mouseenter",()=>{try{n.pause(e.id)}catch{}try{o.pause(e.id)}catch{}}),T.addEventListener("mouseleave",()=>{try{n.resume(e.id)}catch{}try{o.resume(e.id)}catch{}})),w.debug(`üïí Managers provided; start deferred until mount (${e.type})`);else if(i){const i=re(T,t,e.type);a(r,e.id,t,()=>{try{s(e.id)}catch(t){w.error("‚ùå Error in progress complete callback:",t),T.parentNode&&T.remove()}}),window.innerWidth>768&&(T.addEventListener("mouseenter",()=>{i&&i.pause()}),T.addEventListener("mouseleave",()=>{i&&i.resume()})),T._progressBarInstance=i,w.debug(`‚úÖ JavaScript progress bar initialized for ${e.type} (${t}ms)`)}else a(r,e.id,t,()=>{try{s(e.id)}catch(t){w.error("‚ùå Error in auto-close callback:",t),T.parentNode&&T.remove()}}),w.debug(`‚úÖ Fallback timer used for ${e.type} (${t}ms)`)}}catch(v){w.error("‚ùå Error setting up auto-close timer:",v)}try{u(e.type,e.message,E.title||"")}catch(S){w.warn("‚ùå Error announcing notification:",S)}return T}catch(E){return w.error("‚ùå Critical error in createNotificationElement:",E),g.createSimpleFallback(e)}}function de(e){const t=String(e||"").toLowerCase();switch(t){case"errore":case"danger":case"err":case"error":return"error";case"successo":case"ok":case"success":return"success";case"avviso":case"warn":case"warning":return"warning";default:return"info"===t||"informazione"===t?"info":t||"info"}}function he(e,t,i,r){if(e.has(t)){const i=e.get(t);i&&clearTimeout(i.timerId)}const n=Date.now(),o=setTimeout(()=>{e.delete(t),r(t)},i);e.set(t,{timerId:o,originalDuration:i,startTime:n,remainingTime:i,isPaused:!1,pausedAt:null,callback:r})}function me(e,t){const i=e.get(t);i&&!i.isPaused&&(clearTimeout(i.timerId),i.isPaused=!0,i.pausedAt=Date.now(),i.remainingTime=i.remainingTime-(i.pausedAt-i.startTime),w.debug(`‚è∏Ô∏è Timer paused for notification: ${t}`))}function ge(e,t){const i=e.get(t);i&&i.isPaused&&(i.isPaused=!1,i.startTime=Date.now(),i.timerId=setTimeout(()=>{e.delete(t),i.callback&&i.callback(t)},i.remainingTime),w.debug(`‚ñ∂Ô∏è Timer resumed for notification: ${t}`))}function pe(e,t,i){const r=e.get(t);if(r){clearTimeout(r.timerId),e.delete(t);try{"function"==typeof i&&i(t)}catch(n){w.warn("Timer onStop callback error:",n)}w.debug(`‚èπÔ∏è Timer stopped for notification: ${t}`)}}"undefined"!=typeof window&&ce.init();class fe{container;progressBars;constructor(e){this.container=e,this.progressBars=new Map,w.debug("NotificationProgressBarManager initialized")}start(e,t,i){if(t<=0)return null;try{this.stop(e);const r=this.queryElement(e);if(!r)return w.warn(`[ProgressBarManager] Element not found for notification ${e}`),null;const n=this.createProgressBar(r,t,i);return n&&(this.progressBars.set(e,n),r._progressBarInstance=n,w.debug(`[ProgressBarManager] Progress bar started for notification ${e}`)),n}catch(r){return w.error(`[ProgressBarManager] Failed to start progress bar for ${e}:`,r),null}}pause(e){try{const t=this.progressBars.get(e);t&&(t.pause(),w.debug(`[ProgressBarManager] Progress bar paused for notification ${e}`))}catch(t){w.error(`[ProgressBarManager] Failed to pause progress bar for ${e}:`,t)}}resume(e){try{const t=this.progressBars.get(e);t&&(t.resume(),w.debug(`[ProgressBarManager] Progress bar resumed for notification ${e}`))}catch(t){w.error(`[ProgressBarManager] Failed to resume progress bar for ${e}:`,t)}}stop(e){try{const t=this.progressBars.get(e);if(t){t.destroy(),this.progressBars.delete(e);const i=this.queryElement(e);i&&i._progressBarInstance&&(i._progressBarInstance=null),w.debug(`[ProgressBarManager] Progress bar stopped for notification ${e}`)}}catch(t){w.error(`[ProgressBarManager] Failed to stop progress bar for ${e}:`,t)}}pauseAll(){try{this.progressBars.forEach((e,t)=>this.pause(t)),w.debug(`[ProgressBarManager] All progress bars paused (${this.progressBars.size})`)}catch(e){w.error("[ProgressBarManager] Failed to pause all progress bars:",e)}}resumeAll(){try{this.progressBars.forEach((e,t)=>this.resume(t)),w.debug(`[ProgressBarManager] All progress bars resumed (${this.progressBars.size})`)}catch(e){w.error("[ProgressBarManager] Failed to resume all progress bars:",e)}}cleanup(){try{const e=this.progressBars.size;this.progressBars.forEach((e,t)=>this.stop(t)),this.progressBars.clear(),w.debug(`[ProgressBarManager] Cleanup completed (${e} progress bars destroyed)`)}catch(e){w.error("[ProgressBarManager] Failed to cleanup progress bars:",e)}}getStats(){return{active:this.progressBars.size,activeIds:Array.from(this.progressBars.keys())}}isActive(e){return this.progressBars.has(e)}destroy(){this.cleanup(),this.container=null,w.debug("[ProgressBarManager] Manager destroyed")}createProgressBar(e,t,i){try{const r=e.querySelector(".notification__progress--js-placeholder"),n=re(e,t,r?.dataset?.type||e.dataset?.type||"info");if(i){const t=()=>{try{i(e.dataset?.id??"")}catch{}e.removeEventListener("progressComplete",t)};e.addEventListener("progressComplete",t)}return{pause:()=>{try{n?.pause?.()}catch{}},resume:()=>{try{n?.resume?.()}catch{}},destroy:()=>{try{n?.destroy?.()}catch{}},get isPaused(){return Boolean(n?.isPaused)},get isDestroyed(){return Boolean(n?.isDestroyed)},get progress(){try{return n?.progress??0}catch{return 0}}}}catch(r){return w.error("[ProgressBarManager] Failed to create progress bar:",r),null}}queryElement(e){const t=this.container?.querySelector(`[data-id="${e}"]`);return t??null}}class ye{containerEl;timerManager;progressBarManager;settings;onRemove;timersMap;isRendering;_lastRenderedIds;_renderCount;_lastRenderTime;_avgRenderTime;constructor({containerEl:e,timerManager:t,progressBarManager:i,settings:r,onRemove:n,timersMap:o}){this.containerEl=e||null,this.timerManager=t||null,this.progressBarManager=i||null,this.settings=r||{},this.onRemove="function"==typeof n?n:null,this.timersMap=o||new Map,this.isRendering=!1,this._lastRenderedIds=[],this._renderCount=0,this._lastRenderTime=0,this._avgRenderTime=0}setContainer(e){this.containerEl=e,this.progressBarManager&&(this.progressBarManager.container=e)}render(e=[]){if(Array.isArray(e)&&this.containerEl&&!this.isRendering){this.isRendering=!0;try{const i="undefined"!=typeof window&&window.performance&&"function"==typeof window.performance.now?()=>window.performance.now():()=>Date.now(),r=i(),n=new Set(e.map(e=>e.id)),o=new Set(this._lastRenderedIds);o.forEach(e=>{if(!n.has(e))try{this.removeElement(e)}catch(t){ce.handleDOMError(t,"remove",null)}}),e.forEach(e=>{if(!o.has(e.id))try{this.addElement(e)}catch(t){ce.handleRenderError(t,e,e=>{const t=ce.createSimpleFallback(e);return null!=t&&null!=this.containerEl&&this.containerEl.appendChild(t),t})}}),e.forEach(e=>{if(o.has(e.id))try{const t=this.getElementById(e.id);if(!t)return;const i=e?.options?.duplicateCount||1;let r=t.querySelector(".notification__count");if(i>1)if(r)r.textContent=`√ó${i}`,r.setAttribute("aria-label",`Ripetuta ${i} volte`);else{const e=t.querySelector(".notification__icon");r=document.createElement("span"),r.className="notification__count",r.setAttribute("aria-label",`Ripetuta ${i} volte`),r.textContent=`√ó${i}`,e&&e.parentNode?e.parentNode.insertBefore(r,e):t.querySelector(".notification__content")?.prepend(r)}else r&&r.remove()}catch(t){}});const s=e.length,a=Number(this.settings?.maxVisible??5),c=Math.max(0,s-a),l=c>0?e.slice(0,c):[];t=e=>{try{this.onRemove?.(e)}catch{}},void l.forEach(e=>{"success"!==e.type&&"info"!==e.type||setTimeout(()=>{t(e.id)},1e3)}),this._lastRenderedIds=e.map(e=>e.id);const u=Math.max(0,i()-r);this._lastRenderTime=u,this._renderCount+=1,this._avgRenderTime=1===this._renderCount?u:(this._avgRenderTime*(this._renderCount-1)+u)/this._renderCount}finally{this.isRendering=!1}var t}}addElement(e){const t=this.createElement(e);if(!t)throw new Error("createElement returned null");this.containerEl.appendChild(t),this.afterMount(e,t)}removeElement(e){const t=this.getElementById(e);t&&t.parentNode&&t.parentNode.removeChild(t)}getStats(){return{renderCount:this._renderCount,averageRenderTime:this._avgRenderTime,lastRenderTime:this._lastRenderTime}}updateSettings(e){this.settings=e||this.settings}createElement(e){try{return ue({notification:e,settings:this.settings,timers:this.timersMap,timerManager:this.timerManager,progressBarManager:this.progressBarManager,removeNotification:e=>{try{this.onRemove?.(e)}catch{}},announceNotification:oe,attachNotificationEvents:se,attachTouchEvents:ae,notificationContainer:{container:this.containerEl},errorHandler:ce})}catch(t){w.error("[RenderEngine] Failed to create notification element:",t);try{return ce.createSimpleFallback(e)}catch(i){return null}}}afterMount(e,t){try{if(!e||!t)return;const i=e.options||{},r=te(e.type,i.duration);r>0&&!i.persistent&&this.timerManager&&this.progressBarManager&&(this.progressBarManager.start(e.id,r,()=>{try{this.onRemove?.(e.id)}catch{}}),this.timerManager.start(e.id,r),"undefined"!=typeof window&&window.innerWidth>768&&(t.addEventListener("mouseenter",()=>{try{this.timerManager.pause(e.id)}catch{}try{this.progressBarManager.pause(e.id)}catch{}}),t.addEventListener("mouseleave",()=>{try{this.timerManager.resume(e.id)}catch{}try{this.progressBarManager.resume(e.id)}catch{}})))}catch(i){w.error("[RenderEngine] afterMount failed:",i)}}getElementById(e){try{return this.containerEl?.querySelector(`[data-id="${e}"]`)||null}catch(t){return null}}pauseAll(){try{this.timerManager?.pauseAll()}catch{}try{this.progressBarManager?.pauseAll()}catch{}}resumeAll(){try{this.timerManager?.resumeAll()}catch{}try{this.progressBarManager?.resumeAll()}catch{}}cleanupAll(){try{this.timerManager?.stopAll()}catch{}try{this.progressBarManager?.cleanup()}catch{}}removeAnimated(e,t,i){try{const r=this.getElementById(e);if(r&&t)try{r.classList.remove("notification--entering"),r.classList.add("notification--exiting");const t=r.querySelector(".notification__progress");return t&&t.classList.remove("notification__progress--active","notification__progress--paused","notification__progress--resumed"),setTimeout(()=>{try{this.removeElement(e)}catch{}try{i?.()}catch{}},300),void 0}catch{}this.removeElement(e);try{i?.()}catch{}}catch(r){try{i?.()}catch{}}}}function be(e){return"object"==typeof e&&null!==e}class ve{timers;onTimeout;constructor(e){this.timers=new Map,this.onTimeout=e??(e=>w.debug(`Timer expired for notification ${e}`)),w.debug("NotificationTimerManager initialized")}start(e,t,i){try{if(this.stop(e),t<=0)return w.debug(`[TimerManager] No timer set for notification ${e} (duration: ${t})`),!1;const r=i??this.onTimeout;return he(this.timers,e,t,e=>{w.debug(`[TimerManager] Timer ${e} expired`),r(e)}),w.debug(`[TimerManager] Timer started for notification ${e} (${t}ms)`),!0}catch(r){return w.error(`[TimerManager] Failed to start timer for ${e}:`,r),!1}}pause(e){try{return this.timers.has(e)?(me(this.timers,e),w.debug(`[TimerManager] Timer paused for notification ${e}`),!0):(w.debug(`[TimerManager] No timer to pause for notification ${e}`),!1)}catch(t){return w.error(`[TimerManager] Failed to pause timer for ${e}:`,t),!1}}resume(e){try{return this.timers.has(e)?(ge(this.timers,e),w.debug(`[TimerManager] Timer resumed for notification ${e}`),!0):(w.debug(`[TimerManager] No timer to resume for notification ${e}`),!1)}catch(t){return w.error(`[TimerManager] Failed to resume timer for ${e}:`,t),!1}}stop(e,t){try{return!!this.timers.has(e)&&(pe(this.timers,e,t),w.debug(`[TimerManager] Timer stopped for notification ${e}`),!0)}catch(i){return w.error(`[TimerManager] Failed to stop timer for ${e}:`,i),!1}}pauseAll(){let e=0;try{this.timers.forEach((t,i)=>{this.pause(i)&&e++}),w.debug(`[TimerManager] Paused ${e}/${this.timers.size} timers`)}catch(t){w.error("[TimerManager] Failed to pause all timers:",t)}return e}resumeAll(){let e=0;try{this.timers.forEach((t,i)=>{this.resume(i)&&e++}),w.debug(`[TimerManager] Resumed ${e}/${this.timers.size} timers`)}catch(t){w.error("[TimerManager] Failed to resume all timers:",t)}return e}stopAll(e){let t=0;try{Array.from(this.timers.keys()).forEach(i=>{this.stop(i,e)&&t++}),w.debug(`[TimerManager] Stopped ${t} timers`)}catch(i){w.error("[TimerManager] Failed to stop all timers:",i)}return t}cleanupOrphanedTimers(e=[]){let t=0;try{const i=new Set(e);Array.from(this.timers.keys()).forEach(e=>{i.has(e)||this.stop(e)&&t++}),t>0&&w.debug(`[TimerManager] Cleaned up ${t} orphaned timers`)}catch(i){w.error("[TimerManager] Failed to cleanup orphaned timers:",i)}return t}getStats(){try{const e={total:this.timers.size,active:0,paused:0,activeIds:[],pausedIds:[]};return this.timers.forEach((t,i)=>{be(t)&&(t.isPaused??t.paused?(e.paused++,e.pausedIds.push(i)):(e.active++,e.activeIds.push(i)))}),e}catch(e){return w.error("[TimerManager] Failed to get stats:",e),{total:0,active:0,paused:0,activeIds:[],pausedIds:[],error:e instanceof Error?e.message:"Unknown error"}}}hasTimer(e){return this.timers.has(e)}isPaused(e){try{const t=this.timers.get(e);return!!be(t)&&Boolean(t.isPaused??t.paused)}catch(t){return w.error(`[TimerManager] Failed to check if timer ${e} is paused:`,t),!1}}getRemainingTime(e){try{const t=this.timers.get(e);if(!be(t))return-1;if((t.isPaused??t.paused)&&"number"==typeof t.remainingTime)return t.remainingTime;if("number"==typeof t.remainingTime&&"number"==typeof t.startTime){const e=Date.now()-t.startTime;return Math.max(t.remainingTime-e,0)}return-1}catch(t){return w.error(`[TimerManager] Failed to get remaining time for ${e}:`,t),-1}}cleanup(){try{const e=this.stopAll();this.timers.clear(),w.debug(`[TimerManager] Cleanup completed (${e} timers stopped)`)}catch(e){w.error("[TimerManager] Failed to cleanup:",e)}}destroy(){this.cleanup(),this.onTimeout=()=>{},w.debug("[TimerManager] Manager destroyed")}}class we{onHidden;onVisible;_handler;_attached;constructor({onHidden:e,onVisible:t}={}){this.onHidden="function"==typeof e?e:null,this.onVisible="function"==typeof t?t:null,this._handler=this._handleVisibilityChange.bind(this),this._attached=!1}attach(){this._attached||"undefined"==typeof document||(document.addEventListener("visibilitychange",this._handler,{passive:!0}),this._attached=!0)}detach(){this._attached&&"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._handler),this._attached=!1)}_handleVisibilityChange(){try{document.hidden?this.onHidden?.():this.onVisible?.()}catch{}}}class Se{timerManager;progressBarManager;legacyTimersMap;constructor({timerManager:e,progressBarManager:t,legacyTimersMap:i}){this.timerManager=e??null,this.progressBarManager=t??null,this.legacyTimersMap=i??new Map}start(e,t,i){return this.timerManager?this.timerManager.start(e,t,i):!(t<=0)&&(he(this.legacyTimersMap,e,t,i),!0)}pause(e){return this.timerManager?this.timerManager.pause(e):!!this.legacyTimersMap.has(e)&&(me(this.legacyTimersMap,e),!0)}resume(e){return this.timerManager?this.timerManager.resume(e):!!this.legacyTimersMap.has(e)&&(ge(this.legacyTimersMap,e),!0)}stop(e,t){const i=t??(e=>this.progressBarManager?.stop(e));return this.timerManager?this.timerManager.stop(e,i):!!this.legacyTimersMap.has(e)&&(pe(this.legacyTimersMap,e,i),!0)}pauseAll(){if(this.timerManager)return this.timerManager.pauseAll();let e=0;return this.legacyTimersMap.forEach((t,i)=>{this.pause(i)&&e++}),e}resumeAll(){if(this.timerManager)return this.timerManager.resumeAll();let e=0;return this.legacyTimersMap.forEach((t,i)=>{this.resume(i)&&e++}),e}stopAll(e){if(this.timerManager)return this.timerManager.stopAll(e);let t=0;const i=e??(e=>this.progressBarManager?.stop(e));return Array.from(this.legacyTimersMap.keys()).forEach(e=>{this.legacyTimersMap.has(e)&&(pe(this.legacyTimersMap,e,i),t++)}),t}cleanupOrphans(e=[]){if(this.timerManager)return this.timerManager.cleanupOrphanedTimers(e);const t=new Set(e);let i=0;return Array.from(this.legacyTimersMap.keys()).forEach(e=>{t.has(e)||this.legacyTimersMap.has(e)&&(pe(this.legacyTimersMap,e,()=>this.progressBarManager?.stop(e)),i++)}),i}hasTimer(e){return this.timerManager?this.timerManager.hasTimer(e):this.legacyTimersMap.has(e)}}const Ee={nome:"Nome",cognome:"Cognome",codice_rad:"Codice RAD",data_ricovero:"Data Ricovero",reparto_appartenenza:"Reparto Appartenenza",reparto_provenienza:"Reparto Provenienza",diagnosi:"Diagnosi",user_id:"Utente"};function Me(e,t={}){const i="string"==typeof e?e:e?.message||"",r="object"==typeof e&&e&&"details"in e?e.details:"",n="object"==typeof e&&e&&"code"in e?e.code:void 0,{entity:o="record",operation:s}=t,a=()=>{const e=[/column\s+'([^']+)'/i,/"([^"]+)"\s+column/i,/Key\s*\(([^)]+)\)/i,/column\s+"([^"]+)"/i];for(const t of e){const e=t.exec(i)||(r?t.exec(r):null);if(e&&e[1])return e[1]}};if("23502"===n||/violates not-null constraint/i.test(i)||/null value in column/i.test(i)){const e=a();if("user_id"===e)return"Utente non autenticato. Effettua nuovamente l'accesso e riprova.";if(!e)return"Compila tutti i campi obbligatori.";const t=Ee[e]||function(e){return e?e.split("_").filter(Boolean).map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):""}(e);return`Il campo "${c=t,c?c.charAt(0).toUpperCase()+c.slice(1):c}" √® obbligatorio.`}var c;if("23505"===n||/duplicate key value violates unique constraint/i.test(i))return/codice_rad/i.test(i)?`Esiste gi√† un ${o} con lo stesso Codice RAD.`:"Alcuni valori devono essere unici: verifica i dati inseriti.";if("23503"===n||/violates foreign key constraint/i.test(i)){const e=a();return`Valore non valido per ${e&&Ee[e]?Ee[e]:"alcuni campi"}. Seleziona un'opzione corretta e riprova.`}if("23514"===n||/violates check constraint/i.test(i))return"Alcuni dati non rispettano i vincoli richiesti. Verifica i campi e riprova.";if("PGRST301"===n||/JWT|auth|unauth/i.test(i))return"Sessione scaduta o non valida. Effettua l'accesso e riprova.";return`Si √® verificato un errore durante il ${s||"salvataggio"} del ${o}. Verifica i campi e riprova.`}class Te{static DEBUG=!1;constructor(){this.notificationContainer=null,this.timers=new Map,this.initialized=!1,this.isRendering=!1,this.settings=W.getSettings(),this._lastRenderedNotificationIds=[],this._renderCount=0,this._lastRenderTime=0,this._averageRenderTime=0,this._unsubscribe=null,this._unsubscribeSettings=null,this.timerManager=null,this.progressBarManager=null,this.renderEngine=null,this.visibilityManager=null,this.timerAdapter=null}flush(){try{const e=W.getNotifications();this.renderNotifications(e)}catch{}}async init(){if(!this.initialized&&"undefined"!=typeof window)try{await this.#e(),function(){try{ne=o.getInstance({id:"notification-announcer"})}catch(e){if(!document.getElementById("notification-announcer")){const e=document.createElement("div");e.id="notification-announcer",e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.style.cssText="position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden;",document.body.appendChild(e)}}}(),this._unsubscribe=W.subscribe(this.#t),this._unsubscribeSettings=W.subscribe((e,t)=>{try{if(this.settings=t,this.notificationContainer){this.notificationContainer.updateSettings({position:this.settings.position,maxVisible:this.settings.maxVisible})}}catch{}}),this.initialized=!0,this.visibilityManager=new we({onHidden:()=>{try{this.renderEngine?.pauseAll(),this.#i()}catch{}},onVisible:()=>{try{this.renderEngine?.resumeAll(),this.#r()}catch{}}}),this.visibilityManager.attach()}catch(e){ce.handleServiceError(e,"init"),this.initialized=!0}}async#e(){if(this.notificationContainer)return;const{NotificationContainer:e}=await a(async()=>{const{NotificationContainer:e}=await import("./shared-CpQNZA6K.js").then(e=>e.t);return{NotificationContainer:e}},__vite__mapDeps([0,1,2,3,4]));this.notificationContainer=new e({position:this.settings.position,maxVisible:this.settings.maxVisible});const t=this.notificationContainer?.container||null;this.timerManager=new ve(e=>this.removeNotification(e)),this.progressBarManager=new fe(t),this.renderEngine=new ye({containerEl:t,timerManager:this.timerManager,progressBarManager:this.progressBarManager,settings:this.settings,onRemove:e=>this.removeNotification(e),timersMap:this.timers}),this.timerAdapter=new Se({timerManager:this.timerManager,progressBarManager:this.progressBarManager,legacyTimersMap:this.timers})}show(e,t,i={}){try{const r=de(e),n=String(t||"").trim();if(!n){return this.show(r,`Notifica ${r} - Messaggio non disponibile`,i)}const o=function(e,t){const i=e||{},r=(i.customDurations||{})[t];return(i.persistentTypes||[]).includes(t)?0:"number"==typeof r?r:"number"==typeof i.defaultDuration?i.defaultDuration:5e3}(this.settings,r),s=function(e,t,i){const r=t||{};return{duration:void 0!==r.duration?r.duration:i,closable:!1!==r.closable,position:r.position||e&&e.position,priority:r.priority||0,title:r.title,actions:r.actions,persistent:r.persistent,...r}}(this.settings,i,o);return W.addNotification(r,n,s)}catch(r){return ce.handleServiceError(r,"show",{type:e,message:t,options:i}),ce.recoverFromShowError({type:de(e),message:t,options:i,id:Date.now().toString()})}}success(e,t={}){return"number"==typeof t&&(t={duration:t}),this.show("success",e,t)}info(e,t={}){return"number"==typeof t&&(t={duration:t}),this.show("info",e,t)}warning(e,t={}){return"number"==typeof t&&(t={duration:t}),this.show("warning",e,t)}error(e,t={}){return"number"==typeof t&&(t={duration:t}),this.show("error",e,t)}renderNotifications(e=[]){Array.isArray(e)&&this.notificationContainer&&(this.renderEngine?.setContainer(this.notificationContainer.container),this.renderEngine?.updateSettings(this.settings),this.renderEngine?.render(e))}#n(e){const t=this.renderEngine?.createElement(e)||ue({notification:e,settings:this.settings,timers:this.timers,removeNotification:e=>this.removeNotification(e),startAutoCloseTimer:he,pauseAutoCloseTimer:me,resumeAutoCloseTimer:ge,announceNotification:oe,attachNotificationEvents:se,attachTouchEvents:ae,notificationContainer:this.notificationContainer,errorHandler:ce});if(!t)throw new Error("createNotificationElement returned null");this.notificationContainer.addNotification(t);try{this.renderEngine?.afterMount(e,t)}catch{}}#t=this.#o(e=>{Array.isArray(e)&&this.renderNotifications(e)},16);removeNotification(e){try{if(this.timerAdapter?.stop(e,()=>this.progressBarManager?.stop(e)),!this.notificationContainer)return W.removeNotification(e),void 0;const t=this.settings.enableAnimations&&!ce.shouldDisableAnimations();this.renderEngine?.removeAnimated(e,t,()=>this.#s(e))}catch(t){ce.handleServiceError(t,"remove",e),ce.recoverFromRemoveError(e)}}#s(e){this.#a(e)}#a(e){try{W.removeNotification(e)}catch{}}clear(){try{this.timerAdapter?.stopAll(e=>this.progressBarManager?.stop(e)),this.timers.clear(),this.notificationContainer?.clearAllNotifications&&this.notificationContainer.clearAllNotifications(),W.clearAllNotifications()}catch(e){ce.handleServiceError(e,"clear"),ce.recoverFromClearError()}}clearByType(e){W.getNotifications().forEach(t=>{t.type===e&&this.timerAdapter?.stop(t.id,()=>this.progressBarManager?.stop(t.id))}),W.clearNotificationsByType(e)}startAutoCloseTimer(e,t){try{this.timerAdapter?.start(e,t,e=>this.removeNotification(e))}catch{}}pauseAutoCloseTimer(e){try{this.timerAdapter?.pause(e)}catch{}}resumeAutoCloseTimer(e){try{this.timerAdapter?.resume(e)}catch{}}stopAutoCloseTimer(e){try{this.timerAdapter?.stop(e,()=>this.progressBarManager?.stop(e))}catch{}}handleAction(e,t){try{const i=W.getNotifications().find(t=>t.id===e),r=i?.options?.actions?.[t];r&&"function"==typeof r.onClick&&r.onClick({id:e,index:t,notification:i})}catch{}}setCustomDurations(e){this.updateSettings({customDurations:{...this.settings.customDurations||{},...e}})}setPersistentTypes(e){this.updateSettings({persistentTypes:[...e]})}setAutoCleanupInterval(e){this.updateSettings({autoCleanupInterval:e})}updatePosition(e){this.updateSettings({position:e})}setMaxVisible(e){this.updateSettings({maxVisible:e});const t=W.getNotifications();this.renderNotifications(t)}enableSounds(e=!0){this.updateSettings({enableSounds:!!e})}updateSettings(e){try{const t=this._validateSettings(e);if(W.updateSettings(t),this.settings=W.getSettings(),this.notificationContainer){const e={};"position"in t&&(e.position=this.settings.position),"maxVisible"in t&&(e.maxVisible=this.settings.maxVisible),Object.keys(e).length&&this.notificationContainer.updateSettings(e)}return this.renderEngine?.updateSettings(this.settings),!0}catch{return!1}}getStats(){try{return{...W.getStats(),settings:this.settings,activeTimers:this.timerManager?this.timerManager.timers.size:this.timers.size,containerInitialized:!!this.notificationContainer,serviceInitialized:this.initialized,performance:this.renderEngine?.getStats?.()||{renderCount:this._renderCount,averageRenderTime:this._averageRenderTime,lastRenderTime:this._lastRenderTime}}}catch(e){return{total:0,visible:0,byType:{success:0,error:0,warning:0,info:0},persistent:0,error:e?.message}}}exportSettings(){try{const e=W.exportSettings();return e.serviceMetadata={version:"2.0",exportedBy:"NotificationService"},e}catch(e){return null}}importSettings(e){try{if(!e||"object"!=typeof e||!e.settings)return!1;e.version&&"1.0"!==e.version&&w.warn(`Versione backup non supportata: ${e.version}`);const t=W.importSettings(e);return t&&(this.settings=W.getSettings()),t}catch(t){return!1}}cleanupOldNotifications(e=3e5){try{const t=W.clearOldNotifications(e),i=new Set(W.getNotifications().map(e=>e.id));return Array.from(this.timers.keys()).forEach(e=>{i.has(e)||this.timers.delete(e)}),t}catch{return 0}}_validateSettings(e){const t={},i=e=>"number"==typeof e&&!Number.isNaN(e),r=e=>"boolean"==typeof e;if(void 0!==e.maxVisible){if(!Number.isInteger(e.maxVisible)||e.maxVisible<1||e.maxVisible>20)throw new Error("maxVisible must be between 1 and 20");t.maxVisible=e.maxVisible}if(void 0!==e.defaultDuration){if(!i(e.defaultDuration)||e.defaultDuration<0)throw new Error("defaultDuration must be >= 0");t.defaultDuration=e.defaultDuration}if(void 0!==e.position){if(!["top-right","top-left","bottom-right","bottom-left","top-center","bottom-center"].includes(e.position))throw new Error("invalid position");t.position=e.position}if(void 0!==e.enableSounds){if(!r(e.enableSounds))throw new Error("enableSounds must be boolean");t.enableSounds=e.enableSounds}if(void 0!==e.enableAnimations){if(!r(e.enableAnimations))throw new Error("enableAnimations must be boolean");t.enableAnimations=e.enableAnimations}if(void 0!==e.autoCleanupInterval){if(!i(e.autoCleanupInterval)||e.autoCleanupInterval<6e4)throw new Error("autoCleanupInterval must be >= 60000");t.autoCleanupInterval=e.autoCleanupInterval}if(void 0!==e.maxStoredNotifications){if(!Number.isInteger(e.maxStoredNotifications)||e.maxStoredNotifications<10)throw new Error("maxStoredNotifications must be >= 10");t.maxStoredNotifications=e.maxStoredNotifications}if(void 0!==e.persistentTypes){if(!Array.isArray(e.persistentTypes))throw new Error("persistentTypes must be array");t.persistentTypes=[...e.persistentTypes]}if(void 0!==e.soundVolume){if(!i(e.soundVolume)||e.soundVolume<0||e.soundVolume>1)throw new Error("soundVolume must be between 0 and 1");t.soundVolume=e.soundVolume}if(void 0!==e.customDurations){const r=["success","error","warning","info"],n=e.customDurations;if(!n||"object"!=typeof n)throw new Error("customDurations must be object");for(const e of Object.keys(n))if(!r.includes(e)||!i(n[e])||n[e]<0)throw new Error("invalid customDurations entry");t.customDurations={...n}}return t}getNotificationsByType(e){try{return W.getNotificationsByType(e)}catch{return[]}}getVisibleNotifications(){try{return W.getVisibleNotifications()}catch{return[]}}hasErrors(){try{return W.hasErrorNotifications()}catch{return!1}}destroy(){try{try{this.timerAdapter?.stopAll()}catch{}try{this.progressBarManager?.cleanup()}catch{}try{this.timers.forEach((e,t)=>pe(this.timers,t))}catch{}try{this.timers.clear()}catch{}this.notificationContainer?.clearAllNotifications&&this.notificationContainer.clearAllNotifications();try{this.visibilityManager?.detach()}catch{}if("function"==typeof this._unsubscribe){try{this._unsubscribe()}catch{}this._unsubscribe=null}if("function"==typeof this._unsubscribeSettings){try{this._unsubscribeSettings()}catch{}this._unsubscribeSettings=null}try{this.timerManager?.destroy()}catch{}try{this.progressBarManager?.destroy()}catch{}this.renderEngine=null}finally{this.notificationContainer=null,this.initialized=!1}}#c(e){try{this.progressBarManager?.stop(e)}catch{}}#l(e){try{this.progressBarManager?.pause(e)}catch{}}#u(e){try{this.progressBarManager?.resume(e)}catch{}}#i(){try{this.timerAdapter?.pauseAll(),this.progressBarManager?.pauseAll()}catch{}}#r(){try{this.timerAdapter?.resumeAll(),this.progressBarManager?.resumeAll()}catch{}}#o(e,t){let i=!1;return(...r)=>{i||(e.apply(this,r),i=!0,setTimeout(()=>i=!1,t))}}}const _e=new Te,Ae=Object.freeze(Object.defineProperty({__proto__:null,notificationService:_e},Symbol.toStringTag,{value:"Module"}));export{a as _,m as a,X as b,K as c,Z as d,N as e,D as f,B as g,L as h,k as i,p as j,f as k,w as l,Me as m,Q as n,O as o,$ as p,y as q,E as r,_ as s,b as t,g as u,F as v,P as w,M as x,R as y};
