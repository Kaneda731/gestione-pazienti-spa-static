import{r as e,j as a,R as t,a as i,u as n,b as s,k as o}from"./charts-feature-DjbKlvyw.js";import{e as r,C as l,B as c,i as d,a as m,u,f as p,g as h,P as g,j as v,k as f,m as x,n as b,V as _,o as y,h as z,l as j,b as w}from"./shared-BGQg7biK.js";import{r as N,u as D}from"./react-vendor-DSd4Y30N.js";import{_ as S,s as C,l as E,n as I,u as P,b as $,a as T,m as k,c as R}from"./core-services-BI3G_WoH.js";import{I as A,a as L,c as O,e as F,p as M,g as V,r as B}from"./events-feature-BaxCeh3a.js";import{M as q}from"./ui-vendor-CzXQDyZB.js";const W=[{value:"dimissione",label:"Dimissione"},{value:"trasferimento_interno",label:"Trasferimento interno"},{value:"trasferimento_esterno",label:"Trasferimento esterno"},{value:"decesso",label:"Decesso"}],K=[{value:"0",label:"0 - Ordinaria"},{value:"6",label:"6 - Protetta"}],G=[{value:"",label:"Seleziona..."},{value:"56",label:"56 - Riabilitazione Motoria"},{value:"60",label:"60 - Lunga Degenza"}],U=[{value:"",label:"Seleziona..."},{value:"Cardiologia",label:"Cardiologia"},{value:"CR1",label:"CR1"},{value:"CR3",label:"CR3"},{value:"Gastroenterologia",label:"Gastroenterologia"},{value:"Ginecologia",label:"Ginecologia"},{value:"Medicina Interna",label:"Medicina Interna"},{value:"Neurologia",label:"Neurologia"},{value:"Pediatria",label:"Pediatria"},{value:"Pneumologia",label:"Pneumologia"},{value:"UGI",label:"UGI"},{value:"Urologia",label:"Urologia"}],J={data_dimissione:"",tipo_dimissione:"dimissione",codice_dimissione:"0"},H=({patientName:t,onDischargeSubmit:i})=>{const[n,s]=e.useState(!1),[o,d]=e.useState(J),[m,u]=e.useState(!1),p=e=>a=>{d("tipo_dimissione"===e?t=>{const i={...t,[e]:a};return"dimissione"===a?i.codice_dimissione="0":"trasferimento_esterno"===a?i.codice_dimissione="3":"trasferimento_interno"!==a&&"decesso"!==a||(i.codice_dimissione=null),i}:t=>({...t,[e]:a}))};return a.jsxs("div",{className:"discharge-section card mt-4",children:[a.jsx("div",{className:"card-header bg-light",children:a.jsxs("button",{type:"button",onClick:()=>s(!n),className:"btn btn-link w-100 text-start p-0 d-flex justify-content-between align-items-center",style:{textDecoration:"none",color:"inherit"},children:[a.jsxs("div",{className:"d-flex align-items-center gap-2",children:[a.jsx("span",{className:"material-icons",style:{fontSize:"1.5rem"},children:n?"expand_less":"expand_more"}),a.jsx("strong",{children:"Dimissione / Trasferimento"}),a.jsx("span",{className:"badge bg-info",style:{fontSize:"0.75rem"},children:"Opzionale"})]}),n&&a.jsxs("span",{style:{fontSize:"0.875rem",color:"#6c757d"},children:["Paziente: ",t]})]})}),n&&a.jsxs("div",{className:"card-body",children:[a.jsxs("div",{className:"alert alert-info mb-3",children:[a.jsx("strong",{children:"Nota:"})," Registra i dati di dimissione o trasferimento del paziente. Questa sezione è facoltativa e può essere completata anche in un secondo momento."]}),a.jsxs("form",{id:"discharge-section",onSubmit:async e=>{if(e.preventDefault(),!m&&i){u(!0);try{await i(o),d(J),s(!1)}finally{u(!1)}}},className:"d-flex flex-column gap-3",children:[a.jsx(r,{label:"Data dimissione",value:o.data_dimissione,onChange:e=>{d(a=>({...a,data_dimissione:e||""}))},isRequired:n,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0}),a.jsxs("div",{className:"form-group",children:[a.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-type",children:["Tipo dimissione ",a.jsx("span",{className:"text-danger",children:"*"})]}),a.jsx(l,{id:"discharge-dismissal-type",value:o.tipo_dimissione,options:W.map(e=>({value:e.value,label:e.label})),onChange:p("tipo_dimissione"),placeholder:"Seleziona..."})]}),"dimissione"===o.tipo_dimissione&&a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",htmlFor:"discharge-dismissal-code",children:"Codice dimissione"}),a.jsx(l,{id:"discharge-dismissal-code",value:o.codice_dimissione??"",options:K.map(e=>({value:e.value,label:e.label})),onChange:p("codice_dimissione"),placeholder:"Seleziona..."})]}),"trasferimento_interno"===o.tipo_dimissione&&a.jsxs("div",{className:"form-group",children:[a.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-dept",children:["Reparto destinazione ",a.jsx("span",{className:"text-danger",children:"*"})]}),a.jsx(l,{id:"discharge-dismissal-dept",value:o.reparto_destinazione??"",options:U.map(e=>({value:e.value,label:e.label})),onChange:p("reparto_destinazione"),placeholder:"Seleziona..."})]}),"trasferimento_esterno"===o.tipo_dimissione&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"form-group",children:[a.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-clinic",children:["Clinica destinazione ",a.jsx("span",{className:"text-danger",children:"*"})]}),a.jsx("input",{id:"discharge-dismissal-clinic",name:"clinica_destinazione",className:"form-control",value:o.clinica_destinazione??"",onChange:e=>{const{name:a,value:t}=e.target;d(e=>({...e,[a]:t}))},required:n&&"trasferimento_esterno"===o.tipo_dimissione})]}),a.jsxs("div",{className:"form-group",children:[a.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-clinic-code",children:["Codice clinica ",a.jsx("span",{className:"text-danger",children:"*"})]}),a.jsx(l,{id:"discharge-dismissal-clinic-code",value:o.codice_clinica??"",options:G.map(e=>({value:e.value,label:e.label})),onChange:p("codice_clinica"),placeholder:"Seleziona..."})]})]}),a.jsxs("div",{className:"d-flex gap-2 pt-2",children:[a.jsx(c,{type:"submit",disabled:m,children:m?"Registrazione in corso...":"Registra dimissione"}),a.jsx(c,{type:"button",variant:"secondary",onClick:()=>{d(J),s(!1)},children:"Annulla"})]})]})]})]})},Q=["AR","PO","CO","CR","PS"],Y=["Bassa","Media","Alta"],Z=({values:e,onChange:t})=>a.jsxs("div",{className:"row",children:[a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",htmlFor:"patient-name",children:"Nome"}),a.jsx("input",{id:"patient-name",name:"nome",className:"form-control",value:e.nome,onChange:t,required:!0})]}),a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",htmlFor:"patient-surname",children:"Cognome"}),a.jsx("input",{id:"patient-surname",name:"cognome",className:"form-control",value:e.cognome,onChange:t,required:!0})]})]}),X=({values:e,onChange:t})=>{const i=e=>a=>{t({target:{name:e,value:a||""}})};return a.jsxs("div",{className:"row",children:[a.jsx("div",{className:"col-md-6",children:a.jsx(r,{id:"patient-birth-date",value:e.data_nascita,onChange:i("data_nascita"),label:"Data nascita",placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})}),a.jsx("div",{className:"col-md-6",children:a.jsx(r,{id:"patient-admission-date",value:e.data_ricovero,onChange:i("data_ricovero"),label:"Data ricovero",placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})})]})},ee=({values:t,onChange:i,diagnosiOptions:n,repartoOptions:s,loadingDiagnosi:o,loadingReparti:r})=>{const c=e=>a=>{i({target:{name:e,value:a}})},d=e.useMemo(()=>[{value:"",label:"Seleziona diagnosi..."},...n.map(e=>({value:e.nome,label:e.nome}))],[n]),m=e.useMemo(()=>0===n.length?"empty":n.map(e=>e.id).sort().join("-"),[n]),u=e.useMemo(()=>[{value:"",label:"Seleziona..."},...s.map(e=>({value:e,label:e}))],[s]);return a.jsxs("div",{className:"row",children:[a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",htmlFor:"patient-diagnosis",children:"Diagnosi"}),a.jsx(l,{id:"patient-diagnosis",value:t.diagnosi,options:d,onChange:c("diagnosi"),disabled:o,placeholder:"Seleziona diagnosi..."},`diagnosis-${m}`),o&&a.jsx("small",{className:"form-text text-muted",children:"Caricamento diagnosi in corso..."})]}),a.jsxs("div",{className:"col-md-6",children:[a.jsx("label",{className:"form-label",htmlFor:"patient-ward",children:"Reparto Appartenenza"}),a.jsx(l,{id:"patient-ward",value:t.reparto_appartenenza,options:u,onChange:c("reparto_appartenenza"),disabled:r,placeholder:"Seleziona..."},`ward-${s.length}`),r&&a.jsx("small",{className:"form-text text-muted",children:"Caricamento reparti in corso..."})]})]})},ae=({values:t,onChange:i})=>{const n=e=>a=>{i({target:{name:e,value:a}})},s=e.useMemo(()=>[{value:"",label:"Seleziona..."},...Q.map(e=>({value:e,label:e}))],[]),o=e.useMemo(()=>[{value:"",label:"Seleziona..."},...Y.map(e=>({value:e,label:e}))],[]);return a.jsxs("div",{className:"row",children:[a.jsxs("div",{className:"col-md-4",children:[a.jsx("label",{className:"form-label",htmlFor:"patient-codice-rad",children:"Codice RAD"}),a.jsx("input",{id:"patient-codice-rad",name:"codice_rad",className:"form-control",value:t.codice_rad,onChange:i})]}),a.jsxs("div",{className:"col-md-4",children:[a.jsx("label",{className:"form-label",htmlFor:"patient-reparto-provenienza",children:"Reparto Provenienza"}),a.jsx(l,{id:"patient-reparto-provenienza",value:t.reparto_provenienza,options:s,onChange:n("reparto_provenienza"),placeholder:"Seleziona..."},"reparto-provenienza")]}),a.jsxs("div",{className:"col-md-4",children:[a.jsx("label",{className:"form-label",htmlFor:"patient-livello-assistenza",children:"Livello Assistenza"}),a.jsx(l,{id:"patient-livello-assistenza",value:t.livello_assistenza,options:o,onChange:n("livello_assistenza"),placeholder:"Seleziona..."},"livello-assistenza")]})]})},te=({values:e,onCheckboxChange:t,onEditInfection:i,onEditSurgery:n,infectionBadge:s,surgeryBadge:o,renderBadge:r})=>a.jsxs("div",{className:"row mt-3",children:[a.jsxs("div",{className:"col-md-6",children:[a.jsxs("div",{className:"form-check form-switch",children:[a.jsx("input",{className:"form-check-input",type:"checkbox",id:"patient-infetto",name:"infetto",checked:e.infetto,onChange:t}),a.jsxs("label",{className:"form-check-label",htmlFor:"patient-infetto",children:["Paziente Infetto",r(s)]})]}),a.jsxs("button",{type:"button",className:"btn btn-link px-0",onClick:()=>{void i()},children:[a.jsx("span",{className:"material-icons align-middle me-1",children:"edit"}),"Modifica dati infezione"]})]}),a.jsxs("div",{className:"col-md-6",children:[a.jsxs("div",{className:"form-check form-switch",children:[a.jsx("input",{className:"form-check-input",type:"checkbox",id:"patient-ha-intervento",name:"ha_intervento",checked:e.ha_intervento,onChange:t}),a.jsxs("label",{className:"form-check-label",htmlFor:"patient-ha-intervento",children:["Intervento Chirurgico",r(o)]})]}),a.jsxs("button",{type:"button",className:"btn btn-link px-0",onClick:()=>{void n()},children:[a.jsx("span",{className:"material-icons align-middle me-1",children:"edit"}),"Modifica dati intervento"]})]})]}),ie=({values:e,onChange:t})=>a.jsxs("div",{children:[a.jsx("label",{className:"form-label",htmlFor:"patient-notes",children:"Note"}),a.jsx("textarea",{id:"patient-notes",name:"note",className:"form-control",value:e.note,onChange:t,rows:3})]}),ne=({submitting:e,submitLabel:t,onCancel:i})=>a.jsxs("div",{className:"d-flex gap-2",children:[a.jsx(c,{type:"submit",disabled:e,children:t}),a.jsx(c,{type:"button",variant:"secondary",onClick:i,children:"Annulla"})]}),se=({patientId:t,patientName:i="Paziente",event:n,onSubmit:s,onClose:o})=>{const[r,l]=e.useState(!1),c=e.useRef(`infection-event-modal-${Date.now()}`).current,d=e.useRef(null),m=e.useRef(null),u=e.useRef(null),p=e.useRef(null);e.useEffect(()=>{const e=d.current;if(!e)return;p.current=document.activeElement;let a=requestAnimationFrame(()=>{if(d.current)try{const a=new q(e);m.current=a;const t=()=>{u.current=null;const e=p.current;p.current=null,e&&document.contains(e)&&queueMicrotask(()=>e.focus()),o()};u.current=t,e.addEventListener("hidden.bs.modal",t),a.show()}catch(a){console.error("Error initializing modal:",a)}});return()=>{null!==a&&(cancelAnimationFrame(a),a=null);const t=m.current;if(m.current=null,e&&u.current&&(e.removeEventListener("hidden.bs.modal",u.current),u.current=null),t)try{t.dispose()}catch(i){console.error("Error disposing modal:",i)}}},[o]);const h=e.useCallback(()=>{const e=m.current;if(e){const a=d.current,t=document.activeElement;t&&a?.contains(t)&&t.blur(),e.hide()}else o()},[o]);return a.jsx("div",{className:"modal fade",id:c,ref:d,tabIndex:-1,"aria-labelledby":`${c}-label`,"aria-hidden":"true",children:a.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:a.jsxs("div",{className:"modal-content",children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("div",{children:[a.jsx("h5",{className:"modal-title mb-1",id:`${c}-label`,children:n?"Modifica Evento":"Registra Infezione"}),a.jsxs("p",{className:"text-muted mb-0 small",children:[a.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"person"}),i]})]}),a.jsx("button",{type:"button",className:"btn-close","aria-label":"Chiudi","data-bs-dismiss":"modal"})]}),a.jsx("div",{className:"modal-body",children:a.jsx(A,{event:n,patientId:t,onSubmit:async e=>{l(!0);try{await s(e),h()}finally{l(!1)}},onCancel:h,isSubmitting:r})})]})})})};let oe=null,re=null;async function le(){if(!oe){const e=await S(()=>Promise.resolve().then(()=>et),void 0);oe=e.default}return oe}async function ce(){if(!re){const e=await S(()=>Promise.resolve().then(()=>tt),void 0);re=e.default}return re}async function de(){const[e,a]=await Promise.all([le(),ce()]);return{infection:e,surgery:a}}const me={hasData:!1,isValid:!1,tooltip:""};const ue=({patientId:t,patientName:i="Paziente",event:n,onSubmit:s,onClose:o})=>{const[r,l]=e.useState(!1),c=e.useRef(`intervention-event-modal-${Date.now()}`).current,d=e.useRef(null),m=e.useRef(null),u=e.useRef(null);e.useEffect(()=>{const e=d.current;if(!e)return;let a=requestAnimationFrame(()=>{if(d.current)try{const a=new q(e);m.current=a;const t=()=>{u.current=null,o()};u.current=t,e.addEventListener("hidden.bs.modal",t),a.show()}catch(a){console.error("Error initializing modal:",a)}});return()=>{null!==a&&(cancelAnimationFrame(a),a=null);const t=m.current;if(m.current=null,e&&u.current&&(e.removeEventListener("hidden.bs.modal",u.current),u.current=null),t)try{t.dispose()}catch(i){console.error("Error disposing modal:",i)}}},[o]);const p=e.useCallback(()=>{const e=m.current;e?e.hide():o()},[o]);return a.jsx("div",{className:"modal fade",id:c,ref:d,tabIndex:-1,"aria-labelledby":`${c}-label`,"aria-hidden":"true",children:a.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:a.jsxs("div",{className:"modal-content",children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("div",{children:[a.jsx("h5",{className:"modal-title mb-1",id:`${c}-label`,children:n?"Modifica Evento":"Registra Intervento"}),a.jsxs("p",{className:"text-muted mb-0 small",children:[a.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"person"}),i]})]}),a.jsx("button",{type:"button",className:"btn-close","aria-label":"Chiudi","data-bs-dismiss":"modal"})]}),a.jsx("div",{className:"modal-body",children:a.jsx(L,{event:n,patientId:t,onSubmit:async e=>{l(!0);try{await s(e),p()}finally{l(!1)}},onCancel:p,isSubmitting:r})})]})})})},pe={hasData:!1,isValid:!1,tooltip:""};function he({values:t,setValues:i,patientDisplayName:n,patientId:s=""}){const o=function({setValues:t,patientDisplayName:i,patientId:n=""}){const[s,o]=e.useState(me),[r,l]=e.useState(!1),c=e.useCallback(async()=>{const e=await le();if(!e.hasInfectionData())return me;const a=e.getInfectionData(),t=[];return a?.data_evento&&t.push(`Data: ${a.data_evento}`),a?.agente_patogeno&&t.push(`Agente: ${a.agente_patogeno}`),a?.descrizione&&t.push(`Note: ${a.descrizione}`),{hasData:!0,isValid:0===(e.getValidationErrors?.()?.length??0),tooltip:t.join("\n")}},[]),d=e.useCallback(async()=>{const e=await c();o(e)},[c]),m=e.useCallback(async e=>{const a=await le();a.setInfectionData({data_evento:e.data_evento,agente_patogeno_id:e.agente_patogeno_id,tipo_patogeno:e.tipo_patogeno,data_fine_evento:e.data_fine_evento,note:e.note}),l(!1);const i=a.hasInfectionData();t(e=>({...e,infetto:i})),await d()},[t,d]),u=e.useCallback(async e=>{e?l(!0):((await le()).clearInfectionData(),t(e=>({...e,infetto:!1})),await d())},[t,d]),p=e.useCallback(async e=>{const{name:a,checked:t}=e.target;"infetto"===a&&await u(t)},[u]),h=e.useCallback(()=>{l(!0)},[]);return{badge:s,renderBadge:e.useCallback(e=>e.hasData?a.jsx("span",{className:"badge ms-2 "+(e.isValid?"bg-success":"bg-warning text-dark"),title:e.tooltip,children:e.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),handleCheckboxChange:p,handleEditInfection:h,modalsPortal:N.createPortal(a.jsx(a.Fragment,{children:r&&a.jsx(se,{patientId:n,patientName:i||"Nuovo Paziente",onSubmit:m,onClose:()=>l(!1)})}),document.body),refreshSummary:d}}({values:t,setValues:i,patientDisplayName:n,patientId:s}),r=function({setValues:t,patientDisplayName:i,patientId:n=""}){const[s,o]=e.useState(pe),[r,l]=e.useState(!1),c=e.useCallback(async()=>{const e=await ce();if(!e.hasSurgeryData())return pe;const a=e.getValidationErrors?.()?.length??0,t=e.getDataSummary?.(),i=[];return t?.dataIntervento&&i.push(`Intervento: ${t.dataIntervento}`),t?.tipoIntervento&&i.push(`Tipo: ${t.tipoIntervento}`),t?.hasInfection&&i.push("Infezione associata"),{hasData:!0,isValid:0===a,tooltip:i.join("\n")}},[]),d=e.useCallback(async()=>{const e=await c();o(e)},[c]),m=e.useCallback(async e=>{const a=await ce();a.setSurgeryData({data_evento:e.data_evento,tipo_intervento_id:e.tipo_intervento_id,descrizione:e.descrizione_intervento}),l(!1);const i=a.hasSurgeryData();t(e=>({...e,ha_intervento:i})),await d()},[t,d]),u=e.useCallback(async e=>{e?l(!0):((await ce()).clearSurgeryData(),t(e=>({...e,ha_intervento:!1})),await d())},[t,d]),p=e.useCallback(async e=>{const{name:a,checked:t}=e.target;"ha_intervento"===a&&await u(t)},[u]),h=e.useCallback(()=>{l(!0)},[]);return{badge:s,renderBadge:e.useCallback(e=>e.hasData?a.jsx("span",{className:"badge ms-2 "+(e.isValid?"bg-success":"bg-warning text-dark"),title:e.tooltip,children:e.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),handleCheckboxChange:p,handleEditSurgery:h,modalsPortal:N.createPortal(a.jsx(a.Fragment,{children:r&&a.jsx(ue,{patientId:n,patientName:i||"Nuovo Paziente",onSubmit:m,onClose:()=>l(!1)})}),document.body),refreshSummary:d}}({values:t,setValues:i,patientDisplayName:n,patientId:s});e.useEffect(()=>{(async()=>{await o.refreshSummary(),await r.refreshSummary()})()},[o,r]),e.useEffect(()=>()=>{de().then(({infection:e,surgery:a})=>{e.clearInfectionData(),a.clearSurgeryData()})},[]);const l=e.useCallback(async e=>{const{name:a}=e.target;return"infetto"===a?(await o.handleCheckboxChange(e),void 0):"ha_intervento"===a?(await r.handleCheckboxChange(e),void 0):(i(t=>({...t,[a]:e.target.checked})),void 0)},[o,r,i]),c=e.useMemo(()=>e=>e.hasData?a.jsx("span",{className:"badge ms-2 "+(e.isValid?"bg-success":"bg-warning text-dark"),title:e.tooltip,children:e.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),d=e.useMemo(()=>a.jsxs(a.Fragment,{children:[o.modalsPortal,r.modalsPortal]}),[o.modalsPortal,r.modalsPortal]);return{infectionBadge:o.badge,surgeryBadge:r.badge,renderBadge:c,handleCheckboxChange:l,handleEditInfection:o.handleEditInfection,handleEditSurgery:r.handleEditSurgery,modalsPortal:d}}const ge=e=>{if(null==e||""===e)return"";if(e instanceof Date)return e.toISOString().split("T")[0];const a=String(e);if(a.match(/^\d{4}-\d{2}-\d{2}$/))return a;try{const e=O(a);if(e)return e}catch(t){const e=new Date(a);if(!Number.isNaN(e.getTime()))return e.toISOString().split("T")[0]}return a},ve=["data_nascita","data_ricovero","data_dimissione"];function fe({initialPatient:a}){const[t,i]=e.useState(()=>({nome:"",cognome:"",data_nascita:"",data_ricovero:"",data_dimissione:"",diagnosi:"",reparto_appartenenza:"",reparto_provenienza:"",livello_assistenza:"",codice_rad:"",note:"",tipo_dimissione:"",codice_dimissione:"",reparto_destinazione:"",clinica_destinazione:"",codice_clinica:"",infetto:!1,ha_intervento:!1}));e.useEffect(()=>{if(!a)return i({nome:"",cognome:"",data_nascita:"",data_ricovero:"",data_dimissione:"",diagnosi:"",reparto_appartenenza:"",reparto_provenienza:"",livello_assistenza:"",codice_rad:"",note:"",tipo_dimissione:"",codice_dimissione:"",reparto_destinazione:"",clinica_destinazione:"",codice_clinica:"",infetto:!1,ha_intervento:!1}),void 0;const e={id:a.id??null,nome:a.nome??"",cognome:a.cognome??"",data_nascita:ge(a.data_nascita??""),data_ricovero:ge(a.data_ricovero??""),data_dimissione:ge(a.data_dimissione??""),diagnosi:a.diagnosi??"",reparto_appartenenza:a.reparto_appartenenza??"",reparto_provenienza:a.reparto_provenienza??"",livello_assistenza:a.livello_assistenza??"",codice_rad:a.codice_rad??"",note:a.note??"",tipo_dimissione:a.tipo_dimissione??"",codice_dimissione:a.codice_dimissione??"",reparto_destinazione:a.reparto_destinazione??"",clinica_destinazione:a.clinica_destinazione??"",codice_clinica:a.codice_clinica??"",infetto:a.infetto??!1,ha_intervento:!1};i(e)},[a]);const n=e.useCallback(e=>{const{name:a,value:t,type:n}=e.target,s="checkbox"===n?e.target.checked:t;i(e=>{if("string"==typeof s&&ve.includes(a)){const t=ge(s);return{...e,[a]:t}}return{...e,[a]:s}})},[]);return{values:t,setValues:i,handleChange:n}}async function xe(){try{const e=await d("pazienti","tipo_dimissione"),a=["dimissione","trasferimento_interno","trasferimento_esterno","decesso"],t=e.map(e=>null==e?null:String(e)).filter(e=>!!e&&a.includes(e));return Array.from(new Set(t))}catch(e){throw E.error("Error loading transfer values:",e),new Error("Impossibile caricare le opzioni di trasferimento.")}}async function be(){try{const[e,a]=await Promise.all([C.from("pazienti").select("id",{count:"exact",head:!0}).is("data_dimissione",null),C.from("pazienti").select("id",{count:"exact",head:!0}).not("data_dimissione","is",null)]);if(e.error)throw e.error;if(a.error)throw a.error;return{hasActive:(e.count??0)>0,hasDimesso:(a.count??0)>0}}catch(e){throw E.error("Error loading patient status availability:",e),new Error("Impossibile caricare le opzioni di stato.")}}function _e(){const[a,t]=e.useState([]),[i,n]=e.useState([]),[s,o]=e.useState(!1),[r,l]=e.useState(!1);return e.useEffect(()=>{void(async()=>{o(!0);try{const{data:e,error:a}=await C.from("diagnosi").select("id, nome").order("nome",{ascending:!0});if(a)E.error("Errore nel caricamento delle diagnosi",{error:a}),I("Impossibile caricare le diagnosi disponibili",{duration:5e3});else{const a=(e||[]).map(e=>({id:String(e.id),nome:e.nome}));t(a)}}catch(e){E.error("Errore imprevisto nel caricamento delle diagnosi",{error:e}),I("Errore nel caricamento delle diagnosi",{duration:5e3})}finally{o(!1)}})()},[]),e.useEffect(()=>{void(async()=>{l(!0);try{const e=await m();n(e)}catch(e){E.error("Errore nel caricamento dei reparti",{error:e}),I("Impossibile caricare i reparti disponibili",{duration:5e3})}finally{l(!1)}})()},[]),{diagnosiOptions:a,repartoOptions:i,loadingDiagnosi:s,loadingReparti:r}}function ye({values:e,surgeryDataManager:a,infectionDataManager:t,isPatientCurrentlyInfected:i}){const n={nome:e.nome?.trim()||"",cognome:e.cognome?.trim()||"",data_nascita:e.data_nascita||"",data_ricovero:e.data_ricovero||"",data_dimissione:e.data_dimissione||"",diagnosi:e.diagnosi?.trim()||"",reparto_appartenenza:e.reparto_appartenenza?.trim()||"",reparto_provenienza:e.reparto_provenienza?.trim()||"",livello_assistenza:e.livello_assistenza?.trim()||"",codice_rad:e.codice_rad?.trim()||"",tipo_dimissione:e.tipo_dimissione||null,codice_dimissione:e.codice_dimissione?.trim()||"",reparto_destinazione:e.reparto_destinazione?.trim()||"",clinica_destinazione:e.clinica_destinazione?.trim()||"",codice_clinica:e.codice_clinica?.trim()||null,note:e.note?.trim()||"",infetto:e.infetto||!1,_hasInfectionData:!1,_hasSurgeryData:!1};if(t.hasInfectionData()){const e=t.getInfectionData();e&&(n._hasInfectionData=!0,n._infectionData=e)}if(a.hasSurgeryData()){const e=a.getSurgeryData();e&&(n._hasSurgeryData=!0,n._surgeryData=e)}return i&&i()&&(n.infetto=!0),n}const ze=({patient:t,mode:i,onSubmit:n,onCancel:s,onValidate:o})=>{const{values:r,setValues:l,handleChange:c}=fe({initialPatient:t}),[d,m]=e.useState(!1),u=e.useRef(null),p=e.useMemo(()=>[r.nome?.trim(),r.cognome?.trim()].filter(Boolean).join(" ").trim(),[r.nome,r.cognome]),{diagnosiOptions:h,repartoOptions:g,loadingDiagnosi:v,loadingReparti:f}=_e(),{infectionBadge:x,surgeryBadge:b,renderBadge:_,handleCheckboxChange:y,handleEditInfection:z,handleEditSurgery:j,modalsPortal:w}=he({values:r,setValues:l,patientDisplayName:p,patientId:t?.id??""}),N=e.useCallback(async e=>{if(e.preventDefault(),!d){m(!0);try{const{infection:e,surgery:a}=await de(),t=ye({values:r,infectionDataManager:e,surgeryDataManager:a});if(o){if(!o(t).valid)return m(!1),void 0}await n(t)}finally{m(!1)}}},[n,o,d,r]),D="create"===i?"Salva paziente":"Aggiorna paziente";return a.jsxs(a.Fragment,{children:[a.jsxs("form",{id:"patient-form",ref:u,onSubmit:N,className:"d-flex flex-column gap-3",noValidate:!0,children:[a.jsx(Z,{values:r,onChange:c}),a.jsx(X,{values:r,onChange:c}),a.jsx(ee,{values:r,onChange:c,diagnosiOptions:h,repartoOptions:g,loadingDiagnosi:v,loadingReparti:f}),a.jsx(ae,{values:r,onChange:c}),a.jsx(te,{values:r,onCheckboxChange:y,onEditInfection:z,onEditSurgery:j,infectionBadge:x,surgeryBadge:b,renderBadge:_}),a.jsx(ie,{values:r,onChange:c}),a.jsx(ne,{submitting:d,submitLabel:D,onCancel:s})]}),w]})},je=["personal-info","admission-dates","diagnosis","provenance","clinical-flags","notes","review"],we={"personal-info":"Dati Personali","admission-dates":"Date Ricovero",diagnosis:"Diagnosi",provenance:"Provenienza","clinical-flags":"Dati Clinici",notes:"Note",review:"Riepilogo"},Ne=["personal-info","admission-dates","diagnosis","provenance","clinical-flags","notes","review"],De=({currentStep:e,totalSteps:t,getStepLabel:i,getStepNumber:n})=>{const s=Ne.indexOf(e),o=n(e);return a.jsxs("div",{className:"wizard-stepper",children:[a.jsx("div",{className:"wizard-stepper-progress",children:a.jsx("div",{className:"wizard-stepper-progress-bar",children:a.jsx("div",{className:"wizard-stepper-progress-fill",style:{width:o/t*100+"%"},role:"progressbar","aria-valuenow":o,"aria-valuemin":1,"aria-valuemax":t,"aria-label":`Progresso: ${o} di ${t}`})})}),a.jsxs("div",{className:"wizard-stepper-info",children:[a.jsx("span",{className:"wizard-stepper-label",children:i(e)}),a.jsxs("span",{className:"wizard-stepper-counter",children:[o," di ",t]})]}),a.jsx("div",{className:"wizard-stepper-dots d-md-none",children:Ne.map((t,n)=>a.jsx("div",{className:`wizard-stepper-dot ${t===e?"active":""} ${n<s?"completed":""}`,"aria-label":`Step ${n+1}: ${i(t)}`},t))})]})},Se=({values:e,onChange:t})=>a.jsx("div",{className:"wizard-step",children:a.jsxs("div",{className:"wizard-step-content",children:[a.jsx("h3",{className:"wizard-step-title",children:"Dati Personali"}),a.jsx("p",{className:"wizard-step-description",children:"Inserisci i dati anagrafici del paziente"}),a.jsx(Z,{values:e,onChange:t})]})}),Ce=({values:e,onChange:t})=>a.jsx("div",{className:"wizard-step",children:a.jsxs("div",{className:"wizard-step-content",children:[a.jsx("h3",{className:"wizard-step-title",children:"Date Importanti"}),a.jsx("p",{className:"wizard-step-description",children:"Inserisci la data di nascita e ricovero"}),a.jsx(X,{values:e,onChange:t})]})}),Ee=({values:e,onChange:t,diagnosiOptions:i,repartoOptions:n,loadingDiagnosi:s,loadingReparti:o})=>a.jsx("div",{className:"wizard-step",children:a.jsxs("div",{className:"wizard-step-content",children:[a.jsx("h3",{className:"wizard-step-title",children:"Diagnosi"}),a.jsx("p",{className:"wizard-step-description",children:"Seleziona la diagnosi e il reparto"}),a.jsx(ee,{values:e,onChange:t,diagnosiOptions:i||[],repartoOptions:n||[],loadingDiagnosi:s??!1,loadingReparti:o??!1})]})}),Ie=({values:e,onChange:t})=>a.jsx("div",{className:"wizard-step",children:a.jsxs("div",{className:"wizard-step-content",children:[a.jsx("h3",{className:"wizard-step-title",children:"Provenienza e Assistenza"}),a.jsx("p",{className:"wizard-step-description",children:"Informazioni sulla provenienza del paziente (opzionale)"}),a.jsx(ae,{values:e,onChange:t})]})}),Pe=({values:e,onCheckboxChange:t,onEditInfection:i,onEditSurgery:n,infectionBadge:s,surgeryBadge:o,renderBadge:r})=>a.jsx("div",{className:"wizard-step",children:a.jsxs("div",{className:"wizard-step-content",children:[a.jsx("h3",{className:"wizard-step-title",children:"Dati Clinici"}),a.jsx("p",{className:"wizard-step-description",children:"Seleziona i flag clinici del paziente"}),a.jsx(te,{values:e,onCheckboxChange:t??(async()=>{}),onEditInfection:i??(async()=>{}),onEditSurgery:n??(async()=>{}),infectionBadge:s,surgeryBadge:o,renderBadge:r})]})}),$e=({values:e,onChange:t})=>a.jsx("div",{className:"wizard-step",children:a.jsxs("div",{className:"wizard-step-content",children:[a.jsx("h3",{className:"wizard-step-title",children:"Note Aggiuntive"}),a.jsx("p",{className:"wizard-step-description",children:"Aggiungi eventuali note (opzionale)"}),a.jsx(ie,{values:e,onChange:t})]})}),Te=({values:e})=>a.jsx("div",{className:"wizard-step",children:a.jsxs("div",{className:"wizard-step-content",children:[a.jsx("h3",{className:"wizard-step-title",children:"Riepilogo"}),a.jsx("p",{className:"wizard-step-description",children:"Verifica i dati inseriti prima di confermare"}),a.jsxs("div",{className:"review-section",children:[a.jsx("h4",{className:"review-section-title",children:"Dati Personali"}),a.jsxs("div",{className:"review-grid",children:[a.jsxs("div",{className:"review-item",children:[a.jsx("span",{className:"review-label",children:"Nome:"}),a.jsx("span",{className:"review-value",children:e.nome})]}),a.jsxs("div",{className:"review-item",children:[a.jsx("span",{className:"review-label",children:"Cognome:"}),a.jsx("span",{className:"review-value",children:e.cognome})]})]})]}),a.jsxs("div",{className:"review-section",children:[a.jsx("h4",{className:"review-section-title",children:"Date"}),a.jsxs("div",{className:"review-grid",children:[a.jsxs("div",{className:"review-item",children:[a.jsx("span",{className:"review-label",children:"Data Nascita:"}),a.jsx("span",{className:"review-value",children:e.data_nascita})]}),a.jsxs("div",{className:"review-item",children:[a.jsx("span",{className:"review-label",children:"Data Ricovero:"}),a.jsx("span",{className:"review-value",children:e.data_ricovero})]})]})]}),a.jsxs("div",{className:"review-section",children:[a.jsx("h4",{className:"review-section-title",children:"Clinico"}),a.jsxs("div",{className:"review-grid",children:[a.jsxs("div",{className:"review-item",children:[a.jsx("span",{className:"review-label",children:"Diagnosi:"}),a.jsx("span",{className:"review-value",children:e.diagnosi||"Non specificato"})]}),a.jsxs("div",{className:"review-item",children:[a.jsx("span",{className:"review-label",children:"Reparto:"}),a.jsx("span",{className:"review-value",children:e.reparto_appartenenza||"Non specificato"})]}),a.jsxs("div",{className:"review-item",children:[a.jsx("span",{className:"review-label",children:"Paziente Infetto:"}),a.jsx("span",{className:"review-value",children:e.infetto?"Sì":"No"})]}),a.jsxs("div",{className:"review-item",children:[a.jsx("span",{className:"review-label",children:"Intervento Chirurgico:"}),a.jsx("span",{className:"review-value",children:e.ha_intervento?"Sì":"No"})]})]})]}),e.note&&a.jsxs("div",{className:"review-section",children:[a.jsx("h4",{className:"review-section-title",children:"Note"}),a.jsx("p",{className:"review-notes",children:e.note})]})]})}),ke=({patient:t,mode:i,onSubmit:n,onCancel:s,onValidate:o})=>{const{values:r,setValues:l,handleChange:c}=fe({initialPatient:t}),[d,m]=e.useState(!1),g=e.useRef(null),v=((e="personal-info")=>u({steps:je,labels:we,initialStep:e}))("personal-info"),f=p({currentStep:v.currentStep,getStepLabel:v.getStepLabel,totalSteps:v.totalSteps,currentStepNumber:v.getStepNumber(v.currentStep)});h();const x=e.useMemo(()=>[r.nome?.trim(),r.cognome?.trim()].filter(Boolean).join(" ").trim(),[r.nome,r.cognome]),{diagnosiOptions:b,repartoOptions:_,loadingDiagnosi:y,loadingReparti:z}=_e(),{infectionBadge:j,surgeryBadge:w,renderBadge:N,handleCheckboxChange:D,handleEditInfection:S,handleEditSurgery:C,modalsPortal:E}=he({values:r,setValues:l,patientDisplayName:x,patientId:t?.id??""}),I=e.useCallback(async e=>{if(e.preventDefault(),!d){m(!0);try{const{infection:e,surgery:a}=await de(),t=ye({values:r,infectionDataManager:e,surgeryDataManager:a});if(o){if(!o(t).valid)return m(!1),void 0}await n(t)}finally{m(!1)}}},[n,o,d,r]),P="create"===i?"Salva paziente":"Aggiorna paziente",$=e.useCallback(()=>{switch(v.currentStep){case"personal-info":return!!r.nome?.trim()&&!!r.cognome?.trim();case"admission-dates":return!!r.data_nascita&&!!r.data_ricovero;case"diagnosis":return!!r.diagnosi&&!!r.reparto_appartenenza;case"provenance":case"clinical-flags":case"notes":case"review":return!0;default:return!1}},[v.currentStep,r.nome,r.cognome,r.data_nascita,r.data_ricovero,r.diagnosi,r.reparto_appartenenza]);return a.jsxs(a.Fragment,{children:[a.jsxs("form",{id:"patient-form-wizard",ref:g,onSubmit:I,className:"wizard-form",noValidate:!0,children:[a.jsxs("div",{className:"wizard-form-header",children:[a.jsx("button",{type:"button",className:"wizard-back-button",onClick:s,"aria-label":"Torna alla lista pazienti",children:a.jsx("i",{className:"bi bi-arrow-left"})}),a.jsx("h1",{className:"wizard-form-title",children:"Inserimento Nuovo Paziente"})]}),a.jsx(De,{currentStep:v.currentStep,totalSteps:v.totalSteps,getStepLabel:v.getStepLabel,getStepNumber:v.getStepNumber}),a.jsx("div",{ref:f,className:"wizard-form-content",children:(()=>{const e={values:r,onChange:c,diagnosiOptions:b,repartoOptions:_,loadingDiagnosi:y,loadingReparti:z,onCheckboxChange:D,onEditInfection:S,onEditSurgery:C,infectionBadge:j,surgeryBadge:w,renderBadge:N};switch(v.currentStep){case"personal-info":return a.jsx(Se,{...e});case"admission-dates":return a.jsx(Ce,{...e});case"diagnosis":return a.jsx(Ee,{...e});case"provenance":return a.jsx(Ie,{...e});case"clinical-flags":return a.jsx(Pe,{...e});case"notes":return a.jsx($e,{...e});case"review":return a.jsx(Te,{values:r});default:return null}})()}),a.jsxs("div",{className:"wizard-form-actions",children:[a.jsxs("button",{type:"button",className:"btn btn-secondary btn-block",onClick:v.prevStep,disabled:!v.canGoPrev,children:[a.jsx("i",{className:"bi bi-chevron-left"}),"Indietro"]}),"review"!==v.currentStep?a.jsxs("button",{type:"button",className:"btn btn-primary btn-block",onClick:v.nextStep,disabled:!v.canGoNext||!$(),title:$()?void 0:"Completa i campi obbligatori per continuare",children:["Avanti",a.jsx("i",{className:"bi bi-chevron-right"})]}):a.jsx(a.Fragment,{children:a.jsx("button",{type:"submit",className:"btn btn-success btn-block",disabled:d,children:a.jsxs(a.Fragment,d?{children:[a.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio in corso..."]}:{children:[a.jsx("i",{className:"bi bi-check-circle me-2"}),P]})})})]})]}),E]})},Re=(e={})=>{let a=C.from("pazienti").select("*",{count:"exact"}).not("user_id","is",null);const{reparto:t,diagnosi:i,stato:n,search:s,infetto:o}=e;if(t&&(a=a.eq("reparto_appartenenza",t)),i&&(a=a.eq("diagnosi",i)),"attivo"===n&&(a=a.is("data_dimissione",null)),"dimesso"===n&&(a=a.not("data_dimissione","is",null)),console.log("Applying infection filter:",o,"as boolean:","true"===o),void 0!==o&&(a=a.eq("infetto","true"===o)),s){const e=s.trim().split(/\s+/).filter(e=>e.length>0);if(1===e.length)a=a.or(`nome.ilike.%${e[0]}%,cognome.ilike.%${e[0]}%,codice_rad.ilike.%${e[0]}%`);else if(2===e.length){const[t,i]=e;a=a.or([`nome.ilike.%${t}%`,`nome.ilike.%${i}%`,`cognome.ilike.%${t}%`,`cognome.ilike.%${i}%`,`codice_rad.ilike.%${t}%`,`codice_rad.ilike.%${i}%`].join(","))}else{const t=[];e.forEach(e=>{t.push(`nome.ilike.%${e}%`,`cognome.ilike.%${e}%`,`codice_rad.ilike.%${e}%`)}),a=a.or(t.join(","))}}return a},Ae={getPaginatedPatients:async(e={},a={})=>{const{page:t=0,limit:i=g,sortColumn:n="data_ricovero",sortDirection:s="desc"}=a;let o=Re(e);const r=t*i,l=r+i-1;o=o.order(n,{ascending:"asc"===s}).range(r,l);const{data:c,error:d,count:m}=await o;if(d)throw d;try{const e=(c||[]).filter(e=>e&&"trasferimento_esterno"===e.tipo_dimissione).slice(0,5).map(e=>({id:e.id,codice_clinica:e.codice_clinica}));E.group("[patientApi.getPaginatedPatients] Result summary"),E.log({total:c?.length||0,count:m,externalTransfersSample:e}),E.groupEnd()}catch(u){}return{patients:c||[],totalCount:m||0}},getAllPatients:async(e={})=>{const{sortColumn:a="data_ricovero",sortDirection:t="desc"}=e;let i=Re(e);i=i.order(a,{ascending:"asc"===t}).limit(5e3);const{data:n,error:s}=await i;if(s)throw s;try{const e=(n||[]).filter(e=>e&&"trasferimento_esterno"===e.tipo_dimissione).slice(0,5).map(e=>({id:e.id,codice_clinica:e.codice_clinica}));E.group("[patientApi.getAllPatients] Result sample"),E.log({total:n?.length||0,externalTransfersSample:e}),E.groupEnd()}catch(o){}return n||[]},getPatientById:async e=>{const{data:a,error:t}=await C.from("pazienti").select("*").eq("id",e).single();if(t)throw t;try{E.log("[patientApi.getPatientById] Loaded",{id:a?.id,tipo_dimissione:a?.tipo_dimissione,codice_clinica:a?.codice_clinica||null})}catch(i){}return a},createPatient:async e=>{const a={...e},{id:t,...i}=a,{data:n,error:s}=await C.from("pazienti").insert(i).select("*").single();if(s)throw s;return n},updatePatient:async(e,a)=>{try{E.group("[patientApi.updatePatient] Update payload"),E.log({id:e,codice_clinica:a?.codice_clinica??null,tipo_dimissione:a?.tipo_dimissione??null}),E.groupEnd()}catch(n){}const{data:t,error:i}=await C.from("pazienti").update(a).eq("id",e).select().single();if(i)throw i;try{E.group("[patientApi.updatePatient] Update result"),E.log({id:t?.id,tipo_dimissione:t?.tipo_dimissione??null,codice_clinica:t?.codice_clinica??null}),E.groupEnd()}catch(n){}return t},deletePatient:async e=>{const{error:a}=await C.from("pazienti").delete().eq("id",e);if(a)throw a},searchPatients:async(e,a=!1,t=50)=>{const i=e.trim().split(/\s+/).filter(e=>e.length>0);let n=C.from("pazienti").select("id, nome, cognome, codice_rad, data_ricovero, diagnosi, reparto_appartenenza").not("user_id","is",null);if(1===i.length)n=n.or(`nome.ilike.%${i[0]}%,cognome.ilike.%${i[0]}%,codice_rad.ilike.%${i[0]}%`);else if(2===i.length){const[e,a]=i;n=n.or([`nome.ilike.%${e}%`,`nome.ilike.%${a}%`,`cognome.ilike.%${e}%`,`cognome.ilike.%${a}%`,`codice_rad.ilike.%${e}%`,`codice_rad.ilike.%${a}%`].join(","))}else{const e=[];i.forEach(a=>{e.push(`nome.ilike.%${a}%`,`cognome.ilike.%${a}%`,`codice_rad.ilike.%${a}%`)}),n=n.or(e.join(","))}n=n.order("cognome"),a&&(n=n.is("data_dimissione",null));const{data:s,error:o}=await n.limit(Math.max(1,Number(t)||50));if(o)throw o;return s||[]},getStatsData:async()=>{const{data:e,error:a}=await C.from("pazienti").select("data_dimissione, diagnosi, reparto_appartenenza").not("user_id","is",null);if(a)throw a;return e||[]}};const Le=new class{async exportPatients(e={}){try{P.getState().setLoading(!0);const a=await Ae.getAllPatients(e);if(this._logExportSample(a,"CSV"),!a||0===a.length)return $("Nessun dato da esportare per i filtri selezionati."),void 0;const t=v(a);f(t,"esportazione_pazienti.csv"),T(`Esportati ${a.length} pazienti con successo!`)}catch(a){E.error("Errore nell'esportazione:",a);const e=a instanceof Error?a.message:String(a);throw e.includes("network")||e.includes("fetch")?I("Impossibile connettersi al server. Verifica la tua connessione."):e.includes("permission")||e.includes("autorizzato")?I("Non hai i permessi per esportare questi dati."):I(`Impossibile esportare i dati: ${e}`),a}finally{P.getState().setLoading(!1)}}async exportPatientsJSON(e={}){try{P.getState().setLoading(!0);const a=await Ae.getAllPatients(e);if(!a||0===a.length)return $("Nessun dato da esportare per i filtri selezionati."),void 0;const t=x(a);b(t,"esportazione_pazienti.json"),T(`Esportati ${a.length} pazienti in JSON con successo!`)}catch(a){E.error("Errore nell'esportazione JSON:",a);const e=a instanceof Error?a.message:String(a);throw e.includes("network")||e.includes("fetch")?I("Impossibile connettersi al server. Verifica la tua connessione."):e.includes("permission")||e.includes("autorizzato")?I("Non hai i permessi per esportare questi dati."):I(`Impossibile esportare i dati in JSON: ${e}`),a}finally{P.getState().setLoading(!1)}}_logExportSample(e,a){try{const t=(e||[]).filter(e=>e&&"trasferimento_esterno"===e.tipo_dimissione).slice(0,5).map(e=>({id:e.id,codice_clinica:e.codice_clinica}));E.group(`[PatientExportService.export${a}] Export dataset sample`),E.log({total:e?.length||0,sampleExternalTransfers:t}),E.groupEnd()}catch(t){}}};const Oe=new class{transactionLogs;maxLogRetention;cleanupInterval;constructor(){this.transactionLogs=new Map,this.maxLogRetention=864e5,this.cleanupInterval=36e5,this.startLogCleanup()}generateTransactionId(){return`tx_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}initializeTransactionLog(e,a,t={}){const i={id:e,type:a,status:"started",steps:[],initialData:this.sanitizeLogData(t),createdAt:Date.now(),completedAt:null};return this.transactionLogs.set(e,i),E.log(`Transazione ${e} inizializzata: ${a}`),i}logTransactionStep(e,a,t,i={}){const n=this.transactionLogs.get(e);if(!n)return E.error(`Tentativo di loggare step per transazione inesistente: ${e}`),void 0;const s={step:a,status:t,data:this.sanitizeLogData(i),timestamp:Date.now()};n.steps.push(s),E.log(`Transazione ${e} - Step ${a}: ${t}`)}completeTransactionLog(e,a){const t=this.transactionLogs.get(e);if(!t)return E.error(`Tentativo di completare transazione inesistente: ${e}`),void 0;t.status=a,t.completedAt=Date.now(),E.log(`Transazione ${e} completata con stato: ${a}`)}getTransactionLog(e){return this.transactionLogs.get(e)||null}getAllTransactionLogs(){return Array.from(this.transactionLogs.values())}getTransactionStats(){const e=Array.from(this.transactionLogs.values());return{total:e.length,byStatus:e.reduce((e,a)=>(e[a.status]=(e[a.status]||0)+1,e),{}),byType:e.reduce((e,a)=>(e[a.type]=(e[a.type]||0)+1,e),{}),oldestLog:e.length>0?Math.min(...e.map(e=>e.createdAt)):null,newestLog:e.length>0?Math.max(...e.map(e=>e.createdAt)):null}}sanitizeLogData(e){if(!e||"object"!=typeof e)return e;const a={...e};return["password","token","auth","secret","nome","cognome","codice_fiscale","codice_rad","telefono","email","indirizzo","indirizzo_residenza","citta","cap","note","descrizione"].forEach(e=>{a[e]&&(a[e]="[REDACTED]")}),a}startLogCleanup(){setInterval(()=>{this.cleanupOldLogs()},this.cleanupInterval)}cleanupOldLogs(){const e=Date.now();let a=0;for(const[t,i]of this.transactionLogs.entries())e-i.createdAt>this.maxLogRetention&&(this.transactionLogs.delete(t),a++);a>0&&E.log(`Cleanup log transazioni: ${a} log rimossi`)}};const Fe=new class{async createPatientStep(e,a=!1){try{const t={...e,infetto:a,data_infezione:null},i=await Ae.createPatient(t);if(!i||!i.id)throw new Error("Creazione paziente fallita: nessun ID restituito");return E.log(`Paziente creato con successo: ID ${i.id}`),i}catch(t){throw E.error("Errore nella creazione paziente:",t),new Error(`Fallimento creazione paziente: ${t?.message??String(t)}`)}}async createInfectionEventStep(e,a){try{const t={paziente_id:e,tipo_evento:"infezione",data_evento:a.data_evento,agente_patogeno_id:a.agente_patogeno_id||null,tipo_patogeno:a.tipo_patogeno||null,descrizione:a.descrizione||null,data_fine_evento:a.data_fine_evento||null},i=await F.createEvento(t);if(!i||!i.id)throw new Error("Creazione evento infezione fallita: nessun ID restituito");return E.log(`Evento infezione creato con successo: ID ${i.id}`),i}catch(t){throw E.error("Errore nella creazione evento infezione:",t),new Error(`Fallimento creazione evento infezione: ${t?.message??String(t)}`)}}async createSurgeryEventStep(e,a){try{const t={paziente_id:e,tipo_evento:"intervento",data_evento:a.data_evento,tipo_intervento_id:a.tipo_intervento_id,descrizione:a.descrizione||null,data_fine_evento:null},i=await F.createEvento(t);if(!i||!i.id)throw new Error("Creazione evento intervento fallita: nessun ID restituito");return E.log(`Evento intervento creato con successo: ID ${i.id}`),i}catch(t){throw E.error("Errore nella creazione evento intervento:",t),new Error(`Fallimento creazione evento intervento: ${t?.message??String(t)}`)}}async verifySynchronizationStep(e){try{await new Promise(e=>setTimeout(e,500));const a=await Ae.getPatientById(e);if(!a)throw new Error("Paziente non trovato durante verifica sincronizzazione");a.infetto||E.warn(`Paziente ${e}: flag infetto non sincronizzato correttamente`),a.data_infezione||E.warn(`Paziente ${e}: data_infezione non sincronizzata correttamente`),E.log(`Sincronizzazione verificata per paziente ${e}`)}catch(a){E.error("Errore nella verifica sincronizzazione:",a),E.warn("Continuando nonostante errore di verifica sincronizzazione")}}async rollbackPatientCreation(e){try{await Ae.deletePatient(e),E.log(`Rollback completato: paziente ${e} eliminato`)}catch(a){throw E.error(`Errore nel rollback paziente ${e}:`,a),new Error(`Rollback fallito: ${a?.message??String(a)}`)}}};const Me=new class{async handleTransactionFailure(e,a){const t=Oe.getTransactionLog(e);if(!t)return E.error(`Log transazione ${e} non trovato`),void 0;Oe.logTransactionStep(e,"handle_failure","started",{error:a.message});const i=t.steps.filter(e=>"completed"===e.status),n=i.some(e=>"create_patient"===e.step),s=i.some(e=>"create_infection_event"===e.step);try{s&&!n?await this.handleInconsistentState(e,a):n&&!s?await this.handlePatientCreatedInfectionFailed(e,a):n?await this.handleLateFailure(e,a):await this.handleEarlyFailure(e,a),Oe.completeTransactionLog(e,"failed")}catch(o){E.error(`Errore durante gestione fallimento transazione ${e}:`,o),Oe.completeTransactionLog(e,"rollback_failed")}}async handlePatientCreatedInfectionFailed(e,a){const t=Oe.getTransactionLog(e).steps.find(e=>"create_patient"===e.step&&"completed"===e.status);if(!t||!t.data||!t.data.patientId)throw new Error("ID paziente non trovato nel log della transazione");const i=t.data.patientId;throw Oe.logTransactionStep(e,"recovery_options_presented","completed",{type:"error",title:"Creazione Incompleta",message:`Paziente creato con successo, ma creazione evento infezione fallita. \n                Paziente ID: ${i}\n                Errore: ${a.message}`,actions:[{label:"Riprova Evento Infezione",action:"retry_infection",data:{transactionId:e,patientId:i}},{label:"Completa Manualmente",action:"complete_manually",data:{patientId:i}},{label:"Elimina Paziente",action:"rollback_patient",data:{patientId:i},variant:"danger"}]}),I("Paziente creato ma evento infezione fallito. Controlla la sezione notifiche per le opzioni di recovery.",{persistent:!0}),new Error(`Transazione parzialmente completata. Paziente ID: ${i}. ${a.message}`)}async handleEarlyFailure(e,a){Oe.logTransactionStep(e,"early_failure_handled","completed",{message:"Nessun rollback necessario - nessuna risorsa creata"}),I(`Errore nella creazione: ${a.message}`)}async handleLateFailure(e,a){Oe.logTransactionStep(e,"late_failure_handled","completed",{message:"Transazione sostanzialmente completata nonostante errore finale",originalError:a.message}),$(`Paziente e evento infezione creati, ma si è verificato un errore nella verifica finale: ${a.message}`)}async handleInconsistentState(e,a){Oe.logTransactionStep(e,"inconsistent_state_detected","completed",{message:"Stato inconsistente rilevato - richiede intervento manuale",originalError:a.message}),I(`Stato inconsistente rilevato. Contattare l'amministratore. Transazione ID: ${e}`,{persistent:!0})}async retryInfectionCreation(e,a,t){const i=`${e}_retry_${Date.now()}`;try{Oe.initializeTransactionLog(i,"retry_infection_creation",{originalTransactionId:e,patientId:a,infectionData:t});const n=await Fe.createInfectionEventStep(a,t);return await Fe.verifySynchronizationStep(a),Oe.completeTransactionLog(i,"completed"),T("Evento infezione creato con successo!"),n}catch(n){throw Oe.completeTransactionLog(i,"failed"),E.error("Errore nel retry creazione infezione:",n),n}}};const Ve=new class{async validatePatientData(e){if(!e||"object"!=typeof e)throw new Error("Dati paziente non validi");const a=["nome","cognome","data_ricovero"];for(const t of a)if(!e[t]||""===e[t].toString().trim())throw new Error(`Campo paziente obbligatorio mancante: ${t}`)}async validateInfectionData(e){if(!e||"object"!=typeof e)throw new Error("Dati infezione non validi");const a=["data_evento"];for(const t of a)if(!e[t]||""===e[t].toString().trim())throw new Error(`Campo infezione obbligatorio mancante: ${t}`);await this.validateEventDate(e.data_evento,"evento infezione")}async validateSurgeryData(e){if(!e||"object"!=typeof e)throw new Error("Dati intervento non validi");const a=["data_evento","tipo_intervento"];for(const t of a)if(!e[t]||""===e[t].toString().trim())throw new Error(`Campo intervento obbligatorio mancante: ${t}`);if(await this.validateEventDate(e.data_evento,"evento intervento"),e.has_infection&&e.data_infezione){const a=new Date(e.data_infezione),t=new Date(e.data_evento);if(isNaN(a.getTime()))throw new Error("Data infezione associata non valida");if(a<t)throw new Error("La data dell'infezione non può essere precedente all'intervento")}}async validateEventDate(e,a){const t=new Date(e),i=new Date;if(i.setHours(23,59,59,999),isNaN(t.getTime()))throw new Error(`Data ${a} non valida`);if(t>i)throw new Error(`La data dell'${a} non può essere nel futuro`)}async validateTransactionData(e,a,t){switch(await this.validatePatientData(e),t){case"infection":await this.validateInfectionData(a);break;case"surgery":await this.validateSurgeryData(a);break;default:throw new Error(`Tipo evento non supportato: ${t}`)}E.log(`Validazione dati transazione ${t} completata con successo`)}};const Be=new class{async executeTransaction(e){const a=Oe.generateTransactionId();try{Oe.initializeTransactionLog(a,e.type,e.data),P.getState().setLoading(!0),await this.validateTransaction(a,e);const t=await this.createPatient(a,e),i=await this.createEvents(a,e,t.id);return await this.verifyTransaction(a,t.id),Oe.completeTransactionLog(a,"completed"),T(e.successMessage),this.formatResult(a,t,i)}catch(t){throw E.error(`Errore nella transazione ${a}:`,t),await Me.handleTransactionFailure(a,t),t}finally{P.getState().setLoading(!1)}}async validateTransaction(e,a){Oe.logTransactionStep(e,"validation","started"),await Ve.validatePatientData(a.data.patientData);for(const t of a.events)await Ve.validateTransactionData(a.data.patientData,a.data[t.dataKey],t.type);Oe.logTransactionStep(e,"validation","completed",{message:"Dati validati con successo"})}async createPatient(e,a){Oe.logTransactionStep(e,"create_patient","started");const t=a.events.some(e=>"infection"===e.type),i=await Fe.createPatientStep(a.data.patientData,t);return Oe.logTransactionStep(e,"create_patient","completed",{patientId:i.id}),i}async createEvents(e,a,t){const i={};for(const n of a.events){const s=`create_${n.type}_event`;let o;switch(Oe.logTransactionStep(e,s,"started"),n.type){case"infection":o=await Fe.createInfectionEventStep(t,a.data[n.dataKey]);break;case"surgery":o=await Fe.createSurgeryEventStep(t,a.data[n.dataKey]);break;default:throw new Error(`Tipo evento non supportato: ${n.type}`)}i[n.resultKey]=o,Oe.logTransactionStep(e,s,"completed",{eventId:o.id})}if(a.data.surgeryData?.has_infection&&a.data.surgeryData?.data_infezione){const n="create_infection_event";Oe.logTransactionStep(e,n,"started");const s={data_evento:a.data.surgeryData.data_infezione,agente_patogeno:a.data.surgeryData.agente_patogeno,descrizione:a.data.surgeryData.descrizione_infezione},o=await Fe.createInfectionEventStep(t,s);i.infectionEvent=o,Oe.logTransactionStep(e,n,"completed",{eventId:o.id})}return i}async verifyTransaction(e,a){Oe.logTransactionStep(e,"verify_synchronization","started"),await Fe.verifySynchronizationStep(a),Oe.logTransactionStep(e,"verify_synchronization","completed")}formatResult(e,a,t){return{success:!0,transactionId:e,patient:a,...t,message:"Transazione completata con successo"}}};const qe=new class{async executePatientWithSurgeryTransaction(e,a){return Be.executeTransaction({type:"patient_with_surgery",loadingMessage:"Creazione paziente e evento intervento...",successMessage:"Paziente e evento intervento creati con successo!",data:{patientData:e,surgeryData:a},events:[{type:"surgery",dataKey:"surgeryData",resultKey:"surgeryEvent"}]})}async executePatientWithSurgeryAndInfectionTransaction(e,a,t){return Be.executeTransaction({type:"patient_with_surgery_and_infection",loadingMessage:"Creazione paziente, intervento e infezione...",successMessage:"Paziente, intervento e infezione creati con successo!",data:{patientData:e,surgeryData:a,infectionData:t},events:[{type:"surgery",dataKey:"surgeryData",resultKey:"surgeryEvent"},{type:"infection",dataKey:"infectionData",resultKey:"infectionEvent"}]})}async executePatientWithInfectionTransaction(e,a){return Be.executeTransaction({type:"patient_with_infection",loadingMessage:"Creazione paziente e evento infezione...",successMessage:"Paziente e evento infezione creati con successo!",data:{patientData:e,infectionData:a},events:[{type:"infection",dataKey:"infectionData",resultKey:"infectionEvent"}]})}async rollbackPatientCreation(e){await Fe.rollbackPatientCreation(e)}async retryInfectionCreation(e,a,t){return Me.retryInfectionCreation(e,a,t)}getTransactionLog(e){return Oe.getTransactionLog(e)}getAllTransactionLogs(){return Oe.getAllTransactionLogs()}getTransactionStats(){return Oe.getTransactionStats()}};const We=new class{async createPatientWithInfection(e,a){try{E.log("Avvio creazione paziente con infezione:",{patientName:`${e.nome} ${e.cognome}`,infectionDate:a.data_evento}),await this._validateInfectionData(a);const t=await qe.executePatientWithInfectionTransaction(e,a);return(await le()).clearInfectionData(),E.log("Creazione paziente con infezione completata con successo:",{transactionId:t.transactionId,patientId:t.patient?.id,infectionEventId:t.infectionEvent?.id}),t}catch(t){throw this._handleInfectionError(t,"creazione"),t}}async handleInfectionEventCreation(e,a){try{E.log(`Creazione evento infezione per paziente ${e}`),await this._validateInfectionData(a);const t=(await F.getEventiByPaziente(e,{tipo_evento:["infezione"]})).filter(e=>!e.data_fine_evento);if(t.length>0)throw this._handleActiveInfectionConflict(t[0]),new Error("Paziente ha già un'infezione attiva");const i=await this._createInfectionEvent(e,a);return(await le()).clearInfectionData(),i}catch(t){throw this._handleInfectionError(t,"creazione evento"),t}}async forceCreateInfectionEvent(e,a){try{E.log(`Creazione forzata evento infezione per paziente ${e}`),await this._validateInfectionData(a);const t=await this._createInfectionEvent(e,a);return(await le()).clearInfectionData(),T("Nuovo evento infezione creato con successo!"),t}catch(t){E.error("Errore nella creazione forzata evento infezione:",t);const e=t instanceof Error?t.message:String(t);throw e.includes("JWT")?I("Sessione scaduta. Effettua nuovamente l'accesso."):e.includes("validation")||e.includes("valido")?I(`Dati infezione non validi: ${e}`):I(`Impossibile creare l'infezione: ${e}`),t}}async retryInfectionEventCreation(e,a,t){try{return E.log(`Retry creazione evento infezione - Transazione: ${e}, Paziente: ${a}`),await qe.retryInfectionCreation(e,a,t)}catch(i){E.error("Errore nel retry creazione evento infezione:",i);const e=i instanceof Error?i.message:String(i);throw e.includes("JWT")?I("Sessione scaduta. Effettua nuovamente l'accesso."):e.includes("timeout")||e.includes("tempo")?I("Tempo scaduto. Riprova più tardi."):I(`Impossibile completare l'operazione: ${e}`),i}}async _validateInfectionData(e){const a=await le();if(a.setInfectionData(e),!a.hasValidInfectionData()){const e=a.getValidationErrors().map(e=>e.message).join(", ");throw new Error(`Dati infezione non validi: ${e}`)}}async _createInfectionEvent(e,a){const t={paziente_id:e,tipo_evento:"infezione",data_evento:a.data_evento,agente_patogeno:a.agente_patogeno||void 0,descrizione:a.descrizione||void 0,data_fine_evento:void 0},i=await F.createEvento(t);return E.log(`Evento infezione creato con successo: ID ${i.id}`),i}_handleActiveInfectionConflict(e){E.warn(`Paziente ha già un'infezione attiva dal ${e.data_evento}`),$(`Il paziente ha già un'infezione attiva dal ${e.data_evento}. Vuoi comunque creare un nuovo evento di infezione?`,{persistent:!0,actions:[{label:"Crea Comunque",action:"force_create_infection"},{label:"Annulla",action:"cancel_infection"}]})}_handleInfectionError(e,a){const t=e?.message||JSON.stringify(e);E.error(`Errore nella ${a} paziente con infezione:`,t),t.includes("Dati infezione non validi")?I(`Dati infezione non validi: ${t}`):t.includes("Transazione parzialmente completata")?E.warn("Transazione parzialmente completata - recovery options presentate"):t.includes("già un'infezione attiva")||(t.includes("non trovato")?I("Paziente non trovato. Verifica i dati e riprova."):t.includes("JWT")?I("Sessione scaduta. Effettua nuovamente l'accesso."):I(`Impossibile ${a}: ${t}`))}};const Ke=new class{async createPatientWithSurgery(e,a){try{E.log("Avvio creazione paziente con intervento chirurgico:",{patientName:`${e.nome} ${e.cognome}`,surgeryDate:a.data_evento,surgeryType:a.tipo_intervento}),await this._validateSurgeryData(a);const t=await qe.executePatientWithSurgeryTransaction(e,a),{surgery:i}=await de();return i.clearSurgeryData(),E.log("Creazione paziente con intervento completata con successo:",{transactionId:t.transactionId,patientId:t.patient?.id,surgeryEventId:t.surgeryEvent?.id}),t}catch(t){throw this._handleSurgeryError(t,"creazione paziente con intervento"),t}}async createPatientWithSurgeryAndInfection(e,a,t){try{E.log("Avvio creazione paziente con intervento e infezione:",{patientName:`${e.nome} ${e.cognome}`,surgeryDate:a.data_evento,infectionDate:t?.data_evento||a.data_infezione});const{surgery:i,infection:n}=await de();await this._validateSurgeryData(a);let s=t;!s&&i.hasAssociatedInfection()&&(s=i.prepareInfectionEventData()),s&&this._validateInfectionData(s);const o=await qe.executePatientWithSurgeryAndInfectionTransaction(e,a,s);return i.clearSurgeryData(),s&&n.clearInfectionData(),E.log("Creazione paziente con intervento e infezione completata con successo:",{transactionId:o.transactionId,patientId:o.patient?.id,surgeryEventId:o.surgeryEvent?.id,infectionEventId:o.infectionEvent?.id}),o}catch(i){throw this._handleSurgeryError(i,"creazione paziente con intervento e infezione"),i}}async _validateSurgeryData(e){const{surgery:a}=await de();if(a.setSurgeryData(e),!a.hasValidSurgeryData()){const e=a.getValidationErrors().map(e=>e.message).join(", ");throw new Error(`Dati intervento non validi: ${e}`)}}async _validateInfectionData(e){const{infection:a}=await de();if(a.setInfectionData(e),!a.hasValidInfectionData()){const e=a.getValidationErrors().map(e=>e.message).join(", ");throw new Error(`Dati infezione non validi: ${e}`)}}_handleSurgeryError(e,a){const t=e?.message||JSON.stringify(e);E.error(`Errore nella ${a}:`,t),t.includes("non validi")?I(`Dati intervento non validi: ${t}`):t.includes("Transazione parzialmente completata")?E.warn("Transazione parzialmente completata - recovery options presentate"):t.includes("JWT")?I("Sessione scaduta. Effettua nuovamente l'accesso."):I(`Impossibile ${a}: ${t}`)}};var Ge=(e=>(e.CLINIC_56="56",e.CLINIC_60="60",e))(Ge||{}),Ue=(e=>(e.ORDINARIA="0",e.TRASFERIMENTO="3",e.PROTETTA="6",e))(Ue||{}),Je=(e=>(e.DIMISSIONE="dimissione",e.TRASFERIMENTO_INTERNO="trasferimento_interno",e.TRASFERIMENTO_ESTERNO="trasferimento_esterno",e.DECESSO="decesso",e))(Je||{});const He={nome:"Nome",cognome:"Cognome",data_nascita:"Data Nascita",data_ricovero:"Data Ricovero",diagnosi:"Diagnosi",reparto_appartenenza:"Reparto Appartenenza",reparto_provenienza:"Reparto Provenienza",data_dimissione:"Data Dimissione",diagnosi_secondarie:"Diagnosi Secondarie",livello_assistenza:"Livello di assistenza",codice_rad:"Codice RAD",tipo_dimissione:"Tipo dimissione",reparto_destinazione:"Reparto destinazione",clinica_destinazione:"Clinica destinazione",codice_clinica:"Codice clinica",codice_dimissione:"Codice dimissione",data_infezione:"Data infezione"},Qe=["nome","cognome","data_nascita","data_ricovero","diagnosi","reparto_appartenenza","reparto_provenienza"],Ye=["data_dimissione","tipo_dimissione"],Ze=Object.values(Je),Xe=Object.values(Ge),ea=Object.values(Ue);function aa(e){return null!=e&&("string"!=typeof e||e.trim().length>0)}function ta(e){return He[e]||e}function ia(e){return e.join(", ")}const na={isInFuture(e){const a="string"==typeof e?new Date(e):e,t=new Date;return t.setHours(23,59,59,999),a>t},isBefore:(e,a)=>("string"==typeof e?new Date(e):e)<("string"==typeof a?new Date(a):a),isAfter:(e,a)=>("string"==typeof e?new Date(e):e)>("string"==typeof a?new Date(a):a),validateRange(e,a,t){if(e&&a&&this.isAfter(a,e))throw new _(t.end,`${ta(t.end)} non può essere precedente a ${ta(t.start)}`)},validateNotFuture(e,a){if(e&&this.isInFuture(e))throw new _(a,`${ta(a)} non può essere nel futuro`)}},sa={validateInternalTransfer(e){if(!aa(e.reparto_destinazione))throw new _("reparto_destinazione","Il reparto di destinazione è obbligatorio per i trasferimenti interni")},validateExternalTransfer(e){if(!aa(e.clinica_destinazione))throw new _("clinica_destinazione","La clinica di destinazione è obbligatoria per i trasferimenti esterni");if(!aa(e.codice_clinica))throw new _("codice_clinica","Il codice clinica è obbligatorio per i trasferimenti esterni");const a=String(e.codice_clinica);if(!Xe.includes(a))throw new _("codice_clinica",`Codice clinica non valido. Valori ammessi: ${ia(Xe)}`)},validateDischargeCode(e,a){if(!aa(a))return;const t=String(a);if(!ea.includes(t))throw new _("codice_dimissione",`Codice dimissione non valido. Valori ammessi: ${ia(ea)}`);switch(e){case"dimissione":if(!["0","6"].includes(t))throw new _("codice_dimissione","Per 'dimissione' sono ammessi solo i codici 0 (ordinaria) o 6 (protetta)");break;case"trasferimento_esterno":if("3"!==t)throw new _("codice_dimissione","Per 'trasferimento_esterno' è ammesso solo il codice 3")}},validateDischargeCodeRequired(e,a){const t=["dimissione","trasferimento_esterno"].includes(e),i=["trasferimento_interno","decesso"].includes(e);if(t&&!aa(a))throw new _("codice_dimissione","Il codice dimissione è obbligatorio per il tipo selezionato");if(i&&aa(a))throw new _("codice_dimissione",`Per '${e}' il codice dimissione non deve essere valorizzato`)}};function oa(e){for(const a of Qe)if(!aa(e[a]))throw new _(a,`Il campo "${ta(a)}" è obbligatorio.`);!function(e){if(e.data_nascita){const a="string"==typeof e.data_nascita?e.data_nascita:e.data_nascita.toISOString();na.validateNotFuture(a,"data_nascita")}if(e.data_ricovero){const a="string"==typeof e.data_ricovero?e.data_ricovero:e.data_ricovero.toISOString();na.validateNotFuture(a,"data_ricovero")}if(e.data_dimissione&&e.data_ricovero){const a="string"==typeof e.data_ricovero?e.data_ricovero:e.data_ricovero.toISOString(),t="string"==typeof e.data_dimissione?e.data_dimissione:e.data_dimissione.toISOString();na.validateRange(a,t,{start:"data_ricovero",end:"data_dimissione"})}if(e.data_infezione){const a="string"==typeof e.data_infezione?e.data_infezione:e.data_infezione.toISOString();if(na.validateNotFuture(a,"data_infezione"),e.data_ricovero){const t="string"==typeof e.data_ricovero?e.data_ricovero:e.data_ricovero.toISOString();na.validateRange(t,a,{start:"data_ricovero",end:"data_infezione"})}if(e.data_dimissione){const t="string"==typeof e.data_dimissione?e.data_dimissione:e.data_dimissione.toISOString();na.validateRange(a,t,{start:"data_infezione",end:"data_dimissione"})}}}(e),function(e){if(!e)return;if(e.length>11)throw new _("codice_rad","Il codice RAD non può superare i 11 caratteri")}(e.codice_rad),function(e){const a=e.tipo_dimissione;if(!a)return;if(!Ze.includes(a))throw new _("tipo_dimissione",`Tipo dimissione non valido. Valori ammessi: ${ia(Ze)}`);"trasferimento_interno"===a?sa.validateInternalTransfer(e):"trasferimento_esterno"===a&&sa.validateExternalTransfer(e);sa.validateDischargeCodeRequired(a,e.codice_dimissione),aa(e.codice_dimissione)&&sa.validateDischargeCode(a,e.codice_dimissione)}(e)}function ra(e){for(const a of Ye)if(!aa(e[a]))throw new _(a,`Il campo "${ta(a)}" è obbligatorio.`);if(!Ze.includes(e.tipo_dimissione))throw new _("tipo_dimissione",`Tipo dimissione non valido. Valori ammessi: ${ia(Ze)}`);!function(e){if(e.data_dimissione){na.validateNotFuture(e.data_dimissione,"data_dimissione")}}(e),function(e){const a=e.tipo_dimissione;"trasferimento_interno"===a?sa.validateInternalTransfer(e):"trasferimento_esterno"===a&&sa.validateExternalTransfer(e);sa.validateDischargeCodeRequired(a,e.codice_dimissione),aa(e.codice_dimissione)&&sa.validateDischargeCode(a,e.codice_dimissione)}(e)}const la=C,ca=Ae;const da=new class{cache=new Map;cacheTimeout=3e5;constructor(){this.initCache()}initCache(e=this.cacheTimeout){this.cache=new Map,this.cacheTimeout=e}getCached(e){const a=this.cache.get(e);return a&&Date.now()-a.timestamp<this.cacheTimeout?a.data:null}setCache(e,a){const t={data:a,timestamp:Date.now()};this.cache.set(e,t)}deleteCache(e){this.cache.delete(e)}invalidateCache(){this.cache.clear()}async withLoading(e,a){E.log(`[PatientService] ${e}`),P.getState().setLoading(!0);try{return await a()}finally{P.getState().setLoading(!1)}}handleError(e,a={}){const t=a.operation??"operazione";E.error(`Errore in ${t}:`,e);const i=e instanceof Error?e.message:String(e);if(a.useDbErrorMapping){const t=k(e,a);I(t)}else I(`Errore ${t}: ${i}`)}showSuccess(e){T(e)}async getPatients(e={},a={}){try{const{page:t=0,limit:i=g,sortColumn:n,sortDirection:s}=a,o={page:t,limit:i,sortColumn:n??"data_ricovero",sortDirection:s??"desc"},{patients:r,totalCount:l}=await ca.getPaginatedPatients(e,o);this.logPatientsSample(r,{page:t,limit:i,totalCount:l});const c=t;return{patients:r,totalCount:l,currentPage:c,totalPages:i>0?Math.ceil(l/i):0,hasNextPage:i>0&&(c+1)*i<l,hasPrevPage:c>0}}catch(t){throw this.handleError(t,{operation:"caricamento pazienti"}),t}}async getPatientsWithClinicalEvents(e={},a={}){try{const{page:t=0,limit:i=g,sortColumn:n,sortDirection:s}=a,o={page:t,limit:i,sortColumn:n??"data_ricovero",sortDirection:s??"desc"},{patients:r,totalCount:l}=await ca.getPaginatedPatients(e,o);if(r.length>0){const e=r.map(e=>e.id),{data:a,error:t}=await la.from("eventi_clinici").select("*").in("paziente_id",e).order("data_evento",{ascending:!1});if(t)E.warn("⚠️ Errore nel caricamento eventi clinici:",t);else{const e=a.reduce((e,a)=>(e[a.paziente_id]||(e[a.paziente_id]=[]),e[a.paziente_id].push(a),e),{});r.forEach(a=>{a.eventi_clinici=e[a.id]||[]})}}this.logPatientsSample(r,{page:t,limit:i,totalCount:l});const c=t;return{patients:r,totalCount:l,currentPage:c,totalPages:i>0?Math.ceil(l/i):0,hasNextPage:i>0&&(c+1)*i<l,hasPrevPage:c>0}}catch(t){throw this.handleError(t,{operation:"caricamento pazienti con eventi clinici"}),t}}async getPatientById(e){const a=`patient_${e}`,t=this.getCached(a);if(t)return t;try{const t=await ca.getPatientById(e);return t&&(this.setCache(a,t),E.log("[PatientService.getPatientById] Received record",{id:t.id,tipo_dimissione:t.tipo_dimissione,codice_clinica:t.codice_clinica??null})),t}catch(i){throw this.handleError(i,{operation:"caricamento paziente"}),i}}async createPatient(e){return this.withLoading("Creazione paziente...",async()=>{oa(e);const{data:{user:a}}=await la.auth.getUser();if(!a)throw new Error("Utente non autenticato");const t={...Object.entries(e).filter(([e,a])=>!e.startsWith("_")&&void 0!==a).reduce((e,[a,t])=>(e[a]=t,e),{}),user_id:a.id,data_dimissione:null,tipo_dimissione:null,codice_dimissione:null,infetto:Boolean(e.infetto)};try{const e=await ca.createPatient(t);return this.invalidateCache(),this.showSuccess("Paziente creato con successo!"),e}catch(i){throw this.handleError(i,{entity:"paziente",operation:"creazione",useDbErrorMapping:!0}),i}})}async updatePatient(e,a,t={showNotification:!0}){return this.withLoading("Aggiornamento paziente...",async()=>{try{const i=Object.entries(a).filter(([e,a])=>!e.startsWith("_")&&void 0!==a).reduce((e,[a,t])=>(e[a]=t,e),{}),n=await ca.updatePatient(e,i);return this.deleteCache(`patient_${e}`),!1!==t.showNotification&&this.showSuccess("Paziente aggiornato con successo!"),n}catch(i){throw this.handleError(i,{entity:"paziente",operation:"aggiornamento",useDbErrorMapping:!0}),i}})}async deletePatient(e){return this.withLoading("Eliminazione paziente...",async()=>{try{await ca.deletePatient(e),this.deleteCache(`patient_${e}`),this.invalidateCache(),this.showSuccess("Paziente eliminato con successo!")}catch(a){throw this.handleError(a,{operation:"eliminazione"}),a}})}async dischargePatient(e,a=null){try{const t=a??(new Date).toISOString().split("T")[0];await this.updatePatient(e,{data_dimissione:t},{showNotification:!1}),this.showSuccess("Paziente dimesso con successo!")}catch(t){throw this.handleError(t,{operation:"dimissione"}),t}}async dischargePatientWithTransfer(e,a){return this.withLoading("Dimissione paziente...",async()=>{try{ra(a);const t=await ca.updatePatient(e,a);this.deleteCache(`patient_${e}`);return this.showSuccess(`Paziente ${"dimissione"===a.tipo_dimissione?"dimesso":"trasferito"} con successo!`),t}catch(t){throw this.handleError(t,{operation:"dimissione"}),t}})}async reactivatePatient(e){try{const a={data_dimissione:null,tipo_dimissione:null,reparto_destinazione:null,clinica_destinazione:null,codice_clinica:null,codice_dimissione:null};await this.updatePatient(e,a,{showNotification:!1}),this.showSuccess("Paziente riattivato con successo!")}catch(a){throw this.handleError(a,{operation:"riattivazione"}),a}}async searchPatients(e,a=!1,t=50){try{return await ca.searchPatients(e,a,t)}catch(i){throw this.handleError(i,{operation:"ricerca pazienti"}),i}}async exportPatients(e={}){await Le.exportPatients(e)}async exportPatientsJSON(e={}){await Le.exportPatientsJSON(e)}async getPatientStats(){try{const e=await ca.getStatsData(),a={total:e.length,active:e.filter(e=>!e.data_dimissione).length,discharged:e.filter(e=>e.data_dimissione).length,byDiagnosis:{},byDepartment:{}};return e.forEach(e=>{e.diagnosi&&(a.byDiagnosis[e.diagnosi]=(a.byDiagnosis[e.diagnosi]||0)+1),e.reparto_appartenenza&&(a.byDepartment[e.reparto_appartenenza]=(a.byDepartment[e.reparto_appartenenza]||0)+1)}),a}catch(e){throw E.error("Errore nel caricamento statistiche:",e),e}}async getTransferHistory(e){try{const a=await this.getPatientById(e);if(!a)throw new Error("Paziente non trovato");const t=[];return a.data_dimissione&&a.tipo_dimissione&&t.push({data:a.data_dimissione,tipo:a.tipo_dimissione,reparto_destinazione:a.reparto_destinazione,clinica_destinazione:a.clinica_destinazione,codice_clinica:a.codice_clinica,codice_dimissione:a.codice_dimissione}),t}catch(a){throw this.handleError(a,{operation:"caricamento cronologia trasferimenti"}),a}}async createPatientWithInfection(e,a){oa(e);const t=await We.createPatientWithInfection(e,a);return this.invalidateCache(),t}async handleInfectionEventCreation(e,a){const t=await We.handleInfectionEventCreation(e,a);return this.deleteCache(`patient_${e}`),t}async retryInfectionEventCreation(e,a,t){return We.retryInfectionEventCreation(e,a,t)}async rollbackPatientCreation(e){await qe.rollbackPatientCreation(e),this.deleteCache(`patient_${e}`),this.invalidateCache()}async forceCreateInfectionEvent(e,a){const t=await We.forceCreateInfectionEvent(e,a);return this.deleteCache(`patient_${e}`),t}async createPatientWithSurgery(e,a){oa(e);const t=await Ke.createPatientWithSurgery(e,a);return this.invalidateCache(),t}async createPatientWithSurgeryAndInfection(e,a,t){oa(e);const i=await Ke.createPatientWithSurgeryAndInfection(e,a,t);return this.invalidateCache(),i}getTransactionStats(){return qe.getTransactionStats()}getTransactionLog(e){return qe.getTransactionLog(e)}async handleTemporaryEventsCreation(e,a){return this.withLoading("Salvataggio eventi clinici...",async()=>{try{for(const t of a){const a={...t};delete a.id,delete a.isTemporary,a.paziente_id=e,await F.createEvento(a)}this.showSuccess(`${a.length} eventi clinici salvati con successo`)}catch(t){throw this.handleError(t,{operation:"salvataggio eventi clinici"}),t}})}async createPatientWithTemporaryEvents(e,a){return this.withLoading("Creazione paziente ed eventi clinici...",async()=>{try{const t=await ca.createPatient(e);for(const e of a){const a={...e};delete a.id,delete a.isTemporary,a.paziente_id=t.id,await F.createEvento(a)}return this.showSuccess(`Paziente e ${a.length} eventi clinici creati con successo`),{patient:t,events:a,success:!0}}catch(t){throw this.handleError(t,{operation:"creazione paziente e eventi"}),t}})}logPatientsSample(e,a){try{const t=(e||[]).filter(e=>e&&"trasferimento_esterno"===e.tipo_dimissione).slice(0,5).map(e=>({id:e.id,codice_clinica:e.codice_clinica}));E.group("[patientService.getPatients] Result summary"),E.log({...a,sampleExternalTransfers:t}),E.groupEnd()}catch{}}};const ma=()=>{const t=function(){const a=D();return e.useCallback(e=>{if(a)return a(e),void 0;const t=e.startsWith("/")?e.slice(1):e;window.location.hash=t||"home"},[a])}(),[i,n]=e.useState("create"),[s,o]=e.useState(void 0),[r,l]=e.useState(!1);e.useEffect(()=>{void(async()=>{const e=sessionStorage.getItem("editPazienteId");if(!e)return n("create"),void 0;l(!0);try{const a=await da.getPatientById(e);a?(o(a),n("edit")):(E.warn("Patient not found",{id:e}),$("Paziente non trovato"))}catch(a){E.error("Error loading patient for edit",a),I("Errore nel caricamento del paziente")}finally{l(!1),sessionStorage.removeItem("editPazienteId")}})()},[]);const c=e.useCallback(async e=>{try{"edit"===i&&s?.id?(E.info("Updating existing patient",{id:s.id,data:e}),await da.updatePatient(s.id,e),T("Paziente aggiornato con successo")):(E.info("Creating new patient",{data:e}),await da.createPatient(e),T("Paziente creato con successo")),t("/list")}catch(a){throw E.error("Error submitting patient form",a),a}},[t,i,s?.id]),d=e.useCallback(async e=>{if(s?.id)try{E.info("Registering patient discharge",{patientId:s.id,data:e}),await da.dischargePatientWithTransfer(s.id,e),T("Dimissione registrata con successo")}catch(a){throw E.error("Error registering patient discharge",a),I("Errore nella registrazione della dimissione"),a}},[s?.id]),m=e.useCallback(()=>{t("/list")},[t]),u=e.useMemo(()=>"undefined"!=typeof window&&window.innerWidth<992,[]);return a.jsxs("div",{className:"patient-form-page-container",children:[u&&a.jsx(a.Fragment,{children:r?a.jsxs("div",{className:"text-center py-5",children:[a.jsx("div",{className:"spinner-border mb-3",role:"status",children:a.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),a.jsx("p",{className:"text-muted",children:"Caricamento dati paziente in corso..."})]}):a.jsx(ke,{patient:s,mode:i,onSubmit:c,onCancel:m})}),!u&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"patient-form-hero",children:a.jsx("div",{className:"patient-form-hero-content",children:a.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-3",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"patient-form-title",children:r?"Caricamento...":"edit"===i?"Modifica Paziente":"Inserimento Nuovo Paziente"}),a.jsx("p",{className:"patient-form-subtitle",children:r?"Attendere il caricamento dei dati...":"edit"===i?`Modifica i dati di ${s?.nome} ${s?.cognome}`:"Compila il form per aggiungere un nuovo paziente al sistema"})]}),a.jsxs("button",{type:"button",className:"patient-form-back-button",onClick:m,disabled:r,"aria-label":"Torna alla lista",children:[a.jsx("span",{className:"material-icons align-middle me-1",children:"arrow_back"}),a.jsx("span",{className:"back-button-text",children:"Torna alla lista"})]})]})})}),a.jsx("div",{className:"row",children:a.jsxs("div",{className:"col-12 col-lg-10 col-xl-8 mx-auto",children:[a.jsxs("div",{className:"patient-form-card",children:[a.jsx("div",{className:"patient-form-card-header",children:a.jsxs("div",{className:"patient-form-card-title-wrapper",children:[a.jsx("div",{className:"patient-form-card-icon",children:a.jsx("span",{className:"material-icons",children:"edit"===i?"edit":"person_add"})}),a.jsxs("h2",{className:"patient-form-card-title",style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"1rem"},children:[a.jsx("span",{children:"Modifica Dati Paziente"}),"edit"===i&&s&&a.jsxs("span",{style:{fontSize:"1.3rem",fontWeight:"700",color:"#0d6efd"},children:[s.nome," ",s.cognome]})]})]})}),a.jsxs("div",{className:"patient-form-card-body",children:[r?a.jsxs("div",{className:"text-center py-5",children:[a.jsx("div",{className:"spinner-border mb-3",role:"status",children:a.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),a.jsx("p",{className:"text-muted",children:"Caricamento dati paziente in corso..."})]}):a.jsx(ze,{patient:s,mode:i,onSubmit:c,onCancel:m}),!r&&"edit"===i&&s&&a.jsx(H,{patientId:s.id,patientName:`${s.nome} ${s.cognome}`,onDischargeSubmit:d})]})]}),a.jsx("div",{className:"patient-form-help-card card",children:a.jsxs("div",{className:"card-body",children:[a.jsxs("div",{className:"patient-form-help-header",children:[a.jsx("div",{className:"help-icon",children:a.jsx("span",{className:"material-icons",children:"info"})}),a.jsx("h3",{className:"help-title",children:"Informazioni"})]}),a.jsxs("ul",{className:"patient-form-help-list",children:[a.jsx("li",{children:"I campi contrassegnati sono obbligatori"}),a.jsx("li",{children:"La data di ricovero non può essere futura"}),a.jsx("li",{children:"Il codice RAD deve essere univoco se specificato"}),a.jsx("li",{children:"I dati possono essere modificati successivamente dalla pagina di dettaglio"})]})]})})]})})]})]})},ua=Object.freeze(Object.defineProperty({__proto__:null,PatientFormPage:ma,default:ma},Symbol.toStringTag,{value:"Module"})),pa={search:"Ricerca",reparto:"Reparto appartenenza",diagnosi:"Diagnosi",stato:"Stato",infetto:"Infetto",trasferimento:"Trasferimento"},ha={true:"Sì",false:"No"},ga={dimissione:"Dimissione",trasferimento_interno:"Trasferimento interno",trasferimento_esterno:"Trasferimento esterno",decesso:"Decesso"},va=["search","reparto","diagnosi","stato","infetto","trasferimento"];function fa(e){return va.map(a=>{const t=e[a];if(null==t||""===t)return null;const i=function(e,a){if(null==a)return"";if("object"==typeof a&&null!==a)return console.warn(`Filter value for "${e}" is an object, skipping:`,a),"";try{const t=String(a);return"search"===e?t.trim():"infetto"===e?ha[t]||ha[String("true"===t)]||t:"stato"===e?"attivo"===t?"Attivo":"dimesso"===t?"Dimesso":t:"trasferimento"===e&&ga[t]||t}catch(t){return console.error(`Error converting filter value for "${e}":`,t,a),""}}(a,t);return i?{key:a,label:pa[a]||a,value:i}:null}).filter(e=>null!==e)}const xa=({filters:e,onClearFilter:t})=>{const i=fa(e);return 0===i.length?null:a.jsxs("div",{className:"d-flex gap-2 mb-3",role:"list",children:[a.jsx("span",{className:"text-muted small",children:"Filtri attivi:"}),i.map(({key:e,label:i,value:n})=>a.jsxs("span",{className:"badge rounded-pill bg-secondary d-inline-flex align-items-center",role:"listitem",children:[i,": ",n,a.jsx("button",{type:"button",className:"btn-close btn-close-white ms-2","aria-label":`Rimuovi filtro ${i}`,onClick:()=>t(e)})]},e))]})},ba=new Map;function _a(e){if(!e)return!1;if(ba.has(e.id))return ba.get(e.id);let a=!1;return!0===e.infetto?a=!0:e.eventi_clinici&&Array.isArray(e.eventi_clinici)&&(a=M.hasActiveInfection(e.eventi_clinici)),ba.set(e.id,a),a}const ya=({patient:e,onEdit:t,onDelete:i,onDischarge:n,onReactivate:s,onAddIntervention:o,onAddInfection:r,onViewEvents:l})=>{const d=V(e.eventi_clinici??[],new Date),m=function(e){return _a(e)?"patient-card-infected":""}(e);return a.jsx("div",{className:`card mb-3 ${e.data_dimissione?"border-danger":"border-success"} ${m}`,title:m?"Paziente con infezione attiva":void 0,children:a.jsxs("div",{className:"card-body",children:[a.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[a.jsxs("div",{children:[a.jsxs("h5",{className:"card-title mb-1",children:[e.nome," ",e.cognome]}),m&&a.jsxs("span",{className:"badge bg-danger mb-2",children:[a.jsx("span",{className:"material-icons fs-6 me-1",style:{verticalAlign:"middle"},"aria-hidden":"true",children:"coronavirus"}),"Infezione Attiva"]})]}),d?.hasStatus&&a.jsx("span",{className:`badge bg-${d.statusClass??"success"}`,children:d.badgeText??""})]}),a.jsxs("p",{className:"card-text",children:[e.diagnosi," • ",e.reparto_appartenenza]}),a.jsxs("div",{className:"patient-card-actions d-flex gap-2",children:[t&&a.jsx(c,{variant:"secondary",className:"patient-card-action-btn",onClick:()=>t(e),children:"Modifica"}),i&&a.jsx(c,{variant:"danger",className:"patient-card-action-btn",onClick:()=>i(e),children:"Elimina"}),n&&!e.data_dimissione&&a.jsx(c,{variant:"warning",className:"patient-card-action-btn",onClick:()=>n(e),children:"Dimetti"}),s&&e.data_dimissione&&a.jsx(c,{variant:"success",className:"patient-card-action-btn",onClick:()=>s(e),children:"Riattiva"})]}),a.jsxs("div",{className:"mt-3 patient-card-actions d-flex gap-2",children:[o&&a.jsx(c,{variant:"outline-primary",className:"patient-card-action-btn",onClick:()=>o(e),children:"Intervento"}),r&&a.jsx(c,{variant:"outline-warning",className:"patient-card-action-btn",onClick:()=>r(e),children:"Infezione"}),l&&a.jsx(c,{variant:"outline-info",className:"patient-card-action-btn",onClick:()=>l(e),children:"Timeline"})]})]})})},za=e=>{if(!e)return"-";const a="string"==typeof e?new Date(e):e;return Number.isNaN(a.getTime())?"-":a.toLocaleDateString("it-IT")},ja=({patient:e,onSelect:t,onDelete:i,onEdit:n,onDischarge:s,onReactivate:o,showActions:r=!1})=>{const l=!!e.data_dimissione,d=function(e){return _a(e)?"table-row-infected":""}(e);return a.jsxs("tr",{className:d,onClick:()=>t?.(e),style:{cursor:t?"pointer":"default"},title:d?"Paziente con infezione attiva":void 0,children:[a.jsx("td",{children:e.cognome||"-"}),a.jsx("td",{children:e.nome||"-"}),a.jsx("td",{children:za(e.data_nascita)}),a.jsx("td",{children:za(e.data_ricovero)}),a.jsx("td",{children:e.diagnosi||"-"}),a.jsx("td",{children:e.reparto_appartenenza||"-"}),a.jsx("td",{children:(()=>{const t=(e=>{const a=e.eventi_clinici?.filter(e=>"intervento"===e.tipo_evento)?.sort((e,a)=>{const t=new Date(e.data_evento).getTime();return new Date(a.data_evento).getTime()-t})[0];if(!a?.data_evento)return"-";const t=new Date(a.data_evento);if(Number.isNaN(t.getTime()))return"-";const i=(new Date).getTime()-t.getTime(),n=Math.floor(i/864e5);return n>=0?`PO ${n}`:"-"})(e);return"-"===t?"-":a.jsx("span",{className:"badge bg-info text-dark",title:`Giorno post-operatorio ${t.replace("PO ","")}`,children:t})})()}),a.jsx("td",{children:a.jsx("span",l?{className:"badge bg-secondary",children:"Dimesso"}:{className:"badge bg-success",children:"Attivo"})}),a.jsx("td",{children:(()=>{const t=(e=>{if(!e.data_dimissione)return null;let a="";"trasferimento_esterno"===e.tipo_dimissione?a="Esterno":"trasferimento_interno"===e.tipo_dimissione?a="Interno":"decesso"===e.tipo_dimissione?a="Decesso":"dimissione"===e.tipo_dimissione&&(a="Dimissione");let t="";return e.reparto_destinazione?t=e.reparto_destinazione:e.clinica_destinazione&&(t=e.clinica_destinazione),{type:a,destination:t,note:e.note||void 0}})(e);return t?a.jsxs("div",{className:"small",children:[a.jsx("strong",{children:t.type}),t.destination&&a.jsxs(a.Fragment,{children:[" → ",a.jsx("span",{children:t.destination})]}),t.note&&a.jsxs("div",{className:"text-muted",children:["(",t.note,")"]})]}):"-"})()}),r&&a.jsx("td",{children:a.jsxs("div",{className:"patient-table-actions d-flex gap-2",children:[n&&a.jsx(c,{variant:"link",onClick:()=>n(e),title:`Modifica paziente ${e.nome} ${e.cognome}`,"aria-label":`Modifica paziente ${e.nome} ${e.cognome}`,className:"patient-table-action-btn",children:a.jsx("span",{className:"material-icons fs-5","aria-hidden":"true",children:"edit"})}),s&&!l&&a.jsx(c,{variant:"link",onClick:()=>s(e),title:`Dimetti paziente ${e.nome} ${e.cognome}`,"aria-label":`Dimetti paziente ${e.nome} ${e.cognome}`,className:"patient-table-action-btn text-warning",children:a.jsx("span",{className:"material-icons fs-5","aria-hidden":"true",children:"event_available"})}),o&&l&&a.jsx(c,{variant:"link",onClick:()=>o(e),title:`Riattiva paziente ${e.nome} ${e.cognome}`,"aria-label":`Riattiva paziente ${e.nome} ${e.cognome}`,className:"patient-table-action-btn text-success",children:a.jsx("span",{className:"material-icons fs-5","aria-hidden":"true",children:"undo"})}),i&&a.jsx(c,{variant:"link",onClick:()=>i(e),title:`Elimina paziente ${e.nome} ${e.cognome}`,"aria-label":`Elimina paziente ${e.nome} ${e.cognome}`,className:"patient-table-action-btn text-danger",children:a.jsx("span",{className:"material-icons fs-5","aria-hidden":"true",children:"delete"})})]})})]},e.id)},wa=({patients:e,loading:t=!1,onSelect:i,onDelete:n,onEdit:s,onDischarge:o,onReactivate:r,onAddIntervention:l,onAddInfection:d,onViewEvents:m,onResetFilters:u,showActions:p=!1,emptyMessage:h="Nessun paziente disponibile"})=>{const g=y()>=1200;return t?a.jsxs("div",{className:"text-center p-5",role:"status","aria-live":"polite","aria-busy":"true",children:[a.jsx("div",{className:"spinner-border text-primary mb-3",role:"presentation",children:a.jsx("span",{className:"visually-hidden",children:"Caricamento pazienti in corso..."})}),a.jsx("p",{className:"text-muted mb-0",children:"Caricamento pazienti in corso..."}),a.jsx("div",{className:"mt-4",children:[1,2,3].map(e=>a.jsx("div",{className:"card mb-2 placeholder-glow",children:a.jsxs("div",{className:"card-body",children:[a.jsx("span",{className:"placeholder col-7"}),a.jsx("span",{className:"placeholder col-4 ms-2"}),a.jsx("span",{className:"placeholder col-6"})]})},e))})]}):e.length?a.jsx("div",g?{className:"table-responsive",style:{maxHeight:"70vh",overflowY:"auto"},children:a.jsxs("table",{className:"table table-hover align-middle","aria-label":"Elenco pazienti",children:[a.jsx("thead",{className:"table-light",style:{position:"sticky",top:0,zIndex:10},children:a.jsxs("tr",{children:[a.jsx("th",{scope:"col",children:"Cognome"}),a.jsx("th",{scope:"col",children:"Nome"}),a.jsx("th",{scope:"col",children:"Data Nascita"}),a.jsx("th",{scope:"col",children:"Data Ricovero"}),a.jsx("th",{scope:"col",children:"Diagnosi"}),a.jsx("th",{scope:"col",children:"Reparto appartenenza"}),a.jsx("th",{scope:"col",children:"Post-Op"}),a.jsx("th",{scope:"col",children:"Stato"}),a.jsx("th",{scope:"col",children:"Trasferimento"}),p&&a.jsx("th",{scope:"col",children:"Azioni"})]})}),a.jsx("tbody",{children:e.map(e=>a.jsx(ja,{patient:e,onSelect:i,onDelete:n,onEdit:s,onDischarge:o,onReactivate:r,showActions:p},e.id))})]})}:{children:e.map(e=>a.jsx(ya,{patient:e,onEdit:s,onDelete:n,onDischarge:o,onReactivate:r,onAddIntervention:l,onAddInfection:d,onViewEvents:m},e.id))}):a.jsxs("div",{className:"empty-state text-center py-5",children:[a.jsx("span",{className:"material-icons fs-1","aria-hidden":"true",children:"group_off"}),a.jsx("p",{className:"mb-1",children:h}),a.jsx("p",{className:"text-muted mb-3",children:"Aggiorna i filtri o reimposta la ricerca per visualizzare nuovi risultati."}),u&&a.jsxs(c,{variant:"outline-primary",size:"sm",onClick:u,children:[a.jsx("span",{className:"material-icons me-1",style:{verticalAlign:"text-bottom"},children:"refresh"}),"Resetta filtri"]})]})};const Na=new class{async getPatientStats(e={}){try{const a=C.from("pazienti").select("id"),{data:t,error:i}=await a;if(i)throw i;const n=(t||[]).length;let s=C.from("pazienti").select("id, data_dimissione, reparto_appartenenza");if(e.search&&(s=s.or(`nome.ilike.%${e.search}%,cognome.ilike.%${e.search}%,rad.ilike.%${e.search}%`)),e.reparto&&(s=s.eq("reparto_appartenenza",e.reparto)),e.diagnosi&&(s=s.eq("diagnosi",e.diagnosi)),e.stato&&("attivo"===e.stato?s=s.is("data_dimissione",null):"dimesso"===e.stato&&(s=s.not("data_dimissione","is",null))),void 0!==e.infetto){const a="true"===e.infetto||"false"!==e.infetto&&null;null!==a&&(s=s.eq("infetto",a))}e.trasferimento&&(s=s.eq("tipo_dimissione",e.trasferimento));const{data:o,error:r}=await s;if(r)throw r;const l=o||[],c={total:n,ricoverati:l.filter(e=>!e.data_dimissione).length,dimessi:l.filter(e=>e.data_dimissione).length};return e.reparto&&(c.perReparto=l.length),c}catch(a){throw E.error("Error loading patient statistics:",a),a}}},Da=[{value:void 0,label:"Tutti"},{value:"attivo",label:"Attivi"},{value:"dimesso",label:"Dimessi"}],Sa=[{value:void 0,label:"Tutti"},{value:"dimissione",label:"Dimissioni"},{value:"trasferimento_interno",label:"Trasferimenti interni"},{value:"trasferimento_esterno",label:"Trasferimenti esterni"},{value:"decesso",label:"Decessi"}],Ca=[{value:"data_ricovero",label:"Data ricovero"},{value:"cognome",label:"Cognome"},{value:"nome",label:"Nome"},{value:"data_nascita",label:"Data nascita"}];const Ea=()=>{const t=D(),r=i(),{filters:d,setFilters:u,setPage:p,setSort:h,resetFilters:g}=P(),[v,f]=e.useState(d.search||""),[x,b]=e.useState(!1),[_,y]=e.useState({title:"",body:"",onConfirm:()=>{}}),[N,S]=e.useState(null),C=e.useRef(null),{data:E,isPending:$,isError:k,isFetching:A}=n({queryKey:["patients",d],queryFn:()=>{const{page:e,sortColumn:a,sortDirection:t,...i}=d;return da.getPatientsWithClinicalEvents(i,{page:e,limit:10,sortColumn:a,sortDirection:t})},placeholderData:o}),{data:L}=n({queryKey:["patientStats",d],queryFn:()=>Na.getPatientStats(d),initialData:{total:0,ricoverati:0,dimessi:0}}),{data:O}=n({queryKey:["patientFilterOptions"],queryFn:async()=>{const[e,a,t,i,n]=await Promise.all([j(),m(),be(),xe(),w()]);return{diagnosiOptions:e,repartoOptions:a,statusOptions:Ra(t),transferOptions:Aa(i),infectionOptions:La(n)}},staleTime:3e5}),F=(e,a)=>s({mutationFn:a=>da[e](a),onSuccess:()=>{T(a),r.invalidateQueries({queryKey:["patients"]})},onError:e=>{const a=e instanceof Error?e.message:"Si è verificato un errore";I(a)},onSettled:()=>{b(!1)}}),M=F("deletePatient","Paziente eliminato con successo"),V=F("dischargePatient","Paziente dimesso con successo"),B=F("reactivatePatient","Paziente riattivato con successo"),q=e=>{u({...e,page:0})},W=()=>{f(""),g(),R?.("Filtri resettati",{timeout:1500,position:"top-center"}),setTimeout(()=>C.current?.focus(),100)},K=e.useMemo(()=>function(e,a){let t=null;return(...i)=>{t&&clearTimeout(t),t=setTimeout(()=>e(...i),a)}}(e=>{q({search:e})},500),[]),G=e=>{if(!E)return;const a=d.page??0,t="prev"===e?Math.max(a-1,0):a+1;"prev"===e&&!E.hasPrevPage||"next"===e&&!E.hasNextPage||p(t)},U=(e,a,t)=>{y({title:e,body:a,onConfirm:t}),b(!0)},J=(e,a)=>{const{id:i}=a;switch(e){case"add-intervention":t(`/eventi-clinici?action=add&type=intervento&paziente=${i}`);break;case"add-infection":t(`/eventi-clinici?action=add&type=infezione&paziente=${i}`);break;case"view-events":t(`/eventi-clinici?paziente=${i}`)}},H=async e=>{S(e);try{await("csv"===e?da.exportPatients(d):da.exportPatientsJSON(d)),T(`File ${e.toUpperCase()} scaricato con successo`)}catch(a){const e=a instanceof Error?a.message:"Errore durante l'esportazione";I(e)}finally{S(null)}},Q=e.useMemo(()=>{let e=0;return d.search&&e++,d.reparto&&e++,d.diagnosi&&e++,d.stato&&e++,void 0!==d.infetto&&e++,d.trasferimento&&e++,e},[d]);return a.jsxs("div",{className:"patient-list-page-container",children:[a.jsx(z,{isOpen:x,title:_.title,body:_.body,onConfirm:_.onConfirm,onCancel:()=>b(!1)}),a.jsx("div",{className:"patient-list-hero",children:a.jsxs("div",{className:"patient-list-hero-content",children:[a.jsx("h1",{className:"patient-list-title",children:"Elenco Pazienti"}),a.jsx("p",{className:"patient-list-subtitle",children:"Gestisci pazienti, filtra per stato e esporta la lista"})]})}),L&&a.jsxs("div",{className:"patient-stats-grid",children:[a.jsxs("div",{className:"patient-stat-card",children:[a.jsx("div",{className:"stat-icon",children:a.jsx("span",{className:"material-icons","aria-hidden":"true",children:"people"})}),a.jsx("div",{className:"stat-value",children:L.total}),a.jsx("div",{className:"stat-label",children:"Totale Pazienti"})]}),a.jsxs("div",{className:"patient-stat-card",children:[a.jsx("div",{className:"stat-icon",children:a.jsx("span",{className:"material-icons","aria-hidden":"true",children:"hotel"})}),a.jsx("div",{className:"stat-value",children:L.ricoverati}),a.jsx("div",{className:"stat-label",children:"Ricoverati"})]}),a.jsxs("div",{className:"patient-stat-card stat-discharged",children:[a.jsx("div",{className:"stat-icon",children:a.jsx("span",{className:"material-icons","aria-hidden":"true",children:"logout"})}),a.jsx("div",{className:"stat-value",children:L.dimessi}),a.jsx("div",{className:"stat-label",children:"Dimessi"})]}),d.reparto&&void 0!==L.perReparto&&a.jsxs("div",{className:"patient-stat-card",children:[a.jsx("div",{className:"stat-icon",children:a.jsx("span",{className:"material-icons","aria-hidden":"true",children:"business"})}),a.jsx("div",{className:"stat-value",children:L.perReparto}),a.jsxs("div",{className:"stat-label",children:["In ",d.reparto]})]})]}),a.jsxs("section",{className:"patient-filters-card",role:"search","aria-label":"Filtri ricerca pazienti",children:[a.jsxs("div",{className:"patient-filters-header",children:[a.jsxs("div",{className:"filters-title-wrapper",children:[a.jsx("span",{className:"material-icons","aria-hidden":"true",children:"filter_list"}),a.jsx("h2",{className:"filters-title",children:"Filtri Ricerca"})]}),Q>0&&a.jsxs("span",{className:"active-filters-badge",children:[Q," attivi"]})]}),a.jsxs("div",{className:"patient-filters-body",children:[a.jsxs("div",{className:"row g-3 align-items-end patient-filters",children:[a.jsxs("div",{className:"col-12 col-md-6 col-xl-4",children:[a.jsx("label",{className:"form-label",htmlFor:"patient-search",children:"Cerca paziente"}),a.jsx("input",{ref:C,id:"patient-search",type:"search",className:"form-control",value:v,onChange:e=>{const a=e.target.value;f(a),K(a)},placeholder:"Nome, cognome, RAD..."})]}),a.jsxs("div",{className:"col-12 col-md-6 col-xl-4",children:[a.jsx("label",{className:"form-label",htmlFor:"patient-department",children:"Reparto"}),a.jsx(l,{id:"patient-department",value:d.reparto??"",options:[{value:"",label:"Tutti"},...(O?.repartoOptions??[]).map(e=>({value:e,label:e}))],onChange:e=>q({reparto:e||void 0}),placeholder:"Tutti"})]}),a.jsxs("div",{className:"col-12 col-md-6 col-xl-4",children:[a.jsx("label",{className:"form-label",htmlFor:"patient-diagnosis",children:"Diagnosi"}),a.jsx(l,{id:"patient-diagnosis",value:d.diagnosi??"",options:[{value:"",label:"Tutti"},...(O?.diagnosiOptions??[]).map(e=>({value:e.nome,label:e.nome}))],onChange:e=>q({diagnosi:e||void 0}),placeholder:"Tutti"})]}),a.jsxs("div",{className:"col-12 col-md-6 col-xl-4",children:[a.jsx("label",{className:"form-label",htmlFor:"patient-status",children:"Stato"}),a.jsx(l,{id:"patient-status",value:d.stato??"",options:(O?.statusOptions??[]).map(e=>({value:e.value??"",label:e.label})),onChange:e=>q({stato:e||void 0}),placeholder:"Tutti"})]})]}),a.jsx("div",{className:"filters-actions",children:a.jsxs(c,{variant:"outline-secondary",onClick:W,children:[a.jsx("span",{className:"material-icons me-1","aria-hidden":"true",children:"refresh"}),"Resetta Filtri"]})})]})]}),a.jsxs("section",{className:"mb-3",children:[a.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2",children:[a.jsx(xa,{filters:d,onClearFilter:e=>{"search"===e&&f(""),u({[e]:void 0})}}),E&&E.totalCount>0&&a.jsxs("div",{className:"text-muted small",children:["Mostrando ",a.jsx("strong",{children:E.patients.length})," di ",a.jsx("strong",{children:E.totalCount}),E.totalCount>10&&a.jsxs("span",{children:[" (pagina ",(d.page??0)+1," di ",E.totalPages,")"]})]})]}),a.jsxs("div",{className:"sort-controls-card",children:[a.jsxs("div",{className:"sort-selector",children:[a.jsx("label",{className:"sort-control-label",id:"sort-selector-label",children:"Ordina per:"}),a.jsx("div",{className:"sort-selector-buttons",role:"group","aria-labelledby":"sort-selector-label",children:Ca.map(e=>{const t=d.sortColumn===e.value,i=t?"asc"===d.sortDirection?"arrow_upward":"arrow_downward":"unfold_more",n=t?"asc"===d.sortDirection?"in ordine crescente":"in ordine decrescente":"senza ordine applicato";return a.jsxs("button",{type:"button",className:"btn sort-selector-button"+(t?" sort-selector-button--active":""),onClick:()=>(e=>{h(e)})(e.value),"aria-pressed":t,"aria-label":`Ordina per ${e.label} ${n}`,children:[e.label,a.jsxs("span",{className:"visually-hidden",children:[" ",n]}),a.jsx("span",{className:"material-icons","aria-hidden":"true",children:i})]},e.value)})})]}),E&&E.totalCount>0&&a.jsxs("div",{className:"export-controls",children:[a.jsx("label",{className:"sort-control-label",id:"export-controls-label",children:"Esporta:"}),a.jsxs("div",{className:"export-buttons",role:"group","aria-labelledby":"export-controls-label",children:[a.jsx("button",{type:"button",className:"btn btn-outline-secondary export-button",onClick:()=>H("csv"),disabled:null!==N,children:a.jsxs(a.Fragment,"csv"===N?{children:[a.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"}),a.jsx("span",{children:"CSV"})]}:{children:[a.jsx("span",{className:"material-icons","aria-hidden":"true",children:"download"}),a.jsx("span",{children:"CSV"})]})}),a.jsx("button",{type:"button",className:"btn btn-outline-secondary export-button",onClick:()=>H("json"),disabled:null!==N,children:a.jsxs(a.Fragment,"json"===N?{children:[a.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"}),a.jsx("span",{children:"JSON"})]}:{children:[a.jsx("span",{className:"material-icons","aria-hidden":"true",children:"code"}),a.jsx("span",{children:"JSON"})]})})]})]})]})]}),k&&a.jsx("div",{className:"alert alert-danger",children:"Errore nel caricamento."}),a.jsx(wa,{patients:E?.patients??[],loading:$||A,onDelete:e=>{U("Conferma Eliminazione",`Sei sicuro di voler eliminare il paziente ${e.nome} ${e.cognome}?`,()=>M.mutate(e.id))},onDischarge:e=>{U("Conferma Dimissione",`Sei sicuro di voler dimettere il paziente ${e.nome} ${e.cognome}?`,()=>V.mutate(e.id))},onReactivate:e=>{U("Conferma Riattivazione",`Sei sicuro di voler riattivare il paziente ${e.nome} ${e.cognome}?`,()=>B.mutate(e.id))},onEdit:e=>{sessionStorage.setItem("editPazienteId",e.id),t("/inserimento")},onAddIntervention:e=>J("add-intervention",e),onAddInfection:e=>J("add-infection",e),onViewEvents:e=>J("view-events",e),onResetFilters:W,showActions:!0}),E&&E.totalPages>1&&a.jsx("nav",{className:"patient-pagination",children:a.jsxs("ul",{className:"pagination mb-0",children:[a.jsx("li",{className:"page-item "+(E.hasPrevPage?"":"disabled"),children:a.jsx("button",{className:"page-link",onClick:()=>G("prev"),disabled:!E.hasPrevPage,children:"‹"})}),a.jsx("li",{className:"page-item active",children:a.jsxs("span",{className:"page-link",children:["Pagina ",(d.page??0)+1," di ",E.totalPages]})}),a.jsx("li",{className:"page-item "+(E.hasNextPage?"":"disabled"),children:a.jsx("button",{className:"page-link",onClick:()=>G("next"),disabled:!E.hasNextPage,children:"›"})})]})})]})},Ia={attivo:"Attivi",dimesso:"Dimessi"},Pa={dimissione:"Dimissioni",trasferimento_interno:"Trasferimenti interni",trasferimento_esterno:"Trasferimenti esterni",decesso:"Decessi"},$a=["dimissione","trasferimento_interno","trasferimento_esterno","decesso"],Ta={true:"Sì",false:"No"},ka=[{value:void 0,label:"Tutti"},{value:"true",label:Ta.true},{value:"false",label:Ta.false}];function Ra(e){if(!e)return Da;const a=[{value:void 0,label:"Tutti"}];return e.hasActive&&a.push({value:"attivo",label:Ia.attivo}),e.hasDimesso&&a.push({value:"dimesso",label:Ia.dimesso}),a.length>1?a:Da}function Aa(e){if(!e||0===e.length)return Sa;const a=Array.from(new Set(e));return a.sort((e,a)=>$a.indexOf(e)-$a.indexOf(a)),[{value:void 0,label:"Tutti"},...a.map(e=>({value:e,label:Pa[e]??e}))]}function La(e){if(!e||0===e.length)return ka;const a=Array.from(new Set(e)),t=["true","false"].filter(e=>a.includes(e)),i=[{value:void 0,label:"Tutti"}];return t.forEach(e=>{i.push({value:e,label:Ta[e]})}),i}const Oa=t.memo(Ea),Fa=Object.freeze(Object.defineProperty({__proto__:null,PatientListPage:Ea,default:Oa},Symbol.toStringTag,{value:"Module"})),Ma=[{value:"dimissione",label:"Dimissione"},{value:"trasferimento_interno",label:"Trasferimento interno"},{value:"trasferimento_esterno",label:"Trasferimento esterno"},{value:"decesso",label:"Decesso"}],Va=[{value:"0",label:"0 - Ordinaria"},{value:"6",label:"6 - Protetta"}],Ba=[{value:"",label:"Seleziona..."},{value:"56",label:"56 - Riabilitazione Motoria"},{value:"60",label:"60 - Lunga Degenza"}],qa=[{value:"",label:"Seleziona..."},{value:"Cardiologia",label:"Cardiologia"},{value:"CR1",label:"CR1"},{value:"CR3",label:"CR3"},{value:"Gastroenterologia",label:"Gastroenterologia"},{value:"Ginecologia",label:"Ginecologia"},{value:"Medicina Interna",label:"Medicina Interna"},{value:"Neurologia",label:"Neurologia"},{value:"Pediatria",label:"Pediatria"},{value:"Pneumologia",label:"Pneumologia"},{value:"UGI",label:"UGI"},{value:"Urologia",label:"Urologia"}],Wa={data_dimissione:"",tipo_dimissione:"dimissione",codice_dimissione:"0"},Ka=({onSubmit:t,onCancel:i,isSubmitting:n})=>{const[s,o]=e.useState(Wa),d=e.useRef(null),m=e=>a=>{o("tipo_dimissione"===e?t=>{const i={...t,[e]:a};return"dimissione"===a?i.codice_dimissione="0":"trasferimento_esterno"===a?i.codice_dimissione="3":"trasferimento_interno"!==a&&"decesso"!==a||(i.codice_dimissione=null),i}:t=>({...t,[e]:a}))};return a.jsxs("form",{id:"discharge-form",ref:d,onSubmit:async e=>{e.preventDefault(),n||t(s)},className:"d-flex flex-column gap-3",children:[a.jsx(r,{value:s.data_dimissione,onChange:e=>{o(a=>({...a,data_dimissione:e||""}))},label:"Data dimissione",placeholder:"gg/mm/aaaa",isRequired:!0,allowInput:!0,clearable:!0}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",htmlFor:"dismissal-type",children:"Tipo dimissione"}),a.jsx(l,{id:"dismissal-type",value:s.tipo_dimissione,options:Ma.map(e=>({value:e.value,label:e.label})),onChange:m("tipo_dimissione"),placeholder:"Seleziona..."})]}),"dimissione"===s.tipo_dimissione&&a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",htmlFor:"dismissal-code",children:"Codice dimissione"}),a.jsx(l,{id:"dismissal-code",value:s.codice_dimissione??"",options:Va.map(e=>({value:e.value,label:e.label})),onChange:m("codice_dimissione"),placeholder:"Seleziona..."})]}),"trasferimento_interno"===s.tipo_dimissione&&a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",htmlFor:"dismissal-dept",children:"Reparto destinazione"}),a.jsx(l,{id:"dismissal-dept",value:s.reparto_destinazione??"",options:qa.map(e=>({value:e.value,label:e.label})),onChange:m("reparto_destinazione"),placeholder:"Seleziona..."})]}),"trasferimento_esterno"===s.tipo_dimissione&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",htmlFor:"dismissal-clinic",children:"Clinica destinazione"}),a.jsx("input",{id:"dismissal-clinic",name:"clinica_destinazione",className:"form-control",value:s.clinica_destinazione??"",onChange:e=>{const{name:a,value:t}=e.target;o(e=>({...e,[a]:t}))}})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",htmlFor:"dismissal-clinic-code",children:"Codice clinica"}),a.jsx(l,{id:"dismissal-clinic-code",value:s.codice_clinica??"",options:Ba.map(e=>({value:e.value,label:e.label})),onChange:m("codice_clinica"),placeholder:"Seleziona..."})]})]}),a.jsxs("div",{className:"d-flex gap-2",children:[a.jsx(c,{type:"submit",disabled:n,children:"Conferma dimissione"}),a.jsx(c,{type:"button",variant:"secondary",onClick:i,children:"Annulla"})]})]})};const Ga=()=>{const t=D(),[o,r]=e.useState(""),[l,d]=e.useState(null),m=e.useCallback(()=>{t("/list")},[t]),{data:u=[],isLoading:p,refetch:h}=n({queryKey:["patients","search",o],queryFn:()=>async function(e,a={}){const t=e.trim();return t?da.searchPatients(t,a.activeOnly??!1,a.limit??50):[]}(o,{activeOnly:!0,limit:20}),enabled:!!o.trim()}),g=e.useMemo(()=>Boolean(l),[l]),v=i(),f=s({mutationFn:({patientId:e,data:a})=>da.dischargePatientWithTransfer(e,a),onSuccess:()=>{T("Dimissione registrata con successo"),d(null),v.invalidateQueries({queryKey:["patients"]}),v.invalidateQueries({queryKey:["patients","search"]})},onError:e=>{I(e.message||"Errore durante la dimissione")}});return a.jsxs("div",{className:"discharge-page-container",children:[a.jsx("div",{className:"discharge-hero",children:a.jsx("div",{className:"discharge-hero-content",children:a.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-3",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"discharge-title",children:"Dimissioni Paziente"}),a.jsx("p",{className:"discharge-subtitle",children:"Cerca un paziente e registra i dati di dimissione o trasferimento"})]}),a.jsxs("button",{type:"button",className:"discharge-back-button",onClick:m,"aria-label":"Torna alla lista",children:[a.jsx("span",{className:"material-icons align-middle me-1",children:"arrow_back"}),a.jsx("span",{className:"back-button-text",children:"Torna alla lista"})]})]})})}),a.jsx("div",{className:"row",children:a.jsxs("div",{className:"col-12 col-lg-10 col-xl-8 mx-auto",children:[a.jsxs("div",{className:"discharge-main-card",children:[a.jsx("div",{className:"discharge-card-header",children:a.jsxs("div",{className:"discharge-card-title-wrapper",children:[a.jsx("div",{className:"discharge-card-icon",children:a.jsx("span",{className:"material-icons",children:"person_search"})}),a.jsx("h2",{className:"discharge-card-title",children:"Dimissione Paziente"})]})}),a.jsxs("div",{className:"discharge-card-body",children:[a.jsxs("div",{className:"discharge-search-section",children:[a.jsx("div",{className:"search-header",children:a.jsx("h3",{className:"search-section-title",children:"Ricerca Paziente"})}),a.jsxs("div",{className:"search-body",children:[a.jsxs("div",{className:"row g-3 align-items-end",children:[a.jsxs("div",{className:"col-md-8",children:[a.jsx("label",{className:"form-label",htmlFor:"discharge-search",children:"Cerca paziente"}),a.jsx("input",{id:"discharge-search",type:"search",className:"form-control",value:o,onChange:e=>r(e.target.value),placeholder:"Inserisci nome o cognome"})]}),a.jsx("div",{className:"col-md-4",children:a.jsx(c,{variant:"primary",onClick:()=>h(),disabled:p||!o.trim(),children:p?"Ricerca...":"Cerca"})})]}),u.length>0&&a.jsx("div",{className:"patient-results-list",children:u.map(e=>a.jsxs("div",{className:"patient-result-item",children:[a.jsxs("div",{className:"patient-info",children:[a.jsx("div",{className:"patient-icon",children:a.jsx("span",{className:"material-icons",children:"person"})}),a.jsxs("div",{className:"patient-details",children:[a.jsxs("div",{className:"patient-name",children:[e.nome," ",e.cognome]}),e.reparto_appartenenza&&a.jsx("div",{className:"patient-department",children:e.reparto_appartenenza})]})]}),a.jsx(c,{size:"sm",onClick:()=>(e=>{const a=u.find(a=>a.id===e)??null;d(a),r("")})(e.id),children:"Seleziona"})]},e.id))})]})]}),g&&a.jsxs("div",{className:"discharge-form-section",children:[a.jsxs("div",{className:"form-header",children:[a.jsx("h3",{className:"form-section-title",children:"Registra Dimissione"}),a.jsxs("div",{className:"selected-patient-badge",children:[a.jsx("span",{className:"material-icons",children:"person"}),a.jsx("span",{children:a.jsxs("strong",{children:[l?.nome," ",l?.cognome]})})]})]}),a.jsx("div",{className:"form-body",children:a.jsx(Ka,{patientId:l.id,onSubmit:e=>f.mutate({patientId:l.id,data:e}),onCancel:()=>d(null),isSubmitting:f.isPending})})]}),!g&&a.jsxs("div",{className:"discharge-empty-state-inline",children:[a.jsx("div",{className:"empty-icon",children:a.jsx("span",{className:"material-icons",children:"person_search"})}),a.jsx("div",{className:"empty-title",children:"Nessun paziente selezionato"}),a.jsx("p",{className:"empty-description",children:"Seleziona un paziente dalla ricerca per procedere con la dimissione."})]})]})]}),a.jsx("div",{className:"discharge-help-card card",children:a.jsxs("div",{className:"card-body",children:[a.jsxs("div",{className:"discharge-help-header",children:[a.jsx("div",{className:"help-icon",children:a.jsx("span",{className:"material-icons",children:"info"})}),a.jsx("h3",{className:"help-title",children:"Informazioni"})]}),a.jsxs("ul",{className:"discharge-help-list",children:[a.jsx("li",{children:"Cerca il paziente per nome o cognome"}),a.jsx("li",{children:"Seleziona il paziente dalla lista dei risultati"}),a.jsx("li",{children:"Compila i dati di dimissione o trasferimento"}),a.jsx("li",{children:"La dimissione non può essere registrata per pazienti già dimessi"})]})]})})]})})]})},Ua=Object.freeze(Object.defineProperty({__proto__:null,DischargePage:Ga,default:Ga},Symbol.toStringTag,{value:"Module"}));const Ja=new class{cache=new Map;timeout=3e5;get(e){const a=this.cache.get(e);return a&&Date.now()-a.timestamp<this.timeout?a.data:(a&&this.cache.delete(e),null)}set(e,a){this.cache.set(e,{data:a,timestamp:Date.now()})}clear(){this.cache.clear()}cleanup(){const e=Date.now();for(const[a,t]of this.cache.entries())e-t.timestamp>this.timeout&&this.cache.delete(a)}},Ha={activeOnly:!1,maxResults:10,minSearchLength:2,debounceDelay:300,enableCache:!0,cacheKey:"patient-search",enableDeduplication:!0};const Qa=({value:t,onChange:i,placeholder:n="Cerca paziente...",className:s="",disabled:o=!1,required:r=!1,activeOnly:l=!1,maxResults:c=10,minSearchLength:d=2,debounceDelay:m=300,showPatientInfo:u=!0,highlightMatch:p=!0})=>{const h=e.useId(),g=`patient-autocomplete-${h}`,v=`patient-autocomplete-list-${h}`,f=e.useRef(null),x=e.useRef(null),b=e.useRef(null),[_,y]=e.useState(!1),[z,j]=e.useState(-1),[w,D]=e.useState(""),[S,C]=e.useState({top:0,left:0,width:0}),{searchTerm:I,setSearchTerm:P,results:$,loading:T,error:k,clearSearch:R}=function(a={}){const t={...Ha,...a},{activeOnly:i,maxResults:n,minSearchLength:s,debounceDelay:o,enableCache:r,cacheKey:l,enableDeduplication:c}=t,[d,m]=e.useState(""),[u,p]=e.useState([]),[h,g]=e.useState(!1),[v,f]=e.useState(null),[x,b]=e.useState({hits:0,misses:0}),_=e.useRef(),y=e.useRef(null),z=e.useRef(""),j=e.useCallback(async e=>{if(e===z.current)return;z.current=e,y.current&&y.current.abort(),y.current=new AbortController;const{signal:a}=y.current;if(!e||e.trim().length<s)return p([]),f(null),g(!1),void 0;const t=e.trim();g(!0),f(null);try{let e;if(r){const e=Ja.get(`${l}:${t}:${i}:${n}`);if(e)return E.log("[usePatientAutocomplete] Cache hit for:",t),p(e),b(e=>({...e,hits:e.hits+1})),g(!1),void 0;b(e=>({...e,misses:e.misses+1}))}const s=async()=>da.searchPatients(t,i,n);c?(E.log("[usePatientAutocomplete] Using deduplication for search:",{deduplicationKey:`patient-search:${t}:${i}:${n}`}),e=await B.executeRequest(`patient-search:${t}:${i}:${n}`,s,{signal:a})):(E.log("[usePatientAutocomplete] Direct search without deduplication"),e=await s()),a.aborted||(E.group("[usePatientAutocomplete] Search results DEBUG"),E.log("Risultati ricevuti:",{term:t,resultsCount:e.length,fromCache:!1,activeOnly:i,maxResults:n,enableDeduplication:c,sampleResults:e.slice(0,3).map(e=>({id:e.id,nome:e.nome,cognome:e.cognome,codice_rad:e.codice_rad}))}),r&&e.length>0&&(Ja.set(`${l}:${t}:${i}:${n}`,e),E.log("Results cached")),p(e),0===e.length&&f(`Nessun paziente trovato per "${t}"`))}catch(o){if(!a.aborted){const e=o instanceof Error?o.message:"Errore durante la ricerca";f(e),p([]),E.error("[usePatientAutocomplete] Search error:",o)}}finally{a.aborted||g(!1)}},[i,n,s,r,l,c]),w=e.useCallback(e=>{m(e),_.current&&clearTimeout(_.current),_.current=window.setTimeout(()=>{j(e)},o)},[j,o]),N=e.useCallback(()=>{m(""),p([]),f(null),z.current="",_.current&&clearTimeout(_.current),y.current&&y.current.abort()},[]),D=e.useCallback(()=>{d&&j(d)},[d,j]);return e.useEffect(()=>()=>{_.current&&clearTimeout(_.current),y.current&&y.current.abort()},[]),e.useEffect(()=>{r&&Ja.clear()},[i,n,r,l]),{searchTerm:d,setSearchTerm:w,results:u,loading:h,error:v,clearSearch:N,refetch:D,cacheStats:x}}({activeOnly:l,maxResults:c,minSearchLength:d,debounceDelay:m,enableCache:!0,cacheKey:"patient-autocomplete",enableDeduplication:!0});e.useEffect(()=>{if(t){D(`${t.cognome} ${t.nome}`)}else D("")},[t]),e.useEffect(()=>{const e=e=>{const a=e.target,t=f.current&&f.current.contains(a),i=b.current&&b.current.contains(a);t||i||(y(!1),j(-1))};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),e.useEffect(()=>{if(_&&x.current){const e=x.current.getBoundingClientRect();C({top:e.top+e.height,left:e.left,width:e.width})}},[_]);const A=e.useMemo(()=>$.slice(0,c),[$,c]),L=e.useCallback((e,t)=>{if(!p||!t.trim())return e;const i=new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return e.split(i).map((e,t)=>i.test(e)?a.jsx("mark",{className:"bg-warning text-dark",children:e},t):e)},[p]),O=e.useCallback(e=>{const a=e.target.value;D(a),(a.toLowerCase().includes("olak")||a.toLowerCase().includes("kozak"))&&(E.group("[PatientAutocomplete] DEBUG SEARCH FOR OLAK/KOZAK"),E.log("Input value:",a),E.log("Min search length:",d),E.log("Will trigger search:",a.trim().length>=d),E.groupEnd()),P(a),a.trim().length>=d?(y(!0),j(-1)):(y(!1),j(-1)),a.trim()||i(null)},[P,d,i]),F=e.useCallback(e=>{i(e),y(!1),j(-1),E.log("[PatientAutocomplete] Patient selected:",{id:e.id,name:`${e.cognome} ${e.nome}`})},[i]),M=e.useCallback(e=>{if(!_||0===A.length)return"ArrowDown"===e.key&&I.trim().length>=d&&(y(!0),j(0)),void 0;switch(e.key){case"ArrowDown":e.preventDefault(),j(e=>e<A.length-1?e+1:0);break;case"ArrowUp":e.preventDefault(),j(e=>e>0?e-1:A.length-1);break;case"Enter":e.preventDefault(),z>=0&&A[z]&&F(A[z]);break;case"Escape":e.preventDefault(),y(!1),j(-1),x.current?.blur()}},[_,A,z,I,d,F]),V=e.useCallback(()=>{I.trim().length>=d&&A.length>0&&y(!0)},[I,d,A.length]),q=e.useCallback(()=>{D(""),P(""),y(!1),j(-1),i(null),R()},[P,i,R]),W=e.useCallback(e=>L(`${e.cognome} ${e.nome}`,I),[I,L]),K=e.useCallback(e=>{const a=[];if(e.codice_rad&&a.push(`RAD: ${e.codice_rad}`),e.reparto_appartenenza&&a.push(e.reparto_appartenenza),e.data_ricovero){const t=new Date(e.data_ricovero);a.push(`Ric: ${t.toLocaleDateString("it-IT")}`)}return a.join(" • ")},[]);return e.useEffect(()=>{if(z>=0&&b.current){const e=b.current.children[z];e&&e.scrollIntoView({block:"nearest"})}},[z]),e.useEffect(()=>{if(!_||!b.current)return;const e=e=>{e.stopPropagation(),e.preventDefault();const a=e.currentTarget,t=b.current?.querySelectorAll('li[role="option"]');if(t){const e=Array.from(t).indexOf(a);e>=0&&A[e]&&F(A[e])}};let a=0;const t=()=>{if(!b.current)return;const i=b.current.querySelectorAll('li[role="option"]');i.length>0?i.forEach(a=>{a.addEventListener("click",e,!1)}):a<10&&(a++,setTimeout(t,50))};return t(),()=>{if(b.current){b.current.querySelectorAll('li[role="option"]').forEach(a=>{a.removeEventListener("click",e,!1)})}}},[_,A,F]),a.jsxs("div",{className:`patient-autocomplete position-relative ${s}`,ref:f,children:[a.jsxs("div",{className:"input-group",children:[a.jsx("input",{ref:x,id:g,type:"text",className:"form-control "+(o?"bg-light":""),placeholder:n,value:w,onChange:O,onKeyDown:M,onFocus:V,disabled:o,required:r,role:"combobox","aria-controls":v,"aria-expanded":_,"aria-autocomplete":"list","aria-busy":T,"aria-describedby":k?`${g}-error`:void 0}),w&&!o&&a.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:q,"aria-label":"Cancella ricerca",children:a.jsx("i",{className:"bi bi-x-lg"})}),T&&a.jsx("span",{className:"input-group-text",children:a.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"})})]}),k&&a.jsx("div",{id:`${g}-error`,className:"form-text text-danger mt-1",children:k}),_&&N.createPortal(a.jsxs("ul",{ref:b,id:v,className:"list-group shadow-sm",style:{position:"fixed",top:`${S.top}px`,left:`${S.left}px`,width:`${S.width}px`,maxHeight:"300px",overflowY:"auto",zIndex:9999,backgroundColor:"white",borderRadius:"0.25rem",border:"1px solid #dee2e6"},role:"listbox",children:[T&&a.jsxs("li",{className:"list-group-item text-muted",role:"presentation",children:[a.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Ricerca in corso..."]}),!T&&0===A.length&&I.trim().length>=d&&a.jsxs("li",{className:"list-group-item text-muted text-center py-3",role:"presentation",children:[a.jsx("i",{className:"bi bi-person-x fs-4 d-block mb-2"}),'Nessun paziente trovato per "',a.jsx("strong",{children:I}),'"']}),!T&&A.map((e,i)=>a.jsx("li",{role:"option",className:`list-group-item list-group-item-action cursor-pointer ${i===z?"active":""} ${t?.id===e.id?"border-primary":""}`,onMouseEnter:()=>j(i),"aria-selected":i===z,"data-patient-index":i,children:a.jsx("div",{className:"d-flex justify-content-between align-items-start",children:a.jsxs("div",{className:"flex-grow-1",children:[a.jsxs("div",{className:"fw-semibold",children:[W(e),t?.id===e.id&&a.jsx("i",{className:"bi bi-check-circle-fill text-primary ms-2","aria-label":"Selezionato"})]}),u&&a.jsx("div",{className:"small text-muted mt-1",children:K(e)}),e.diagnosi&&a.jsxs("div",{className:"small text-muted mt-1",children:[a.jsx("i",{className:"bi bi-clipboard2-pulse me-1"}),e.diagnosi]})]})})},e.id))]}),document.body)]})},Ya=e=>{const{data:a,isLoading:t,error:i}=n({queryKey:["patient",e],queryFn:async()=>{if(!e)return null;try{const a=await da.getPatientById(e);if(a){const t={id:a.id,nome:a.nome,cognome:a.cognome};return E.info("Patient loaded successfully",{patientId:e}),t}return E.warn("Patient not found",{patientId:e}),$("Paziente non trovato",{duration:3e3}),null}catch(a){const t=a instanceof Error?a:new Error(String(a));throw E.error("Error loading patient data",{patientId:e,error:t}),I("Errore nel caricamento del paziente",{duration:5e3}),t}},enabled:!!e,staleTime:3e5});return{patient:a||null,loading:t,error:i instanceof Error?i:null}};class Za{infectionData=null;isValid=!1;validationErrors=[];constructor(){this.infectionData=null,this.isValid=!1,this.validationErrors=[]}setInfectionData(e){if(!e)return this.clearInfectionData(),void 0;this.infectionData={data_evento:e.data_evento||"",agente_patogeno:e.agente_patogeno||"",descrizione:e.descrizione||"",timestamp:Date.now()},this.validateInfectionData(this.infectionData)}getInfectionData(){return this.infectionData?{...this.infectionData}:null}clearInfectionData(){this.infectionData=null,this.isValid=!1,this.validationErrors=[]}hasValidInfectionData(){return null!==this.infectionData&&this.isValid}hasInfectionData(){return null!==this.infectionData}validateInfectionData(e){if(this.validationErrors=[],!e)return this.isValid=!1,!1;if(e.data_evento){const a=new Date(e.data_evento),t=new Date;t.setHours(23,59,59,999),isNaN(a.getTime())?this.validationErrors.push({field:"data_evento",message:"Formato data non valido"}):a>t&&this.validationErrors.push({field:"data_evento",message:"La data dell'infezione non può essere futura"})}else this.validationErrors.push({field:"data_evento",message:"La data dell'infezione è obbligatoria"});return e.agente_patogeno&&""!==e.agente_patogeno.trim()?e.agente_patogeno.trim().length<2?this.validationErrors.push({field:"agente_patogeno",message:"L'agente patogeno deve contenere almeno 2 caratteri"}):e.agente_patogeno.length>100&&this.validationErrors.push({field:"agente_patogeno",message:"L'agente patogeno non può superare i 100 caratteri"}):this.validationErrors.push({field:"agente_patogeno",message:"L'agente patogeno è obbligatorio"}),e.descrizione&&e.descrizione.length>500&&this.validationErrors.push({field:"descrizione",message:"La descrizione non può superare i 500 caratteri"}),this.isValid=0===this.validationErrors.length,this.isValid}getValidationErrors(){return[...this.validationErrors]}getFieldErrors(e){return this.validationErrors.filter(a=>a.field===e)}hasFieldError(e){return this.validationErrors.some(a=>a.field===e)}getStatus(){return{hasData:this.hasInfectionData(),isValid:this.isValid,errorCount:this.validationErrors.length,timestamp:this.infectionData?.timestamp||null}}cleanupExpiredData(){if(this.infectionData&&this.infectionData.timestamp){const e=Date.now()-36e5;if(this.infectionData.timestamp<e)return this.clearInfectionData(),!0}return!1}}const Xa=new Za,et=Object.freeze(Object.defineProperty({__proto__:null,InfectionDataManager:Za,default:Xa},Symbol.toStringTag,{value:"Module"}));const at=new class{surgeryData=null;constructor(){this.surgeryData=null}setSurgeryData(e){this.surgeryData=e?{...e}:null}getSurgeryData(){return this.surgeryData?{...this.surgeryData}:null}clearSurgeryData(){this.surgeryData=null}hasSurgeryData(){return null!==this.surgeryData&&"object"==typeof this.surgeryData}hasValidSurgeryData(){if(!this.hasSurgeryData())return!1;return 0===this.getValidationErrors().length}getValidationErrors(){const e=[];if(!this.hasSurgeryData())return e.push({field:"general",message:"Nessun dato di intervento presente"}),e;const a=this.surgeryData;if(a.data_evento&&""!==String(a.data_evento).trim()||e.push({field:"data_evento",message:"Data intervento obbligatoria"}),a.tipo_intervento&&""!==String(a.tipo_intervento).trim()||e.push({field:"tipo_intervento",message:"Tipo intervento obbligatorio"}),a.data_evento)try{const t=new Date(a.data_evento),i=new Date;i.setHours(23,59,59,999),isNaN(t.getTime())?e.push({field:"data_evento",message:"Formato data intervento non valido"}):t>i&&e.push({field:"data_evento",message:"La data dell'intervento non può essere nel futuro"})}catch(t){e.push({field:"data_evento",message:"Errore nella validazione della data intervento"})}if(a.has_infection)if(a.data_infezione&&""!==String(a.data_infezione).trim())try{const t=new Date(String(a.data_infezione)),i=new Date(String(a.data_evento));isNaN(t.getTime())?e.push({field:"data_infezione",message:"Formato data infezione non valido"}):t<i&&e.push({field:"data_infezione",message:"La data dell'infezione non può essere precedente all'intervento"})}catch(t){e.push({field:"data_infezione",message:"Errore nella validazione della data infezione"})}else e.push({field:"data_infezione",message:"Data infezione obbligatoria se si indica un'infezione"});return e}prepareSurgeryEventData(){if(!this.hasValidSurgeryData())return null;const e=this.getSurgeryData();return e?{tipo_evento:"intervento",data_evento:e.data_evento,tipo_intervento:e.tipo_intervento||"",descrizione:e.descrizione||null}:null}prepareInfectionEventData(){if(!this.hasValidSurgeryData()||!this.surgeryData?.has_infection)return null;const e=this.getSurgeryData();return e&&e.data_infezione?{tipo_evento:"infezione",data_evento:e.data_infezione,agente_patogeno:e.agente_patogeno||null,descrizione:e.descrizione_infezione||null}:null}hasAssociatedInfection(){return this.hasSurgeryData()&&!0===this.surgeryData?.has_infection&&!!this.surgeryData?.data_infezione}getDataSummary(){if(!this.hasSurgeryData())return{hasData:!1};const e=this.surgeryData,a=this.getValidationErrors();return{hasData:!0,isValid:0===a.length,errorCount:a.length,dataIntervento:e.data_evento||"Non specificata",tipoIntervento:e.tipo_intervento||"Non specificato",hasInfection:e.has_infection||!1,dataInfezione:e.data_infezione||"Non specificata",agentePatogeno:e.agente_patogeno||"Non specificato"}}},tt=Object.freeze(Object.defineProperty({__proto__:null,default:at},Symbol.toStringTag,{value:"Module"}));export{Ua as D,Qa as P,ua as a,Fa as b,Ya as u};
