import{s as e,a as t,n as a}from"./index-C8Q0S6p5.js";import{g as i,p as n}from"./helpers-CWDmnvVa.js";import{_ as r}from"./supabase-AmyKTmiY.js";import o from"./CustomDatepicker-6By5cdaM.js";import{i as s,u as l}from"./CustomSelect-BqvyF0SR.js";import"./vendor-BU6HxVpN.js";import"./utils-BtSsRyB2.js";async function c(){try{const[e,t,a]=await Promise.all([i("reparto_appartenenza"),i("reparto_provenienza"),i("diagnosi")]);return{repartoOptions:e,provenienzaOptions:t,diagnosiOptions:a}}catch(e){throw console.error("Errore nel recuperare le opzioni dei filtri:",e),new Error("Impossibile caricare le opzioni per i filtri.")}}const d=Object.freeze(Object.defineProperty({__proto__:null,getChartData:async function(t){let a=e.from("pazienti").select("diagnosi");t.reparto&&(a=a.eq("reparto_appartenenza",t.reparto)),t.provenienza&&(a=a.eq("reparto_provenienza",t.provenienza)),t.diagnosi&&(a=a.eq("diagnosi",t.diagnosi)),t.assistenza&&(a=a.eq("livello_assistenza",t.assistenza)),"true"===t.infetto&&(a=a.eq("infetto",!0)),"false"===t.infetto&&(a=a.eq("infetto",!1)),t.startDate&&(a=a.gte("data_ricovero",t.startDate)),t.endDate&&(a=a.lte("data_ricovero",t.endDate));const{data:i,error:n}=await a;if(n)throw console.error("Errore nel recuperare i dati del grafico:",n),new Error("Impossibile caricare i dati per il grafico.");return(i||[]).filter(e=>e&&"object"==typeof e&&e.diagnosi&&null!==e.diagnosi&&""!==String(e.diagnosi).trim())},getFilterOptionsForChart:c},Symbol.toStringTag,{value:"Module"}));class h{constructor(){}hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?`${parseInt(t[1],16)}, ${parseInt(t[2],16)}, ${parseInt(t[3],16)}`:"13, 110, 253"}showMobileDetailModal(e){const a=document.getElementById("mobile-chart-detail-modal");a&&a.remove();const i=new Intl.NumberFormat("it-IT"),n=`${i.format(Number(e.value??0))} pazienti`,r=`${i.format(Number(e.total??0))} pazienti`;let o;if("number"==typeof e?.percentage)o=e.percentage;else if("string"==typeof e?.percentage){const t=e.percentage.replace("%","").replace(",","."),a=parseFloat(t);o=Number.isFinite(a)?a:void 0}void 0===o&&Number.isFinite(Number(e.value))&&Number.isFinite(Number(e.total))&&Number(e.total)>0&&(o=Number(e.value)/Number(e.total)*100);const s=Number.isFinite(o)?`${new Intl.NumberFormat("it-IT",{minimumFractionDigits:1,maximumFractionDigits:1}).format(o)}%`:"-",l=document.createElement("div");l.id="mobile-chart-detail-modal",l.className="chart-modal",l.setAttribute("role","dialog"),l.setAttribute("aria-modal","true"),l.setAttribute("aria-labelledby","mobile-chart-modal-title"),l.setAttribute("aria-describedby","mobile-chart-modal-desc"),l.innerHTML=t(this._getMobileModalTemplate(e,{valueLabel:n,percentLabel:s,totalLabel:r})),document.body.appendChild(l);const c=document.activeElement,d=l.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'),h=d[0],u=d[d.length-1],p=l.querySelector(".chart-modal-close"),m=l.querySelector(".chart-modal-ok"),g=()=>{l.style.animation="modalSlideOut 0.2s ease-in forwards",setTimeout(()=>{l.parentNode&&l.remove(),document.removeEventListener("keydown",f),c&&"function"==typeof c.focus&&c.focus()},200)},f=e=>{if("Escape"===e.key)return e.preventDefault(),g(),void 0;"Tab"===e.key&&d.length&&(e.shiftKey?document.activeElement===h&&(e.preventDefault(),u.focus()):document.activeElement===u&&(e.preventDefault(),h.focus()))};return p&&p.addEventListener("click",g),m&&m.addEventListener("click",g),l.addEventListener("click",e=>{e.target===l&&g()}),document.addEventListener("keydown",f),h&&"function"==typeof h.focus&&h.focus(),l}showDesktopDetailPanel(e){const a=document.getElementById("desktop-chart-detail-panel");a&&a.remove();const i=document.getElementById("desktop-chart-detail-modal");i&&i.remove();const n=document.createElement("div");n.id="desktop-chart-detail-modal",n.className="chart-modal",n.setAttribute("role","dialog"),n.setAttribute("aria-modal","true"),n.setAttribute("aria-labelledby","chart-modal-title"),n.setAttribute("aria-describedby","chart-modal-desc"),n.innerHTML=t(this._getDesktopPanelTemplate(e)),document.body.appendChild(n);const r=document.activeElement,o=n.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'),s=o[0],l=o[o.length-1],c=n.querySelector(".chart-modal-close"),d=()=>{n.style.animation="modalFadeOut 0.2s ease-in forwards",setTimeout(()=>{n.parentNode&&n.remove(),document.removeEventListener("keydown",h),r&&"function"==typeof r.focus&&r.focus()},200)},h=e=>{if("Escape"===e.key)return e.preventDefault(),d(),void 0;"Tab"===e.key&&o.length&&(e.shiftKey?document.activeElement===s&&(e.preventDefault(),l.focus()):document.activeElement===l&&(e.preventDefault(),s.focus()))};return c&&c.addEventListener("click",d),document.addEventListener("keydown",h),n.addEventListener("click",e=>{e.target===n&&d()}),s&&"function"==typeof s.focus&&s.focus(),n}_getMobileModalTemplate(e,a){return`\n      <div class="chart-modal-content" style="border-top: 4px solid ${e.color};" >\n        <div class="chart-modal-header">\n          <h3 id="mobile-chart-modal-title">Dettagli Grafico</h3>\n          <button class="chart-modal-close" aria-label="Chiudi">&times;</button>\n        </div>\n        <div class="chart-modal-body" id="mobile-chart-modal-desc">\n          <div class="chart-detail-card">\n            <h4 class="diagnosis-name">${t(String(e.label))}</h4>\n            <div class="stats-container">\n              <div class="stat-item">\n                <span class="stat-value">${a.valueLabel}</span>\n                <span class="stat-label">Pazienti</span>\n              </div>\n              <div class="stat-item">\n                <span class="stat-value">${a.percentLabel}</span>\n                <span class="stat-label">Percentuale</span>\n              </div>\n            </div>\n            <div class="additional-info">\n              <div class="info-row">\n                <span class="info-label">Totale complessivo</span>\n                <span class="info-value">${a.totalLabel}</span>\n              </div>\n            </div>\n            <div class="actions">\n              <button class="chart-modal-ok" aria-label="OK">OK</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}_getDesktopPanelTemplate(e){const a=new Intl.NumberFormat("it-IT"),i=`${a.format(Number(e.value??0))} pazienti`,n=`${a.format(Number(e.total??0))} pazienti`;let r;if("number"==typeof e?.percentage)r=e.percentage;else if("string"==typeof e?.percentage){const t=e.percentage.replace("%","").replace(",","."),a=parseFloat(t);r=Number.isFinite(a)?a:void 0}void 0===r&&Number.isFinite(Number(e.value))&&Number.isFinite(Number(e.total))&&Number(e.total)>0&&(r=Number(e.value)/Number(e.total)*100);const o=Number.isFinite(r)?`${new Intl.NumberFormat("it-IT",{minimumFractionDigits:1,maximumFractionDigits:1}).format(r)}%`:"-";return`\n      <div class="chart-modal-content" style="border-top: 4px solid ${e.color};">\n        <div class="chart-modal-header">\n          <h3 id="chart-modal-title">Dettagli Grafico</h3>\n          <button class="chart-modal-close" aria-label="Chiudi">&times;</button>\n        </div>\n        <div class="chart-modal-body">\n          <div class="chart-detail-vertical">\n            <div class="chart-detail-color" style="background-color: ${e.color}"></div>\n            <div class="chart-detail-info" id="chart-modal-desc">\n              <h4>${t(String(e.label))}</h4>\n              <p class="chart-detail-value">${i}</p>\n              <p class="chart-detail-percentage">${o} del totale</p>\n            </div>\n          </div>\n          <div class="chart-detail-additional">\n            <p><strong>Totale complessivo:</strong> ${n}</p>\n          </div>\n        </div>\n      </div>\n    `}}class u{constructor(){this._ensureStylesLoaded(),this.activeToasts=[]}_ensureStylesLoaded(){}showToast(e,t="info",a="desktop",i=3e3){this._removeExistingToasts(t);const n=document.createElement("div"),r=`chart-toast-${Date.now()}`;n.id=r,n.className=`chart-toast ${t} ${a}-chart-toast`,n.setAttribute("role","alert"),n.setAttribute("aria-live","assertive"),n.textContent=e,document.body.appendChild(n),this.activeToasts.push({id:r,element:n,type:t,timer:null});const o=setTimeout(()=>{this._removeToast(r)},i),s=this.activeToasts.findIndex(e=>e.id===r);return-1!==s&&(this.activeToasts[s].timer=o),n.addEventListener("click",()=>{this._removeToast(r)}),n}showSuccessToast(e,t="desktop",a=3e3){return this.showToast(e,"success",t,a)}showErrorToast(e,t="desktop",a=4e3){return this.showToast(e,"error",t,a)}showInfoToast(e,t="desktop",a=3e3){return this.showToast(e,"info",t,a)}showWarningToast(e,t="desktop",a=4e3){return this.showToast(e,"warning",t,a)}_removeToast(e){const t=this.activeToasts.findIndex(t=>t.id===e);if(-1!==t){const e=this.activeToasts[t];e.timer&&clearTimeout(e.timer),e.element.style.animation="toastFadeOut 0.3s ease-in forwards",setTimeout(()=>{e.element.parentNode&&e.element.remove(),this.activeToasts.splice(t,1)},300)}}_removeExistingToasts(e){this.activeToasts.filter(t=>t.type===e).forEach(e=>{this._removeToast(e.id)})}removeAllToasts(){[...this.activeToasts].forEach(e=>{this._removeToast(e.id)})}}class p{static throttle(e,t){let a;return function(){a||(e.apply(this,arguments),a=!0,setTimeout(()=>a=!1,t))}}static debounce(e,t){let a;return function(){const i=this,n=arguments;clearTimeout(a),a=setTimeout(()=>e.apply(i,n),t)}}static safeClone(e){if(null===e||"object"!=typeof e)return e;try{return JSON.parse(JSON.stringify(e))}catch(t){return console.warn("Errore durante il deep clone, utilizzo shallow copy:",t),Array.isArray(e)?[...e]:{...e}}}static calculatePercentage(e,t,a=1){return 0===t?"0%":(e/t*100).toFixed(a)+"%"}static generateUniqueId(e="chart"){return`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}static isElementInViewport(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}static formatNumber(e,t="it-IT"){return new Intl.NumberFormat(t).format(e)}static getDatasetColor(e,t){return e?Array.isArray(e.backgroundColor)?e.backgroundColor[t]||e.borderColor||"#36A2EB":e.backgroundColor||e.borderColor||"#36A2EB":"#36A2EB"}static calculateTotal(e){return Array.isArray(e)?e.reduce((e,t)=>e+(Number(t)||0),0):0}}class m{constructor(){this.modals=new h,this.toasts=new u}adaptOptions(e){const t=p.safeClone(e);t.plugins=t.plugins||{},t.interaction=t.interaction||{};const a=e.type||e.plugins&&e.plugins.type||null;if(t.plugins.legend=this._getLegendOptions(a),t.plugins.title=this._getTitleOptions(t.plugins?.title,a),t.plugins.tooltip=this._getTooltipOptions(t.plugins?.tooltip),t.interaction=this._getInteractionOptions(),"pie"===a||"doughnut"===a||"polarArea"===a){if(t.layout=t.layout||{},t.plugins&&t.plugins.legend&&t.plugins.legend.labels){const e=t.plugins.legend.labels,a=e.font||{};e.font={...a,size:Math.min(12,a.size||14)},e.boxWidth=Math.min(16,e.boxWidth||20),e.padding=Math.min(8,e.padding||20)}let a;t.plugins&&t.plugins.legend&&(t.plugins.legend.padding=8,t.plugins.legend.fullSize=!1);try{const e=document.getElementById("chart-container")||("undefined"!=typeof window?window.document?.querySelector(".chart-container"):null);a=e?.clientWidth||("undefined"!=typeof window?window.innerWidth:void 0)}catch{}const i=this._estimateLegendWidth(e?.data?.labels||[],t.plugins?.legend?.labels?.font?.size||13,t.plugins?.legend?.labels?.boxWidth||18,20)+520;if("right"===(t.plugins?.legend?.position||"right")&&a&&a<i)t.plugins.legend.position="bottom",t.plugins.legend.align="center",t.layout.padding={top:16,right:0,left:0,bottom:0},t.plugins.title&&(t.plugins.title.align=t.plugins.title.align||"center",t.plugins.title.padding=Math.max(28,t.plugins.title.padding||24));else{const e=t.layout.padding||{};t.layout.padding={...e,right:Math.max(8,e.right||0),top:Math.max(12,e.top||0)}}}return t.plugins.zoom=this._getZoomOptions(),t.maintainAspectRatio=!1,t.responsive=!0,t.animation={duration:1e3,easing:"easeOutQuart",delay:e=>50*e.dataIndex},t.onHover=this._getHoverHandler(),t.onClick=this._getClickHandler(),t}adaptLayout(e){e.classList.remove("chart-mobile","chart-tablet"),e.classList.add("chart-desktop"),e.style.minHeight="500px",e.style.height="80vh",this._optimizeContainer(e)}_getLegendOptions(e){return"bar"===e||"line"===e?{display:!0,position:"top",align:"center",padding:8,fullSize:!1,labels:{boxWidth:12,font:{size:12},padding:6,usePointStyle:!0,maxWidth:void 0,maxHeight:void 0,generateLabels:function(e){const t=e.data;return t.labels.length&&t.datasets.length?t.labels.map((a,i)=>{const n=p.getDatasetColor(t.datasets[0],i);return{text:a,fillStyle:n,strokeStyle:n,lineWidth:0,pointStyle:"circle",hidden:!e.getDataVisibility(i),index:i}}):[]}},onClick:(e,t,a)=>{const i=a.chart;i.toggleDataVisibility(t.index),i.update()}}:{position:"right",align:"start",padding:8,fullSize:!1,labels:{boxWidth:16,font:{size:13},padding:8,usePointStyle:!0,generateLabels:function(e){const t=e.data;return t.labels.length&&t.datasets.length?t.labels.map((a,i)=>{const n=p.getDatasetColor(t.datasets[0],i);return{text:a,fillStyle:n,strokeStyle:n,lineWidth:0,pointStyle:"circle",hidden:!e.getDataVisibility(i),index:i}}):[]}},onClick:(e,t,a)=>{const i=t.index,n=a.chart;n.toggleDataVisibility(i),n.update();const r=n.canvas.parentNode;if(r){const e=r.querySelector(`.chart-legend-item-${i}`);e&&e.classList.toggle("filtered")}}}}_getTitleOptions(e={},t=null){return{...e,display:!1}}_getTooltipOptions(e={}){return{...e,enabled:!1,mode:"index",intersect:!1,backgroundColor:"rgba(0, 0, 0, 0.9)",titleFont:{size:16,weight:"bold"},bodyFont:{size:14},padding:16,cornerRadius:8,displayColors:!0,callbacks:{...e?.callbacks,title:function(e){return e[0].label||""},label:function(e){const t=e.dataset.label||"",a=e.parsed||e.raw,i=p.calculateTotal(e.dataset.data);return[`${t}: ${a}`,`Percentuale: ${p.calculatePercentage(a,i)}`]},afterBody:function(e){return[`Totale: ${e[0].dataset.data.reduce((e,t)=>e+t,0)}`,"Click per esplorare"]}},animation:{duration:150}}}_getInteractionOptions(){return{mode:"index",intersect:!1,includeInvisible:!1}}_getZoomOptions(){return{zoom:{wheel:{enabled:!0,speed:.1},pinch:{enabled:!0},mode:"xy",onZoom:function(){const e=document.querySelector(".chart-container");e&&(e.classList.add("zooming"),setTimeout(()=>{e.classList.remove("zooming")},300))}},pan:{enabled:!0,mode:"xy",threshold:10}}}_getHoverHandler(){return(e,t,a)=>{if(e.native&&(e.native.target.style.cursor=t.length>0?"pointer":"default"),t.length>0&&t[0]&&a&&a.canvas&&a.canvas.parentNode){const e=t[0].index,i=a.canvas.parentNode.querySelectorAll(".chart-legend-item");i&&i[e]&&(i.forEach(e=>e.classList.remove("highlighted")),i[e].classList.add("highlighted"))}}}_getClickHandler(){return(e,t,a)=>{if(t.length>0&&t[0]){if(a){const e=t[0].index,i=a.data,n=i.datasets[0],r=p.getDatasetColor(n,e),o=p.calculateTotal(n.data),s=p.calculatePercentage(n.data[e],o);this.modals.showDesktopDetailPanel({label:i.labels[e],value:n.data[e],color:r,total:o,percentage:s,chart:a})}}}}_optimizeContainer(e){e.style.padding="0.5rem",e.style.minHeight||(e.style.minHeight="500px"),e.classList.add("chart-desktop-optimized")}_estimateLegendWidth(e=[],t=13,a=18,i=20){if(!e.length)return 140;const n=Math.max(6,Math.min(9,Math.round(.62*t))),r=e.reduce((e,t)=>Math.max(e,(t||"").length),0);return Math.max(120,Math.min(260,a+8+r*n+i))}showNotification(e,t="info"){this.toasts.showToast(e,t,"desktop",3e3)}}class g{constructor(){this.modals=new h,this.toasts=new u,this.lastTouchEnd=0}adaptOptions(e){const t=p.safeClone(e),a=t?.type||e?.type;return t.plugins=t.plugins||{},t.interaction=t.interaction||{},t.plugins.legend=this._getLegendOptions(a),t.plugins.title=this._getTitleOptions(t.plugins?.title),t.plugins.tooltip=this._getTooltipOptions(t.plugins?.tooltip),t.interaction=this._getInteractionOptions(),t.maintainAspectRatio=!1,t.responsive=!0,t.devicePixelRatio=window.devicePixelRatio||1,t.animation={duration:800,easing:"easeOutQuart"},t.onHover=this._getHoverHandler(),t.onClick=this._getClickHandler(),t}adaptLayout(e){e.classList.remove("chart-tablet","chart-desktop"),e.classList.add("chart-mobile"),e.style.minHeight="300px",e.style.height="60vh",this._optimizeContainer(e),this._setupTouchControls(e)}_getLegendOptions(e){return{position:"bar"===e||"line"===e?"top":"bottom",align:"center",labels:{boxWidth:15,font:{size:12},padding:15,usePointStyle:!0,generateLabels:function(e){const t=e.data;return t.labels.length&&t.datasets.length?t.labels.map((a,i)=>{const n=p.getDatasetColor(t.datasets[0],i);return{text:a,fillStyle:n,strokeStyle:n,lineWidth:0,pointStyle:"circle",hidden:!e.getDataVisibility(i),index:i}}):[]}},onClick:(e,t,a)=>{const i=a.chart;i.toggleDataVisibility(t.index),i.update()}}}_getTitleOptions(e={}){return{...e,font:{size:16,weight:"bold"},padding:20}}_getTooltipOptions(e={}){return{...e,enabled:!1,mode:"nearest",intersect:!1,backgroundColor:"rgba(0, 0, 0, 0.9)",titleFont:{size:14,weight:"bold"},bodyFont:{size:13},padding:15,cornerRadius:8,displayColors:!0,borderColor:"rgba(255, 255, 255, 0.1)",borderWidth:1,caretPadding:10,callbacks:{...e?.callbacks,title:function(e){return e[0].label||""},label:function(e){const t=e.dataset.label||"",a=e.parsed||e.raw,i=p.calculateTotal(e.dataset.data);return[`${t}: ${a}`,`Percentuale: ${p.calculatePercentage(a,i)}`]},afterLabel:function(e){return"Tocca per dettagli"}},animation:{duration:300}}}_getInteractionOptions(){return{mode:"nearest",intersect:!1,includeInvisible:!1}}_getHoverHandler(){return(e,t)=>{t.length>0?(e.native.target.style.cursor="pointer",navigator.vibrate&&navigator.vibrate(10)):e.native.target.style.cursor="default"}}_getClickHandler(){return(e,t)=>{if(t.length>0){navigator.vibrate&&navigator.vibrate(20);const a=t[0].index,i=e.chart.data,n=i.datasets[0],r=p.getDatasetColor(n,a);this.modals.showMobileDetailModal({label:i.labels[a],value:n.data[a],color:r,total:p.calculateTotal(n.data)})}}}_optimizeContainer(e){e.style.touchAction="manipulation",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.webkitTouchCallout="none",e.style.willChange="transform",e.style.backfaceVisibility="hidden",e.style.padding="0.5rem",e.style.minHeight||(e.style.minHeight="300px"),e.classList.add("chart-mobile-optimized")}_setupTouchControls(e){let t=0,a=0,i=0,n=0;e.addEventListener("touchstart",e=>{e.changedTouches&&e.changedTouches.length>0&&(t=e.changedTouches[0].screenX,a=e.changedTouches[0].screenY)},{passive:!0}),e.addEventListener("touchend",e=>{e.changedTouches&&e.changedTouches.length>0&&(i=e.changedTouches[0].screenX,n=e.changedTouches[0].screenY,this._handleSwipeGesture(t,a,i,n))},{passive:!0}),e.addEventListener("touchend",e=>{const t=(new Date).getTime(),a=t-this.lastTouchEnd;a<300&&a>0&&e.preventDefault(),this.lastTouchEnd=t})}_handleSwipeGesture(e,t,a,i){const n=a-e,r=i-t;Math.abs(n)>Math.abs(r)&&Math.abs(n)>50&&this._triggerChartTypeChange(n>0?"previous":"next")}_triggerChartTypeChange(e){const t=new CustomEvent("chartTypeChange",{detail:{direction:e}});document.dispatchEvent(t),this.toasts.showInfoToast("next"===e?"Prossimo tipo di grafico":"Tipo di grafico precedente","mobile",2e3)}showNotification(e,t="info"){this.toasts.showToast(e,t,"mobile",3e3)}}class f{constructor(){this.modals=new h,this.toasts=new u}adaptOptions(e){const t=p.safeClone(e),a=t?.type||e?.type;return t.plugins=t.plugins||{},t.interaction=t.interaction||{},t.plugins.legend=this._getLegendOptions(a),t.plugins.title=this._getTitleOptions(t.plugins?.title),t.plugins.tooltip=this._getTooltipOptions(t.plugins?.tooltip),t.interaction=this._getInteractionOptions(),t.maintainAspectRatio=!1,t.responsive=!0,t.devicePixelRatio=window.devicePixelRatio||1,t.animation={duration:900,easing:"easeOutQuart"},t.onHover=this._getHoverHandler(),t.onClick=this._getClickHandler(),t}adaptLayout(e){e.classList.remove("chart-mobile","chart-desktop"),e.classList.add("chart-tablet"),e.style.minHeight="400px",e.style.height="70vh",this._optimizeContainer(e)}_getLegendOptions(e){return{position:"bar"===e||"line"===e?"top":"bottom",align:"center",padding:8,fullSize:!1,labels:{boxWidth:14,font:{size:14},padding:8,usePointStyle:!0,generateLabels:function(e){const t=e.data;return t.labels.length&&t.datasets.length?t.labels.map((a,i)=>{const n=p.getDatasetColor(t.datasets[0],i);return{text:a,fillStyle:n,strokeStyle:n,lineWidth:0,pointStyle:"circle",hidden:!e.getDataVisibility(i),index:i}}):[]}},onClick:(e,t,a)=>{const i=t.index,n=a.chart;n.toggleDataVisibility(i),n.update();const r=!n.getDataVisibility(i);this.toasts.showInfoToast(`${r?"Nascosto":"Mostrato"}: ${n.data.labels[i]}`,"tablet",2e3)}}}_getTitleOptions(e={}){return{...e,font:{size:18,weight:"bold"},padding:16}}_getTooltipOptions(e={}){return{...e,enabled:!1,mode:"index",intersect:!1,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:15,weight:"bold"},bodyFont:{size:14},padding:15,cornerRadius:8,callbacks:{...e?.callbacks,title:function(e){return e[0].label||""},label:function(e){const t=e.dataset.label||"",a=e.parsed||e.raw,i=p.calculateTotal(e.dataset.data);return[`${t}: ${a}`,`Percentuale: ${p.calculatePercentage(a,i)}`]}}}}_getInteractionOptions(){return{mode:"index",intersect:!1}}_getHoverHandler(){return(e,t)=>{e.native&&(e.native.target.style.cursor=t.length>0?"pointer":"default")}}_getClickHandler(){return(e,t)=>{if(t.length>0){const a=t[0].index,i=e.chart.data,n=i.datasets[0],r=p.getDatasetColor(n,a);this.modals.showMobileDetailModal({label:i.labels[a],value:n.data[a],color:r,total:p.calculateTotal(n.data)})}}}_optimizeContainer(e){e.style.willChange="transform",e.style.padding="0.25rem",e.style.minHeight||(e.style.minHeight="400px"),e.classList.add("chart-tablet-optimized")}showNotification(e,t="info"){this.toasts.showToast(e,t,"tablet",3e3)}}class b{constructor(e={mobile:767,tablet:991,desktop:1200}){this.breakpoints=e,this.currentDevice=this.detectDevice(),this.resizeListeners=[],this._setupResizeListener()}detectDevice(){try{if("undefined"==typeof window)return console.warn("Window non disponibile, impossibile rilevare il dispositivo"),"desktop";const t=window.innerWidth||document.documentElement.clientWidth||1024,a=window.innerHeight||document.documentElement.clientHeight||768,i=this.breakpoints&&"number"==typeof this.breakpoints.mobile?this.breakpoints.mobile:767,n=this.breakpoints&&"number"==typeof this.breakpoints.tablet?this.breakpoints.tablet:991;let r=!1;try{r="ontouchstart"in window||window.navigator&&navigator.maxTouchPoints>0}catch(e){console.warn("Errore nel rilevamento touch:",e)}return t<=i?"mobile":t<=n?r&&!(a>t)&&t<=1024?"mobile":"tablet":"desktop"}catch(t){return console.error("Errore durante il rilevamento del dispositivo:",t),"desktop"}}isMobile(){return"mobile"===this.detectDevice()}isTablet(){return"tablet"===this.detectDevice()}isDesktop(){return"desktop"===this.detectDevice()}isTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0}isPortrait(){return window.innerHeight>window.innerWidth}isLandscape(){return window.innerWidth>window.innerHeight}onDeviceChange(e){if("function"!=typeof e)throw new Error("Il callback deve essere una funzione");return this.resizeListeners.push(e),()=>{this.resizeListeners=this.resizeListeners.filter(t=>t!==e)}}_setupResizeListener(){if("undefined"==typeof window||null==window||"function"!=typeof window.addEventListener||null==window.addEventListener)return console.warn("Window/addEventListener non disponibile, impossibile configurare i listener di resize"),void 0;const e=((e,t)=>{let a;return function(){const i=arguments,n=this;if(!a){try{e.apply(n,i)}catch(r){console.error("Errore nella funzione throttled:",r)}a=!0,setTimeout(()=>a=!1,t)}}})(()=>{try{const e=this.currentDevice;this.currentDevice=this.detectDevice(),e!==this.currentDevice&&Array.isArray(this.resizeListeners)&&this.resizeListeners.forEach(t=>{if("function"==typeof t)try{t(this.currentDevice,e)}catch(a){console.error("Errore durante l'esecuzione del listener di resize:",a)}})}catch(e){console.error("Errore durante la gestione del resize:",e)}},250);try{window.addEventListener("resize",e),window.addEventListener("orientationchange",e)}catch(t){console.error("Errore durante l'aggiunta dei listener di resize:",t)}}}class v{constructor(e={mobile:767,tablet:991,desktop:1200}){this.deviceDetector=new b(e),this.adapters={mobile:null,tablet:null,desktop:null}}createAdapter(){const e=this.deviceDetector.detectDevice();return this.getAdapterForDevice(e)}getAdapterForDevice(e){if(this.adapters[e])return this.adapters[e];switch(e){case"mobile":return this.adapters.mobile=new g,this.adapters.mobile;case"tablet":return this.adapters.tablet=new f,this.adapters.tablet;default:return this.adapters.desktop=new m,this.adapters.desktop}}onDeviceChange(e){return this.deviceDetector.onDeviceChange(e)}getCurrentDeviceType(){return this.deviceDetector.detectDevice()}isMobile(){return this.deviceDetector.isMobile()}isTablet(){return this.deviceDetector.isTablet()}isDesktop(){return this.deviceDetector.isDesktop()}}class y{constructor(e={mobile:767,tablet:991,desktop:1200}){this.adapterFactory=new v(e),this.currentAdapter=this.adapterFactory.createAdapter(),this.currentDevice=this.adapterFactory.getCurrentDeviceType(),this.resizeHandler=null,this.unsubscribeDeviceChange=null}adaptOptions(e){return this.currentAdapter.adaptOptions(e)}adaptLayout(e){this.currentAdapter.adaptLayout(e)}handleResize(e,t){if(this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),"function"==typeof this.unsubscribeDeviceChange){try{this.unsubscribeDeviceChange()}catch(r){console.warn("Errore durante unsubscribe device change:",r)}this.unsubscribeDeviceChange=null}this.resizeHandler=p.throttle(()=>{const a=this.adapterFactory.getCurrentDeviceType();if(a!==this.currentDevice){this.currentDevice=a,this.currentAdapter=this.adapterFactory.getAdapterForDevice(this.currentDevice),e.canvas&&e.canvas.parentNode&&this.adaptLayout(e.canvas.parentNode);const i=this.adaptOptions(t),{scales:n,...r}=e.options||{};e.options={...r,...i},e.update()}else"function"==typeof e.resize?e.resize():"function"==typeof e.update&&e.update("none")},250),window.addEventListener("resize",this.resizeHandler),this.unsubscribeDeviceChange=this.adapterFactory.onDeviceChange(a=>{this.currentAdapter=this.adapterFactory.getAdapterForDevice(a),e.canvas&&e.canvas.parentNode&&this.adaptLayout(e.canvas.parentNode);const i=this.adaptOptions(t),{scales:n,...r}=e.options||{};e.options={...r,...i},e.update()}),e&&e.canvas&&e.canvas.parentNode&&this.adaptLayout(e.canvas.parentNode);const a=this.adaptOptions(t),{scales:i,...n}=e.options||{};e.options={...n,...a},e.update()}showMobileDetailModal(e){this.currentAdapter&&this.currentAdapter.modals?this.currentAdapter.modals.showMobileDetailModal(e):console.warn("Modal non disponibile: currentAdapter o modals non inizializzato")}showDesktopDetailPanel(e){this.currentAdapter&&this.currentAdapter.modals?this.currentAdapter.modals.showDesktopDetailPanel(e):console.warn("Panel non disponibile: currentAdapter o modals non inizializzato")}showNotification(e,t="info"){this.currentAdapter?this.currentAdapter.showNotification(e,t):console.warn("Notifica non disponibile: currentAdapter non inizializzato")}getCurrentDevice(){return this.currentDevice}isMobile(){return this.adapterFactory.isMobile()}isTablet(){return this.adapterFactory.isTablet()}isDesktop(){return this.adapterFactory.isDesktop()}detectDevice(){return this.adapterFactory.getCurrentDeviceType()}implementMobileResponsiveLayout(e,t){console.warn("implementMobileResponsiveLayout è deprecato. Utilizzare adaptLayout() invece."),this.adapterFactory.isMobile()&&this.adaptLayout(e)}implementDesktopResponsiveLayout(e,t){console.warn("implementDesktopResponsiveLayout è deprecato. Utilizzare adaptLayout() invece."),this.adapterFactory.isDesktop()&&this.adaptLayout(e)}cleanup(){if(console.warn("cleanup è deprecato. Le risorse vengono gestite automaticamente."),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),"function"==typeof this.unsubscribeDeviceChange){try{this.unsubscribeDeviceChange()}catch(e){console.warn("Errore durante unsubscribe device change:",e)}this.unsubscribeDeviceChange=null}}}class w{constructor(e){this.Chart=e,this.chartTypes={pie:{name:"Torta",renderer:this.renderPieChart.bind(this),icon:'<span class="material-icons">pie_chart</span>'},bar:{name:"Barre",renderer:this.renderBarChart.bind(this),icon:'<span class="material-icons">bar_chart</span>'},line:{name:"Linee",renderer:this.renderLineChart.bind(this),icon:'<span class="material-icons">show_chart</span>'}},this.currentType="pie",this.currentChart=null}setChartType(e){return!!this.chartTypes[e]&&(this.currentType=e,!0)}renderChart(e,t,a={},i){this.currentChart&&(this.currentChart.destroy(),this.currentChart=null),this.setChartType(i);return this.currentChart=(0,this.chartTypes[this.currentType].renderer)(e,t,a),this.currentChart}createCanvas(e){e.innerHTML="";const t=document.createElement("canvas");return t.width=e.clientWidth,t.height=e.clientHeight,e.appendChild(t),t}prepareChartData(e){if(e&&"object"==typeof e&&e.labels&&e.datasets)return{labels:e.labels,values:e.datasets[0].data};if(Array.isArray(e)){if(e.length>0&&Array.isArray(e[0])){const[t,...a]=e;return{labels:a.map(e=>e[0]),values:a.map(e=>e[1])}}if(e.length>0&&"object"==typeof e[0]){return{labels:e.map(e=>e.label||e.diagnosi||e.name||"Non specificato"),values:e.map(e=>e.value||e.count||1)}}}return console.warn("Formato dati non riconosciuto in prepareChartData:",e),{labels:[],values:[]}}renderPieChart(e,a,i={}){const n=this.createCanvas(e).getContext("2d"),{labels:r,values:o}=this.prepareChartData(a),s=o.reduce((e,t)=>e+t,0),l={labels:r,datasets:[{data:o,backgroundColor:this.generateColorPalette(o.length),borderWidth:2,borderColor:"#fff",hoverOffset:20,hoverBorderWidth:3,hoverBorderColor:"#fff",percentages:o.map(e=>(e/s*100).toFixed(1))}]},c=i.chartType||i.type||"doughnut",d=this.mergeOptions({type:c,data:l,options:{responsive:!0,maintainAspectRatio:!1,cutout:"doughnut"===c?"60%":0,plugins:{legend:{position:"right",labels:{font:{size:14},generateLabels:e=>{const t=e.data;return t.labels.length&&t.datasets.length?t.labels.map((e,a)=>{const i=t.datasets[0],n=i.backgroundColor[a];return{text:`${e} (${i.percentages[a]}%)`,fillStyle:n,strokeStyle:n,lineWidth:0,hidden:!1,index:a}}):[]}},onClick:(e,t,a)=>{const i=t.index,n=a.chart,r=n.getDatasetMeta(0);r.data[i].hidden=!r.data[i].hidden,n.update()}},tooltip:{enabled:!1},datalabels:!1},hover:{mode:"nearest",intersect:!0},events:["mousemove","mouseout","click","touchstart","touchmove"],onHover:(e,a)=>{if(!e||!e.chart)return;const i=e.chart.canvas.parentElement.querySelector(".custom-pie-tooltip");if(i&&i.remove(),a&&a.length>0){const i=a[0],n=i.datasetIndex,r=i.index,o=e.chart.data.labels[r],s=e.chart.data.datasets[n].data[r],l=(s/e.chart.data.datasets[n].data.reduce((e,t)=>e+t,0)*100).toFixed(1),c=document.createElement("div");c.className="custom-pie-tooltip",c.style.cssText="\n              position: fixed;\n              background: rgba(0, 0, 0, 0.9);\n              color: white;\n              padding: 12px 16px;\n              border-radius: 8px;\n              font-size: 14px;\n              pointer-events: none;\n              box-shadow: 0 4px 12px rgba(0,0,0,0.5);\n              z-index: 9999;\n              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n              line-height: 1.4;\n              max-width: 200px;\n              word-wrap: break-word;\n            ",c.innerHTML=t('<div style="font-weight: bold; margin-bottom: 4px;">'+o+"</div><div>"+s+' pazienti</div><div style="font-size: 12px; opacity: 0.9;">'+l+"% del totale</div>");const d=e.native.clientX+10,h=e.native.clientY-10;c.style.left=d+"px",c.style.top=h+"px",document.body.appendChild(c);const u=c.getBoundingClientRect();d+u.width>window.innerWidth&&(c.style.left=d-u.width-20+"px"),h+u.height>window.innerHeight&&(c.style.top=h-u.height-20+"px")}},onLeave:e=>{document.querySelectorAll(".custom-pie-tooltip").forEach(e=>e.remove())},onClick:(e,a)=>{if(a&&a.length>0){const i=a[0],n=i.datasetIndex,r=i.index,o=e.chart.data.labels[r],s=e.chart.data.datasets[n].data[r],l=(s/e.chart.data.datasets[n].data.reduce((e,t)=>e+t,0)*100).toFixed(1);if(!document.querySelector(".custom-pie-tooltip")){const a=document.createElement("div");a.className="custom-pie-tooltip",a.style.cssText="position: fixed;background: rgba(0, 0, 0, 0.9);color: white;padding: 12px 16px;border-radius: 8px;font-size: 14px;pointer-events: none;box-shadow: 0 4px 12px rgba(0,0,0,0.5);z-index: 9999;font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;line-height: 1.4;",a.innerHTML=t('<div style="font-weight: bold; margin-bottom: 4px;">'+o+"</div><div>"+s+' pazienti</div><div style="font-size: 12px; opacity: 0.9;">'+l+"% del totale</div>");const i=e.native.clientY-10;a.style.left=e.native.clientX+10+"px",a.style.top=i+"px",document.body.appendChild(a),setTimeout(()=>{a.remove()},2e3)}}},animation:{animateRotate:!0,animateScale:!0,duration:800,easing:"easeOutQuart"}}},i);return new this.Chart(n,d)}renderBarChart(e,t,a={}){e.classList.add("bar-chart-container");const i=this.createCanvas(e).getContext("2d"),{labels:n,values:r}=this.prepareChartData(t),o=this.generateColorPalette(r.length),s=r.reduce((e,t)=>e+t,0),l={labels:n,datasets:[{label:a.datasetLabel||"Valori",data:r,backgroundColor:a.singleColor?"rgba(54, 162, 235, 0.7)":o,borderColor:a.singleColor?"rgba(54, 162, 235, 1)":o,borderWidth:1,borderRadius:4,hoverBorderWidth:2,hoverBorderColor:"#fff",percentages:r.map(e=>(e/s*100).toFixed(1))}]},c=this.mergeOptions({type:"bar",data:l,options:{responsive:!0,maintainAspectRatio:!1,indexAxis:a.horizontal?"y":"x",scales:{y:{beginAtZero:!0,ticks:{precision:0,font:{size:12}},grid:{display:!0,color:"rgba(0, 0, 0, 0.05)"}},x:{ticks:{maxRotation:45,minRotation:0,font:{size:12},autoSkip:!0,maxTicksLimit:15},grid:{display:!1}}},plugins:{legend:{display:!0,position:"right",labels:{font:{size:11},usePointStyle:!0,boxWidth:10,padding:8,boxHeight:10,color:"#333",generateLabels:e=>{const t=e.data;return t.labels.length&&t.datasets.length?t.labels.map((e,a)=>{const i=t.datasets[0].backgroundColor[a];return{text:e,fillStyle:i,strokeStyle:i,lineWidth:0,hidden:!1,index:a}}):[]}}},title:{display:!!a.title,text:a.title||"",font:{size:16,weight:"bold"},padding:{top:10,bottom:20}},tooltip:{enabled:!1,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:14,weight:"bold"},bodyFont:{size:13},padding:12,cornerRadius:6,displayColors:!0,callbacks:{title:e=>e[0].label||"",label:e=>{const t=e.parsed.y||e.parsed.x||0;return(e.dataset.label||"")+": "+t+" ("+(t/e.dataset.data.reduce((e,t)=>e+t,0)*100).toFixed(1)+"%)"},afterLabel:e=>{const t=e.dataset.data.reduce((e,t)=>e+t,0);return"Percentuale sul totale: "+(e.parsed.y/t*100).toFixed(1)+"%"}}},datalabels:!1},hover:{mode:"index",intersect:!1},animation:{duration:800,easing:"easeOutQuart",delay:e=>50*e.dataIndex}}},a);return new this.Chart(i,c)}renderLineChart(e,t,a={}){const i=this.createCanvas(e).getContext("2d"),{labels:n,values:r}=this.prepareChartData(t),o=this.mergeOptions({type:"line",data:{labels:n,datasets:[{label:a.datasetLabel||"Trend",data:r,fill:!1,borderColor:"rgba(75, 192, 192, 1)",tension:.1,pointBackgroundColor:"rgba(75, 192, 192, 1)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgba(75, 192, 192, 1)",pointRadius:5,pointHoverRadius:7}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{precision:0}}},plugins:{legend:{display:!0,position:"top"}},interaction:{mode:"index",intersect:!1}}},a);return new this.Chart(i,o)}mergeOptions(e,t){const a={...e};return t.type&&(a.type=t.type),t.data&&(a.data={...a.data,...t.data}),t.options&&(a.options={...a.options,...t.options},t.options.plugins&&a.options.plugins&&(a.options.plugins={...a.options.plugins,...t.options.plugins})),a}getAvailableChartTypes(){return Object.entries(this.chartTypes).map(([e,t])=>({id:e,name:t.name,icon:t.icon}))}updateChart(e,t={}){if(this.currentChart){if(e){const{labels:t,values:a}=this.prepareChartData(e);this.currentChart.data.labels=t,this.currentChart.data.datasets[0].data=a}t&&Object.keys(t).length>0&&(this.currentChart.options={...this.currentChart.options,...t}),this.currentChart.update()}}generateColorPalette(e){const t=["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40","#43e97b","#f9ea8f","#f67019","#a259f7","#e14eca","#00c9a7","#4d79ff","#ff4d4d","#ffcc00","#00cc99","#cc00cc","#3399ff","#ff9933","#00ffcc"];if(e<=t.length)return t.slice(0,e);const a=[...t],i=e-t.length;for(let n=0;n<i;n++){const e=this.hexToHSL(t[n%t.length]);e.h=(e.h+360/i*n)%360,a.push(this.hslToHex(e))}return a}hexToHSL(e){e=e.replace(/^#/,"");let t=parseInt(e.substring(0,2),16)/255,a=parseInt(e.substring(2,4),16)/255,i=parseInt(e.substring(4,6),16)/255;const n=Math.max(t,a,i),r=Math.min(t,a,i);let o=(n+r)/2,s=0;n!==r&&(s=o>.5?(n-r)/(2-n-r):(n-r)/(n+r));let l=0;return n!==r&&(l=n===t?(a-i)/(n-r)+(a<i?6:0):n===a?(i-t)/(n-r)+2:(t-a)/(n-r)+4,l*=60),{h:l,s:s,l:o}}hslToHex(e){const{h:t,s:a,l:i}=e,n=(1-Math.abs(2*i-1))*a,r=n*(1-Math.abs(t/60%2-1)),o=i-n/2;let s,l,c;return[s,l,c]=t<60?[n,r,0]:t<120?[r,n,0]:t<180?[0,n,r]:t<240?[0,r,n]:t<300?[r,0,n]:[n,0,r],s=Math.round(255*(s+o)).toString(16).padStart(2,"0"),l=Math.round(255*(l+o)).toString(16).padStart(2,"0"),c=Math.round(255*(c+o)).toString(16).padStart(2,"0"),"#"+s+l+c}cleanup(){this.currentChart&&(this.currentChart.destroy(),this.currentChart=null)}}class C{async exportAsImage(e,t="png",a={}){return new Promise((i,n)=>{try{if(!e||!e.canvas)throw new Error("Grafico non valido per l'esportazione");const r=document.createElement("canvas"),o=r.getContext("2d"),s=window.devicePixelRatio||1,l=e.canvas.width,c=e.canvas.height;if(r.width=l*s,r.height=c*s,o.scale(s,s),o.fillStyle="#ffffff",o.fillRect(0,0,l,c),o.drawImage(e.canvas,0,0,l,c),a&&Object.keys(a).length>0&&(o.fillStyle="#f8f9fa",o.fillRect(0,c-40,l,40),o.font="12px Arial",o.fillStyle="#6c757d",a.timestamp&&o.fillText(`Generato il: ${a.timestamp}`,10,c-25),a.filters)){const e=Object.entries(a.filters).filter(([e,t])=>t).map(([e,t])=>`${e}: ${t}`).join(", ");e&&o.fillText(`Filtri: ${e}`,10,c-10)}r.toBlob(e=>{e?i(e):n(new Error("Impossibile generare l'immagine"))},`image/${t}`,.95)}catch(r){n(r)}})}generateShareableLink(e,t){const a={...e,chartType:t},i=Object.fromEntries(Object.entries(a).filter(([e,t])=>null!=t&&""!==t)),n=new URLSearchParams(i).toString();return`${window.location.href.split("?")[0]}?${n}`}async shareViaEmail(e,t,i={}){try{const n=new FileReader;return new Promise((r,o)=>{n.onloadend=()=>{try{let e="Ecco il grafico richiesto.\n\n";if(i.timestamp&&(e+=`Generato il: ${i.timestamp}\n`),i.filters){const t=Object.entries(i.filters).filter(([e,t])=>t).map(([e,t])=>`${e}: ${t}`).join(", ");t&&(e+=`Filtri applicati: ${t}\n`)}const n=encodeURIComponent("Condivisione Grafico"),o=encodeURIComponent(e),s=`mailto:${t}?subject=${n}&body=${o}`;window.open(s),a.info("Si aprirà il tuo client email. Per allegare l'immagine del grafico, salva prima l'immagine usando la funzione \"Esporta come immagine\" e poi allegala manualmente all'email."),r(!0)}catch(e){o(e)}},n.onerror=()=>{o(new Error("Errore nella lettura dell'immagine"))},n.readAsDataURL(e)})}catch(n){throw console.error("Errore nella condivisione via email:",n),new Error("Impossibile condividere il grafico via email")}}downloadImage(e,t="grafico"){const a=document.createElement("a");a.href=URL.createObjectURL(e),a.download=`${t}.png`,document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(()=>{URL.revokeObjectURL(a.href)},100)}}function E(e,t){const a=document.createElement("div");a.className="alert alert-danger";const i=document.createElement("strong");i.textContent="Errore:",a.appendChild(i),a.appendChild(document.createTextNode(" "+t)),e.innerHTML="",e.appendChild(a)}const z=new class{constructor(){this.chartJsLoadPromise=null,this.chartJsRef=null,this.chartJsVersion="4.3.3",this.chartJsCdn=`https://cdn.jsdelivr.net/npm/chart.js@${this.chartJsVersion}/dist/chart.umd.js`,this.preloadLink=null,this.prefetchLink=null,this.loadStartTime=null,this.loadAttempts=0,this.maxRetries=3,this.retryDelay=1e3}prefetch(){this.prefetchLink||this.chartJsRef||(this.prefetchLink=document.createElement("link"),this.prefetchLink.rel="prefetch",this.prefetchLink.href=this.chartJsCdn,this.prefetchLink.as="script",document.head.appendChild(this.prefetchLink))}async load(){return this.chartJsRef?this.chartJsRef:(this.chartJsLoadPromise||(this.loadStartTime=performance.now(),this.loadAttempts++,this.prefetchLink&&(document.head.removeChild(this.prefetchLink),this.prefetchLink=null),this.chartJsLoadPromise=new Promise((e,t)=>{const a=document.createElement("script");a.src=this.chartJsCdn,a.async=!0,a.crossOrigin="anonymous",a.onload=()=>{if(this.chartJsRef=window.Chart,!this.chartJsRef)return t(new Error("Chart.js caricato ma non disponibile globalmente")),void 0;this.loadAttempts=0,this.loadStartTime=null,e(this.chartJsRef)},a.onerror=i=>{if(console.error("Errore nel caricamento di Chart.js:",i),a.parentNode&&a.parentNode.removeChild(a),this.loadAttempts<this.maxRetries){const a=this.retryDelay*Math.pow(2,this.loadAttempts-1);setTimeout(()=>{this.chartJsLoadPromise=null,this.load().then(e).catch(t)},a)}else this.chartJsLoadPromise=null,this.loadAttempts=0,this.loadStartTime=null,t(new Error(`Impossibile caricare Chart.js dopo ${this.maxRetries} tentativi: ${i.message}`))},document.head.appendChild(a)})),this.chartJsLoadPromise)}isLoaded(){return!!this.chartJsRef}isLoading(){return!!this.chartJsLoadPromise&&!this.chartJsRef}cleanup(){this.prefetchLink&&(document.head.removeChild(this.prefetchLink),this.prefetchLink=null),this.preloadLink&&(document.head.removeChild(this.preloadLink),this.preloadLink=null),this.chartJsLoadPromise=null,this.chartJsRef=null,this.loadAttempts=0,this.loadStartTime=null}},x=new class{constructor(e={}){this.cache=new Map,this.CACHE_EXPIRY_TIME=e.expiryTime||3e5,this.MAX_CACHE_SIZE=e.maxSize||20,this.cacheHits=0,this.cacheMisses=0,this.lastCleanup=Date.now(),this.CLEANUP_INTERVAL=6e5}generateKey(e,t,a){try{const i=JSON.stringify(e),n=JSON.stringify(t);return`${a}_${btoa(i+n).slice(0,20)}`}catch(i){return console.warn("Errore nella generazione della chiave cache:",i),`${a}_${Date.now()}`}}get(e){this._periodicCleanup();const t=this.cache.get(e);return t&&Date.now()-t.timestamp<this.CACHE_EXPIRY_TIME?(this.cacheHits++,t.data):(t&&this.cache.delete(e),this.cacheMisses++,null)}set(e,t){this.cache.size>=this.MAX_CACHE_SIZE&&this.evictOldestEntry(),this.cache.set(e,{data:t,timestamp:Date.now()})}evictOldestEntry(){let e=null,t=Date.now();for(const[a,i]of this.cache.entries())i.timestamp<t&&(t=i.timestamp,e=a);e&&this.cache.delete(e)}_periodicCleanup(){const e=Date.now();if(e-this.lastCleanup>this.CLEANUP_INTERVAL){this.lastCleanup=e;for(const[t,a]of this.cache.entries())e-a.timestamp>this.CACHE_EXPIRY_TIME&&this.cache.delete(t)}}clear(){this.cache.clear(),this.cacheHits=0,this.cacheMisses=0,this.lastCleanup=Date.now()}getStats(){return{size:this.cache.size,maxSize:this.MAX_CACHE_SIZE,hits:this.cacheHits,misses:this.cacheMisses,hitRatio:this.cacheHits+this.cacheMisses>0?(this.cacheHits/(this.cacheHits+this.cacheMisses)).toFixed(2):0,lastCleanup:new Date(this.lastCleanup).toLocaleString()}}},T=new class{handleDataLoadError(e,t,a){console.error("Errore nel caricamento dei dati:",e);if(E(t,`\n      <div class="chart-error">\n        <p>Si è verificato un errore nel caricamento dei dati: ${e.message}</p>\n        ${a?'<button class="btn btn-sm btn-primary retry-btn">Riprova</button>':""}\n      </div>\n    `),a&&t){const e=t.querySelector(".retry-btn");e&&e.addEventListener("click",a)}}handleRenderError(e,t,a={}){console.error("Errore nel rendering del grafico:",e),a.fallbackType?(!function(e,t,a="text-muted"){const i=document.createElement("p");i.className=`${a} text-center mt-5`,i.textContent=t,e.innerHTML="",e.appendChild(i)}(t,`Tentativo di renderizzare un grafico alternativo (${a.fallbackType})...`),a.fallbackCallback&&setTimeout(()=>{a.fallbackCallback(a.fallbackType)},500)):E(t,`Errore nel rendering del grafico: ${e.message}`)}handleExportError(e,t){console.error("Errore nell'esportazione del grafico:",e),t?t(`Si è verificato un errore durante l'esportazione: ${e.message}`):a.error(`Errore nell'esportazione del grafico: ${e.message}`)}};let k=null,L=null,D=null;async function S(){const e=await z.load();return k||(k=new w(e)),L||(L=new y),D||(D=new C),{chartTypeManager:k,responsiveAdapter:L,exportService:D,Chart:e}}function _(e,t){return(D||(D=new C),D).generateShareableLink(e,t)}async function A(e,a,i={},n="pie"){try{!function(e){e.innerHTML=t('<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary"></div></div>')}(e);const r=x.generateKey(a,i,n);x.get(r);const{chartTypeManager:o,responsiveAdapter:s}=await S();if(!o||!s)throw new Error("Componenti del grafico non inizializzati correttamente");o.setChartType(n),s.adaptLayout(e);const l={...i,type:n},c=s.adaptOptions(l),d=o.renderChart(e,a,{options:c},n);return s.handleResize(d,l),x.set(r,{data:a,options:i,chartType:n}),d}catch(r){throw console.error("Errore nella creazione del grafico:",r),T.handleRenderError(r,e,{fallbackType:"pie",fallbackCallback:t=>{try{if("pie"===t)return async function(e,t,a={}){return A(e,t,a,"pie")}(e,a,{...i,animation:!1,responsive:!0,maintainAspectRatio:!1})}catch(n){E(e,`Impossibile visualizzare il grafico: ${n.message}`)}}}),r}}function F(){L&&(L.cleanup(),L=null),k&&(k.cleanup(),k=null),x.clear(),z.cleanup(),void(D=null)}"undefined"!=typeof document&&document.addEventListener("DOMContentLoaded",()=>{"requestIdleCallback"in window?requestIdleCallback(()=>z.prefetch()):setTimeout(()=>z.prefetch(),1e3)});let I=null,M=null,H="pie",$=null;const O={get chartContainer(){return document.getElementById("chart-container")},get chartControls(){return document.getElementById("chart-controls")},get chartTypeSelector(){return document.getElementById("chart-type-selector")},get chartExportBtn(){return document.getElementById("chart-export-btn")},get chartShareBtn(){return document.getElementById("chart-share-btn")},get repartoFilter(){return document.getElementById("filter-reparto")},get provenienzaFilter(){return document.getElementById("filter-provenienza")},get diagnosiFilter(){return document.getElementById("filter-diagnosi")},get assistenzaFilter(){return document.getElementById("filter-assistenza")},get infettoFilter(){return document.getElementById("filter-infetto")},get startDateFilter(){return document.getElementById("filter-start-date")},get endDateFilter(){return document.getElementById("filter-end-date")},get applyButton(){return document.getElementById("apply-filters-btn")},get resetButton(){return document.getElementById("reset-filters-btn")}};async function N(){try{const t=[{id:"chart-container",name:"Container del grafico"},{id:"filter-reparto",name:"Filtro reparto"},{id:"filter-provenienza",name:"Filtro provenienza"},{id:"filter-diagnosi",name:"Filtro diagnosi"}];for(const e of t)document.getElementById(e.id)||console.warn(`Elemento ${e.name} (${e.id}) non trovato nel DOM`);document.querySelector("#filter-reparto, #filter-provenienza, #filter-diagnosi, #filter-assistenza, #filter-infetto")&&s("#filter-reparto, #filter-provenienza, #filter-diagnosi, #filter-assistenza, #filter-infetto");if(document.querySelectorAll("[data-datepicker]").length>0&&(I=new o("[data-datepicker]",{dateFormat:"d/m/Y"})),$=new y,await async function(){await async function(){try{const e=await async function(){try{const{chartTypeManager:e}=await S();return e.getAvailableChartTypes()}catch(e){return console.error("Errore nel recupero dei tipi di grafico:",e),[]}}();if(!O.chartTypeSelector){const t=document.querySelector(".filters-fieldset .row.mt-3 .col-12.d-flex.justify-content-center"),a=document.createElement("div");a.className="chart-type-selector-container ms-0 ms-md-3 mt-3 mt-md-0";const i=document.createElement("select");i.id="chart-type-selector",i.className="form-select form-select-sm",i.setAttribute("data-custom","true"),e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,t.setAttribute("data-icon",e.icon),i.appendChild(t)}),i.value=H,i.addEventListener("change",R),a.appendChild(i),t&&t.appendChild(a),s("#chart-type-selector"),setTimeout(()=>{l("#chart-type-selector")},100),document.addEventListener("chartTypeChange",P)}}catch(e){console.error("Errore nell'inizializzazione del selettore del tipo di grafico:",e)}}(),function(){const e=document.getElementById("chart-buttons-container");if(!e)return;const t=document.createElement("div");t.className="chart-export-buttons d-inline-flex gap-2";const a=document.createElement("button");a.id="chart-export-btn",a.className="btn btn-sm btn-outline-primary",a.innerHTML='<span class="material-icons">download</span> Esporta',a.addEventListener("click",B);const i=document.createElement("button");i.id="chart-share-btn",i.className="btn btn-sm btn-outline-secondary",i.innerHTML='<span class="material-icons">share</span> Condividi',i.addEventListener("click",W),t.appendChild(a),t.appendChild(i),e.appendChild(t)}()}(),O.chartContainer)try{$.adaptLayout(O.chartContainer)}catch(e){console.error("Errore nell'adattamento del layout:",e)}else console.warn("Container del grafico non trovato, impossibile adattare il layout");G()}catch(t){console.error("Errore nell'inizializzazione della UI del grafico:",t),Z(`Errore nell'inizializzazione: ${t.message}`)}}function R(e){if(H=e.target.value,M){U(J())}}function P(e){const t=e.detail.direction,a=["pie","bar","line"],i=a.indexOf(H);let n;n="next"===t?(i+1)%a.length:0===i?a.length-1:i-1;const r=a[n];H=r;const o=O.chartTypeSelector;if(o&&(o.value=r,o.customSelectInstance?o.customSelectInstance.setValue(r):l("#chart-type-selector")),M){U(J())}}async function B(){if(!M)return a.warning("Nessun grafico da esportare. Genera prima un grafico."),void 0;try{const e=J(),t={timestamp:(new Date).toLocaleString(),filters:e};await async function(e,t="grafico",i={}){try{const{exportService:a}=await S(),n=await a.exportAsImage(e,"png",i);a.downloadImage(n,t)}catch(n){throw T.handleExportError(n,e=>{a.error(e)}),n}}(M,"grafico-pazienti",t)}catch(e){console.error("Errore nell'esportazione del grafico:",e),a.error(`Errore nell'esportazione: ${e.message}`)}}async function W(){if(!M)return a.warning("Nessun grafico da condividere. Genera prima un grafico."),void 0;try{const e=J(),t=await _(e,H);await navigator.clipboard.writeText(t),a.success("Link copiato negli appunti!")}catch(e){console.error("Errore nella condivisione del grafico:",e),a.error(`Errore nella condivisione: ${e.message}`)}}function j(){I&&(I.destroy(),I=null),document.removeEventListener("chartTypeChange",P),F(),M&&(M.destroy(),M=null)}function J(){return{reparto:O.repartoFilter.value,provenienza:O.provenienzaFilter.value,diagnosi:O.diagnosiFilter.value,assistenza:O.assistenzaFilter.value,infetto:O.infettoFilter.value,startDate:O.startDateFilter.value,endDate:O.endDateFilter.value}}function q(){["filter-reparto","filter-provenienza","filter-diagnosi","filter-assistenza","filter-infetto"].forEach(e=>{const t=document.getElementById(e);t&&(t.value="",t.customSelectInstance&&t.customSelectInstance.setValue(""))}),O.startDateFilter.value="",O.endDateFilter.value="",G()}async function V(e){if(!O.chartContainer)return console.error("Container del grafico non trovato"),null;if(!e||!Array.isArray(e))return console.warn("Dati non validi per il grafico:",e),X("Dati non validi per visualizzare il grafico."),null;const{labels:t,dataPoints:a}=function(e){if(!e||0===e.length)return{labels:[],dataPoints:[]};const t=new Map;return e.forEach(({diagnosi:e})=>{const a=e?String(e).trim():"Non specificata";a&&t.set(a,(t.get(a)||0)+1)}),{labels:Array.from(t.keys()),dataPoints:Array.from(t.values())}}(e);if(0===t.length)return X("Nessun dato valido per visualizzare il grafico."),null;const i={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!1,text:"",font:{size:18,weight:"bold"}},legend:{position:$&&"function"==typeof $.detectDevice&&"desktop"===$.detectDevice()?"right":"top",onHover:function(e,t,a){},onClick:function(e,t,a){}}}};"bar"===H&&(i.scales={y:{beginAtZero:!0,ticks:{precision:0}},x:{ticks:{maxRotation:45,minRotation:0}}},i.plugins.tooltip={enabled:!1});try{if(M)try{M.destroy()}catch(n){console.warn("Errore durante la distruzione del grafico precedente:",n)}if(M=await A(O.chartContainer,{labels:t,datasets:[{label:"Numero di Pazienti",data:a}]},i,H),$&&M)try{"function"==typeof $.handleResize&&$.handleResize(M,i),M.update()}catch(r){console.error("Errore durante l'adattamento del grafico:",r)}O.chartExportBtn&&(O.chartExportBtn.disabled=!1),O.chartShareBtn&&(O.chartShareBtn.disabled=!1);try{document.dispatchEvent(new CustomEvent("chartUpdated",{detail:{chart:M}}))}catch(o){console.warn("Errore durante la generazione dell'evento chartUpdated:",o)}return M}catch(s){return console.error("Errore durante la creazione del grafico:",s),Z(`Errore nella visualizzazione del grafico: ${s.message}`),null}}async function U(e){void(O.chartContainer.innerHTML=t('<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>'));try{const{getChartData:t}=await r(async()=>{const{getChartData:e}=await Promise.resolve().then(()=>d);return{getChartData:e}},void 0),a=await t(e);await V(a)}catch(a){console.error("Errore nel ridisegno del grafico:",a);try{const e=[{diagnosi:"Influenza"},{diagnosi:"Polmonite"},{diagnosi:"Frattura"},{diagnosi:"Influenza"},{diagnosi:"Polmonite"},{diagnosi:"Frattura"},{diagnosi:"Infarto"},{diagnosi:"Ictus"},{diagnosi:"Diabete"}];await V(e)}catch(i){console.error("Errore anche con i dati di fallback:",i),Z(`Errore nell'aggiornamento del grafico: ${a.message}`)}}}function G(){O.chartContainer.innerHTML=t('<p class="text-muted">Seleziona i filtri e clicca "Applica" per visualizzare il grafico.</p>')}function X(e){O.chartContainer.innerHTML=t(`<p class="text-muted">${e}</p>`)}function Z(e){O.chartContainer.innerHTML=t(`<div class="alert alert-danger">${e}</div>`)}async function Y(){const e=J();try{await U(e)}catch(t){Z(t.message)}}async function K(){N();try{!function(e){n(O.repartoFilter,e.repartoOptions),l("#filter-reparto"),n(O.provenienzaFilter,e.provenienzaOptions),l("#filter-provenienza"),n(O.diagnosiFilter,e.diagnosiOptions),l("#filter-diagnosi"),O.infettoFilter&&(O.infettoFilter.innerHTML=t('\n            <option value="">Tutti</option>\n            <option value="true">Sì</option>\n            <option value="false">No</option>\n        '),l("#filter-infetto"))}(await c())}catch(e){console.error("Errore durante l'inizializzazione della vista grafico:",e),Z(e.message||"Errore durante il caricamento dei filtri.")}return O.applyButton.addEventListener("click",Y),void O.resetButton.addEventListener("click",q),j}export{K as initGraficoView};
