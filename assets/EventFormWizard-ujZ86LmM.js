import{j as e}from"./ui-vendor-CgDpQ-gO.js";import{b as t,i,R as n}from"./react-vendor-bU8fvvPN.js";import{l as a,s as o}from"./index-B3u_oT47.js";import{T as r,e as s,p as l,v as c}from"./patientService-BpWlpoKy.js";import{s as d}from"./CentralizedStatisticsService-CxvteCqU.js";import{D as p}from"./DateRangePicker-wV19jQHj.js";import{u as m,a as u,b as v,W as h}from"./WizardStepper-hBeYqTh9.js";import{u as g}from"./useQuery-CUH6di1e.js";import{u as b}from"./useNotification-BYngRG8x.js";const x={activeOnly:!0,maxResults:10,minSearchLength:2,debounceDelay:300,enableCache:!0,includeFields:["id","nome","cognome","codice_fiscale","data_nascita","reparto_appartenenza","data_ricovero","data_dimissione","codice_rad","diagnosi"]};const f=new class{cache;pendingRequests;debounceTimers;constructor(){this.cache=new r({ttl:3e5,maxSize:100,enableStats:!0}),this.pendingRequests=new Map,this.debounceTimers=new Map}async search(e,t={}){const i={...x,...t};if(e.length<i.minSearchLength)return[];const n=this.buildCacheKey(e,i);if(i.enableCache){const t=this.cache.get(n);if(t)return a.debug("[PatientSearch] Cache hit",{searchTerm:e,count:t.length}),t}const o=this.pendingRequests.get(n);if(o)return a.debug("[PatientSearch] Request deduplication",{searchTerm:e}),o;const r=this.executeSearch(e,i);this.pendingRequests.set(n,r);try{const e=await r;return i.enableCache&&this.cache.set(n,e),e}finally{this.pendingRequests.delete(n)}}searchDebounced(e,t={}){const i={...x,...t},n=this.buildCacheKey(e,i);return new Promise((a,o)=>{const r=this.debounceTimers.get(n);r&&clearTimeout(r);const s=setTimeout(async()=>{try{const i=await this.search(e,t);a(i)}catch(i){o(i)}finally{this.debounceTimers.delete(n)}},i.debounceDelay);this.debounceTimers.set(n,s)})}async executeSearch(e,t){try{a.debug("[PatientSearch] Executing search",{searchTerm:e,options:t});let i=o.from("pazienti").select(t.includeFields.join(",")).limit(t.maxResults);t.activeOnly&&(i=i.is("data_dimissione",null));const n=d(e,{maxTerms:5,maxTokenLength:64});if(0===n.length)return[];if(1===n.length){const e=`%${n[0]}%`;i=i.or(`nome.ilike.${e},cognome.ilike.${e},codice_fiscale.ilike.${e},codice_rad.ilike.${e}`)}else if(2===n.length){const e=n[0],t=n[1];i=i.or([`and(nome.ilike.%${e}%,nome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(nome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,nome.ilike.%${t}%)`,`codice_rad.ilike.%${e}%${t}%`,`codice_rad.ilike.%${t}%${e}%`].join(","))}else{const e=n[0],t=n[1];i=i.or([`and(nome.ilike.%${e}%,nome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(nome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,nome.ilike.%${t}%)`].join(","))}i=i.order("cognome").order("nome");const{data:r,error:s}=await i;if(s)throw a.error("[PatientSearch] Search error",s),s;return a.debug("[PatientSearch] Search completed",{searchTerm:e,resultsCount:r?.length??0}),r??[]}catch(i){throw a.error("[PatientSearch] Unexpected error",i),i}}buildCacheKey(e,t){return JSON.stringify({term:e.toLowerCase(),activeOnly:t.activeOnly??!0,maxResults:t.maxResults??10})}clearCache(){this.cache.clear(),a.debug("[PatientSearch] Cache cleared")}getCacheStats(){return this.cache.getStats()}invalidateCache(e){if(!e)return this.clearCache(),void 0;this.cache.invalidate(t=>t.includes(e.toLowerCase()))}},_={activeOnly:!1,maxResults:10,minSearchLength:2,debounceDelay:300,enableCache:!0,enabled:!0};const j=({value:n,onChange:o,placeholder:r="Cerca paziente...",className:s="",disabled:l=!1,required:c=!1,activeOnly:d=!1,maxResults:p=10,minSearchLength:m=2,debounceDelay:u=300,showPatientInfo:v=!0,highlightMatch:h=!0})=>{const g=t.useId(),b=`patient-autocomplete-${g}`,x=`patient-autocomplete-list-${g}`,j=t.useRef(null),N=t.useRef(null),S=t.useRef(null),[w,z]=t.useState(!1),[y,k]=t.useState(-1),[C,E]=t.useState(""),[D,P]=t.useState({top:0,left:0,width:0}),{searchTerm:I,setSearchTerm:T,results:$,loading:R,error:L,clearSearch:A}=function(e={}){const i={..._,...e},{enabled:n,minSearchLength:o,...r}=i,[s,l]=t.useState(""),[c,d]=t.useState([]),[p,m]=t.useState(!1),[u,v]=t.useState(null),h=t.useRef(null),g=t.useRef(!1),b=t.useCallback(async e=>{if(!e||e.trim().length<(o??2))return d([]),v(null),m(!1),void 0;h.current&&h.current.abort(),h.current=new AbortController,g.current=!0,m(!0),v(null);try{a.debug("[usePatientSearch] Performing search",{term:e});const t=await f.searchDebounced(e.trim(),r);h.current?.signal.aborted||(d(t),0===t.length&&v(`Nessun paziente trovato per "${e}"`))}catch(t){if(!h.current?.signal.aborted){const e=t instanceof Error?t.message:"Errore durante la ricerca";v(e),d([]),a.error("[usePatientSearch] Search error:",t)}}finally{h.current?.signal.aborted||m(!1),g.current=!1}},[o,r]),x=t.useCallback(e=>{l(e),n&&b(e)},[n,b]),j=t.useCallback(()=>{l(""),d([]),v(null),h.current&&h.current.abort(),g.current=!1},[]),N=t.useCallback(()=>{s&&b(s)},[s,b]),S=f.getCacheStats();return t.useEffect(()=>()=>{h.current&&h.current.abort(),g.current=!1},[]),{searchTerm:s,setSearchTerm:x,results:c,loading:p,error:u,clearSearch:j,refetch:N,cacheStats:S}}({activeOnly:d,maxResults:p,minSearchLength:m,debounceDelay:u,enableCache:!0});t.useEffect(()=>{if(n){E(`${n.cognome} ${n.nome}`)}else E("")},[n]),t.useEffect(()=>{const e=e=>{const t=e.target,i=j.current&&j.current.contains(t),n=S.current&&S.current.contains(t);i||n||(z(!1),k(-1))};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),t.useEffect(()=>{if(w&&N.current){const e=N.current.getBoundingClientRect();P({top:e.top+e.height,left:e.left,width:e.width})}},[w]);const O=t.useMemo(()=>$.slice(0,p),[$,p]),q=t.useCallback((t,i)=>{if(!h||!i.trim())return t;const n=new RegExp(`(${i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return t.split(n).map((t,i)=>n.test(t)?e.jsx("mark",{className:"bg-warning text-dark",children:t},i):t)},[h]),F=t.useCallback(e=>{const t=e.target.value;E(t),T(t),t.trim().length>=m?(z(!0),k(-1)):(z(!1),k(-1)),t.trim()||o(null)},[T,m,o]),M=t.useCallback(e=>{o(e),z(!1),k(-1),a.log("[PatientAutocomplete] Patient selected:",{id:e.id,name:`${e.cognome} ${e.nome}`})},[o]),K=t.useCallback(e=>{if(!w||0===O.length)return"ArrowDown"===e.key&&I.trim().length>=m&&(z(!0),k(0)),void 0;switch(e.key){case"ArrowDown":e.preventDefault(),k(e=>e<O.length-1?e+1:0);break;case"ArrowUp":e.preventDefault(),k(e=>e>0?e-1:O.length-1);break;case"Enter":e.preventDefault(),y>=0&&O[y]&&M(O[y]);break;case"Escape":e.preventDefault(),z(!1),k(-1),N.current?.blur()}},[w,O,y,I,m,M]),H=t.useCallback(()=>{I.trim().length>=m&&O.length>0&&z(!0)},[I,m,O.length]),V=t.useCallback(()=>{E(""),T(""),z(!1),k(-1),o(null),A()},[T,o,A]),B=t.useCallback(e=>q(`${e.cognome} ${e.nome}`,I),[I,q]),U=t.useCallback(e=>{const t=[];if(e.codice_rad&&t.push(`RAD: ${e.codice_rad}`),e.reparto_appartenenza&&t.push(e.reparto_appartenenza),e.data_ricovero){const i=new Date(e.data_ricovero);t.push(`Ric: ${i.toLocaleDateString("it-IT")}`)}return t.join(" • ")},[]);return t.useEffect(()=>{if(y>=0&&S.current){const e=S.current.children[y];e&&e.scrollIntoView({block:"nearest"})}},[y]),t.useEffect(()=>{if(!w||!S.current)return;const e=e=>{e.stopPropagation(),e.preventDefault();const t=e.currentTarget,i=S.current?.querySelectorAll('li[role="option"]');if(i){const e=Array.from(i).indexOf(t);e>=0&&O[e]&&M(O[e])}};let t=0;const i=()=>{if(!S.current)return;const n=S.current.querySelectorAll('li[role="option"]');n.length>0?n.forEach(t=>{t.addEventListener("click",e,!1)}):t<10&&(t++,setTimeout(i,50))};return i(),()=>{if(S.current){S.current.querySelectorAll('li[role="option"]').forEach(t=>{t.removeEventListener("click",e,!1)})}}},[w,O,M]),e.jsxs("div",{className:`patient-autocomplete position-relative ${s}`,ref:j,children:[e.jsxs("div",{className:"input-group",children:[e.jsx("input",{ref:N,id:b,type:"text",className:"form-control "+(l?"bg-light":""),placeholder:r,value:C,onChange:F,onKeyDown:K,onFocus:H,disabled:l,required:c,role:"combobox","aria-controls":x,"aria-expanded":w,"aria-autocomplete":"list","aria-busy":R,"aria-describedby":L?`${b}-error`:void 0}),C&&!l&&e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:V,"aria-label":"Cancella ricerca",children:e.jsx("i",{className:"bi bi-x-lg"})}),R&&e.jsx("span",{className:"input-group-text",children:e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"})})]}),L&&e.jsx("div",{id:`${b}-error`,className:"form-text text-danger mt-1",children:L}),w&&i.createPortal(e.jsxs("ul",{ref:S,id:x,className:"list-group shadow-sm",style:{position:"fixed",top:`${D.top}px`,left:`${D.left}px`,width:`${D.width}px`,maxHeight:"300px",overflowY:"auto",zIndex:9999,backgroundColor:"white",borderRadius:"0.25rem",border:"1px solid #dee2e6"},role:"listbox",children:[R&&e.jsxs("li",{className:"list-group-item text-muted",role:"presentation",children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Ricerca in corso..."]}),!R&&0===O.length&&I.trim().length>=m&&e.jsxs("li",{className:"list-group-item text-muted text-center py-3",role:"presentation",children:[e.jsx("i",{className:"bi bi-person-x fs-4 d-block mb-2"}),'Nessun paziente trovato per "',e.jsx("strong",{children:I}),'"']}),!R&&O.map((t,i)=>e.jsx("li",{role:"option",className:`list-group-item list-group-item-action cursor-pointer ${i===y?"active":""} ${n?.id===t.id?"border-primary":""}`,onMouseEnter:()=>k(i),"aria-selected":i===y,"data-patient-index":i,children:e.jsx("div",{className:"d-flex justify-content-between align-items-start",children:e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"fw-semibold",children:[B(t),n?.id===t.id&&e.jsx("i",{className:"bi bi-check-circle-fill text-primary ms-2","aria-label":"Selezionato"})]}),v&&e.jsx("div",{className:"small text-muted mt-1",children:U(t)}),t.diagnosi&&e.jsxs("div",{className:"small text-muted mt-1",children:[e.jsx("i",{className:"bi bi-clipboard2-pulse me-1"}),t.diagnosi]})]})})},t.id))]}),document.body)]})},N=[{value:"batterico",label:"Batterico"},{value:"virale",label:"Virale"},{value:"fungino",label:"Fungino"},{value:"parassitario",label:"Parassitario"}],S={DESCRIPTION:4,NOTES:6},w={PATIENT_SEARCH:300},z={PLACEHOLDER:"Cerca per nome, cognome o RAD...",HELP_TEXT:"Seleziona un paziente per continuare",SELECTED:(e,t)=>`Paziente selezionato: ${e} ${t}`},y=({values:t,onChange:i,hasPatient:n=!0,selectedPatient:a=null,onSelectPatient:o,onPatientSelect:r})=>e.jsx("div",{className:"wizard-step","data-step":"event-type",children:e.jsxs("div",{className:"wizard-step-content",children:[!n&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"wizard-step-title",children:"Seleziona Paziente"}),e.jsxs("div",{className:"mb-4",children:[e.jsx(j,{value:a,onChange:e=>{o&&o(e?.id||""),r&&r(e)},placeholder:z.PLACEHOLDER,activeOnly:!1,maxResults:10,minSearchLength:1,debounceDelay:w.PATIENT_SEARCH,showPatientInfo:!0,highlightMatch:!0}),a&&e.jsxs("div",{className:"alert alert-success mt-3",role:"alert",children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),z.SELECTED(a.cognome,a.nome)]}),!a&&e.jsxs("div",{className:"alert alert-info mt-3",role:"alert",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),z.HELP_TEXT]})]}),!a&&e.jsx("div",{style:{marginBottom:"2rem"}})]}),(n||a)&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"wizard-step-title",children:"Tipo di Evento"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona il tipo di evento clinico da registrare"}),e.jsx("div",{className:"event-type-selection",children:e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"event-type-card "+("intervento"===t.tipo_evento?"selected":""),onClick:()=>i({tipo_evento:"intervento"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),i({tipo_evento:"intervento"}))},children:[e.jsx("div",{className:"event-type-card-icon",children:e.jsx("i",{className:"bi bi-heart-pulse"})}),e.jsxs("div",{className:"event-type-card-content",children:[e.jsx("h4",{className:"event-type-card-title",children:"Intervento Chirurgico"}),e.jsx("p",{className:"event-type-card-description",children:"Registra un intervento chirurgico eseguito sul paziente"})]}),e.jsx("div",{className:"event-type-card-radio",children:e.jsx("input",{type:"radio",name:"tipo_evento",value:"intervento",checked:"intervento"===t.tipo_evento,onChange:()=>i({tipo_evento:"intervento"}),className:"form-check-input"})})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"event-type-card "+("infezione"===t.tipo_evento?"selected":""),onClick:()=>i({tipo_evento:"infezione"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),i({tipo_evento:"infezione"}))},children:[e.jsx("div",{className:"event-type-card-icon",children:e.jsx("i",{className:"bi bi-virus"})}),e.jsxs("div",{className:"event-type-card-content",children:[e.jsx("h4",{className:"event-type-card-title",children:"Infezione"}),e.jsx("p",{className:"event-type-card-description",children:"Registra un'infezione contratta dal paziente"})]}),e.jsx("div",{className:"event-type-card-radio",children:e.jsx("input",{type:"radio",name:"tipo_evento",value:"infezione",checked:"infezione"===t.tipo_evento,onChange:()=>i({tipo_evento:"infezione"}),className:"form-check-input"})})]})})]})})]})]})}),k=({values:t,onChange:i,errors:n,isSubmitting:a,tipiIntervento:o,agentiPatogeno:r,loadingTypes:s,loadingPatogens:l})=>{const c="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"event-details",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:c?"Dettagli Intervento":"Dettagli Infezione"}),e.jsx("p",{className:"wizard-step-description",children:c?"Specifica il tipo di intervento e la descrizione":"Specifica l'agente patogeno e il tipo"}),e.jsxs(e.Fragment,c?{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"tipo_intervento_id",className:"form-label",children:["Tipo Intervento ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("select",{id:"tipo_intervento_id",name:"tipo_intervento_id",className:"form-select "+(n?.tipo_intervento_id?"is-invalid":""),value:t.tipo_intervento_id?String(t.tipo_intervento_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):void 0;i({tipo_intervento_id:t})},disabled:a||s,required:!0,children:[e.jsx("option",{value:"",children:s?"Caricamento tipi intervento...":"Seleziona tipo intervento..."}),o.map(t=>e.jsx("option",{value:String(t.id),children:t.nome},t.id))]}),n?.tipo_intervento_id&&e.jsx("div",{className:"invalid-feedback",role:"alert",children:n.tipo_intervento_id})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"descrizione_intervento",className:"form-label",children:"Descrizione Dettagliata"}),e.jsx("textarea",{id:"descrizione_intervento",name:"descrizione_intervento",className:"form-control",value:t.descrizione_intervento||"",onChange:e=>i({descrizione_intervento:e.target.value}),disabled:a,rows:S.DESCRIPTION,placeholder:"Descrivere dettagliatamente l'intervento eseguito..."}),e.jsx("div",{className:"form-text",children:"Opzionale - Fornire una descrizione dettagliata della procedura"})]})]}:{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"agente_patogeno_id",className:"form-label",children:["Agente Eziologico ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("select",{id:"agente_patogeno_id",name:"agente_patogeno_id",className:"form-select "+(n?.agente_patogeno_id?"is-invalid":""),value:t.agente_patogeno_id?String(t.agente_patogeno_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):void 0;i({agente_patogeno_id:t})},disabled:a||l,required:!0,children:[e.jsx("option",{value:"",children:l?"Caricamento agenti patogeno...":"Seleziona agente eziologico..."}),r.map(t=>e.jsx("option",{value:String(t.id),children:t.nome},t.id))]}),n?.agente_patogeno_id&&e.jsx("div",{className:"invalid-feedback",role:"alert",children:n.agente_patogeno_id}),e.jsx("div",{className:"form-text",children:"Selezionare l'agente responsabile dell'infezione"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"tipo_patogeno",className:"form-label",children:"Tipo Patogeno"}),e.jsxs("select",{id:"tipo_patogeno",name:"tipo_patogeno",className:"form-select",value:t.tipo_patogeno||"",onChange:e=>i({tipo_patogeno:e.target.value}),disabled:a,children:[e.jsx("option",{value:"",children:"Seleziona tipo patogeno..."}),N.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]}),e.jsx("div",{className:"form-text",children:"Opzionale - Specificare la categoria del patogeno"})]})]})]})})},C=({values:t,onChange:i,errors:n,isSubmitting:a,showResolutionDate:o,setShowResolutionDate:r})=>{const s="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"dates",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Date Evento"}),e.jsx("p",{className:"wizard-step-description",children:s?"Specifica quando è stato eseguito l'intervento":"Specifica le date di inizio e fine dell'infezione"}),s?e.jsx("div",{className:"mb-3",children:e.jsx(p,{label:"Data Intervento",value:t.data_evento||"",onChange:e=>i({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:a,isInvalid:!!n?.data_evento,errorMessage:n?.data_evento})}):e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-12 mb-3",children:e.jsx(p,{label:"Data Inizio",value:t.data_evento||"",onChange:e=>i({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:a,isInvalid:!!n?.data_evento,errorMessage:n?.data_evento})}),e.jsxs("div",{className:"col-12 mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2 gap-2",children:[e.jsx("label",{htmlFor:"toggle_resolution",className:"form-label mb-0",children:"Data Fine"}),e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"toggle_resolution",checked:o,onChange:e=>{r(e.target.checked),e.target.checked||i({data_fine_evento:""})},disabled:a}),e.jsx("label",{className:"form-check-label",htmlFor:"toggle_resolution",children:"Infezione risolta"})]})]}),o&&e.jsx(p,{value:t.data_fine_evento||"",onChange:e=>i({data_fine_evento:e||""}),placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:a,isInvalid:!!n?.data_fine_evento,errorMessage:n?.data_fine_evento})]})]})]})})},E=({values:t,onChange:i,isSubmitting:n})=>{const a="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"notes",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Note Aggiuntive"}),e.jsx("p",{className:"wizard-step-description",children:"Aggiungi informazioni o osservazioni rilevanti (opzionale)"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"note",className:"form-label",children:a?"Note Aggiuntive":"Note Cliniche"}),e.jsx("textarea",{id:"note",name:"note",className:"form-control",value:t.note||"",onChange:e=>i({note:e.target.value}),disabled:n,rows:S.NOTES,placeholder:a?"Note aggiuntive sull'intervento...":"Sintomi, terapia, esami, decorso...","aria-describedby":"note-help"}),e.jsxs("div",{id:"note-help",className:"form-text",children:["Opzionale - ",a?"Informazioni aggiuntive sull'intervento":"Informazioni cliniche rilevanti"]})]})]})})},D=({values:i,tipiIntervento:n,agentiPatogeno:a})=>{const o="intervento"===i.tipo_evento,r=t.useMemo(()=>n.find(e=>e.id===i.tipo_intervento_id)?.nome,[n,i.tipo_intervento_id]),s=t.useMemo(()=>a.find(e=>e.id===i.agente_patogeno_id)?.nome,[a,i.agente_patogeno_id]);return e.jsx("div",{className:"wizard-step","data-step":"review",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Riepilogo"}),e.jsx("p",{className:"wizard-step-description",children:"Verifica i dati inseriti prima di salvare"}),e.jsxs("div",{className:"event-review-summary",children:[e.jsxs("div",{className:"alert alert-light",children:[e.jsx("h5",{className:"alert-heading",children:o?"Intervento Chirurgico":"Infezione"}),e.jsx("hr",{}),e.jsxs(e.Fragment,o?{children:[e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Tipo Intervento:"})," ",e.jsx("span",{children:r||"Non specificato"})]}),i.descrizione_intervento&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Descrizione:"})," ",e.jsx("span",{children:i.descrizione_intervento})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Intervento:"})," ",e.jsx("span",{children:i.data_evento||"Non specificata"})]})]}:{children:[e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Agente Eziologico:"})," ",e.jsx("span",{children:s||"Non specificato"})]}),i.tipo_patogeno&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Tipo Patogeno:"})," ",e.jsx("span",{children:N.find(e=>e.value===i.tipo_patogeno)?.label})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Inizio:"})," ",e.jsx("span",{children:i.data_evento||"Non specificata"})]}),i.data_fine_evento&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Fine:"})," ",e.jsx("span",{children:i.data_fine_evento})]})]}),i.note&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Note:"})," ",e.jsx("span",{children:i.note})]})]}),e.jsxs("div",{className:"alert alert-info",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),"Verifica che tutti i dati siano corretti. Puoi tornare indietro per modificare qualsiasi campo prima di salvare."]})]})]})})},P=["event-type","event-details","dates","notes","review"],I={"event-type":"Tipo Evento","event-details":"Dettagli",dates:"Date",notes:"Note",review:"Riepilogo"},T=({patientId:i,event:o,onSubmit:r,onCancel:d,initialEventType:p})=>{const{notify:x}=b(),f=!!o,_=((e="event-type")=>m({steps:P,labels:I,initialStep:e}))("event-type"),j=u({currentStep:_.currentStep,getStepLabel:_.getStepLabel,totalSteps:_.totalSteps,currentStepNumber:_.getStepNumber(_.currentStep),enabled:!1});v();const{patient:N}=(e=>{const{notify:t}=b(),{data:i,isLoading:n,error:o}=g({queryKey:["patient",e],queryFn:async()=>{if(!e)return null;try{const i=await l.getPatientById(e);if(i){const t={id:i.id,nome:i.nome,cognome:i.cognome};return a.info("Patient loaded successfully",{patientId:e}),t}return a.warn("Patient not found",{patientId:e}),t.warning("Paziente non trovato").withDuration(3e3).show(),null}catch(i){const n=i instanceof Error?i:new Error(String(i));throw a.error("Error loading patient data",{patientId:e,error:n}),t.error("Errore nel caricamento del paziente").withDuration(5e3).show(),n}},enabled:!!e,staleTime:3e5});return{patient:i||null,loading:n,error:o instanceof Error?o:null}})(i),{tipiIntervento:S,agentiPatogeno:w,loading:z}=(()=>{const{notify:e}=b(),{data:i,isLoading:n,error:o}=g({queryKey:["eventLookupTables"],queryFn:async()=>{try{const[e,t]=await Promise.all([s.getListaTipiIntervento(),s.getListaAgentiPatogeno()]);return a.info("Event lookup tables loaded successfully",{tipiCount:e.length,agentiCount:t.length}),{tipi:e,agenti:t}}catch(t){const i=t instanceof Error?t:new Error(String(t));throw a.error("Error loading event lookup tables",{error:i}),e.error("Impossibile caricare i dati. Riprova più tardi.").withDuration(5e3).show(),i}},staleTime:6e5}),r=i?.tipi||[],l=i?.agenti||[],c=t.useMemo(()=>new Map(r.map(e=>[e.id,e.nome])),[r]),d=t.useMemo(()=>new Map(l.map(e=>[e.id,e.nome])),[l]);return{tipiIntervento:r,agentiPatogeno:l,loading:n,error:o instanceof Error?o:null,tipiInterventoMap:c,agentiPatogeniMap:d}})(),[T,$]=t.useState(i||""),[R,L]=t.useState(N),[A,O]=t.useState({paziente_id:T,tipo_evento:o?.tipo_evento||p||"intervento",data_evento:o?.data_evento||"",tipo_intervento_id:o?.tipo_intervento_id??void 0,descrizione_intervento:o?.descrizione_intervento||"",agente_patogeno_id:o?.agente_patogeno_id??void 0,tipo_patogeno:o?.tipo_patogeno??void 0,data_fine_evento:o?.data_fine_evento||"",note:o?.note||""}),[q,F]=t.useState(!!o?.data_fine_evento),[M,K]=t.useState({}),[H,V]=t.useState(!1);n.useEffect(()=>{N&&L(N)},[N]);const B=e=>{$(e),O(t=>({...t,paziente_id:e}))},U=e=>{L(e)},W=e=>{O(t=>({...t,...e}));const t=Object.keys(e);t.some(e=>M[e])&&K(e=>{const i={...e};return t.forEach(e=>delete i[e]),i})},X=()=>{switch(_.currentStep){case"event-type":return!!T&&!!A.tipo_evento;case"event-details":return"intervento"===A.tipo_evento?!!A.tipo_intervento_id:"infezione"===A.tipo_evento&&!!A.agente_patogeno_id;case"dates":return!!A.data_evento;case"notes":case"review":return!0;default:return!1}};return e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),!(()=>{const e={};if(!T)return e.paziente_id="Seleziona un paziente",K(e),!1;if(A.tipo_evento||(e.tipo_evento="Seleziona il tipo di evento"),"intervento"===A.tipo_evento&&(A.tipo_intervento_id||(e.tipo_intervento_id="Il tipo di intervento è obbligatorio"),A.data_evento||(e.data_evento="La data dell'intervento è obbligatoria")),"infezione"===A.tipo_evento){A.agente_patogeno_id||(e.agente_patogeno_id="Il tipo di batterio è obbligatorio"),A.data_evento||(e.data_evento="La data di inizio infezione è obbligatoria");const t=c(A.data_evento,q&&A.data_fine_evento||void 0,"infezione");t&&(e.data_evento=t)}if("intervento"===A.tipo_evento){A.data_evento||(e.data_evento="La data dell'intervento è obbligatoria");const t=c(A.data_evento,void 0,"intervento");t&&(e.data_evento=t)}return K(e),0===Object.keys(e).length})())return _.goToStep("event-type"),void 0;try{V(!0);const e={paziente_id:T,tipo_evento:A.tipo_evento,data_evento:A.data_evento,note:A.note};"intervento"===A.tipo_evento&&(e.tipo_intervento_id=A.tipo_intervento_id,e.descrizione_intervento=A.descrizione_intervento),"infezione"===A.tipo_evento&&(e.agente_patogeno_id=A.agente_patogeno_id,e.tipo_patogeno=A.tipo_patogeno,q&&(e.data_fine_evento=A.data_fine_evento)),await r(e)}catch(t){a.error("Errore durante il salvataggio del evento",{error:t}),x.error("Errore durante il salvataggio. Riprova più tardi.").withDuration(5e3).show(),V(!1)}},className:"wizard-form event-wizard-form",noValidate:!0,children:[e.jsxs("div",{className:"wizard-form-header",children:[e.jsx("button",{type:"button",className:"wizard-back-button",onClick:d,disabled:H,"aria-label":"Torna indietro",children:e.jsx("i",{className:"bi bi-arrow-left"})}),e.jsx("h1",{className:"wizard-form-title",children:f?"Modifica Evento":"Nuovo Evento"})]}),e.jsx(h,{currentStep:_.currentStep,getStepLabel:_.getStepLabel,getStepNumber:_.getStepNumber,totalSteps:_.totalSteps,stepOrder:P,themeColor:"clinical",extraInfo:R&&_.getStepNumber(_.currentStep)>1?e.jsxs("div",{className:"wizard-patient-info",children:[e.jsx("small",{className:"text-muted",children:"Paziente:"}),e.jsxs("strong",{children:[R.cognome," ",R.nome]})]}):null}),e.jsx("div",{ref:j,className:"wizard-form-content",children:(()=>{const t=!!T,i={values:A,onChange:W,errors:M,isSubmitting:H};switch(_.currentStep){case"event-type":return e.jsx(y,{...i,hasPatient:t,selectedPatient:R,onSelectPatient:B,onPatientSelect:U});case"event-details":return e.jsx(k,{...i,tipiIntervento:S,agentiPatogeno:w,loadingTypes:z,loadingPatogens:z});case"dates":return e.jsx(C,{...i,showResolutionDate:q,setShowResolutionDate:F});case"notes":return e.jsx(E,{...i});case"review":return e.jsx(D,{...i,tipiIntervento:S,agentiPatogeno:w,loadingTypes:z,loadingPatogens:z});default:return null}})()}),e.jsxs("div",{className:"wizard-form-actions",children:[_.canGoPrev&&e.jsxs("button",{type:"button",className:"btn btn-secondary btn-block",onClick:_.prevStep,disabled:H,children:[e.jsx("i",{className:"bi bi-chevron-left"})," Indietro"]}),"review"!==_.currentStep?e.jsxs("button",{type:"button",className:"btn btn-primary btn-block",onClick:_.nextStep,disabled:H||!X(),title:X()?void 0:"Completa i campi obbligatori per continuare",children:["Avanti ",e.jsx("i",{className:"bi bi-chevron-right"})]}):e.jsx("button",{type:"submit",className:"btn btn-success btn-block",disabled:H,children:e.jsxs(e.Fragment,H?{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio..."]}:{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),f?"Aggiorna Evento":"Salva Evento"]})})]})]})};export{T as E,j as P};
