const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/form-pMK8clq8.js","assets/supabase-AmyKTmiY.js","assets/infectionDataManager-Bh24oi45.js","assets/CustomDatepicker-6By5cdaM.js","assets/utils-BtSsRyB2.js","assets/CustomSelect-FZxngiBJ.js","assets/ResolveInfectionModal-CvOPfqto.js","assets/vendor-BU6HxVpN.js","assets/post-operative-calculator-C3z7C_vm.js","assets/lookupService-D46JfnFe.js","assets/surgeryDataManager-CbtGeuzn.js","assets/dimissione-i-kj54A9.js","assets/patientService-mXu2lH6N.js","assets/PatientAutocomplete-2iZEKgko.js","assets/formatting-C7G90sDQ.js","assets/grafico-Q9PhXSvN.js","assets/helpers-MgX-2Ics.js","assets/chartjsService-BqG25P3j.js","assets/list-DWBrk7pA.js","assets/diagnosi-DsYXSrjE.js","assets/eventi-clinici-DUU-a97n.js"])))=>i.map(i=>d[i]);
import{c as e,_ as t}from"./supabase-AmyKTmiY.js";import{Dropdown as i,Collapse as n,Modal as r}from"./vendor-BU6HxVpN.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),t.credentials="use-credentials"===e.crossOrigin?"include":"anonymous"===e.crossOrigin?"omit":"same-origin",t}(e);fetch(e.href,t)}}();const o="redirectUrl",a="Gestione Pazienti SPA",s="1.0.0",c="development"==="production";const l=new class{sanitizeArgs(e){const t=new Set(["password","token","auth","secret","nome","cognome","codice_fiscale","codice_rad","telefono","email","indirizzo","indirizzo_residenza","citta","cap","note","descrizione"]),i=e=>{if(null==e)return e;if("string"==typeof e)return e.length>200?e.slice(0,200)+"…":e;if(e instanceof Error)return{name:e.name,message:e.message};if(Array.isArray(e))return e.map(i);if("object"==typeof e){const n={};for(const[r,o]of Object.entries(e))n[r]=t.has(r)?"[REDACTED]":i(o);return n}return e};return e.map(i)}log(...e){}warn(...e){}error(...e){const t=this.sanitizeArgs(e);console.error(...t)}info(...e){}debug(...e){}group(e){}groupEnd(){}table(e){}time(e){}timeEnd(e){}},d=e("https://aiguzywadjzyrwandgba.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZ3V6eXdhZGp6eXJ3YW5kZ2JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDM1MzQsImV4cCI6MjA2Njc3OTUzNH0.pezVt3-xxkHBYK2V6ryHUtj_givF_TA9xwEzuK2essw",{auth:{flowType:"pkce",detectSessionInUrl:!0,persistSession:!0,autoRefreshToken:!0,storage:window.localStorage,storageKey:"supabase.auth.token",debug:!1},global:{headers:{"X-Client-Info":"supabase-js-vite"}}}),u=Object.freeze(Object.defineProperty({__proto__:null,supabase:d},Symbol.toStringTag,{value:"Module"}));const h=new class{constructor(){this.readyPromise=new Promise(e=>{this.resolveReady=e}),this.init()}async init(){await this.waitForViteReady(),await this.waitForSupabaseReady(),this.notifyReady()}async waitForViteReady(){return new Promise(e=>{"complete"===document.readyState?(l.log("Vite è pronto"),e()):window.addEventListener("load",()=>{setTimeout(()=>{l.log("Vite è pronto (dopo load)"),e()},100)},{once:!0})})}async waitForSupabaseReady(){return new Promise(async e=>{try{await d.auth.getSession(),l.log("Supabase è pronto"),e()}catch(t){console.error("Errore nell'inizializzazione Supabase:",t),this.clearCorruptedState(),setTimeout(async()=>{try{await d.auth.getSession(),l.log("Supabase è pronto (dopo retry)"),e()}catch(t){console.error("Errore nel retry Supabase:",t),e()}},500)}})}clearCorruptedState(){l.log("Pulisco stato corrotto..."),["supabase.auth.token","sb-aiguzywadjzyrwandgba-auth-token"].forEach(e=>{localStorage.removeItem(e),sessionStorage.removeItem(e)}),document.cookie.split(";").forEach(e=>{const t=e.indexOf("="),i=t>-1?e.substr(0,t):e;(i.trim().includes("supabase")||i.trim().includes("sb-"))&&(document.cookie=i+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/")})}onReady(){return this.readyPromise}notifyReady(){l.log("Middleware Vite-Supabase pronto"),this.resolveReady()}};const g=new class{constructor(){this.isInitialized=!1,this.authState="idle",this.errorState=null,this.init()}async init(){if(!this.isInitialized){await new Promise(e=>{h.onReady(e)});try{const e=new URLSearchParams(window.location.search),t=new URLSearchParams(window.location.hash.substring(1));t.has("access_token")||t.has("refresh_token")||e.has("code")||t.has("error")?(l.log("Rilevato redirect OAuth con parametri reali, gestisco la sessione..."),this.authState="authenticating",await this.handleOAuthCallback()):l.log("Nessun parametro OAuth rilevato, inizializzazione normale"),this.isInitialized=!0}catch(e){console.error("Errore nell'inizializzazione OAuth:",e),this.errorState=e,this.authState="error"}}}async handleOAuthCallback(){try{l.log("Gestisco callback OAuth...");if(new URLSearchParams(window.location.search).has("code")){l.log("Rilevato parametro code, eseguo exchangeCodeForSession...");const{data:e,error:t}=await d.auth.exchangeCodeForSession(window.location.href);if(t)throw console.error("Errore in exchangeCodeForSession:",t),this.clearCorruptedState(),t;l.log("exchangeCodeForSession completato:",!!e?.session)}const{data:e,error:t}=await d.auth.getSession();if(t)throw console.error("Errore nel callback OAuth:",t),this.clearCorruptedState(),t;if(e.session){l.log("Sessione OAuth recuperata con successo"),this.authState="authenticated",this.cleanupOAuthUrl();const e=sessionStorage.getItem("redirectUrl");e?(sessionStorage.removeItem("redirectUrl"),window.location.hash=e):window.location.hash="#home"}return e.session}catch(e){throw console.error("Errore nella gestione del callback OAuth:",e),this.clearCorruptedState(),e}}clearCorruptedState(){l.log("Pulisco stato corrotto OAuth..."),h.clearCorruptedState(),this.cleanupOAuthUrl(),this.authState="idle",this.errorState=null}cleanupOAuthUrl(){if(window.location.hash.includes("access_token")||window.location.search.includes("code")){const e=window.location.hash.split("&")[0],t=window.location.pathname+(e&&"#"!==e?e:"");window.history.replaceState({},document.title,t),l.log("URL pulito da parametri OAuth, nuovo URL:",t)}}async signInWithGoogle(){try{await h.onReady(),"error"===this.authState&&(l.log("Stato di errore rilevato, pulisco..."),this.clearCorruptedState(),await new Promise(e=>setTimeout(e,100))),this.authState="authenticating";const e=window.location.origin+window.location.pathname+window.location.hash;l.log("Iniziando login OAuth con redirect:",e);const{data:t,error:i}=await d.auth.signInWithOAuth({provider:"google",options:{redirectTo:e,queryParams:{}}});if(i)throw console.error("Errore nella chiamata OAuth:",i),this.authState="error",this.errorState=i,i;return l.log("Login OAuth iniziato con successo:",t),{success:!0,data:t}}catch(e){return console.error("Errore completo nel login OAuth:",e),401===e.status&&(l.log("Errore 401 rilevato, pulisco stato corrotto..."),this.clearCorruptedState()),this.authState="error",this.errorState=e,{success:!1,error:e.message}}}getAuthState(){return{state:this.authState,error:this.errorState,isInitialized:this.isInitialized}}};let p={session:void 0,profile:null};async function m(e){try{if("undefined"!=typeof window&&window.__PW_E2E_AUTH_MOCK){e?.user?(p.session=e,p.profile={id:e.user.id,username:e.user.email?.split("@")[0]||"e2e-user",full_name:e.user.user_metadata?.full_name||e.user.user_metadata?.name||e.user.email||"E2E User",role:"editor",email:e.user.email,fallback:!0}):(p.session=null,p.profile=null);try{window.dispatchEvent(new CustomEvent("auth:session-changed",{detail:{session:e}}))}catch{}return window.dispatchEvent(new CustomEvent("auth-profile-loaded")),void 0}}catch{}if(e?.user){const t=await async function(e){if(!e)return null;try{const{data:t,error:i,status:n}=await d.from("profiles").select("username, full_name, role").eq("id",e.id).single();if(i&&406!==n)throw i;return t}catch(t){console.error("Errore nel recuperare il profilo utente:",t);try{const{data:t}=await d.rpc("get_user_role_safe",{user_uuid:e.id}),i=t||"editor";return console.info("✅ Ruolo recuperato con funzione sicura:",i),{id:e.id,username:e.email?.split("@")[0]||"utente",full_name:e.user_metadata?.full_name||e.user_metadata?.name||e.email||"Utente",role:i,email:e.email,fallback:!0}}catch(i){return console.error("❌ Errore nel recupero ruolo sicuro, uso fallback minimo:",i),null}}}(e.user);p.session=e,t?p.profile=t:(console.warn("⚠️ Profilo non disponibile, uso fallback per:",e.user.email),p.profile={id:e.user.id,username:e.user.email?.split("@")[0]||"utente",full_name:e.user.user_metadata?.full_name||e.user.user_metadata?.name||e.user.email||"Utente",role:"editor",email:e.user.email,fallback:!0})}else p.session=null,p.profile=null;try{window.dispatchEvent(new CustomEvent("auth:session-changed",{detail:{session:e}}))}catch{}window.dispatchEvent(new CustomEvent("auth-profile-loaded"))}async function f(){try{const{error:e}=await d.auth.signOut();if(e)throw e;return{success:!0}}catch(e){return console.error("Errore durante il signOut:",e),{success:!1,error:e.message}}}let y=window.innerWidth<=767;function b(){const e=document.querySelector(".navbar"),t=document.querySelector(".mobile-navbar");if(!e||!t)return;const i=window.innerWidth<=767;if(i===y)return e.classList.toggle("d-none",i),t.classList.toggle("d-none",!i),void 0;y=i,l.log("Mode changed to: "+(i?"mobile":"desktop"));const n=new CustomEvent("mode:change",{detail:{isMobile:i}});window.dispatchEvent(n),e.classList.toggle("d-none",i),t.classList.toggle("d-none",!i),i&&v()}function v(){const e=document.getElementById("mobile-auth-container"),t=document.getElementById("mobile-home-link");if(!e||!t)return;if(p.session){const i=document.createElement("span");i.className="material-icons",i.title="Logout",i.textContent="logout",e.replaceChildren(i),e.onclick=async e=>{e.preventDefault(),await f()},t.classList.add("navbar-home-logged")}else{const i=document.createElement("span");i.className="material-icons",i.title="Login",i.textContent="login",e.replaceChildren(i),e.onclick=e=>{e.preventDefault();const t=document.getElementById("login-modal-trigger");t&&t.click()},t.classList.remove("navbar-home-logged")}}const{entries:w,setPrototypeOf:E,isFrozen:S,getPrototypeOf:_,getOwnPropertyDescriptor:C}=Object;let{freeze:T,seal:A,create:z}=Object,{apply:L,construct:k}="undefined"!=typeof Reflect&&Reflect;T||(T=function(e){return e}),A||(A=function(e){return e}),L||(L=function(e,t,i){return e.apply(t,i)}),k||(k=function(e,t){return new e(...t)});const x=G(Array.prototype.forEach),O=G(Array.prototype.lastIndexOf),D=G(Array.prototype.pop),N=G(Array.prototype.push),I=G(Array.prototype.splice),M=G(String.prototype.toLowerCase),R=G(String.prototype.toString),P=G(String.prototype.match),F=G(String.prototype.replace),$=G(String.prototype.indexOf),j=G(String.prototype.trim),U=G(Object.prototype.hasOwnProperty),V=G(RegExp.prototype.test),B=(H=TypeError,function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return k(H,t)});var H;function G(e){return function(t){t instanceof RegExp&&(t.lastIndex=0);for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return L(e,t,n)}}function W(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:M;E&&E(e,null);let n=t.length;for(;n--;){let r=t[n];if("string"==typeof r){const e=i(r);e!==r&&(S(t)||(t[n]=e),r=e)}e[r]=!0}return e}function q(e){for(let t=0;t<e.length;t++){U(e,t)||(e[t]=null)}return e}function J(e){const t=z(null);for(const[i,n]of w(e)){U(e,i)&&(t[i]=Array.isArray(n)?q(n):n&&"object"==typeof n&&n.constructor===Object?J(n):n)}return t}function Y(e,t){for(;null!==e;){const i=C(e,t);if(i){if(i.get)return G(i.get);if("function"==typeof i.value)return G(i.value)}e=_(e)}return function(){return null}}const X=T(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),K=T(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Q=T(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Z=T(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),ee=T(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),te=T(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),ie=T(["#text"]),ne=T(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),re=T(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),oe=T(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),ae=T(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),se=A(/\{\{[\w\W]*|[\w\W]*\}\}/gm),ce=A(/<%[\w\W]*|[\w\W]*%>/gm),le=A(/\$\{[\w\W]*/gm),de=A(/^data-[\-\w.\u00B7-\uFFFF]+$/),ue=A(/^aria-[\-\w]+$/),he=A(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),ge=A(/^(?:\w+script|data):/i),pe=A(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),me=A(/^html$/i),fe=A(/^[a-z][.\w]*(-[.\w]+)+$/i);var ye=Object.freeze({__proto__:null,ARIA_ATTR:ue,ATTR_WHITESPACE:pe,CUSTOM_ELEMENT:fe,DATA_ATTR:de,DOCTYPE_NAME:me,ERB_EXPR:ce,IS_ALLOWED_URI:he,IS_SCRIPT_OR_DATA:ge,MUSTACHE_EXPR:se,TMPLIT_EXPR:le});const be=1,ve=3,we=7,Ee=8,Se=9;var _e=function e(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"undefined"==typeof window?null:window;const i=t=>e(t);if(i.version="3.2.6",i.removed=[],!t||!t.document||t.document.nodeType!==Se||!t.Element)return i.isSupported=!1,i;let{document:n}=t;const r=n,o=r.currentScript,{DocumentFragment:a,HTMLTemplateElement:s,Node:c,Element:l,NodeFilter:d,NamedNodeMap:u=t.NamedNodeMap||t.MozNamedAttrMap,HTMLFormElement:h,DOMParser:g,trustedTypes:p}=t,m=l.prototype,f=Y(m,"cloneNode"),y=Y(m,"remove"),b=Y(m,"nextSibling"),v=Y(m,"childNodes"),E=Y(m,"parentNode");if("function"==typeof s){const e=n.createElement("template");e.content&&e.content.ownerDocument&&(n=e.content.ownerDocument)}let S,_="";const{implementation:C,createNodeIterator:A,createDocumentFragment:L,getElementsByTagName:k}=n,{importNode:H}=r;let G={afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]};i.isSupported="function"==typeof w&&"function"==typeof E&&C&&void 0!==C.createHTMLDocument;const{MUSTACHE_EXPR:q,ERB_EXPR:se,TMPLIT_EXPR:ce,DATA_ATTR:le,ARIA_ATTR:de,IS_SCRIPT_OR_DATA:ue,ATTR_WHITESPACE:ge,CUSTOM_ELEMENT:pe}=ye;let{IS_ALLOWED_URI:fe}=ye,_e=null;const Ce=W({},[...X,...K,...Q,...ee,...ie]);let Te=null;const Ae=W({},[...ne,...re,...oe,...ae]);let ze=Object.seal(z(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Le=null,ke=null,xe=!0,Oe=!0,De=!1,Ne=!0,Ie=!1,Me=!0,Re=!1,Pe=!1,Fe=!1,$e=!1,je=!1,Ue=!1,Ve=!0,Be=!1,He=!0,Ge=!1,We={},qe=null;const Je=W({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let Ye=null;const Xe=W({},["audio","video","img","source","image","track"]);let Ke=null;const Qe=W({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Ze="http://www.w3.org/1998/Math/MathML",et="http://www.w3.org/2000/svg",tt="http://www.w3.org/1999/xhtml";let it=tt,nt=!1,rt=null;const ot=W({},[Ze,et,tt],R);let at=W({},["mi","mo","mn","ms","mtext"]),st=W({},["annotation-xml"]);const ct=W({},["title","style","font","a","script"]);let lt=null;const dt=["application/xhtml+xml","text/html"];let ut=null,ht=null;const gt=n.createElement("form"),pt=function(e){return e instanceof RegExp||e instanceof Function},mt=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!ht||ht!==e){if(e&&"object"==typeof e||(e={}),e=J(e),lt=-1===dt.indexOf(e.PARSER_MEDIA_TYPE)?"text/html":e.PARSER_MEDIA_TYPE,ut="application/xhtml+xml"===lt?R:M,_e=U(e,"ALLOWED_TAGS")?W({},e.ALLOWED_TAGS,ut):Ce,Te=U(e,"ALLOWED_ATTR")?W({},e.ALLOWED_ATTR,ut):Ae,rt=U(e,"ALLOWED_NAMESPACES")?W({},e.ALLOWED_NAMESPACES,R):ot,Ke=U(e,"ADD_URI_SAFE_ATTR")?W(J(Qe),e.ADD_URI_SAFE_ATTR,ut):Qe,Ye=U(e,"ADD_DATA_URI_TAGS")?W(J(Xe),e.ADD_DATA_URI_TAGS,ut):Xe,qe=U(e,"FORBID_CONTENTS")?W({},e.FORBID_CONTENTS,ut):Je,Le=U(e,"FORBID_TAGS")?W({},e.FORBID_TAGS,ut):J({}),ke=U(e,"FORBID_ATTR")?W({},e.FORBID_ATTR,ut):J({}),We=!!U(e,"USE_PROFILES")&&e.USE_PROFILES,xe=!1!==e.ALLOW_ARIA_ATTR,Oe=!1!==e.ALLOW_DATA_ATTR,De=e.ALLOW_UNKNOWN_PROTOCOLS||!1,Ne=!1!==e.ALLOW_SELF_CLOSE_IN_ATTR,Ie=e.SAFE_FOR_TEMPLATES||!1,Me=!1!==e.SAFE_FOR_XML,Re=e.WHOLE_DOCUMENT||!1,$e=e.RETURN_DOM||!1,je=e.RETURN_DOM_FRAGMENT||!1,Ue=e.RETURN_TRUSTED_TYPE||!1,Fe=e.FORCE_BODY||!1,Ve=!1!==e.SANITIZE_DOM,Be=e.SANITIZE_NAMED_PROPS||!1,He=!1!==e.KEEP_CONTENT,Ge=e.IN_PLACE||!1,fe=e.ALLOWED_URI_REGEXP||he,it=e.NAMESPACE||tt,at=e.MATHML_TEXT_INTEGRATION_POINTS||at,st=e.HTML_INTEGRATION_POINTS||st,ze=e.CUSTOM_ELEMENT_HANDLING||{},e.CUSTOM_ELEMENT_HANDLING&&pt(e.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(ze.tagNameCheck=e.CUSTOM_ELEMENT_HANDLING.tagNameCheck),e.CUSTOM_ELEMENT_HANDLING&&pt(e.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(ze.attributeNameCheck=e.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),e.CUSTOM_ELEMENT_HANDLING&&"boolean"==typeof e.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements&&(ze.allowCustomizedBuiltInElements=e.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Ie&&(Oe=!1),je&&($e=!0),We&&(_e=W({},ie),Te=[],!0===We.html&&(W(_e,X),W(Te,ne)),!0===We.svg&&(W(_e,K),W(Te,re),W(Te,ae)),!0===We.svgFilters&&(W(_e,Q),W(Te,re),W(Te,ae)),!0===We.mathMl&&(W(_e,ee),W(Te,oe),W(Te,ae))),e.ADD_TAGS&&(_e===Ce&&(_e=J(_e)),W(_e,e.ADD_TAGS,ut)),e.ADD_ATTR&&(Te===Ae&&(Te=J(Te)),W(Te,e.ADD_ATTR,ut)),e.ADD_URI_SAFE_ATTR&&W(Ke,e.ADD_URI_SAFE_ATTR,ut),e.FORBID_CONTENTS&&(qe===Je&&(qe=J(qe)),W(qe,e.FORBID_CONTENTS,ut)),He&&(_e["#text"]=!0),Re&&W(_e,["html","head","body"]),_e.table&&(W(_e,["tbody"]),delete Le.tbody),e.TRUSTED_TYPES_POLICY){if("function"!=typeof e.TRUSTED_TYPES_POLICY.createHTML)throw B('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if("function"!=typeof e.TRUSTED_TYPES_POLICY.createScriptURL)throw B('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');S=e.TRUSTED_TYPES_POLICY,_=S.createHTML("")}else void 0===S&&(S=function(e,t){if("object"!=typeof e||"function"!=typeof e.createPolicy)return null;let i=null;const n="data-tt-policy-suffix";t&&t.hasAttribute(n)&&(i=t.getAttribute(n));const r="dompurify"+(i?"#"+i:"");try{return e.createPolicy(r,{createHTML:e=>e,createScriptURL:e=>e})}catch(o){return console.warn("TrustedTypes policy "+r+" could not be created."),null}}(p,o)),null!==S&&"string"==typeof _&&(_=S.createHTML(""));T&&T(e),ht=e}},ft=W({},[...K,...Q,...Z]),yt=W({},[...ee,...te]),bt=function(e){N(i.removed,{element:e});try{E(e).removeChild(e)}catch(t){y(e)}},vt=function(e,t){try{N(i.removed,{attribute:t.getAttributeNode(e),from:t})}catch(n){N(i.removed,{attribute:null,from:t})}if(t.removeAttribute(e),"is"===e)if($e||je)try{bt(t)}catch(n){}else try{t.setAttribute(e,"")}catch(n){}},wt=function(e){let t=null,i=null;if(Fe)e="<remove></remove>"+e;else{const t=P(e,/^[\r\n\t ]+/);i=t&&t[0]}"application/xhtml+xml"===lt&&it===tt&&(e='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+e+"</body></html>");const r=S?S.createHTML(e):e;if(it===tt)try{t=(new g).parseFromString(r,lt)}catch(a){}if(!t||!t.documentElement){t=C.createDocument(it,"template",null);try{t.documentElement.innerHTML=nt?_:r}catch(a){}}const o=t.body||t.documentElement;return e&&i&&o.insertBefore(n.createTextNode(i),o.childNodes[0]||null),it===tt?k.call(t,Re?"html":"body")[0]:Re?t.documentElement:o},Et=function(e){return A.call(e.ownerDocument||e,e,d.SHOW_ELEMENT|d.SHOW_COMMENT|d.SHOW_TEXT|d.SHOW_PROCESSING_INSTRUCTION|d.SHOW_CDATA_SECTION,null)},St=function(e){return e instanceof h&&("string"!=typeof e.nodeName||"string"!=typeof e.textContent||"function"!=typeof e.removeChild||!(e.attributes instanceof u)||"function"!=typeof e.removeAttribute||"function"!=typeof e.setAttribute||"string"!=typeof e.namespaceURI||"function"!=typeof e.insertBefore||"function"!=typeof e.hasChildNodes)},_t=function(e){return"function"==typeof c&&e instanceof c};function Ct(e,t,n){x(e,e=>{e.call(i,t,n,ht)})}const Tt=function(e){let t=null;if(Ct(G.beforeSanitizeElements,e,null),St(e))return bt(e),!0;const n=ut(e.nodeName);if(Ct(G.uponSanitizeElement,e,{tagName:n,allowedTags:_e}),Me&&e.hasChildNodes()&&!_t(e.firstElementChild)&&V(/<[/\w!]/g,e.innerHTML)&&V(/<[/\w!]/g,e.textContent))return bt(e),!0;if(e.nodeType===we)return bt(e),!0;if(Me&&e.nodeType===Ee&&V(/<[/\w]/g,e.data))return bt(e),!0;if(!_e[n]||Le[n]){if(!Le[n]&&zt(n)){if(ze.tagNameCheck instanceof RegExp&&V(ze.tagNameCheck,n))return!1;if(ze.tagNameCheck instanceof Function&&ze.tagNameCheck(n))return!1}if(He&&!qe[n]){const t=E(e)||e.parentNode,i=v(e)||e.childNodes;if(i&&t){for(let n=i.length-1;n>=0;--n){const r=f(i[n],!0);r.__removalCount=(e.__removalCount||0)+1,t.insertBefore(r,b(e))}}}return bt(e),!0}return e instanceof l&&!function(e){let t=E(e);t&&t.tagName||(t={namespaceURI:it,tagName:"template"});const i=M(e.tagName),n=M(t.tagName);return!!rt[e.namespaceURI]&&(e.namespaceURI===et?t.namespaceURI===tt?"svg"===i:t.namespaceURI===Ze?"svg"===i&&("annotation-xml"===n||at[n]):Boolean(ft[i]):e.namespaceURI===Ze?t.namespaceURI===tt?"math"===i:t.namespaceURI===et?"math"===i&&st[n]:Boolean(yt[i]):e.namespaceURI===tt?!(t.namespaceURI===et&&!st[n])&&!(t.namespaceURI===Ze&&!at[n])&&!yt[i]&&(ct[i]||!ft[i]):!("application/xhtml+xml"!==lt||!rt[e.namespaceURI]))}(e)?(bt(e),!0):"noscript"!==n&&"noembed"!==n&&"noframes"!==n||!V(/<\/no(script|embed|frames)/i,e.innerHTML)?(Ie&&e.nodeType===ve&&(t=e.textContent,x([q,se,ce],e=>{t=F(t,e," ")}),e.textContent!==t&&(N(i.removed,{element:e.cloneNode()}),e.textContent=t)),Ct(G.afterSanitizeElements,e,null),!1):(bt(e),!0)},At=function(e,t,i){if(Ve&&("id"===t||"name"===t)&&(i in n||i in gt))return!1;if(Oe&&!ke[t]&&V(le,t));else if(xe&&V(de,t));else if(!Te[t]||ke[t]){if(!(zt(e)&&(ze.tagNameCheck instanceof RegExp&&V(ze.tagNameCheck,e)||ze.tagNameCheck instanceof Function&&ze.tagNameCheck(e))&&(ze.attributeNameCheck instanceof RegExp&&V(ze.attributeNameCheck,t)||ze.attributeNameCheck instanceof Function&&ze.attributeNameCheck(t))||"is"===t&&ze.allowCustomizedBuiltInElements&&(ze.tagNameCheck instanceof RegExp&&V(ze.tagNameCheck,i)||ze.tagNameCheck instanceof Function&&ze.tagNameCheck(i))))return!1}else if(Ke[t]);else if(V(fe,F(i,ge,"")));else if("src"!==t&&"xlink:href"!==t&&"href"!==t||"script"===e||0!==$(i,"data:")||!Ye[e]){if(De&&!V(ue,F(i,ge,"")));else if(i)return!1}else;return!0},zt=function(e){return"annotation-xml"!==e&&P(e,pe)},Lt=function(e){Ct(G.beforeSanitizeAttributes,e,null);const{attributes:t}=e;if(!t||St(e))return;const n={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:Te,forceKeepAttr:void 0};let r=t.length;for(;r--;){const a=t[r],{name:s,namespaceURI:c,value:l}=a,d=ut(s),u=l;let h="value"===s?u:j(u);if(n.attrName=d,n.attrValue=h,n.keepAttr=!0,n.forceKeepAttr=void 0,Ct(G.uponSanitizeAttribute,e,n),h=n.attrValue,!Be||"id"!==d&&"name"!==d||(vt(s,e),h="user-content-"+h),Me&&V(/((--!?|])>)|<\/(style|title)/i,h)){vt(s,e);continue}if(n.forceKeepAttr)continue;if(!n.keepAttr){vt(s,e);continue}if(!Ne&&V(/\/>/i,h)){vt(s,e);continue}Ie&&x([q,se,ce],e=>{h=F(h,e," ")});const g=ut(e.nodeName);if(At(g,d,h)){if(S&&"object"==typeof p&&"function"==typeof p.getAttributeType)if(c);else switch(p.getAttributeType(g,d)){case"TrustedHTML":h=S.createHTML(h);break;case"TrustedScriptURL":h=S.createScriptURL(h)}if(h!==u)try{c?e.setAttributeNS(c,s,h):e.setAttribute(s,h),St(e)?bt(e):D(i.removed)}catch(o){vt(s,e)}}else vt(s,e)}Ct(G.afterSanitizeAttributes,e,null)},kt=function e(t){let i=null;const n=Et(t);for(Ct(G.beforeSanitizeShadowDOM,t,null);i=n.nextNode();)Ct(G.uponSanitizeShadowNode,i,null),Tt(i),Lt(i),i.content instanceof a&&e(i.content);Ct(G.afterSanitizeShadowDOM,t,null)};return i.sanitize=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=null,o=null,s=null,l=null;if(nt=!e,nt&&(e="\x3c!--\x3e"),"string"!=typeof e&&!_t(e)){if("function"!=typeof e.toString)throw B("toString is not a function");if("string"!=typeof(e=e.toString()))throw B("dirty is not a string, aborting")}if(!i.isSupported)return e;if(Pe||mt(t),i.removed=[],"string"==typeof e&&(Ge=!1),Ge){if(e.nodeName){const t=ut(e.nodeName);if(!_e[t]||Le[t])throw B("root node is forbidden and cannot be sanitized in-place")}}else if(e instanceof c)n=wt("\x3c!----\x3e"),o=n.ownerDocument.importNode(e,!0),o.nodeType===be&&"BODY"===o.nodeName||"HTML"===o.nodeName?n=o:n.appendChild(o);else{if(!$e&&!Ie&&!Re&&-1===e.indexOf("<"))return S&&Ue?S.createHTML(e):e;if(n=wt(e),!n)return $e?null:Ue?_:""}n&&Fe&&bt(n.firstChild);const d=Et(Ge?e:n);for(;s=d.nextNode();)Tt(s),Lt(s),s.content instanceof a&&kt(s.content);if(Ge)return e;if($e){if(je)for(l=L.call(n.ownerDocument);n.firstChild;)l.appendChild(n.firstChild);else l=n;return(Te.shadowroot||Te.shadowrootmode)&&(l=H.call(r,l,!0)),l}let u=Re?n.outerHTML:n.innerHTML;return Re&&_e["!doctype"]&&n.ownerDocument&&n.ownerDocument.doctype&&n.ownerDocument.doctype.name&&V(me,n.ownerDocument.doctype.name)&&(u="<!DOCTYPE "+n.ownerDocument.doctype.name+">\n"+u),Ie&&x([q,se,ce],e=>{u=F(u,e," ")}),S&&Ue?S.createHTML(u):u},i.setConfig=function(){mt(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}),Pe=!0},i.clearConfig=function(){ht=null,Pe=!1},i.isValidAttribute=function(e,t,i){ht||mt({});const n=ut(e),r=ut(t);return At(n,r,i)},i.addHook=function(e,t){"function"==typeof t&&N(G[e],t)},i.removeHook=function(e,t){if(void 0!==t){const i=O(G[e],t);return-1===i?void 0:I(G[e],i,1)[0]}return D(G[e])},i.removeHooks=function(e){G[e]=[]},i.removeAllHooks=function(){G={afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}},i}();function Ce(e){if(!e)return"";try{return _e.sanitize(e)}catch(t){return console.warn("Error sanitizing HTML:",t),String(e).replace(/</g,"&lt;").replace(/>/g,"&gt;")}}let Te=null,Ae=!1;const ze={inserimento:()=>t(()=>import("./form-pMK8clq8.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),dimissione:()=>t(()=>import("./dimissione-i-kj54A9.js"),__vite__mapDeps([11,12,1,2,7,9,3,4,5,13,14])),grafico:()=>t(()=>import("./grafico-Q9PhXSvN.js"),__vite__mapDeps([15,16,1,3,4,5,17,7])),list:()=>t(()=>import("./list-DWBrk7pA.js"),__vite__mapDeps([18,1,12,2,7,8,14,5,16])),diagnosi:()=>t(()=>import("./diagnosi-DsYXSrjE.js"),__vite__mapDeps([19,1,7])),"eventi-clinici":()=>t(()=>import("./eventi-clinici-DUU-a97n.js"),__vite__mapDeps([20,1,14,2,13,12,7,3,4,5]))},Le=new Map,ke=Object.assign({"/src/views/access-denied.html":()=>t(()=>import("./access-denied-qNA2WfrE.js"),[]).then(e=>e.default),"/src/views/auth-modal.html":()=>t(()=>import("./auth-modal-VMurGtIz.js"),[]).then(e=>e.default),"/src/views/diagnosi.html":()=>t(()=>import("./diagnosi-Cwkqnh9y.js"),[]).then(e=>e.default),"/src/views/dimissione.html":()=>t(()=>import("./dimissione-Btfp9upn.js"),[]).then(e=>e.default),"/src/views/eventi-clinici.html":()=>t(()=>import("./eventi-clinici-D-JWmn83.js"),[]).then(e=>e.default),"/src/views/grafico.html":()=>t(()=>import("./grafico-DyPZBtMB.js"),[]).then(e=>e.default),"/src/views/home.html":()=>t(()=>import("./home-fApaPaO7.js"),[]).then(e=>e.default),"/src/views/inserimento.html":()=>t(()=>import("./inserimento-B2V9ZJKD.js"),[]).then(e=>e.default),"/src/views/list.html":()=>t(()=>import("./list-oHAJ5ahF.js"),[]).then(e=>e.default),"/src/views/login-required.html":()=>t(()=>import("./login-required-DkOrvptO.js"),[]).then(e=>e.default)});function xe(){const e=p.profile?.role;l.log("Updating UI visibility based on role:",e);const t={inserimento:["admin","editor"],list:["admin","editor","viewer"],grafico:["admin","editor","viewer"],diagnosi:["admin"],dimissione:["admin","editor"],"eventi-clinici":["admin","editor"]};document.querySelectorAll(".menu-card").forEach(i=>{const n=i.dataset.view;t[n]&&(i.style.display=e&&t[n].includes(e)?"block":"none")})}async function Oe(e){if(Le.has(e))return Le.get(e);const t=`/src/views/${e}.html`;if(!ke[t])return console.error(`Vista non trovata: ${e} (path cercato: ${t})`),l.error(`Vista HTML non trovata: ${e}`),"home"!==e?await Oe("home"):'\n                <div class="container mt-4">\n                    <div class="alert alert-danger" role="alert">\n                        <h4 class="alert-heading">Errore critico</h4>\n                        <p>Impossibile caricare le viste dell\'applicazione.</p>\n                        <button class="btn btn-primary" onclick="location.reload()">Ricarica pagina</button>\n                    </div>\n                </div>\n            ';try{const i=await ke[t]();if(!i||"string"!=typeof i)throw new Error(`Contenuto vista ${e} non valido`);return Le.set(e,i),i}catch(i){return console.error("Errore nel caricamento della vista:",e,i),l.error(`Fallimento caricamento vista HTML ${e}:`,i),"home"!==e?await Oe("home"):'\n                <div class="container mt-4">\n                    <div class="alert alert-danger" role="alert">\n                        <h4 class="alert-heading">Errore di caricamento</h4>\n                        <p>Si è verificato un errore nel caricamento della vista.</p>\n                        <button class="btn btn-primary" onclick="location.reload()">Ricarica pagina</button>\n                        \n                    </div>\n                </div>\n            '}}function De(e){window.location.hash=e}async function Ne(){if(Ae)return l.warn("Navigazione già in corso, interrotta."),void 0;Ae=!0;const e=document.getElementById("view-container");try{if("function"==typeof Te&&(Te(),Te=null),window.location.hash.includes("access_token="))return;if(void 0===p.session)return;const i=window.location.hash.replace(/^#\/?/,"");if(!p.session&&(""===i||"home"===i||"list"===i))return window.location.hash="login-required",void 0;if(!e)return console.error("Fatal: #view-container non trovato."),void 0;e.innerHTML=Ce('<div class="d-flex justify-content-center align-items-center" style="height: 80vh;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');const n=window.location.hash.replace(/^#\/?/,"")||"home",[r,o]=n.split("?"),a=new URLSearchParams(o),s={inserimento:["admin","editor"],list:["admin","editor","viewer"],grafico:["admin","editor","viewer"],diagnosi:["admin"],dimissione:["admin","editor"],"eventi-clinici":["admin","editor"]};let u=r;Object.keys(s).includes(r)&&!p.session?(sessionStorage.setItem("redirectUrl",n),u="login-required"):s[r]&&!s[r].includes(p.profile?.role)&&p.profile&&(u="access-denied");const h=await Oe(u);e.innerHTML=Ce(h);const g=e.querySelector(".view");g.offsetHeight,g&&g.classList.add("active");const m=ze[u];if(m)try{const e=await async function(e,t=3,i=1e3){let n;for(let o=1;o<=t;o++)try{return await e()}catch(r){if(n=r,l.warn(`Tentativo ${o}/${t} fallito per import dinamico:`,r.message),o===t)throw n;const e=i*Math.pow(2,o-1);await new Promise(t=>setTimeout(t,e))}}(m);if(!e)throw new Error(`Modulo ${u} caricato ma vuoto`);if("list"===u){const t=await e.fetchListData();Te=await e.initListView(t)}else if("diagnosi"===u)Te=await e.initDiagnosiView(a);else if("grafico"===u)Te=await e.initGraficoView(a);else if("inserimento"===u)Te=await e.initInserimentoView(a);else if("dimissione"===u)Te=await e.initDimissioneView(a);else if("eventi-clinici"===u)Te=await e.initEventiCliniciView(a);else{const t=Object.values(e).find(e=>"function"==typeof e&&e.name.startsWith("init"));t&&(Te=await t(a))}}catch(t){return console.error("Errore nel caricamento del modulo:",u,t),l.error(`Fallimento caricamento modulo ${u}:`,t),e.innerHTML=Ce(`\n                    <div class="container mt-4">\n                        <div class="alert alert-warning" role="alert">\n                            <h4 class="alert-heading">\n                                <span class="material-icons me-2" style="vertical-align: middle;">warning</span>\n                                Problema di caricamento\n                            </h4>\n                            <p>Si è verificato un problema nel caricamento di questa sezione dell'applicazione.</p>\n                            <hr>\n                            <div class="d-flex gap-2">\n                                <button class="btn btn-primary" onclick="location.reload()">\n                                    <span class="material-icons me-1" style="vertical-align: middle;">refresh</span>\n                                    Ricarica pagina\n                                </button>\n                                <button class="btn btn-outline-secondary" onclick="window.location.hash = 'home'">\n                                    <span class="material-icons me-1" style="vertical-align: middle;">home</span>\n                                    Torna alla home\n                                </button>\n                            </div>\n                            ${c?`<details class="mt-3"><summary>Dettagli tecnici (solo sviluppo)</summary><pre class="small mt-2">${t.stack||t.message}</pre></details>`:""}\n                        </div>\n                    </div>\n                `),void 0}else if("home"===u)xe(),document.querySelectorAll(".menu-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.view;"inserimento"===t&&sessionStorage.removeItem("editPazienteId"),De(t)})});else if("login-required"===u){const e=document.getElementById("login-prompt-button");e&&e.addEventListener("click",()=>{d.auth.signInWithOAuth({provider:"google"})})}const f=new CustomEvent("viewChanged",{detail:{view:u,params:a}});document.dispatchEvent(f)}catch(i){console.error("Errore durante il rendering della vista:",i),e&&(e.innerHTML=Ce('<div class="alert alert-danger m-3">Si è verificato un errore critico. Si prega di ricaricare la pagina.</div>'))}finally{Ae=!1}}function Ie(){void window.addEventListener("error",e=>{if(["A listener indicated an asynchronous response by returning true","Extension context invalidated","Could not establish connection","chrome-extension://","moz-extension://"].some(t=>e.message&&e.message.includes(t)))return console.debug("Browser extension error ignored:",e.message),e.preventDefault(),!1;console.error("Application error:",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,error:e.error})}),window.addEventListener("unhandledrejection",e=>{const t=e.reason?.message||e.reason?.toString()||"";if(["A listener indicated an asynchronous response by returning true","message channel closed before a response was received","Extension context invalidated","Could not establish connection"].some(e=>t.includes(e)))return console.debug("Browser extension promise rejection ignored:",t),e.preventDefault(),void 0;console.error("Unhandled promise rejection:",e.reason)}),window.appLogger={info:(e,t=null)=>{l.log(`[APP] ${e}`,t||"")},warn:(e,t=null)=>{l.warn(`[APP WARNING] ${e}`,t||"")},error:(e,t=null)=>{console.error("[APP ERROR]",e,t||"")},debug:(e,t=null)=>{"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname||l.log(`[APP DEBUG] ${e}`,t||"")}},window.appLogger.info("Error service and logger initialized.",{timestamp:(new Date).toISOString()})}window.addEventListener("auth-profile-loaded",xe);class Me{constructor(){this.logger=l}getLegendOptions(e={}){return{position:e.position||"right",align:e.align||"start",labels:{boxWidth:e.boxWidth||20,font:{size:e.fontSize||14},padding:e.padding||20,usePointStyle:!0,generateLabels:this._generateLabels.bind(this)},onClick:this._handleLegendClick.bind(this)}}_generateLabels(e){try{const t=e.data;return t.labels?.length&&t.datasets?.length?t.labels.map((i,n)=>{const r=this._getDatasetColor(t.datasets[0],n),o=e.getDatasetMeta(0);return{text:i,fillStyle:r,strokeStyle:r,lineWidth:0,pointStyle:"circle",hidden:!!o.data[n]&&o.data[n].hidden,index:n}}):[]}catch(t){return this.logger.error("Errore nella generazione delle etichette della legenda:",t),[]}}_handleLegendClick(e,t,i){try{const e=t.index,n=i.chart,r=n.getDatasetMeta(0);r.data[e]&&(r.data[e].hidden=!r.data[e].hidden,n.update(),this._updateContainerState(n,e,r.data[e].hidden),this.logger.debug(`Toggle visibilità elemento ${e}: ${r.data[e].hidden?"nascosto":"visibile"}`))}catch(n){this.logger.error("Errore nella gestione del click sulla legenda:",n)}}_updateContainerState(e,t,i){try{const n=e.canvas.parentNode;if(n){const e=n.querySelector(`.chart-legend-item-${t}`);e&&e.classList.toggle("filtered",i)}}catch(n){this.logger.warn("Impossibile aggiornare lo stato del container:",n)}}_getDatasetColor(e,t){return e.backgroundColor&&Array.isArray(e.backgroundColor)?e.backgroundColor[t]||"#666":e.backgroundColor&&"function"==typeof e.backgroundColor?e.backgroundColor(t)||"#666":e.backgroundColor||"#666"}}class Re extends Me{getLegendOptions(e={}){const t=super.getLegendOptions(e);return{...t,position:"right",align:"start",labels:{...t.labels,boxWidth:20,font:{size:14},padding:20}}}}class Pe extends Me{getLegendOptions(e={}){const t=super.getLegendOptions(e);return{...t,position:"bottom",align:"center",labels:{...t.labels,boxWidth:15,font:{size:12},padding:15}}}_handleLegendClick(e,t,i){super._handleLegendClick(e,t,i),this._showMobileFeedback(t,i)}_showMobileFeedback(e,t){try{const i=t.chart,n=e.index,r=i.getDatasetMeta(0),o=r.data[n]?.hidden;this._showToast(`${o?"Nascosto":"Mostrato"}: ${i.data.labels[n]}`,"mobile")}catch(i){this.logger.warn("Impossibile mostrare feedback mobile:",i)}}_showToast(e,t,i=2e3){console.log(`[${t.toUpperCase()}] ${e}`)}}class Fe extends Me{getLegendOptions(e={}){const t=super.getLegendOptions(e);return{...t,position:"bottom",align:"center",labels:{...t.labels,boxWidth:18,font:{size:14},padding:18}}}_handleLegendClick(e,t,i){super._handleLegendClick(e,t,i),this._showTabletFeedback(t,i)}_showTabletFeedback(e,t){try{const i=t.chart,n=e.index,r=i.getDatasetMeta(0),o=r.data[n]?.hidden;this._showToast(`${o?"Nascosto":"Mostrato"}: ${i.data.labels[n]}`,"tablet")}catch(i){this.logger.warn("Impossibile mostrare feedback tablet:",i)}}_showToast(e,t,i=2e3){console.log(`[${t.toUpperCase()}] ${e}`)}}class $e{static createAdapter(e="desktop"){switch(e.toLowerCase()){case"mobile":return new Pe;case"tablet":return new Fe;default:return new Re}}}const je=new class{constructor(){this.logger=l,this.adapters=new Map}getAdapter(e="desktop"){return this.adapters.has(e)||this.adapters.set(e,$e.createAdapter(e)),this.adapters.get(e)}preserveLegendOptions(e={},t="desktop",i={}){try{const n=this.getAdapter(t).getLegendOptions(i),r=this._deepMerge(e,{plugins:{legend:n}});return this.logger.debug("Opzioni legenda preservate e combinate:",{deviceType:t,existingOptions:!!e.plugins?.legend,customOptions:Object.keys(i)}),r}catch(n){return this.logger.error("Errore nella preservazione delle opzioni della legenda:",n),e}}_deepMerge(e,t){try{if(this._hasCircularReferences(t))return this.logger.warn("Riferimenti circolari rilevati nel deep merge, uso merge superficiale"),{...e,...t};const i={...e},n=10,r=(e,t,i=0)=>{if(i>n)return this.logger.warn("Profondità massima raggiunta nel deep merge, uso merge superficiale"),{...e,...t};for(const n in t)if(t.hasOwnProperty(n)){const o=t[n];this._isSafeOptionValue(o)?e[n]=o&&"object"==typeof o&&!Array.isArray(o)?r(e[n]||{},o,i+1):o:this.logger.warn(`Valore non sicuro saltato nel deep merge: ${n}`)}return e};return r(i,t)}catch(i){return this.logger.error("Errore nel deep merge, uso merge superficiale:",i),{...e,...t}}}detectDevice(){try{const e=window.innerWidth;return e<768?"mobile":e<1024?"tablet":"desktop"}catch(e){return this.logger.warn("Impossibile rilevare il dispositivo, uso desktop come fallback:",e),"desktop"}}applyToExistingChart(e,t="desktop",i={}){try{if(!e||!e.options)return this.logger.warn("Grafico non valido per l'applicazione delle opzioni"),void 0;if(this._isChartCorrupted(e))return this.logger.warn("Grafico in stato corrotto, applicazione opzioni saltata"),void 0;const n=this.preserveLegendOptions(e.options,t,i);if(this._hasCircularReferences(n)){this.logger.warn("Opzioni con riferimenti circolari rilevate, uso opzioni di fallback");const i=this._getFallbackLegendOptions(t);return this._applySafeOptions(e,i),void 0}this._applySafeOptions(e,n),this.logger.debug("Opzioni preservate applicate al grafico esistente")}catch(n){this.logger.error("Errore nell'applicazione delle opzioni al grafico:",n);try{this.logger.warn("Applicazione fallback delle opzioni...");const i=this._getFallbackLegendOptions(t);this._applySafeOptions(e,i)}catch(r){this.logger.error("Errore anche nel fallback delle opzioni:",r)}}}_isChartCorrupted(e){try{if(!e.options||!e.data||!e.canvas)return!0;const t=Object.keys(e.options);if(t.length>1e3)return!0;for(const i of t)if("function"==typeof e.options[i])return!0;return!1}catch(t){return!0}}_hasCircularReferences(e){try{const t=new WeakSet,i=e=>{if(e&&"object"==typeof e){if(t.has(e))return!0;t.add(e);for(const t in e)if(e.hasOwnProperty(t)&&i(e[t]))return!0}return!1};return i(e)}catch(t){return!0}}_applySafeOptions(e,t){try{const i=this._createSafeOptionsCopy(t);Object.assign(e.options,i),"function"==typeof e.update&&e.update()}catch(i){this.logger.error("Errore nell'applicazione sicura delle opzioni:",i)}}_createSafeOptionsCopy(e){try{const t={};for(const[i,n]of Object.entries(e))this._isSafeOptionValue(n)&&(t[i]=n);return t}catch(t){return this.logger.warn("Errore nella creazione della copia sicura, uso oggetto vuoto:",t),{}}}_isSafeOptionValue(e){if(null==e)return!0;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return!0;if(Array.isArray(e))return e.every(e=>this._isSafeOptionValue(e));if("object"==typeof e)try{const t=Object.keys(e);if(t.length>100)return!1;const i=["plugins","legend","labels","position","display","font","size","color","padding","boxWidth","usePointStyle"];for(const n of t)if(!i.includes(n)){if("function"==typeof e[n])return!1;if(!this._isSafeOptionValue(e[n]))return!1}return!0}catch(t){return!1}return!1}_getFallbackLegendOptions(e){return{plugins:{legend:{display:!0,position:"mobile"===e?"bottom":"right",labels:{font:{size:"mobile"===e?12:14}}}}}}};const Ue=new class{constructor(){this.logger=l}getLegendOptionsForChartType(e,t="desktop",i={}){try{const n=this._getBaseOptionsForChartType(e),r=this._getDeviceSpecificOptions(t),o=this._mergeOptions(n,r,i);return je.preserveLegendOptions({},t,o)}catch(n){return this.logger.error(`Errore nell'ottenimento delle opzioni per ${e}:`,n),this._getFallbackOptions(t)}}_getBaseOptionsForChartType(e){const t={pie:this._getPieChartLegendOptions(),doughnut:this._getDoughnutChartLegendOptions(),bar:this._getBarChartLegendOptions(),line:this._getLineChartLegendOptions(),radar:this._getRadarChartLegendOptions(),polarArea:this._getPolarAreaChartLegendOptions()};return t[e]||t.bar}_getPieChartLegendOptions(){return{position:"right",align:"start",labels:{generateLabels:e=>{const t=e.data;return t.labels?.length&&t.datasets?.length?t.labels.map((e,i)=>{const n=t.datasets[0],r=n.data[i],o=n.percentages?.[i]||this._calculatePercentage(r,t.datasets[0].data),a=this._getDatasetColor(n,i);return{text:`${e} (${o}%)`,fillStyle:a,strokeStyle:a,lineWidth:0,pointStyle:"circle",hidden:!1,index:i}}):[]}}}}_getDoughnutChartLegendOptions(){return{...this._getPieChartLegendOptions(),labels:{...this._getPieChartLegendOptions().labels,generateLabels:e=>{const t=e.data;return t.labels?.length&&t.datasets?.length?t.labels.map((e,i)=>{const n=t.datasets[0],r=n.data[i],o=n.percentages?.[i]||this._calculatePercentage(r,t.datasets[0].data),a=this._getDatasetColor(n,i);return{text:`${e} (${o}%)`,fillStyle:a,strokeStyle:a,lineWidth:0,pointStyle:"rect",hidden:!1,index:i}}):[]}}}}_getBarChartLegendOptions(){return{position:"top",align:"center",labels:{generateLabels:e=>{const t=e.data;return t.datasets?.length?t.datasets.map((e,t)=>{const i=this._getDatasetColor(e,t);return{text:e.label||`Dataset ${t+1}`,fillStyle:i,strokeStyle:i,lineWidth:0,pointStyle:"rect",hidden:e.hidden||!1,index:t}}):[]}}}}_getLineChartLegendOptions(){return{position:"top",align:"center",labels:{generateLabels:e=>{const t=e.data;return t.datasets?.length?t.datasets.map((e,t)=>{const i=this._getDatasetColor(e,t);return{text:e.label||`Dataset ${t+1}`,fillStyle:i,strokeStyle:e.borderColor||i,lineWidth:2,pointStyle:"circle",hidden:e.hidden||!1,index:t}}):[]}}}}_getRadarChartLegendOptions(){return{position:"top",align:"center",labels:{generateLabels:e=>{const t=e.data;return t.datasets?.length?t.datasets.map((e,t)=>{const i=this._getDatasetColor(e,t);return{text:e.label||`Dataset ${t+1}`,fillStyle:i,strokeStyle:e.borderColor||i,lineWidth:2,pointStyle:"circle",hidden:e.hidden||!1,index:t}}):[]}}}}_getPolarAreaChartLegendOptions(){return{position:"right",align:"start",labels:{generateLabels:e=>{const t=e.data;return t.labels?.length&&t.datasets?.length?t.labels.map((e,i)=>{const n=t.datasets[0],r=n.data[i],o=n.percentages?.[i]||this._calculatePercentage(r,t.datasets[0].data),a=this._getDatasetColor(n,i);return{text:`${e} (${o}%)`,fillStyle:a,strokeStyle:a,lineWidth:0,pointStyle:"circle",hidden:!1,index:i}}):[]}}}}_getDeviceSpecificOptions(e){const t={mobile:{position:"bottom",align:"center",labels:{boxWidth:15,font:{size:12},padding:15}},tablet:{position:"bottom",align:"center",labels:{boxWidth:18,font:{size:14},padding:18}},desktop:{position:"right",align:"start",labels:{boxWidth:20,font:{size:14},padding:20}}};return t[e]||t.desktop}_mergeOptions(...e){return e.reduce((e,t)=>{if(!t)return e;for(const i in t)e[i]=t[i]&&"object"==typeof t[i]&&!Array.isArray(t[i])?this._mergeOptions(e[i]||{},t[i]):t[i];return e},{})}_calculatePercentage(e,t){try{const i=t.reduce((e,t)=>e+(t||0),0);return(i>0?e/i*100:0).toFixed(1)}catch(i){return this.logger.warn("Errore nel calcolo della percentuale:",i),"0.0"}}_getDatasetColor(e,t){return e.backgroundColor&&Array.isArray(e.backgroundColor)?e.backgroundColor[t]||"#666":e.backgroundColor&&"function"==typeof e.backgroundColor?e.backgroundColor(t)||"#666":e.backgroundColor||"#666"}_getFallbackOptions(e){return this.logger.warn(`Utilizzo opzioni di fallback per ${e}`),{plugins:{legend:{position:"mobile"===e?"bottom":"right",align:"mobile"===e?"center":"start",labels:{boxWidth:"mobile"===e?15:20,font:{size:"mobile"===e?12:14},padding:"mobile"===e?15:20,usePointStyle:!0}}}}}applyLegendToChart(e,t,i="desktop",n={}){try{if(!e||!e.options)return this.logger.warn("Grafico non valido per l'applicazione della legenda"),void 0;const r=this.getLegendOptionsForChartType(t,i,n);if(r.plugins?.legend){e.options.plugins=e.options.plugins||{};const n=this._createSafeLegendCopy(e.options.plugins.legend||{});e.options.plugins.legend={...n,...r.plugins.legend},e.update(),this.logger.debug(`Legenda applicata al grafico ${t} per ${i}`)}}catch(r){this.logger.error("Errore nell'applicazione della legenda al grafico:",r);try{this.logger.warn("Applicazione fallback della legenda..."),this._applyFallbackLegend(e,i)}catch(o){this.logger.error("Errore anche nel fallback della legenda:",o)}}}_createSafeLegendCopy(e){try{const t={};for(const[i,n]of Object.entries(e))this._isSafeValue(n)&&(t[i]=n);return t}catch(t){return this.logger.warn("Errore nella creazione della copia sicura, uso oggetto vuoto:",t),{}}}_isSafeValue(e){if(null==e)return!0;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return!0;if(Array.isArray(e))return e.every(e=>this._isSafeValue(e));if("object"==typeof e)try{const t=Object.keys(e);if(t.length>100)return!1;for(const i of t){if("function"==typeof e[i])return!1;if(!this._isSafeValue(e[i]))return!1}return!0}catch(t){return!1}return!1}_applyFallbackLegend(e,t){try{const i=this._getFallbackOptions(t);i.plugins?.legend&&(e.options.plugins=e.options.plugins||{},e.options.plugins.legend=i.plugins.legend,e.update(),this.logger.info("Legenda di fallback applicata con successo"))}catch(i){this.logger.error("Errore nell'applicazione della legenda di fallback:",i)}}};const Ve=new class{constructor(){this.logger=l,this.activeCharts=new Map}createChartConfiguration(e,t,i={},n="desktop",r=null){try{n||(n=je.detectDevice());const o=this._getBaseChartOptions(e,i),a=Ue.getLegendOptionsForChartType(e,n,i.legend||{}),s=this._mergeChartOptions(o,a,i);return r&&(s.chartId=r,s.deviceType=n),this.logger.debug(`Configurazione grafico creata per ${e} su ${n}`,{chartId:r,hasLegend:!!s.plugins?.legend,hasOnClick:!!s.plugins?.legend?.onClick}),{type:e,data:t,options:s,deviceType:n,chartId:r}}catch(o){return this.logger.error("Errore nella creazione della configurazione del grafico:",o),this._getFallbackConfiguration(e,t,n)}}applyPreservedOptions(e,t,i="desktop",n={}){try{if(!e||!e.options)return this.logger.warn("Grafico non valido per l'applicazione delle opzioni preservate"),void 0;if(this._isChartCorrupted(e))return this.logger.warn("Grafico in stato corrotto, applicazione opzioni saltata"),void 0;i||(i=je.detectDevice());try{je.applyToExistingChart(e,i,n),this.logger.debug("Opzioni preservate applicate con successo")}catch(r){this.logger.error("Errore nell'applicazione delle opzioni preservate:",r)}try{Ue.applyLegendToChart(e,t,i,n),this.logger.debug("Opzioni legenda applicate con successo")}catch(o){this.logger.error("Errore nell'applicazione delle opzioni legenda:",o)}this.logger.debug(`Opzioni preservate applicate al grafico ${t} per ${i}`)}catch(a){this.logger.error("Errore generale nell'applicazione delle opzioni preservate:",a);try{this.logger.warn("Tentativo di ripristino del grafico..."),this._restoreChartToSafeState(e)}catch(s){this.logger.error("Errore nel ripristino del grafico:",s)}}}_isChartCorrupted(e){try{if(!e||"object"!=typeof e)return!0;if(!e.options||!e.data||!e.canvas)return!e.ctx||!e.chartArea||"function"!=typeof e.update;const t=Object.keys(e.options);if(t.length>1e3)return!0;for(const i of t)if("function"==typeof e.options[i])return!0;return!1}catch(t){return!0}}_restoreChartToSafeState(e){try{e.options&&e.options.plugins&&(e.options.plugins.legend={display:!0,position:"top"}),"function"==typeof e.update&&(e.update(),this.logger.info("Grafico ripristinato a stato sicuro"))}catch(t){this.logger.error("Errore nel ripristino del grafico:",t)}}registerActiveChart(e,t,i,n="desktop"){try{this.activeCharts.set(e,{chart:t,chartType:i,deviceType:n,createdAt:new Date,lastUpdated:new Date}),this.logger.debug(`Grafico registrato: ${e} (${i} su ${n})`)}catch(r){this.logger.error("Errore nella registrazione del grafico attivo:",r)}}updateRegisteredChart(e,t={}){try{const i=this.activeCharts.get(e);i&&(Object.assign(i,t,{lastUpdated:new Date}),this.logger.debug(`Grafico aggiornato: ${e}`))}catch(i){this.logger.error("Errore nell'aggiornamento del grafico registrato:",i)}}unregisterChart(e){try{this.activeCharts.has(e)&&(this.activeCharts.delete(e),this.logger.debug(`Grafico rimosso dalla registrazione: ${e}`))}catch(t){this.logger.error("Errore nella rimozione del grafico dalla registrazione:",t)}}getActiveChartsInfo(){try{return Array.from(this.activeCharts.entries()).map(([e,t])=>({id:e,chartType:t.chartType,deviceType:t.deviceType,createdAt:t.createdAt,lastUpdated:t.lastUpdated,isActive:!!t.chart&&!t.chart.destroyed}))}catch(e){return this.logger.error("Errore nel recupero delle informazioni sui grafici attivi:",e),[]}}_getBaseChartOptions(e,t={}){const i={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!1},tooltip:{enabled:!0,mode:"index",intersect:!1}}};switch(e){case"pie":case"doughnut":i.plugins.datalabels=!1,"doughnut"===e&&(i.cutout="60%");break;case"bar":i.scales={x:{display:!0},y:{display:!0}};break;case"line":i.scales={x:{display:!0},y:{display:!0}},i.elements={line:{tension:.4}};break;case"radar":i.scales={r:{display:!0}};break;case"polarArea":i.scales={r:{display:!1}}}return i}_mergeChartOptions(...e){return e.reduce((e,t)=>{if(!t)return e;for(const i in t)e[i]=t[i]&&"object"==typeof t[i]&&!Array.isArray(t[i])?this._mergeChartOptions(e[i]||{},t[i]):t[i];return e},{})}_getFallbackConfiguration(e,t,i){return this.logger.warn(`Utilizzo configurazione di fallback per ${e} su ${i}`),{type:e,data:t,options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"mobile"===i?"bottom":"right",align:"mobile"===i?"center":"start",labels:{boxWidth:"mobile"===i?15:20,font:{size:"mobile"===i?12:14},padding:"mobile"===i?15:20,usePointStyle:!0}}}},deviceType:i}}migrateExistingChart(e,t,i="desktop"){try{if(!e||!e.options)return this.logger.warn("Grafico esistente non valido per la migrazione"),null;const n=je.preserveLegendOptions(e.options,i,{}),r=this._mergeChartOptions(e.options,n,{chartType:t,deviceType:i});return this.logger.info(`Grafico migrato con successo: ${t} su ${i}`),{type:t,data:e.data,options:r,deviceType:i,migrated:!0}}catch(n){return this.logger.error("Errore nella migrazione del grafico esistente:",n),null}}validateChartConfiguration(e){try{const t=[],i=[];if(e.type||t.push("Tipo di grafico mancante"),e.data||t.push("Dati del grafico mancanti"),e.options||t.push("Opzioni del grafico mancanti"),e.options?.plugins?.legend){const t=e.options.plugins.legend;t.onClick||i.push("Funzionalità onClick della legenda non configurata"),t.labels?.generateLabels||i.push("Generazione etichette personalizzata non configurata")}else i.push("Configurazione legenda non trovata");if(e.deviceType){["desktop","mobile","tablet"].includes(e.deviceType)||i.push(`Tipo di dispositivo non riconosciuto: ${e.deviceType}`)}const n=0===t.length,r=i.length>0;return this.logger.debug("Validazione configurazione grafico completata",{isValid:n,errors:t.length,warnings:i.length}),{isValid:n,hasWarnings:r,errors:t,warnings:i}}catch(t){return this.logger.error("Errore nella validazione della configurazione:",t),{isValid:!1,hasWarnings:!1,errors:["Errore durante la validazione"],warnings:[]}}}};const Be=new class{constructor(){this.logger=l,this.migratedCharts=new Map,this.migrationStatus={started:!1,completed:!1,totalCharts:0,migratedCharts:0,failedCharts:0,errors:[]}}async startMigration(e={}){try{this.logger.info("🚀 Avvio migrazione al nuovo sistema di grafici"),this.migrationStatus.started=!0,this.migrationStatus.startedAt=new Date;const t=this._findExistingCharts();if(0===t.length)return this.logger.info("✅ Nessun grafico esistente trovato da migrare"),this.migrationStatus.completed=!0,this.migrationStatus.completedAt=new Date,this.migrationStatus;this.migrationStatus.totalCharts=t.length,this.logger.info(`📊 Trovati ${t.length} grafici da migrare`);for(const i of t)await this._migrateSingleChart(i,e);return this.migrationStatus.completed=!0,this.migrationStatus.completedAt=new Date,this.migrationStatus.duration=this.migrationStatus.completedAt-this.migrationStatus.startedAt,this.logger.info("🎉 Migrazione completata con successo!",{total:this.migrationStatus.totalCharts,migrated:this.migrationStatus.migratedCharts,failed:this.migrationStatus.failedCharts,duration:`${this.migrationStatus.duration}ms`}),this.migrationStatus}catch(t){throw this.logger.error("❌ Errore durante la migrazione:",t),this.migrationStatus.errors.push({type:"migration_error",message:t.message,timestamp:new Date}),t}}_findExistingCharts(){try{const e=[];return document.querySelectorAll("canvas").forEach((t,i)=>{try{if(window.Chart&&"function"==typeof window.Chart.getChart){const n=window.Chart.getChart(t);n&&e.push({canvas:t,chart:n,index:i,id:t.id||`chart-${i}`,type:this._detectChartType(n),hasLegend:!!n.options?.plugins?.legend,hasOnClick:!!n.options?.plugins?.legend?.onClick})}}catch(n){this.logger.warn(`Impossibile analizzare canvas ${i}:`,n)}}),e}catch(e){return this.logger.error("Errore nella ricerca dei grafici esistenti:",e),[]}}async _migrateSingleChart(e,t={}){try{const{canvas:i,chart:n,id:r,type:o}=e;if(i.hasAttribute("data-migrated-chart"))return this.logger.debug(`⏭️ Grafico ${r} già migrato, skip`),void 0;if(!this._isChartReadyForMigration(n))return this.logger.debug(`⏳ Grafico ${r} non ancora pronto per la migrazione, skip`),void 0;this.logger.info(`🔄 Migrazione grafico ${r} (${o})`);const a=je.detectDevice(),s=`migrated-${r}-${o}-${Date.now()}`,c=Ve.migrateExistingChart(n,o,a);c?(Ve.registerActiveChart(s,n,o,a),this.migratedCharts.set(s,{originalId:r,canvas:i,chart:n,chartType:o,deviceType:a,migratedConfig:c,migratedAt:new Date,originalConfig:{hasLegend:e.hasLegend,hasOnClick:e.hasOnClick}}),i.setAttribute("data-migrated-chart",s),i.setAttribute("data-chart-type",o),i.setAttribute("data-device-type",a),i.setAttribute("data-migration-date",(new Date).toISOString()),Ve.applyPreservedOptions(n,o,a,t.chartOptions||{}),this.migrationStatus.migratedCharts++,this.logger.info(`✅ Grafico ${r} migrato con successo`,{newId:s,type:o,device:a,hasLegend:!!c.plugins?.legend,hasOnClick:!!c.plugins?.legend?.onClick})):(this.migrationStatus.failedCharts++,this.logger.warn(`⚠️ Fallita migrazione grafico ${r}`))}catch(i){this.migrationStatus.failedCharts++,this.migrationStatus.errors.push({type:"chart_migration_error",chartId:e.id,message:i.message,timestamp:new Date}),this.logger.error(`❌ Errore nella migrazione del grafico ${e.id}:`,i)}}_isChartReadyForMigration(e){try{if(!e||"object"!=typeof e)return!1;if(!e.options||!e.data||!e.canvas)return e.ctx&&e.chartArea&&"function"==typeof e.update,!1;const t=Object.keys(e.options);if(t.length>1e3)return!1;for(const i of t)if("function"==typeof e.options[i])return!1;return!0}catch(t){return!1}}_detectChartType(e){try{return e.config&&e.config.type?e.config.type:e.options&&e.options.type?e.options.type:this._inferChartTypeFromData(e.data)}catch(t){return this.logger.warn("Errore nel rilevamento del tipo di grafico:",t),"bar"}}_inferChartTypeFromData(e){try{if(!e||!e.datasets)return"bar";const t=e.datasets[0];return t.percentages||t.data&&t.data.length===e.labels?.length?"pie":t.borderColor?"line":"bar"}catch(t){return this.logger.warn("Errore nell'inferenza del tipo di grafico:",t),"bar"}}getMigrationStatus(){return{...this.migrationStatus}}getMigratedChartsInfo(){try{return Array.from(this.migratedCharts.entries()).map(([e,t])=>({id:e,originalId:t.originalId,chartType:t.chartType,deviceType:t.deviceType,migratedAt:t.migratedAt,originalConfig:t.originalConfig,hasLegend:!!t.chart.options?.plugins?.legend,hasOnClick:!!t.chart.options?.plugins?.legend?.onClick}))}catch(e){return this.logger.error("Errore nel recupero delle informazioni sui grafici migrati:",e),[]}}verifyMigration(){try{const e={total:this.migratedCharts.size,verified:0,issues:[],timestamp:new Date};return this.migratedCharts.forEach((t,i)=>{try{const n=t.chart;if(!n||n.destroyed)return e.issues.push({chartId:i,issue:"chart_destroyed",message:"Grafico distrutto o non valido"}),void 0;if(!n.options?.plugins?.legend)return e.issues.push({chartId:i,issue:"missing_legend",message:"Configurazione legenda mancante"}),void 0;if(!n.options.plugins.legend.onClick)return e.issues.push({chartId:i,issue:"missing_onclick",message:"Funzionalità onClick mancante"}),void 0;e.verified++}catch(n){e.issues.push({chartId:i,issue:"verification_error",message:n.message})}}),this.logger.info("Verifica migrazione completata",e),e}catch(e){return this.logger.error("Errore durante la verifica della migrazione:",e),{error:e.message}}}rollbackChart(e){try{const t=this.migratedCharts.get(e);if(!t)return this.logger.warn(`Grafico migrato ${e} non trovato per il rollback`),!1;const{canvas:i,originalId:n}=t;return i.removeAttribute("data-migrated-chart"),i.removeAttribute("data-chart-type"),i.removeAttribute("data-device-type"),i.removeAttribute("data-migration-date"),Ve.unregisterChart(e),this.migratedCharts.delete(e),this.logger.info(`Rollback completato per il grafico ${n}`,{chartId:e,originalId:n}),!0}catch(t){return this.logger.error(`Errore durante il rollback del grafico ${e}:`,t),!1}}cleanup(){try{const e=Array.from(this.migratedCharts.keys());e.forEach(e=>{this.rollbackChart(e)}),this.logger.info("Pulizia migrazioni completata",{removedCharts:e.length})}catch(e){this.logger.error("Errore durante la pulizia delle migrazioni:",e)}}},He={enabled:!0,waitForDOM:!0,waitForChartJS:!0,chartJSTimeout:15e3,chartOptions:{preserveExisting:!0,enableResponsive:!0,enhanceInteractions:!0},verbose:!0};const Ge=new class{constructor(e={}){this.config={...He,...e},this.logger=l,this.initialized=!1,this.migrationStarted=!1}async initialize(){try{if(this.initialized)return this.logger.warn("Migrazione automatica già inizializzata"),void 0;this.logger.info("🚀 Inizializzazione migrazione automatica"),this.config.waitForDOM&&await this._waitForDOM(),this.config.waitForChartJS&&await this._waitForChartJS(),this._setupEventListeners(),await this._startAutoMigration(),this.initialized=!0,this.logger.info("✅ Migrazione automatica inizializzata con successo")}catch(e){throw this.logger.error("❌ Errore durante l'inizializzazione della migrazione automatica:",e),e}}_waitForDOM(){return new Promise(e=>{"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()})}async _waitForChartJS(){return new Promise(async(e,i)=>{try{if(window.Chart&&"function"==typeof window.Chart.getChart)return this.logger.info("✅ Chart.js rilevato globalmente"),e(),void 0;try{const n=await t(()=>import("./chartjsService-BqG25P3j.js").then(e=>e.e),[]);if(n&&n.chartLoader&&"function"==typeof n.chartLoader.isLoaded){const t=n.chartLoader;if(t.isLoaded())return this.logger.info("✅ Chart.js rilevato tramite chartjsService"),e(),void 0;this.logger.info("⏳ Chart.js non ancora caricato tramite chartjsService, attendo...");const r=this.config.chartJSTimeout,o=100;let a=0;const s=()=>{try{if(t&&t.isLoaded&&t.isLoaded())return this.logger.info("✅ Chart.js caricato tramite chartjsService"),e(),void 0;if(a+=o,a>=r)return this.logger.warn("Timeout nell'attesa di Chart.js tramite chartjsService, uso fallback globale"),this._startGlobalChartJSCheck(e,i),void 0;setTimeout(s,o)}catch(n){this.logger.warn("Errore nel controllo chartjsService, uso fallback globale:",n),this._startGlobalChartJSCheck(e,i)}};s()}else this.logger.warn("chartjsService importato ma chartLoader non valido, uso fallback globale"),this._startGlobalChartJSCheck(e,i)}catch(n){this.logger.warn("Impossibile importare chartjsService, uso fallback globale:",n),this._startGlobalChartJSCheck(e,i)}}catch(r){i(new Error(`Errore nell'attesa di Chart.js: ${r.message}`))}})}_startGlobalChartJSCheck(e,t){try{this.logger.info("🔄 Avvio controllo globale di Chart.js come fallback...");const i=this.config.chartJSTimeout,n=100;let r=0;const o=()=>{try{if(window.Chart&&"function"==typeof window.Chart.getChart)return this.logger.info("✅ Chart.js rilevato globalmente dopo attesa"),e(),void 0;if(r+=n,r>=i)return t(new Error("Timeout nell'attesa di Chart.js (fallback globale)")),void 0;setTimeout(o,n)}catch(a){this.logger.error("Errore nel controllo globale di Chart.js:",a),t(new Error(`Errore nel controllo globale: ${a.message}`))}};o()}catch(i){this.logger.error("Errore nell'avvio del controllo globale:",i),t(new Error(`Errore nell'avvio controllo globale: ${i.message}`))}}_setupEventListeners(){try{window.addEventListener("load",()=>{this._startAutoMigration()}),this._setupMutationObserver(),window.addEventListener("resize",this._debounce(()=>{this._handleResize()},250)),this.logger.info("📡 Event listener configurati per la migrazione automatica")}catch(e){this.logger.error("Errore nella configurazione degli event listener:",e)}}_setupMutationObserver(){try{if("undefined"!=typeof MutationObserver){new MutationObserver(e=>{e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){"CANVAS"===e.tagName&&this._handleNewCanvas(e);const t=e.querySelectorAll&&e.querySelectorAll("canvas");t&&t.forEach(e=>this._handleNewCanvas(e))}})})}).observe(document.body,{childList:!0,subtree:!0}),this.logger.info("👁️ MutationObserver configurato per nuovi canvas")}}catch(e){this.logger.warn("MutationObserver non disponibile:",e)}}_handleNewCanvas(e){try{if(e.hasAttribute("data-migration-processed"))return;e.setAttribute("data-migration-processed","true"),setTimeout(()=>{try{if(window.Chart&&"function"==typeof window.Chart.getChart){const t=window.Chart.getChart(e);t&&this._isChartReadyForMigration(t)?(this.logger.info("🎨 Nuovo canvas rilevato, avvio migrazione..."),this._migrateSingleChart(e,t)):t&&(this.logger.debug("⏳ Grafico non ancora pronto, riprovo più tardi..."),setTimeout(()=>this._handleNewCanvas(e),500))}}catch(t){this.logger.warn("Errore nella gestione del nuovo canvas:",t)}},200)}catch(t){this.logger.error("Errore nella gestione del nuovo canvas:",t)}}_handleResize(){try{const e=this._detectDeviceType();this._updateDeviceTypeForMigratedCharts(e)}catch(e){this.logger.warn("Errore nella gestione del ridimensionamento:",e)}}_isChartReadyForMigration(e){try{if(!e||"object"!=typeof e)return!1;if(!e.options||!e.data||!e.canvas)return e.ctx&&e.chartArea&&"function"==typeof e.update,!1;const t=Object.keys(e.options);if(t.length>1e3)return!1;for(const i of t)if("function"==typeof e.options[i])return!1;return!0}catch(t){return!1}}_detectDeviceType(){try{const e=window.innerWidth;return e<768?"mobile":e<1024?"tablet":"desktop"}catch(e){return"desktop"}}_updateDeviceTypeForMigratedCharts(e){try{Be.getMigratedChartsInfo().forEach(t=>{t.deviceType!==e&&(this.logger.info(`🔄 Aggiornamento tipo dispositivo per ${t.id}: ${t.deviceType} → ${e}`),Be.updateChartDeviceType(t.id,e))})}catch(t){this.logger.warn("Errore nell'aggiornamento del tipo dispositivo:",t)}}async _startAutoMigration(){try{if(this.migrationStarted)return this.logger.info("🔄 Migrazione automatica già in corso"),void 0;this.migrationStarted=!0,this.logger.info("🚀 Avvio migrazione automatica dei grafici esistenti");const e=await Be.startMigration(this.config.chartOptions);this.logger.info("✅ Migrazione automatica completata",{total:e.totalCharts,migrated:e.migratedCharts,failed:e.failedCharts,duration:e.duration});const t=Be.verifyMigration();return this.logger.info("🔍 Verifica migrazione completata",t),e}catch(e){throw this.logger.error("❌ Errore durante la migrazione automatica:",e),e}finally{this.migrationStarted=!1}}_migrateSingleChart(e,t){try{const i={canvas:e,chart:t,index:0,id:e.id||`auto-chart-${Date.now()}`,type:this._detectChartType(t),hasLegend:!!t.options?.plugins?.legend,hasOnClick:!!t.options?.plugins?.legend?.onClick};Be._migrateSingleChart(i,this.config.chartOptions)}catch(i){this.logger.error("Errore nella migrazione del singolo grafico:",i)}}_detectChartType(e){try{return e.config&&e.config.type?e.config.type:e.options&&e.options.type?e.options.type:"bar"}catch(t){return"bar"}}_debounce(e,t){let i;return function(...n){clearTimeout(i),i=setTimeout(()=>{clearTimeout(i),e(...n)},t)}}getStatus(){return{initialized:this.initialized,migrationStarted:this.migrationStarted,config:this.config,migrationStatus:Be.getMigrationStatus()}}disable(){this.config.enabled=!1,this.logger.info("⏸️ Migrazione automatica disabilitata")}enable(){this.config.enabled=!0,this.logger.info("▶️ Migrazione automatica riabilitata")}cleanup(){try{Be.cleanup(),this.initialized=!1,this.migrationStarted=!1,this.logger.info("🧹 Pulizia migrazione automatica completata")}catch(e){this.logger.error("Errore durante la pulizia:",e)}}},We={enabled:!0,waitForDOM:!0,waitForChartJS:!0,chartJSTimeout:15e3,chartOptions:{preserveExisting:!0,enableResponsive:!0,enhanceInteractions:!0},verbose:!0};async function qe(){try{l.info("🚀 Inizializzazione automatica del sistema di migrazione grafici"),await Ge.initialize(We),l.info("✅ Sistema di migrazione automatica inizializzato con successo");const e=Ge.getStatus();l.info("📊 Stato migrazione automatica:",e)}catch(e){if(l.error("❌ Errore durante l'inizializzazione automatica:",e),e.message.includes("Chart.js")||e.message.includes("Timeout")){l.info("⏳ Chart.js non ancora disponibile, riprovo con retry intelligente...");let e=0;const t=3,i=3e3,n=async()=>{try{e++;const n=i*Math.pow(2,e-1);l.info(`🔄 Tentativo di reinizializzazione ${e}/${t} (delay: ${n}ms)...`),await new Promise(e=>setTimeout(e,n)),await Ge.initialize(We),l.info("✅ Reinizializzazione riuscita")}catch(r){e<t?(l.warn(`⚠️ Tentativo ${e} fallito, riprovo...`),n()):(l.error("❌ Tutti i tentativi di reinizializzazione falliti:",r),l.info("💡 Il sistema continuerà a funzionare normalmente, ma la migrazione dei grafici potrebbe non essere attiva"))}};n()}else l.info("🔄 Tentativo di reinizializzazione per errore generico..."),setTimeout(async()=>{try{await Ge.initialize(We),l.info("✅ Reinizializzazione riuscita")}catch(e){l.error("❌ Reinizializzazione fallita:",e)}},2e3)}}"undefined"!=typeof window?"loading"===document.readyState?document.addEventListener("DOMContentLoaded",qe):qe():l.info("🖥️ Ambiente Node.js rilevato, migrazione automatica non disponibile");const Je=new class{constructor(){this.errorPatterns=["message channel closed before a response was received","A listener indicated an asynchronous response by returning true, but the message channel closed before a response was received","Extension context invalidated","Could not establish connection","The message port closed before a response was received","Receiving end does not exist","chrome-extension://","moz-extension://","safari-extension://","edge-extension://"],this.suppressedErrors=new Set,this.errorCount=0,this.maxErrorsToLog=5,this.init()}init(){window.addEventListener("error",this.handleError.bind(this)),window.addEventListener("unhandledrejection",this.handleRejection.bind(this)),this.interceptExtensionListeners()}isExtensionError(e,t=""){if(!e)return!1;const i=e.toString().toLowerCase(),n=t.toString().toLowerCase();return this.errorPatterns.some(e=>i.includes(e.toLowerCase())||n.includes(e.toLowerCase()))}handleError(e){const{message:t,filename:i}=e;return!this.isExtensionError(t,i)||(this.suppressExtensionError(e,"JavaScript Error"),void 0)}handleRejection(e){const t=e.reason;let i="";return t instanceof Error?i=t.message:"string"==typeof t?i=t:t&&t.toString&&(i=t.toString()),!this.isExtensionError(i)||(this.suppressExtensionError(e,"Promise Rejection"),void 0)}suppressExtensionError(e,t){e.preventDefault(),e.stopPropagation();const i=`${t}:${e.message||e.reason}`;return!this.suppressedErrors.has(i)&&this.errorCount<this.maxErrorsToLog&&(console.warn("[ExtensionErrorHandler] Errore di estensione soppresso:",t,{message:e.message||e.reason,filename:e.filename,type:t}),this.suppressedErrors.add(i),this.errorCount++),!1}interceptExtensionListeners(){"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onMessage&&this.wrapChromeListeners(),"undefined"!=typeof browser&&browser.runtime&&browser.runtime.onMessage&&this.wrapFirefoxListeners(),this.wrapPostMessage()}wrapChromeListeners(){const e=chrome.runtime.onMessage.addListener;chrome.runtime.onMessage.addListener=function(t){return e.call(this,function(e,i,n){try{const r=t(e,i,n);if(!0===r){const e=setTimeout(()=>{try{n({_extensionErrorHandlerResponse:!0})}catch(e){}},100),t=n;n=function(...i){clearTimeout(e);try{return t(...i)}catch(n){}}}return r}catch(r){return console.warn("[ExtensionErrorHandler] Errore nel message listener:",r),!1}})}}wrapFirefoxListeners(){const e=browser.runtime.onMessage.addListener;browser.runtime.onMessage.addListener=function(t){return e.call(this,function(e,i,n){try{return t(e,i,n)}catch(r){return console.warn("[ExtensionErrorHandler] Errore nel message listener Firefox:",r),Promise.resolve()}})}}wrapPostMessage(){const e=window.postMessage;window.postMessage=function(t,i,n){try{return e.call(this,t,i,n)}catch(r){if(this.isExtensionError(r.message))return console.warn("[ExtensionErrorHandler] Errore postMessage di estensione soppresso:",r),void 0;throw r}}.bind(this)}getStats(){return{suppressedErrorTypes:this.suppressedErrors.size,totalErrorCount:this.errorCount,maxErrorsToLog:this.maxErrorsToLog}}resetStats(){this.suppressedErrors.clear(),this.errorCount=0}};"undefined"!=typeof window&&(window.extensionErrorHandler=Je),"undefined"!=typeof window&&(window.bootstrap={Modal:r,Collapse:n,Dropdown:i});const Ye=new class{getDefaultAnimationSetting(){try{return"undefined"==typeof window||!window.matchMedia||!window.matchMedia("(prefers-reduced-motion: reduce)").matches}catch(e){return!0}}constructor(){this.state={currentView:"home",previousView:null,editPazienteId:null,selectedPazienteId:null,listFilters:{reparto:"",diagnosi:"",stato:"",infetto:"",search:"",page:0,sortColumn:"data_ricovero",sortDirection:"desc"},eventiCliniciFilters:{paziente_search:"",tipo_evento:"",data_da:"",data_a:"",reparto:"",agente_patogeno:"",tipo_intervento:"",sortColumn:"data_evento",sortDirection:"desc"},formData:{},isLoading:!1,loadingMessage:"",errors:[],notifications:[],notificationSettings:{maxVisible:5,defaultDuration:5e3,position:"top-right",enableSounds:!1,enableAnimations:this.getDefaultAnimationSetting(),autoCleanupInterval:3e5,maxStoredNotifications:50,persistentTypes:["error"],soundVolume:.5,customDurations:{success:4e3,info:5e3,warning:6e3,error:0}},user:null,isAuthenticated:!1},this.subscribers=new Map,this.persistentKeys=["listFilters","editPazienteId","formData","eventiCliniciFilters","notificationSettings"],this.cleanupTimer=null,this.loadPersistedState(),this.startAutoCleanup()}loadPersistedState(){try{this.persistentKeys.forEach(e=>{const t=localStorage.getItem(`app_state_${e}`);t&&(this.state[e]=JSON.parse(t))});const e=this.state.notificationSettings||{};Array.isArray(e.persistentTypes)?e.persistentTypes.includes("error")||e.persistentTypes.unshift("error"):e.persistentTypes=["error"],e.customDurations=e.customDurations||{},(void 0===e.customDurations.error||e.customDurations.error>0)&&(e.customDurations.error=0),this.state.notificationSettings=e}catch(e){l.warn("Errore durante il caricamento dello stato persistente:",e)}}persistState(){try{this.persistentKeys.forEach(e=>{null!=this.state[e]&&localStorage.setItem(`app_state_${e}`,JSON.stringify(this.state[e]))})}catch(e){l.warn("Errore durante il salvataggio dello stato persistente:",e)}}getState(e){return e?this.state[e]:{...this.state}}setState(e,t){const i="string"==typeof e?{[e]:t}:e,n={...this.state};void 0===i.notifications||Array.isArray(i.notifications)||(console.warn("⚠️ StateService: notifications must be an array, got:",typeof i.notifications),i.notifications=[]),Object.assign(this.state,i);const r=Object.keys(i);r.some(e=>this.persistentKeys.includes(e))&&this.persistState(),this.notifySubscribers(r,n)}subscribe(e,t){const i=Array.isArray(e)?e:[e],n=Symbol("subscriber");return this.subscribers.set(n,{keys:i,callback:t}),()=>{this.subscribers.delete(n)}}notifySubscribers(e,t){this.subscribers.forEach(({keys:i,callback:n},r)=>{if(i.some(t=>e.includes(t)))try{const o=n(this.state,t,e);o&&"function"==typeof o.then&&o.catch(o=>{console.error(`Errore async in subscriber callback [${n.name||"(anonymous)"}] (subscriberId: ${String(r)}):`,o,"\nchangedKeys:",e,"\nsubscriber keys:",i,"\ncurrent state:",this.state,"\nold state:",t,"\ncallback:",n.toString())})}catch(o){console.error(`Errore in subscriber callback [${n.name||"(anonymous)"}] (subscriberId: ${String(r)}):`,o,"\nchangedKeys:",e,"\nsubscriber keys:",i,"\ncurrent state:",this.state,"\nold state:",t,"\ncallback:",n.toString())}})}clearState(e=["user","isAuthenticated"]){this.stopAutoCleanup();const t={};e.forEach(e=>{void 0!==this.state[e]&&(t[e]=this.state[e])});const i={currentView:"home",previousView:null,editPazienteId:null,selectedPazienteId:null,listFilters:{reparto:"",diagnosi:"",stato:"",infetto:"",search:"",page:0,sortColumn:"data_ricovero",sortDirection:"desc"},eventiCliniciFilters:{paziente_search:"",tipo_evento:"",data_da:"",data_a:"",reparto:"",agente_patogeno:"",tipo_intervento:"",sortColumn:"data_evento",sortDirection:"desc"},formData:{},isLoading:!1,loadingMessage:"",errors:[],notifications:[],notificationSettings:{maxVisible:5,defaultDuration:5e3,position:"top-right",enableSounds:!1,enableAnimations:this.getDefaultAnimationSetting(),autoCleanupInterval:3e5,maxStoredNotifications:50,persistentTypes:["error"],soundVolume:.5,customDurations:{success:4e3,info:5e3,warning:6e3,error:0}},user:null,isAuthenticated:!1};this.state={...i,...t},this.persistentKeys.forEach(t=>{e.includes(t)||localStorage.removeItem(`app_state_${t}`)}),e.includes("notificationSettings")&&this.startAutoCleanup()}setEditPatient(e){this.setState("editPazienteId",e)}getEditPatientId(){return this.getState("editPazienteId")}clearEditPatient(){this.setState("editPazienteId",null)}updateFilters(e){this.setState("listFilters",{...this.getState("listFilters"),...e})}getFilters(){return this.getState("listFilters")}resetFilters(){this.setState("listFilters",{reparto:"",diagnosi:"",stato:"",infetto:"",search:"",page:0,sortColumn:"data_ricovero",sortDirection:"desc"})}setFormData(e){this.setState("formData",e)}getFormData(){return this.getState("formData")}clearFormData(){this.setState("formData",{})}setLoading(e,t=""){this.setState({isLoading:e,loadingMessage:t})}addNotification(e,t,i={}){"number"==typeof i&&(i={duration:i});const n=this.normalizeNotificationType(e),r={maxVisible:5,defaultDuration:5e3,position:"top-right",enableSounds:!1,enableAnimations:!0,autoCleanupInterval:3e5,maxStoredNotifications:50,persistentTypes:["error"],soundVolume:.5,customDurations:{success:4e3,info:5e3,warning:6e3,error:0},...this.getState("notificationSettings")},o=r.customDurations&&void 0!==r.customDurations[n]?r.customDurations[n]:r.defaultDuration,a={id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:n,message:t,timestamp:new Date,isVisible:!0,isRemoving:!1,options:{duration:o,persistent:r.persistentTypes.includes(n),closable:!0,position:r.position,priority:0,...i}};a.options.persistent&&(a.options.duration=0);const s=this.getState("notifications");l.debug(`[StateService] Current notifications before adding: ${s.length}`,s);let c=[...s,a];if(c.length>r.maxStoredNotifications){l.warn(`[StateService] Max stored notifications (${r.maxStoredNotifications}) exceeded. Trimming old notifications.`);const e=c.sort((e,t)=>new Date(e.timestamp)-new Date(t.timestamp)).slice(0,c.length-r.maxStoredNotifications);c=c.filter(t=>!e.includes(t)||t.options.persistent&&"error"===t.type),l.debug(`[StateService] Notifications after trimming: ${c.length}`,c)}return this.setState("notifications",c),l.debug(`[StateService] Notification added. New notifications array length: ${this.getState("notifications").length}`,this.getState("notifications")),a.id}normalizeNotificationType(e){const t=String(e||"").toLowerCase().trim();return t?["error","errore","err","danger","fatal"].includes(t)?"error":["success","ok","successo"].includes(t)?"success":["warning","warn","avviso","alert"].includes(t)?"warning":(["info","informazione","notice"].includes(t),"info"):"info"}removeNotification(e){const t=this.getState("notifications");l.debug("[StateService] Notifiche prima della rimozione:",t);const i=t.filter(t=>t.id!==e);this.setState("notifications",i);const n=this.getState("notifications");l.debug("[StateService] Notifiche dopo la rimozione:",n)}updateNotificationSettings(e){const t={...this.getState("notificationSettings"),...e};this.setState("notificationSettings",t),void 0!==e.autoCleanupInterval&&this.startAutoCleanup()}getNotificationSettings(){return this.getState("notificationSettings")}clearAllNotifications(){this.setState("notifications",[])}clearNotificationsByType(e){const t=this.getState("notifications").filter(t=>t.type!==e);this.setState("notifications",t)}clearOldNotifications(e=3e5){const t=new Date,i=this.getState("notifications"),n=i.filter(i=>{const n=t-new Date(i.timestamp);return!(!i.options.persistent||"error"!==i.type)||n<e});return this.setState("notifications",n),i.length-n.length}markNotificationRemoving(e){const t=this.getState("notifications").map(t=>t.id===e?{...t,isRemoving:!0}:t);this.setState("notifications",t)}getNotificationsByType(e){return this.getState("notifications").filter(t=>t.type===e)}getVisibleNotifications(){return this.getState("notifications").filter(e=>e.isVisible&&!e.isRemoving)}countNotificationsByType(e){return this.getNotificationsByType(e).length}hasErrorNotifications(){return this.countNotificationsByType("error")>0}startAutoCleanup(){this.cleanupTimer&&clearInterval(this.cleanupTimer);const e=this.getState("notificationSettings");this.cleanupTimer=setInterval(()=>{const t=this.clearOldNotifications(e.autoCleanupInterval);t>0&&l.debug(`Cleanup automatico: rimosse ${t} notifiche vecchie`)},e.autoCleanupInterval)}stopAutoCleanup(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null)}getNotificationStats(){const e=this.getState("notifications");return{total:e.length,visible:e.filter(e=>e.isVisible&&!e.isRemoving).length,byType:{success:e.filter(e=>"success"===e.type).length,error:e.filter(e=>"error"===e.type).length,warning:e.filter(e=>"warning"===e.type).length,info:e.filter(e=>"info"===e.type).length},persistent:e.filter(e=>e.options.persistent).length,oldest:e.length>0?Math.min(...e.map(e=>new Date(e.timestamp).getTime())):null,newest:e.length>0?Math.max(...e.map(e=>new Date(e.timestamp).getTime())):null}}exportNotificationSettings(){return{settings:this.getState("notificationSettings"),timestamp:(new Date).toISOString(),version:"1.0"}}importNotificationSettings(e){try{return!("1.0"!==e.version||!e.settings)&&(this.updateNotificationSettings(e.settings),!0)}catch(t){return l.error("Errore durante importazione impostazioni notifiche:",t),!1}}setCurrentView(e,t=null){this.setState({currentView:e,previousView:t||this.getState("currentView")})}getCurrentView(){return this.getState("currentView")}setUser(e){this.setState({user:e,isAuthenticated:!!e})}getUser(){return this.getState("user")}isAuthenticated(){return this.getState("isAuthenticated")}updateEventiCliniciFilters(e){this.setState("eventiCliniciFilters",{...this.getState("eventiCliniciFilters"),...e})}getEventiCliniciFilters(){return this.getState("eventiCliniciFilters")}resetEventiCliniciFilters(){this.setState("eventiCliniciFilters",{paziente_search:"",tipo_evento:"",data_da:"",data_a:"",reparto:"",agente_patogeno:"",tipo_intervento:"",sortColumn:"data_evento",sortDirection:"desc"})}destroy(){this.stopAutoCleanup(),this.subscribers.clear(),this.persistentKeys.forEach(e=>{localStorage.removeItem(`app_state_${e}`)})}},Xe=Object.freeze(Object.defineProperty({__proto__:null,stateService:Ye},Symbol.toStringTag,{value:"Module"}));function Ke(e,t){const i=document.getElementById("notification-announcer");i&&(i.textContent=`${e}: ${t}`)}function Qe(e,t,{removeNotification:i}){const n=e.querySelector(".notification__close");n&&n.addEventListener("click",e=>{e.stopPropagation(),i(t.id)}),e.addEventListener("keydown",e=>{"Escape"===e.key&&(e.preventDefault(),i(t.id))})}function Ze(e,t,{pauseAutoCloseTimer:i}){let n=0;e.addEventListener("touchstart",()=>{n=Date.now()}),e.addEventListener("touchend",()=>{Date.now()-n>500&&i?.(t.id)})}class et{static DEBUG=!1;static notificationQueue=[];static isDOMReady=!1;static domReadyCallbacks=[];static animationSupport=null;static reducedMotionPreference=null;static errorCounts={render:0,animation:0,dom:0,service:0,total:0};static init(){this.checkDOMReady(),this.checkAnimationSupport(),this.checkReducedMotionPreference(),this.setupErrorRecovery()}static handleRenderError(e,t,i=null){this.errorCounts.render++,this.errorCounts.total++,console.error("❌ Notification render error:",e,t),"undefined"!=typeof window&&window.appLogger&&window.appLogger.error("Notification render failed",{error:e.message,notificationId:t?.id,notificationType:t?.type,stack:e.stack});try{return i&&"function"==typeof i?i(t):this.createSimpleFallback(t)}catch(n){return console.error("❌ Fallback renderer also failed:",n),this.showConsoleFallback(t),null}}static handleAnimationError(e,t,i="unknown"){if(this.errorCounts.animation++,this.errorCounts.total++,t)try{t.style.animation="none",t.style.transition="none","entrance"===i?(t.style.opacity="1",t.style.transform="translateX(0)",t.classList.add("notification--visible"),t.classList.remove("notification--entering")):"exit"===i&&(t.style.opacity="0",t.classList.add("notification--hidden"),t.classList.remove("notification--exiting"))}catch(n){console.error("❌ Animation fallback failed:",n)}}static handleServiceError(e,t,i=null){this.errorCounts.service++,this.errorCounts.total++,this.errorCounts.service%10==1&&console.error(`❌ NotificationService error in ${t} (${this.errorCounts.service} total):`,e),"undefined"!=typeof window&&window.appLogger&&window.appLogger.error(`NotificationService ${t} failed`,{error:e.message,operation:t,data:i,stack:e.stack});try{switch(t){case"show":this.recoverFromShowError(i);break;case"remove":this.recoverFromRemoveError(i);break;case"clear":this.recoverFromClearError();break;case"init":this.recoverFromInitError()}}catch(n){console.error("❌ Error recovery failed:",n)}}static handleDOMError(e,t,i=null){return this.errorCounts.dom++,this.errorCounts.total++,console.error(`❌ DOM error in ${t}:`,e),!(!this.isDOMReady&&"render"===t)||(console.log("📋 DOM not ready, queueing notification"),!1)}static queueNotification(e,t){if(this.isDOMReady)try{return e(t)}catch(i){return this.handleRenderError(i,t)}return this.notificationQueue.push({renderFunction:e,notification:t,timestamp:Date.now()}),null}static processNotificationQueue(){if(!this.isDOMReady||0===this.notificationQueue.length)return;console.log(`🚀 Processing ${this.notificationQueue.length} queued notifications`);const e=[...this.notificationQueue];this.notificationQueue=[],e.forEach(({renderFunction:e,notification:t,timestamp:i})=>{try{if(Date.now()-i>3e4)return console.warn("⚠️ Skipping old queued notification:",t?.id),void 0;e(t)}catch(n){this.handleRenderError(n,t)}})}static createSimpleFallback(e){const t=document.createElement("div");t.className=`notification notification--${e.type} notification--fallback`,t.setAttribute("data-id",e.id),t.setAttribute("role","error"===e.type?"alert":"status"),t.setAttribute("aria-live","error"===e.type?"assertive":"polite"),t.style.cssText="\n            position: relative;\n            padding: 12px 16px;\n            margin: 8px 0;\n            border-radius: 4px;\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            font-size: 14px;\n            line-height: 1.4;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n            max-width: 400px;\n            word-wrap: break-word;\n        ";const i={success:{bg:"#d4edda",text:"#155724",border:"#c3e6cb"},error:{bg:"#f8d7da",text:"#721c24",border:"#f5c6cb"},warning:{bg:"#fff3cd",text:"#856404",border:"#ffeaa7"},info:{bg:"#d1ecf1",text:"#0c5460",border:"#bee5eb"}},n=i[e.type]||i.info;t.style.backgroundColor=n.bg,t.style.color=n.text,t.style.border=`1px solid ${n.border}`;const r=document.createElement("div");r.style.cssText="display: flex; align-items: flex-start; gap: 8px;";const o=document.createElement("span");o.style.cssText="flex-shrink: 0; font-weight: bold; font-size: 16px;";const a={success:"✓",error:"✕",warning:"⚠",info:"ℹ"};o.textContent=a[e.type]||a.info;const s=document.createElement("div");if(s.style.cssText="flex: 1; min-width: 0;",e.title){const t=document.createElement("div");t.style.cssText="font-weight: bold; margin-bottom: 4px;",t.textContent=e.title,s.appendChild(t)}const c=document.createElement("div");c.textContent=e.message||`Notifica ${e.type||"info"} - Messaggio non disponibile`,s.appendChild(c);const l=document.createElement("button");return l.style.cssText=`\n            background: none;\n            border: none;\n            font-size: 18px;\n            cursor: pointer;\n            padding: 0;\n            margin-left: 8px;\n            color: ${n.text};\n            opacity: 0.7;\n            flex-shrink: 0;\n        `,l.textContent="×",l.setAttribute("aria-label","Chiudi notifica"),l.onclick=()=>{t.remove();try{window.stateService&&"function"==typeof window.stateService.removeNotification&&window.stateService.removeNotification(e.id)}catch(i){console.debug("Could not remove from state:",i)}},r.appendChild(o),r.appendChild(s),r.appendChild(l),t.appendChild(r),t}static showConsoleFallback(e){const t={success:"✅",error:"❌",warning:"⚠️",info:"ℹ️"},i=`${t[e.type]||t.info} NOTIFICATION: ${e.message||`Notifica ${e.type||"info"} - Messaggio non disponibile`}`;"error"===e.type?console.error(i):"warning"===e.type?console.warn(i):console.log(i)}static checkDOMReady(){if("undefined"==typeof document)return this.isDOMReady=!1,void 0;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.isDOMReady=!0,this.processNotificationQueue(),this.domReadyCallbacks.forEach(e=>{try{e()}catch(t){console.error("❌ DOM ready callback error:",t)}}),this.domReadyCallbacks=[]}):this.isDOMReady=!0}static checkAnimationSupport(){if("undefined"==typeof window||"undefined"==typeof document)return this.animationSupport=!1,void 0;try{const e=document.createElement("div");e.style.animation="test 1s",this.animationSupport=""!==e.style.animation}catch(e){this.animationSupport=!1}this.DEBUG&&console.log("🎬 Animation support:",this.animationSupport)}static checkReducedMotionPreference(){if("undefined"==typeof window||!window.matchMedia)return this.reducedMotionPreference=!1,void 0;try{const e=window.matchMedia("(prefers-reduced-motion: reduce)");this.reducedMotionPreference=e.matches,e.addEventListener("change",e=>{this.reducedMotionPreference=e.matches})}catch(e){this.reducedMotionPreference=!1}this.DEBUG&&console.log("🎬 Reduced motion preference:",this.reducedMotionPreference)}static setupErrorRecovery(){setInterval(()=>{this.cleanupOldQueuedNotifications()},6e4),"undefined"!=typeof window&&window.addEventListener("error",e=>{e.message&&e.message.includes("notification")&&console.warn("⚠️ Possible notification-related error detected")})}static cleanupOldQueuedNotifications(){const e=Date.now(),t=this.notificationQueue.length;this.notificationQueue=this.notificationQueue.filter(t=>e-t.timestamp<6e4);const i=t-this.notificationQueue.length;i>0&&this.DEBUG&&console.log(`🧹 Cleaned up ${i} old queued notifications`)}static recoverFromShowError(e){console.log("🔄 Attempting recovery from show error");try{const t=this.createSimpleFallback(e);if(t){const e=document.querySelector(".notification-container")||document.querySelector("#notification-container")||document.body;if(e)return e.appendChild(t),!0}}catch(t){console.error("❌ Show recovery failed:",t)}return this.showConsoleFallback(e),!1}static recoverFromRemoveError(e){console.log("🔄 Attempting recovery from remove error");try{const t=document.querySelector(`[data-id="${e}"]`);if(t)return t.remove(),!0}catch(t){console.error("❌ Remove recovery failed:",t)}return!1}static recoverFromClearError(){console.log("🔄 Attempting recovery from clear error");try{const e=document.querySelectorAll('.notification, [class*="notification"]');return e.forEach(e=>{try{e.remove()}catch(t){console.debug("Could not remove notification element:",t)}}),!0}catch(e){console.error("❌ Clear recovery failed:",e)}return!1}static recoverFromInitError(){console.log("🔄 Attempting recovery from init error");try{let e=document.querySelector(".notification-container");if(!e)return e=document.createElement("div"),e.className="notification-container notification-container--fallback",e.style.cssText="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    z-index: 9999;\n                    pointer-events: none;\n                ",document.body.appendChild(e),!0}catch(e){console.error("❌ Init recovery failed:",e)}return!1}static getErrorStats(){return{...this.errorCounts,queueSize:this.notificationQueue.length,isDOMReady:this.isDOMReady,animationSupport:this.animationSupport,reducedMotionPreference:this.reducedMotionPreference}}static resetErrorStats(){this.errorCounts={render:0,animation:0,dom:0,service:0,total:0}}static shouldDisableAnimations(){return!this.animationSupport||this.reducedMotionPreference}static onDOMReady(e){if(this.isDOMReady)try{e()}catch(t){console.error("❌ DOM ready callback error:",t)}else this.domReadyCallbacks.push(e)}}"undefined"!=typeof window&&et.init();const tt={SUCCESS:{icon:"check_circle",ariaRole:"status",ariaLive:"polite",defaultDuration:4e3},ERROR:{icon:"error",ariaRole:"alert",ariaLive:"assertive",defaultDuration:0},WARNING:{icon:"warning",ariaRole:"alert",ariaLive:"assertive",defaultDuration:6e3},INFO:{icon:"info",ariaRole:"status",ariaLive:"polite",defaultDuration:5e3}},it={maxWidth:768};function nt(e,t){if(void 0!==t)return t;const i=tt[e.toUpperCase()];return i?i.defaultDuration:5e3}class rt{constructor(e,t=4e3,i="success"){this.element=e,this.duration=t,this.type=i,this.startTime=null,this.animationId=null,this.isPaused=!1,this.pausedTime=0,this.isDestroyed=!1,this.timing=this.createEasingFunction("linear"),this.init()}createEasingFunction(e="linear"){const t={linear:e=>e,easeOut:e=>1-Math.pow(1-e,3),easeIn:e=>Math.pow(e,3),easeInOut:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2};return t[e]||t.linear}init(){if(this.isDestroyed)return;const e=this.element.querySelector(".notification__progress--js-placeholder");e?this.replaceProgressBarPlaceholder(e):this.element.querySelector(".notification__progress")||this.createProgressBar(),this.progressBar=this.element.querySelector(".notification__progress"),this.progressFill=this.element.querySelector(".notification__progress-fill"),this.progressBar&&this.progressFill&&this.start()}replaceProgressBarPlaceholder(e){e.classList.remove("notification__progress--js-placeholder"),e.classList.add("notification__progress--js-controlled"),e.setAttribute("aria-valuenow","100");const t={success:"rgba(16, 185, 129, 0.2)",error:"rgba(239, 68, 68, 0.2)",warning:"rgba(245, 158, 11, 0.2)",info:"rgba(6, 182, 212, 0.2)"};e.style.cssText=`\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: ${t[this.type]||t.info};\n            border-radius: 0 0 8px 8px;\n            overflow: hidden;\n            opacity: 1;\n            z-index: 10;\n            will-change: transform;\n        `;const i=document.createElement("div");i.className="notification__progress-fill";const n={success:"linear-gradient(90deg, #10b981, #34d399)",error:"linear-gradient(90deg, #ef4444, #f87171)",warning:"linear-gradient(90deg, #f59e0b, #fbbf24)",info:"linear-gradient(90deg, #06b6d4, #22d3ee)"};i.style.cssText=`\n            position: absolute;\n            top: 0;\n            left: 0;\n            height: 100%;\n            width: 100%;\n            background: ${n[this.type]||n.info};\n            opacity: 0.9;\n            transform-origin: left;\n            transform: scaleX(1);\n            transition: none;\n            will-change: transform;\n            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);\n        `,e.innerHTML="",e.appendChild(i)}createProgressBar(){const e={success:"rgba(16, 185, 129, 0.2)",error:"rgba(239, 68, 68, 0.2)",warning:"rgba(245, 158, 11, 0.2)",info:"rgba(6, 182, 212, 0.2)"},t={success:"linear-gradient(90deg, #10b981, #34d399)",error:"linear-gradient(90deg, #ef4444, #f87171)",warning:"linear-gradient(90deg, #f59e0b, #fbbf24)",info:"linear-gradient(90deg, #06b6d4, #22d3ee)"},i=document.createElement("div");i.className="notification__progress notification__progress--js-controlled",i.setAttribute("role","progressbar"),i.setAttribute("aria-label","Tempo rimanente prima della chiusura automatica"),i.setAttribute("aria-valuemin","0"),i.setAttribute("aria-valuemax","100"),i.setAttribute("aria-valuenow","100"),i.style.cssText=`\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: ${e[this.type]||e.info};\n            border-radius: 0 0 8px 8px;\n            overflow: hidden;\n            opacity: 1;\n            z-index: 10;\n            will-change: transform;\n        `;const n=document.createElement("div");n.className="notification__progress-fill",n.style.cssText=`\n            position: absolute;\n            top: 0;\n            left: 0;\n            height: 100%;\n            width: 100%;\n            background: ${t[this.type]||t.info};\n            opacity: 0.9;\n            transform-origin: left;\n            transform: scaleX(1);\n            transition: none;\n            will-change: transform;\n            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);\n        `,i.appendChild(n),this.element.appendChild(i)}start(){this.isDestroyed||(this.startTime=performance.now(),this.lastLoggedProgress=-1,this.animate({timing:this.timing,draw:e=>this.draw(e),duration:this.duration}))}animate({timing:e,draw:t,duration:i}){if(this.isDestroyed)return;const n=this.startTime,r=o=>{if(this.isDestroyed)return;if(this.isPaused)return this.animationId=requestAnimationFrame(r),void 0;let a=(o-n-this.pausedTime)/i;a>1&&(a=1),a<0&&(a=0);let s=e(a);t(s),this.updateAccessibility(a),a<1?this.animationId=requestAnimationFrame(r):this.onComplete()};this.animationId=requestAnimationFrame(r)}draw(e){if(this.isDestroyed||!this.progressFill)return;this.progressFill.style.transform=`scaleX(${1-e})`}updateAccessibility(e){if(this.progressBar){const t=Math.round(100*(1-e));this.progressBar.setAttribute("aria-valuenow",t.toString())}}pause(){this.isPaused||this.isDestroyed||(this.isPaused=!0,this.pauseStartTime=performance.now())}resume(){this.isPaused&&!this.isDestroyed&&(this.isPaused=!1,this.pauseStartTime&&(this.pausedTime+=performance.now()-this.pauseStartTime,this.pauseStartTime=null))}stop(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.progressFill&&!this.isDestroyed&&(this.progressFill.style.transform="scaleX(0)")}onComplete(){if(this.isDestroyed)return;const e=new CustomEvent("progressComplete",{detail:{element:this.element,type:this.type,duration:this.duration}});this.element.dispatchEvent(e)}destroy(){this.isDestroyed=!0,this.stop(),this.progressBar&&this.progressBar.parentNode&&this.progressBar.parentNode.removeChild(this.progressBar),this.element=null,this.progressBar=null,this.progressFill=null}}function ot(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function at({notification:e,index:t=0,settings:i,timers:n,removeNotification:r,startAutoCloseTimer:o,pauseAutoCloseTimer:a,resumeAutoCloseTimer:s,announceNotification:c,attachNotificationEvents:d,attachTouchEvents:u,notificationContainer:h,errorHandler:g=et}){try{const t=tt[e.type.toUpperCase()]||tt.INFO,w=e.options||{},E=document.createElement("div");if(E.className=`notification notification--${e.type}`,E.dataset.id=e.id,E.setAttribute("role",t.ariaRole),E.setAttribute("aria-live",t.ariaLive),E.setAttribute("aria-atomic","true"),E.setAttribute("tabindex","0"),i.enableAnimations&&!g.shouldDisableAnimations())try{E.classList.add("notification--entering"),E.addEventListener("animationend",e=>{(e.animationName.includes("slideIn")||e.animationName.includes("fadeIn"))&&(E.classList.remove("notification--entering"),E.classList.add("notification--visible"))}),E.addEventListener("animationerror",e=>{g.handleAnimationError(new Error("Animation failed"),E,"entrance")})}catch(p){g.handleAnimationError(p,E,"entrance")}else E.classList.add("notification--visible","notification--no-animations");let S="";try{S=`\n                <div class="notification__content">\n                    <span class="material-icons notification__icon" aria-hidden="true">${t.icon}</span>\n                    <div class="notification__body">\n                        ${w.title?`<div class="notification__title">${ot(w.title)}</div>`:""}\n                        <div class="notification__message">${ot(e.message)}</div>\n                    </div>\n                </div>\n            `,(!1!==w.closable||w.actions)&&(S+='<div class="notification__actions">',w.actions&&Array.isArray(w.actions)&&w.actions.forEach((e,t)=>{S+=`\n                            <button class="notification__action-btn ${"primary"===e.style?"notification__action-btn--primary":"secondary"===e.style?"notification__action-btn--secondary":""}" \n                                    data-action-index="${t}"\n                                    aria-label="${ot(e.label)}">\n                                ${ot(e.label)}\n                            </button>\n                        `}),!1!==w.closable&&(S+='\n                        <button class="notification__close" \n                                aria-label="Chiudi notifica"\n                                title="Chiudi notifica">\n                            <span class="material-icons" aria-hidden="true">close</span>\n                        </button>\n                    '),S+="</div>");const i=nt(e.type,w.duration);i>0&&!w.persistent&&(l.debug(`🔧 Creating progress bar placeholder for ${e.type} (${i}ms)`),S+=`\n                    <div class="notification__progress notification__progress--js-placeholder" \n                         aria-hidden="true" \n                         role="progressbar"\n                         aria-label="Tempo rimanente prima della chiusura automatica"\n                         data-duration="${i}"\n                         data-type="${e.type}"></div>\n                `),E.innerHTML=S}catch(m){l.error("❌ Error building notification HTML:",m),E.innerHTML=`\n                <div class="notification__content">\n                    <span class="notification__icon">!</span>\n                    <div class="notification__body">\n                        <div class="notification__message">${e.message||"Notifica"}</div>\n                    </div>\n                    <button class="notification__close" aria-label="Chiudi">×</button>\n                </div>\n            `}try{d(E,e,{timers:n,removeNotification:r,pauseAutoCloseTimer:a,resumeAutoCloseTimer:s,notificationContainer:h})}catch(f){l.error("❌ Error attaching notification events:",f);const t=E.querySelector(".notification__close");t&&t.addEventListener("click",()=>{try{r(e.id)}catch(t){E.remove()}})}try{window.innerWidth<=it.maxWidth&&u(E,e,{pauseAutoCloseTimer:a,resumeAutoCloseTimer:s,removeNotification:r})}catch(y){l.error("❌ Error attaching touch events:",y)}try{const t=nt(e.type,w.duration);if(t>0&&!w.persistent){const i=E.querySelector(".notification__progress--js-placeholder");if(l.debug("🔍 Looking for progress bar placeholder:",i),i){const i=new rt(E,t,e.type);o(n,e.id,t,()=>{try{r(e.id)}catch(t){l.error("❌ Error in progress complete callback:",t),E.parentNode&&E.remove()}}),window.innerWidth>768&&(E.addEventListener("mouseenter",()=>{i&&i.pause()}),E.addEventListener("mouseleave",()=>{i&&i.resume()})),E.addEventListener("progressComplete",()=>{try{r(e.id)}catch(t){console.error("❌ Error in progress complete callback:",t),E.parentNode&&E.remove()}}),E._progressBarInstance=i}else o(n,e.id,t,()=>{try{r(e.id)}catch(t){console.error("❌ Error in auto-close callback:",t),E.parentNode&&E.remove()}})}}catch(b){console.error("❌ Error setting up auto-close timer:",b)}try{c(e.type,e.message)}catch(v){console.error("❌ Error announcing notification:",v)}return E}catch(w){return console.error("❌ Critical error in createNotificationElement:",w),g.createSimpleFallback(e)}}function st(e,t,i,n){if(e.has(t)){const i=e.get(t);clearTimeout(i.timerId)}const r=Date.now(),o=setTimeout(()=>{e.delete(t),n(t)},i);e.set(t,{timerId:o,originalDuration:i,startTime:r,remainingTime:i,isPaused:!1,pausedAt:null,callback:n})}function ct(e,t){const i=e.get(t);i&&!i.isPaused&&(clearTimeout(i.timerId),i.isPaused=!0,i.pausedAt=Date.now(),i.remainingTime=i.remainingTime-(i.pausedAt-i.startTime))}function lt(e,t){const i=e.get(t);i&&i.isPaused&&(i.isPaused=!1,i.startTime=Date.now(),i.timerId=setTimeout(()=>{e.delete(t),i.callback&&i.callback(t)},i.remainingTime))}function dt(e,t,i){const n=e.get(t);if(n){clearTimeout(n.timerId),e.delete(t);try{"function"==typeof i&&i(t)}catch(r){console.warn("Timer onStop callback error:",r)}console.log(`⏹️ Timer stopped for notification: ${t}`)}}class ut{static DEBUG=!1;constructor(){this.notificationContainer=null,this.timers=new Map,this.initialized=!1,this.isRendering=!1,this.settings=Ye.getNotificationSettings(),this._lastRenderedNotificationIds=[],this._renderCount=0,this._lastRenderTime=0,this._averageRenderTime=0}flush(){try{const e=Ye.getState("notifications")||[];this.renderNotifications(e)}catch{}}async init(){if(!this.initialized&&"undefined"!=typeof window)try{await this.#e(),function(){if(document.getElementById("notification-announcer"))return;const e=document.createElement("div");e.id="notification-announcer",e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.style.cssText="\n        position: absolute;\n        left: -10000px;\n        width: 1px;\n        height: 1px;\n        overflow: hidden;\n    ",document.body.appendChild(e)}(),Ye.subscribe("notifications",this.#t),this.initialized=!0}catch(e){et.handleServiceError(e,"init"),this.initialized=!0}}async#e(){if(this.notificationContainer)return;const{NotificationContainer:e}=await t(async()=>{const{NotificationContainer:e}=await import("./NotificationContainer-Dr5T1boT.js");return{NotificationContainer:e}},[]);this.notificationContainer=new e({position:this.settings.position,maxVisible:this.settings.maxVisible})}show(e,t,i={}){try{const n=this.#i(e),r=String(t||"").trim();if(!r){return this.show(n,`Notifica ${n} - Messaggio non disponibile`,i)}const o=this.#n(n),a=this.#r(i,o);return Ye.addNotification(n,r,a)}catch(n){return et.handleServiceError(n,"show",{type:e,message:t,options:i}),et.recoverFromShowError({type:this.#i(e),message:t,options:i,id:Date.now().toString()})}}success(e,t={}){return"number"==typeof t&&(t={duration:t}),this.show("success",e,t)}info(e,t={}){return"number"==typeof t&&(t={duration:t}),this.show("info",e,t)}warning(e,t={}){return"number"==typeof t&&(t={duration:t}),this.show("warning",e,t)}error(e,t={}){return"number"==typeof t&&(t={duration:t}),this.show("error",e,t)}renderNotifications(e=[]){if(Array.isArray(e)&&this.notificationContainer&&!this.isRendering){this.isRendering=!0;try{const n="undefined"!=typeof window&&window.performance&&"function"==typeof window.performance.now?()=>window.performance.now():()=>Date.now(),r=n(),o=new Set(e.map(e=>e.id)),a=new Set(this._lastRenderedNotificationIds);a.forEach(e=>{if(!o.has(e))try{this.notificationContainer.removeNotification(e)}catch(t){et.handleDOMError(t,"remove",null)}}),e.forEach(e=>{if(!a.has(e.id))try{this.#o(e)}catch(t){et.handleRenderError(t,e,e=>{const t=et.createSimpleFallback(e);return t&&this.notificationContainer.addNotification(t),t})}}),t=e.slice(this.settings.maxVisible),i=e=>this.removeNotification(e),t.forEach(e=>{"success"!==e.type&&"info"!==e.type||setTimeout(()=>{i(e.id)},1e3)}),this._lastRenderedNotificationIds=e.map(e=>e.id);const s=n(),c=Math.max(0,s-r);this._lastRenderTime=c,this._renderCount+=1,this._averageRenderTime=1===this._renderCount?c:(this._averageRenderTime*(this._renderCount-1)+c)/this._renderCount}finally{this.isRendering=!1}var t,i}}#o(e){const t=at({notification:e,settings:this.settings,timers:this.timers,removeNotification:e=>this.removeNotification(e),handleAction:(e,t)=>this.handleAction(e,t),startAutoCloseTimer:st,pauseAutoCloseTimer:ct,resumeAutoCloseTimer:lt,announceNotification:Ke,attachNotificationEvents:Qe,attachTouchEvents:Ze,notificationContainer:this.notificationContainer,errorHandler:et});if(!t)throw new Error("createNotificationElement returned null");this.notificationContainer.addNotification(t)}#t=this.#a(e=>{let t=[];Array.isArray(e)?t=e:e&&"object"==typeof e&&(t=e.notifications||[]),this.renderNotifications(t)},16);removeNotification(e){try{if(dt(this.timers,e,()=>this.#s(e)),!this.notificationContainer)return Ye.removeNotification(e),void 0;const t=this.notificationContainer.container?.querySelector(`[data-id="${e}"]`),i=this.settings.enableAnimations&&!et.shouldDisableAnimations();if(t&&i)try{t.classList.remove("notification--entering"),t.classList.add("notification--exiting");const i=t.querySelector(".notification__progress");return i&&i.classList.remove("notification__progress--active","notification__progress--paused","notification__progress--resumed"),setTimeout(()=>this.#c(e),300),void 0}catch{}this.#c(e)}catch(t){et.handleServiceError(t,"remove",e),et.recoverFromRemoveError(e)}}#c(e){try{this.notificationContainer&&this.notificationContainer.removeNotification(e)}catch{}Ye.removeNotification(e)}clear(){try{this.timers.forEach((e,t)=>dt(this.timers,t,()=>this.#s(t))),this.timers.clear(),this.notificationContainer?.clearAllNotifications&&this.notificationContainer.clearAllNotifications(),Ye.clearAllNotifications()}catch(e){et.handleServiceError(e,"clear"),et.recoverFromClearError()}}clearByType(e){(Ye.getState("notifications")||[]).forEach(t=>{t.type===e&&this.timers.has(t.id)&&dt(this.timers,t.id,()=>this.#s(t.id))}),Ye.clearNotificationsByType(e)}startAutoCloseTimer(e,t){try{st(this.timers,e,t,e=>this.removeNotification(e))}catch{}}pauseAutoCloseTimer(e){try{ct(this.timers,e)}catch{}}resumeAutoCloseTimer(e){try{lt(this.timers,e)}catch{}}stopAutoCloseTimer(e){try{dt(this.timers,e,()=>this.#s(e))}catch{}}handleAction(e,t){try{const i=(Ye.getState("notifications")||[]).find(t=>t.id===e),n=i?.options?.actions?.[t];n&&"function"==typeof n.onClick&&n.onClick({id:e,index:t,notification:i})}catch{}}setCustomDurations(e){this.updateSettings({customDurations:{...this.settings.customDurations||{},...e}})}setPersistentTypes(e){this.updateSettings({persistentTypes:[...e]})}setAutoCleanupInterval(e){this.updateSettings({autoCleanupInterval:e})}updatePosition(e){this.updateSettings({position:e})}setMaxVisible(e){this.updateSettings({maxVisible:e});const t=Ye.getState("notifications")||[];this.renderNotifications(t)}enableSounds(e=!0){this.updateSettings({enableSounds:!!e})}updateSettings(e){try{const t=this._validateSettings(e);if(Ye.updateNotificationSettings(t),this.settings=Ye.getNotificationSettings(),this.notificationContainer){const e={};"position"in t&&(e.position=this.settings.position),"maxVisible"in t&&(e.maxVisible=this.settings.maxVisible),Object.keys(e).length&&this.notificationContainer.updateSettings(e)}return!0}catch{return!1}}getStats(){try{return{..."function"==typeof Ye.getNotificationStats?Ye.getNotificationStats():{total:0,visible:0,byType:{success:0,error:0,warning:0,info:0},persistent:0},settings:this.settings,activeTimers:this.timers.size,containerInitialized:!!this.notificationContainer,serviceInitialized:this.initialized,performance:{renderCount:this._renderCount,averageRenderTime:this._averageRenderTime,lastRenderTime:this._lastRenderTime}}}catch(e){return{total:0,visible:0,byType:{success:0,error:0,warning:0,info:0},persistent:0,error:e?.message}}}exportSettings(){try{const e=Ye.exportNotificationSettings();return e.serviceMetadata={version:"2.0",exportedBy:"NotificationService"},e}catch(e){return null}}importSettings(e){try{if(!e||"object"!=typeof e||!e.settings)return!1;e.version&&"1.0"!==e.version&&console.warn(`Versione backup non supportata: ${e.version}`);const t=Ye.importNotificationSettings(e);return t&&(this.settings=Ye.getNotificationSettings()),t}catch(t){return!1}}cleanupOldNotifications(e=3e5){try{if("function"==typeof Ye.clearOldNotifications){const t=Ye.clearOldNotifications(e)??0,i=new Set((Ye.getState("notifications")||[]).map(e=>e.id));return Array.from(this.timers.keys()).forEach(e=>{i.has(e)||this.timers.delete(e)}),t}const t=Date.now(),i=Ye.getState("notifications")||[];let n=0;i.forEach(i=>{const r=new Date(i.timestamp).getTime();if(Number.isFinite(r)&&t-r>e)try{Ye.removeNotification(i.id),n+=1}catch{}});const r=new Set((Ye.getState("notifications")||[]).map(e=>e.id));return Array.from(this.timers.keys()).forEach(e=>{r.has(e)||this.timers.delete(e)}),n}catch{return 0}}_validateSettings(e){const t={},i=e=>"number"==typeof e&&!Number.isNaN(e),n=e=>"boolean"==typeof e;if(void 0!==e.maxVisible){if(!Number.isInteger(e.maxVisible)||e.maxVisible<1||e.maxVisible>20)throw new Error("maxVisible must be between 1 and 20");t.maxVisible=e.maxVisible}if(void 0!==e.defaultDuration){if(!i(e.defaultDuration)||e.defaultDuration<0)throw new Error("defaultDuration must be >= 0");t.defaultDuration=e.defaultDuration}if(void 0!==e.position){if(!["top-right","top-left","bottom-right","bottom-left","top-center","bottom-center"].includes(e.position))throw new Error("invalid position");t.position=e.position}if(void 0!==e.enableSounds){if(!n(e.enableSounds))throw new Error("enableSounds must be boolean");t.enableSounds=e.enableSounds}if(void 0!==e.enableAnimations){if(!n(e.enableAnimations))throw new Error("enableAnimations must be boolean");t.enableAnimations=e.enableAnimations}if(void 0!==e.autoCleanupInterval){if(!i(e.autoCleanupInterval)||e.autoCleanupInterval<6e4)throw new Error("autoCleanupInterval must be >= 60000");t.autoCleanupInterval=e.autoCleanupInterval}if(void 0!==e.maxStoredNotifications){if(!Number.isInteger(e.maxStoredNotifications)||e.maxStoredNotifications<10)throw new Error("maxStoredNotifications must be >= 10");t.maxStoredNotifications=e.maxStoredNotifications}if(void 0!==e.persistentTypes){if(!Array.isArray(e.persistentTypes))throw new Error("persistentTypes must be array");t.persistentTypes=[...e.persistentTypes]}if(void 0!==e.soundVolume){if(!i(e.soundVolume)||e.soundVolume<0||e.soundVolume>1)throw new Error("soundVolume must be between 0 and 1");t.soundVolume=e.soundVolume}if(void 0!==e.customDurations){const n=["success","error","warning","info"],r=e.customDurations;if(!r||"object"!=typeof r)throw new Error("customDurations must be object");for(const e of Object.keys(r))if(!n.includes(e)||!i(r[e])||r[e]<0)throw new Error("invalid customDurations entry");t.customDurations={...r}}return t}getNotificationsByType(e){try{return Ye.getNotificationsByType(e)}catch{return[]}}getVisibleNotifications(){try{return Ye.getVisibleNotifications()}catch{return[]}}hasErrors(){try{return Ye.hasErrorNotifications()}catch{return!1}}destroy(){try{this.timers.forEach((e,t)=>dt(this.timers,t)),this.timers.clear(),this.notificationContainer?.clearAllNotifications&&this.notificationContainer.clearAllNotifications()}finally{this.notificationContainer=null,this.initialized=!1}}#n(e){const t=this.settings||{},i=(t.customDurations||{})[e];return(t.persistentTypes||[]).includes(e)?0:"number"==typeof i?i:"number"==typeof t.defaultDuration?t.defaultDuration:5e3}#r(e,t){return{duration:void 0!==e.duration?e.duration:t,closable:!1!==e.closable,position:e.position||this.settings.position,priority:e.priority||0,title:e.title,actions:e.actions,persistent:e.persistent,...e}}#s(e){try{const t=this.notificationContainer?.container?.querySelector(`[data-id="${e}"]`);t&&t._progressBarInstance&&(t._progressBarInstance.destroy(),t._progressBarInstance=null)}catch{}}#a(e,t){let i=!1;return(...n)=>{i||(e.apply(this,n),i=!0,setTimeout(()=>i=!1,t))}}#i(e){const t=String(e||"").toLowerCase();switch(t){case"errore":case"danger":case"err":case"error":return"error";case"successo":case"ok":case"success":return"success";case"avviso":case"warn":case"warning":return"warning";default:return"info"===t||"informazione"===t?"info":t||"info"}}}const ht=new ut;function gt(){!function(){const e=document.getElementById("theme-toggle"),t=document.getElementById("theme-icon");if(!e||!t)return;pt(localStorage.getItem("theme")||"light"),e.addEventListener("click",()=>{pt("dark"===(document.documentElement.getAttribute("data-bs-theme")||"light")?"light":"dark")})}(),function(){const e=document.getElementById("mobile-theme-toggle"),t=document.getElementById("mobile-theme-icon");if(!e||!t)return;function i(){"dark"===(document.documentElement.getAttribute("data-bs-theme")||"light")?(t.textContent="light_mode",e.setAttribute("title","Modalità chiara")):(t.textContent="dark_mode",e.setAttribute("title","Modalità scura"))}e.addEventListener("click",e=>{e.preventDefault();pt("dark"===(document.documentElement.getAttribute("data-bs-theme")||"light")?"light":"dark")});new MutationObserver(i).observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]}),i()}()}function pt(e){document.documentElement.setAttribute("data-bs-theme",e),localStorage.setItem("theme",e);const t=document.getElementById("theme-icon"),i=document.getElementById("theme-toggle");t&&i&&("dark"===e?(t.textContent="light_mode",i.setAttribute("title","Modalità chiara")):(t.textContent="dark_mode",i.setAttribute("title","Modalità scura")))}const mt=new class{constructor(){this.loadingInstances=new Map}showLoading(e,t="Caricamento..."){if("string"==typeof e&&(e=document.getElementById(e)||document.querySelector(e)),!e)return;const i=this.generateId(),n=this.createLoadingElement(t);return this.loadingInstances.set(i,{container:e,originalContent:e.innerHTML}),e.innerHTML=Ce(""),e.appendChild(n),i}hideLoading(e){const t=this.loadingInstances.get(e);t&&(t.container.innerHTML=Ce(t.originalContent),this.loadingInstances.delete(e))}showEmpty(e,t="Nessun dato disponibile",i="inbox"){if("string"==typeof e&&(e=document.getElementById(e)||document.querySelector(e)),!e)return;const n=this.createEmptyElement(t,i);e.innerHTML=Ce(""),e.appendChild(n)}showError(e,t="Si è verificato un errore",i=!1,n=null){if("string"==typeof e&&(e=document.getElementById(e)||document.querySelector(e)),!e)return;const r=this.createErrorElement(t,i,n);e.innerHTML=Ce(""),e.appendChild(r)}createLoadingElement(e){const t=document.createElement("div");return t.className="ui-state loading-state",t.innerHTML=Ce(`\n            <div class="loading-content">\n                <div class="spinner">\n                    <div class="spinner-border text-primary" role="status">\n                        <span class="visually-hidden">Loading...</span>\n                    </div>\n                </div>\n                <div class="loading-message">${e}</div>\n            </div>\n            <style>\n                .ui-state {\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    min-height: 200px;\n                    text-align: center;\n                    padding: 2rem;\n                }\n                \n                .loading-content {\n                    display: flex;\n                    flex-direction: column;\n                    align-items: center;\n                    gap: 1rem;\n                }\n                \n                .loading-message {\n                    color: #6c757d;\n                    font-size: 0.9rem;\n                }\n                \n                .empty-content {\n                    display: flex;\n                    flex-direction: column;\n                    align-items: center;\n                    gap: 1rem;\n                    color: #6c757d;\n                }\n                \n                .empty-icon {\n                    font-size: 3rem;\n                    opacity: 0.5;\n                }\n                \n                .empty-message {\n                    font-size: 1.1rem;\n                    font-weight: 500;\n                }\n                \n                .error-content {\n                    display: flex;\n                    flex-direction: column;\n                    align-items: center;\n                    gap: 1rem;\n                    color: #dc3545;\n                }\n                \n                .error-icon {\n                    font-size: 3rem;\n                    opacity: 0.7;\n                }\n                \n                .error-message {\n                    font-size: 1.1rem;\n                    font-weight: 500;\n                    text-align: center;\n                }\n                \n                .retry-button {\n                    margin-top: 0.5rem;\n                }\n            </style>\n        `),t}createEmptyElement(e,t){const i=document.createElement("div");return i.className="ui-state empty-state",i.innerHTML=Ce(`\n            <div class="empty-content">\n                <span class="material-icons empty-icon">${t}</span>\n                <div class="empty-message">${e}</div>\n            </div>\n        `),i}createErrorElement(e,t,i){const n=document.createElement("div");n.className="ui-state error-state";if(n.innerHTML=Ce(`\n            <div class="error-content">\n                <span class="material-icons error-icon">error_outline</span>\n                <div class="error-message">${e}</div>\n                ${t&&i?'\n            <button class="btn btn-outline-danger btn-sm retry-button">\n                <span class="material-icons me-1">refresh</span>\n                Riprova\n            </button>\n        ':""}\n            </div>\n        `),t&&i){n.querySelector(".retry-button").addEventListener("click",i)}return n}showPageLoading(e="Caricamento..."){const t=document.createElement("div");t.id="page-loading-overlay",t.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(255, 255, 255, 0.9);\n            z-index: 9998;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        ";const i=this.createLoadingElement(e);return t.appendChild(i),document.body.appendChild(t),()=>{const e=document.getElementById("page-loading-overlay");e&&e.remove()}}hidePageLoading(){const e=document.getElementById("page-loading-overlay");e&&e.remove()}generateId(){return"loading_"+Math.random().toString(36).substr(2,9)}async withLoading(e,t,i="Caricamento..."){const n=this.showLoading(e,i);try{const e=await t();return this.hideLoading(n),e}catch(r){throw this.hideLoading(n),this.showError(e,`Errore: ${r.message}`,!0,()=>{this.withLoading(e,t,i)}),r}}renderConditional(e,t,i,n="Nessun dato disponibile"){if(!t||Array.isArray(t)&&0===t.length)return this.showEmpty(e,n),void 0;"string"==typeof e&&(e=document.getElementById(e)||document.querySelector(e)),e&&(e.innerHTML=Ce(""),i(e,t))}};"undefined"!=typeof window&&(window.uiStateService=mt),"undefined"!=typeof window&&(window.EMERGENCY_STOP=function(){console.log("🚨 EMERGENCY STOP ACTIVATED");try{window.notificationService&&(window.notificationService.timers?.forEach(e=>clearTimeout(e)),window.notificationService.timers?.clear(),window.notificationService.emergencyReset&&window.notificationService.emergencyReset()),window.stateService&&window.stateService.subscribers?.clear()}catch(e){console.error("❌ Emergency stop failed:",e)}},window.EMERGENCY_RELOAD=function(){console.log("🔄 Emergency reload..."),location.reload()});let ft=!1;function yt(e){const t=document.getElementById("auth-container");if(t){if(e){const i=p.profile?.role||"caricamento...",n=e.user.email;t.innerHTML=Ce(`\n            <div class="d-flex align-items-center text-light">\n                <span class="navbar-text me-3" title="${n}">\n                    <i class="material-icons me-1" style="font-size: 1.1em; vertical-align: text-bottom;">account_circle</i>\n                    ${n.split("@")[0]}\n                </span>\n                <span class="badge bg-info me-3 text-uppercase" style="font-size: 0.75em; padding: 0.4em 0.6em;">\n                    ${i}\n                </span>\n                <button id="logout-button" class="btn btn-outline-light btn-sm">\n                    <i class="material-icons" style="font-size: 1em; vertical-align: middle;">logout</i>\n                </button>\n            </div>\n        `)}else t.innerHTML=Ce('\n            <button id="login-modal-trigger" class="btn btn-outline-light">\n                <i class="material-icons me-1" style="font-size: 1em;">login</i>\n                Accedi\n            </button>\n        ');v()}}function bt(){window.addEventListener("auth:session-changed",e=>{yt(e.detail?.session||null)}),void 0!==p&&yt(p.session||null),document.body.addEventListener("click",async e=>{if(e.target.closest("#logout-button")&&(e.preventDefault(),await f()),e.target.closest("#login-modal-trigger")&&(e.preventDefault(),async function(){let e=document.getElementById("auth-modal");if(!e){const{default:i}=await t(async()=>{const{default:e}=await import("./auth-modal-VMurGtIz.js");return{default:e}},[]),n=document.createElement("div");n.innerHTML=Ce(i),document.body.appendChild(n.firstElementChild),e=document.getElementById("auth-modal")}const i=document.getElementById("auth-error-message");i&&(i.style.display="none");new r(e).show()}()),e.target.closest("#google-login-btn")){e.preventDefault(),l.log("Pulsante Google cliccato");const t=e.target.closest("#google-login-btn"),n=t.querySelector(".spinner-border"),o=t.querySelector(".material-icons");t.disabled=!0,n&&(n.style.display="inline-block"),o&&(o.style.display="none");try{await async function(){return await g.signInWithGoogle()}();!function(){const e=document.getElementById("auth-modal");if(e){const t=r.getInstance(e);t&&t.hide()}}()}catch(i){console.error("Errore durante l'accesso:",i);const e=document.getElementById("auth-error");e&&(e.textContent="Errore durante l'accesso. Riprova.",e.style.display="block")}finally{t.disabled=!1,n&&(n.style.display="none"),o&&(o.style.display="inline-block")}}})}function vt(){document.addEventListener("click",e=>{const t=e.target.closest(".btn-back-menu");if(t){e.preventDefault(),t.style.transform="scale(0.95)",t.style.transition="transform 0.1s ease",setTimeout(()=>{t.style.transform="",t.style.transition=""},150);const i=t.getAttribute("data-view")||"home";"home"===i&&(sessionStorage.removeItem("editPazienteId"),sessionStorage.removeItem("formData"),sessionStorage.removeItem("currentFilters")),setTimeout(()=>De(i),100)}})}void(window.innerWidth>767||document.addEventListener("DOMContentLoaded",()=>{!function(){if(ft)return;const e=()=>{ft=!0,document.removeEventListener("touchstart",e),document.removeEventListener("click",e)};document.addEventListener("touchstart",e,{once:!0,passive:!0}),document.addEventListener("click",e,{once:!0,passive:!0})}(),document.querySelectorAll(".card").forEach(e=>{e.addEventListener("touchstart",e=>{if(!e.target.closest("button, a, input, select, .custom-select-wrapper"))try{"vibrate"in navigator&&ft&&navigator.vibrate(10)}catch(t){console.debug("Vibrazione non disponibile o bloccata.",t.message)}},{passive:!0})}),window.addEventListener("resize",()=>{window.innerWidth<=480?document.querySelectorAll(".cards-grid-mobile").forEach(e=>{e.style.gridTemplateColumns="1fr"}):document.querySelectorAll(".cards-grid-mobile").forEach(e=>{e.style.gridTemplateColumns=""})},{passive:!0})})),window.addEventListener("load",async function(){try{l.log(`🚀 Inizializzazione ${a} v${s}`),Ie(),gt(),vt(),function(){b(),window.addEventListener("resize",b);const e=document.getElementById("auth-container");e&&new MutationObserver(v).observe(e,{childList:!0,subtree:!0});setTimeout(v,150),window.addEventListener("auth:session-changed",()=>{v()})}(),window.authUIListenersInitialized||(bt(),window.authUIListenersInitialized=!0),ht.init(),window.addEventListener("hashchange",Ne),await async function(e){g.init();try{if("undefined"!=typeof window&&window.__PW_E2E_AUTH_MOCK){const t={user:{id:"e2e-user-123",email:"e2e@example.com",user_metadata:{name:"E2E User"}},access_token:"e2e-token"};return await m(t),e&&e(t),l.log("E2E auth mock attivo: sessione e profilo impostati"),void 0}}catch{}const{data:{session:t}}=await d.auth.getSession();l.log("Sessione iniziale recuperata:",t),await m(t),e&&e(t),d.auth.onAuthStateChange(async(t,i)=>{l.log("Auth event:",t,"Session:",i),"SIGNED_OUT"===t&&"error"===g.getAuthState().state&&g.clearCorruptedState(),i?.access_token!==p.session?.access_token&&(await m(i),e&&e(i))}),l.log("Sistema di autenticazione inizializzato")}(e=>{const t=sessionStorage.getItem(o);sessionStorage.removeItem(o),e&&t?window.location.hash=t:Ne()}),l.log("✅ Applicazione inizializzata con successo")}catch(e){console.error("❌ Errore durante l'inizializzazione dell'applicazione:",e),document.body.innerHTML=Ce('\n      <div class="container mt-5">\n        <div class="alert alert-danger" role="alert">\n          <h4 class="alert-heading">Errore di inizializzazione</h4>\n          <p>Si è verificato un errore durante l\'avvio dell\'applicazione.</p>\n          \n          <hr>\n          <p class="mb-0">Ricarica la pagina per riprovare.</p>\n        </div>\n      </div>\n    ')}});export{Ce as a,Ye as b,De as c,p as d,u as e,Xe as f,vt as i,l,ht as n,_e as p,d as s};
