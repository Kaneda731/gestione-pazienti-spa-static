import{j as e}from"./ui-vendor-S6RcKJ66.js";import{b as t,i as n,R as i}from"./react-vendor-Bp2pLdQf.js";import{u as a,a as o,b as r,W as s}from"./WizardStepper-wmT1Y9zi.js";import{T as l,e as c,p as d,v as p}from"./patientService-nZnPwMcP.js";import{l as m,c as u}from"./index-Tu0R_pQ1.js";import{D as v}from"./DateRangePicker-CWxAFNS2.js";import{u as h}from"./useQuery-7TTwZeE5.js";import{n as g,a as b}from"./notificationService-BvbiyDvA.js";const x={activeOnly:!0,maxResults:10,minSearchLength:2,debounceDelay:300,enableCache:!0,includeFields:["id","nome","cognome","codice_fiscale","data_nascita","reparto_appartenenza","data_ricovero","data_dimissione","codice_rad"]};const _=new class{cache;pendingRequests;debounceTimers;constructor(){this.cache=new l({ttl:3e5,maxSize:100,enableStats:!0}),this.pendingRequests=new Map,this.debounceTimers=new Map}async search(e,t={}){const n={...x,...t};if(e.length<n.minSearchLength)return[];const i=this.buildCacheKey(e,n);if(n.enableCache){const t=this.cache.get(i);if(t)return m.debug("[PatientSearch] Cache hit",{searchTerm:e,count:t.length}),t}const a=this.pendingRequests.get(i);if(a)return m.debug("[PatientSearch] Request deduplication",{searchTerm:e}),a;const o=this.executeSearch(e,n);this.pendingRequests.set(i,o);try{const e=await o;return n.enableCache&&this.cache.set(i,e),e}finally{this.pendingRequests.delete(i)}}searchDebounced(e,t={}){const n={...x,...t},i=this.buildCacheKey(e,n);return new Promise((a,o)=>{const r=this.debounceTimers.get(i);r&&clearTimeout(r);const s=setTimeout(async()=>{try{const n=await this.search(e,t);a(n)}catch(n){o(n)}finally{this.debounceTimers.delete(i)}},n.debounceDelay);this.debounceTimers.set(i,s)})}async executeSearch(e,t){try{m.debug("[PatientSearch] Executing search",{searchTerm:e,options:t});let n=u.from("pazienti").select(t.includeFields.join(",")).limit(t.maxResults);t.activeOnly&&(n=n.is("data_dimissione",null));const i=e.trim().split(/\s+/);if(1===i.length){const e=`%${i[0]}%`;n=n.or(`nome.ilike.${e},cognome.ilike.${e},codice_fiscale.ilike.${e},codice_rad.ilike.${e}`)}else if(2===i.length){const e=i[0],t=i[1];n=n.or([`and(nome.ilike.%${e}%,nome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(nome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,nome.ilike.%${t}%)`,`codice_rad.ilike.%${e}%${t}%`,`codice_rad.ilike.%${t}%${e}%`].join(","))}else{const e=i[0],t=i[1];n=n.or([`and(nome.ilike.%${e}%,nome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(nome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,nome.ilike.%${t}%)`].join(","))}n=n.order("cognome").order("nome");const{data:a,error:o}=await n;if(o)throw m.error("[PatientSearch] Search error",o),o;return m.debug("[PatientSearch] Search completed",{searchTerm:e,resultsCount:a?.length??0}),a??[]}catch(n){throw m.error("[PatientSearch] Unexpected error",n),n}}buildCacheKey(e,t){return JSON.stringify({term:e.toLowerCase(),activeOnly:t.activeOnly??!0,maxResults:t.maxResults??10})}clearCache(){this.cache.clear(),m.debug("[PatientSearch] Cache cleared")}getCacheStats(){return this.cache.getStats()}invalidateCache(e){if(!e)return this.clearCache(),void 0;this.cache.invalidate(t=>t.includes(e.toLowerCase()))}},f={activeOnly:!1,maxResults:10,minSearchLength:2,debounceDelay:300,enableCache:!0,enabled:!0};const j=({value:i,onChange:a,placeholder:o="Cerca paziente...",className:r="",disabled:s=!1,required:l=!1,activeOnly:c=!1,maxResults:d=10,minSearchLength:p=2,debounceDelay:u=300,showPatientInfo:v=!0,highlightMatch:h=!0})=>{const g=t.useId(),b=`patient-autocomplete-${g}`,x=`patient-autocomplete-list-${g}`,j=t.useRef(null),N=t.useRef(null),S=t.useRef(null),[z,w]=t.useState(!1),[y,k]=t.useState(-1),[C,E]=t.useState(""),[P,D]=t.useState({top:0,left:0,width:0}),{searchTerm:I,setSearchTerm:$,results:T,loading:R,error:L,clearSearch:A}=function(e={}){const n={...f,...e},{enabled:i,minSearchLength:a,...o}=n,[r,s]=t.useState(""),[l,c]=t.useState([]),[d,p]=t.useState(!1),[u,v]=t.useState(null),h=t.useRef(null),g=t.useRef(!1),b=t.useCallback(async e=>{if(!g.current){if(!e||e.trim().length<(a??2))return c([]),v(null),p(!1),void 0;h.current&&h.current.abort(),h.current=new AbortController,g.current=!0,p(!0),v(null);try{m.debug("[usePatientSearch] Performing search",{term:e});const t=await _.searchDebounced(e.trim(),o);h.current?.signal.aborted||(c(t),0===t.length&&v(`Nessun paziente trovato per "${e}"`))}catch(t){if(!h.current?.signal.aborted){const e=t instanceof Error?t.message:"Errore durante la ricerca";v(e),c([]),m.error("[usePatientSearch] Search error:",t)}}finally{h.current?.signal.aborted||p(!1),g.current=!1}}},[a,o]),x=t.useCallback(e=>{s(e),i&&b(e)},[i,b]),j=t.useCallback(()=>{s(""),c([]),v(null),h.current&&h.current.abort(),g.current=!1},[]),N=t.useCallback(()=>{r&&b(r)},[r,b]),S=_.getCacheStats();return t.useEffect(()=>()=>{h.current&&h.current.abort(),g.current=!1},[]),{searchTerm:r,setSearchTerm:x,results:l,loading:d,error:u,clearSearch:j,refetch:N,cacheStats:S}}({activeOnly:c,maxResults:d,minSearchLength:p,debounceDelay:u,enableCache:!0});t.useEffect(()=>{if(i){E(`${i.cognome} ${i.nome}`)}else E("")},[i]),t.useEffect(()=>{const e=e=>{const t=e.target,n=j.current&&j.current.contains(t),i=S.current&&S.current.contains(t);n||i||(w(!1),k(-1))};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),t.useEffect(()=>{if(z&&N.current){const e=N.current.getBoundingClientRect();D({top:e.top+e.height,left:e.left,width:e.width})}},[z]);const O=t.useMemo(()=>T.slice(0,d),[T,d]),q=t.useCallback((t,n)=>{if(!h||!n.trim())return t;const i=new RegExp(`(${n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return t.split(i).map((t,n)=>i.test(t)?e.jsx("mark",{className:"bg-warning text-dark",children:t},n):t)},[h]),F=t.useCallback(e=>{const t=e.target.value;E(t),$(t),t.trim().length>=p?(w(!0),k(-1)):(w(!1),k(-1)),t.trim()||a(null)},[$,p,a]),M=t.useCallback(e=>{a(e),w(!1),k(-1),m.log("[PatientAutocomplete] Patient selected:",{id:e.id,name:`${e.cognome} ${e.nome}`})},[a]),K=t.useCallback(e=>{if(!z||0===O.length)return"ArrowDown"===e.key&&I.trim().length>=p&&(w(!0),k(0)),void 0;switch(e.key){case"ArrowDown":e.preventDefault(),k(e=>e<O.length-1?e+1:0);break;case"ArrowUp":e.preventDefault(),k(e=>e>0?e-1:O.length-1);break;case"Enter":e.preventDefault(),y>=0&&O[y]&&M(O[y]);break;case"Escape":e.preventDefault(),w(!1),k(-1),N.current?.blur()}},[z,O,y,I,p,M]),H=t.useCallback(()=>{I.trim().length>=p&&O.length>0&&w(!0)},[I,p,O.length]),V=t.useCallback(()=>{E(""),$(""),w(!1),k(-1),a(null),A()},[$,a,A]),B=t.useCallback(e=>q(`${e.cognome} ${e.nome}`,I),[I,q]),U=t.useCallback(e=>{const t=[];if(e.codice_rad&&t.push(`RAD: ${e.codice_rad}`),e.reparto_appartenenza&&t.push(e.reparto_appartenenza),e.data_ricovero){const n=new Date(e.data_ricovero);t.push(`Ric: ${n.toLocaleDateString("it-IT")}`)}return t.join(" • ")},[]);return t.useEffect(()=>{if(y>=0&&S.current){const e=S.current.children[y];e&&e.scrollIntoView({block:"nearest"})}},[y]),t.useEffect(()=>{if(!z||!S.current)return;const e=e=>{e.stopPropagation(),e.preventDefault();const t=e.currentTarget,n=S.current?.querySelectorAll('li[role="option"]');if(n){const e=Array.from(n).indexOf(t);e>=0&&O[e]&&M(O[e])}};let t=0;const n=()=>{if(!S.current)return;const i=S.current.querySelectorAll('li[role="option"]');i.length>0?i.forEach(t=>{t.addEventListener("click",e,!1)}):t<10&&(t++,setTimeout(n,50))};return n(),()=>{if(S.current){S.current.querySelectorAll('li[role="option"]').forEach(t=>{t.removeEventListener("click",e,!1)})}}},[z,O,M]),e.jsxs("div",{className:`patient-autocomplete position-relative ${r}`,ref:j,children:[e.jsxs("div",{className:"input-group",children:[e.jsx("input",{ref:N,id:b,type:"text",className:"form-control "+(s?"bg-light":""),placeholder:o,value:C,onChange:F,onKeyDown:K,onFocus:H,disabled:s,required:l,role:"combobox","aria-controls":x,"aria-expanded":z,"aria-autocomplete":"list","aria-busy":R,"aria-describedby":L?`${b}-error`:void 0}),C&&!s&&e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:V,"aria-label":"Cancella ricerca",children:e.jsx("i",{className:"bi bi-x-lg"})}),R&&e.jsx("span",{className:"input-group-text",children:e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"})})]}),L&&e.jsx("div",{id:`${b}-error`,className:"form-text text-danger mt-1",children:L}),z&&n.createPortal(e.jsxs("ul",{ref:S,id:x,className:"list-group shadow-sm",style:{position:"fixed",top:`${P.top}px`,left:`${P.left}px`,width:`${P.width}px`,maxHeight:"300px",overflowY:"auto",zIndex:9999,backgroundColor:"white",borderRadius:"0.25rem",border:"1px solid #dee2e6"},role:"listbox",children:[R&&e.jsxs("li",{className:"list-group-item text-muted",role:"presentation",children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Ricerca in corso..."]}),!R&&0===O.length&&I.trim().length>=p&&e.jsxs("li",{className:"list-group-item text-muted text-center py-3",role:"presentation",children:[e.jsx("i",{className:"bi bi-person-x fs-4 d-block mb-2"}),'Nessun paziente trovato per "',e.jsx("strong",{children:I}),'"']}),!R&&O.map((t,n)=>e.jsx("li",{role:"option",className:`list-group-item list-group-item-action cursor-pointer ${n===y?"active":""} ${i?.id===t.id?"border-primary":""}`,onMouseEnter:()=>k(n),"aria-selected":n===y,"data-patient-index":n,children:e.jsx("div",{className:"d-flex justify-content-between align-items-start",children:e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"fw-semibold",children:[B(t),i?.id===t.id&&e.jsx("i",{className:"bi bi-check-circle-fill text-primary ms-2","aria-label":"Selezionato"})]}),v&&e.jsx("div",{className:"small text-muted mt-1",children:U(t)}),t.diagnosi&&e.jsxs("div",{className:"small text-muted mt-1",children:[e.jsx("i",{className:"bi bi-clipboard2-pulse me-1"}),t.diagnosi]})]})})},t.id))]}),document.body)]})},N=[{value:"batterico",label:"Batterico"},{value:"virale",label:"Virale"},{value:"fungino",label:"Fungino"},{value:"parassitario",label:"Parassitario"}],S={DESCRIPTION:4,NOTES:6},z={PATIENT_SEARCH:300},w={PLACEHOLDER:"Cerca per nome, cognome o RAD...",HELP_TEXT:"Seleziona un paziente per continuare",SELECTED:(e,t)=>`Paziente selezionato: ${e} ${t}`},y=({values:t,onChange:n,hasPatient:i=!0,selectedPatient:a=null,onSelectPatient:o,onPatientSelect:r})=>e.jsx("div",{className:"wizard-step","data-step":"event-type",children:e.jsxs("div",{className:"wizard-step-content",children:[!i&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"wizard-step-title",children:"Seleziona Paziente"}),e.jsxs("div",{className:"mb-4",children:[e.jsx(j,{value:a,onChange:e=>{o&&o(e?.id||""),r&&r(e)},placeholder:w.PLACEHOLDER,activeOnly:!1,maxResults:10,minSearchLength:1,debounceDelay:z.PATIENT_SEARCH,showPatientInfo:!0,highlightMatch:!0}),a&&e.jsxs("div",{className:"alert alert-success mt-3",role:"alert",children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),w.SELECTED(a.cognome,a.nome)]}),!a&&e.jsxs("div",{className:"alert alert-info mt-3",role:"alert",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),w.HELP_TEXT]})]}),!a&&e.jsx("div",{style:{marginBottom:"2rem"}})]}),(i||a)&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"wizard-step-title",children:"Tipo di Evento"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona il tipo di evento clinico da registrare"}),e.jsx("div",{className:"event-type-selection",children:e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"event-type-card "+("intervento"===t.tipo_evento?"selected":""),onClick:()=>n({tipo_evento:"intervento"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n({tipo_evento:"intervento"}))},children:[e.jsx("div",{className:"event-type-card-icon",children:e.jsx("i",{className:"bi bi-heart-pulse"})}),e.jsxs("div",{className:"event-type-card-content",children:[e.jsx("h4",{className:"event-type-card-title",children:"Intervento Chirurgico"}),e.jsx("p",{className:"event-type-card-description",children:"Registra un intervento chirurgico eseguito sul paziente"})]}),e.jsx("div",{className:"event-type-card-radio",children:e.jsx("input",{type:"radio",name:"tipo_evento",value:"intervento",checked:"intervento"===t.tipo_evento,onChange:()=>n({tipo_evento:"intervento"}),className:"form-check-input"})})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"event-type-card "+("infezione"===t.tipo_evento?"selected":""),onClick:()=>n({tipo_evento:"infezione"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n({tipo_evento:"infezione"}))},children:[e.jsx("div",{className:"event-type-card-icon",children:e.jsx("i",{className:"bi bi-virus"})}),e.jsxs("div",{className:"event-type-card-content",children:[e.jsx("h4",{className:"event-type-card-title",children:"Infezione"}),e.jsx("p",{className:"event-type-card-description",children:"Registra un'infezione contratta dal paziente"})]}),e.jsx("div",{className:"event-type-card-radio",children:e.jsx("input",{type:"radio",name:"tipo_evento",value:"infezione",checked:"infezione"===t.tipo_evento,onChange:()=>n({tipo_evento:"infezione"}),className:"form-check-input"})})]})})]})})]})]})}),k=({values:t,onChange:n,errors:i,isSubmitting:a,tipiIntervento:o,agentiPatogeno:r,loadingTypes:s,loadingPatogens:l})=>{const c="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"event-details",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:c?"Dettagli Intervento":"Dettagli Infezione"}),e.jsx("p",{className:"wizard-step-description",children:c?"Specifica il tipo di intervento e la descrizione":"Specifica l'agente patogeno e il tipo"}),e.jsxs(e.Fragment,c?{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"tipo_intervento_id",className:"form-label",children:["Tipo Intervento ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("select",{id:"tipo_intervento_id",name:"tipo_intervento_id",className:"form-select "+(i?.tipo_intervento_id?"is-invalid":""),value:t.tipo_intervento_id?String(t.tipo_intervento_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):void 0;n({tipo_intervento_id:t})},disabled:a||s,required:!0,children:[e.jsx("option",{value:"",children:s?"Caricamento tipi intervento...":"Seleziona tipo intervento..."}),o.map(t=>e.jsx("option",{value:String(t.id),children:t.nome},t.id))]}),i?.tipo_intervento_id&&e.jsx("div",{className:"invalid-feedback",role:"alert",children:i.tipo_intervento_id})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"descrizione_intervento",className:"form-label",children:"Descrizione Dettagliata"}),e.jsx("textarea",{id:"descrizione_intervento",name:"descrizione_intervento",className:"form-control",value:t.descrizione_intervento||"",onChange:e=>n({descrizione_intervento:e.target.value}),disabled:a,rows:S.DESCRIPTION,placeholder:"Descrivere dettagliatamente l'intervento eseguito..."}),e.jsx("div",{className:"form-text",children:"Opzionale - Fornire una descrizione dettagliata della procedura"})]})]}:{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"agente_patogeno_id",className:"form-label",children:["Agente Eziologico ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("select",{id:"agente_patogeno_id",name:"agente_patogeno_id",className:"form-select "+(i?.agente_patogeno_id?"is-invalid":""),value:t.agente_patogeno_id?String(t.agente_patogeno_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):void 0;n({agente_patogeno_id:t})},disabled:a||l,required:!0,children:[e.jsx("option",{value:"",children:l?"Caricamento agenti patogeno...":"Seleziona agente eziologico..."}),r.map(t=>e.jsx("option",{value:String(t.id),children:t.nome},t.id))]}),i?.agente_patogeno_id&&e.jsx("div",{className:"invalid-feedback",role:"alert",children:i.agente_patogeno_id}),e.jsx("div",{className:"form-text",children:"Selezionare l'agente responsabile dell'infezione"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"tipo_patogeno",className:"form-label",children:"Tipo Patogeno"}),e.jsxs("select",{id:"tipo_patogeno",name:"tipo_patogeno",className:"form-select",value:t.tipo_patogeno||"",onChange:e=>n({tipo_patogeno:e.target.value}),disabled:a,children:[e.jsx("option",{value:"",children:"Seleziona tipo patogeno..."}),N.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]}),e.jsx("div",{className:"form-text",children:"Opzionale - Specificare la categoria del patogeno"})]})]})]})})},C=({values:t,onChange:n,errors:i,isSubmitting:a,showResolutionDate:o,setShowResolutionDate:r})=>{const s="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"dates",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Date Evento"}),e.jsx("p",{className:"wizard-step-description",children:s?"Specifica quando è stato eseguito l'intervento":"Specifica le date di inizio e fine dell'infezione"}),s?e.jsx("div",{className:"mb-3",children:e.jsx(v,{label:"Data Intervento",value:t.data_evento||"",onChange:e=>n({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:a,isInvalid:!!i?.data_evento,errorMessage:i?.data_evento})}):e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-12 mb-3",children:e.jsx(v,{label:"Data Inizio",value:t.data_evento||"",onChange:e=>n({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:a,isInvalid:!!i?.data_evento,errorMessage:i?.data_evento})}),e.jsxs("div",{className:"col-12 mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2 gap-2",children:[e.jsx("label",{htmlFor:"toggle_resolution",className:"form-label mb-0",children:"Data Fine"}),e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"toggle_resolution",checked:o,onChange:e=>{r(e.target.checked),e.target.checked||n({data_fine_evento:""})},disabled:a}),e.jsx("label",{className:"form-check-label",htmlFor:"toggle_resolution",children:"Infezione risolta"})]})]}),o&&e.jsx(v,{value:t.data_fine_evento||"",onChange:e=>n({data_fine_evento:e||""}),placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:a,isInvalid:!!i?.data_fine_evento,errorMessage:i?.data_fine_evento})]})]})]})})},E=({values:t,onChange:n,isSubmitting:i})=>{const a="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"notes",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Note Aggiuntive"}),e.jsx("p",{className:"wizard-step-description",children:"Aggiungi informazioni o osservazioni rilevanti (opzionale)"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"note",className:"form-label",children:a?"Note Aggiuntive":"Note Cliniche"}),e.jsx("textarea",{id:"note",name:"note",className:"form-control",value:t.note||"",onChange:e=>n({note:e.target.value}),disabled:i,rows:S.NOTES,placeholder:a?"Note aggiuntive sull'intervento...":"Sintomi, terapia, esami, decorso...","aria-describedby":"note-help"}),e.jsxs("div",{id:"note-help",className:"form-text",children:["Opzionale - ",a?"Informazioni aggiuntive sull'intervento":"Informazioni cliniche rilevanti"]})]})]})})},P=({values:n,tipiIntervento:i,agentiPatogeno:a})=>{const o="intervento"===n.tipo_evento,r=t.useMemo(()=>i.find(e=>e.id===n.tipo_intervento_id)?.nome,[i,n.tipo_intervento_id]),s=t.useMemo(()=>a.find(e=>e.id===n.agente_patogeno_id)?.nome,[a,n.agente_patogeno_id]);return e.jsx("div",{className:"wizard-step","data-step":"review",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Riepilogo"}),e.jsx("p",{className:"wizard-step-description",children:"Verifica i dati inseriti prima di salvare"}),e.jsxs("div",{className:"event-review-summary",children:[e.jsxs("div",{className:"alert alert-light",children:[e.jsx("h5",{className:"alert-heading",children:o?"Intervento Chirurgico":"Infezione"}),e.jsx("hr",{}),e.jsxs(e.Fragment,o?{children:[e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Tipo Intervento:"})," ",e.jsx("span",{children:r||"Non specificato"})]}),n.descrizione_intervento&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Descrizione:"})," ",e.jsx("span",{children:n.descrizione_intervento})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Intervento:"})," ",e.jsx("span",{children:n.data_evento||"Non specificata"})]})]}:{children:[e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Agente Eziologico:"})," ",e.jsx("span",{children:s||"Non specificato"})]}),n.tipo_patogeno&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Tipo Patogeno:"})," ",e.jsx("span",{children:N.find(e=>e.value===n.tipo_patogeno)?.label})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Inizio:"})," ",e.jsx("span",{children:n.data_evento||"Non specificata"})]}),n.data_fine_evento&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Fine:"})," ",e.jsx("span",{children:n.data_fine_evento})]})]}),n.note&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Note:"})," ",e.jsx("span",{children:n.note})]})]}),e.jsxs("div",{className:"alert alert-info",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),"Verifica che tutti i dati siano corretti. Puoi tornare indietro per modificare qualsiasi campo prima di salvare."]})]})]})})},D=["event-type","event-details","dates","notes","review"],I={"event-type":"Tipo Evento","event-details":"Dettagli",dates:"Date",notes:"Note",review:"Riepilogo"},$=({patientId:n,event:l,onSubmit:u,onCancel:v})=>{const x=!!l,_=((e="event-type")=>a({steps:D,labels:I,initialStep:e}))("event-type"),f=o({currentStep:_.currentStep,getStepLabel:_.getStepLabel,totalSteps:_.totalSteps,currentStepNumber:_.getStepNumber(_.currentStep),enabled:!1});r();const{patient:j}=(e=>{const{data:t,isLoading:n,error:i}=h({queryKey:["patient",e],queryFn:async()=>{if(!e)return null;try{const t=await d.getPatientById(e);if(t){const n={id:t.id,nome:t.nome,cognome:t.cognome};return m.info("Patient loaded successfully",{patientId:e}),n}return m.warn("Patient not found",{patientId:e}),b("Paziente non trovato",{duration:3e3}),null}catch(t){const n=t instanceof Error?t:new Error(String(t));throw m.error("Error loading patient data",{patientId:e,error:n}),g("Errore nel caricamento del paziente",{duration:5e3}),n}},enabled:!!e,staleTime:3e5});return{patient:t||null,loading:n,error:i instanceof Error?i:null}})(n),{tipiIntervento:N,agentiPatogeno:S,loading:z}=(()=>{const{data:e,isLoading:n,error:i}=h({queryKey:["eventLookupTables"],queryFn:async()=>{try{const[e,t]=await Promise.all([c.getListaTipiIntervento(),c.getListaAgentiPatogeno()]);return m.info("Event lookup tables loaded successfully",{tipiCount:e.length,agentiCount:t.length}),{tipi:e,agenti:t}}catch(e){const t=e instanceof Error?e:new Error(String(e));throw m.error("Error loading event lookup tables",{error:t}),g("Impossibile caricare i dati. Riprova più tardi.",{duration:5e3}),t}},staleTime:6e5}),a=e?.tipi||[],o=e?.agenti||[],r=t.useMemo(()=>new Map(a.map(e=>[e.id,e.nome])),[a]),s=t.useMemo(()=>new Map(o.map(e=>[e.id,e.nome])),[o]);return{tipiIntervento:a,agentiPatogeno:o,loading:n,error:i instanceof Error?i:null,tipiInterventoMap:r,agentiPatogeniMap:s}})(),[w,$]=t.useState(n||""),[T,R]=t.useState(j),[L,A]=t.useState({paziente_id:w,tipo_evento:l?.tipo_evento||"intervento",data_evento:l?.data_evento||"",tipo_intervento_id:l?.tipo_intervento_id??void 0,descrizione_intervento:l?.descrizione_intervento||"",agente_patogeno_id:l?.agente_patogeno_id??void 0,tipo_patogeno:l?.tipo_patogeno??void 0,data_fine_evento:l?.data_fine_evento||"",note:l?.note||""}),[O,q]=t.useState(!!l?.data_fine_evento),[F,M]=t.useState({}),[K,H]=t.useState(!1);i.useEffect(()=>{j&&R(j)},[j]);const V=e=>{$(e),A(t=>({...t,paziente_id:e}))},B=e=>{R(e)},U=e=>{A(t=>({...t,...e}));const t=Object.keys(e);t.some(e=>F[e])&&M(e=>{const n={...e};return t.forEach(e=>delete n[e]),n})},W=()=>{switch(_.currentStep){case"event-type":return!!w&&!!L.tipo_evento;case"event-details":return"intervento"===L.tipo_evento?!!L.tipo_intervento_id:"infezione"===L.tipo_evento&&!!L.agente_patogeno_id;case"dates":return!!L.data_evento;case"notes":case"review":return!0;default:return!1}};return e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),!(()=>{const e={};if(!w)return e.paziente_id="Seleziona un paziente",M(e),!1;if(L.tipo_evento||(e.tipo_evento="Seleziona il tipo di evento"),"intervento"===L.tipo_evento&&(L.tipo_intervento_id||(e.tipo_intervento_id="Il tipo di intervento è obbligatorio"),L.data_evento||(e.data_evento="La data dell'intervento è obbligatoria")),"infezione"===L.tipo_evento){L.agente_patogeno_id||(e.agente_patogeno_id="Il tipo di batterio è obbligatorio"),L.data_evento||(e.data_evento="La data di inizio infezione è obbligatoria");const t=p(L.data_evento,O?L.data_fine_evento:void 0,"infezione");t&&(e.data_evento=t)}if("intervento"===L.tipo_evento){L.data_evento||(e.data_evento="La data dell'intervento è obbligatoria");const t=p(L.data_evento,void 0,"intervento");t&&(e.data_evento=t)}return M(e),0===Object.keys(e).length})())return _.goToStep("event-type"),void 0;try{H(!0);const e={paziente_id:w,tipo_evento:L.tipo_evento,data_evento:L.data_evento,note:L.note};"intervento"===L.tipo_evento&&(e.tipo_intervento_id=L.tipo_intervento_id,e.descrizione_intervento=L.descrizione_intervento),"infezione"===L.tipo_evento&&(e.agente_patogeno_id=L.agente_patogeno_id,e.tipo_patogeno=L.tipo_patogeno,O&&(e.data_fine_evento=L.data_fine_evento)),await u(e)}catch(t){m.error("Errore durante il salvataggio del evento",{error:t}),g("Errore durante il salvataggio. Riprova più tardi.",{duration:5e3}),H(!1)}},className:"wizard-form event-wizard-form",noValidate:!0,children:[e.jsxs("div",{className:"wizard-form-header",children:[e.jsx("button",{type:"button",className:"wizard-back-button",onClick:v,disabled:K,"aria-label":"Torna indietro",children:e.jsx("i",{className:"bi bi-arrow-left"})}),e.jsx("h1",{className:"wizard-form-title",children:x?"Modifica Evento":"Nuovo Evento"})]}),e.jsx(s,{currentStep:_.currentStep,getStepLabel:_.getStepLabel,getStepNumber:_.getStepNumber,totalSteps:_.totalSteps,stepOrder:D,themeColor:"clinical",extraInfo:T&&_.getStepNumber(_.currentStep)>1?e.jsxs("div",{className:"wizard-patient-info",children:[e.jsx("small",{className:"text-muted",children:"Paziente:"}),e.jsxs("strong",{children:[T.cognome," ",T.nome]})]}):null}),e.jsx("div",{ref:f,className:"wizard-form-content",children:(()=>{const t=!!w,n={values:L,onChange:U,errors:F,isSubmitting:K};switch(_.currentStep){case"event-type":return e.jsx(y,{...n,hasPatient:t,selectedPatient:T,onSelectPatient:V,onPatientSelect:B});case"event-details":return e.jsx(k,{...n,tipiIntervento:N,agentiPatogeno:S,loadingTypes:z,loadingPatogens:z});case"dates":return e.jsx(C,{...n,showResolutionDate:O,setShowResolutionDate:q});case"notes":return e.jsx(E,{...n});case"review":return e.jsx(P,{...n,tipiIntervento:N,agentiPatogeno:S,loadingTypes:z,loadingPatogens:z});default:return null}})()}),e.jsxs("div",{className:"wizard-form-actions",children:[_.canGoPrev&&e.jsxs("button",{type:"button",className:"btn btn-secondary btn-block",onClick:_.prevStep,disabled:K,children:[e.jsx("i",{className:"bi bi-chevron-left"})," Indietro"]}),"review"!==_.currentStep?e.jsxs("button",{type:"button",className:"btn btn-primary btn-block",onClick:_.nextStep,disabled:K||!W(),title:W()?void 0:"Completa i campi obbligatori per continuare",children:["Avanti ",e.jsx("i",{className:"bi bi-chevron-right"})]}):e.jsx("button",{type:"submit",className:"btn btn-success btn-block",disabled:K,children:e.jsxs(e.Fragment,K?{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio..."]}:{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),x?"Aggiorna Evento":"Salva Evento"]})})]})]})};export{$ as E,j as P};
