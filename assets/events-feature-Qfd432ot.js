import{l as e,n as t,a,s as i,b as n}from"./core-services-qaelRMFP.js";import{r as s,j as o,R as r}from"./auth-feature-BcTinZZO.js";import{e as l,B as c,C as d,D as v,u as p,f as m,g as h,v as u,h as g}from"./shared-CpQNZA6K.js";import{u as _,a as f}from"./react-vendor-DjwQKAdz.js";import{P as x,u as b}from"./patients-feature-CNIQB4Vx.js";import{u as j,a as N,b as z}from"./charts-feature-CXI6mK00.js";const y=new class{cache=new Map;cacheTimeout=3e5;stats={hits:0,misses:0,entries:0,lastCleanup:Date.now()};cleanupInterval=null;constructor(e=3e5){this.cacheTimeout=e,this.startAutoCleanup()}generateCacheKey(e={},t={}){const a={filters:{paziente_search:e.paziente_search?.trim()||"",paziente_id:e.paziente_id||"",tipo_evento:e.tipo_evento||"",data_inizio:e.data_inizio||"",data_fine:e.data_fine||""},pagination:{page:t.page??0,limit:t.limit??10,sortColumn:t.sortColumn||"data_evento",sortDirection:t.sortDirection||"desc"}};return`search_${JSON.stringify(a)}`}get(t={},a={}){const i=this.generateCacheKey(t,a),n=this.cache.get(i);if(n){if(!(Date.now()-n.timestamp>this.cacheTimeout))return this.stats.hits++,e.debug(`Cache HIT: ${i.substring(0,50)}... (TTL: ${(this.cacheTimeout-(Date.now()-n.timestamp))/1e3}s remaining)`),n.result;this.cache.delete(i),e.debug(`Cache EXPIRED: ${i.substring(0,50)}...`)}return this.stats.misses++,null}set(t={},a={},i){const n=this.generateCacheKey(t,a);this.cache.set(n,{result:i,timestamp:Date.now()}),this.stats.entries=this.cache.size,e.debug(`Cache SET: ${n.substring(0,50)}... (${i.totalCount} events)`)}has(e={},t={}){return null!==this.get(e,t)}invalidatePatient(t){let a=0;for(const[e]of this.cache.entries())e.includes(`"paziente_id":"${t}"`)&&(this.cache.delete(e),a++);a>0&&(this.stats.entries=this.cache.size,e.debug(`Cache INVALIDATED: ${a} entries for patient ${t}`))}invalidateEventType(t){let a=0;for(const[e]of this.cache.entries())e.includes(`"tipo_evento":"${t}"`)&&(this.cache.delete(e),a++);a>0&&(this.stats.entries=this.cache.size,e.debug(`Cache INVALIDATED: ${a} entries for event type ${t}`))}invalidateDateRange(t,a){let i=0;for(const[e]of this.cache.entries())e.includes('"data_')&&(this.cache.delete(e),i++);i>0&&(this.stats.entries=this.cache.size,e.debug(`Cache INVALIDATED: ${i} entries for date range ${t} to ${a}`))}clear(){const t=this.cache.size;this.cache.clear(),this.stats={hits:0,misses:0,entries:0,lastCleanup:Date.now()},e.debug(`Cache CLEARED: ${t} entries removed`)}cleanup(){const t=Date.now();let a=0;for(const[e,i]of this.cache.entries())t-i.timestamp>this.cacheTimeout&&(this.cache.delete(e),a++);this.stats.entries=this.cache.size,this.stats.lastCleanup=t,a>0&&e.debug(`Cache CLEANUP: ${a} expired entries removed`)}startAutoCleanup(){this.cleanupInterval&&clearInterval(this.cleanupInterval),this.cleanupInterval=setInterval(()=>this.cleanup(),6e4)}stopAutoCleanup(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}getStats(){const e=this.stats.hits+this.stats.misses;return{...this.stats,hitRate:Number((e>0?this.stats.hits/e*100:0).toFixed(2))}}setCacheTimeout(t){this.cacheTimeout=Math.max(0,t),e.debug(`Cache timeout set to ${t}ms`)}getCacheTimeout(){return this.cacheTimeout}getCacheKeys(){return Array.from(this.cache.keys()).map(e=>e.substring(0,80)+"...")}getDebugInfo(){return{totalEntries:this.cache.size,cacheTimeout:this.cacheTimeout,stats:this.getStats(),keys:this.getCacheKeys().slice(0,10),memoryUsage:`~${(JSON.stringify(Array.from(this.cache.entries())).length/1024).toFixed(2)}KB`}}};const w=new class{rules=new Map;stats={totalInvalidations:0,selectiveInvalidations:0,fullInvalidations:0,rulesApplied:0,cacheEntriesCleared:0,lastInvalidation:0};constructor(){this.initializeDefaultRules()}initializeDefaultRules(){this.addRule({id:"intervention-events",name:"Intervention Events",description:"Invalidates cache entries related to surgical interventions",eventType:"intervento",affects:["search:*tipo_evento:intervento*","search:*:*","events-paziente_*"],dependencies:[],priority:10}),this.addRule({id:"infection-events",name:"Infection Events",description:"Invalidates cache entries related to infections",eventType:"infezione",affects:["search:*tipo_evento:infezione*","search:*:*","events-paziente_*","patient-infection-status_*"],dependencies:[],priority:10}),this.addRule({id:"patient-data-changes",name:"Patient Data Changes",description:"Invalidates all cache entries when patient data changes",eventType:"patient-update",affects:["search:*:*","events-paziente_*","patient-search_*"],dependencies:[],priority:20}),this.addRule({id:"new-event-statistics",name:"New Event Statistics",description:"Invalidates statistics cache when new events are added",eventType:"create",affects:["event-stats_*","suggested-filters_*"],dependencies:[],priority:5}),e.debug("Initialized default cache invalidation rules")}addRule(t){this.rules.set(t.id,t),e.debug(`Added cache invalidation rule: ${t.name}`)}removeRule(t){const a=this.rules.delete(t);return a&&e.debug(`Removed cache invalidation rule: ${t}`),a}getRules(){return Array.from(this.rules.values())}invalidateCache(t,a,i={}){const n=Date.now();if(this.stats.totalInvalidations++,i.forceFullInvalidation){const t=this.performFullInvalidation();return this.stats.fullInvalidations++,this.stats.lastInvalidation=Date.now(),e.debug(`Performed full cache invalidation in ${Date.now()-n}ms`),{invalidated:!0,entriesCleared:t,rulesApplied:0,strategy:"full"}}const s=this.findApplicableRules(t,a);if(0===s.length)return e.debug(`No applicable invalidation rules for event type: ${t}`),{invalidated:!1,entriesCleared:0,rulesApplied:0,strategy:"none"};s.sort((e,t)=>t.priority-e.priority);const o=new Set;let r=0;for(const e of s)e.condition&&!e.condition(a)||(e.affects.forEach(e=>{this.getCacheKeysByPattern(e,i.patientId).forEach(e=>o.add(e))}),r++,this.stats.rulesApplied++);if(0===o.size)return e.debug("No cache entries would be affected by invalidation rules"),{invalidated:!1,entriesCleared:0,rulesApplied:r,strategy:"none"};const l=this.performSelectiveInvalidation(Array.from(o));return this.stats.selectiveInvalidations++,this.stats.cacheEntriesCleared+=l,this.stats.lastInvalidation=Date.now(),e.debug(`Performed selective cache invalidation in ${Date.now()-n}ms: ${l} entries cleared, ${r} rules applied`),{invalidated:!0,entriesCleared:l,rulesApplied:r,strategy:"selective"}}findApplicableRules(e,t){const a=[];for(const i of this.rules.values())i.eventType!==e?i.dependencies.includes(e)&&a.push(i):a.push(i);return a}getCacheKeysByPattern(e,t){const a=[];if("search:*:*"===e)a.push(...y.getCacheKeys());else if(e.startsWith("search:")){const t=e.replace("search:","");a.push(...y.getCacheKeys().filter(e=>e.includes(t)))}else e.startsWith("events-paziente_")?t&&a.push(`events-paziente_${t}`):e.startsWith("patient-infection-status_")&&t&&a.push(`patient-infection-status_${t}`);return a}performSelectiveInvalidation(e){let t=0;for(const a of e)a.startsWith("search_")?(y.clear(),t++):(a.startsWith("events-paziente_")||a.startsWith("patient-infection-status_"))&&t++;return t}performFullInvalidation(){return y.clear(),1}getStats(){const e=this.stats.totalInvalidations,t=this.stats.totalInvalidations>0?this.stats.rulesApplied/this.stats.totalInvalidations:0;return{...this.stats,selectiveRate:Number((e>0?this.stats.selectiveInvalidations/e*100:0).toFixed(2)),averageRulesPerInvalidation:Number(t.toFixed(2))}}resetStats(){this.stats={totalInvalidations:0,selectiveInvalidations:0,fullInvalidations:0,rulesApplied:0,cacheEntriesCleared:0,lastInvalidation:0},e.debug("Cache invalidation statistics reset")}getDebugInfo(){return{totalRules:this.rules.size,rules:Array.from(this.rules.values()).map(e=>({id:e.id,name:e.name,eventType:e.eventType,affectsCount:e.affects.length,priority:e.priority})),stats:this.getStats()}}};const I=new class{async handle(a,i){e.error(`Error ${i}:`,a);const n={JWT:"Sessione scaduta. Effettua nuovamente l'accesso.",network:"Impossibile connettersi al server.",fetch:"Impossibile connettersi al server.",duplicate:"Questo evento esiste gi√†.","foreign key":"Paziente non trovato.",23503:"Paziente non trovato."};for(const[e,s]of Object.entries(n))if(a.message?.includes(e))return t(s),void 0;t(`Errore ${i}: ${a.message}`)}};const C=new class{validateEvento(e){const t={};if(e.paziente_id||(t.paziente_id="Paziente obbligatorio"),e.tipo_evento||(t.tipo_evento="Tipo evento obbligatorio"),e.data_evento||(t.data_evento="Data evento obbligatoria"),e.data_evento){const a=new Date(e.data_evento),i=new Date;i.setHours(23,59,59,999),isNaN(a.getTime())?t.data_evento="Data non valida":a>i&&(t.data_evento="La data non pu√≤ essere nel futuro")}return"intervento"===e.tipo_evento&&(e.tipo_intervento_id||(t.tipo_intervento="Specialistica obbligatoria per interventi")),"infezione"===e.tipo_evento&&(e.agente_patogeno_id||e.tipo_patogeno||(t.tipo_batterio="Specificare agente patogeno")),{isValid:0===Object.keys(t).length,errors:t}}};const S=new class{async createEvento(e){try{a.getState().setLoading(!0);const t=C.validateEvento(e);if(!t.isValid){const e=Object.values(t.errors).join(", ");throw new Error(e)}const s={paziente_id:e.paziente_id,tipo_evento:e.tipo_evento,data_evento:e.data_evento};"intervento"===e.tipo_evento&&(e.tipo_intervento_id&&(s.tipo_intervento_id=e.tipo_intervento_id),s.descrizione=e.descrizione_intervento||e.note||null),"infezione"===e.tipo_evento&&(e.agente_patogeno_id&&(s.agente_patogeno_id=e.agente_patogeno_id),s.descrizione=e.note||null,e.tipo_patogeno&&(s.tipo_patogeno=e.tipo_patogeno),e.data_fine_evento&&(s.data_fine_evento=e.data_fine_evento));const{data:o,error:r}=await i.from("eventi_clinici").insert([s]).select().single();if(r)throw r;return"infezione"===e.tipo_evento&&await this._updatePazienteInfezioneStatus(e.paziente_id),this.invalidateCache(),n("Evento creato con successo!"),o}catch(t){throw await I.handle(t,"creazione evento"),t}finally{a.getState().setLoading(!1)}}async updateEvento(t,s){try{a.getState().setLoading(!0);const o=C.validateEvento(s);if(!o.isValid){const e=Object.values(o.errors).join(", ");throw new Error(e)}const r={data_evento:s.data_evento};"intervento"===s.tipo_evento&&(r.descrizione=s.descrizione_intervento||s.note||null,null!=s.tipo_intervento_id&&(r.tipo_intervento_id=s.tipo_intervento_id)),"infezione"===s.tipo_evento&&(r.descrizione=s.note||null,null!=s.agente_patogeno_id&&(r.agente_patogeno_id=s.agente_patogeno_id),s.tipo_patogeno&&(r.tipo_patogeno=s.tipo_patogeno),s.data_fine_evento&&(r.data_fine_evento=s.data_fine_evento)),e.info("Updating event:",{id:t,dataToUpdate:r});const{data:l,error:c}=await i.from("eventi_clinici").update(r).eq("id",t).select().single();if(c)throw e.error("Supabase update error:",{error:c,dataToUpdate:r}),c;return"infezione"===s.tipo_evento&&await this._updatePazienteInfezioneStatus(s.paziente_id),this.invalidateCache(),n("Evento aggiornato con successo!"),l}catch(o){throw await I.handle(o,"aggiornamento evento"),o}finally{a.getState().setLoading(!1)}}async deleteEvento(e){try{a.getState().setLoading(!0);const{data:t,error:s}=await i.from("eventi_clinici").select("paziente_id, tipo_evento").eq("id",e).single();if(s&&"PGRST116"!==s.code)throw s;const{error:o}=await i.from("eventi_clinici").delete().eq("id",e);if(o)throw o;t&&"infezione"===t.tipo_evento&&await this._updatePazienteInfezioneStatus(t.paziente_id),this.invalidateCache(),n("Evento eliminato con successo!")}catch(t){throw await I.handle(t,"eliminazione evento"),t}finally{a.getState().setLoading(!1)}}async resolveInfezione(e,t){try{a.getState().setLoading(!0);const{data:s,error:o}=await i.from("eventi_clinici").select("data_evento, paziente_id").eq("id",e).eq("tipo_evento","infezione").single();if(o)throw o;const r=new Date(s.data_evento);if(new Date(t)<r)throw new Error("La data di risoluzione non pu√≤ essere precedente alla data dell'infezione");const{data:l,error:c}=await i.from("eventi_clinici").update({data_fine_evento:t}).eq("id",e).select().single();if(c)throw c;return await this._updatePazienteInfezioneStatus(s.paziente_id),this.invalidateCache(),n("Infezione risolta con successo!"),l}catch(s){throw await I.handle(s,"risoluzione infezione"),s}finally{a.getState().setLoading(!1)}}invalidateCache(){y.clear()}invalidateSelectiveCache(e,t){e?w.invalidateCache(e,{},{patientId:t}):this.invalidateCache()}async _updatePazienteInfezioneStatus(t){try{const{data:a,error:n}=await i.from("eventi_clinici").select("id, data_evento").eq("paziente_id",t).eq("tipo_evento","infezione").is("data_fine_evento",null).order("data_evento",{ascending:!1}).limit(1);if(n)throw n;const s=a&&a.length>0,{error:o}=await i.from("pazienti").update({infetto:s,data_infezione:s?a[0].data_evento:null}).eq("id",t);o&&e.error("Supabase patient update error:",o)}catch(a){e.error("Error updating patient infection status:",a)}}};const D=new class{async getListaTipiIntervento(){try{const{data:e,error:t}=await i.from("tipi_intervento").select("id, nome, descrizione").eq("attivo",!0).order("nome",{ascending:!0});if(t)throw t;return e||[]}catch(t){return e.error("Error loading surgery types:",t),[]}}async getListaAgentiPatogeno(){try{const{data:e,error:t}=await i.from("agenti_patogeno").select("id, nome, descrizione").eq("attivo",!0).order("nome",{ascending:!0});if(t)throw t;return e||[]}catch(t){return e.error("Error loading pathogenic agents:",t),[]}}};const E=new class{requests=new Map;defaultTimeout=3e4;stats={total:0,duplicates:0,cancelled:0,completed:0,timedOut:0,active:0};cleanupInterval=null;constructor(e=3e4){this.defaultTimeout=e,this.startAutoCleanup()}generateRequestSignature(e,t={}){const a={method:t.method||"GET",...t.body&&{body:t.body},...t.params&&{params:t.params},...t.headers&&{headers:Object.fromEntries(Object.entries(t.headers).filter(([e])=>!e.toLowerCase().includes("auth")).sort(([e],[t])=>e.localeCompare(t)))}};return`${e}:${JSON.stringify(a)}`}async executeRequest(t,a,i={},n=this.defaultTimeout){const s=this.generateRequestSignature(t,i),o=this.requests.get(s);if(o)return this.stats.duplicates++,e.debug(`Request DUPLICATE: ${s.substring(0,50)}... (returning existing promise)`),o.promise;const r=new AbortController,l=setTimeout(()=>{r.signal.aborted||(r.abort(),this.stats.timedOut++,e.debug(`Request TIMEOUT: ${s.substring(0,50)}...`))},n),c=a(r.signal).then(e=>(this.cleanupRequest(s),this.stats.completed++,e)).catch(t=>{throw this.cleanupRequest(s),"AbortError"!==t.name&&e.error(`Request FAILED: ${s.substring(0,50)}...`,t),t});return this.requests.set(s,{controller:r,promise:c,timestamp:Date.now(),timeout:l}),this.stats.total++,this.stats.active++,e.debug(`Request STARTED: ${s.substring(0,50)}... (active: ${this.stats.active})`),c}cancelRequest(t){const a=this.requests.get(t);return!(!a||a.controller.signal.aborted)&&(a.controller.abort(),this.cleanupRequest(t),this.stats.cancelled++,e.debug(`Request CANCELLED: ${t.substring(0,50)}...`),!0)}cancelAllRequests(){let t=0;for(const[e]of this.requests.entries())this.cancelRequest(e)&&t++;return e.debug(`Cancelled ${t} active requests`),t}cancelRequestsMatching(t){let a=0;const i="string"==typeof t?new RegExp(t):t;for(const[e]of this.requests.entries())i.test(e)&&this.cancelRequest(e)&&a++;return a>0&&e.debug(`Cancelled ${a} requests matching pattern`),a}getStats(){const e=this.stats.total,t=e>0?this.stats.cancelled/e*100:0;return{...this.stats,duplicateRate:Number((e>0?this.stats.duplicates/e*100:0).toFixed(2)),cancellationRate:Number(t.toFixed(2))}}getActiveRequests(){const e=Date.now();return Array.from(this.requests.entries()).map(([t,a])=>({signature:t.substring(0,80)+"...",timestamp:a.timestamp,age:e-a.timestamp}))}cleanupRequest(e){const t=this.requests.get(e);t&&(t.timeout&&clearTimeout(t.timeout),this.requests.delete(e),this.stats.active=Math.max(0,this.stats.active-1))}cleanup(){const t=Date.now();let a=0;for(const[e,i]of this.requests.entries()){(t-i.timestamp>3e5||i.controller.signal.aborted)&&(this.cleanupRequest(e),a++)}a>0&&e.debug(`Request cleanup: ${a} old requests removed`)}startAutoCleanup(){this.cleanupInterval&&clearInterval(this.cleanupInterval),this.cleanupInterval=setInterval(()=>this.cleanup(),6e4)}stopAutoCleanup(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}resetStats(){this.stats={total:0,duplicates:0,cancelled:0,completed:0,timedOut:0,active:this.requests.size},e.debug("Request statistics reset")}getDebugInfo(){return{activeRequests:this.requests.size,stats:this.getStats(),activeRequestsList:this.getActiveRequests().slice(0,10),memoryUsage:`~${(JSON.stringify(Array.from(this.requests.entries())).length/1024).toFixed(2)}KB`}}};const k=new class{async getAllEventi(e={},t={}){const n=`getAllEventi:${JSON.stringify({filters:e,pagination:t})}`;return E.executeRequest(n,async n=>{try{a.getState().setLoading(!0);const{tipo_evento:n=[],paziente_id:s,paziente_search:o,data_inizio:r,data_fine:l,reparto:c}=e,{page:d=1,limit:v=20,sortColumn:p="data_evento",sortDirection:m="desc"}=t,h="number"==typeof v&&Number.isFinite(v)&&v>0?v:20,u="number"==typeof d&&Number.isFinite(d)&&d>0?d:1;let g=u-1;const _=y.get(e,t);if(_)return _;let f=null;if(o?.trim()&&(f=await this._getPazientiIdsForSearch(o),0===f.length))return this._emptyResult(u);const x=e=>{const t={count:"exact",head:e?.head??!1};let a=i.from("eventi_clinici").select("\n              *,\n              pazienti!inner(\n                id,\n                nome,\n                cognome,\n                codice_rad,\n                reparto_appartenenza,\n                data_dimissione\n              )\n            ",t);return s?a=a.eq("paziente_id",s):f&&(a=a.in("paziente_id",f)),n&&n.length>0&&(a=a.in("tipo_evento",n)),r&&(a=a.gte("data_evento",r)),l&&(a=a.lte("data_evento",l)),c&&(a=a.eq("pazienti.reparto_appartenenza",c)),a};let b=null;if(g>0){const{count:e,error:t}=await x({head:!0});if(t)throw t;b=e??0;const a=b>0?Math.max(0,Math.ceil(b/h)-1):0;g>a&&(g=a)}let j=x();const N=g*h,z=N+h-1;j=j.order(p,{ascending:"asc"===m}).range(N,z);const{data:w,error:I,count:C}=await j;if(I&&"PGRST116"===I.code)return this._emptyResult(g+1);if(I)throw I;const S=b??C??0,D=S>0?Math.ceil(S/h):0,E={eventi:w||[],totalCount:S,currentPage:g+1,totalPages:D,hasNextPage:S>0&&g<D-1,hasPrevPage:g>0};return y.set(e,t,E),E}catch(s){throw await I.handle(s,"loading events"),s}finally{a.getState().setLoading(!1)}},{method:"GET"},3e4)}async getEventiByPaziente(e,t={}){try{let a=i.from("eventi_clinici").select("*").eq("paziente_id",e).order("data_evento",{ascending:!1});t.tipo_evento&&t.tipo_evento.length>0&&(a=a.in("tipo_evento",t.tipo_evento));const{data:n,error:s}=await a;if(s)throw s;return n||[]}catch(a){throw await I.handle(a,"loading patient events"),a}}async searchPazienti(t,a=!0){if(!t?.trim())return[];try{const e=`%${t.trim()}%`;let n=i.from("pazienti").select("id, nome, cognome, codice_rad, reparto_appartenenza, data_dimissione").or(`nome.ilike.${e},cognome.ilike.${e},codice_rad.ilike.${e}`).order("cognome").limit(10);a&&(n=n.is("data_dimissione",null));const{data:s,error:o}=await n;if(o)throw o;return s||[]}catch(n){return e.error("Error searching patients:",n),[]}}async getGiorniPostOperatori(t,a=null){try{const{data:e,error:n}=await i.from("eventi_clinici").select("data_evento, tipo_intervento, descrizione").eq("paziente_id",t).eq("tipo_evento","intervento").order("data_evento",{ascending:!1}).limit(1);if(n)throw n;if(!e||0===e.length)return{giorni:null,ultimoIntervento:null};const s=e[0],o=a?new Date(a):new Date,r=new Date(s.data_evento),l=Math.abs(o.getTime()-r.getTime());return{giorni:Math.ceil(l/864e5),ultimoIntervento:{data:s.data_evento,tipo:s.tipo_intervento||"",descrizione:s.descrizione||void 0}}}catch(n){return e.error("Error calculating post-operative days:",n),{giorni:null,ultimoIntervento:null}}}async _getPazientiIdsForSearch(t){try{const e=`%${t.trim()}%`,{data:a,error:n}=await i.from("pazienti").select("id").or(`nome.ilike.${e},cognome.ilike.${e},codice_rad.ilike.${e}`);if(n)throw n;return a?.map(e=>e.id)||[]}catch(a){return e.error("Error searching patient IDs:",a),[]}}_emptyResult(e){return{eventi:[],totalCount:0,currentPage:e,totalPages:0,hasNextPage:!1,hasPrevPage:!1}}};const P=new class{async getEventiStats(){try{const{data:e,error:t}=await i.from("eventi_clinici").select("tipo_evento, data_evento, pazienti!inner(id)");if(t)throw t;const a=e||[],n={total:a.length,interventi:a.filter(e=>"intervento"===e.tipo_evento).length,infezioni:a.filter(e=>"infezione"===e.tipo_evento).length,ultimoMese:0},s=new Date;return s.setMonth(s.getMonth()-1),n.ultimoMese=a.filter(e=>new Date(e.data_evento)>=s).length,n}catch(t){throw e.error("Error loading event statistics:",t),t}}};const T=new class{async getAllEventi(e={},t={}){return k.getAllEventi(e,t)}async getEventiByPaziente(e,t){return k.getEventiByPaziente(e,t)}async searchPazienti(e,t){return k.searchPazienti(e,t)}async getGiorniPostOperatori(e,t){return k.getGiorniPostOperatori(e,t)}async createEvento(e){return S.createEvento(e)}async updateEvento(e,t){return S.updateEvento(e,t)}async deleteEvento(e){return S.deleteEvento(e)}async resolveInfezione(e,t){return S.resolveInfezione(e,t)}async getListaTipiIntervento(){return D.getListaTipiIntervento()}async getListaAgentiPatogeno(){return D.getListaAgentiPatogeno()}async getEventiStats(){return P.getEventiStats()}invalidateCache(){S.invalidateCache()}invalidateSelectiveCache(e,t){S.invalidateSelectiveCache(e,t)}};function A(e){if(!e)return"";if("string"==typeof e&&/^\d{4}-\d{2}-\d{2}/.test(e))return e.split("T")[0];const t="string"==typeof e?new Date(e):e;if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const R=[{value:"batterico",label:"Batterico"},{value:"virale",label:"Virale"},{value:"fungino",label:"Fungino"},{value:"parassitario",label:"Parassitario"}],F=({event:e,patientId:t,onSubmit:a,onCancel:i,isSubmitting:n=!1})=>{const r=!!e,c=!!e?.data_fine_evento,[d,v]=s.useState([]),[p,m]=s.useState(!0),[h,u]=s.useState({tipo_evento:"infezione",agente_patogeno_id:e?.agente_patogeno_id??null,tipo_patogeno:e?.tipo_patogeno||"",data_evento:A(e?.data_evento)||"",data_fine_evento:A(e?.data_fine_evento||void 0)||"",note:e?.note||""}),[g,_]=s.useState(c),[f,x]=s.useState({}),b=(new Date).toISOString().split("T")[0];s.useEffect(()=>{(async()=>{try{m(!0);const e=await T.getListaAgentiPatogeno();v(Array.isArray(e)?e:[])}catch(e){console.error("Errore caricamento agenti patogeno:",e)}finally{m(!1)}})()},[]),s.useEffect(()=>{e&&(u({tipo_evento:"infezione",agente_patogeno_id:e.agente_patogeno_id??null,tipo_patogeno:e.tipo_patogeno||"",data_evento:A(e.data_evento),data_fine_evento:A(e.data_fine_evento||void 0)||"",note:e.note||""}),_(!!e.data_fine_evento))},[e]);const j=e=>{const{name:t,value:a}=e.target;u(e=>({...e,[t]:a})),f[t]&&x(e=>{const a={...e};return delete a[t],a})};return o.jsxs("form",{role:"form",onSubmit:async e=>{if(e.preventDefault(),(()=>{const e={};return h.agente_patogeno_id||(e.tipo_batterio="Il tipo di batterio √® obbligatorio"),h.data_evento||(e.data_evento="La data di inizio infezione √® obbligatoria"),g&&h.data_fine_evento&&(h.data_fine_evento<h.data_evento&&(e.data_fine_evento="La data di fine non pu√≤ essere precedente alla data di inizio"),h.data_fine_evento>b&&(e.data_fine_evento="La data di fine non pu√≤ essere futura")),x(e),0===Object.keys(e).length})())try{const e={paziente_id:t,tipo_evento:"infezione",data_evento:h.data_evento,agente_patogeno_id:h.agente_patogeno_id??void 0,tipo_patogeno:h.tipo_patogeno,data_fine_evento:g?h.data_fine_evento:void 0,note:h.note};await a(e)}catch(i){console.error("Errore durante il salvataggio dell'infezione:",i)}},className:"infection-form",noValidate:!0,children:[o.jsxs("div",{className:"row mb-3",children:[o.jsx("div",{className:"col-md-6",children:o.jsx("h4",{className:"mb-3",children:r?"Modifica Infezione":"Nuova Infezione"})}),o.jsx("div",{className:"col-md-6 text-end",children:o.jsx("span",{className:`badge ${c?"bg-success":"bg-warning"} fs-6`,children:c?"Infezione Risolta":"Infezione Attiva"})})]}),o.jsxs("div",{className:"mb-3",children:[o.jsxs("label",{htmlFor:"agente_patogeno_id",className:"form-label",children:["Agente Eziologico ",o.jsx("span",{className:"text-danger",children:"*"})]}),o.jsxs("select",{id:"agente_patogeno_id",name:"agente_patogeno_id",className:"form-select "+(f.tipo_batterio?"is-invalid":""),value:h.agente_patogeno_id?String(h.agente_patogeno_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):null;u(e=>({...e,agente_patogeno_id:t})),f.tipo_batterio&&x(e=>{const t={...e};return delete t.tipo_batterio,t})},disabled:n||p,required:!0,"aria-required":"true","aria-invalid":!!f.tipo_batterio,"aria-describedby":f.tipo_batterio?"agente_patogeno-error":"agente_patogeno-help",children:[o.jsx("option",{value:"",children:p?"Caricamento agenti patogeno...":"Seleziona agente eziologico..."}),d.map(e=>o.jsx("option",{value:String(e.id),children:e.nome},e.id))]}),f.tipo_batterio&&o.jsx("div",{id:"agente_patogeno-error",className:"invalid-feedback",role:"alert",children:f.tipo_batterio}),o.jsx("div",{id:"agente_patogeno-help",className:"form-text",children:"Selezionare l'agente responsabile dell'infezione"})]}),o.jsxs("div",{className:"mb-3",children:[o.jsx("label",{htmlFor:"tipo_patogeno",className:"form-label",children:"Tipo Patogeno"}),o.jsxs("select",{id:"tipo_patogeno",name:"tipo_patogeno",className:"form-select",value:h.tipo_patogeno,onChange:j,disabled:n,"aria-describedby":"tipo_patogeno-help",children:[o.jsx("option",{value:"",children:"Seleziona tipo patogeno..."}),R.map(e=>o.jsx("option",{value:e.value,children:e.label},e.value))]}),o.jsx("div",{id:"tipo_patogeno-help",className:"form-text",children:"Opzionale - Specificare la categoria del patogeno"})]}),o.jsxs("div",{className:"row mb-3",children:[o.jsx("div",{className:"col-md-6",children:o.jsx(l,{label:"Data Inizio",value:h.data_evento,onChange:e=>{u(t=>({...t,data_evento:e||""})),f.data_evento&&x(e=>{const t={...e};return delete t.data_evento,t})},isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:n,isInvalid:!!f.data_evento,errorMessage:f.data_evento})}),o.jsxs("div",{className:"col-md-6",children:[o.jsxs("div",{className:"d-flex align-items-center mb-2 gap-2",children:[o.jsx("label",{htmlFor:"toggle_resolution",className:"form-label mb-0",children:"Data Fine"}),o.jsxs("div",{className:"form-check",children:[o.jsx("input",{className:"form-check-input",type:"checkbox",id:"toggle_resolution",checked:g,onChange:()=>{_(!g),g&&u(e=>({...e,data_fine_evento:""}))},disabled:n}),o.jsx("label",{className:"form-check-label",htmlFor:"toggle_resolution",children:"Infezione risolta"})]})]}),g&&o.jsx(l,{value:h.data_fine_evento,onChange:e=>{u(t=>({...t,data_fine_evento:e||""})),f.data_fine_evento&&x(e=>{const t={...e};return delete t.data_fine_evento,t})},placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:n,isInvalid:!!f.data_fine_evento,errorMessage:f.data_fine_evento})]})]}),o.jsxs("div",{className:"mb-3",children:[o.jsx("label",{htmlFor:"note",className:"form-label",children:"Note Cliniche"}),o.jsx("textarea",{id:"note",name:"note",className:"form-control",value:h.note,onChange:j,disabled:n,rows:3,placeholder:"Sintomi, terapia, esami, decorso...","aria-describedby":"note-help"}),o.jsx("div",{id:"note-help",className:"form-text",children:"Opzionale - Informazioni cliniche rilevanti"})]}),o.jsxs("div",{className:"alert alert-info mb-3",children:[o.jsx("h6",{className:"alert-heading",children:"Informazioni"}),o.jsxs("p",{className:"mb-2",children:["Compilare tutti i campi obbligatori contrassegnati con ",o.jsx("span",{className:"text-danger",children:"*"}),". Le date non possono essere future."]}),o.jsx("p",{className:"mb-0",children:"Se l'infezione √® risolta, specificare la data di fine. I campi data sono correlati: la data di fine deve essere successiva alla data di inizio."})]}),o.jsxs("div",{className:"d-flex justify-content-end gap-2",children:[o.jsx("button",{type:"button",className:"btn btn-secondary",onClick:i,disabled:n,children:"Annulla"}),o.jsx("button",{type:"submit",className:"btn btn-primary",disabled:n,children:n?o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio..."]}):r?"Aggiorna Infezione":"Salva Infezione"})]})]})},$=({event:e,patientId:t,onSubmit:a,onCancel:i,isSubmitting:n=!1})=>{const r=!!e,[c,d]=s.useState([]),[v,p]=s.useState(!0),[m,h]=s.useState({tipo_evento:"intervento",tipo_intervento_id:e?.tipo_intervento_id??null,descrizione_intervento:e?.descrizione_intervento||"",data_evento:A(e?.data_evento)||"",note:e?.note||""}),[u,g]=s.useState({});(new Date).toISOString().split("T")[0],s.useEffect(()=>{(async()=>{try{p(!0);const e=await T.getListaTipiIntervento();d(Array.isArray(e)?e:[])}catch(e){console.error("Errore caricamento tipi intervento:",e)}finally{p(!1)}})()},[]),s.useEffect(()=>{e&&h({tipo_evento:"intervento",tipo_intervento_id:e.tipo_intervento_id??null,descrizione_intervento:e.descrizione_intervento||"",data_evento:A(e.data_evento),note:e.note||""})},[e]);const _=e=>{const{name:t,value:a}=e.target;h(e=>({...e,[t]:a})),u[t]&&g(e=>{const a={...e};return delete a[t],a})};return o.jsxs("form",{role:"form",onSubmit:async e=>{if(e.preventDefault(),(()=>{const e={};return m.tipo_intervento_id||(e.tipo_intervento="Il tipo di intervento √® obbligatorio"),m.data_evento||(e.data_evento="La data dell'intervento √® obbligatoria"),g(e),0===Object.keys(e).length})())try{const e={paziente_id:t,tipo_evento:"intervento",data_evento:m.data_evento,tipo_intervento_id:m.tipo_intervento_id??void 0,descrizione_intervento:m.descrizione_intervento,note:m.note};await a(e)}catch(i){console.error("Errore durante il salvataggio dell'intervento:",i)}},className:"intervention-form",noValidate:!0,children:[o.jsxs("div",{className:"row mb-3",children:[o.jsx("div",{className:"col-md-6",children:o.jsx("h4",{className:"mb-3",children:r?"Modifica Intervento":"Nuovo Intervento"})}),o.jsx("div",{className:"col-md-6 text-end",children:o.jsx("span",{className:"badge bg-primary fs-6",children:"Intervento Chirurgico"})})]}),o.jsxs("div",{className:"mb-3",children:[o.jsxs("label",{htmlFor:"tipo_intervento_id",className:"form-label",children:["Tipo Intervento ",o.jsx("span",{className:"text-danger",children:"*"})]}),o.jsxs("select",{id:"tipo_intervento_id",name:"tipo_intervento_id",className:"form-select "+(u.tipo_intervento?"is-invalid":""),value:m.tipo_intervento_id?String(m.tipo_intervento_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):null;h(e=>({...e,tipo_intervento_id:t})),u.tipo_intervento&&g(e=>{const t={...e};return delete t.tipo_intervento,t})},disabled:n||v,required:!0,"aria-required":"true","aria-invalid":!!u.tipo_intervento,"aria-describedby":u.tipo_intervento?"tipo_intervento-error":void 0,children:[o.jsx("option",{value:"",children:v?"Caricamento tipi intervento...":"Seleziona tipo intervento..."}),c.map(e=>o.jsx("option",{value:String(e.id),children:e.nome},e.id))]}),u.tipo_intervento&&o.jsx("div",{id:"tipo_intervento-error",className:"invalid-feedback",role:"alert",children:u.tipo_intervento})]}),o.jsxs("div",{className:"mb-3",children:[o.jsx("label",{htmlFor:"descrizione_intervento",className:"form-label",children:"Descrizione Dettagliata"}),o.jsx("textarea",{id:"descrizione_intervento",name:"descrizione_intervento",className:"form-control "+(u.descrizione_intervento?"is-invalid":""),value:m.descrizione_intervento,onChange:_,disabled:n,rows:4,placeholder:"Descrivere dettagliatamente l'intervento eseguito...","aria-invalid":!!u.descrizione_intervento,"aria-describedby":u.descrizione_intervento?"descrizione_intervento-error":"descrizione_intervento-help"}),u.descrizione_intervento&&o.jsx("div",{id:"descrizione_intervento-error",className:"invalid-feedback",role:"alert",children:u.descrizione_intervento}),o.jsx("div",{id:"descrizione_intervento-help",className:"form-text",children:"Opzionale - Fornire una descrizione dettagliata della procedura"})]}),o.jsx("div",{className:"mb-3",children:o.jsx(l,{label:"Data Intervento",value:m.data_evento,onChange:e=>{h(t=>({...t,data_evento:e||""})),u.data_evento&&g(e=>{const t={...e};return delete t.data_evento,t})},isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:n,isInvalid:!!u.data_evento,errorMessage:u.data_evento})}),o.jsxs("div",{className:"mb-3",children:[o.jsx("label",{htmlFor:"note",className:"form-label",children:"Note Aggiuntive"}),o.jsx("textarea",{id:"note",name:"note",className:"form-control",value:m.note,onChange:_,disabled:n,rows:2,placeholder:"Note aggiuntive sull'intervento...","aria-describedby":"note-help"}),o.jsx("div",{id:"note-help",className:"form-text",children:"Opzionale - Informazioni aggiuntive sull'intervento"})]}),o.jsxs("div",{className:"alert alert-info mb-3",children:[o.jsx("h6",{className:"alert-heading",children:"Informazioni"}),o.jsxs("p",{className:"mb-0",children:["Compilare tutti i campi obbligatori contrassegnati con ",o.jsx("span",{className:"text-danger",children:"*"}),". La data dell'intervento non pu√≤ essere futura."]})]}),o.jsxs("div",{className:"d-flex justify-content-end gap-2",children:[o.jsx("button",{type:"button",className:"btn btn-secondary",onClick:i,disabled:n,children:"Annulla"}),o.jsx("button",{type:"submit",className:"btn btn-primary",disabled:n,children:n?o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio..."]}):r?"Aggiorna Intervento":"Salva Intervento"})]})]})};function M(e){if(!e)return null;if(e.match(/^\d{4}-\d{2}-\d{2}$/))return e;if(!e.includes("/"))throw new Error("Formato data non valido. Utilizzare il formato gg/mm/aaaa");const t=e.split("/");if(3!==t.length)throw new Error("Formato data non valido. Utilizzare il formato gg/mm/aaaa");const[a,i,n]=t,s=parseInt(a,10),o=parseInt(i,10),r=parseInt(n,10);if(isNaN(s)||isNaN(o)||isNaN(r))throw new Error("Formato data non valido. Utilizzare numeri validi");if(s<1||s>31)throw new Error("Giorno non valido (1-31)");if(o<1||o>12)throw new Error("Mese non valido (1-12)");if(r<1900||r>2100)throw new Error("Anno non valido");const l=new Date(r,o-1,s);if(l.getDate()!==s||l.getMonth()!==o-1||l.getFullYear()!==r)throw new Error("Data non valida (es. 31/02/2025)");return`${n}-${i.padStart(2,"0")}-${a.padStart(2,"0")}`}const q=new class{interventionTypes;constructor(){this.interventionTypes=["Chirurgia Ortopedica","Chirurgia Plastica","Chirurgia Vascolare","Chirurgia Generale","Altro"]}calculatePostOperativeDays(e,t=new Date){try{if(!Array.isArray(e))throw new Error("eventiClinici must be an array");const a=this.parseDate(t);if(!a)throw new Error("Invalid reference date");const i=this.filterInterventions(e);if(0===i.length)return{hasInterventions:!1,postOperativeDays:null,lastIntervention:null,displayText:null,allInterventions:[]};const n=this.sortInterventionsByDate(i),s=n[0],o=this.parseDate(s.data_evento);if(!o)throw new Error("Invalid intervention date");const r=this.calculateDaysDifference(o,a);return{hasInterventions:!0,postOperativeDays:r,lastIntervention:s,displayText:this.formatDisplayText(r),allInterventions:n}}catch(a){const e=a instanceof Error?a.message:String(a);return window.appLogger?.error("Error calculating post-operative days:",a),{hasInterventions:!1,postOperativeDays:null,lastIntervention:null,displayText:null,allInterventions:[],error:e}}}calculateForMultiplePatients(e,t=new Date){const a=new Map;return Array.isArray(e)?(e.forEach(e=>{if(e.id&&e.eventi_clinici){const i=this.calculatePostOperativeDays(e.eventi_clinici,t);a.set(e.id,i)}}),a):a}getPostOperativeStatus(e,t=new Date){const a=this.calculatePostOperativeDays(e,t);if(!a.hasInterventions)return{hasStatus:!1,statusText:"",statusClass:"",badgeText:""};const i=a.postOperativeDays,n=this.hasActiveInfection(e);let s="success",o=`PO ${i}`;return n?(s="danger",o=`PO ${i} ü¶†`):i<=7?s="danger":i<=30?s="warning":i<=90&&(s="info"),{hasStatus:!0,statusText:a.displayText,statusClass:s,badgeText:o,days:i,lastIntervention:a.lastIntervention,hasActiveInfection:n}}hasActiveInfection(e){return!!Array.isArray(e)&&e.some(e=>"infezione"===e.tipo_evento&&e.data_evento&&!e.data_fine_evento)}filterInterventions(e){return e.filter(e=>"intervento"===e.tipo_evento&&e.data_evento&&e.tipo_intervento)}sortInterventionsByDate(e){return e.sort((e,t)=>{const a=this.parseDate(e.data_evento),i=this.parseDate(t.data_evento);return a&&i?i.getTime()-a.getTime():0})}calculateDaysDifference(e,t){const a=t.getTime()-e.getTime(),i=Math.floor(a/864e5);return Math.max(0,i)}formatDisplayText(e){return 0===e?"Giorno dell'intervento":1===e?"Giorno post-operatorio 1":`Giorno post-operatorio ${e}`}getDetailedPostOperativeInfo(e,t=new Date){const a=this.calculatePostOperativeDays(e,t);if(!a.hasInterventions)return{hasInterventions:!1,summary:"Nessun intervento chirurgico registrato",details:[]};const i=this.parseDate(t);if(!i)return{hasInterventions:!1,summary:"Data riferimento non valida",details:[]};const n=a.allInterventions.map((e,t)=>{const a=this.parseDate(e.data_evento),n=a?this.calculateDaysDifference(a,i):0;return{date:e.data_evento,type:e.tipo_intervento||"N/A",description:e.descrizione_intervento||"",daysSince:n,displayText:this.formatDisplayText(n),isLatest:0===t}});return{hasInterventions:!0,currentPostOpDay:a.postOperativeDays??void 0,currentDisplayText:a.displayText??void 0,lastInterventionDate:a.lastIntervention?.data_evento,lastInterventionType:a.lastIntervention?.tipo_intervento??void 0,totalInterventions:a.allInterventions.length,summary:`${a.displayText} (${a.allInterventions.length} interventi totali)`,details:n}}isInCriticalPostOpPeriod(e,t=7,a=new Date){const i=this.calculatePostOperativeDays(e,a);if(!i.hasInterventions)return{isCritical:!1,reason:"No interventions recorded"};const n=i.postOperativeDays||0,s=n<=t;return{isCritical:s,postOpDays:n,criticalThreshold:t,reason:s?`Patient is ${n} days post-operative (‚â§${t} days)`:`Patient is ${n} days post-operative (>${t} days)`}}parseDate(e){if(!e)return null;if(e instanceof Date)return isNaN(e.getTime())?null:e;if("string"==typeof e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)){const t=new Date(e+"T00:00:00.000Z");return isNaN(t.getTime())?null:t}if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(e)){const t=e.split("/"),a=parseInt(t[0],10),i=parseInt(t[1],10)-1,n=parseInt(t[2],10),s=new Date(n,i,a);return isNaN(s.getTime())?null:s}const t=new Date(e);return isNaN(t.getTime())?null:t}return null}validateInterventionEvent(e){const t=[];if(!e)return t.push("Event object is required"),{isValid:!1,errors:t};if("intervento"!==e.tipo_evento&&t.push('Event type must be "intervento"'),e.data_evento){const a=this.parseDate(e.data_evento);a?a>new Date&&t.push("Event date cannot be in the future"):t.push("Invalid event date format")}else t.push("Event date is required");return e.tipo_intervento||t.push("Intervention type is required"),{isValid:0===t.length,errors:t}}getPostOperativeStatistics(e,t=new Date){if(!Array.isArray(e))return{totalPatients:0,patientsWithInterventions:0,criticalPeriod:0,earlyRecovery:0,lateRecovery:0,averagePostOpDays:0};let a=0,i=0,n=0,s=0,o=0;return e.forEach(e=>{if(e.eventi_clinici){const r=this.calculatePostOperativeDays(e.eventi_clinici,t);r.hasInterventions&&null!==r.postOperativeDays&&(a++,o+=r.postOperativeDays,r.postOperativeDays<=7?i++:r.postOperativeDays<=30?n++:s++)}}),{totalPatients:e.length,patientsWithInterventions:a,criticalPeriod:i,earlyRecovery:n,lateRecovery:s,averagePostOpDays:a>0?Math.round(o/a):0}}};function O(e,t){return q.getPostOperativeStatus(e,t)}function L(e){const t=new Map;return e.forEach(e=>{t.set(e.id,e.nome)}),t}function K(e,t,a){if("intervento"===e.tipo_evento)return e.tipo_intervento_id&&t?.has(e.tipo_intervento_id)?t.get(e.tipo_intervento_id)||"-":e.tipo_intervento||"-";if("infezione"===e.tipo_evento){if(e.agente_patogeno_id&&a?.has(e.agente_patogeno_id)){const t=a.get(e.agente_patogeno_id)||"";return e.tipo_patogeno?`${t} (${e.tipo_patogeno})`:t}return e.tipo_batterio||"-"}return"-"}const B=r.memo(({event:e,patient:t,tipiInterventoMap:a,agentiPatogeniMap:i,onEdit:n,onDelete:s,onResolve:r})=>{const l="infezione"===e.tipo_evento;return o.jsx("div",{className:`card h-100 ${l?"border-danger":"border-success"}`,children:o.jsxs("div",{className:"card-body",children:[o.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-2",children:[o.jsx("span",{className:"badge "+(l?"bg-danger":"bg-primary"),role:"status","aria-label":l?"Infezione":"Intervento",children:l?"Infezione":"Intervento"}),o.jsx("time",{dateTime:e.data_evento,className:"text-muted small",title:new Date(e.data_evento).toLocaleDateString("it-IT"),children:new Date(e.data_evento).toLocaleDateString("it-IT")})]}),o.jsx("h5",{className:"card-title mb-1",children:t?`${t.nome} ${t.cognome}`:e.paziente_id}),t?.codice_rad&&o.jsxs("div",{className:"small text-muted mb-2",children:[o.jsx("abbr",{title:"Codice RAD",children:"RAD"}),": ",t.codice_rad]}),o.jsxs("div",{className:"card-text",children:[o.jsxs("div",{className:"mb-2",children:[o.jsx("strong",{children:"Dettagli:"})," ","-"!==K(e,a,i)?K(e,a,i):"Nessun dettaglio"]}),e.note&&o.jsxs("div",{className:"mb-2",children:[o.jsx("strong",{children:"Note:"})," ",e.note]}),e.data_fine_evento&&o.jsxs("div",{className:"mb-2",children:[o.jsx("strong",{children:"Data fine:"})," ",o.jsx("time",{dateTime:e.data_fine_evento,title:new Date(e.data_fine_evento).toLocaleDateString("it-IT"),children:new Date(e.data_fine_evento).toLocaleDateString("it-IT")})]})]}),o.jsxs("div",{className:"d-flex gap-2",role:"group","aria-label":"Azioni evento",children:[o.jsx("button",{type:"button",className:"btn btn-secondary btn-sm",onClick:()=>n(e),"aria-label":`Modifica evento ${l?"infezione":"intervento"} del ${new Date(e.data_evento).toLocaleDateString("it-IT")}`,children:"Modifica"}),o.jsx("button",{type:"button",className:"btn btn-danger btn-sm",onClick:()=>s(e.id),"aria-label":`Elimina evento ${l?"infezione":"intervento"} del ${new Date(e.data_evento).toLocaleDateString("it-IT")}`,children:"Elimina"}),l&&!e.data_fine_evento&&o.jsx("button",{type:"button",className:"btn btn-success btn-sm",onClick:()=>r(e.id),"aria-label":"Segna infezione come risolta",children:"Risolvi"})]})]})})});B.displayName="EventCard";const V=({hasFilters:e,onCreateClick:t})=>o.jsxs("div",{className:"events-empty-state",role:"status","aria-live":"polite","aria-label":e?"Nessun evento corrisponde ai filtri selezionati":"Nessun evento clinico registrato",children:[o.jsx("div",{className:"empty-icon",children:o.jsx("span",{className:"material-icons","aria-hidden":"true",children:e?"filter_list_off":"event_busy"})}),o.jsx("h3",{className:"empty-title",children:e?"Nessun evento trovato":"Nessun evento registrato"}),o.jsx("p",{className:"empty-description",children:e?"Nessun evento clinico corrisponde ai criteri di ricerca selezionati. Prova a modificare i filtri o a rimuovere alcuni di essi.":"Non hai ancora registrato alcun evento clinico per i pazienti. Inizia creando il primo evento."}),!e&&o.jsxs(c,{variant:"clinical",onClick:t,className:"mt-3","aria-label":"Crea il primo evento clinico",children:[o.jsx("span",{className:"material-icons me-1",children:"add"}),"Crea Primo Evento"]})]}),W=({count:e=5})=>o.jsx("div",{className:"skeleton-cards",children:[...Array(e)].map((e,t)=>o.jsx("div",{className:"skeleton-card card mb-3",children:o.jsxs("div",{className:"card-body",children:[o.jsx("div",{className:"skeleton-text skeleton-title mb-3"}),o.jsx("div",{className:"skeleton-text skeleton-subtitle mb-2"}),o.jsx("div",{className:"skeleton-text skeleton-text-line mb-2"}),o.jsx("div",{className:"skeleton-text skeleton-text-line"}),o.jsxs("div",{className:"skeleton-buttons mt-3",children:[o.jsx("div",{className:"skeleton-button"}),o.jsx("div",{className:"skeleton-button"}),o.jsx("div",{className:"skeleton-button"})]})]})},t))}),U=({rows:e=5})=>o.jsx("div",{className:"skeleton-table",children:o.jsxs("table",{className:"table",children:[o.jsx("thead",{children:o.jsxs("tr",{children:[o.jsx("th",{children:o.jsx("div",{className:"skeleton-text skeleton-header"})}),o.jsx("th",{children:o.jsx("div",{className:"skeleton-text skeleton-header"})}),o.jsx("th",{children:o.jsx("div",{className:"skeleton-text skeleton-header"})}),o.jsx("th",{children:o.jsx("div",{className:"skeleton-text skeleton-header"})}),o.jsx("th",{children:o.jsx("div",{className:"skeleton-text skeleton-header"})})]})}),o.jsx("tbody",{children:[...Array(e)].map((e,t)=>o.jsxs("tr",{className:"skeleton-row",children:[o.jsx("td",{children:o.jsx("div",{className:"skeleton-text"})}),o.jsx("td",{children:o.jsx("div",{className:"skeleton-text"})}),o.jsx("td",{children:o.jsx("div",{className:"skeleton-text skeleton-short"})}),o.jsx("td",{children:o.jsx("div",{className:"skeleton-text skeleton-medium"})}),o.jsxs("td",{children:[o.jsx("div",{className:"skeleton-badge"}),o.jsx("div",{className:"skeleton-badge"})]})]},t))})]})}),G={tipo_evento:[],paziente_id:void 0,paziente_search:"",data_inizio:void 0,data_fine:void 0};function H({initialFilters:e={},debounceMs:t=300,onFiltersChange:a,batchUpdateDelay:i=100}={}){const[n,o]=s.useState(()=>({...G,...e})),[r,l]=s.useState({}),[c,d]=s.useState(!1),[v,p]=s.useState(!1),m=s.useRef(),h=s.useRef(),u=s.useCallback(e=>{console.log("‚è±Ô∏è applyFiltersWithDebounce called with:",e,"- will apply in",t,"ms"),p(!0),m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{console.log("‚úÖ Debounce timeout fired! Applying filters:",e),o(e),p(!1),console.log("üì¢ Calling onFiltersChange callback"),a&&a(e)},t)},[t,a]),g=s.useCallback((e,t)=>{console.log("üîÑ updateFilter called:",{key:e,value:t,currentValue:n[e]});const a={...n,[e]:t};console.log("üì¶ New filters object:",a),u(a)},[n,u]),_=s.useCallback(e=>{const t={...n,...e};u(t)},[n,u]),f=s.useCallback(e=>{o(e),a&&a(e)},[a]),x=s.useCallback(()=>{const t={...G,...e};u(t)},[e,u]);s.useCallback((e,t)=>{l(a=>({...a,[e]:t})),d(!0),h.current&&clearTimeout(h.current),h.current=setTimeout(()=>{b()},i)},[i]);const b=s.useCallback(()=>{if(c){const e={...n,...r};u(e),l({}),d(!1),h.current&&clearTimeout(h.current)}},[n,r,c,u]),j=s.useCallback(()=>{l({}),d(!1),h.current&&clearTimeout(h.current)},[]);return s.useEffect(()=>()=>{m.current&&clearTimeout(m.current),h.current&&clearTimeout(h.current)},[]),{filters:n,pendingFilters:r,hasPendingChanges:c,updateFilter:g,updateFilters:_,setFilters:f,resetFilters:x,applyPendingFilters:b,discardPendingFilters:j,isDebouncing:v}}const J=["intervento","infezione"],Q={intervento:"Intervento",infezione:"Infezione"},Y=r.memo(({initialFilters:e,onFiltersChange:t,debounceMs:a=300,showQuickFilters:i=!0,showBatchControls:n=!1,compact:l=!1,compactToggleOverride:p})=>{console.log("üéØ DebouncedEventFilters RENDERED with initialFilters:",e),s.useRef(".debounced-event-filters");const{filters:m,hasPendingChanges:h,updateFilter:u,updateFilters:g,resetFilters:_,applyPendingFilters:f,discardPendingFilters:b,isDebouncing:j}=H({initialFilters:e,debounceMs:a,onFiltersChange:t}),[N,z]=s.useState(m.paziente_search||""),[y,w]=s.useState(m.data_inizio||""),[I,C]=s.useState(m.data_fine||""),[S,D]=s.useState(null),[E,k]=s.useState(!1);s.useEffect(()=>{z(m.paziente_search||""),w(m.data_inizio||""),C(m.data_fine||""),m.paziente_id||D(null)},[m]),s.useCallback(e=>{const t=e.target.value;z(t),u("paziente_search",t)},[u]);const P=s.useCallback(e=>{w(e||""),u("data_inizio",e||void 0)},[u]),T=s.useCallback(e=>{C(e||""),u("data_fine",e||void 0)},[u]),A=s.useCallback(e=>{u("tipo_evento",e?[e]:[])},[u]),R=s.useCallback(e=>{const t=new Date;let a,i;switch(t.setHours(0,0,0,0),e){case"today":a=i=t.toISOString().split("T")[0];break;case"week":const e=new Date(t);e.setDate(t.getDate()-7),a=e.toISOString().split("T")[0],i=t.toISOString().split("T")[0];break;case"month":const n=new Date(t);n.setDate(t.getDate()-30),a=n.toISOString().split("T")[0],i=t.toISOString().split("T")[0]}w(a),C(i),g({data_inizio:a,data_fine:i})},[g]),F=s.useCallback(()=>{_(),z(""),w(""),C("")},[_]),$=r.useMemo(()=>{let e=0;return m.paziente_search&&e++,m.tipo_evento&&m.tipo_evento.length>0&&e++,m.data_inizio&&e++,m.data_fine&&e++,e},[m]),M=s.useCallback(e=>{switch(e){case"paziente_search":u("paziente_id",void 0),z("");break;case"tipo_evento":u("tipo_evento",[]);break;case"data_inizio":P(null);break;case"data_fine":T(null)}},[u]);if(l){const e=Boolean(p),t=e?p.expanded:E;return o.jsxs("div",{className:"debounced-event-filters compact "+(t?"is-expanded":"is-collapsed"),children:[!e&&o.jsxs("div",{className:"filters-header-bar",children:[o.jsxs("div",{className:"filters-summary",children:[o.jsxs("button",{type:"button",className:"filters-toggle-btn",onClick:()=>{e?p.onToggle():k(e=>!e)},"aria-expanded":t,"aria-label":t?"Nascondi filtri":"Mostra filtri",children:[o.jsx("span",{className:"filters-toggle-icon material-icons","aria-hidden":"true",children:"filter_list"}),o.jsxs("span",{className:"filters-label",children:["Filtri ",$>0&&`(${$})`]}),o.jsx("span",{className:"filters-toggle-chevron material-icons","aria-hidden":"true",children:t?"expand_less":"expand_more"})]}),j&&o.jsx("span",{className:"spinner-border spinner-border-sm ms-2",role:"status","aria-label":"Caricamento filtri"})]}),$>0&&o.jsx(c,{variant:"link",size:"sm",onClick:F,className:"btn-reset-link",children:"Cancella tutto"})]}),$>0&&o.jsxs("div",{className:"active-filter-chips",hidden:!t,children:[m.paziente_search&&o.jsxs("span",{className:"filter-chip",children:[o.jsxs("span",{className:"chip-label",children:["Paziente: ",m.paziente_search]}),o.jsx("button",{type:"button",className:"chip-remove",onClick:()=>M("paziente_search"),"aria-label":"Rimuovi filtro paziente",children:"‚úï"})]}),m.tipo_evento&&m.tipo_evento.length>0&&o.jsxs("span",{className:"filter-chip",children:[o.jsxs("span",{className:"chip-label",children:["Tipo: ",m.tipo_evento.map(e=>Q[e]).join(", ")]}),o.jsx("button",{type:"button",className:"chip-remove",onClick:()=>M("tipo_evento"),"aria-label":"Rimuovi filtro tipo evento",children:"‚úï"})]}),m.data_inizio&&o.jsxs("span",{className:"filter-chip",children:[o.jsxs("span",{className:"chip-label",children:["Da: ",m.data_inizio]}),o.jsx("button",{type:"button",className:"chip-remove",onClick:()=>M("data_inizio"),"aria-label":"Rimuovi filtro data inizio",children:"‚úï"})]}),m.data_fine&&o.jsxs("span",{className:"filter-chip",children:[o.jsxs("span",{className:"chip-label",children:["A: ",m.data_fine]}),o.jsx("button",{type:"button",className:"chip-remove",onClick:()=>M("data_fine"),"aria-label":"Rimuovi filtro data fine",children:"‚úï"})]})]}),t&&o.jsxs("div",{className:"filters-content",children:[e&&o.jsxs("div",{className:"filters-compact-actions d-flex justify-content-end align-items-center mb-2 gap-2",children:[j&&o.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-label":"Caricamento filtri"}),$>0&&o.jsx(c,{variant:"link",size:"sm",onClick:F,className:"btn-reset-link",children:"Cancella tutto"})]}),o.jsxs("div",{className:"row g-2 align-items-end",children:[o.jsxs("div",{className:"col-12",children:[o.jsx("label",{htmlFor:"patient-search-compact",className:"form-label",children:"Paziente"}),o.jsx(x,{value:S,onChange:e=>{D(e),u("paziente_id",e?e.id:void 0)},placeholder:"Cerca paziente per nome, cognome o codice...",className:"form-control form-control-sm"})]}),o.jsxs("div",{className:"col-12",children:[o.jsx("label",{htmlFor:"event-type-compact",className:"form-label",children:"Tipo Evento"}),o.jsx(d,{id:"event-type-compact",value:m.tipo_evento?.[0]||"",options:[{value:"",label:"Tutti"},...J.map(e=>({value:e,label:Q[e]}))],onChange:A,placeholder:"Tutti"})]}),o.jsxs("div",{className:"col-12",children:[o.jsx("label",{className:"form-label",children:"Periodo"}),o.jsx("div",{className:"date-range-expanded",children:o.jsx(v,{startDate:y,endDate:I,onStartDateChange:P,onEndDateChange:T,startLabel:"Data Inizio",endLabel:"Data Fine",startPlaceholder:"Data inizio",endPlaceholder:"Data fine",size:"sm",clearable:!0,allowInput:!0})})]})]})]})]})}return o.jsxs("div",{className:"debounced-event-filters",children:[i&&o.jsx("div",{className:"quick-filters mb-3",children:o.jsxs("div",{className:"btn-group",role:"group",children:[o.jsx(c,{variant:"outline-primary",size:"sm",onClick:()=>R("today"),children:"Oggi"}),o.jsx(c,{variant:"outline-primary",size:"sm",onClick:()=>R("week"),children:"Ultima settimana"}),o.jsx(c,{variant:"outline-primary",size:"sm",onClick:()=>R("month"),children:"Ultimo mese"})]})}),o.jsxs("div",{className:"row g-3",children:[o.jsxs("div",{className:"col-md-4",children:[o.jsx("label",{htmlFor:"patient-search",className:"form-label",children:"Paziente"}),o.jsx(x,{value:S,onChange:e=>{D(e),u("paziente_id",e?e.id:void 0)},placeholder:"Cerca paziente per nome, cognome o codice...",className:"form-control"})]}),o.jsxs("div",{className:"col-md-2",children:[o.jsx("label",{htmlFor:"event-type",className:"form-label",children:"Tipo Evento"}),o.jsx(d,{id:"event-type",value:m.tipo_evento?.[0]||"",options:[{value:"",label:"Tutti"},...J.map(e=>({value:e,label:Q[e]}))],onChange:A,placeholder:"Tutti",className:"form-control-sm"})]}),o.jsx("div",{className:"col-md-6",children:o.jsx(v,{startDate:y,endDate:I,onStartDateChange:P,onEndDateChange:T,startLabel:"Data Inizio",endLabel:"Data Fine",startPlaceholder:"gg/mm/aaaa",endPlaceholder:"gg/mm/aaaa",clearable:!0,allowInput:!0})})]}),n&&h&&o.jsx("div",{className:"batch-controls mt-3 p-2 bg-light rounded",children:o.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[o.jsx("small",{className:"text-muted",children:"Ci sono modifiche non applicate"}),o.jsxs("div",{className:"btn-group btn-group-sm",children:[o.jsx(c,{variant:"success",onClick:f,children:"Applica"}),o.jsx(c,{variant:"outline-secondary",onClick:b,children:"Annulla"})]})]})}),o.jsxs("div",{className:"filter-actions mt-3 d-flex justify-content-end",children:[j&&o.jsx("div",{className:"debouncing-indicator me-2",children:o.jsx("div",{className:"spinner-border spinner-border-sm",role:"status",children:o.jsx("span",{className:"visually-hidden",children:"Aggiornamento filtri..."})})}),o.jsx(c,{variant:"outline-secondary",onClick:F,disabled:0===$,children:"Resetta Filtri"})]})]})}),X=({statistics:e,loading:t})=>t?o.jsx("div",{className:"patient-stats-grid",children:[...Array(4)].map((e,t)=>o.jsxs("div",{className:"patient-stat-card is-loading",children:[o.jsx("div",{className:"stat-icon"}),o.jsx("div",{className:"stat-value"}),o.jsx("div",{className:"stat-label"})]},t))}):o.jsxs("div",{className:"patient-stats-grid",children:[o.jsxs("div",{className:"patient-stat-card",children:[o.jsx("div",{className:"stat-icon",children:o.jsx("span",{className:"material-icons",children:"timeline"})}),o.jsx("div",{className:"stat-value",children:e.total}),o.jsx("div",{className:"stat-label",children:"Totale Eventi"})]}),o.jsxs("div",{className:"patient-stat-card",children:[o.jsx("div",{className:"stat-icon",children:o.jsx("span",{className:"material-icons",children:"healing"})}),o.jsx("div",{className:"stat-value",children:e.interventi}),o.jsx("div",{className:"stat-label",children:"Interventi"})]}),o.jsxs("div",{className:"patient-stat-card",children:[o.jsx("div",{className:"stat-icon",children:o.jsx("span",{className:"material-icons",children:"bug_report"})}),o.jsx("div",{className:"stat-value",children:e.infezioni}),o.jsx("div",{className:"stat-label",children:"Infezioni"})]}),o.jsxs("div",{className:"patient-stat-card",children:[o.jsx("div",{className:"stat-icon",children:o.jsx("span",{className:"material-icons",children:"date_range"})}),o.jsx("div",{className:"stat-value",children:e.ultimoMese}),o.jsx("div",{className:"stat-label",children:"Nell'ultimo mese"})]})]}),Z=({events:e,patients:t,loading:a,hasFilters:i=!1,onEdit:n,onDelete:s,onResolve:r,onCreateEvent:l,tipiInterventoMap:c,agentiPatogeniMap:d,currentPage:v,totalPages:p,totalCount:m,onPageChange:h})=>a?o.jsx(W,{count:10}):0===e.length?o.jsx(V,{hasFilters:i,onCreateClick:l||(()=>{})}):o.jsxs("div",{className:"virtualized-event-list",children:[o.jsx("div",{className:"mb-2 d-flex justify-content-between align-items-center",children:o.jsxs("div",{className:"text-muted small",children:["Visualizzazione ottimizzata: ",e.length," eventi"]})}),o.jsx("div",{className:"row",children:e.map(e=>{const a=t.get(e.paziente_id);return o.jsx("div",{className:"col-12 col-md-6 col-lg-4 mb-3",children:o.jsx(B,{event:e,patient:a,tipiInterventoMap:c,agentiPatogeniMap:d,onEdit:n,onDelete:s,onResolve:r})},e.id)})}),e.length>0&&"number"==typeof v&&"number"==typeof p&&h?o.jsx("nav",{"aria-label":"Paginazione eventi clinici",className:"mt-3",children:o.jsxs("div",{className:"d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2",children:[o.jsxs("div",{className:"text-muted small text-center text-sm-start",role:"status","aria-live":"polite","aria-atomic":"true",children:["Pagina ",v," di ",p," ‚Ä¢ ",m??e.length," eventi totali"]}),o.jsxs("div",{className:"d-flex gap-2",role:"group","aria-label":"Navigazione pagine",children:[o.jsxs("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>h(Math.max(1,v-1)),disabled:v<=1,"aria-label":`Vai alla pagina precedente (attualmente a pagina ${v} di ${p})`,"aria-pressed":!1,children:[o.jsx("span",{className:"material-icons me-1 align-middle","aria-hidden":"true",children:"chevron_left"}),"Precedente"]}),o.jsxs("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>h(Math.min(p,v+1)),disabled:v>=p,"aria-label":`Vai alla pagina successiva (attualmente a pagina ${v} di ${p})`,"aria-pressed":!1,children:["Successivo",o.jsx("span",{className:"material-icons ms-1 align-middle","aria-hidden":"true",children:"chevron_right"})]})]})]})}):e.length>0&&o.jsx("div",{className:"text-center mt-3",children:o.jsxs("div",{className:"text-muted small",children:[e.length," eventi totali"]})})]}),ee=({events:e,patients:t,loading:a,hasFilters:i=!1,onEdit:n,onDelete:s,onResolve:r,onCreateEvent:l,currentPage:d,totalPages:v,pageSize:p,onPageChange:m,onPageSizeChange:h,tipiInterventoMap:u,agentiPatogeniMap:g})=>a?o.jsx(U,{rows:p}):0===e.length?o.jsx(V,{hasFilters:i,onCreateClick:l||(()=>{})}):o.jsxs("div",{className:"virtualized-events-table",children:[o.jsxs("div",{className:"mb-2 d-flex justify-content-between align-items-center",children:[o.jsxs("div",{className:"text-muted small",children:["Visualizzazione ottimizzata: ",e.length," eventi"]}),o.jsx("div",{children:o.jsx("select",{value:p,onChange:e=>h(Number(e.target.value)),className:"form-select form-select-sm",style:{width:"auto"},children:[10,20,50,100].map(e=>o.jsxs("option",{value:e,children:["Mostra ",e]},e))})})]}),o.jsx("div",{className:"table-responsive",children:o.jsxs("table",{className:"table table-striped table-hover",children:[o.jsx("thead",{className:"table-light",children:o.jsxs("tr",{children:[o.jsx("th",{children:"Paziente"}),o.jsx("th",{children:"Tipo Evento"}),o.jsx("th",{children:"Data"}),o.jsx("th",{children:"Dettagli"}),o.jsx("th",{children:"Azioni"})]})}),o.jsx("tbody",{children:e.map(e=>{const a=t.get(e.paziente_id),i=a&&a.eventi_clinici?.some(e=>"infezione"===e.tipo_evento&&!e.data_fine_evento);return o.jsxs("tr",{className:`event-row ${i?"event-row-infected-patient":""}`,title:i?"Evento di paziente con infezione attiva":void 0,children:[o.jsx("td",{children:o.jsxs("div",{className:"d-flex flex-column",children:[o.jsx("div",{className:"fw-semibold",children:a?`${a.nome} ${a.cognome}`:e.paziente_id}),a?.codice_rad&&o.jsxs("div",{className:"small text-muted",children:["RAD: ",a.codice_rad]}),i&&o.jsxs("div",{className:"small text-danger",children:[o.jsx("span",{className:"material-icons fs-6 me-1",style:{verticalAlign:"middle"},children:"coronavirus"}),"Infezione Attiva"]})]})}),o.jsx("td",{children:o.jsx("span",{className:"badge "+("intervento"===e.tipo_evento?"bg-primary":"bg-danger"),children:"intervento"===e.tipo_evento?"Intervento":"Infezione"})}),o.jsx("td",{children:o.jsx("div",{className:"text-nowrap",children:new Date(e.data_evento).toLocaleDateString("it-IT")})}),o.jsx("td",{children:K(e,u,g)}),o.jsx("td",{children:o.jsxs("div",{className:"d-flex gap-1",children:[o.jsx(c,{variant:"link",size:"sm",onClick:()=>n(e),title:"Modifica evento",className:"p-1",children:o.jsx("span",{className:"material-icons fs-5",children:"edit"})}),o.jsx(c,{variant:"link",size:"sm",onClick:()=>s(e.id),title:"Elimina evento",className:"p-1 text-danger",children:o.jsx("span",{className:"material-icons fs-5",children:"delete"})}),"infezione"===e.tipo_evento&&!e.data_fine_evento&&o.jsx(c,{variant:"link",size:"sm",onClick:()=>r(e.id),title:"Risolvi infezione",className:"p-1 text-success",children:o.jsx("span",{className:"material-icons fs-5",children:"check_circle"})})]})})]},e.id)})})]})}),o.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-3",children:[o.jsxs("div",{className:"text-muted small",children:["Pagina ",d," di ",v," ‚Ä¢ ",e.length," eventi totali"]}),o.jsx("nav",{children:o.jsxs("ul",{className:"pagination pagination-sm mb-0",children:[o.jsx("li",{className:"page-item "+(1===d?"disabled":""),children:o.jsx("button",{className:"page-link",onClick:()=>m(d-1),disabled:1===d,children:o.jsx("span",{className:"material-icons",children:"chevron_left"})})}),[...Array(Math.min(5,v)).keys()].map(e=>{const t=e+1;let a=t;return v>5&&(a=d<=3?t:d>=v-2?v-4+t:d-2+t),o.jsx("li",{className:"page-item "+(d===a?"active":""),children:o.jsx("button",{className:"page-link",onClick:()=>m(a),children:a})},a)}),o.jsx("li",{className:"page-item "+(d===v?"disabled":""),children:o.jsx("button",{className:"page-link",onClick:()=>m(d+1),disabled:d===v,children:o.jsx("span",{className:"material-icons",children:"chevron_right"})})})]})})]})]}),te={intervento:"Intervento Chirurgico",infezione:"Infezione"},ae=["intervento","infezione"],ie=({event:e,patientId:t,onSubmit:a,onCancel:i,initialEventType:n,allowedTypes:r,isSubmitting:l=!1})=>{const[c,d]=s.useState(()=>{if(e?.tipo_evento)return e.tipo_evento;if(n&&(!r||r.includes(n)))return n;return(r||ae)[0]}),[v,p]=s.useState(t),[m,h]=s.useState(null);s.useEffect(()=>{e?.tipo_evento&&d(e.tipo_evento)},[e?.tipo_evento]);const u=r||ae,g=!e&&u.length>1,_=e||v;return o.jsxs("div",{className:"typed-event-form",children:[!e&&o.jsx("div",{className:"card mb-4",children:o.jsxs("div",{className:"card-body",children:[o.jsxs("h5",{className:"card-title mb-3",children:[o.jsx("span",{className:"material-icons",style:{fontSize:"1.25rem",marginRight:"0.5rem",verticalAlign:"middle"},children:"person_search"}),"Seleziona Paziente"]}),o.jsx(x,{value:m,onChange:e=>{e?(p(e.id),h(e)):(p(""),h(null))},placeholder:"Cerca per nome, cognome o RAD...",disabled:l,activeOnly:!1,maxResults:10,minSearchLength:1,debounceDelay:300,showPatientInfo:!0,highlightMatch:!0}),v&&m&&o.jsxs("div",{className:"alert alert-success mt-2 mb-0",role:"alert",children:[o.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"check_circle"}),"Paziente selezionato: ",o.jsxs("strong",{children:[m.cognome," ",m.nome]})]}),!v&&o.jsxs("div",{className:"alert alert-info mt-2 mb-0",role:"alert",children:[o.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"info"}),"Seleziona un paziente per continuare"]})]})}),g&&_&&o.jsx("div",{className:"card mb-4",children:o.jsxs("div",{className:"card-body",children:[o.jsx("h5",{className:"card-title mb-3",children:"Seleziona Tipo Evento"}),o.jsx("div",{className:"btn-group w-100",role:"group",children:u.map(e=>o.jsx("button",{type:"button",className:"btn "+(c===e?"btn-primary active":"btn-outline-primary"),onClick:()=>{d(e)},disabled:l,children:te[e]},e))}),o.jsx("div",{className:"mt-2 text-center",children:o.jsxs("small",{className:"text-muted",children:["Tipo selezionato: ",o.jsx("strong",{children:te[c]})]})})]})}),_&&o.jsx("intervento"===c?$:F,{event:e,patientId:v,onSubmit:a,onCancel:i,isSubmitting:l})]})},ne=["event-type","event-details","dates","notes","review"],se=({currentStep:e,getStepLabel:t,getStepNumber:a,totalSteps:i,selectedPatient:n})=>{const s=a(e),r=t(e);return o.jsxs("div",{className:"event-wizard-stepper",children:[o.jsx("div",{className:"event-wizard-stepper-progress",children:o.jsx("div",{className:"event-wizard-stepper-progress-bar",children:o.jsx("div",{className:"event-wizard-stepper-progress-fill",style:{width:`${s/i*100}%`},role:"progressbar","aria-valuenow":s,"aria-valuemin":1,"aria-valuemax":i,"aria-label":`Progresso: ${s} di ${i}`})})}),o.jsxs("div",{className:"event-wizard-stepper-info",children:[o.jsx("span",{className:"event-wizard-stepper-label",children:r}),o.jsxs("span",{className:"event-wizard-stepper-counter",children:[s," di ",i]}),n&&s>1&&o.jsxs("div",{className:"event-wizard-stepper-patient",children:[o.jsx("small",{className:"text-muted",children:"Paziente:"}),o.jsxs("strong",{children:[n.cognome," ",n.nome]})]})]}),o.jsx("div",{className:"event-wizard-stepper-dots d-md-none",children:ne.map((a,i)=>{const n=i+1,r=t(a);return o.jsx("div",{className:`event-wizard-stepper-dot ${a===e?"active":""} ${i<s-1?"completed":""}`,"aria-label":`Step ${n}: ${r}`},a)})})]})},oe=[{value:"batterico",label:"Batterico"},{value:"virale",label:"Virale"},{value:"fungino",label:"Fungino"},{value:"parassitario",label:"Parassitario"}],re={DESCRIPTION:4,NOTES:6},le={MOBILE_MAX:991},ce={PATIENT_SEARCH:300},de={PLACEHOLDER:"Cerca per nome, cognome o RAD...",HELP_TEXT:"Seleziona un paziente per continuare",SELECTED:(e,t)=>`Paziente selezionato: ${e} ${t}`},ve=({values:e,onChange:t,hasPatient:a=!0,selectedPatient:i=null,onSelectPatient:n,onPatientSelect:s})=>o.jsx("div",{className:"wizard-step","data-step":"event-type",children:o.jsxs("div",{className:"wizard-step-content",children:[!a&&o.jsxs(o.Fragment,{children:[o.jsx("h3",{className:"wizard-step-title",children:"Seleziona Paziente"}),o.jsxs("div",{className:"mb-4",children:[o.jsx(x,{value:i,onChange:e=>{n&&n(e?.id||""),s&&s(e)},placeholder:de.PLACEHOLDER,activeOnly:!1,maxResults:10,minSearchLength:1,debounceDelay:ce.PATIENT_SEARCH,showPatientInfo:!0,highlightMatch:!0}),i&&o.jsxs("div",{className:"alert alert-success mt-3",role:"alert",children:[o.jsx("i",{className:"bi bi-check-circle me-2"}),de.SELECTED(i.cognome,i.nome)]}),!i&&o.jsxs("div",{className:"alert alert-info mt-3",role:"alert",children:[o.jsx("i",{className:"bi bi-info-circle me-2"}),de.HELP_TEXT]})]}),!i&&o.jsx("div",{style:{marginBottom:"2rem"}})]}),(a||i)&&o.jsxs(o.Fragment,{children:[o.jsx("h3",{className:"wizard-step-title",children:"Tipo di Evento"}),o.jsx("p",{className:"wizard-step-description",children:"Seleziona il tipo di evento clinico da registrare"}),o.jsx("div",{className:"event-type-selection",children:o.jsxs("div",{className:"row g-3",children:[o.jsx("div",{className:"col-12",children:o.jsxs("div",{className:"event-type-card "+("intervento"===e.tipo_evento?"selected":""),onClick:()=>t({tipo_evento:"intervento"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t({tipo_evento:"intervento"}))},children:[o.jsx("div",{className:"event-type-card-icon",children:o.jsx("i",{className:"bi bi-heart-pulse"})}),o.jsxs("div",{className:"event-type-card-content",children:[o.jsx("h4",{className:"event-type-card-title",children:"Intervento Chirurgico"}),o.jsx("p",{className:"event-type-card-description",children:"Registra un intervento chirurgico eseguito sul paziente"})]}),o.jsx("div",{className:"event-type-card-radio",children:o.jsx("input",{type:"radio",name:"tipo_evento",value:"intervento",checked:"intervento"===e.tipo_evento,onChange:()=>t({tipo_evento:"intervento"}),className:"form-check-input"})})]})}),o.jsx("div",{className:"col-12",children:o.jsxs("div",{className:"event-type-card "+("infezione"===e.tipo_evento?"selected":""),onClick:()=>t({tipo_evento:"infezione"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t({tipo_evento:"infezione"}))},children:[o.jsx("div",{className:"event-type-card-icon",children:o.jsx("i",{className:"bi bi-virus"})}),o.jsxs("div",{className:"event-type-card-content",children:[o.jsx("h4",{className:"event-type-card-title",children:"Infezione"}),o.jsx("p",{className:"event-type-card-description",children:"Registra un'infezione contratta dal paziente"})]}),o.jsx("div",{className:"event-type-card-radio",children:o.jsx("input",{type:"radio",name:"tipo_evento",value:"infezione",checked:"infezione"===e.tipo_evento,onChange:()=>t({tipo_evento:"infezione"}),className:"form-check-input"})})]})})]})})]})]})}),pe=({values:e,onChange:t,errors:a,isSubmitting:i,tipiIntervento:n,agentiPatogeno:s,loadingTypes:r,loadingPatogens:l})=>{const c="intervento"===e.tipo_evento;return o.jsx("div",{className:"wizard-step","data-step":"event-details",children:o.jsxs("div",{className:"wizard-step-content",children:[o.jsx("h3",{className:"wizard-step-title",children:c?"Dettagli Intervento":"Dettagli Infezione"}),o.jsx("p",{className:"wizard-step-description",children:c?"Specifica il tipo di intervento e la descrizione":"Specifica l'agente patogeno e il tipo"}),o.jsxs(o.Fragment,c?{children:[o.jsxs("div",{className:"mb-3",children:[o.jsxs("label",{htmlFor:"tipo_intervento_id",className:"form-label",children:["Tipo Intervento ",o.jsx("span",{className:"text-danger",children:"*"})]}),o.jsxs("select",{id:"tipo_intervento_id",name:"tipo_intervento_id",className:"form-select "+(a?.tipo_intervento_id?"is-invalid":""),value:e.tipo_intervento_id?String(e.tipo_intervento_id):"",onChange:e=>{const a=e.target.value?parseInt(e.target.value,10):void 0;t({tipo_intervento_id:a})},disabled:i||r,required:!0,children:[o.jsx("option",{value:"",children:r?"Caricamento tipi intervento...":"Seleziona tipo intervento..."}),n.map(e=>o.jsx("option",{value:String(e.id),children:e.nome},e.id))]}),a?.tipo_intervento_id&&o.jsx("div",{className:"invalid-feedback",role:"alert",children:a.tipo_intervento_id})]}),o.jsxs("div",{className:"mb-3",children:[o.jsx("label",{htmlFor:"descrizione_intervento",className:"form-label",children:"Descrizione Dettagliata"}),o.jsx("textarea",{id:"descrizione_intervento",name:"descrizione_intervento",className:"form-control",value:e.descrizione_intervento||"",onChange:e=>t({descrizione_intervento:e.target.value}),disabled:i,rows:re.DESCRIPTION,placeholder:"Descrivere dettagliatamente l'intervento eseguito..."}),o.jsx("div",{className:"form-text",children:"Opzionale - Fornire una descrizione dettagliata della procedura"})]})]}:{children:[o.jsxs("div",{className:"mb-3",children:[o.jsxs("label",{htmlFor:"agente_patogeno_id",className:"form-label",children:["Agente Eziologico ",o.jsx("span",{className:"text-danger",children:"*"})]}),o.jsxs("select",{id:"agente_patogeno_id",name:"agente_patogeno_id",className:"form-select "+(a?.agente_patogeno_id?"is-invalid":""),value:e.agente_patogeno_id?String(e.agente_patogeno_id):"",onChange:e=>{const a=e.target.value?parseInt(e.target.value,10):void 0;t({agente_patogeno_id:a})},disabled:i||l,required:!0,children:[o.jsx("option",{value:"",children:l?"Caricamento agenti patogeno...":"Seleziona agente eziologico..."}),s.map(e=>o.jsx("option",{value:String(e.id),children:e.nome},e.id))]}),a?.agente_patogeno_id&&o.jsx("div",{className:"invalid-feedback",role:"alert",children:a.agente_patogeno_id}),o.jsx("div",{className:"form-text",children:"Selezionare l'agente responsabile dell'infezione"})]}),o.jsxs("div",{className:"mb-3",children:[o.jsx("label",{htmlFor:"tipo_patogeno",className:"form-label",children:"Tipo Patogeno"}),o.jsxs("select",{id:"tipo_patogeno",name:"tipo_patogeno",className:"form-select",value:e.tipo_patogeno||"",onChange:e=>t({tipo_patogeno:e.target.value}),disabled:i,children:[o.jsx("option",{value:"",children:"Seleziona tipo patogeno..."}),oe.map(e=>o.jsx("option",{value:e.value,children:e.label},e.value))]}),o.jsx("div",{className:"form-text",children:"Opzionale - Specificare la categoria del patogeno"})]})]})]})})},me=({values:e,onChange:t,errors:a,isSubmitting:i,showResolutionDate:n,setShowResolutionDate:s})=>{const r="intervento"===e.tipo_evento;return o.jsx("div",{className:"wizard-step","data-step":"dates",children:o.jsxs("div",{className:"wizard-step-content",children:[o.jsx("h3",{className:"wizard-step-title",children:"Date Evento"}),o.jsx("p",{className:"wizard-step-description",children:r?"Specifica quando √® stato eseguito l'intervento":"Specifica le date di inizio e fine dell'infezione"}),r?o.jsx("div",{className:"mb-3",children:o.jsx(l,{label:"Data Intervento",value:e.data_evento||"",onChange:e=>t({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:i,isInvalid:!!a?.data_evento,errorMessage:a?.data_evento})}):o.jsxs("div",{className:"row",children:[o.jsx("div",{className:"col-12 mb-3",children:o.jsx(l,{label:"Data Inizio",value:e.data_evento||"",onChange:e=>t({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:i,isInvalid:!!a?.data_evento,errorMessage:a?.data_evento})}),o.jsxs("div",{className:"col-12 mb-3",children:[o.jsxs("div",{className:"d-flex align-items-center mb-2 gap-2",children:[o.jsx("label",{htmlFor:"toggle_resolution",className:"form-label mb-0",children:"Data Fine"}),o.jsxs("div",{className:"form-check",children:[o.jsx("input",{className:"form-check-input",type:"checkbox",id:"toggle_resolution",checked:n,onChange:e=>{s(e.target.checked),e.target.checked||t({data_fine_evento:""})},disabled:i}),o.jsx("label",{className:"form-check-label",htmlFor:"toggle_resolution",children:"Infezione risolta"})]})]}),n&&o.jsx(l,{value:e.data_fine_evento||"",onChange:e=>t({data_fine_evento:e||""}),placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:i,isInvalid:!!a?.data_fine_evento,errorMessage:a?.data_fine_evento})]})]})]})})},he=({values:e,onChange:t,isSubmitting:a})=>{const i="intervento"===e.tipo_evento;return o.jsx("div",{className:"wizard-step","data-step":"notes",children:o.jsxs("div",{className:"wizard-step-content",children:[o.jsx("h3",{className:"wizard-step-title",children:"Note Aggiuntive"}),o.jsx("p",{className:"wizard-step-description",children:"Aggiungi informazioni o osservazioni rilevanti (opzionale)"}),o.jsxs("div",{className:"mb-3",children:[o.jsx("label",{htmlFor:"note",className:"form-label",children:i?"Note Aggiuntive":"Note Cliniche"}),o.jsx("textarea",{id:"note",name:"note",className:"form-control",value:e.note||"",onChange:e=>t({note:e.target.value}),disabled:a,rows:re.NOTES,placeholder:i?"Note aggiuntive sull'intervento...":"Sintomi, terapia, esami, decorso...","aria-describedby":"note-help"}),o.jsxs("div",{id:"note-help",className:"form-text",children:["Opzionale - ",i?"Informazioni aggiuntive sull'intervento":"Informazioni cliniche rilevanti"]})]})]})})},ue=({values:e,tipiIntervento:t,agentiPatogeno:a})=>{const i="intervento"===e.tipo_evento,n=s.useMemo(()=>t.find(t=>t.id===e.tipo_intervento_id)?.nome,[t,e.tipo_intervento_id]),r=s.useMemo(()=>a.find(t=>t.id===e.agente_patogeno_id)?.nome,[a,e.agente_patogeno_id]);return o.jsx("div",{className:"wizard-step","data-step":"review",children:o.jsxs("div",{className:"wizard-step-content",children:[o.jsx("h3",{className:"wizard-step-title",children:"Riepilogo"}),o.jsx("p",{className:"wizard-step-description",children:"Verifica i dati inseriti prima di salvare"}),o.jsxs("div",{className:"event-review-summary",children:[o.jsxs("div",{className:"alert alert-light",children:[o.jsx("h5",{className:"alert-heading",children:i?"Intervento Chirurgico":"Infezione"}),o.jsx("hr",{}),o.jsxs(o.Fragment,i?{children:[o.jsxs("div",{className:"review-item",children:[o.jsx("strong",{children:"Tipo Intervento:"})," ",o.jsx("span",{children:n||"Non specificato"})]}),e.descrizione_intervento&&o.jsxs("div",{className:"review-item",children:[o.jsx("strong",{children:"Descrizione:"})," ",o.jsx("span",{children:e.descrizione_intervento})]}),o.jsxs("div",{className:"review-item",children:[o.jsx("strong",{children:"Data Intervento:"})," ",o.jsx("span",{children:e.data_evento||"Non specificata"})]})]}:{children:[o.jsxs("div",{className:"review-item",children:[o.jsx("strong",{children:"Agente Eziologico:"})," ",o.jsx("span",{children:r||"Non specificato"})]}),e.tipo_patogeno&&o.jsxs("div",{className:"review-item",children:[o.jsx("strong",{children:"Tipo Patogeno:"})," ",o.jsx("span",{children:oe.find(t=>t.value===e.tipo_patogeno)?.label})]}),o.jsxs("div",{className:"review-item",children:[o.jsx("strong",{children:"Data Inizio:"})," ",o.jsx("span",{children:e.data_evento||"Non specificata"})]}),e.data_fine_evento&&o.jsxs("div",{className:"review-item",children:[o.jsx("strong",{children:"Data Fine:"})," ",o.jsx("span",{children:e.data_fine_evento})]})]}),e.note&&o.jsxs("div",{className:"review-item",children:[o.jsx("strong",{children:"Note:"})," ",o.jsx("span",{children:e.note})]})]}),o.jsxs("div",{className:"alert alert-info",children:[o.jsx("i",{className:"bi bi-info-circle me-2"}),"Verifica che tutti i dati siano corretti. Puoi tornare indietro per modificare qualsiasi campo prima di salvare."]})]})]})})},ge=["event-type","event-details","dates","notes","review"],_e={"event-type":"Tipo Evento","event-details":"Dettagli",dates:"Date",notes:"Note",review:"Riepilogo"},fe=({patientId:a,event:i,onSubmit:n,onCancel:l})=>{const c=!!i,d=((e="event-type")=>p({steps:ge,labels:_e,initialStep:e}))("event-type"),v=m({currentStep:d.currentStep,getStepLabel:d.getStepLabel,totalSteps:d.totalSteps,currentStepNumber:d.getStepNumber(d.currentStep),enabled:!1});h();const{patient:g}=b(a),{tipiIntervento:_,agentiPatogeno:f,loading:x}=(()=>{const{data:a,isLoading:i,error:n}=j({queryKey:["eventLookupTables"],queryFn:async()=>{try{const[t,a]=await Promise.all([T.getListaTipiIntervento(),T.getListaAgentiPatogeno()]);return e.info("Event lookup tables loaded successfully",{tipiCount:t.length,agentiCount:a.length}),{tipi:t,agenti:a}}catch(a){const i=a instanceof Error?a:new Error(String(a));throw e.error("Error loading event lookup tables",{error:i}),t("Impossibile caricare i dati. Riprova pi√π tardi.",{duration:5e3}),i}},staleTime:6e5}),o=a?.tipi||[],r=a?.agenti||[],l=s.useMemo(()=>new Map(o.map(e=>[e.id,e.nome])),[o]),c=s.useMemo(()=>new Map(r.map(e=>[e.id,e.nome])),[r]);return{tipiIntervento:o,agentiPatogeno:r,loading:i,error:n instanceof Error?n:null,tipiInterventoMap:l,agentiPatogeniMap:c}})(),[N,z]=s.useState(a||""),[y,w]=s.useState(g),[I,C]=s.useState({paziente_id:N,tipo_evento:i?.tipo_evento||"intervento",data_evento:i?.data_evento||"",tipo_intervento_id:i?.tipo_intervento_id??void 0,descrizione_intervento:i?.descrizione_intervento||"",agente_patogeno_id:i?.agente_patogeno_id??void 0,tipo_patogeno:i?.tipo_patogeno??void 0,data_fine_evento:i?.data_fine_evento||"",note:i?.note||""}),[S,D]=s.useState(!!i?.data_fine_evento),[E,k]=s.useState({}),[P,A]=s.useState(!1);r.useEffect(()=>{g&&w(g)},[g]);const R=e=>{z(e),C(t=>({...t,paziente_id:e}))},F=e=>{w(e)},$=e=>{C(t=>({...t,...e}));const t=Object.keys(e);t.some(e=>E[e])&&k(e=>{const a={...e};return t.forEach(e=>delete a[e]),a})},M=()=>{switch(d.currentStep){case"event-type":return!!N&&!!I.tipo_evento;case"event-details":return"intervento"===I.tipo_evento?!!I.tipo_intervento_id:"infezione"===I.tipo_evento&&!!I.agente_patogeno_id;case"dates":return!!I.data_evento;case"notes":case"review":return!0;default:return!1}};return o.jsxs("form",{onSubmit:async a=>{if(a.preventDefault(),!(()=>{const e={};if(!N)return e.paziente_id="Seleziona un paziente",k(e),!1;if(I.tipo_evento||(e.tipo_evento="Seleziona il tipo di evento"),"intervento"===I.tipo_evento&&(I.tipo_intervento_id||(e.tipo_intervento_id="Il tipo di intervento √® obbligatorio"),I.data_evento||(e.data_evento="La data dell'intervento √® obbligatoria")),"infezione"===I.tipo_evento){I.agente_patogeno_id||(e.agente_patogeno_id="Il tipo di batterio √® obbligatorio"),I.data_evento||(e.data_evento="La data di inizio infezione √® obbligatoria");const t=u(I.data_evento,S?I.data_fine_evento:void 0,"infezione");t&&(e.data_evento=t)}if("intervento"===I.tipo_evento){I.data_evento||(e.data_evento="La data dell'intervento √® obbligatoria");const t=u(I.data_evento,void 0,"intervento");t&&(e.data_evento=t)}return k(e),0===Object.keys(e).length})())return d.goToStep("event-type"),void 0;try{A(!0);const e={paziente_id:N,tipo_evento:I.tipo_evento,data_evento:I.data_evento,note:I.note};"intervento"===I.tipo_evento&&(e.tipo_intervento_id=I.tipo_intervento_id,e.descrizione_intervento=I.descrizione_intervento),"infezione"===I.tipo_evento&&(e.agente_patogeno_id=I.agente_patogeno_id,e.tipo_patogeno=I.tipo_patogeno,S&&(e.data_fine_evento=I.data_fine_evento)),await n(e)}catch(i){e.error("Errore durante il salvataggio del evento",{error:i}),t("Errore durante il salvataggio. Riprova pi√π tardi.",{duration:5e3}),A(!1)}},className:"wizard-form event-wizard-form",noValidate:!0,children:[o.jsxs("div",{className:"wizard-form-header",children:[o.jsx("button",{type:"button",className:"wizard-back-button",onClick:l,disabled:P,"aria-label":"Torna indietro",children:o.jsx("i",{className:"bi bi-arrow-left"})}),o.jsx("h1",{className:"wizard-form-title",children:c?"Modifica Evento":"Nuovo Evento"})]}),o.jsx(se,{currentStep:d.currentStep,getStepLabel:d.getStepLabel,getStepNumber:d.getStepNumber,totalSteps:d.totalSteps,selectedPatient:y}),o.jsx("div",{ref:v,className:"wizard-form-content",children:(()=>{const e=!!N,t={values:I,onChange:$,errors:E,isSubmitting:P};switch(d.currentStep){case"event-type":return o.jsx(ve,{...t,hasPatient:e,selectedPatient:y,onSelectPatient:R,onPatientSelect:F});case"event-details":return o.jsx(pe,{...t,tipiIntervento:_,agentiPatogeno:f,loadingTypes:x,loadingPatogens:x});case"dates":return o.jsx(me,{...t,showResolutionDate:S,setShowResolutionDate:D});case"notes":return o.jsx(he,{...t});case"review":return o.jsx(ue,{...t,tipiIntervento:_,agentiPatogeno:f,loadingTypes:x,loadingPatogens:x});default:return null}})()}),o.jsxs("div",{className:"wizard-form-actions",children:[d.canGoPrev&&o.jsxs("button",{type:"button",className:"btn btn-secondary btn-block",onClick:d.prevStep,disabled:P,children:[o.jsx("i",{className:"bi bi-chevron-left"})," Indietro"]}),"review"!==d.currentStep?o.jsxs("button",{type:"button",className:"btn btn-primary btn-block",onClick:d.nextStep,disabled:P||!M(),title:M()?void 0:"Completa i campi obbligatori per continuare",children:["Avanti ",o.jsx("i",{className:"bi bi-chevron-right"})]}):o.jsx("button",{type:"submit",className:"btn btn-success btn-block",disabled:P,children:o.jsxs(o.Fragment,P?{children:[o.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio..."]}:{children:[o.jsx("i",{className:"bi bi-check-circle me-2"}),c?"Aggiorna Evento":"Salva Evento"]})})]})]})},xe=()=>{const e=_(),a=N(),i=s.useMemo(()=>{if("undefined"==typeof window)return!1;const e=window.innerWidth<992;return console.log("üì± Mobile detection:",{width:window.innerWidth,breakpoint:992,isMobile:e}),e},[]);s.useEffect(()=>{const e=document.documentElement.style.scrollBehavior;document.documentElement.style.scrollBehavior="auto",window.scrollTo(0,0);const t=setTimeout(()=>{window.scrollTo(0,0)},100),a=setTimeout(()=>{window.scrollTo(0,0),document.documentElement.style.scrollBehavior=e},300);return()=>{clearTimeout(t),clearTimeout(a),document.documentElement.style.scrollBehavior=e}},[]);const[r,l]=s.useState(1),[d,v]=s.useState(10),[p,m]=s.useState(!1),[h,u]=s.useState("create"),[f,x]=s.useState(null),[b,y]=s.useState(!1),[w,I]=s.useState({title:"",body:"",onConfirm:()=>{}}),[C,S]=s.useState(!i),D=s.useCallback(()=>{S(e=>!e)},[]),{filters:E,updateFilters:k}=H({onFiltersChange:()=>l(1)}),P=s.useMemo(()=>["eventi",JSON.stringify(E),r,d],[E,r,d]),{data:A,isLoading:R,error:F}=j({queryKey:P,queryFn:()=>T.getAllEventi(E,{page:r,limit:d})}),{data:$,isLoading:M}=j({queryKey:["eventiStats"],queryFn:T.getEventiStats,initialData:{total:0,interventi:0,infezioni:0,ultimoMese:0}}),{data:q}=j({queryKey:["tipiIntervento"],queryFn:T.getListaTipiIntervento}),{data:O}=j({queryKey:["agentiPatogeni"],queryFn:T.getListaAgentiPatogeno}),K=s.useMemo(()=>q?L(q):new Map,[q]),B=s.useMemo(()=>O?L(O):new Map,[O]),{eventi:V=[],totalPages:W=1,totalCount:U=0}=A||{},G=s.useMemo(()=>{const e=new Map;return V.forEach(t=>{e.has(t.paziente_id)||e.set(t.paziente_id,t.pazienti)}),e},[V]),J=s.useMemo(()=>{let e=0;return(E.paziente_search||E.paziente_id)&&e++,E.tipo_evento&&E.tipo_evento.length>0&&e++,E.data_inizio&&e++,E.data_fine&&e++,e},[E]),Q={onSuccess:()=>{a.invalidateQueries({queryKey:["eventi"]}),a.invalidateQueries({queryKey:["eventiStats"]}),de()},onError:e=>{t(e.message||"Si √® verificato un errore")}},te=z({mutationFn:e=>T.createEvento(e),...Q,onSuccess:()=>{n("Evento creato con successo"),Q.onSuccess()}}),ae=z({mutationFn:e=>T.updateEvento(e.id,e.eventData),...Q,onSuccess:()=>{n("Evento aggiornato con successo"),Q.onSuccess()}}),ne=z({mutationFn:e=>T.deleteEvento(e),onSuccess:()=>{n("Evento eliminato con successo"),a.invalidateQueries({queryKey:["eventi"]}),a.invalidateQueries({queryKey:["eventiStats"]}),y(!1)},onError:Q.onError}),se=z({mutationFn:e=>T.resolveInfezione(e.id,e.dataFine),onSuccess:()=>{n("Infezione risolta con successo"),a.invalidateQueries({queryKey:["eventi"]}),y(!1)},onError:Q.onError}),oe=async e=>{"create"===h?await te.mutateAsync(e):f&&await ae.mutateAsync({id:f.id,eventData:e})},re=e=>{ve("Conferma Eliminazione","Sei sicuro di voler eliminare questo evento?",()=>{ne.mutate(e)})},le=e=>{const t=prompt("Inserisci la data di risoluzione (YYYY-MM-DD):");t&&ve("Conferma Risoluzione",`Sei sicuro di voler risolvere l'infezione in data ${t}?`,()=>{se.mutate({id:e,dataFine:t})})},ce=(t,a)=>{if(console.log("üî• handleOpenModal called:",{mode:t,event:a,isMobile:i}),"create"===t&&i)return e("/eventi-clinici/nuovo"),void 0;u(t),x(a||null),m(!0)},de=()=>{m(!1),x(null),u("create")};s.useEffect(()=>{p&&i&&requestAnimationFrame(()=>{window.scrollTo(0,0)})},[p,i]);const ve=(e,t,a)=>{I({title:e,body:t,onConfirm:a}),y(!0)};return o.jsxs(o.Fragment,{children:[o.jsx(g,{...w,isOpen:b,onCancel:()=>y(!1)}),o.jsxs("div",{className:"clinical-events-page",children:[o.jsx("div",{className:"patient-list-hero clinical-hero",children:o.jsxs("div",{className:"patient-list-hero-content",children:[o.jsxs("h1",{className:"patient-list-title",children:[o.jsx("span",{className:"material-icons me-2",children:"timeline"}),"Eventi Clinici"]}),o.jsx("p",{className:"patient-list-subtitle",children:"Gestisci eventi clinici, filtra per tipo e data, esporta i risultati"})]})}),F&&o.jsx("div",{className:"alert alert-danger",children:"Errore nel caricamento degli eventi. Riprova."}),o.jsx(X,{statistics:$,loading:M}),o.jsxs("section",{className:"patient-filters-card"+(i?" clinical-filters-collapsible":""),children:[o.jsxs("div",{className:"patient-filters-header",children:[o.jsxs("div",{className:"filters-title-wrapper",children:[o.jsx("span",{className:"material-icons","aria-hidden":"true",children:"filter_list"}),o.jsx("h2",{className:"filters-title",children:"Filtri Eventi"}),i&&J>0&&o.jsx("span",{className:"filters-active-count","aria-label":`${J} filtri attivi`,children:J})]}),i&&o.jsx("button",{type:"button",className:"filters-collapse-toggle",onClick:D,"aria-expanded":C,"aria-controls":"clinical-event-filters","aria-label":C?"Nascondi filtri eventi clinici":"Mostra filtri eventi clinici",children:o.jsx("span",{className:"material-icons","aria-hidden":"true",children:C?"expand_less":"expand_more"})})]}),o.jsx("div",{className:"patient-filters-body",id:"clinical-event-filters",hidden:i&&!C,children:o.jsx(Y,{initialFilters:E,onFiltersChange:k,compact:i,compactToggleOverride:i?{expanded:C,onToggle:D}:void 0})})]}),o.jsxs("section",{className:"patient-results-card",children:[o.jsx("div",{className:"patient-results-header",children:o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%"},children:[o.jsxs("h2",{className:"results-title",children:[o.jsx("span",{className:"material-icons",children:"list"}),"Eventi (",U,")"]}),o.jsxs(c,{variant:"clinical",onClick:()=>ce("create"),className:"btn-nuovo-evento",style:{padding:"0.65rem 1.5rem",fontSize:"1rem",fontWeight:"600",whiteSpace:"nowrap"},children:[o.jsx("span",{className:"material-icons align-middle",style:{marginRight:"0.5rem",fontSize:"1.3rem"},children:"add"}),"Nuovo Evento"]})]})}),o.jsx("div",{className:"patient-results-body",children:i?o.jsx(Z,{events:V,patients:G,loading:R,hasFilters:J>0,onEdit:e=>ce("edit",e),onDelete:re,onResolve:le,onCreateEvent:()=>ce("create"),tipiInterventoMap:K,agentiPatogeniMap:B,currentPage:r,totalPages:W,totalCount:U,onPageChange:l}):o.jsx(ee,{events:V,patients:G,loading:R,hasFilters:J>0,onEdit:e=>ce("edit",e),onDelete:re,onResolve:le,onCreateEvent:()=>ce("create"),currentPage:r,totalPages:W,pageSize:d,onPageChange:l,onPageSizeChange:v,tipiInterventoMap:K,agentiPatogeniMap:B})})]}),p&&i&&o.jsx("div",{className:"event-wizard-mobile-overlay",children:o.jsx(fe,{patientId:f?.paziente_id||"",event:f||void 0,onSubmit:oe,onCancel:de})}),p&&!i&&o.jsx("div",{className:"modal fade show",style:{display:"block"},tabIndex:-1,children:o.jsx("div",{className:"modal-dialog modal-lg",children:o.jsxs("div",{className:"modal-content",children:[o.jsxs("div",{className:"modal-header",children:[o.jsxs("div",{children:[o.jsx("h5",{className:"modal-title mb-1",children:"create"===h?"Nuovo Evento":"Modifica Evento"}),f&&G.get(f.paziente_id)&&o.jsxs("p",{className:"text-muted mb-0 small",children:[o.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"person"}),G.get(f.paziente_id)?.cognome," ",G.get(f.paziente_id)?.nome]})]}),o.jsx("button",{type:"button",className:"btn-close",onClick:de})]}),o.jsx("div",{className:"modal-body",children:o.jsx(ie,{event:f||void 0,patientId:f?.paziente_id||"",onSubmit:oe,onCancel:de,isSubmitting:te.isPending||ae.isPending})})]})})})]}),"    "]})},be=Object.freeze(Object.defineProperty({__proto__:null,EventsPage:xe,default:xe},Symbol.toStringTag,{value:"Module"}));const je=()=>{const t=function(){const e=_();return s.useCallback(t=>{if(e)return e(t),void 0;const a=t.startsWith("/")?t.slice(1):t;window.location.hash=a||"home"},[e])}(),[a]=f(),[i,r]=s.useState(!1),[l,c]=s.useState("");s.useEffect(()=>{const e=a.get("patientId");c(e||"")},[a]);const d=s.useCallback(async a=>{try{e.info("Creating new event",{data:a}),await T.createEvento(a),n("Evento creato con successo"),t("/eventi-clinici")}catch(i){throw e.error("Error submitting event form",i),i}},[t]),v=s.useCallback(()=>{t("/eventi-clinici")},[t]),p=((e=le.MOBILE_MAX)=>{const[t,a]=s.useState(()=>"undefined"!=typeof window&&window.innerWidth<e);return s.useEffect(()=>{const t=()=>{a(window.innerWidth<e)};return window.addEventListener("resize",t),()=>{window.removeEventListener("resize",t)}},[e]),t})();return o.jsxs("div",{className:"event-wizard-page-container",children:[p&&o.jsx(o.Fragment,{children:i?o.jsxs("div",{className:"text-center py-5",children:[o.jsx("div",{className:"spinner-border mb-3",role:"status",children:o.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),o.jsx("p",{className:"text-muted",children:"Caricamento dati evento in corso..."})]}):o.jsx(fe,{patientId:l,event:void 0,onSubmit:d,onCancel:v})}),!p&&o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"event-form-hero",children:o.jsx("div",{className:"event-form-hero-content",children:o.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-3",children:[o.jsxs("div",{children:[o.jsx("h1",{className:"event-form-title",children:i?"Caricamento...":"Nuovo Evento Clinico"}),o.jsx("p",{className:"event-form-subtitle",children:i?"Attendere il caricamento dei dati...":"Compila il form per aggiungere un nuovo evento clinico al sistema"})]}),o.jsxs("button",{type:"button",className:"event-form-back-button",onClick:v,disabled:i,"aria-label":"Torna alla lista eventi",children:[o.jsx("span",{className:"material-icons align-middle me-1",children:"arrow_back"}),o.jsx("span",{className:"back-button-text",children:"Torna agli eventi"})]})]})})}),o.jsx("div",{className:"row",children:o.jsx("div",{className:"col-12 col-lg-10 col-xl-8 mx-auto",children:o.jsxs("div",{className:"event-form-card",children:[o.jsx("div",{className:"event-form-card-header",children:o.jsxs("div",{className:"event-form-card-title-wrapper",children:[o.jsx("div",{className:"event-form-card-icon",children:o.jsx("span",{className:"material-icons",children:"add_circle"})}),o.jsx("h2",{className:"event-form-card-title",children:i?"Caricamento...":"Nuovo Evento"})]})}),o.jsx("div",{className:"event-form-card-body",children:o.jsxs("div",i?{className:"text-center py-5",children:[o.jsx("div",{className:"spinner-border mb-3",role:"status",children:o.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),o.jsx("p",{className:"text-muted",children:"Caricamento dati evento in corso..."})]}:{className:"text-center py-5",children:[o.jsxs("p",{className:"text-muted",children:["La versione desktop del form eventi √® in fase di sviluppo.",o.jsx("br",{}),"Utilizza la versione mobile per creare o modificare eventi."]}),o.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:v,children:[o.jsx("span",{className:"material-icons align-middle me-2",children:"arrow_back"}),"Torna agli eventi"]})]})})]})})})]})]})},Ne=Object.freeze(Object.defineProperty({__proto__:null,EventWizardPage:je,default:je},Symbol.toStringTag,{value:"Module"}));export{be as E,F as I,$ as a,Ne as b,M as c,T as e,O as g,q as p,E as r};
