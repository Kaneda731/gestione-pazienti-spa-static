const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/form-Bq_xW3WN.js","assets/supabase-AmyKTmiY.js","assets/CustomSelect--37MymX7.js","assets/CustomDatepicker-6By5cdaM.js","assets/utils-BtSsRyB2.js","assets/infectionDataManager-XVFwni5O.js","assets/post-operative-calculator-C3z7C_vm.js","assets/ResolveInfectionModal-CUpr2Rkl.js","assets/vendor-BU6HxVpN.js","assets/surgeryDataManager-CbtGeuzn.js","assets/lookupService-BTBnNs1X.js","assets/dimissione-De83lZfJ.js","assets/PatientAutocomplete-xEphiRd1.js","assets/patientService-DXycJ_5w.js","assets/formatting-C7G90sDQ.js","assets/grafico-CgY7Z70y.js","assets/helpers-DknIzt00.js","assets/list-tXaZAGdh.js","assets/diagnosi-D6aZBn3_.js","assets/eventi-clinici-C-yvKVJr.js"])))=>i.map(i=>d[i]);
import{c as e,_ as t}from"./supabase-AmyKTmiY.js";import{Collapse as i,Modal as n}from"./vendor-BU6HxVpN.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),t.credentials="use-credentials"===e.crossOrigin?"include":"anonymous"===e.crossOrigin?"omit":"same-origin",t}(e);fetch(e.href,t)}}();const o="Gestione Pazienti SPA",r="1.0.0",a="development"==="production",s="redirectUrl";const c=new class{sanitizeArgs(e){const t=new Set(["password","token","auth","secret","nome","cognome","codice_fiscale","codice_rad","telefono","email","indirizzo","indirizzo_residenza","citta","cap","note","descrizione"]),i=e=>{if(null==e)return e;if("string"==typeof e)return e.length>200?e.slice(0,200)+"â€¦":e;if(e instanceof Error)return{name:e.name,message:e.message};if(Array.isArray(e))return e.map(i);if("object"==typeof e){const n={};for(const[o,r]of Object.entries(e))n[o]=t.has(o)?"[REDACTED]":i(r);return n}return e};return e.map(i)}log(...e){}warn(...e){}error(...e){const t=this.sanitizeArgs(e);console.error(...t)}info(...e){}debug(...e){}group(e){}groupEnd(){}table(e){}time(e){}timeEnd(e){}};function l(){void window.addEventListener("error",e=>{if(["A listener indicated an asynchronous response by returning true","Extension context invalidated","Could not establish connection","chrome-extension://","moz-extension://"].some(t=>e.message&&e.message.includes(t)))return console.debug("Browser extension error ignored:",e.message),e.preventDefault(),!1;console.error("Application error:",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,error:e.error})}),window.addEventListener("unhandledrejection",e=>{const t=e.reason?.message||e.reason?.toString()||"";if(["A listener indicated an asynchronous response by returning true","message channel closed before a response was received","Extension context invalidated","Could not establish connection"].some(e=>t.includes(e)))return console.debug("Browser extension promise rejection ignored:",t),e.preventDefault(),void 0;console.error("Unhandled promise rejection:",e.reason)}),window.appLogger={info:(e,t=null)=>{c.log(`[APP] ${e}`,t||"")},warn:(e,t=null)=>{c.warn(`[APP WARNING] ${e}`,t||"")},error:(e,t=null)=>{console.error("[APP ERROR]",e,t||"")},debug:(e,t=null)=>{"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname||c.log(`[APP DEBUG] ${e}`,t||"")}},window.appLogger.info("Error service and logger initialized.",{timestamp:(new Date).toISOString()})}const d=e("https://aiguzywadjzyrwandgba.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZ3V6eXdhZGp6eXJ3YW5kZ2JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDM1MzQsImV4cCI6MjA2Njc3OTUzNH0.pezVt3-xxkHBYK2V6ryHUtj_givF_TA9xwEzuK2essw",{auth:{flowType:"pkce",detectSessionInUrl:!0,persistSession:!0,autoRefreshToken:!0,storage:window.localStorage,storageKey:"supabase.auth.token",debug:!1},global:{headers:{"X-Client-Info":"supabase-js-vite"}}}),u=Object.freeze(Object.defineProperty({__proto__:null,supabase:d},Symbol.toStringTag,{value:"Module"}));const m=new class{constructor(){this.readyPromise=new Promise(e=>{this.resolveReady=e}),this.init()}async init(){await this.waitForViteReady(),await this.waitForSupabaseReady(),this.notifyReady()}async waitForViteReady(){return new Promise(e=>{"complete"===document.readyState?(c.log("Vite Ã¨ pronto"),e()):window.addEventListener("load",()=>{setTimeout(()=>{c.log("Vite Ã¨ pronto (dopo load)"),e()},100)},{once:!0})})}async waitForSupabaseReady(){return new Promise(async e=>{try{await d.auth.getSession(),c.log("Supabase Ã¨ pronto"),e()}catch(t){console.error("Errore nell'inizializzazione Supabase:",t),this.clearCorruptedState(),setTimeout(async()=>{try{await d.auth.getSession(),c.log("Supabase Ã¨ pronto (dopo retry)"),e()}catch(t){console.error("Errore nel retry Supabase:",t),e()}},500)}})}clearCorruptedState(){c.log("Pulisco stato corrotto..."),["supabase.auth.token","sb-aiguzywadjzyrwandgba-auth-token"].forEach(e=>{localStorage.removeItem(e),sessionStorage.removeItem(e)}),document.cookie.split(";").forEach(e=>{const t=e.indexOf("="),i=t>-1?e.substr(0,t):e;(i.trim().includes("supabase")||i.trim().includes("sb-"))&&(document.cookie=i+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/")})}onReady(){return this.readyPromise}notifyReady(){c.log("Middleware Vite-Supabase pronto"),this.resolveReady()}};const h=new class{constructor(){this.isInitialized=!1,this.authState="idle",this.errorState=null,this.init()}async init(){if(!this.isInitialized){await new Promise(e=>{m.onReady(e)});try{const e=new URLSearchParams(window.location.search),t=new URLSearchParams(window.location.hash.substring(1));t.has("access_token")||t.has("refresh_token")||e.has("code")||t.has("error")?(c.log("Rilevato redirect OAuth con parametri reali, gestisco la sessione..."),this.authState="authenticating",await this.handleOAuthCallback()):c.log("Nessun parametro OAuth rilevato, inizializzazione normale"),this.isInitialized=!0}catch(e){console.error("Errore nell'inizializzazione OAuth:",e),this.errorState=e,this.authState="error"}}}async handleOAuthCallback(){try{c.log("Gestisco callback OAuth...");if(new URLSearchParams(window.location.search).has("code")){c.log("Rilevato parametro code, eseguo exchangeCodeForSession...");const{data:e,error:t}=await d.auth.exchangeCodeForSession(window.location.href);if(t)throw console.error("Errore in exchangeCodeForSession:",t),this.clearCorruptedState(),t;c.log("exchangeCodeForSession completato:",!!e?.session)}const{data:e,error:t}=await d.auth.getSession();if(t)throw console.error("Errore nel callback OAuth:",t),this.clearCorruptedState(),t;if(e.session){c.log("Sessione OAuth recuperata con successo"),this.authState="authenticated",this.cleanupOAuthUrl();const e=sessionStorage.getItem("redirectUrl");e?(sessionStorage.removeItem("redirectUrl"),window.location.hash=e):window.location.hash="#home"}return e.session}catch(e){throw console.error("Errore nella gestione del callback OAuth:",e),this.clearCorruptedState(),e}}clearCorruptedState(){c.log("Pulisco stato corrotto OAuth..."),m.clearCorruptedState(),this.cleanupOAuthUrl(),this.authState="idle",this.errorState=null}cleanupOAuthUrl(){if(window.location.hash.includes("access_token")||window.location.search.includes("code")){const e=window.location.hash.split("&")[0],t=window.location.pathname+(e&&"#"!==e?e:"");window.history.replaceState({},document.title,t),c.log("URL pulito da parametri OAuth, nuovo URL:",t)}}async signInWithGoogle(){try{await m.onReady(),"error"===this.authState&&(c.log("Stato di errore rilevato, pulisco..."),this.clearCorruptedState(),await new Promise(e=>setTimeout(e,100))),this.authState="authenticating";const e=window.location.origin+window.location.pathname+window.location.hash;c.log("Iniziando login OAuth con redirect:",e);const{data:t,error:i}=await d.auth.signInWithOAuth({provider:"google",options:{redirectTo:e,queryParams:{}}});if(i)throw console.error("Errore nella chiamata OAuth:",i),this.authState="error",this.errorState=i,i;return c.log("Login OAuth iniziato con successo:",t),{success:!0,data:t}}catch(e){return console.error("Errore completo nel login OAuth:",e),401===e.status&&(c.log("Errore 401 rilevato, pulisco stato corrotto..."),this.clearCorruptedState()),this.authState="error",this.errorState=e,{success:!1,error:e.message}}}getAuthState(){return{state:this.authState,error:this.errorState,isInitialized:this.isInitialized}}};let f={session:void 0,profile:null};async function p(e){if(e?.user){const t=await async function(e){if(!e)return null;try{const{data:t,error:i,status:n}=await d.from("profiles").select("username, full_name, role").eq("id",e.id).single();if(i&&406!==n)throw i;return t}catch(t){console.error("Errore nel recuperare il profilo utente:",t);try{const{data:t}=await d.rpc("get_user_role_safe",{user_uuid:e.id}),i=t||"editor";return console.info("âœ… Ruolo recuperato con funzione sicura:",i),{id:e.id,username:e.email?.split("@")[0]||"utente",full_name:e.user_metadata?.full_name||e.user_metadata?.name||e.email||"Utente",role:i,email:e.email,fallback:!0}}catch(i){return console.error("âŒ Errore nel recupero ruolo sicuro, uso fallback minimo:",i),null}}}(e.user);f.session=e,t?f.profile=t:(console.warn("âš ï¸ Profilo non disponibile, uso fallback per:",e.user.email),f.profile={id:e.user.id,username:e.user.email?.split("@")[0]||"utente",full_name:e.user.user_metadata?.full_name||e.user.user_metadata?.name||e.user.email||"Utente",role:"editor",email:e.user.email,fallback:!0})}else f.session=null,f.profile=null;try{window.dispatchEvent(new CustomEvent("auth:session-changed",{detail:{session:e}}))}catch(t){}window.dispatchEvent(new CustomEvent("auth-profile-loaded"))}async function g(){try{const{error:e}=await d.auth.signOut();if(e)throw e;return{success:!0}}catch(e){return console.error("Errore durante il signOut:",e),{success:!1,error:e.message}}}function y(){!function(){const e=document.getElementById("theme-toggle"),t=document.getElementById("theme-icon");if(!e||!t)return;v(localStorage.getItem("theme")||"light"),e.addEventListener("click",()=>{v("dark"===(document.documentElement.getAttribute("data-bs-theme")||"light")?"light":"dark")})}(),function(){const e=document.getElementById("mobile-theme-toggle"),t=document.getElementById("mobile-theme-icon");if(!e||!t)return;function i(){"dark"===(document.documentElement.getAttribute("data-bs-theme")||"light")?(t.textContent="light_mode",e.setAttribute("title","ModalitÃ  chiara")):(t.textContent="dark_mode",e.setAttribute("title","ModalitÃ  scura"))}e.addEventListener("click",e=>{e.preventDefault();v("dark"===(document.documentElement.getAttribute("data-bs-theme")||"light")?"light":"dark")});new MutationObserver(i).observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]}),i()}()}function v(e){document.documentElement.setAttribute("data-bs-theme",e),localStorage.setItem("theme",e);const t=document.getElementById("theme-icon"),i=document.getElementById("theme-toggle");t&&i&&("dark"===e?(t.textContent="light_mode",i.setAttribute("title","ModalitÃ  chiara")):(t.textContent="dark_mode",i.setAttribute("title","ModalitÃ  scura")))}const w=new class{constructor(){this.errorPatterns=["message channel closed before a response was received","A listener indicated an asynchronous response by returning true, but the message channel closed before a response was received","Extension context invalidated","Could not establish connection","The message port closed before a response was received","Receiving end does not exist","chrome-extension://","moz-extension://","safari-extension://","edge-extension://"],this.suppressedErrors=new Set,this.errorCount=0,this.maxErrorsToLog=5,this.init()}init(){window.addEventListener("error",this.handleError.bind(this)),window.addEventListener("unhandledrejection",this.handleRejection.bind(this)),this.interceptExtensionListeners()}isExtensionError(e,t=""){if(!e)return!1;const i=e.toString().toLowerCase(),n=t.toString().toLowerCase();return this.errorPatterns.some(e=>i.includes(e.toLowerCase())||n.includes(e.toLowerCase()))}handleError(e){const{message:t,filename:i}=e;return!this.isExtensionError(t,i)||(this.suppressExtensionError(e,"JavaScript Error"),void 0)}handleRejection(e){const t=e.reason;let i="";return t instanceof Error?i=t.message:"string"==typeof t?i=t:t&&t.toString&&(i=t.toString()),!this.isExtensionError(i)||(this.suppressExtensionError(e,"Promise Rejection"),void 0)}suppressExtensionError(e,t){e.preventDefault(),e.stopPropagation();const i=`${t}:${e.message||e.reason}`;return!this.suppressedErrors.has(i)&&this.errorCount<this.maxErrorsToLog&&(console.warn("[ExtensionErrorHandler] Errore di estensione soppresso:",t,{message:e.message||e.reason,filename:e.filename,type:t}),this.suppressedErrors.add(i),this.errorCount++),!1}interceptExtensionListeners(){"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onMessage&&this.wrapChromeListeners(),"undefined"!=typeof browser&&browser.runtime&&browser.runtime.onMessage&&this.wrapFirefoxListeners(),this.wrapPostMessage()}wrapChromeListeners(){const e=chrome.runtime.onMessage.addListener;chrome.runtime.onMessage.addListener=function(t){return e.call(this,function(e,i,n){try{const o=t(e,i,n);if(!0===o){const e=setTimeout(()=>{try{n({_extensionErrorHandlerResponse:!0})}catch(e){}},100),t=n;n=function(...i){clearTimeout(e);try{return t(...i)}catch(n){}}}return o}catch(o){return console.warn("[ExtensionErrorHandler] Errore nel message listener:",o),!1}})}}wrapFirefoxListeners(){const e=browser.runtime.onMessage.addListener;browser.runtime.onMessage.addListener=function(t){return e.call(this,function(e,i,n){try{return t(e,i,n)}catch(o){return console.warn("[ExtensionErrorHandler] Errore nel message listener Firefox:",o),Promise.resolve()}})}}wrapPostMessage(){const e=window.postMessage;window.postMessage=function(t,i,n){try{return e.call(this,t,i,n)}catch(o){if(this.isExtensionError(o.message))return console.warn("[ExtensionErrorHandler] Errore postMessage di estensione soppresso:",o),void 0;throw o}}.bind(this)}getStats(){return{suppressedErrorTypes:this.suppressedErrors.size,totalErrorCount:this.errorCount,maxErrorsToLog:this.maxErrorsToLog}}resetStats(){this.suppressedErrors.clear(),this.errorCount=0}};"undefined"!=typeof window&&(window.extensionErrorHandler=w),"undefined"!=typeof window&&(window.bootstrap={Modal:n,Collapse:i});const b=new class{getDefaultAnimationSetting(){try{return"undefined"==typeof window||!window.matchMedia||!window.matchMedia("(prefers-reduced-motion: reduce)").matches}catch(e){return!0}}constructor(){this.state={currentView:"home",previousView:null,editPazienteId:null,selectedPazienteId:null,listFilters:{reparto:"",diagnosi:"",stato:"",infetto:"",search:"",page:0,sortColumn:"data_ricovero",sortDirection:"desc"},eventiCliniciFilters:{paziente_search:"",tipo_evento:"",data_da:"",data_a:"",reparto:"",agente_patogeno:"",tipo_intervento:"",sortColumn:"data_evento",sortDirection:"desc"},formData:{},isLoading:!1,loadingMessage:"",errors:[],notifications:[],notificationSettings:{maxVisible:5,defaultDuration:5e3,position:"top-right",enableSounds:!1,enableAnimations:this.getDefaultAnimationSetting(),autoCleanupInterval:3e5,maxStoredNotifications:50,persistentTypes:["error"],soundVolume:.5,customDurations:{success:4e3,info:5e3,warning:6e3,error:0}},user:null,isAuthenticated:!1},this.subscribers=new Map,this.persistentKeys=["listFilters","editPazienteId","formData","eventiCliniciFilters","notificationSettings"],this.cleanupTimer=null,this.loadPersistedState(),this.startAutoCleanup()}loadPersistedState(){try{this.persistentKeys.forEach(e=>{const t=localStorage.getItem(`app_state_${e}`);t&&(this.state[e]=JSON.parse(t))})}catch(e){c.warn("Errore durante il caricamento dello stato persistente:",e)}}persistState(){try{this.persistentKeys.forEach(e=>{null!=this.state[e]&&localStorage.setItem(`app_state_${e}`,JSON.stringify(this.state[e]))})}catch(e){c.warn("Errore durante il salvataggio dello stato persistente:",e)}}getState(e){return e?this.state[e]:{...this.state}}setState(e,t){const i="string"==typeof e?{[e]:t}:e,n={...this.state};void 0===i.notifications||Array.isArray(i.notifications)||(console.warn("âš ï¸ StateService: notifications must be an array, got:",typeof i.notifications),i.notifications=[]),Object.assign(this.state,i);const o=Object.keys(i);o.some(e=>this.persistentKeys.includes(e))&&this.persistState(),this.notifySubscribers(o,n)}subscribe(e,t){const i=Array.isArray(e)?e:[e],n=Symbol("subscriber");return this.subscribers.set(n,{keys:i,callback:t}),()=>{this.subscribers.delete(n)}}notifySubscribers(e,t){this.subscribers.forEach(({keys:i,callback:n},o)=>{if(i.some(t=>e.includes(t)))try{const r=n(this.state,t,e);r&&"function"==typeof r.then&&r.catch(r=>{console.error(`Errore async in subscriber callback [${n.name||"(anonymous)"}] (subscriberId: ${String(o)}):`,r,"\nchangedKeys:",e,"\nsubscriber keys:",i,"\ncurrent state:",this.state,"\nold state:",t,"\ncallback:",n.toString())})}catch(r){console.error(`Errore in subscriber callback [${n.name||"(anonymous)"}] (subscriberId: ${String(o)}):`,r,"\nchangedKeys:",e,"\nsubscriber keys:",i,"\ncurrent state:",this.state,"\nold state:",t,"\ncallback:",n.toString())}})}clearState(e=["user","isAuthenticated"]){this.stopAutoCleanup();const t={};e.forEach(e=>{void 0!==this.state[e]&&(t[e]=this.state[e])});const i={currentView:"home",previousView:null,editPazienteId:null,selectedPazienteId:null,listFilters:{reparto:"",diagnosi:"",stato:"",infetto:"",search:"",page:0,sortColumn:"data_ricovero",sortDirection:"desc"},eventiCliniciFilters:{paziente_search:"",tipo_evento:"",data_da:"",data_a:"",reparto:"",agente_patogeno:"",tipo_intervento:"",sortColumn:"data_evento",sortDirection:"desc"},formData:{},isLoading:!1,loadingMessage:"",errors:[],notifications:[],notificationSettings:{maxVisible:5,defaultDuration:5e3,position:"top-right",enableSounds:!1,enableAnimations:this.getDefaultAnimationSetting(),autoCleanupInterval:3e5,maxStoredNotifications:50,persistentTypes:["error"],soundVolume:.5,customDurations:{success:4e3,info:5e3,warning:6e3,error:0}},user:null,isAuthenticated:!1};this.state={...i,...t},this.persistentKeys.forEach(t=>{e.includes(t)||localStorage.removeItem(`app_state_${t}`)}),e.includes("notificationSettings")&&this.startAutoCleanup()}setEditPatient(e){this.setState("editPazienteId",e)}getEditPatientId(){return this.getState("editPazienteId")}clearEditPatient(){this.setState("editPazienteId",null)}updateFilters(e){this.setState("listFilters",{...this.getState("listFilters"),...e})}getFilters(){return this.getState("listFilters")}resetFilters(){this.setState("listFilters",{reparto:"",diagnosi:"",stato:"",infetto:"",search:"",page:0,sortColumn:"data_ricovero",sortDirection:"desc"})}setFormData(e){this.setState("formData",e)}getFormData(){return this.getState("formData")}clearFormData(){this.setState("formData",{})}setLoading(e,t=""){this.setState({isLoading:e,loadingMessage:t})}addNotification(e,t,i={}){"number"==typeof i&&(i={duration:i});const n={maxVisible:5,defaultDuration:5e3,position:"top-right",enableSounds:!1,enableAnimations:!0,autoCleanupInterval:3e5,maxStoredNotifications:50,persistentTypes:["error"],soundVolume:.5,customDurations:{success:4e3,info:5e3,warning:6e3,error:0},...this.getState("notificationSettings")},o=n.customDurations&&void 0!==n.customDurations[e]?n.customDurations[e]:n.defaultDuration,r={id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:e,message:t,timestamp:new Date,isVisible:!0,isRemoving:!1,options:{duration:o,persistent:n.persistentTypes.includes(e),closable:!0,position:n.position,priority:0,...i}};r.options.persistent&&(r.options.duration=0);const a=this.getState("notifications");c.debug(`[StateService] Current notifications before adding: ${a.length}`,a);let s=[...a,r];if(s.length>n.maxStoredNotifications){c.warn(`[StateService] Max stored notifications (${n.maxStoredNotifications}) exceeded. Trimming old notifications.`);const e=s.sort((e,t)=>new Date(e.timestamp)-new Date(t.timestamp)).slice(0,s.length-n.maxStoredNotifications);s=s.filter(t=>!e.includes(t)||t.options.persistent&&"error"===t.type),c.debug(`[StateService] Notifications after trimming: ${s.length}`,s)}return this.setState("notifications",s),c.debug(`[StateService] Notification added. New notifications array length: ${this.getState("notifications").length}`,this.getState("notifications")),r.id}removeNotification(e){const t=this.getState("notifications");c.debug("[StateService] Notifiche prima della rimozione:",t);const i=t.filter(t=>t.id!==e);this.setState("notifications",i);const n=this.getState("notifications");c.debug("[StateService] Notifiche dopo la rimozione:",n)}updateNotificationSettings(e){const t={...this.getState("notificationSettings"),...e};this.setState("notificationSettings",t),void 0!==e.autoCleanupInterval&&this.startAutoCleanup()}getNotificationSettings(){return this.getState("notificationSettings")}clearAllNotifications(){this.setState("notifications",[])}clearNotificationsByType(e){const t=this.getState("notifications").filter(t=>t.type!==e);this.setState("notifications",t)}clearOldNotifications(e=3e5){const t=new Date,i=this.getState("notifications"),n=i.filter(i=>{const n=t-new Date(i.timestamp);return!(!i.options.persistent||"error"!==i.type)||n<e});return this.setState("notifications",n),i.length-n.length}markNotificationRemoving(e){const t=this.getState("notifications").map(t=>t.id===e?{...t,isRemoving:!0}:t);this.setState("notifications",t)}getNotificationsByType(e){return this.getState("notifications").filter(t=>t.type===e)}getVisibleNotifications(){return this.getState("notifications").filter(e=>e.isVisible&&!e.isRemoving)}countNotificationsByType(e){return this.getNotificationsByType(e).length}hasErrorNotifications(){return this.countNotificationsByType("error")>0}startAutoCleanup(){this.cleanupTimer&&clearInterval(this.cleanupTimer);const e=this.getState("notificationSettings");this.cleanupTimer=setInterval(()=>{const t=this.clearOldNotifications(e.autoCleanupInterval);t>0&&c.debug(`Cleanup automatico: rimosse ${t} notifiche vecchie`)},e.autoCleanupInterval)}stopAutoCleanup(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null)}getNotificationStats(){const e=this.getState("notifications");return{total:e.length,visible:e.filter(e=>e.isVisible&&!e.isRemoving).length,byType:{success:e.filter(e=>"success"===e.type).length,error:e.filter(e=>"error"===e.type).length,warning:e.filter(e=>"warning"===e.type).length,info:e.filter(e=>"info"===e.type).length},persistent:e.filter(e=>e.options.persistent).length,oldest:e.length>0?Math.min(...e.map(e=>new Date(e.timestamp).getTime())):null,newest:e.length>0?Math.max(...e.map(e=>new Date(e.timestamp).getTime())):null}}exportNotificationSettings(){return{settings:this.getState("notificationSettings"),timestamp:(new Date).toISOString(),version:"1.0"}}importNotificationSettings(e){try{return!("1.0"!==e.version||!e.settings)&&(this.updateNotificationSettings(e.settings),!0)}catch(t){return c.error("Errore durante importazione impostazioni notifiche:",t),!1}}setCurrentView(e,t=null){this.setState({currentView:e,previousView:t||this.getState("currentView")})}getCurrentView(){return this.getState("currentView")}setUser(e){this.setState({user:e,isAuthenticated:!!e})}getUser(){return this.getState("user")}isAuthenticated(){return this.getState("isAuthenticated")}updateEventiCliniciFilters(e){this.setState("eventiCliniciFilters",{...this.getState("eventiCliniciFilters"),...e})}getEventiCliniciFilters(){return this.getState("eventiCliniciFilters")}resetEventiCliniciFilters(){this.setState("eventiCliniciFilters",{paziente_search:"",tipo_evento:"",data_da:"",data_a:"",reparto:"",agente_patogeno:"",tipo_intervento:"",sortColumn:"data_evento",sortDirection:"desc"})}destroy(){this.stopAutoCleanup(),this.subscribers.clear(),this.persistentKeys.forEach(e=>{localStorage.removeItem(`app_state_${e}`)})}},E=Object.freeze(Object.defineProperty({__proto__:null,stateService:b},Symbol.toStringTag,{value:"Module"}));class S{static DEBUG=!1;static notificationQueue=[];static isDOMReady=!1;static domReadyCallbacks=[];static animationSupport=null;static reducedMotionPreference=null;static errorCounts={render:0,animation:0,dom:0,service:0,total:0};static init(){this.checkDOMReady(),this.checkAnimationSupport(),this.checkReducedMotionPreference(),this.setupErrorRecovery()}static handleRenderError(e,t,i=null){this.errorCounts.render++,this.errorCounts.total++,console.error("âŒ Notification render error:",e,t),"undefined"!=typeof window&&window.appLogger&&window.appLogger.error("Notification render failed",{error:e.message,notificationId:t?.id,notificationType:t?.type,stack:e.stack});try{return i&&"function"==typeof i?i(t):this.createSimpleFallback(t)}catch(n){return console.error("âŒ Fallback renderer also failed:",n),this.showConsoleFallback(t),null}}static handleAnimationError(e,t,i="unknown"){if(this.errorCounts.animation++,this.errorCounts.total++,t)try{t.style.animation="none",t.style.transition="none","entrance"===i?(t.style.opacity="1",t.style.transform="translateX(0)",t.classList.add("notification--visible"),t.classList.remove("notification--entering")):"exit"===i&&(t.style.opacity="0",t.classList.add("notification--hidden"),t.classList.remove("notification--exiting"))}catch(n){console.error("âŒ Animation fallback failed:",n)}}static handleServiceError(e,t,i=null){this.errorCounts.service++,this.errorCounts.total++,this.errorCounts.service%10==1&&console.error(`âŒ NotificationService error in ${t} (${this.errorCounts.service} total):`,e),"undefined"!=typeof window&&window.appLogger&&window.appLogger.error(`NotificationService ${t} failed`,{error:e.message,operation:t,data:i,stack:e.stack});try{switch(t){case"show":this.recoverFromShowError(i);break;case"remove":this.recoverFromRemoveError(i);break;case"clear":this.recoverFromClearError();break;case"init":this.recoverFromInitError()}}catch(n){console.error("âŒ Error recovery failed:",n)}}static handleDOMError(e,t,i=null){return this.errorCounts.dom++,this.errorCounts.total++,console.error(`âŒ DOM error in ${t}:`,e),!(!this.isDOMReady&&"render"===t)||(console.log("ðŸ“‹ DOM not ready, queueing notification"),!1)}static queueNotification(e,t){if(this.isDOMReady)try{return e(t)}catch(i){return this.handleRenderError(i,t)}return this.notificationQueue.push({renderFunction:e,notification:t,timestamp:Date.now()}),null}static processNotificationQueue(){if(!this.isDOMReady||0===this.notificationQueue.length)return;console.log(`ðŸš€ Processing ${this.notificationQueue.length} queued notifications`);const e=[...this.notificationQueue];this.notificationQueue=[],e.forEach(({renderFunction:e,notification:t,timestamp:i})=>{try{if(Date.now()-i>3e4)return console.warn("âš ï¸ Skipping old queued notification:",t?.id),void 0;e(t)}catch(n){this.handleRenderError(n,t)}})}static createSimpleFallback(e){const t=document.createElement("div");t.className=`notification notification--${e.type} notification--fallback`,t.setAttribute("data-id",e.id),t.setAttribute("role","error"===e.type?"alert":"status"),t.setAttribute("aria-live","error"===e.type?"assertive":"polite"),t.style.cssText="\n            position: relative;\n            padding: 12px 16px;\n            margin: 8px 0;\n            border-radius: 4px;\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            font-size: 14px;\n            line-height: 1.4;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n            max-width: 400px;\n            word-wrap: break-word;\n        ";const i={success:{bg:"#d4edda",text:"#155724",border:"#c3e6cb"},error:{bg:"#f8d7da",text:"#721c24",border:"#f5c6cb"},warning:{bg:"#fff3cd",text:"#856404",border:"#ffeaa7"},info:{bg:"#d1ecf1",text:"#0c5460",border:"#bee5eb"}},n=i[e.type]||i.info;t.style.backgroundColor=n.bg,t.style.color=n.text,t.style.border=`1px solid ${n.border}`;const o=document.createElement("div");o.style.cssText="display: flex; align-items: flex-start; gap: 8px;";const r=document.createElement("span");r.style.cssText="flex-shrink: 0; font-weight: bold; font-size: 16px;";const a={success:"âœ“",error:"âœ•",warning:"âš ",info:"â„¹"};r.textContent=a[e.type]||a.info;const s=document.createElement("div");if(s.style.cssText="flex: 1; min-width: 0;",e.title){const t=document.createElement("div");t.style.cssText="font-weight: bold; margin-bottom: 4px;",t.textContent=e.title,s.appendChild(t)}const c=document.createElement("div");c.textContent=e.message||`Notifica ${e.type||"info"} - Messaggio non disponibile`,s.appendChild(c);const l=document.createElement("button");return l.style.cssText=`\n            background: none;\n            border: none;\n            font-size: 18px;\n            cursor: pointer;\n            padding: 0;\n            margin-left: 8px;\n            color: ${n.text};\n            opacity: 0.7;\n            flex-shrink: 0;\n        `,l.textContent="Ã—",l.setAttribute("aria-label","Chiudi notifica"),l.onclick=()=>{t.remove();try{window.stateService&&"function"==typeof window.stateService.removeNotification&&window.stateService.removeNotification(e.id)}catch(i){console.debug("Could not remove from state:",i)}},o.appendChild(r),o.appendChild(s),o.appendChild(l),t.appendChild(o),t}static showConsoleFallback(e){const t={success:"âœ…",error:"âŒ",warning:"âš ï¸",info:"â„¹ï¸"},i=`${t[e.type]||t.info} NOTIFICATION: ${e.message||`Notifica ${e.type||"info"} - Messaggio non disponibile`}`;"error"===e.type?console.error(i):"warning"===e.type?console.warn(i):console.log(i)}static checkDOMReady(){if("undefined"==typeof document)return this.isDOMReady=!1,void 0;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.isDOMReady=!0,this.processNotificationQueue(),this.domReadyCallbacks.forEach(e=>{try{e()}catch(t){console.error("âŒ DOM ready callback error:",t)}}),this.domReadyCallbacks=[]}):this.isDOMReady=!0}static checkAnimationSupport(){if("undefined"==typeof window||"undefined"==typeof document)return this.animationSupport=!1,void 0;try{const e=document.createElement("div");e.style.animation="test 1s",this.animationSupport=""!==e.style.animation}catch(e){this.animationSupport=!1}this.DEBUG&&console.log("ðŸŽ¬ Animation support:",this.animationSupport)}static checkReducedMotionPreference(){if("undefined"==typeof window||!window.matchMedia)return this.reducedMotionPreference=!1,void 0;try{const e=window.matchMedia("(prefers-reduced-motion: reduce)");this.reducedMotionPreference=e.matches,e.addEventListener("change",e=>{this.reducedMotionPreference=e.matches})}catch(e){this.reducedMotionPreference=!1}this.DEBUG&&console.log("ðŸŽ¬ Reduced motion preference:",this.reducedMotionPreference)}static setupErrorRecovery(){setInterval(()=>{this.cleanupOldQueuedNotifications()},6e4),"undefined"!=typeof window&&window.addEventListener("error",e=>{e.message&&e.message.includes("notification")&&console.warn("âš ï¸ Possible notification-related error detected")})}static cleanupOldQueuedNotifications(){const e=Date.now(),t=this.notificationQueue.length;this.notificationQueue=this.notificationQueue.filter(t=>e-t.timestamp<6e4);const i=t-this.notificationQueue.length;i>0&&this.DEBUG&&console.log(`ðŸ§¹ Cleaned up ${i} old queued notifications`)}static recoverFromShowError(e){console.log("ðŸ”„ Attempting recovery from show error");try{const t=this.createSimpleFallback(e);if(t){const e=document.querySelector(".notification-container")||document.querySelector("#notification-container")||document.body;if(e)return e.appendChild(t),!0}}catch(t){console.error("âŒ Show recovery failed:",t)}return this.showConsoleFallback(e),!1}static recoverFromRemoveError(e){console.log("ðŸ”„ Attempting recovery from remove error");try{const t=document.querySelector(`[data-id="${e}"]`);if(t)return t.remove(),!0}catch(t){console.error("âŒ Remove recovery failed:",t)}return!1}static recoverFromClearError(){console.log("ðŸ”„ Attempting recovery from clear error");try{const e=document.querySelectorAll('.notification, [class*="notification"]');return e.forEach(e=>{try{e.remove()}catch(t){console.debug("Could not remove notification element:",t)}}),!0}catch(e){console.error("âŒ Clear recovery failed:",e)}return!1}static recoverFromInitError(){console.log("ðŸ”„ Attempting recovery from init error");try{let e=document.querySelector(".notification-container");if(!e)return e=document.createElement("div"),e.className="notification-container notification-container--fallback",e.style.cssText="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    z-index: 9999;\n                    pointer-events: none;\n                ",document.body.appendChild(e),!0}catch(e){console.error("âŒ Init recovery failed:",e)}return!1}static getErrorStats(){return{...this.errorCounts,queueSize:this.notificationQueue.length,isDOMReady:this.isDOMReady,animationSupport:this.animationSupport,reducedMotionPreference:this.reducedMotionPreference}}static resetErrorStats(){this.errorCounts={render:0,animation:0,dom:0,service:0,total:0}}static shouldDisableAnimations(){return!this.animationSupport||this.reducedMotionPreference}static onDOMReady(e){if(this.isDOMReady)try{e()}catch(t){console.error("âŒ DOM ready callback error:",t)}else this.domReadyCallbacks.push(e)}}"undefined"!=typeof window&&S.init();class _{constructor(){this.listeners=new Map,this.globalListeners=new Set,this.abortControllers=new Map,this.cleanupCallbacks=new Set,this.setupGlobalCleanup()}setupGlobalCleanup(){if("undefined"==typeof window||"undefined"==typeof document)return;const e=()=>this.cleanupAll();window.addEventListener("beforeunload",e),window.addEventListener("pagehide",e),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState?this.pauseAllTimers():this.resumeAllTimers()}),this.globalCleanupHandler=e}addEventListener(e,t,i,n={}){if(!e||"function"!=typeof i)return console.warn("Invalid element or handler for addEventListener"),void 0;this.abortControllers.has(e)||this.abortControllers.set(e,new AbortController);const o={...n,signal:this.abortControllers.get(e).signal},r=n=>{try{i(n)}catch(o){console.error("Error in notification event handler:",o),this.removeEventListener(e,t,i)}};return e.addEventListener(t,r,o),this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add({type:t,handler:r,originalHandler:i,options:o}),r}removeEventListener(e,t,i){if(!e||!this.listeners.has(e))return;const n=this.listeners.get(e);for(const o of n)if(o.type===t&&(o.originalHandler===i||o.handler===i)){e.removeEventListener(t,o.handler,o.options),n.delete(o);break}0===n.size&&this.cleanupElement(e)}removeAllListeners(e){e&&(this.abortControllers.has(e)&&(this.abortControllers.get(e).abort(),this.abortControllers.delete(e)),this.listeners.delete(e))}cleanupElement(e){e&&(this.removeAllListeners(e),e.dataset&&(delete e.dataset.notificationId,delete e.dataset.eventManagerTracked),this.cleanupElementTimers(e))}addGlobalListener(e,t,i,n={}){const o=e=>{try{i(e)}catch(t){console.error("Error in global notification event handler:",t)}};return e.addEventListener(t,o,n),this.globalListeners.add({target:e,type:t,handler:o,originalHandler:i,options:n}),o}removeGlobalListener(e,t,i){for(const n of this.globalListeners)if(n.target===e&&n.type===t&&(n.originalHandler===i||n.handler===i)){e.removeEventListener(t,n.handler,n.options),this.globalListeners.delete(n);break}}addCleanupCallback(e){"function"==typeof e&&this.cleanupCallbacks.add(e)}removeCleanupCallback(e){this.cleanupCallbacks.delete(e)}cleanupAll(){for(const[t]of this.listeners)this.cleanupElement(t);for(const t of this.globalListeners)t.target.removeEventListener(t.type,t.handler,t.options);this.globalListeners.clear();for(const t of this.cleanupCallbacks)try{t()}catch(e){console.error("Error in cleanup callback:",e)}this.listeners.clear(),this.abortControllers.clear(),this.cleanupCallbacks.clear()}pauseAllTimers(){window.notificationTimerManager&&window.notificationTimerManager.pauseAll()}resumeAllTimers(){window.notificationTimerManager&&window.notificationTimerManager.resumeAll()}cleanupElementTimers(e){if(!e||!e.dataset.notificationId)return;window.notificationTimerManager&&window.notificationTimerManager.clearTimer(e.dataset.notificationId),e.getAnimations&&e.getAnimations().forEach(e=>{e.cancel()})}setupEventDelegation(e){e&&"undefined"!=typeof window&&(this.addEventListener(e,"click",e=>{const t=e.target.closest(".notification__close");if(t){const e=t.closest(".notification");e&&e.dataset.id&&this.handleNotificationClose(e.dataset.id)}const i=e.target.closest(".notification__action-btn");if(i){const e=i.closest(".notification"),t=i.dataset.actionIndex;e&&void 0!==t&&this.handleNotificationAction(e.dataset.id,parseInt(t))}}),this.addEventListener(e,"keydown",e=>{const t=e.target.closest(".notification");if(t)switch(e.key){case"Escape":e.preventDefault(),this.handleNotificationClose(t.dataset.id);break;case"Enter":case" ":(e.target.classList.contains("notification__close")||e.target.classList.contains("notification__action-btn"))&&(e.preventDefault(),e.target.click())}}),"ontouchstart"in window&&this.setupTouchDelegation(e))}setupTouchDelegation(e){let t=null,i=null,n=null;this.addEventListener(e,"touchstart",e=>{const o=e.target.closest(".notification");if(!o)return;const r=e.touches[0];t=r.clientX,i=r.clientY,n=Date.now(),o.classList.add("notification--touched")},{passive:!0}),this.addEventListener(e,"touchmove",e=>{const n=e.target.closest(".notification");if(!n||!t)return;const o=e.touches[0],r=o.clientX-t,a=Math.abs(o.clientY-i);Math.abs(r)>30&&a<50&&(n.style.transform=`translateX(${r}px)`,Math.abs(r)>100&&n.classList.add("notification--swipe-threshold"))},{passive:!0}),this.addEventListener(e,"touchend",e=>{const o=e.target.closest(".notification");if(o){if(o.classList.remove("notification--touched","notification--swipe-threshold"),t&&n){const i=e.changedTouches[0].clientX-t,r=Date.now()-n;Math.abs(i)>100&&r<500?this.handleNotificationClose(o.dataset.id):o.style.transform=""}t=null,i=null,n=null}},{passive:!0})}handleNotificationClose(e){window.notificationService&&window.notificationService.removeNotification(e)}handleNotificationAction(e,t){window.notificationService&&window.notificationService.handleAction&&window.notificationService.handleAction(e,t)}getStats(){return{elementsTracked:this.listeners.size,totalListeners:Array.from(this.listeners.values()).reduce((e,t)=>e+t.size,0),globalListeners:this.globalListeners.size,abortControllers:this.abortControllers.size,cleanupCallbacks:this.cleanupCallbacks.size}}destroy(){this.cleanupAll(),this.globalCleanupHandler&&(window.removeEventListener("beforeunload",this.globalCleanupHandler),window.removeEventListener("pagehide",this.globalCleanupHandler))}}const A=new _,C=Object.freeze(Object.defineProperty({__proto__:null,NotificationEventManager:_,notificationEventManager:A},Symbol.toStringTag,{value:"Module"}));class T{constructor(){this.activeAnimations=new Map,this.animationQueue=[],this.isProcessing=!1,this.rafId=null,this.performanceMonitor={frameCount:0,lastFrameTime:0,averageFPS:60,droppedFrames:0},this.supportsWebAnimations="animate"in document.createElement("div"),this.supportsWillChange="undefined"!=typeof CSS&&CSS.supports&&CSS.supports("will-change","transform"),this.prefersReducedMotion="undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.init()}init(){window.matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",e=>{this.prefersReducedMotion=e.matches,e.matches&&this.disableAllAnimations()}),this.startPerformanceMonitoring()}animateEntrance(e,t={}){if(!e||this.prefersReducedMotion)return this.applyFinalState(e,"visible"),Promise.resolve();const i={duration:300,easing:"cubic-bezier(0.34, 1.56, 0.64, 1)",direction:t.direction||"right",...t};return this.prepareForAnimation(e),this.supportsWebAnimations?this.animateWithWebAPI(e,"entrance",i):this.animateWithCSS(e,"entrance",i)}animateExit(e,t={}){if(!e)return Promise.resolve();if(this.prefersReducedMotion)return e.style.opacity="0",Promise.resolve();const i={duration:300,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",direction:t.direction||"right",...t};return this.prepareForAnimation(e),this.supportsWebAnimations?this.animateWithWebAPI(e,"exit",i):this.animateWithCSS(e,"exit",i)}animateStackShift(e,t,i,n={}){if(!e||this.prefersReducedMotion||t===i)return e.style.transform=`translateY(${i}px)`,Promise.resolve();const o={duration:200,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",...n};this.prepareForAnimation(e);const r=[{transform:`translateY(${t}px)`},{transform:`translateY(${i}px)`}];return this.supportsWebAnimations?e.animate(r,{duration:o.duration,easing:o.easing,fill:"forwards"}).finished:this.animateWithRAF(e,r,o)}prepareForAnimation(e){e&&(this.supportsWillChange?e.style.willChange="transform, opacity":e.style.transform=e.style.transform||"translateZ(0)",e.style.backfaceVisibility="hidden",e.style.perspective="1000px")}cleanupAfterAnimation(e){if(!e)return;this.supportsWillChange&&(e.style.willChange="auto");const t=e.style.transform;t&&!t.includes("translate")&&(e.style.transform=""),this.activeAnimations.delete(e)}animateWithWebAPI(e,t,i){const n=this.getKeyframes(t,i),o=e.animate(n,{duration:i.duration,easing:i.easing,fill:"forwards"});return this.activeAnimations.set(e,{animation:o,type:t,startTime:performance.now()}),o.addEventListener("finish",()=>{this.cleanupAfterAnimation(e),"entrance"===t&&this.applyFinalState(e,"visible")}),o.addEventListener("cancel",()=>{this.cleanupAfterAnimation(e)}),o.finished}animateWithCSS(e,t,i){return new Promise(n=>{const o="notification--"+("entrance"===t?"entering":"exiting");e.classList.add(o),this.activeAnimations.set(e,{type:t,startTime:performance.now(),className:o});const r=i=>{i.target===e&&(e.removeEventListener("animationend",r),e.removeEventListener("animationcancel",r),e.classList.remove(o),this.cleanupAfterAnimation(e),"entrance"===t&&this.applyFinalState(e,"visible"),n())};e.addEventListener("animationend",r),e.addEventListener("animationcancel",r),setTimeout(()=>{this.activeAnimations.has(e)&&r({target:e})},i.duration+100)})}animateWithRAF(e,t,i){return new Promise(n=>{const o=performance.now(),r=this.parseKeyframe(t[0]),a=this.parseKeyframe(t[t.length-1]),s=t=>{const c=Math.min((t-o)/i.duration,1),l=this.applyEasing(c,i.easing);this.interpolateAndApply(e,r,a,l),c<1?requestAnimationFrame(s):(this.cleanupAfterAnimation(e),n())};this.activeAnimations.set(e,{type:"raf",startTime:o,rafId:requestAnimationFrame(s)})})}getKeyframes(e,t){const i=window.innerWidth<=767;switch(e){case"entrance":if(i)return[{transform:"translateY(-100%)",opacity:0},{transform:"translateY(0)",opacity:1}];return[{transform:`translateX(${"left"===t.direction?"-100%":"100%"})`,opacity:0},{transform:"translateX(0)",opacity:1}];case"exit":if(i)return[{transform:"translateY(0)",opacity:1},{transform:"translateY(-100%)",opacity:0}];return[{transform:"translateX(0)",opacity:1},{transform:`translateX(${"left"===t.direction?"-100%":"100%"})`,opacity:0}];default:return[{opacity:0},{opacity:1}]}}applyFinalState(e,t){if(e)switch(t){case"visible":e.style.opacity="1",e.style.transform="translateX(0) translateY(0)",e.classList.add("notification--visible"),e.classList.remove("notification--entering","notification--exiting");break;case"hidden":e.style.opacity="0",e.classList.remove("notification--visible","notification--entering"),e.classList.add("notification--exiting")}}disableAllAnimations(){for(const[e,t]of this.activeAnimations)t.animation&&t.animation.cancel&&t.animation.cancel(),t.rafId&&cancelAnimationFrame(t.rafId),t.className&&e.classList.remove(t.className),this.applyFinalState(e,"visible");this.activeAnimations.clear()}cancelAnimation(e){if(!this.activeAnimations.has(e))return;const t=this.activeAnimations.get(e);t.animation&&t.animation.cancel&&t.animation.cancel(),t.rafId&&cancelAnimationFrame(t.rafId),t.className&&e.classList.remove(t.className),this.cleanupAfterAnimation(e)}startPerformanceMonitoring(){let e=performance.now();const t=i=>{const n=1e3/(i-e);this.performanceMonitor.frameCount++,this.performanceMonitor.lastFrameTime=i,this.performanceMonitor.frameCount%60==0&&(this.performanceMonitor.averageFPS=(this.performanceMonitor.averageFPS+n)/2,n<50&&this.performanceMonitor.droppedFrames++,this.performanceMonitor.averageFPS<45&&this.optimizeForLowPerformance()),e=i,this.rafId=requestAnimationFrame(t)};this.rafId=requestAnimationFrame(t)}optimizeForLowPerformance(){this.defaultDuration=Math.max(.7*this.defaultDuration,150),this.complexAnimationsEnabled=!1,this.essentialAnimationsOnly=!0}parseKeyframe(e){const t={};if(e.transform){const i=e.transform.match(/translate[XY]?\(([^)]+)\)/);i&&(t.transform=i[1])}return void 0!==e.opacity&&(t.opacity=parseFloat(e.opacity)),t}applyEasing(e,t){if("string"==typeof t&&t.startsWith("cubic-bezier"))return e;switch(t){case"ease-in":return e*e;case"ease-out":return 1-Math.pow(1-e,2);case"ease-in-out":return e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2;default:return e}}interpolateAndApply(e,t,i,n){if(void 0!==t.opacity&&void 0!==i.opacity){e.style.opacity=t.opacity+(i.opacity-t.opacity)*n}t.transform&&i.transform&&(e.style.transform=i.transform)}getPerformanceStats(){return{...this.performanceMonitor,activeAnimations:this.activeAnimations.size,supportsWebAnimations:this.supportsWebAnimations,supportsWillChange:this.supportsWillChange,prefersReducedMotion:this.prefersReducedMotion}}destroy(){this.disableAllAnimations(),this.rafId&&cancelAnimationFrame(this.rafId),this.activeAnimations.clear()}}const N=new T,L=Object.freeze(Object.defineProperty({__proto__:null,NotificationAnimationManager:T,notificationAnimationManager:N},Symbol.toStringTag,{value:"Module"}));const M=new class{constructor(){this.loadedModules=new Map,this.loadingPromises=new Map,this.preloadQueue=[],this.lazyElements=new Set,this.criticalComponents=new Set(["NotificationService","NotificationRenderer"]),this.config={preloadDelay:2e3,intersectionThreshold:.1,enablePreloading:!0,enableIntersectionObserver:"undefined"!=typeof window&&"IntersectionObserver"in window},this.init()}init(){this.config.enablePreloading&&setTimeout(()=>{this.preloadNonCriticalComponents()},this.config.preloadDelay),this.config.enableIntersectionObserver?this.setupIntersectionObserver():"undefined"!=typeof window&&"undefined"!=typeof document&&(this._fallbackScanHandler=this.scanLazyElements.bind(this),window.addEventListener("scroll",this._fallbackScanHandler,{passive:!0}),window.addEventListener("resize",this._fallbackScanHandler),setTimeout(()=>this.scanLazyElements(),0))}async loadModule(e,t){if(this.loadedModules.has(e))return this.loadedModules.get(e);if(this.loadingPromises.has(e))return this.loadingPromises.get(e);const i=this.performModuleLoad(e,t);this.loadingPromises.set(e,i);try{const t=await i;return this.loadedModules.set(e,t),this.loadingPromises.delete(e),t}catch(n){throw this.loadingPromises.delete(e),n}}async performModuleLoad(e,i){const n=performance.now();try{let o;switch(e){case"NotificationAnimationManager":o=await t(()=>Promise.resolve().then(()=>L),void 0);break;case"NotificationEventManager":o=await t(()=>Promise.resolve().then(()=>C),void 0);break;case"NotificationSoundManager":o=await t(()=>import("./notificationSoundManager-C0nx5Rbo.js"),[]);break;case"NotificationPersistence":o=await t(()=>import("./notificationPersistence-RoJthKjZ.js"),[]);break;case"NotificationVirtualScroller":o=await t(()=>import("./notificationVirtualScroller-D252q0dr.js"),[]);break;case"NotificationBatchRenderer":o=await t(()=>import("./notificationBatchRenderer-_D2mKYrp.js"),[]);break;case"NotificationRenderer":o=await t(()=>Promise.resolve().then(()=>U),void 0);break;default:o=await import(i)}const r=performance.now()-n;return this.trackLoadingPerformance(e,r),o}catch(o){return this.loadFallback(e)}}async preloadNonCriticalComponents(){const e=[{name:"NotificationVirtualScroller",path:"./notificationVirtualScroller.js",condition:()=>this.shouldPreloadVirtualScroller()},{name:"NotificationAnimationManager",path:"./notificationAnimationManager.js",condition:()=>!window.matchMedia("(prefers-reduced-motion: reduce)").matches},{name:"NotificationEventManager",path:"./notificationEventManager.js",condition:()=>!0},{name:"NotificationSoundManager",path:"./notificationSoundManager.js",condition:()=>this.shouldPreloadSounds()},{name:"NotificationPersistence",path:"./notificationPersistence.js",condition:()=>"localStorage"in window}];for(const t of e)t.condition()&&this.preloadQueue.push(t);await this.processBatchPreload()}async processBatchPreload(){for(;this.preloadQueue.length>0;){const e=this.preloadQueue.splice(0,2).map(e=>this.loadModule(e.name,e.path).catch(t=>(console.warn(`Preload failed for ${e.name}:`,t),null)));await Promise.all(e),await this.sleep(100)}}setupIntersectionObserver(){this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&this.handleElementVisible(e.target)})},{threshold:this.config.intersectionThreshold,rootMargin:"50px"})}async handleElementVisible(e){const t=e.dataset.lazyComponent;if(t)try{await this.loadComponentForElement(e,t),this.intersectionObserver.unobserve(e)}catch(i){console.error("Failed to load component for visible element:",i)}}async loadComponentForElement(e,t){const i={"advanced-animations":{module:"NotificationAnimationManager",path:"./notificationAnimationManager.js"},"virtual-scroller":{module:"NotificationVirtualScroller",path:"./notificationVirtualScroller.js"},"sound-effects":{module:"NotificationSoundManager",path:"./notificationSoundManager.js"}}[t];if(!i)return;const n=await this.loadModule(i.module,i.path);n&&n.default&&"function"==typeof n.default.init&&n.default.init(e)}async loadNotificationContainer(e={}){return"virtual"===this.determineContainerType(e)?this.loadModule("NotificationVirtualContainer","../../../shared/components/notifications/NotificationVirtualContainer.js"):this.loadModule("NotificationContainer","../../../shared/components/notifications/NotificationContainer.js")}determineContainerType(e){return e.expectedNotifications>10||navigator.deviceMemory&&navigator.deviceMemory<4?"virtual":"standard"}async loadOptimizedRenderer(e=0){return e>20?this.loadModule("NotificationBatchRenderer","./notificationBatchRenderer.js"):this.loadModule("NotificationRenderer","./notificationRenderer.js")}shouldPreloadVirtualScroller(){if(navigator.deviceMemory&&navigator.deviceMemory<4)return!0;const e=localStorage.getItem("notification_history");if(e)try{return JSON.parse(e).length>50}catch(t){return!1}return!1}shouldPreloadSounds(){return"Audio"in window&&!navigator.userAgent.includes("Mobile")&&!window.matchMedia("(prefers-reduced-motion: reduce)").matches}async loadFallback(e){const t={NotificationAnimationManager:()=>({animateEntrance:e=>(e.style.opacity="1",Promise.resolve()),animateExit:e=>(e.style.opacity="0",Promise.resolve()),destroy:()=>{}}),NotificationVirtualScroller:()=>({setNotifications:()=>{},destroy:()=>{}}),NotificationSoundManager:()=>({playSound:()=>{},destroy:()=>{}})}[e];if(t)return console.warn(`Using fallback for ${e}`),{default:t()};throw new Error(`No fallback available for ${e}`)}trackLoadingPerformance(e,t){this.performanceStats||(this.performanceStats=new Map),this.performanceStats.set(e,{loadTime:t,timestamp:Date.now(),cached:this.loadedModules.has(e)})}observeElement(e,t){e&&(e.dataset.lazyComponent=t,this.intersectionObserver?this.intersectionObserver.observe(e):(this.lazyElements.add(e),this.scanLazyElements()))}unobserveElement(e){this.intersectionObserver&&e?this.intersectionObserver.unobserve(e):e&&this.lazyElements.delete(e)}scanLazyElements(){if(0===this.lazyElements.size)return;const e="undefined"!=typeof window?window.innerHeight:0;Math.max(0,Math.min(1,this.config.intersectionThreshold||0))*e;for(const i of Array.from(this.lazyElements))if(i&&i.isConnected)try{const t=i.getBoundingClientRect();t.top<e+50&&t.bottom>-50&&(this.handleElementVisible(i),this.lazyElements.delete(i))}catch(t){this.lazyElements.delete(i)}else this.lazyElements.delete(i)}async preloadForFeature(e){const t={"advanced-notifications":["NotificationAnimationManager","NotificationSoundManager"],"bulk-notifications":["NotificationVirtualScroller","NotificationBatchRenderer"],"persistent-notifications":["NotificationPersistence","NotificationStorage"]}[e];if(!t)return;const i=t.map(t=>this.loadModule(t,this.getModulePath(t)).catch(i=>(console.warn(`Failed to preload ${t} for ${e}:`,i),null)));await Promise.all(i)}getModulePath(e){return{NotificationAnimationManager:"./notificationAnimationManager.js",NotificationVirtualScroller:"./notificationVirtualScroller.js",NotificationSoundManager:"./notificationSoundManager.js",NotificationBatchRenderer:"./notificationBatchRenderer.js",NotificationPersistence:"./notificationPersistence.js",NotificationStorage:"./notificationStorage.js"}[e]||`./${e.toLowerCase()}.js`}sleep(e){return new Promise(t=>setTimeout(t,e))}getStats(){return{loadedModules:Array.from(this.loadedModules.keys()),loadingPromises:Array.from(this.loadingPromises.keys()),preloadQueueSize:this.preloadQueue.length,performanceStats:this.performanceStats?Object.fromEntries(this.performanceStats):{},config:this.config}}destroy(){this.intersectionObserver&&this.intersectionObserver.disconnect(),"undefined"!=typeof window&&this._fallbackScanHandler&&(window.removeEventListener("scroll",this._fallbackScanHandler),window.removeEventListener("resize",this._fallbackScanHandler),this._fallbackScanHandler=null),this.preloadQueue=[];for(const[t,i]of this.loadedModules)if(i.default&&"function"==typeof i.default.destroy)try{i.default.destroy()}catch(e){console.warn(`Error destroying module ${t}:`,e)}this.loadedModules.clear(),this.loadingPromises.clear()}},x={SUCCESS:{icon:"check_circle",ariaRole:"status",ariaLive:"polite",defaultDuration:4e3},ERROR:{icon:"error",ariaRole:"alert",ariaLive:"assertive",defaultDuration:0},WARNING:{icon:"warning",ariaRole:"alert",ariaLive:"assertive",defaultDuration:6e3},INFO:{icon:"info",ariaRole:"status",ariaLive:"polite",defaultDuration:5e3}},I={maxWidth:768};function R(e,t){if(void 0!==t)return t;const i=x[e.toUpperCase()];return i?i.defaultDuration:5e3}function D(){if(document.getElementById("notification-announcer"))return;const e=document.createElement("div");e.id="notification-announcer",e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.style.cssText="\n        position: absolute;\n        left: -10000px;\n        width: 1px;\n        height: 1px;\n        overflow: hidden;\n    ",document.body.appendChild(e)}function k(e,t){const i=document.getElementById("notification-announcer");i&&(i.textContent=`${e}: ${t}`)}function O(e,t,{removeNotification:i}){const n=e.querySelector(".notification__close");n&&n.addEventListener("click",e=>{e.stopPropagation(),i(t.id)}),e.addEventListener("keydown",e=>{"Escape"===e.key&&(e.preventDefault(),i(t.id))})}function P(e,t,{pauseAutoCloseTimer:i}){let n=0;e.addEventListener("touchstart",()=>{n=Date.now()}),e.addEventListener("touchend",()=>{Date.now()-n>500&&i?.(t.id)})}function z(e,t,i,n){if(e.has(t)){const i=e.get(t);clearTimeout(i.timerId)}const o=Date.now(),r=setTimeout(()=>{e.delete(t),n(t)},i);e.set(t,{timerId:r,originalDuration:i,startTime:o,remainingTime:i,isPaused:!1,pausedAt:null,callback:n})}function F(e,t){const i=e.get(t);i&&!i.isPaused&&(clearTimeout(i.timerId),i.isPaused=!0,i.pausedAt=Date.now(),i.remainingTime=i.remainingTime-(i.pausedAt-i.startTime))}function V(e,t){const i=e.get(t);i&&i.isPaused&&(i.isPaused=!1,i.startTime=Date.now(),i.timerId=setTimeout(()=>{e.delete(t),i.callback&&i.callback(t)},i.remainingTime))}function B(e,t,i){const n=e.get(t);if(n){clearTimeout(n.timerId),e.delete(t);try{"function"==typeof i&&i(t)}catch(o){console.warn("Timer onStop callback error:",o)}console.log(`â¹ï¸ Timer stopped for notification: ${t}`)}}class ${constructor(e,t=4e3,i="success"){this.element=e,this.duration=t,this.type=i,this.startTime=null,this.animationId=null,this.isPaused=!1,this.pausedTime=0,this.isDestroyed=!1,this.timing=this.createEasingFunction("linear"),this.init()}createEasingFunction(e="linear"){const t={linear:e=>e,easeOut:e=>1-Math.pow(1-e,3),easeIn:e=>Math.pow(e,3),easeInOut:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2};return t[e]||t.linear}init(){if(this.isDestroyed)return;const e=this.element.querySelector(".notification__progress--js-placeholder");e?this.replaceProgressBarPlaceholder(e):this.element.querySelector(".notification__progress")||this.createProgressBar(),this.progressBar=this.element.querySelector(".notification__progress"),this.progressFill=this.element.querySelector(".notification__progress-fill"),this.progressBar&&this.progressFill&&this.start()}replaceProgressBarPlaceholder(e){e.classList.remove("notification__progress--js-placeholder"),e.classList.add("notification__progress--js-controlled"),e.setAttribute("aria-valuenow","100");const t={success:"rgba(16, 185, 129, 0.2)",error:"rgba(239, 68, 68, 0.2)",warning:"rgba(245, 158, 11, 0.2)",info:"rgba(6, 182, 212, 0.2)"};e.style.cssText=`\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: ${t[this.type]||t.info};\n            border-radius: 0 0 8px 8px;\n            overflow: hidden;\n            opacity: 1;\n            z-index: 10;\n            will-change: transform;\n        `;const i=document.createElement("div");i.className="notification__progress-fill";const n={success:"linear-gradient(90deg, #10b981, #34d399)",error:"linear-gradient(90deg, #ef4444, #f87171)",warning:"linear-gradient(90deg, #f59e0b, #fbbf24)",info:"linear-gradient(90deg, #06b6d4, #22d3ee)"};i.style.cssText=`\n            position: absolute;\n            top: 0;\n            left: 0;\n            height: 100%;\n            width: 100%;\n            background: ${n[this.type]||n.info};\n            opacity: 0.9;\n            transform-origin: left;\n            transform: scaleX(1);\n            transition: none;\n            will-change: transform;\n            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);\n        `,e.innerHTML="",e.appendChild(i)}createProgressBar(){const e={success:"rgba(16, 185, 129, 0.2)",error:"rgba(239, 68, 68, 0.2)",warning:"rgba(245, 158, 11, 0.2)",info:"rgba(6, 182, 212, 0.2)"},t={success:"linear-gradient(90deg, #10b981, #34d399)",error:"linear-gradient(90deg, #ef4444, #f87171)",warning:"linear-gradient(90deg, #f59e0b, #fbbf24)",info:"linear-gradient(90deg, #06b6d4, #22d3ee)"},i=document.createElement("div");i.className="notification__progress notification__progress--js-controlled",i.setAttribute("role","progressbar"),i.setAttribute("aria-label","Tempo rimanente prima della chiusura automatica"),i.setAttribute("aria-valuemin","0"),i.setAttribute("aria-valuemax","100"),i.setAttribute("aria-valuenow","100"),i.style.cssText=`\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: ${e[this.type]||e.info};\n            border-radius: 0 0 8px 8px;\n            overflow: hidden;\n            opacity: 1;\n            z-index: 10;\n            will-change: transform;\n        `;const n=document.createElement("div");n.className="notification__progress-fill",n.style.cssText=`\n            position: absolute;\n            top: 0;\n            left: 0;\n            height: 100%;\n            width: 100%;\n            background: ${t[this.type]||t.info};\n            opacity: 0.9;\n            transform-origin: left;\n            transform: scaleX(1);\n            transition: none;\n            will-change: transform;\n            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);\n        `,i.appendChild(n),this.element.appendChild(i)}start(){this.isDestroyed||(this.startTime=performance.now(),this.lastLoggedProgress=-1,this.animate({timing:this.timing,draw:e=>this.draw(e),duration:this.duration}))}animate({timing:e,draw:t,duration:i}){if(this.isDestroyed)return;const n=this.startTime,o=r=>{if(this.isDestroyed)return;if(this.isPaused)return this.animationId=requestAnimationFrame(o),void 0;let a=(r-n-this.pausedTime)/i;a>1&&(a=1),a<0&&(a=0);let s=e(a);t(s),this.updateAccessibility(a),a<1?this.animationId=requestAnimationFrame(o):this.onComplete()};this.animationId=requestAnimationFrame(o)}draw(e){if(this.isDestroyed||!this.progressFill)return;this.progressFill.style.transform=`scaleX(${1-e})`}updateAccessibility(e){if(this.progressBar){const t=Math.round(100*(1-e));this.progressBar.setAttribute("aria-valuenow",t.toString())}}pause(){this.isPaused||this.isDestroyed||(this.isPaused=!0,this.pauseStartTime=performance.now())}resume(){this.isPaused&&!this.isDestroyed&&(this.isPaused=!1,this.pauseStartTime&&(this.pausedTime+=performance.now()-this.pauseStartTime,this.pauseStartTime=null))}stop(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.progressFill&&!this.isDestroyed&&(this.progressFill.style.transform="scaleX(0)")}onComplete(){if(this.isDestroyed)return;const e=new CustomEvent("progressComplete",{detail:{element:this.element,type:this.type,duration:this.duration}});this.element.dispatchEvent(e)}destroy(){this.isDestroyed=!0,this.stop(),this.progressBar&&this.progressBar.parentNode&&this.progressBar.parentNode.removeChild(this.progressBar),this.element=null,this.progressBar=null,this.progressFill=null}}function j(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function H({notification:e,index:t=0,settings:i,timers:n,removeNotification:o,startAutoCloseTimer:r,pauseAutoCloseTimer:a,resumeAutoCloseTimer:s,announceNotification:l,attachNotificationEvents:d,attachTouchEvents:u,notificationContainer:m,errorHandler:h=S}){try{const t=x[e.type.toUpperCase()]||x.INFO,b=e.options||{},E=document.createElement("div");if(E.className=`notification notification--${e.type}`,E.dataset.id=e.id,E.setAttribute("role",t.ariaRole),E.setAttribute("aria-live",t.ariaLive),E.setAttribute("aria-atomic","true"),E.setAttribute("tabindex","0"),i.enableAnimations&&!h.shouldDisableAnimations())try{E.classList.add("notification--entering"),E.addEventListener("animationend",e=>{(e.animationName.includes("slideIn")||e.animationName.includes("fadeIn"))&&(E.classList.remove("notification--entering"),E.classList.add("notification--visible"))}),E.addEventListener("animationerror",e=>{h.handleAnimationError(new Error("Animation failed"),E,"entrance")})}catch(f){h.handleAnimationError(f,E,"entrance")}else E.classList.add("notification--visible","notification--no-animations");let S="";try{S=`\n                <div class="notification__content">\n                    <span class="material-icons notification__icon" aria-hidden="true">${t.icon}</span>\n                    <div class="notification__body">\n                        ${b.title?`<div class="notification__title">${j(b.title)}</div>`:""}\n                        <div class="notification__message">${j(e.message)}</div>\n                    </div>\n                </div>\n            `,(!1!==b.closable||b.actions)&&(S+='<div class="notification__actions">',b.actions&&Array.isArray(b.actions)&&b.actions.forEach((e,t)=>{S+=`\n                            <button class="notification__action-btn ${"primary"===e.style?"notification__action-btn--primary":"secondary"===e.style?"notification__action-btn--secondary":""}" \n                                    data-action-index="${t}"\n                                    aria-label="${j(e.label)}">\n                                ${j(e.label)}\n                            </button>\n                        `}),!1!==b.closable&&(S+='\n                        <button class="notification__close" \n                                aria-label="Chiudi notifica"\n                                title="Chiudi notifica">\n                            <span class="material-icons" aria-hidden="true">close</span>\n                        </button>\n                    '),S+="</div>");const i=R(e.type,b.duration);i>0&&!b.persistent&&(c.debug(`ðŸ”§ Creating progress bar placeholder for ${e.type} (${i}ms)`),S+=`\n                    <div class="notification__progress notification__progress--js-placeholder" \n                         aria-hidden="true" \n                         role="progressbar"\n                         aria-label="Tempo rimanente prima della chiusura automatica"\n                         data-duration="${i}"\n                         data-type="${e.type}"></div>\n                `),E.innerHTML=S}catch(p){c.error("âŒ Error building notification HTML:",p),E.innerHTML=`\n                <div class="notification__content">\n                    <span class="notification__icon">!</span>\n                    <div class="notification__body">\n                        <div class="notification__message">${e.message||"Notifica"}</div>\n                    </div>\n                    <button class="notification__close" aria-label="Chiudi">Ã—</button>\n                </div>\n            `}try{d(E,e,{timers:n,removeNotification:o,pauseAutoCloseTimer:a,resumeAutoCloseTimer:s,notificationContainer:m})}catch(g){c.error("âŒ Error attaching notification events:",g);const t=E.querySelector(".notification__close");t&&t.addEventListener("click",()=>{try{o(e.id)}catch(t){E.remove()}})}try{window.innerWidth<=I.maxWidth&&u(E,e,{pauseAutoCloseTimer:a,resumeAutoCloseTimer:s,removeNotification:o})}catch(y){c.error("âŒ Error attaching touch events:",y)}try{const t=R(e.type,b.duration);if(t>0&&!b.persistent){const i=E.querySelector(".notification__progress--js-placeholder");if(c.debug("ðŸ” Looking for progress bar placeholder:",i),i){const i=new $(E,t,e.type);r(n,e.id,t,()=>{try{o(e.id)}catch(t){c.error("âŒ Error in progress complete callback:",t),E.parentNode&&E.remove()}}),window.innerWidth>768&&(E.addEventListener("mouseenter",()=>{i&&i.pause()}),E.addEventListener("mouseleave",()=>{i&&i.resume()})),E.addEventListener("progressComplete",()=>{try{o(e.id)}catch(t){console.error("âŒ Error in progress complete callback:",t),E.parentNode&&E.remove()}}),E._progressBarInstance=i}else r(n,e.id,t,()=>{try{o(e.id)}catch(t){console.error("âŒ Error in auto-close callback:",t),E.parentNode&&E.remove()}})}}catch(v){console.error("âŒ Error setting up auto-close timer:",v)}try{l(e.type,e.message)}catch(w){console.error("âŒ Error announcing notification:",w)}return E}catch(b){return console.error("âŒ Critical error in createNotificationElement:",b),h.createSimpleFallback(e)}}const U=Object.freeze(Object.defineProperty({__proto__:null,createNotificationElement:H,placeholderRenderer:function(){}},Symbol.toStringTag,{value:"Module"}));class W{static DEBUG=!1;constructor(){this.notificationContainer=null,this.timers=new Map,this.touchStartX=null,this.isRendering=!1,this.initialized=!1,this.settings=b.getNotificationSettings(),this._lastRenderTime=null,this._renderCount=0,this._totalRenderTime=0,this._averageRenderTime=null,this._lastRenderedNotificationIds=[],this.virtualScroller=null,this.useVirtualScrolling=!1,this.performanceMode="auto",this.maxConcurrentNotifications=this.detectOptimalMaxNotifications(),this.cleanupInterval=null,this.lastCleanupTime=Date.now(),this.memoryThreshold=52428800,this._consecutiveRenderErrors=0,this._renderingDisabled=!1,this.setupPerformanceMonitoring()}async init(){if(!this.initialized&&"undefined"!=typeof window)try{await this.initializeContainer(),this.setupEventHandlers(),this.setupStateSubscription(),this.setupAutomaticCleanup(),this.setupEmergencyReset(),this.initialized=!0}catch(e){console.error("âŒ Failed to initialize NotificationService:",e),S.handleServiceError(e,"init"),await this.initializeFallback()}}async initializeContainer(){this.useVirtualScrolling=!1;const{NotificationContainer:e}=await t(async()=>{const{NotificationContainer:e}=await import("./NotificationContainer-Dr5T1boT.js");return{NotificationContainer:e}},[]);this.notificationContainer=new e({position:this.settings.position,maxVisible:this.settings.maxVisible})}setupEventHandlers(){A.setupEventDelegation(this.notificationContainer.container),D()}setupStateSubscription(){b.subscribe("notifications",this.throttledRenderNotifications.bind(this))}setupEmergencyReset(){"undefined"!=typeof window&&(window.notificationEmergencyReset=()=>this.emergencyReset())}logInitializationSuccess(){console.log("âœ… NotificationService initialized with performance optimizations")}async initializeFallback(){try{const{NotificationContainer:e}=await t(async()=>{const{NotificationContainer:e}=await import("./NotificationContainer-Dr5T1boT.js");return{NotificationContainer:e}},[]);this.notificationContainer=new e({position:this.settings.position,maxVisible:Math.min(this.settings.maxVisible,5)}),D(),b.subscribe("notifications",this.throttledRenderNotifications.bind(this)),this.initialized=!0}catch(e){throw console.error("âŒ Fallback initialization failed:",e),e}}show(e,t,i={}){console.log("ðŸ” [notificationService.show] Called with:",{type:e,message:t,options:i});try{const n=String(t||"").trim();if(console.log("ðŸ” [notificationService.show] Validated message:",n),!n){console.warn("âš ï¸ Empty message provided to notificationService.show(), using fallback");return this.show(e,`Notifica ${e} - Messaggio non disponibile`,i)}const o=x[e.toUpperCase()]||x.INFO,r=this.getCustomDuration(e,o),a=this.buildFinalOptions(i,r);console.log("ðŸ” [notificationService.show] Final options:",a);const s=b.addNotification(e,n,a);return console.log("ðŸ” [notificationService.show] addNotification result:",s),s}catch(n){return console.error("âŒ NotificationService.show error:",n),S.handleServiceError(n,"show",{type:e,message:t,options:i}),S.recoverFromShowError({type:e,message:t,options:i,id:Date.now().toString()})}}getCustomDuration(e,t){return this.settings.customDurations&&void 0!==this.settings.customDurations[e]?this.settings.customDurations[e]:t.defaultDuration}buildFinalOptions(e,t){return{duration:void 0!==e.duration?e.duration:t,closable:!1!==e.closable,position:e.position||this.settings.position,priority:e.priority||0,title:e.title,actions:e.actions,...e}}success(e,t={}){return"number"==typeof t&&(t={duration:t}),this.show("success",e,t)}info(e,t={}){console.log("ðŸ” [notificationService.info] Called with:",{message:e,options:t}),"number"==typeof t&&(t={duration:t});const i=this.show("info",e,t);return console.log("ðŸ” [notificationService.info] show() result:",i),i}warning(e,t={}){return"number"==typeof t&&(t={duration:t}),this.show("warning",e,t)}error(e,t={}){return"number"==typeof t&&(t={duration:t}),this.show("error",e,t)}renderNotifications(e=[]){if(this.canRender(e)){this.isRendering=!0;try{const t=performance.now();this.updateNotifications(e),this.trackPerformance(t),this.resetErrorCounter()}catch(t){this.handleRenderError(t,e)}finally{this.isRendering=!1}}}canRender(e){return!this.notificationContainer||this.isRendering?(console.warn("âš ï¸ Container missing, attempting to recreate..."),!this.notificationContainer&&this.initialized&&this.recreateContainer(),!1):Array.isArray(e)?this._consecutiveRenderErrors>10?(this.disableRenderingTemporarily(),!1):!this._renderingDisabled:(console.warn("âš ï¸ renderNotifications called with non-array:",typeof e,e),!1)}updateNotifications(e){const t=new Set(e.map(e=>e.id)),i=new Set(this._lastRenderedNotificationIds);var n,o;this.removeObsoleteNotifications(i,t),this.addNewNotifications(e,i),n=e.slice(this.settings.maxVisible),o=e=>this.removeNotification(e),n.forEach(e=>{"success"!==e.type&&"info"!==e.type||setTimeout(()=>{o(e.id)},1e3)}),this._lastRenderedNotificationIds=e.map(e=>e.id)}removeObsoleteNotifications(e,t){e.forEach(e=>{if(!t.has(e))try{this.notificationContainer.removeNotification(e)}catch(i){S.handleDOMError(i,"remove",null)}})}addNewNotifications(e,t){e.forEach(e=>{if(!t.has(e.id))try{this.addNotificationToDOM(e)}catch(i){this.handleNotificationRenderError(i,e)}})}handleNotificationRenderError(e,t){S.handleRenderError(e,t,e=>{const t=S.createSimpleFallback(e);return t&&this.notificationContainer&&this.notificationContainer.addNotification(t),t})}trackPerformance(e){const t=performance.now();this._lastRenderTime=t-e,this._renderCount++,this._totalRenderTime+=this._lastRenderTime,this._averageRenderTime=this._totalRenderTime/this._renderCount}resetErrorCounter(){this._consecutiveRenderErrors=0}handleRenderError(e,t){this._consecutiveRenderErrors=(this._consecutiveRenderErrors||0)+1,console.error(`âŒ NotificationService render error (${this._consecutiveRenderErrors}/10):`,e),this._consecutiveRenderErrors<=5&&S.handleServiceError(e,"render",t)}disableRenderingTemporarily(){console.error("âŒ Too many consecutive render errors, disabling notifications temporarily"),this._renderingDisabled=!0,setTimeout(()=>{this._renderingDisabled=!1,this._consecutiveRenderErrors=0},5e3)}addNotificationToDOM(e){console.log("ðŸ” [addNotificationToDOM] Called with notification:",{id:e.id,message:e.message,type:e.type});const t=S.queueNotification(e=>{console.log("ðŸ” [addNotificationToDOM] Inside renderFunction, notif:",{id:e.id,message:e.message,type:e.type});const t=this.buildRendererPayload(e);console.log("ðŸ” [addNotificationToDOM] Renderer payload built:",{notification:t.notification?.message});try{const e=H(t);if(console.log("ðŸ” [addNotificationToDOM] Element created:",e?"SUCCESS":"NULL"),!e)throw new Error("createNotificationElement returned null");return console.log("ðŸ” [addNotificationToDOM] Element message content:",e.querySelector(".notification__message")?.textContent),this.applyAnimationSettings(e),this.notificationContainer.addNotification(e),e}catch(i){return console.error("ðŸ” [addNotificationToDOM] Error in renderFunction:",i),this.handleElementCreationError(i,e)}},e);return console.log("ðŸ” [addNotificationToDOM] queueNotification result:",t),t}buildRendererPayload(e){return{notification:e,settings:this.settings,timers:this.timers,removeNotification:e=>this.removeNotification(e),handleAction:(e,t)=>this.handleAction(e,t),startAutoCloseTimer:z,pauseAutoCloseTimer:F,resumeAutoCloseTimer:V,announceNotification:k,attachNotificationEvents:O,attachTouchEvents:P,notificationContainer:this.notificationContainer,errorHandler:S}}applyAnimationSettings(e){S.shouldDisableAnimations()&&e.classList.add("notification--no-animations")}handleElementCreationError(e,t){return S.handleRenderError(e,t,e=>{const t=S.createSimpleFallback(e);return t&&this.notificationContainer&&this.notificationContainer.addNotification(t),t})}throttledRenderNotifications=this.throttle((e,t,i)=>{let n=[];Array.isArray(e)?n=e:e&&"object"==typeof e&&(n=e.notifications||[]),this.renderNotifications(n)},16);removeNotification(e){console.log("ðŸ” [removeNotification] Called with id:",e),new Error;try{W.DEBUG,this.cleanupNotificationResources(e),this.removeNotificationFromDOM(e)}catch(t){console.error("ðŸ” [removeNotification] Error:",t),S.handleServiceError(t,"remove",e),S.recoverFromRemoveError(e)}}cleanupNotificationResources(e){if(B(this.timers,e,e=>this.stopProgressBarAnimation(e)),this.notificationContainer){const i=this.notificationContainer.container?.querySelector(`[data-id="${e}"]`);if(i&&i._progressBarInstance)try{i._progressBarInstance.destroy(),i._progressBarInstance=null}catch(t){console.warn("âš ï¸ Error cleaning up progress bar:",t)}}}removeNotificationFromDOM(e){if(!this.notificationContainer)return this.removeFromStateOnly(e),void 0;const t=this.notificationContainer.container?.querySelector(`[data-id="${e}"]`);t&&this.settings.enableAnimations&&!S.shouldDisableAnimations()?this.removeWithAnimation(t,e):this.removeImmediately(e)}removeWithAnimation(e,t){try{e.classList.remove("notification--entering"),e.classList.add("notification--exiting"),this.stopProgressBarDuringExit(e),setTimeout(()=>{this.finalizeRemoval(t)},300)}catch(i){S.handleAnimationError(i,e,"exit"),this.removeImmediately(t)}}stopProgressBarDuringExit(e){const t=e.querySelector(".notification__progress");t&&t.classList.remove("notification__progress--active","notification__progress--paused","notification__progress--resumed")}removeImmediately(e){this.finalizeRemoval(e)}removeFromStateOnly(e){b.removeNotification(e),this.validateRemoval(e)}finalizeRemoval(e){try{this.notificationContainer.removeNotification(e),b.removeNotification(e),this.validateRemoval(e)}catch(t){S.handleServiceError(t,"remove",e),S.recoverFromRemoveError(e)}}validateRemoval(e){(b.getState("notifications")||[]).find(t=>t.id===e)&&console.error("[NotificationService] ERRORE: la notifica",e,"Ã¨ ancora nello stato dopo removeNotification!")}stopProgressBarAnimation(e){try{const t=this.notificationContainer?.container?.querySelector(`[data-id="${e}"]`);t&&t._progressBarInstance&&(t._progressBarInstance.destroy(),t._progressBarInstance=null)}catch(t){}}clear(){try{this.clearAllTimers(),this.clearContainer(),b.clearAllNotifications()}catch(e){S.handleServiceError(e,"clear"),S.recoverFromClearError()}}clearAllTimers(){this.timers.forEach((e,t)=>{B(this.timers,t,e=>this.stopProgressBarAnimation(e))}),this.timers.clear()}clearContainer(){this.notificationContainer&&this.notificationContainer.clearAllNotifications()}clearByType(e){(b.getState("notifications")||[]).forEach(t=>{t.type===e&&this.timers.has(t.id)&&B(this.timers,t.id,e=>this.stopProgressBarAnimation(e))}),b.clearNotificationsByType(e)}startAutoCloseTimer(e,t){console.log("ðŸ” [startAutoCloseTimer] Called with:",{notificationId:e,duration:t});try{z(this.timers,e,t,e=>{console.log("ðŸ” [startAutoCloseTimer] Timer callback called for id:",e),this.removeNotification(e)})}catch(i){console.error("ðŸ” [startAutoCloseTimer] Error:",i)}}pauseAutoCloseTimer(e){try{F(this.timers,e)}catch(t){console.warn("Failed to pause auto-close timer:",t)}}resumeAutoCloseTimer(e){try{V(this.timers,e)}catch(t){console.warn("Failed to resume auto-close timer:",t)}}stopAutoCloseTimer(e){try{B(this.timers,e,e=>this.stopProgressBarAnimation(e))}catch(t){console.warn("Failed to stop auto-close timer:",t)}}handleAction(e,t){try{const i=(b.getState("notifications")||[]).find(t=>t.id===e),n=i?.options?.actions?.[t];n&&"function"==typeof n.onClick&&n.onClick({id:e,index:t,notification:i})}catch(i){console.warn("Notification action handler error:",i)}}setCustomDurations(e){!function(e){console.log("Setting custom durations:",e)}(e)}setPersistentTypes(e){!function(e){console.log("Setting persistent types:",e)}(e)}setAutoCleanupInterval(e){!function(e){console.log("Setting auto cleanup interval:",e)}(e)}updatePosition(e){!function(e){console.log("Updating position:",e)}(e)}setMaxVisible(e){!function(e){console.log("Setting max visible:",e)}(e),this.renderNotifications()}enableSounds(e=!0){!function(e){console.log("Enabling sounds:",e)}(e)}updateSettings(e){try{const t=this._validateSettings(e);return b.updateNotificationSettings(t),this.settings=b.getNotificationSettings(),this.updateContainerSettings(e),!0}catch(t){return console.error("âŒ Failed to update notification settings:",t),!1}}updateContainerSettings(e){this.notificationContainer&&(e.position||e.maxVisible)&&this.notificationContainer.updateSettings({position:this.settings.position,maxVisible:this.settings.maxVisible})}_validateSettings(e){const t={};if(void 0!==e.maxVisible){const i=parseInt(e.maxVisible);if(isNaN(i)||i<1||i>20)throw new Error("maxVisible deve essere un numero tra 1 e 20");t.maxVisible=i}if(void 0!==e.defaultDuration){const i=parseInt(e.defaultDuration);if(isNaN(i)||i<0)throw new Error("defaultDuration deve essere un numero >= 0");t.defaultDuration=i}if(void 0!==e.position){const i=["top-right","top-left","bottom-right","bottom-left","top-center","bottom-center"];if(!i.includes(e.position))throw new Error(`position deve essere uno di: ${i.join(", ")}`);t.position=e.position}if(["enableSounds","enableAnimations"].forEach(i=>{void 0!==e[i]&&(t[i]=Boolean(e[i]))}),void 0!==e.autoCleanupInterval){const i=parseInt(e.autoCleanupInterval);if(isNaN(i)||i<6e4)throw new Error("autoCleanupInterval deve essere >= 60000ms (1 minuto)");t.autoCleanupInterval=i}if(void 0!==e.maxStoredNotifications){const i=parseInt(e.maxStoredNotifications);if(isNaN(i)||i<10||i>1e3)throw new Error("maxStoredNotifications deve essere tra 10 e 1000");t.maxStoredNotifications=i}if(void 0!==e.persistentTypes){if(!Array.isArray(e.persistentTypes))throw new Error("persistentTypes deve essere un array");const i=["success","error","warning","info"],n=e.persistentTypes.filter(e=>!i.includes(e));if(n.length>0)throw new Error(`persistentTypes contiene tipi non validi: ${n.join(", ")}`);t.persistentTypes=[...e.persistentTypes]}if(void 0!==e.soundVolume){const i=parseFloat(e.soundVolume);if(isNaN(i)||i<0||i>1)throw new Error("soundVolume deve essere tra 0 e 1");t.soundVolume=i}if(void 0!==e.customDurations){if("object"!=typeof e.customDurations||null===e.customDurations)throw new Error("customDurations deve essere un oggetto");t.customDurations={};const i=["success","error","warning","info"];for(const[n,o]of Object.entries(e.customDurations)){if(!i.includes(n))throw new Error(`customDurations contiene tipo non valido: ${n}`);const e=parseInt(o);if(isNaN(e)||e<0)throw new Error(`customDurations.${n} deve essere >= 0`);t.customDurations[n]=e}}return t}getStats(){try{return{...b.getNotificationStats(),activeTimers:this.timers.size,containerInitialized:!!this.notificationContainer,serviceInitialized:this.initialized,settings:{...this.settings},performance:{lastRenderTime:this._lastRenderTime||null,renderCount:this._renderCount||0,averageRenderTime:this._averageRenderTime||null}}}catch(e){return console.error("âŒ Failed to get notification stats:",e),{total:0,visible:0,byType:{success:0,error:0,warning:0,info:0},persistent:0,error:e.message}}}exportSettings(){try{const e=b.exportNotificationSettings();return e.serviceMetadata={version:"2.0",exportedBy:"NotificationService",containerType:this.notificationContainer?.constructor.name||"unknown",activeNotifications:b.getState("notifications").length},e}catch(e){return console.error("âŒ Failed to export notification settings:",e),null}}importSettings(e){try{this.validateBackupData(e);const t=b.importNotificationSettings(e);return t&&this.applyImportedSettings(),t}catch(t){return console.error("âŒ Failed to import notification settings:",t),!1}}validateBackupData(e){if(!e||"object"!=typeof e)throw new Error("Formato backup non valido");if(!e.settings)throw new Error("Impostazioni mancanti nel backup");["1.0","2.0"].includes(e.version)||console.warn(`âš ï¸ Versione backup non supportata: ${e.version}. Tentativo di importazione comunque.`)}applyImportedSettings(){this.settings=b.getNotificationSettings(),this.notificationContainer&&this.notificationContainer.updateSettings({position:this.settings.position,maxVisible:this.settings.maxVisible})}cleanupOldNotifications(e=3e5){try{const t=b.clearOldNotifications(e),i=b.getState("notifications"),n=new Set(i.map(e=>e.id));for(const[e]of this.timers)n.has(e)||B(this.timers,e);return W.DEBUG&&t>0,t}catch(t){return console.error("âŒ Failed to cleanup old notifications:",t),0}}setupAutomaticCleanup(){this.cleanupInterval=setInterval(()=>{this.performAutomaticCleanup()},3e5),"undefined"!=typeof document&&document.addEventListener&&document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.performAutomaticCleanup()})}performAutomaticCleanup(){const e=Date.now();this.cleanupOldNotifications(),A&&A.cleanupAll(),N&&N.disableAllAnimations(),window.gc&&"function"==typeof window.gc&&window.gc(),this.lastCleanupTime=e}detectOptimalMaxNotifications(){return navigator.deviceMemory?navigator.deviceMemory>=8?20:navigator.deviceMemory>=4?15:navigator.deviceMemory>=2?10:5:window.innerWidth>=1920?15:window.innerWidth>=1200?10:window.innerWidth>=768?8:5}setupPerformanceMonitoring(){if("performance"===this.performanceMode&&setInterval(()=>{this.checkMemoryUsage()},6e4),"PerformanceObserver"in window)try{this.renderPerformanceObserver=new PerformanceObserver(e=>{for(const t of e.getEntries())t.name.includes("notification-render")&&this.trackRenderPerformance(t)}),this.renderPerformanceObserver.observe({entryTypes:["measure"]})}catch(e){}}checkMemoryUsage(){if("memory"in performance){const e=performance.memory.usedJSHeapSize;console.warn("ðŸš¨ High memory usage detected, optimizing notifications"),e>this.memoryThreshold&&this.optimizeForMemory()}}optimizeForMemory(){this.maxConcurrentNotifications=Math.max(3,this.maxConcurrentNotifications-2),this.cleanupOldNotifications(6e4),N&&N.optimizeForLowPerformance(),this.performanceMode="performance",A&&A.cleanupAll()}trackRenderPerformance(e){const t=e.duration;this._renderCount++,this._totalRenderTime+=t,this._averageRenderTime=this._totalRenderTime/this._renderCount,t>16&&(console.warn(`ðŸŒ Slow render detected: ${t.toFixed(2)}ms`),this._averageRenderTime>10&&this.optimizeForPerformance())}optimizeForPerformance(){console.log("ðŸš€ Optimizing for performance"),"performance"!==this.performanceMode&&(N&&N.optimizeForLowPerformance(),this.maxConcurrentNotifications=Math.max(3,this.maxConcurrentNotifications-1),!this.useVirtualScrolling&&this.notificationContainer&&this.switchToVirtualScrolling(),this.performanceMode="performance")}async switchToVirtualScrolling(){try{const{NotificationVirtualScroller:e}=await M.loadModule("NotificationVirtualScroller","./notificationVirtualScroller.js"),t=this.notificationContainer,i=b.getState("notifications")||[];this.virtualScroller=new e(t.container.parentNode,{itemHeight:72,visibleCount:this.maxConcurrentNotifications,createElement:(e,t)=>this.createOptimizedNotificationElement(e,t)}),this.virtualScroller.setNotifications(i),t.destroy&&t.destroy(),this.useVirtualScrolling=!0}catch(e){console.error("âŒ Failed to switch to virtual scrolling:",e)}}createOptimizedNotificationElement(e,t){const i=document.createElement("div");return i.className=`notification notification--${e.type} notification--optimized`,i.dataset.id=e.id,i.innerHTML=`\n            <div class="notification__content">\n                <span class="notification__icon">${this.getIconForType(e.type)}</span>\n                <div class="notification__message">${e.message}</div>\n                <button class="notification__close" aria-label="Chiudi">Ã—</button>\n            </div>\n        `,i}getIconForType(e){return{success:"âœ“",error:"âœ—",warning:"âš ",info:"â„¹"}[e]||"â„¹"}getPerformanceStats(){const e=this.getStats();return{...e,performance:{...e.performance,useVirtualScrolling:this.useVirtualScrolling,performanceMode:this.performanceMode,maxConcurrentNotifications:this.maxConcurrentNotifications,lastCleanupTime:this.lastCleanupTime,memoryThreshold:this.memoryThreshold,eventManager:A?A.getStats():null,animationManager:N?N.getPerformanceStats():null,lazyLoader:M?M.getStats():null}}}throttle(e,t){let i;return function(){i||(e.apply(this,arguments),i=!0,setTimeout(()=>i=!1,t))}}async recreateContainer(){try{console.log("ðŸ”„ Recreating notification container...");const e=await M.loadNotificationContainer({expectedNotifications:this.maxConcurrentNotifications,useVirtualScrolling:this.useVirtualScrolling});if(this.useVirtualScrolling&&e.NotificationVirtualContainer)this.notificationContainer=new e.NotificationVirtualContainer({position:this.settings.position,maxVisible:this.settings.maxVisible});else{const{NotificationContainer:t}=e;this.notificationContainer=new t({position:this.settings.position,maxVisible:this.settings.maxVisible})}console.log("âœ… Container recreated successfully");document.getElementById("notification-container")||console.error("âŒ Container still not in DOM after recreation")}catch(e){console.error("âŒ Failed to recreate container:",e)}}emergencyReset(){if(console.warn("ðŸš¨ Emergency reset of NotificationService"),this.timers.forEach(e=>clearTimeout(e)),this.timers.clear(),this.isRendering=!1,this._renderingDisabled=!1,this._consecutiveRenderErrors=0,this.notificationContainer)try{this.notificationContainer.clear()}catch(e){console.warn("Error clearing container during emergency reset:",e)}b.setState("notifications",[])}destroy(){this.renderPerformanceObserver&&this.renderPerformanceObserver.disconnect(),this.cleanupInterval&&clearInterval(this.cleanupInterval),this.virtualScroller&&this.virtualScroller.destroy(),A&&A.destroy(),N&&N.destroy(),M&&M.destroy(),this.clear(),this.performanceMode="auto",this.useVirtualScrolling=!1,this.maxConcurrentNotifications=this.detectOptimalMaxNotifications()}}const q=new W,{entries:G,setPrototypeOf:Y,isFrozen:X,getPrototypeOf:Q,getOwnPropertyDescriptor:K}=Object;let{freeze:J,seal:Z,create:ee}=Object,{apply:te,construct:ie}="undefined"!=typeof Reflect&&Reflect;J||(J=function(e){return e}),Z||(Z=function(e){return e}),te||(te=function(e,t,i){return e.apply(t,i)}),ie||(ie=function(e,t){return new e(...t)});const ne=ve(Array.prototype.forEach),oe=ve(Array.prototype.lastIndexOf),re=ve(Array.prototype.pop),ae=ve(Array.prototype.push),se=ve(Array.prototype.splice),ce=ve(String.prototype.toLowerCase),le=ve(String.prototype.toString),de=ve(String.prototype.match),ue=ve(String.prototype.replace),me=ve(String.prototype.indexOf),he=ve(String.prototype.trim),fe=ve(Object.prototype.hasOwnProperty),pe=ve(RegExp.prototype.test),ge=(ye=TypeError,function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return ie(ye,t)});var ye;function ve(e){return function(t){t instanceof RegExp&&(t.lastIndex=0);for(var i=arguments.length,n=new Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];return te(e,t,n)}}function we(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ce;Y&&Y(e,null);let n=t.length;for(;n--;){let o=t[n];if("string"==typeof o){const e=i(o);e!==o&&(X(t)||(t[n]=e),o=e)}e[o]=!0}return e}function be(e){for(let t=0;t<e.length;t++){fe(e,t)||(e[t]=null)}return e}function Ee(e){const t=ee(null);for(const[i,n]of G(e)){fe(e,i)&&(t[i]=Array.isArray(n)?be(n):n&&"object"==typeof n&&n.constructor===Object?Ee(n):n)}return t}function Se(e,t){for(;null!==e;){const i=K(e,t);if(i){if(i.get)return ve(i.get);if("function"==typeof i.value)return ve(i.value)}e=Q(e)}return function(){return null}}const _e=J(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Ae=J(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Ce=J(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Te=J(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Ne=J(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Le=J(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Me=J(["#text"]),xe=J(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Ie=J(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Re=J(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),De=J(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),ke=Z(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Oe=Z(/<%[\w\W]*|[\w\W]*%>/gm),Pe=Z(/\$\{[\w\W]*/gm),ze=Z(/^data-[\-\w.\u00B7-\uFFFF]+$/),Fe=Z(/^aria-[\-\w]+$/),Ve=Z(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Be=Z(/^(?:\w+script|data):/i),$e=Z(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),je=Z(/^html$/i),He=Z(/^[a-z][.\w]*(-[.\w]+)+$/i);var Ue=Object.freeze({__proto__:null,ARIA_ATTR:Fe,ATTR_WHITESPACE:$e,CUSTOM_ELEMENT:He,DATA_ATTR:ze,DOCTYPE_NAME:je,ERB_EXPR:Oe,IS_ALLOWED_URI:Ve,IS_SCRIPT_OR_DATA:Be,MUSTACHE_EXPR:ke,TMPLIT_EXPR:Pe});const We=1,qe=3,Ge=7,Ye=8,Xe=9;var Qe=function e(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"undefined"==typeof window?null:window;const i=t=>e(t);if(i.version="3.2.6",i.removed=[],!t||!t.document||t.document.nodeType!==Xe||!t.Element)return i.isSupported=!1,i;let{document:n}=t;const o=n,r=o.currentScript,{DocumentFragment:a,HTMLTemplateElement:s,Node:c,Element:l,NodeFilter:d,NamedNodeMap:u=t.NamedNodeMap||t.MozNamedAttrMap,HTMLFormElement:m,DOMParser:h,trustedTypes:f}=t,p=l.prototype,g=Se(p,"cloneNode"),y=Se(p,"remove"),v=Se(p,"nextSibling"),w=Se(p,"childNodes"),b=Se(p,"parentNode");if("function"==typeof s){const e=n.createElement("template");e.content&&e.content.ownerDocument&&(n=e.content.ownerDocument)}let E,S="";const{implementation:_,createNodeIterator:A,createDocumentFragment:C,getElementsByTagName:T}=n,{importNode:N}=o;let L={afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]};i.isSupported="function"==typeof G&&"function"==typeof b&&_&&void 0!==_.createHTMLDocument;const{MUSTACHE_EXPR:M,ERB_EXPR:x,TMPLIT_EXPR:I,DATA_ATTR:R,ARIA_ATTR:D,IS_SCRIPT_OR_DATA:k,ATTR_WHITESPACE:O,CUSTOM_ELEMENT:P}=Ue;let{IS_ALLOWED_URI:z}=Ue,F=null;const V=we({},[..._e,...Ae,...Ce,...Ne,...Me]);let B=null;const $=we({},[...xe,...Ie,...Re,...De]);let j=Object.seal(ee(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),H=null,U=null,W=!0,q=!0,Y=!1,X=!0,Q=!1,K=!0,Z=!1,te=!1,ie=!1,ye=!1,ve=!1,be=!1,ke=!0,Oe=!1,Pe=!0,ze=!1,Fe={},Be=null;const $e=we({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let He=null;const Qe=we({},["audio","video","img","source","image","track"]);let Ke=null;const Je=we({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Ze="http://www.w3.org/1998/Math/MathML",et="http://www.w3.org/2000/svg",tt="http://www.w3.org/1999/xhtml";let it=tt,nt=!1,ot=null;const rt=we({},[Ze,et,tt],le);let at=we({},["mi","mo","mn","ms","mtext"]),st=we({},["annotation-xml"]);const ct=we({},["title","style","font","a","script"]);let lt=null;const dt=["application/xhtml+xml","text/html"];let ut=null,mt=null;const ht=n.createElement("form"),ft=function(e){return e instanceof RegExp||e instanceof Function},pt=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!mt||mt!==e){if(e&&"object"==typeof e||(e={}),e=Ee(e),lt=-1===dt.indexOf(e.PARSER_MEDIA_TYPE)?"text/html":e.PARSER_MEDIA_TYPE,ut="application/xhtml+xml"===lt?le:ce,F=fe(e,"ALLOWED_TAGS")?we({},e.ALLOWED_TAGS,ut):V,B=fe(e,"ALLOWED_ATTR")?we({},e.ALLOWED_ATTR,ut):$,ot=fe(e,"ALLOWED_NAMESPACES")?we({},e.ALLOWED_NAMESPACES,le):rt,Ke=fe(e,"ADD_URI_SAFE_ATTR")?we(Ee(Je),e.ADD_URI_SAFE_ATTR,ut):Je,He=fe(e,"ADD_DATA_URI_TAGS")?we(Ee(Qe),e.ADD_DATA_URI_TAGS,ut):Qe,Be=fe(e,"FORBID_CONTENTS")?we({},e.FORBID_CONTENTS,ut):$e,H=fe(e,"FORBID_TAGS")?we({},e.FORBID_TAGS,ut):Ee({}),U=fe(e,"FORBID_ATTR")?we({},e.FORBID_ATTR,ut):Ee({}),Fe=!!fe(e,"USE_PROFILES")&&e.USE_PROFILES,W=!1!==e.ALLOW_ARIA_ATTR,q=!1!==e.ALLOW_DATA_ATTR,Y=e.ALLOW_UNKNOWN_PROTOCOLS||!1,X=!1!==e.ALLOW_SELF_CLOSE_IN_ATTR,Q=e.SAFE_FOR_TEMPLATES||!1,K=!1!==e.SAFE_FOR_XML,Z=e.WHOLE_DOCUMENT||!1,ye=e.RETURN_DOM||!1,ve=e.RETURN_DOM_FRAGMENT||!1,be=e.RETURN_TRUSTED_TYPE||!1,ie=e.FORCE_BODY||!1,ke=!1!==e.SANITIZE_DOM,Oe=e.SANITIZE_NAMED_PROPS||!1,Pe=!1!==e.KEEP_CONTENT,ze=e.IN_PLACE||!1,z=e.ALLOWED_URI_REGEXP||Ve,it=e.NAMESPACE||tt,at=e.MATHML_TEXT_INTEGRATION_POINTS||at,st=e.HTML_INTEGRATION_POINTS||st,j=e.CUSTOM_ELEMENT_HANDLING||{},e.CUSTOM_ELEMENT_HANDLING&&ft(e.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(j.tagNameCheck=e.CUSTOM_ELEMENT_HANDLING.tagNameCheck),e.CUSTOM_ELEMENT_HANDLING&&ft(e.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(j.attributeNameCheck=e.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),e.CUSTOM_ELEMENT_HANDLING&&"boolean"==typeof e.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements&&(j.allowCustomizedBuiltInElements=e.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Q&&(q=!1),ve&&(ye=!0),Fe&&(F=we({},Me),B=[],!0===Fe.html&&(we(F,_e),we(B,xe)),!0===Fe.svg&&(we(F,Ae),we(B,Ie),we(B,De)),!0===Fe.svgFilters&&(we(F,Ce),we(B,Ie),we(B,De)),!0===Fe.mathMl&&(we(F,Ne),we(B,Re),we(B,De))),e.ADD_TAGS&&(F===V&&(F=Ee(F)),we(F,e.ADD_TAGS,ut)),e.ADD_ATTR&&(B===$&&(B=Ee(B)),we(B,e.ADD_ATTR,ut)),e.ADD_URI_SAFE_ATTR&&we(Ke,e.ADD_URI_SAFE_ATTR,ut),e.FORBID_CONTENTS&&(Be===$e&&(Be=Ee(Be)),we(Be,e.FORBID_CONTENTS,ut)),Pe&&(F["#text"]=!0),Z&&we(F,["html","head","body"]),F.table&&(we(F,["tbody"]),delete H.tbody),e.TRUSTED_TYPES_POLICY){if("function"!=typeof e.TRUSTED_TYPES_POLICY.createHTML)throw ge('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if("function"!=typeof e.TRUSTED_TYPES_POLICY.createScriptURL)throw ge('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');E=e.TRUSTED_TYPES_POLICY,S=E.createHTML("")}else void 0===E&&(E=function(e,t){if("object"!=typeof e||"function"!=typeof e.createPolicy)return null;let i=null;const n="data-tt-policy-suffix";t&&t.hasAttribute(n)&&(i=t.getAttribute(n));const o="dompurify"+(i?"#"+i:"");try{return e.createPolicy(o,{createHTML:e=>e,createScriptURL:e=>e})}catch(r){return console.warn("TrustedTypes policy "+o+" could not be created."),null}}(f,r)),null!==E&&"string"==typeof S&&(S=E.createHTML(""));J&&J(e),mt=e}},gt=we({},[...Ae,...Ce,...Te]),yt=we({},[...Ne,...Le]),vt=function(e){ae(i.removed,{element:e});try{b(e).removeChild(e)}catch(t){y(e)}},wt=function(e,t){try{ae(i.removed,{attribute:t.getAttributeNode(e),from:t})}catch(n){ae(i.removed,{attribute:null,from:t})}if(t.removeAttribute(e),"is"===e)if(ye||ve)try{vt(t)}catch(n){}else try{t.setAttribute(e,"")}catch(n){}},bt=function(e){let t=null,i=null;if(ie)e="<remove></remove>"+e;else{const t=de(e,/^[\r\n\t ]+/);i=t&&t[0]}"application/xhtml+xml"===lt&&it===tt&&(e='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+e+"</body></html>");const o=E?E.createHTML(e):e;if(it===tt)try{t=(new h).parseFromString(o,lt)}catch(a){}if(!t||!t.documentElement){t=_.createDocument(it,"template",null);try{t.documentElement.innerHTML=nt?S:o}catch(a){}}const r=t.body||t.documentElement;return e&&i&&r.insertBefore(n.createTextNode(i),r.childNodes[0]||null),it===tt?T.call(t,Z?"html":"body")[0]:Z?t.documentElement:r},Et=function(e){return A.call(e.ownerDocument||e,e,d.SHOW_ELEMENT|d.SHOW_COMMENT|d.SHOW_TEXT|d.SHOW_PROCESSING_INSTRUCTION|d.SHOW_CDATA_SECTION,null)},St=function(e){return e instanceof m&&("string"!=typeof e.nodeName||"string"!=typeof e.textContent||"function"!=typeof e.removeChild||!(e.attributes instanceof u)||"function"!=typeof e.removeAttribute||"function"!=typeof e.setAttribute||"string"!=typeof e.namespaceURI||"function"!=typeof e.insertBefore||"function"!=typeof e.hasChildNodes)},_t=function(e){return"function"==typeof c&&e instanceof c};function At(e,t,n){ne(e,e=>{e.call(i,t,n,mt)})}const Ct=function(e){let t=null;if(At(L.beforeSanitizeElements,e,null),St(e))return vt(e),!0;const n=ut(e.nodeName);if(At(L.uponSanitizeElement,e,{tagName:n,allowedTags:F}),K&&e.hasChildNodes()&&!_t(e.firstElementChild)&&pe(/<[/\w!]/g,e.innerHTML)&&pe(/<[/\w!]/g,e.textContent))return vt(e),!0;if(e.nodeType===Ge)return vt(e),!0;if(K&&e.nodeType===Ye&&pe(/<[/\w]/g,e.data))return vt(e),!0;if(!F[n]||H[n]){if(!H[n]&&Nt(n)){if(j.tagNameCheck instanceof RegExp&&pe(j.tagNameCheck,n))return!1;if(j.tagNameCheck instanceof Function&&j.tagNameCheck(n))return!1}if(Pe&&!Be[n]){const t=b(e)||e.parentNode,i=w(e)||e.childNodes;if(i&&t){for(let n=i.length-1;n>=0;--n){const o=g(i[n],!0);o.__removalCount=(e.__removalCount||0)+1,t.insertBefore(o,v(e))}}}return vt(e),!0}return e instanceof l&&!function(e){let t=b(e);t&&t.tagName||(t={namespaceURI:it,tagName:"template"});const i=ce(e.tagName),n=ce(t.tagName);return!!ot[e.namespaceURI]&&(e.namespaceURI===et?t.namespaceURI===tt?"svg"===i:t.namespaceURI===Ze?"svg"===i&&("annotation-xml"===n||at[n]):Boolean(gt[i]):e.namespaceURI===Ze?t.namespaceURI===tt?"math"===i:t.namespaceURI===et?"math"===i&&st[n]:Boolean(yt[i]):e.namespaceURI===tt?!(t.namespaceURI===et&&!st[n])&&!(t.namespaceURI===Ze&&!at[n])&&!yt[i]&&(ct[i]||!gt[i]):!("application/xhtml+xml"!==lt||!ot[e.namespaceURI]))}(e)?(vt(e),!0):"noscript"!==n&&"noembed"!==n&&"noframes"!==n||!pe(/<\/no(script|embed|frames)/i,e.innerHTML)?(Q&&e.nodeType===qe&&(t=e.textContent,ne([M,x,I],e=>{t=ue(t,e," ")}),e.textContent!==t&&(ae(i.removed,{element:e.cloneNode()}),e.textContent=t)),At(L.afterSanitizeElements,e,null),!1):(vt(e),!0)},Tt=function(e,t,i){if(ke&&("id"===t||"name"===t)&&(i in n||i in ht))return!1;if(q&&!U[t]&&pe(R,t));else if(W&&pe(D,t));else if(!B[t]||U[t]){if(!(Nt(e)&&(j.tagNameCheck instanceof RegExp&&pe(j.tagNameCheck,e)||j.tagNameCheck instanceof Function&&j.tagNameCheck(e))&&(j.attributeNameCheck instanceof RegExp&&pe(j.attributeNameCheck,t)||j.attributeNameCheck instanceof Function&&j.attributeNameCheck(t))||"is"===t&&j.allowCustomizedBuiltInElements&&(j.tagNameCheck instanceof RegExp&&pe(j.tagNameCheck,i)||j.tagNameCheck instanceof Function&&j.tagNameCheck(i))))return!1}else if(Ke[t]);else if(pe(z,ue(i,O,"")));else if("src"!==t&&"xlink:href"!==t&&"href"!==t||"script"===e||0!==me(i,"data:")||!He[e]){if(Y&&!pe(k,ue(i,O,"")));else if(i)return!1}else;return!0},Nt=function(e){return"annotation-xml"!==e&&de(e,P)},Lt=function(e){At(L.beforeSanitizeAttributes,e,null);const{attributes:t}=e;if(!t||St(e))return;const n={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:B,forceKeepAttr:void 0};let o=t.length;for(;o--;){const a=t[o],{name:s,namespaceURI:c,value:l}=a,d=ut(s),u=l;let m="value"===s?u:he(u);if(n.attrName=d,n.attrValue=m,n.keepAttr=!0,n.forceKeepAttr=void 0,At(L.uponSanitizeAttribute,e,n),m=n.attrValue,!Oe||"id"!==d&&"name"!==d||(wt(s,e),m="user-content-"+m),K&&pe(/((--!?|])>)|<\/(style|title)/i,m)){wt(s,e);continue}if(n.forceKeepAttr)continue;if(!n.keepAttr){wt(s,e);continue}if(!X&&pe(/\/>/i,m)){wt(s,e);continue}Q&&ne([M,x,I],e=>{m=ue(m,e," ")});const h=ut(e.nodeName);if(Tt(h,d,m)){if(E&&"object"==typeof f&&"function"==typeof f.getAttributeType)if(c);else switch(f.getAttributeType(h,d)){case"TrustedHTML":m=E.createHTML(m);break;case"TrustedScriptURL":m=E.createScriptURL(m)}if(m!==u)try{c?e.setAttributeNS(c,s,m):e.setAttribute(s,m),St(e)?vt(e):re(i.removed)}catch(r){wt(s,e)}}else wt(s,e)}At(L.afterSanitizeAttributes,e,null)},Mt=function e(t){let i=null;const n=Et(t);for(At(L.beforeSanitizeShadowDOM,t,null);i=n.nextNode();)At(L.uponSanitizeShadowNode,i,null),Ct(i),Lt(i),i.content instanceof a&&e(i.content);At(L.afterSanitizeShadowDOM,t,null)};return i.sanitize=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=null,r=null,s=null,l=null;if(nt=!e,nt&&(e="\x3c!--\x3e"),"string"!=typeof e&&!_t(e)){if("function"!=typeof e.toString)throw ge("toString is not a function");if("string"!=typeof(e=e.toString()))throw ge("dirty is not a string, aborting")}if(!i.isSupported)return e;if(te||pt(t),i.removed=[],"string"==typeof e&&(ze=!1),ze){if(e.nodeName){const t=ut(e.nodeName);if(!F[t]||H[t])throw ge("root node is forbidden and cannot be sanitized in-place")}}else if(e instanceof c)n=bt("\x3c!----\x3e"),r=n.ownerDocument.importNode(e,!0),r.nodeType===We&&"BODY"===r.nodeName||"HTML"===r.nodeName?n=r:n.appendChild(r);else{if(!ye&&!Q&&!Z&&-1===e.indexOf("<"))return E&&be?E.createHTML(e):e;if(n=bt(e),!n)return ye?null:be?S:""}n&&ie&&vt(n.firstChild);const d=Et(ze?e:n);for(;s=d.nextNode();)Ct(s),Lt(s),s.content instanceof a&&Mt(s.content);if(ze)return e;if(ye){if(ve)for(l=C.call(n.ownerDocument);n.firstChild;)l.appendChild(n.firstChild);else l=n;return(B.shadowroot||B.shadowrootmode)&&(l=N.call(o,l,!0)),l}let u=Z?n.outerHTML:n.innerHTML;return Z&&F["!doctype"]&&n.ownerDocument&&n.ownerDocument.doctype&&n.ownerDocument.doctype.name&&pe(je,n.ownerDocument.doctype.name)&&(u="<!DOCTYPE "+n.ownerDocument.doctype.name+">\n"+u),Q&&ne([M,x,I],e=>{u=ue(u,e," ")}),E&&be?E.createHTML(u):u},i.setConfig=function(){pt(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}),te=!0},i.clearConfig=function(){mt=null,te=!1},i.isValidAttribute=function(e,t,i){mt||pt({});const n=ut(e),o=ut(t);return Tt(n,o,i)},i.addHook=function(e,t){"function"==typeof t&&ae(L[e],t)},i.removeHook=function(e,t){if(void 0!==t){const i=oe(L[e],t);return-1===i?void 0:se(L[e],i,1)[0]}return re(L[e])},i.removeHooks=function(e){L[e]=[]},i.removeAllHooks=function(){L={afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}},i}();function Ke(e){if(!e)return"";try{return Qe.sanitize(e)}catch(t){return console.warn("Error sanitizing HTML:",t),String(e).replace(/</g,"&lt;").replace(/>/g,"&gt;")}}const Je=new class{constructor(){this.loadingInstances=new Map}showLoading(e,t="Caricamento..."){if("string"==typeof e&&(e=document.getElementById(e)||document.querySelector(e)),!e)return;const i=this.generateId(),n=this.createLoadingElement(t);return this.loadingInstances.set(i,{container:e,originalContent:e.innerHTML}),e.innerHTML=Ke(""),e.appendChild(n),i}hideLoading(e){const t=this.loadingInstances.get(e);t&&(t.container.innerHTML=Ke(t.originalContent),this.loadingInstances.delete(e))}showEmpty(e,t="Nessun dato disponibile",i="inbox"){if("string"==typeof e&&(e=document.getElementById(e)||document.querySelector(e)),!e)return;const n=this.createEmptyElement(t,i);e.innerHTML=Ke(""),e.appendChild(n)}showError(e,t="Si Ã¨ verificato un errore",i=!1,n=null){if("string"==typeof e&&(e=document.getElementById(e)||document.querySelector(e)),!e)return;const o=this.createErrorElement(t,i,n);e.innerHTML=Ke(""),e.appendChild(o)}createLoadingElement(e){const t=document.createElement("div");return t.className="ui-state loading-state",t.innerHTML=Ke(`\n            <div class="loading-content">\n                <div class="spinner">\n                    <div class="spinner-border text-primary" role="status">\n                        <span class="visually-hidden">Loading...</span>\n                    </div>\n                </div>\n                <div class="loading-message">${e}</div>\n            </div>\n            <style>\n                .ui-state {\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    min-height: 200px;\n                    text-align: center;\n                    padding: 2rem;\n                }\n                \n                .loading-content {\n                    display: flex;\n                    flex-direction: column;\n                    align-items: center;\n                    gap: 1rem;\n                }\n                \n                .loading-message {\n                    color: #6c757d;\n                    font-size: 0.9rem;\n                }\n                \n                .empty-content {\n                    display: flex;\n                    flex-direction: column;\n                    align-items: center;\n                    gap: 1rem;\n                    color: #6c757d;\n                }\n                \n                .empty-icon {\n                    font-size: 3rem;\n                    opacity: 0.5;\n                }\n                \n                .empty-message {\n                    font-size: 1.1rem;\n                    font-weight: 500;\n                }\n                \n                .error-content {\n                    display: flex;\n                    flex-direction: column;\n                    align-items: center;\n                    gap: 1rem;\n                    color: #dc3545;\n                }\n                \n                .error-icon {\n                    font-size: 3rem;\n                    opacity: 0.7;\n                }\n                \n                .error-message {\n                    font-size: 1.1rem;\n                    font-weight: 500;\n                    text-align: center;\n                }\n                \n                .retry-button {\n                    margin-top: 0.5rem;\n                }\n            </style>\n        `),t}createEmptyElement(e,t){const i=document.createElement("div");return i.className="ui-state empty-state",i.innerHTML=Ke(`\n            <div class="empty-content">\n                <span class="material-icons empty-icon">${t}</span>\n                <div class="empty-message">${e}</div>\n            </div>\n        `),i}createErrorElement(e,t,i){const n=document.createElement("div");n.className="ui-state error-state";if(n.innerHTML=Ke(`\n            <div class="error-content">\n                <span class="material-icons error-icon">error_outline</span>\n                <div class="error-message">${e}</div>\n                ${t&&i?'\n            <button class="btn btn-outline-danger btn-sm retry-button">\n                <span class="material-icons me-1">refresh</span>\n                Riprova\n            </button>\n        ':""}\n            </div>\n        `),t&&i){n.querySelector(".retry-button").addEventListener("click",i)}return n}showPageLoading(e="Caricamento..."){const t=document.createElement("div");t.id="page-loading-overlay",t.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(255, 255, 255, 0.9);\n            z-index: 9998;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        ";const i=this.createLoadingElement(e);return t.appendChild(i),document.body.appendChild(t),()=>{const e=document.getElementById("page-loading-overlay");e&&e.remove()}}hidePageLoading(){const e=document.getElementById("page-loading-overlay");e&&e.remove()}generateId(){return"loading_"+Math.random().toString(36).substr(2,9)}async withLoading(e,t,i="Caricamento..."){const n=this.showLoading(e,i);try{const e=await t();return this.hideLoading(n),e}catch(o){throw this.hideLoading(n),this.showError(e,`Errore: ${o.message}`,!0,()=>{this.withLoading(e,t,i)}),o}}renderConditional(e,t,i,n="Nessun dato disponibile"){if(!t||Array.isArray(t)&&0===t.length)return this.showEmpty(e,n),void 0;"string"==typeof e&&(e=document.getElementById(e)||document.querySelector(e)),e&&(e.innerHTML=Ke(""),i(e,t))}};"undefined"!=typeof window&&(window.uiStateService=Je),"undefined"!=typeof window&&(window.EMERGENCY_STOP=function(){console.log("ðŸš¨ EMERGENCY STOP ACTIVATED");try{window.notificationService&&(window.notificationService.timers?.forEach(e=>clearTimeout(e)),window.notificationService.timers?.clear(),window.notificationService.emergencyReset&&window.notificationService.emergencyReset()),window.stateService&&window.stateService.subscribers?.clear()}catch(e){console.error("âŒ Emergency stop failed:",e)}},window.EMERGENCY_RELOAD=function(){console.log("ðŸ”„ Emergency reload..."),location.reload()});let Ze=!1;void(window.innerWidth>767||document.addEventListener("DOMContentLoaded",()=>{!function(){if(Ze)return;const e=()=>{Ze=!0,document.removeEventListener("touchstart",e),document.removeEventListener("click",e)};document.addEventListener("touchstart",e,{once:!0,passive:!0}),document.addEventListener("click",e,{once:!0,passive:!0})}(),document.querySelectorAll(".card").forEach(e=>{e.addEventListener("touchstart",e=>{if(!e.target.closest("button, a, input, select, .custom-select-wrapper"))try{"vibrate"in navigator&&Ze&&navigator.vibrate(10)}catch(t){console.debug("Vibrazione non disponibile o bloccata.",t.message)}},{passive:!0})}),window.addEventListener("resize",()=>{window.innerWidth<=480?document.querySelectorAll(".cards-grid-mobile").forEach(e=>{e.style.gridTemplateColumns="1fr"}):document.querySelectorAll(".cards-grid-mobile").forEach(e=>{e.style.gridTemplateColumns=""})},{passive:!0})}));let et=window.innerWidth<=767;function tt(){const e=document.querySelector(".navbar"),t=document.querySelector(".mobile-navbar");if(!e||!t)return;const i=window.innerWidth<=767;if(i===et)return e.classList.toggle("d-none",i),t.classList.toggle("d-none",!i),void 0;et=i,c.log("Mode changed to: "+(i?"mobile":"desktop"));const n=new CustomEvent("mode:change",{detail:{isMobile:i}});window.dispatchEvent(n),e.classList.toggle("d-none",i),t.classList.toggle("d-none",!i),i&&it()}function it(){const e=document.getElementById("mobile-auth-container"),t=document.getElementById("mobile-home-link");if(!e||!t)return;f.session?(e.innerHTML='<span class="material-icons" title="Logout">logout</span>',e.onclick=async e=>{e.preventDefault(),await g()},t.classList.add("navbar-home-logged")):(e.innerHTML='<span class="material-icons" title="Login">login</span>',e.onclick=e=>{e.preventDefault();const t=document.getElementById("login-modal-trigger");t&&t.click()},t.classList.remove("navbar-home-logged"))}function nt(e){const t=document.getElementById("auth-container");if(t){if(e){const i=f.profile?.role||"caricamento...",n=e.user.email;t.innerHTML=Ke(`\n            <div class="d-flex align-items-center text-light">\n                <span class="navbar-text me-3" title="${n}">\n                    <i class="material-icons me-1" style="font-size: 1.1em; vertical-align: text-bottom;">account_circle</i>\n                    ${n.split("@")[0]}\n                </span>\n                <span class="badge bg-info me-3 text-uppercase" style="font-size: 0.75em; padding: 0.4em 0.6em;">\n                    ${i}\n                </span>\n                <button id="logout-button" class="btn btn-outline-light btn-sm">\n                    <i class="material-icons" style="font-size: 1em; vertical-align: middle;">logout</i>\n                </button>\n            </div>\n        `)}else t.innerHTML=Ke('\n            <button id="login-modal-trigger" class="btn btn-outline-light">\n                <i class="material-icons me-1" style="font-size: 1em;">login</i>\n                Accedi\n            </button>\n        ');it()}}function ot(){window.addEventListener("auth:session-changed",e=>{nt(e.detail?.session||null)}),void 0!==f&&nt(f.session||null),document.body.addEventListener("click",async e=>{if(e.target.closest("#logout-button")&&(e.preventDefault(),await g()),e.target.closest("#login-modal-trigger")&&(e.preventDefault(),async function(){let e=document.getElementById("auth-modal");if(!e){const{default:i}=await t(async()=>{const{default:e}=await import("./auth-modal-VMurGtIz.js");return{default:e}},[]),n=document.createElement("div");n.innerHTML=Ke(i),document.body.appendChild(n.firstElementChild),e=document.getElementById("auth-modal")}const i=document.getElementById("auth-error-message");i&&(i.style.display="none");new n(e).show()}()),e.target.closest("#google-login-btn")){e.preventDefault(),c.log("Pulsante Google cliccato");const t=e.target.closest("#google-login-btn"),o=t.querySelector(".spinner-border"),r=t.querySelector(".material-icons");t.disabled=!0,o&&(o.style.display="inline-block"),r&&(r.style.display="none");try{await async function(){return await h.signInWithGoogle()}();!function(){const e=document.getElementById("auth-modal");if(e){const t=n.getInstance(e);t&&t.hide()}}()}catch(i){console.error("Errore durante l'accesso:",i);const e=document.getElementById("auth-error");e&&(e.textContent="Errore durante l'accesso. Riprova.",e.style.display="block")}finally{t.disabled=!1,o&&(o.style.display="none"),r&&(r.style.display="inline-block")}}})}let rt=null,at=!1;const st={inserimento:()=>t(()=>import("./form-Bq_xW3WN.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),dimissione:()=>t(()=>import("./dimissione-De83lZfJ.js"),__vite__mapDeps([11,1,3,4,2,12,13,5,8,10,14])),grafico:()=>t(()=>import("./grafico-CgY7Z70y.js"),__vite__mapDeps([15,16,1,2,3,4,8])),list:()=>t(()=>import("./list-tXaZAGdh.js"),__vite__mapDeps([17,1,16,13,5,8,14,6,2])),diagnosi:()=>t(()=>import("./diagnosi-D6aZBn3_.js"),__vite__mapDeps([18,1,8])),"eventi-clinici":()=>t(()=>import("./eventi-clinici-C-yvKVJr.js"),__vite__mapDeps([19,1,5,14,2,3,4,12,13,8]))},ct=new Map,lt=Object.assign({"/src/views/access-denied.html":()=>t(()=>import("./access-denied-qNA2WfrE.js"),[]).then(e=>e.default),"/src/views/auth-modal.html":()=>t(()=>import("./auth-modal-VMurGtIz.js"),[]).then(e=>e.default),"/src/views/diagnosi.html":()=>t(()=>import("./diagnosi-Cwkqnh9y.js"),[]).then(e=>e.default),"/src/views/dimissione.html":()=>t(()=>import("./dimissione-Btfp9upn.js"),[]).then(e=>e.default),"/src/views/eventi-clinici.html":()=>t(()=>import("./eventi-clinici-D-JWmn83.js"),[]).then(e=>e.default),"/src/views/grafico.html":()=>t(()=>import("./grafico-DyPZBtMB.js"),[]).then(e=>e.default),"/src/views/home.html":()=>t(()=>import("./home-fApaPaO7.js"),[]).then(e=>e.default),"/src/views/inserimento.html":()=>t(()=>import("./inserimento-B2V9ZJKD.js"),[]).then(e=>e.default),"/src/views/list.html":()=>t(()=>import("./list-oHAJ5ahF.js"),[]).then(e=>e.default),"/src/views/login-required.html":()=>t(()=>import("./login-required-DkOrvptO.js"),[]).then(e=>e.default)});function dt(){const e=f.profile?.role;c.log("Updating UI visibility based on role:",e);const t={inserimento:["admin","editor"],list:["admin","editor","viewer"],grafico:["admin","editor","viewer"],diagnosi:["admin"],dimissione:["admin","editor"],"eventi-clinici":["admin","editor"]};document.querySelectorAll(".menu-card").forEach(i=>{const n=i.dataset.view;t[n]&&(i.style.display=e&&t[n].includes(e)?"block":"none")})}async function ut(e){if(ct.has(e))return ct.get(e);const t=`/src/views/${e}.html`;if(!lt[t])return console.error(`Vista non trovata: ${e} (path cercato: ${t})`),c.error(`Vista HTML non trovata: ${e}`),"home"!==e?await ut("home"):'\n                <div class="container mt-4">\n                    <div class="alert alert-danger" role="alert">\n                        <h4 class="alert-heading">Errore critico</h4>\n                        <p>Impossibile caricare le viste dell\'applicazione.</p>\n                        <button class="btn btn-primary" onclick="location.reload()">Ricarica pagina</button>\n                    </div>\n                </div>\n            ';try{const i=await lt[t]();if(!i||"string"!=typeof i)throw new Error(`Contenuto vista ${e} non valido`);return ct.set(e,i),i}catch(i){return console.error("Errore nel caricamento della vista:",e,i),c.error(`Fallimento caricamento vista HTML ${e}:`,i),"home"!==e?await ut("home"):'\n                <div class="container mt-4">\n                    <div class="alert alert-danger" role="alert">\n                        <h4 class="alert-heading">Errore di caricamento</h4>\n                        <p>Si Ã¨ verificato un errore nel caricamento della vista.</p>\n                        <button class="btn btn-primary" onclick="location.reload()">Ricarica pagina</button>\n                        \n                    </div>\n                </div>\n            '}}function mt(e){window.location.hash=e}async function ht(){if(at)return c.warn("Navigazione giÃ  in corso, interrotta."),void 0;at=!0;const e=document.getElementById("view-container");try{if("function"==typeof rt&&(rt(),rt=null),window.location.hash.includes("access_token="))return;if(void 0===f.session)return;const i=window.location.hash.replace(/^#\/?/,"");if(!f.session&&(""===i||"home"===i||"list"===i))return window.location.hash="login-required",void 0;if(!e)return console.error("Fatal: #view-container non trovato."),void 0;e.innerHTML=Ke('<div class="d-flex justify-content-center align-items-center" style="height: 80vh;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');const n=window.location.hash.replace(/^#\/?/,"")||"home",[o,r]=n.split("?"),s=new URLSearchParams(r),l={inserimento:["admin","editor"],list:["admin","editor","viewer"],grafico:["admin","editor","viewer"],diagnosi:["admin"],dimissione:["admin","editor"],"eventi-clinici":["admin","editor"]};let u=o;Object.keys(l).includes(o)&&!f.session?(sessionStorage.setItem("redirectUrl",n),u="login-required"):l[o]&&!l[o].includes(f.profile?.role)&&f.profile&&(u="access-denied");const m=await ut(u);e.innerHTML=Ke(m);const h=e.querySelector(".view");h.offsetHeight,h&&h.classList.add("active");const p=st[u];if(p)try{const e=await async function(e,t=3,i=1e3){let n;for(let r=1;r<=t;r++)try{return await e()}catch(o){if(n=o,c.warn(`Tentativo ${r}/${t} fallito per import dinamico:`,o.message),r===t)throw n;const e=i*Math.pow(2,r-1);await new Promise(t=>setTimeout(t,e))}}(p);if(!e)throw new Error(`Modulo ${u} caricato ma vuoto`);if("list"===u){const t=await e.fetchListData();rt=await e.initListView(t)}else if("diagnosi"===u)rt=await e.initDiagnosiView(s);else if("grafico"===u)rt=await e.initGraficoView(s);else if("inserimento"===u)rt=await e.initInserimentoView(s);else if("dimissione"===u)rt=await e.initDimissioneView(s);else if("eventi-clinici"===u)rt=await e.initEventiCliniciView(s);else{const t=Object.values(e).find(e=>"function"==typeof e&&e.name.startsWith("init"));t&&(rt=await t(s))}}catch(t){return console.error("Errore nel caricamento del modulo:",u,t),c.error(`Fallimento caricamento modulo ${u}:`,t),e.innerHTML=Ke(`\n                    <div class="container mt-4">\n                        <div class="alert alert-warning" role="alert">\n                            <h4 class="alert-heading">\n                                <span class="material-icons me-2" style="vertical-align: middle;">warning</span>\n                                Problema di caricamento\n                            </h4>\n                            <p>Si Ã¨ verificato un problema nel caricamento di questa sezione dell'applicazione.</p>\n                            <hr>\n                            <div class="d-flex gap-2">\n                                <button class="btn btn-primary" onclick="location.reload()">\n                                    <span class="material-icons me-1" style="vertical-align: middle;">refresh</span>\n                                    Ricarica pagina\n                                </button>\n                                <button class="btn btn-outline-secondary" onclick="window.location.hash = 'home'">\n                                    <span class="material-icons me-1" style="vertical-align: middle;">home</span>\n                                    Torna alla home\n                                </button>\n                            </div>\n                            ${a?`<details class="mt-3"><summary>Dettagli tecnici (solo sviluppo)</summary><pre class="small mt-2">${t.stack||t.message}</pre></details>`:""}\n                        </div>\n                    </div>\n                `),void 0}else if("home"===u)dt(),document.querySelectorAll(".menu-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.view;"inserimento"===t&&sessionStorage.removeItem("editPazienteId"),mt(t)})});else if("login-required"===u){const e=document.getElementById("login-prompt-button");e&&e.addEventListener("click",()=>{d.auth.signInWithOAuth({provider:"google"})})}const g=new CustomEvent("viewChanged",{detail:{view:u,params:s}});document.dispatchEvent(g)}catch(i){console.error("Errore durante il rendering della vista:",i),e&&(e.innerHTML=Ke('<div class="alert alert-danger m-3">Si Ã¨ verificato un errore critico. Si prega di ricaricare la pagina.</div>'))}finally{at=!1}}function ft(){document.addEventListener("click",e=>{const t=e.target.closest(".btn-back-menu");if(t){e.preventDefault(),t.style.transform="scale(0.95)",t.style.transition="transform 0.1s ease",setTimeout(()=>{t.style.transform="",t.style.transition=""},150);const i=t.getAttribute("data-view")||"home";"home"===i&&(sessionStorage.removeItem("editPazienteId"),sessionStorage.removeItem("formData"),sessionStorage.removeItem("currentFilters")),setTimeout(()=>mt(i),100)}})}window.addEventListener("auth-profile-loaded",dt),window.addEventListener("load",async function(){try{c.log(`ðŸš€ Inizializzazione ${o} v${r}`),l(),y(),ft(),function(){tt(),window.addEventListener("resize",tt);const e=document.getElementById("auth-container");e&&new MutationObserver(it).observe(e,{childList:!0,subtree:!0});setTimeout(it,150),window.addEventListener("auth:session-changed",()=>{it()})}(),window.authUIListenersInitialized||(ot(),window.authUIListenersInitialized=!0),q.init(),window.addEventListener("hashchange",ht),await async function(e){h.init();const{data:{session:t}}=await d.auth.getSession();c.log("Sessione iniziale recuperata:",t),await p(t),e&&e(t),d.auth.onAuthStateChange(async(t,i)=>{c.log("Auth event:",t,"Session:",i),"SIGNED_OUT"===t&&"error"===h.getAuthState().state&&h.clearCorruptedState(),i?.access_token!==f.session?.access_token&&(await p(i),e&&e(i))}),c.log("Sistema di autenticazione inizializzato")}(e=>{const t=sessionStorage.getItem(s);sessionStorage.removeItem(s),e&&t?window.location.hash=t:ht()}),c.log("âœ… Applicazione inizializzata con successo")}catch(e){console.error("âŒ Errore durante l'inizializzazione dell'applicazione:",e),document.body.innerHTML='\n            <div class="container mt-5">\n                <div class="alert alert-danger" role="alert">\n                    <h4 class="alert-heading">Errore di inizializzazione</h4>\n                    <p>Si Ã¨ verificato un errore durante l\'avvio dell\'applicazione.</p>\n                    \n                    <hr>\n                    <p class="mb-0">Ricarica la pagina per riprovare.</p>\n                </div>\n            </div>\n        '}});export{Ke as a,b,mt as c,f as d,u as e,E as f,ft as i,c as l,q as n,Qe as p,d as s};
