import{j as e}from"./ui-vendor-S6RcKJ66.js";import{b as t,i,R as n}from"./react-vendor-Bp2pLdQf.js";import{u as a,a as s,b as o,W as r}from"./WizardStepper-wmT1Y9zi.js";import{l,c}from"./index-DqdNwg8u.js";import{D as d}from"./DateRangePicker-DUtwU8_8.js";import{u as p}from"./useQuery-CCqhzSCy.js";import{e as h,p as u,v as m}from"./patientService-CO87WLOJ.js";import{n as v,a as g}from"./notificationErrorHandler-BfRvltaR.js";class b{cache=new Map;options;stats;cleanupTimer;constructor(e={}){this.options={ttl:e.ttl??3e5,maxSize:e.maxSize??1/0,onEvict:e.onEvict??(()=>{}),enableStats:e.enableStats??!0,cleanupInterval:e.cleanupInterval??6e4},this.stats={hits:0,misses:0,evictions:0,entries:0,lastCleanup:Date.now(),hitRate:0},this.startAutoCleanup()}get(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>this.options.ttl?(this.cache.delete(e),this.incrementEvictions(),this.incrementMisses(),null):(this.incrementHits(),t.value):(this.incrementMisses(),null)}set(e,t){this.cache.size>=this.options.maxSize&&!this.cache.has(e)&&this.evictOldest(),this.cache.set(e,{value:t,timestamp:Date.now()}),this.updateEntryCount()}has(e){const t=this.cache.get(e);return!!t&&(!(Date.now()-t.timestamp>this.options.ttl)||(this.cache.delete(e),!1))}delete(e){const t=this.cache.delete(e);return t&&this.updateEntryCount(),t}invalidate(e){let t=0;for(const[i,n]of this.cache.entries())e(i,n.value)&&(this.cache.delete(i),this.options.onEvict(i,n.value),t++);return t>0&&(this.stats.evictions+=t,this.updateEntryCount()),t}clear(){this.cache.clear(),this.stats={hits:0,misses:0,evictions:0,entries:0,lastCleanup:Date.now(),hitRate:0}}getStats(){return{...this.stats}}keys(){return Array.from(this.cache.keys())}size(){return this.cache.size}cleanup(){const e=Date.now();let t=0;for(const[i,n]of this.cache.entries())e-n.timestamp>this.options.ttl&&(this.cache.delete(i),this.options.onEvict(i,n.value),t++);t>0&&(this.stats.evictions+=t,this.updateEntryCount()),this.stats.lastCleanup=e}destroy(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=void 0),this.clear()}evictOldest(){const e=Array.from(this.cache.entries());if(0===e.length)return;const[t,i]=e.reduce((e,t)=>t[1].timestamp<e[1].timestamp?t:e);this.cache.delete(t),this.options.onEvict(t,i.value),this.incrementEvictions()}startAutoCleanup(){this.options.cleanupInterval>0&&(this.cleanupTimer=setInterval(()=>{this.cleanup()},this.options.cleanupInterval))}incrementHits(){this.options.enableStats&&(this.stats.hits++,this.updateHitRate())}incrementMisses(){this.options.enableStats&&(this.stats.misses++,this.updateHitRate())}incrementEvictions(){this.options.enableStats&&this.stats.evictions++}updateEntryCount(){this.options.enableStats&&(this.stats.entries=this.cache.size)}updateHitRate(){const e=this.stats.hits+this.stats.misses;this.stats.hitRate=e>0?this.stats.hits/e:0}}const x={activeOnly:!0,maxResults:10,minSearchLength:2,debounceDelay:300,enableCache:!0,includeFields:["id","nome","cognome","codice_fiscale","data_nascita","reparto_appartenenza","data_ricovero","data_dimissione","codice_rad"]};const f=new class{cache;pendingRequests;debounceTimers;constructor(){this.cache=new b({ttl:3e5,maxSize:100,enableStats:!0}),this.pendingRequests=new Map,this.debounceTimers=new Map}async search(e,t={}){const i={...x,...t};if(e.length<i.minSearchLength)return[];const n=this.buildCacheKey(e,i);if(i.enableCache){const t=this.cache.get(n);if(t)return l.debug("[PatientSearch] Cache hit",{searchTerm:e,count:t.length}),t}const a=this.pendingRequests.get(n);if(a)return l.debug("[PatientSearch] Request deduplication",{searchTerm:e}),a;const s=this.executeSearch(e,i);this.pendingRequests.set(n,s);try{const e=await s;return i.enableCache&&this.cache.set(n,e),e}finally{this.pendingRequests.delete(n)}}searchDebounced(e,t={}){const i={...x,...t},n=this.buildCacheKey(e,i);return new Promise((a,s)=>{const o=this.debounceTimers.get(n);o&&clearTimeout(o);const r=setTimeout(async()=>{try{const i=await this.search(e,t);a(i)}catch(i){s(i)}finally{this.debounceTimers.delete(n)}},i.debounceDelay);this.debounceTimers.set(n,r)})}async executeSearch(e,t){try{l.debug("[PatientSearch] Executing search",{searchTerm:e,options:t});let i=c.from("pazienti").select(t.includeFields.join(",")).limit(t.maxResults);t.activeOnly&&(i=i.is("data_dimissione",null));const n=e.trim().split(/\s+/);if(1===n.length){const e=`%${n[0]}%`;i=i.or(`nome.ilike.${e},cognome.ilike.${e},codice_fiscale.ilike.${e},codice_rad.ilike.${e}`)}else if(2===n.length){const e=n[0],t=n[1];i=i.or([`and(nome.ilike.%${e}%,nome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(nome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,nome.ilike.%${t}%)`,`codice_rad.ilike.%${e}%${t}%`,`codice_rad.ilike.%${t}%${e}%`].join(","))}else{const e=n[0],t=n[1];i=i.or([`and(nome.ilike.%${e}%,nome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(nome.ilike.%${e}%,cognome.ilike.%${t}%)`,`and(cognome.ilike.%${e}%,nome.ilike.%${t}%)`].join(","))}i=i.order("cognome").order("nome");const{data:a,error:s}=await i;if(s)throw l.error("[PatientSearch] Search error",s),s;return l.debug("[PatientSearch] Search completed",{searchTerm:e,resultsCount:a?.length??0}),a??[]}catch(i){throw l.error("[PatientSearch] Unexpected error",i),i}}buildCacheKey(e,t){return JSON.stringify({term:e.toLowerCase(),activeOnly:t.activeOnly??!0,maxResults:t.maxResults??10})}clearCache(){this.cache.clear(),l.debug("[PatientSearch] Cache cleared")}getCacheStats(){return this.cache.getStats()}invalidateCache(e){if(!e)return this.clearCache(),void 0;this.cache.invalidate(t=>t.includes(e.toLowerCase()))}},_={activeOnly:!1,maxResults:10,minSearchLength:2,debounceDelay:300,enableCache:!0,enabled:!0};const j=({value:n,onChange:a,placeholder:s="Cerca paziente...",className:o="",disabled:r=!1,required:c=!1,activeOnly:d=!1,maxResults:p=10,minSearchLength:h=2,debounceDelay:u=300,showPatientInfo:m=!0,highlightMatch:v=!0})=>{const g=t.useId(),b=`patient-autocomplete-${g}`,x=`patient-autocomplete-list-${g}`,j=t.useRef(null),N=t.useRef(null),S=t.useRef(null),[z,w]=t.useState(!1),[y,E]=t.useState(-1),[C,k]=t.useState(""),[D,I]=t.useState({top:0,left:0,width:0}),{searchTerm:P,setSearchTerm:R,results:T,loading:$,error:A,clearSearch:L}=function(e={}){const i={..._,...e},{enabled:n,minSearchLength:a,...s}=i,[o,r]=t.useState(""),[c,d]=t.useState([]),[p,h]=t.useState(!1),[u,m]=t.useState(null),v=t.useRef(null),g=t.useRef(!1),b=t.useCallback(async e=>{if(!g.current){if(!e||e.trim().length<(a??2))return d([]),m(null),h(!1),void 0;v.current&&v.current.abort(),v.current=new AbortController,g.current=!0,h(!0),m(null);try{l.debug("[usePatientSearch] Performing search",{term:e});const t=await f.searchDebounced(e.trim(),s);v.current?.signal.aborted||(d(t),0===t.length&&m(`Nessun paziente trovato per "${e}"`))}catch(t){if(!v.current?.signal.aborted){const e=t instanceof Error?t.message:"Errore durante la ricerca";m(e),d([]),l.error("[usePatientSearch] Search error:",t)}}finally{v.current?.signal.aborted||h(!1),g.current=!1}}},[a,s]),x=t.useCallback(e=>{r(e),n&&b(e)},[n,b]),j=t.useCallback(()=>{r(""),d([]),m(null),v.current&&v.current.abort(),g.current=!1},[]),N=t.useCallback(()=>{o&&b(o)},[o,b]),S=f.getCacheStats();return t.useEffect(()=>()=>{v.current&&v.current.abort(),g.current=!1},[]),{searchTerm:o,setSearchTerm:x,results:c,loading:p,error:u,clearSearch:j,refetch:N,cacheStats:S}}({activeOnly:d,maxResults:p,minSearchLength:h,debounceDelay:u,enableCache:!0});t.useEffect(()=>{if(n){k(`${n.cognome} ${n.nome}`)}else k("")},[n]),t.useEffect(()=>{const e=e=>{const t=e.target,i=j.current&&j.current.contains(t),n=S.current&&S.current.contains(t);i||n||(w(!1),E(-1))};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),t.useEffect(()=>{if(z&&N.current){const e=N.current.getBoundingClientRect();I({top:e.top+e.height,left:e.left,width:e.width})}},[z]);const O=t.useMemo(()=>T.slice(0,p),[T,p]),M=t.useCallback((t,i)=>{if(!v||!i.trim())return t;const n=new RegExp(`(${i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return t.split(n).map((t,i)=>n.test(t)?e.jsx("mark",{className:"bg-warning text-dark",children:t},i):t)},[v]),q=t.useCallback(e=>{const t=e.target.value;k(t),R(t),t.trim().length>=h?(w(!0),E(-1)):(w(!1),E(-1)),t.trim()||a(null)},[R,h,a]),F=t.useCallback(e=>{a(e),w(!1),E(-1),l.log("[PatientAutocomplete] Patient selected:",{id:e.id,name:`${e.cognome} ${e.nome}`})},[a]),H=t.useCallback(e=>{if(!z||0===O.length)return"ArrowDown"===e.key&&P.trim().length>=h&&(w(!0),E(0)),void 0;switch(e.key){case"ArrowDown":e.preventDefault(),E(e=>e<O.length-1?e+1:0);break;case"ArrowUp":e.preventDefault(),E(e=>e>0?e-1:O.length-1);break;case"Enter":e.preventDefault(),y>=0&&O[y]&&F(O[y]);break;case"Escape":e.preventDefault(),w(!1),E(-1),N.current?.blur()}},[z,O,y,P,h,F]),K=t.useCallback(()=>{P.trim().length>=h&&O.length>0&&w(!0)},[P,h,O.length]),B=t.useCallback(()=>{k(""),R(""),w(!1),E(-1),a(null),L()},[R,a,L]),X=t.useCallback(e=>M(`${e.cognome} ${e.nome}`,P),[P,M]),V=t.useCallback(e=>{const t=[];if(e.codice_rad&&t.push(`RAD: ${e.codice_rad}`),e.reparto_appartenenza&&t.push(e.reparto_appartenenza),e.data_ricovero){const i=new Date(e.data_ricovero);t.push(`Ric: ${i.toLocaleDateString("it-IT")}`)}return t.join(" • ")},[]);return t.useEffect(()=>{if(y>=0&&S.current){const e=S.current.children[y];e&&e.scrollIntoView({block:"nearest"})}},[y]),t.useEffect(()=>{if(!z||!S.current)return;const e=e=>{e.stopPropagation(),e.preventDefault();const t=e.currentTarget,i=S.current?.querySelectorAll('li[role="option"]');if(i){const e=Array.from(i).indexOf(t);e>=0&&O[e]&&F(O[e])}};let t=0;const i=()=>{if(!S.current)return;const n=S.current.querySelectorAll('li[role="option"]');n.length>0?n.forEach(t=>{t.addEventListener("click",e,!1)}):t<10&&(t++,setTimeout(i,50))};return i(),()=>{if(S.current){S.current.querySelectorAll('li[role="option"]').forEach(t=>{t.removeEventListener("click",e,!1)})}}},[z,O,F]),e.jsxs("div",{className:`patient-autocomplete position-relative ${o}`,ref:j,children:[e.jsxs("div",{className:"input-group",children:[e.jsx("input",{ref:N,id:b,type:"text",className:"form-control "+(r?"bg-light":""),placeholder:s,value:C,onChange:q,onKeyDown:H,onFocus:K,disabled:r,required:c,role:"combobox","aria-controls":x,"aria-expanded":z,"aria-autocomplete":"list","aria-busy":$,"aria-describedby":A?`${b}-error`:void 0}),C&&!r&&e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:B,"aria-label":"Cancella ricerca",children:e.jsx("i",{className:"bi bi-x-lg"})}),$&&e.jsx("span",{className:"input-group-text",children:e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"})})]}),A&&e.jsx("div",{id:`${b}-error`,className:"form-text text-danger mt-1",children:A}),z&&i.createPortal(e.jsxs("ul",{ref:S,id:x,className:"list-group shadow-sm",style:{position:"fixed",top:`${D.top}px`,left:`${D.left}px`,width:`${D.width}px`,maxHeight:"300px",overflowY:"auto",zIndex:9999,backgroundColor:"white",borderRadius:"0.25rem",border:"1px solid #dee2e6"},role:"listbox",children:[$&&e.jsxs("li",{className:"list-group-item text-muted",role:"presentation",children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Ricerca in corso..."]}),!$&&0===O.length&&P.trim().length>=h&&e.jsxs("li",{className:"list-group-item text-muted text-center py-3",role:"presentation",children:[e.jsx("i",{className:"bi bi-person-x fs-4 d-block mb-2"}),'Nessun paziente trovato per "',e.jsx("strong",{children:P}),'"']}),!$&&O.map((t,i)=>e.jsx("li",{role:"option",className:`list-group-item list-group-item-action cursor-pointer ${i===y?"active":""} ${n?.id===t.id?"border-primary":""}`,onMouseEnter:()=>E(i),"aria-selected":i===y,"data-patient-index":i,children:e.jsx("div",{className:"d-flex justify-content-between align-items-start",children:e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"fw-semibold",children:[X(t),n?.id===t.id&&e.jsx("i",{className:"bi bi-check-circle-fill text-primary ms-2","aria-label":"Selezionato"})]}),m&&e.jsx("div",{className:"small text-muted mt-1",children:V(t)}),t.diagnosi&&e.jsxs("div",{className:"small text-muted mt-1",children:[e.jsx("i",{className:"bi bi-clipboard2-pulse me-1"}),t.diagnosi]})]})})},t.id))]}),document.body)]})},N=[{value:"batterico",label:"Batterico"},{value:"virale",label:"Virale"},{value:"fungino",label:"Fungino"},{value:"parassitario",label:"Parassitario"}],S={TEXTAREA_ROWS:{DESCRIPTION:4,NOTES:6},BREAKPOINTS:{MOBILE_MAX:991},DEBOUNCE:{PATIENT_SEARCH:300}},z={PLACEHOLDER:"Cerca per nome, cognome o RAD...",HELP_TEXT:"Seleziona un paziente per continuare",SELECTED:(e,t)=>`Paziente selezionato: ${e} ${t}`},w=({values:t,onChange:i,hasPatient:n=!0,selectedPatient:a=null,onSelectPatient:s,onPatientSelect:o})=>e.jsx("div",{className:"wizard-step","data-step":"event-type",children:e.jsxs("div",{className:"wizard-step-content",children:[!n&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"wizard-step-title",children:"Seleziona Paziente"}),e.jsxs("div",{className:"mb-4",children:[e.jsx(j,{value:a,onChange:e=>{s&&s(e?.id||""),o&&o(e)},placeholder:z.PLACEHOLDER,activeOnly:!1,maxResults:10,minSearchLength:1,debounceDelay:S.DEBOUNCE.PATIENT_SEARCH,showPatientInfo:!0,highlightMatch:!0}),a&&e.jsxs("div",{className:"alert alert-success mt-3",role:"alert",children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),z.SELECTED(a.cognome,a.nome)]}),!a&&e.jsxs("div",{className:"alert alert-info mt-3",role:"alert",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),z.HELP_TEXT]})]}),!a&&e.jsx("div",{style:{marginBottom:"2rem"}})]}),(n||a)&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"wizard-step-title",children:"Tipo di Evento"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona il tipo di evento clinico da registrare"}),e.jsx("div",{className:"event-type-selection",children:e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"event-type-card "+("intervento"===t.tipo_evento?"selected":""),onClick:()=>i({tipo_evento:"intervento"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),i({tipo_evento:"intervento"}))},children:[e.jsx("div",{className:"event-type-card-icon",children:e.jsx("i",{className:"bi bi-heart-pulse"})}),e.jsxs("div",{className:"event-type-card-content",children:[e.jsx("h4",{className:"event-type-card-title",children:"Intervento Chirurgico"}),e.jsx("p",{className:"event-type-card-description",children:"Registra un intervento chirurgico eseguito sul paziente"})]}),e.jsx("div",{className:"event-type-card-radio",children:e.jsx("input",{type:"radio",name:"tipo_evento",value:"intervento",checked:"intervento"===t.tipo_evento,onChange:()=>i({tipo_evento:"intervento"}),className:"form-check-input"})})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"event-type-card "+("infezione"===t.tipo_evento?"selected":""),onClick:()=>i({tipo_evento:"infezione"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),i({tipo_evento:"infezione"}))},children:[e.jsx("div",{className:"event-type-card-icon",children:e.jsx("i",{className:"bi bi-virus"})}),e.jsxs("div",{className:"event-type-card-content",children:[e.jsx("h4",{className:"event-type-card-title",children:"Infezione"}),e.jsx("p",{className:"event-type-card-description",children:"Registra un'infezione contratta dal paziente"})]}),e.jsx("div",{className:"event-type-card-radio",children:e.jsx("input",{type:"radio",name:"tipo_evento",value:"infezione",checked:"infezione"===t.tipo_evento,onChange:()=>i({tipo_evento:"infezione"}),className:"form-check-input"})})]})})]})})]})]})}),y=({values:t,onChange:i,errors:n,isSubmitting:a,tipiIntervento:s,agentiPatogeno:o,loadingTypes:r,loadingPatogens:l})=>{const c="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"event-details",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:c?"Dettagli Intervento":"Dettagli Infezione"}),e.jsx("p",{className:"wizard-step-description",children:c?"Specifica il tipo di intervento e la descrizione":"Specifica l'agente patogeno e il tipo"}),e.jsxs(e.Fragment,c?{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"tipo_intervento_id",className:"form-label",children:["Tipo Intervento ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("select",{id:"tipo_intervento_id",name:"tipo_intervento_id",className:"form-select "+(n?.tipo_intervento_id?"is-invalid":""),value:t.tipo_intervento_id?String(t.tipo_intervento_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):void 0;i({tipo_intervento_id:t})},disabled:a||r,required:!0,children:[e.jsx("option",{value:"",children:r?"Caricamento tipi intervento...":"Seleziona tipo intervento..."}),s.map(t=>e.jsx("option",{value:String(t.id),children:t.nome},t.id))]}),n?.tipo_intervento_id&&e.jsx("div",{className:"invalid-feedback",role:"alert",children:n.tipo_intervento_id})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"descrizione_intervento",className:"form-label",children:"Descrizione Dettagliata"}),e.jsx("textarea",{id:"descrizione_intervento",name:"descrizione_intervento",className:"form-control",value:t.descrizione_intervento||"",onChange:e=>i({descrizione_intervento:e.target.value}),disabled:a,rows:S.TEXTAREA_ROWS.DESCRIPTION,placeholder:"Descrivere dettagliatamente l'intervento eseguito..."}),e.jsx("div",{className:"form-text",children:"Opzionale - Fornire una descrizione dettagliata della procedura"})]})]}:{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"agente_patogeno_id",className:"form-label",children:["Agente Eziologico ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("select",{id:"agente_patogeno_id",name:"agente_patogeno_id",className:"form-select "+(n?.agente_patogeno_id?"is-invalid":""),value:t.agente_patogeno_id?String(t.agente_patogeno_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):void 0;i({agente_patogeno_id:t})},disabled:a||l,required:!0,children:[e.jsx("option",{value:"",children:l?"Caricamento agenti patogeno...":"Seleziona agente eziologico..."}),o.map(t=>e.jsx("option",{value:String(t.id),children:t.nome},t.id))]}),n?.agente_patogeno_id&&e.jsx("div",{className:"invalid-feedback",role:"alert",children:n.agente_patogeno_id}),e.jsx("div",{className:"form-text",children:"Selezionare l'agente responsabile dell'infezione"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"tipo_patogeno",className:"form-label",children:"Tipo Patogeno"}),e.jsxs("select",{id:"tipo_patogeno",name:"tipo_patogeno",className:"form-select",value:t.tipo_patogeno||"",onChange:e=>i({tipo_patogeno:e.target.value}),disabled:a,children:[e.jsx("option",{value:"",children:"Seleziona tipo patogeno..."}),N.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]}),e.jsx("div",{className:"form-text",children:"Opzionale - Specificare la categoria del patogeno"})]})]})]})})},E=({values:t,onChange:i,errors:n,isSubmitting:a,showResolutionDate:s,setShowResolutionDate:o})=>{const r="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"dates",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Date Evento"}),e.jsx("p",{className:"wizard-step-description",children:r?"Specifica quando è stato eseguito l'intervento":"Specifica le date di inizio e fine dell'infezione"}),r?e.jsx("div",{className:"mb-3",children:e.jsx(d,{label:"Data Intervento",value:t.data_evento||"",onChange:e=>i({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:a,isInvalid:!!n?.data_evento,errorMessage:n?.data_evento})}):e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-12 mb-3",children:e.jsx(d,{label:"Data Inizio",value:t.data_evento||"",onChange:e=>i({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:a,isInvalid:!!n?.data_evento,errorMessage:n?.data_evento})}),e.jsxs("div",{className:"col-12 mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2 gap-2",children:[e.jsx("label",{htmlFor:"toggle_resolution",className:"form-label mb-0",children:"Data Fine"}),e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"toggle_resolution",checked:s,onChange:e=>{o(e.target.checked),e.target.checked||i({data_fine_evento:""})},disabled:a}),e.jsx("label",{className:"form-check-label",htmlFor:"toggle_resolution",children:"Infezione risolta"})]})]}),s&&e.jsx(d,{value:t.data_fine_evento||"",onChange:e=>i({data_fine_evento:e||""}),placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:a,isInvalid:!!n?.data_fine_evento,errorMessage:n?.data_fine_evento})]})]})]})})},C=({values:t,onChange:i,isSubmitting:n})=>{const a="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"notes",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Note Aggiuntive"}),e.jsx("p",{className:"wizard-step-description",children:"Aggiungi informazioni o osservazioni rilevanti (opzionale)"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"note",className:"form-label",children:a?"Note Aggiuntive":"Note Cliniche"}),e.jsx("textarea",{id:"note",name:"note",className:"form-control",value:t.note||"",onChange:e=>i({note:e.target.value}),disabled:n,rows:S.TEXTAREA_ROWS.NOTES,placeholder:a?"Note aggiuntive sull'intervento...":"Sintomi, terapia, esami, decorso...","aria-describedby":"note-help"}),e.jsxs("div",{id:"note-help",className:"form-text",children:["Opzionale - ",a?"Informazioni aggiuntive sull'intervento":"Informazioni cliniche rilevanti"]})]})]})})},k=({values:i,tipiIntervento:n,agentiPatogeno:a})=>{const s="intervento"===i.tipo_evento,o=t.useMemo(()=>n.find(e=>e.id===i.tipo_intervento_id)?.nome,[n,i.tipo_intervento_id]),r=t.useMemo(()=>a.find(e=>e.id===i.agente_patogeno_id)?.nome,[a,i.agente_patogeno_id]);return e.jsx("div",{className:"wizard-step","data-step":"review",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Riepilogo"}),e.jsx("p",{className:"wizard-step-description",children:"Verifica i dati inseriti prima di salvare"}),e.jsxs("div",{className:"event-review-summary",children:[e.jsxs("div",{className:"alert alert-light",children:[e.jsx("h5",{className:"alert-heading",children:s?"Intervento Chirurgico":"Infezione"}),e.jsx("hr",{}),e.jsxs(e.Fragment,s?{children:[e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Tipo Intervento:"})," ",e.jsx("span",{children:o||"Non specificato"})]}),i.descrizione_intervento&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Descrizione:"})," ",e.jsx("span",{children:i.descrizione_intervento})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Intervento:"})," ",e.jsx("span",{children:i.data_evento||"Non specificata"})]})]}:{children:[e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Agente Eziologico:"})," ",e.jsx("span",{children:r||"Non specificato"})]}),i.tipo_patogeno&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Tipo Patogeno:"})," ",e.jsx("span",{children:N.find(e=>e.value===i.tipo_patogeno)?.label})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Inizio:"})," ",e.jsx("span",{children:i.data_evento||"Non specificata"})]}),i.data_fine_evento&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Fine:"})," ",e.jsx("span",{children:i.data_fine_evento})]})]}),i.note&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Note:"})," ",e.jsx("span",{children:i.note})]})]}),e.jsxs("div",{className:"alert alert-info",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),"Verifica che tutti i dati siano corretti. Puoi tornare indietro per modificare qualsiasi campo prima di salvare."]})]})]})})},D=["event-type","event-details","dates","notes","review"],I={"event-type":"Tipo Evento","event-details":"Dettagli",dates:"Date",notes:"Note",review:"Riepilogo"},P=({patientId:i,event:c,onSubmit:d,onCancel:b})=>{const x=!!c,f=((e="event-type")=>a({steps:D,labels:I,initialStep:e}))("event-type"),_=s({currentStep:f.currentStep,getStepLabel:f.getStepLabel,totalSteps:f.totalSteps,currentStepNumber:f.getStepNumber(f.currentStep),enabled:!1});o();const{patient:j}=(e=>{const{data:t,isLoading:i,error:n}=p({queryKey:["patient",e],queryFn:async()=>{if(!e)return null;try{const t=await u.getPatientById(e);if(t){const i={id:t.id,nome:t.nome,cognome:t.cognome};return l.info("Patient loaded successfully",{patientId:e}),i}return l.warn("Patient not found",{patientId:e}),g("Paziente non trovato",{duration:3e3}),null}catch(t){const i=t instanceof Error?t:new Error(String(t));throw l.error("Error loading patient data",{patientId:e,error:i}),v("Errore nel caricamento del paziente",{duration:5e3}),i}},enabled:!!e,staleTime:3e5});return{patient:t||null,loading:i,error:n instanceof Error?n:null}})(i),{tipiIntervento:N,agentiPatogeno:S,loading:z}=(()=>{const{data:e,isLoading:i,error:n}=p({queryKey:["eventLookupTables"],queryFn:async()=>{try{const[e,t]=await Promise.all([h.getListaTipiIntervento(),h.getListaAgentiPatogeno()]);return l.info("Event lookup tables loaded successfully",{tipiCount:e.length,agentiCount:t.length}),{tipi:e,agenti:t}}catch(e){const t=e instanceof Error?e:new Error(String(e));throw l.error("Error loading event lookup tables",{error:t}),v("Impossibile caricare i dati. Riprova più tardi.",{duration:5e3}),t}},staleTime:6e5}),a=e?.tipi||[],s=e?.agenti||[],o=t.useMemo(()=>new Map(a.map(e=>[e.id,e.nome])),[a]),r=t.useMemo(()=>new Map(s.map(e=>[e.id,e.nome])),[s]);return{tipiIntervento:a,agentiPatogeno:s,loading:i,error:n instanceof Error?n:null,tipiInterventoMap:o,agentiPatogeniMap:r}})(),[P,R]=t.useState(i||""),[T,$]=t.useState(j),[A,L]=t.useState({paziente_id:P,tipo_evento:c?.tipo_evento||"intervento",data_evento:c?.data_evento||"",tipo_intervento_id:c?.tipo_intervento_id??void 0,descrizione_intervento:c?.descrizione_intervento||"",agente_patogeno_id:c?.agente_patogeno_id??void 0,tipo_patogeno:c?.tipo_patogeno??void 0,data_fine_evento:c?.data_fine_evento||"",note:c?.note||""}),[O,M]=t.useState(!!c?.data_fine_evento),[q,F]=t.useState({}),[H,K]=t.useState(!1);n.useEffect(()=>{j&&$(j)},[j]);const B=e=>{R(e),L(t=>({...t,paziente_id:e}))},X=e=>{$(e)},V=e=>{L(t=>({...t,...e}));const t=Object.keys(e);t.some(e=>q[e])&&F(e=>{const i={...e};return t.forEach(e=>delete i[e]),i})},W=()=>{switch(f.currentStep){case"event-type":return!!P&&!!A.tipo_evento;case"event-details":return"intervento"===A.tipo_evento?!!A.tipo_intervento_id:"infezione"===A.tipo_evento&&!!A.agente_patogeno_id;case"dates":return!!A.data_evento;case"notes":case"review":return!0;default:return!1}};return e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),!(()=>{const e={};if(!P)return e.paziente_id="Seleziona un paziente",F(e),!1;if(A.tipo_evento||(e.tipo_evento="Seleziona il tipo di evento"),"intervento"===A.tipo_evento&&(A.tipo_intervento_id||(e.tipo_intervento_id="Il tipo di intervento è obbligatorio"),A.data_evento||(e.data_evento="La data dell'intervento è obbligatoria")),"infezione"===A.tipo_evento){A.agente_patogeno_id||(e.agente_patogeno_id="Il tipo di batterio è obbligatorio"),A.data_evento||(e.data_evento="La data di inizio infezione è obbligatoria");const t=m(A.data_evento,O?A.data_fine_evento:void 0,"infezione");t&&(e.data_evento=t)}if("intervento"===A.tipo_evento){A.data_evento||(e.data_evento="La data dell'intervento è obbligatoria");const t=m(A.data_evento,void 0,"intervento");t&&(e.data_evento=t)}return F(e),0===Object.keys(e).length})())return f.goToStep("event-type"),void 0;try{K(!0);const e={paziente_id:P,tipo_evento:A.tipo_evento,data_evento:A.data_evento,note:A.note};"intervento"===A.tipo_evento&&(e.tipo_intervento_id=A.tipo_intervento_id,e.descrizione_intervento=A.descrizione_intervento),"infezione"===A.tipo_evento&&(e.agente_patogeno_id=A.agente_patogeno_id,e.tipo_patogeno=A.tipo_patogeno,O&&(e.data_fine_evento=A.data_fine_evento)),await d(e)}catch(t){l.error("Errore durante il salvataggio del evento",{error:t}),v("Errore durante il salvataggio. Riprova più tardi.",{duration:5e3}),K(!1)}},className:"wizard-form event-wizard-form",noValidate:!0,children:[e.jsxs("div",{className:"wizard-form-header",children:[e.jsx("button",{type:"button",className:"wizard-back-button",onClick:b,disabled:H,"aria-label":"Torna indietro",children:e.jsx("i",{className:"bi bi-arrow-left"})}),e.jsx("h1",{className:"wizard-form-title",children:x?"Modifica Evento":"Nuovo Evento"})]}),e.jsx(r,{currentStep:f.currentStep,getStepLabel:f.getStepLabel,getStepNumber:f.getStepNumber,totalSteps:f.totalSteps,stepOrder:D,themeColor:"clinical",extraInfo:T&&f.getStepNumber(f.currentStep)>1?e.jsxs("div",{className:"wizard-patient-info",children:[e.jsx("small",{className:"text-muted",children:"Paziente:"}),e.jsxs("strong",{children:[T.cognome," ",T.nome]})]}):null}),e.jsx("div",{ref:_,className:"wizard-form-content",children:(()=>{const t=!!P,i={values:A,onChange:V,errors:q,isSubmitting:H};switch(f.currentStep){case"event-type":return e.jsx(w,{...i,hasPatient:t,selectedPatient:T,onSelectPatient:B,onPatientSelect:X});case"event-details":return e.jsx(y,{...i,tipiIntervento:N,agentiPatogeno:S,loadingTypes:z,loadingPatogens:z});case"dates":return e.jsx(E,{...i,showResolutionDate:O,setShowResolutionDate:M});case"notes":return e.jsx(C,{...i});case"review":return e.jsx(k,{...i,tipiIntervento:N,agentiPatogeno:S,loadingTypes:z,loadingPatogens:z});default:return null}})()}),e.jsxs("div",{className:"wizard-form-actions",children:[f.canGoPrev&&e.jsxs("button",{type:"button",className:"btn btn-secondary btn-block",onClick:f.prevStep,disabled:H,children:[e.jsx("i",{className:"bi bi-chevron-left"})," Indietro"]}),"review"!==f.currentStep?e.jsxs("button",{type:"button",className:"btn btn-primary btn-block",onClick:f.nextStep,disabled:H||!W(),title:W()?void 0:"Completa i campi obbligatori per continuare",children:["Avanti ",e.jsx("i",{className:"bi bi-chevron-right"})]}):e.jsx("button",{type:"submit",className:"btn btn-success btn-block",disabled:H,children:e.jsxs(e.Fragment,H?{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio..."]}:{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),x?"Aggiorna Evento":"Salva Evento"]})})]})]})};export{P as E,S as F,j as P};
