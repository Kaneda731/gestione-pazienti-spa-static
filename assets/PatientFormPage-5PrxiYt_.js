import{j as e,D as a,C as i,B as n,l as s,u as t,c as r,d as o}from"./shared-DM1owLfs.js";import{a as l,e as c,l as d,z as m,A as p,B as u}from"./core-services-CSrwUk3W.js";import{r as h,u as g}from"./react-vendor-DMMrM9kC.js";import{I as v,a as x}from"./InterventionForm-SHeRVJ6n.js";import{M as f}from"./ui-vendor-CKm97sqn.js";import{g as b,a as j,b as N,p as w}from"./patientService-BUKaJ6EC.js";/* empty css               */import"./supabase-D6dgNb7x.js";const z=[{value:"dimissione",label:"Dimissione"},{value:"trasferimento_interno",label:"Trasferimento interno"},{value:"trasferimento_esterno",label:"Trasferimento esterno"},{value:"decesso",label:"Decesso"}],_=[{value:"0",label:"0 - Ordinaria"},{value:"6",label:"6 - Protetta"}],y=[{value:"",label:"Seleziona..."},{value:"56",label:"56 - Riabilitazione Motoria"},{value:"60",label:"60 - Lunga Degenza"}],C=[{value:"",label:"Seleziona..."},{value:"Cardiologia",label:"Cardiologia"},{value:"CR1",label:"CR1"},{value:"CR3",label:"CR3"},{value:"Gastroenterologia",label:"Gastroenterologia"},{value:"Ginecologia",label:"Ginecologia"},{value:"Medicina Interna",label:"Medicina Interna"},{value:"Neurologia",label:"Neurologia"},{value:"Pediatria",label:"Pediatria"},{value:"Pneumologia",label:"Pneumologia"},{value:"UGI",label:"UGI"},{value:"Urologia",label:"Urologia"}],S={data_dimissione:"",tipo_dimissione:"dimissione",codice_dimissione:"0"},D=({patientName:s,onDischargeSubmit:t})=>{const[r,o]=l.useState(!1),[c,d]=l.useState(S),[m,p]=l.useState(!1),u=e=>a=>{d("tipo_dimissione"===e?i=>{const n={...i,[e]:a};return"dimissione"===a?n.codice_dimissione="0":"trasferimento_esterno"===a?n.codice_dimissione="3":"trasferimento_interno"!==a&&"decesso"!==a||(n.codice_dimissione=null),n}:i=>({...i,[e]:a}))};return e.jsxs("div",{className:"discharge-section card mt-4",children:[e.jsx("div",{className:"card-header bg-light",children:e.jsxs("button",{type:"button",onClick:()=>o(!r),className:"btn btn-link w-100 text-start p-0 d-flex justify-content-between align-items-center",style:{textDecoration:"none",color:"inherit"},children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1.5rem"},children:r?"expand_less":"expand_more"}),e.jsx("strong",{children:"Dimissione / Trasferimento"}),e.jsx("span",{className:"badge bg-info",style:{fontSize:"0.75rem"},children:"Opzionale"})]}),r&&e.jsxs("span",{style:{fontSize:"0.875rem",color:"#6c757d"},children:["Paziente: ",s]})]})}),r&&e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"alert alert-info mb-3",children:[e.jsx("strong",{children:"Nota:"})," Registra i dati di dimissione o trasferimento del paziente. Questa sezione è facoltativa e può essere completata anche in un secondo momento."]}),e.jsxs("form",{id:"discharge-section",onSubmit:async e=>{if(e.preventDefault(),!m&&t){p(!0);try{await t(c),d(S),o(!1)}finally{p(!1)}}},className:"d-flex flex-column gap-3",children:[e.jsx(a,{label:"Data dimissione",value:c.data_dimissione,onChange:e=>{d(a=>({...a,data_dimissione:e||""}))},isRequired:r,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-type",children:["Tipo dimissione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(i,{id:"discharge-dismissal-type",value:c.tipo_dimissione,options:z.map(e=>({value:e.value,label:e.label})),onChange:u("tipo_dimissione"),placeholder:"Seleziona..."})]}),"dimissione"===c.tipo_dimissione&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"discharge-dismissal-code",children:"Codice dimissione"}),e.jsx(i,{id:"discharge-dismissal-code",value:c.codice_dimissione??"",options:_.map(e=>({value:e.value,label:e.label})),onChange:u("codice_dimissione"),placeholder:"Seleziona..."})]}),"trasferimento_interno"===c.tipo_dimissione&&e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-dept",children:["Reparto destinazione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(i,{id:"discharge-dismissal-dept",value:c.reparto_destinazione??"",options:C.map(e=>({value:e.value,label:e.label})),onChange:u("reparto_destinazione"),placeholder:"Seleziona..."})]}),"trasferimento_esterno"===c.tipo_dimissione&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-clinic",children:["Clinica destinazione ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{id:"discharge-dismissal-clinic",name:"clinica_destinazione",className:"form-control",value:c.clinica_destinazione??"",onChange:e=>{const{name:a,value:i}=e.target;d(e=>({...e,[a]:i}))},required:r&&"trasferimento_esterno"===c.tipo_dimissione})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",htmlFor:"discharge-dismissal-clinic-code",children:["Codice clinica ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(i,{id:"discharge-dismissal-clinic-code",value:c.codice_clinica??"",options:y.map(e=>({value:e.value,label:e.label})),onChange:u("codice_clinica"),placeholder:"Seleziona..."})]})]}),e.jsxs("div",{className:"d-flex gap-2 pt-2",children:[e.jsx(n,{type:"submit",disabled:m,children:m?"Registrazione in corso...":"Registra dimissione"}),e.jsx(n,{type:"button",variant:"secondary",onClick:()=>{d(S),o(!1)},children:"Annulla"})]})]})]})]})},I=["AR","PO","CO","CR","PS"],k=["Bassa","Media","Alta"],E=({values:a,onChange:i})=>e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-name",children:"Nome"}),e.jsx("input",{id:"patient-name",name:"nome",className:"form-control",value:a.nome,onChange:i,required:!0})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-surname",children:"Cognome"}),e.jsx("input",{id:"patient-surname",name:"cognome",className:"form-control",value:a.cognome,onChange:i,required:!0})]})]}),P=({values:i,onChange:n})=>{const s=e=>a=>{n({target:{name:e,value:a||""}})};return e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6",children:e.jsx(a,{id:"patient-birth-date",value:i.data_nascita,onChange:s("data_nascita"),label:"Data nascita",placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})}),e.jsx("div",{className:"col-md-6",children:e.jsx(a,{id:"patient-admission-date",value:i.data_ricovero,onChange:s("data_ricovero"),label:"Data ricovero",placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0})})]})},R=({values:a,onChange:n,diagnosiOptions:s,repartoOptions:t,loadingDiagnosi:r,loadingReparti:o})=>{const c=e=>a=>{n({target:{name:e,value:a}})},d=l.useMemo(()=>[{value:"",label:"Seleziona diagnosi..."},...s.map(e=>({value:e.nome,label:e.nome}))],[s]),m=l.useMemo(()=>0===s.length?"empty":s.map(e=>e.id).sort().join("-"),[s]),p=l.useMemo(()=>[{value:"",label:"Seleziona..."},...t.map(e=>({value:e,label:e}))],[t]);return e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-diagnosis",children:"Diagnosi"}),e.jsx(i,{id:"patient-diagnosis",value:a.diagnosi,options:d,onChange:c("diagnosi"),disabled:r,placeholder:"Seleziona diagnosi..."},`diagnosis-${m}`),r&&e.jsx("small",{className:"form-text text-muted",children:"Caricamento diagnosi in corso..."})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-ward",children:"Reparto Appartenenza"}),e.jsx(i,{id:"patient-ward",value:a.reparto_appartenenza,options:p,onChange:c("reparto_appartenenza"),disabled:o,placeholder:"Seleziona..."},`ward-${t.length}`),o&&e.jsx("small",{className:"form-text text-muted",children:"Caricamento reparti in corso..."})]})]})},F=({values:a,onChange:n})=>{const s=e=>a=>{n({target:{name:e,value:a}})},t=l.useMemo(()=>[{value:"",label:"Seleziona..."},...I.map(e=>({value:e,label:e}))],[]),r=l.useMemo(()=>[{value:"",label:"Seleziona..."},...k.map(e=>({value:e,label:e}))],[]);return e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-codice-rad",children:"Codice RAD"}),e.jsx("input",{id:"patient-codice-rad",name:"codice_rad",className:"form-control",value:a.codice_rad,onChange:n})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-reparto-provenienza",children:"Reparto Provenienza"}),e.jsx(i,{id:"patient-reparto-provenienza",value:a.reparto_provenienza,options:t,onChange:s("reparto_provenienza"),placeholder:"Seleziona..."},"reparto-provenienza")]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",htmlFor:"patient-livello-assistenza",children:"Livello Assistenza"}),e.jsx(i,{id:"patient-livello-assistenza",value:a.livello_assistenza,options:r,onChange:s("livello_assistenza"),placeholder:"Seleziona..."},"livello-assistenza")]})]})},B=({values:a,onCheckboxChange:i,onEditInfection:n,onEditSurgery:s,infectionBadge:t,surgeryBadge:r,renderBadge:o})=>e.jsxs("div",{className:"row mt-3",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"patient-infetto",name:"infetto",checked:a.infetto,onChange:i}),e.jsxs("label",{className:"form-check-label",htmlFor:"patient-infetto",children:["Paziente Infetto",o(t)]})]}),e.jsxs("button",{type:"button",className:"btn btn-link px-0",onClick:()=>{void n()},children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"edit"}),"Modifica dati infezione"]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"patient-ha-intervento",name:"ha_intervento",checked:a.ha_intervento,onChange:i}),e.jsxs("label",{className:"form-check-label",htmlFor:"patient-ha-intervento",children:["Intervento Chirurgico",o(r)]})]}),e.jsxs("button",{type:"button",className:"btn btn-link px-0",onClick:()=>{void s()},children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"edit"}),"Modifica dati intervento"]})]})]}),M=({values:a,onChange:i})=>e.jsxs("div",{children:[e.jsx("label",{className:"form-label",htmlFor:"patient-notes",children:"Note"}),e.jsx("textarea",{id:"patient-notes",name:"note",className:"form-control",value:a.note,onChange:i,rows:3})]}),$=({submitting:a,submitLabel:i,onCancel:s})=>e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(n,{type:"submit",disabled:a,children:i}),e.jsx(n,{type:"button",variant:"secondary",onClick:s,children:"Annulla"})]}),V=({patientId:a,patientName:i="Paziente",event:n,onSubmit:s,onClose:t})=>{const[r,o]=l.useState(!1),c=l.useRef(`infection-event-modal-${Date.now()}`).current,d=l.useRef(null),m=l.useRef(null),p=l.useRef(null),u=l.useRef(null);l.useEffect(()=>{const e=d.current;if(!e)return;u.current=document.activeElement;let a=requestAnimationFrame(()=>{if(d.current)try{const a=new f(e);m.current=a;const i=()=>{p.current=null;const e=u.current;u.current=null,e&&document.contains(e)&&queueMicrotask(()=>e.focus()),t()};p.current=i,e.addEventListener("hidden.bs.modal",i),a.show()}catch(a){console.error("Error initializing modal:",a)}});return()=>{null!==a&&(cancelAnimationFrame(a),a=null);const i=m.current;if(m.current=null,e&&p.current&&(e.removeEventListener("hidden.bs.modal",p.current),p.current=null),i)try{i.dispose()}catch(n){console.error("Error disposing modal:",n)}}},[t]);const h=l.useCallback(()=>{const e=m.current;if(e){const a=d.current,i=document.activeElement;i&&a?.contains(i)&&i.blur(),e.hide()}else t()},[t]);return e.jsx("div",{className:"modal fade",id:c,ref:d,tabIndex:-1,"aria-labelledby":`${c}-label`,"aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"modal-title mb-1",id:`${c}-label`,children:n?"Modifica Evento":"Registra Infezione"}),e.jsxs("p",{className:"text-muted mb-0 small",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"person"}),i]})]}),e.jsx("button",{type:"button",className:"btn-close","aria-label":"Chiudi","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body",children:e.jsx(v,{event:n,patientId:a,onSubmit:async e=>{o(!0);try{await s(e),h()}finally{o(!1)}},onCancel:h,isSubmitting:r})})]})})})},A={hasData:!1,isValid:!1,tooltip:""};const O=({patientId:a,patientName:i="Paziente",event:n,onSubmit:s,onClose:t})=>{const[r,o]=l.useState(!1),c=l.useRef(`intervention-event-modal-${Date.now()}`).current,d=l.useRef(null),m=l.useRef(null),p=l.useRef(null);l.useEffect(()=>{const e=d.current;if(!e)return;let a=requestAnimationFrame(()=>{if(d.current)try{const a=new f(e);m.current=a;const i=()=>{p.current=null,t()};p.current=i,e.addEventListener("hidden.bs.modal",i),a.show()}catch(a){console.error("Error initializing modal:",a)}});return()=>{null!==a&&(cancelAnimationFrame(a),a=null);const i=m.current;if(m.current=null,e&&p.current&&(e.removeEventListener("hidden.bs.modal",p.current),p.current=null),i)try{i.dispose()}catch(n){console.error("Error disposing modal:",n)}}},[t]);const u=l.useCallback(()=>{const e=m.current;e?e.hide():t()},[t]);return e.jsx("div",{className:"modal fade",id:c,ref:d,tabIndex:-1,"aria-labelledby":`${c}-label`,"aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"modal-title mb-1",id:`${c}-label`,children:n?"Modifica Evento":"Registra Intervento"}),e.jsxs("p",{className:"text-muted mb-0 small",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"1rem",marginRight:"0.5rem",verticalAlign:"text-bottom"},children:"person"}),i]})]}),e.jsx("button",{type:"button",className:"btn-close","aria-label":"Chiudi","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body",children:e.jsx(x,{event:n,patientId:a,onSubmit:async e=>{o(!0);try{await s(e),u()}finally{o(!1)}},onCancel:u,isSubmitting:r})})]})})})},L={hasData:!1,isValid:!1,tooltip:""};function T({values:a,setValues:i,patientDisplayName:n,patientId:s=""}){const t=function({setValues:a,patientDisplayName:i,patientId:n=""}){const[s,t]=l.useState(A),[r,o]=l.useState(!1),c=l.useCallback(async()=>{const e=await b();if(!e.hasInfectionData())return A;const a=e.getInfectionData(),i=[];return a?.data_evento&&i.push(`Data: ${a.data_evento}`),a?.agente_patogeno&&i.push(`Agente: ${a.agente_patogeno}`),a?.descrizione&&i.push(`Note: ${a.descrizione}`),{hasData:!0,isValid:0===(e.getValidationErrors?.()?.length??0),tooltip:i.join("\n")}},[]),d=l.useCallback(async()=>{const e=await c();t(e)},[c]),m=l.useCallback(async e=>{const i=await b();i.setInfectionData({data_evento:e.data_evento,agente_patogeno_id:e.agente_patogeno_id,tipo_patogeno:e.tipo_patogeno,data_fine_evento:e.data_fine_evento,note:e.note}),o(!1);const n=i.hasInfectionData();a(e=>({...e,infetto:n})),await d()},[a,d]),p=l.useCallback(async e=>{e?o(!0):((await b()).clearInfectionData(),a(e=>({...e,infetto:!1})),await d())},[a,d]),u=l.useCallback(async e=>{const{name:a,checked:i}=e.target;"infetto"===a&&await p(i)},[p]),g=l.useCallback(()=>{o(!0)},[]);return{badge:s,renderBadge:l.useCallback(a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),handleCheckboxChange:u,handleEditInfection:g,modalsPortal:h.createPortal(e.jsx(e.Fragment,{children:r&&e.jsx(V,{patientId:n,patientName:i||"Nuovo Paziente",onSubmit:m,onClose:()=>o(!1)})}),document.body),refreshSummary:d}}({values:a,setValues:i,patientDisplayName:n,patientId:s}),r=function({setValues:a,patientDisplayName:i,patientId:n=""}){const[s,t]=l.useState(L),[r,o]=l.useState(!1),c=l.useCallback(async()=>{const e=await j();if(!e.hasSurgeryData())return L;const a=e.getValidationErrors?.()?.length??0,i=e.getDataSummary?.(),n=[];return i?.dataIntervento&&n.push(`Intervento: ${i.dataIntervento}`),i?.tipoIntervento&&n.push(`Tipo: ${i.tipoIntervento}`),i?.hasInfection&&n.push("Infezione associata"),{hasData:!0,isValid:0===a,tooltip:n.join("\n")}},[]),d=l.useCallback(async()=>{const e=await c();t(e)},[c]),m=l.useCallback(async e=>{const i=await j();i.setSurgeryData({data_evento:e.data_evento,tipo_intervento_id:e.tipo_intervento_id,descrizione:e.descrizione_intervento}),o(!1);const n=i.hasSurgeryData();a(e=>({...e,ha_intervento:n})),await d()},[a,d]),p=l.useCallback(async e=>{e?o(!0):((await j()).clearSurgeryData(),a(e=>({...e,ha_intervento:!1})),await d())},[a,d]),u=l.useCallback(async e=>{const{name:a,checked:i}=e.target;"ha_intervento"===a&&await p(i)},[p]),g=l.useCallback(()=>{o(!0)},[]);return{badge:s,renderBadge:l.useCallback(a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),handleCheckboxChange:u,handleEditSurgery:g,modalsPortal:h.createPortal(e.jsx(e.Fragment,{children:r&&e.jsx(O,{patientId:n,patientName:i||"Nuovo Paziente",onSubmit:m,onClose:()=>o(!1)})}),document.body),refreshSummary:d}}({values:a,setValues:i,patientDisplayName:n,patientId:s});l.useEffect(()=>{(async()=>{await t.refreshSummary(),await r.refreshSummary()})()},[t,r]),l.useEffect(()=>()=>{N().then(({infection:e,surgery:a})=>{e.clearInfectionData(),a.clearSurgeryData()})},[]);const o=l.useCallback(async e=>{const{name:a}=e.target;return"infetto"===a?(await t.handleCheckboxChange(e),void 0):"ha_intervento"===a?(await r.handleCheckboxChange(e),void 0):(i(i=>({...i,[a]:e.target.checked})),void 0)},[t,r,i]),c=l.useMemo(()=>a=>a.hasData?e.jsx("span",{className:"badge ms-2 "+(a.isValid?"bg-success":"bg-warning text-dark"),title:a.tooltip,children:a.isValid?"Dati inseriti":"Dati incompleti"}):null,[]),d=l.useMemo(()=>e.jsxs(e.Fragment,{children:[t.modalsPortal,r.modalsPortal]}),[t.modalsPortal,r.modalsPortal]);return{infectionBadge:t.badge,surgeryBadge:r.badge,renderBadge:c,handleCheckboxChange:o,handleEditInfection:t.handleEditInfection,handleEditSurgery:r.handleEditSurgery,modalsPortal:d}}const G=e=>{if(null==e||""===e)return"";if(e instanceof Date)return e.toISOString().split("T")[0];const a=String(e);if(a.match(/^\d{4}-\d{2}-\d{2}$/))return a;try{const e=function(e){if(!e)return null;if(e.match(/^\d{4}-\d{2}-\d{2}$/))return e;if(!e.includes("/"))throw new Error("Formato data non valido. Utilizzare il formato gg/mm/aaaa");const a=e.split("/");if(3!==a.length)throw new Error("Formato data non valido. Utilizzare il formato gg/mm/aaaa");const[i,n,s]=a,t=parseInt(i,10),r=parseInt(n,10),o=parseInt(s,10);if(isNaN(t)||isNaN(r)||isNaN(o))throw new Error("Formato data non valido. Utilizzare numeri validi");if(t<1||t>31)throw new Error("Giorno non valido (1-31)");if(r<1||r>12)throw new Error("Mese non valido (1-12)");if(o<1900||o>2100)throw new Error("Anno non valido");const l=new Date(o,r-1,t);if(l.getDate()!==t||l.getMonth()!==r-1||l.getFullYear()!==o)throw new Error("Data non valida (es. 31/02/2025)");return`${s}-${n.padStart(2,"0")}-${i.padStart(2,"0")}`}(a);if(e)return e}catch(i){const e=new Date(a);if(!Number.isNaN(e.getTime()))return e.toISOString().split("T")[0]}return a},U=["data_nascita","data_ricovero","data_dimissione"];function q({initialPatient:e}){const[a,i]=l.useState(()=>({nome:"",cognome:"",data_nascita:"",data_ricovero:"",data_dimissione:"",diagnosi:"",reparto_appartenenza:"",reparto_provenienza:"",livello_assistenza:"",codice_rad:"",note:"",tipo_dimissione:"",codice_dimissione:"",reparto_destinazione:"",clinica_destinazione:"",codice_clinica:"",infetto:!1,ha_intervento:!1}));l.useEffect(()=>{if(!e)return i({nome:"",cognome:"",data_nascita:"",data_ricovero:"",data_dimissione:"",diagnosi:"",reparto_appartenenza:"",reparto_provenienza:"",livello_assistenza:"",codice_rad:"",note:"",tipo_dimissione:"",codice_dimissione:"",reparto_destinazione:"",clinica_destinazione:"",codice_clinica:"",infetto:!1,ha_intervento:!1}),void 0;const a={id:e.id??null,nome:e.nome??"",cognome:e.cognome??"",data_nascita:G(e.data_nascita??""),data_ricovero:G(e.data_ricovero??""),data_dimissione:G(e.data_dimissione??""),diagnosi:e.diagnosi??"",reparto_appartenenza:e.reparto_appartenenza??"",reparto_provenienza:e.reparto_provenienza??"",livello_assistenza:e.livello_assistenza??"",codice_rad:e.codice_rad??"",note:e.note??"",tipo_dimissione:e.tipo_dimissione??"",codice_dimissione:e.codice_dimissione??"",reparto_destinazione:e.reparto_destinazione??"",clinica_destinazione:e.clinica_destinazione??"",codice_clinica:e.codice_clinica??"",infetto:e.infetto??!1,ha_intervento:!1};i(a)},[e]);const n=l.useCallback(e=>{const{name:a,value:n,type:s}=e.target,t="checkbox"===s?e.target.checked:n;i(e=>{if("string"==typeof t&&U.includes(a)){const i=G(t);return{...e,[a]:i}}return{...e,[a]:t}})},[]);return{values:a,setValues:i,handleChange:n}}function W(){const[e,a]=l.useState([]),[i,n]=l.useState([]),[t,r]=l.useState(!1),[o,p]=l.useState(!1);return l.useEffect(()=>{void(async()=>{r(!0);try{const{data:e,error:i}=await c.from("diagnosi").select("id, nome").order("nome",{ascending:!0});if(i)d.error("Errore nel caricamento delle diagnosi",{error:i}),m("Impossibile caricare le diagnosi disponibili",{duration:5e3});else{const i=(e||[]).map(e=>({id:String(e.id),nome:e.nome}));a(i)}}catch(e){d.error("Errore imprevisto nel caricamento delle diagnosi",{error:e}),m("Errore nel caricamento delle diagnosi",{duration:5e3})}finally{r(!1)}})()},[]),l.useEffect(()=>{void(async()=>{p(!0);try{const e=await s();n(e)}catch(e){d.error("Errore nel caricamento dei reparti",{error:e}),m("Impossibile caricare i reparti disponibili",{duration:5e3})}finally{p(!1)}})()},[]),{diagnosiOptions:e,repartoOptions:i,loadingDiagnosi:t,loadingReparti:o}}function Q({values:e,surgeryDataManager:a,infectionDataManager:i,isPatientCurrentlyInfected:n}){const s={nome:e.nome?.trim()||"",cognome:e.cognome?.trim()||"",data_nascita:e.data_nascita||"",data_ricovero:e.data_ricovero||"",data_dimissione:e.data_dimissione||"",diagnosi:e.diagnosi?.trim()||"",reparto_appartenenza:e.reparto_appartenenza?.trim()||"",reparto_provenienza:e.reparto_provenienza?.trim()||"",livello_assistenza:e.livello_assistenza?.trim()||"",codice_rad:e.codice_rad?.trim()||"",tipo_dimissione:e.tipo_dimissione||null,codice_dimissione:e.codice_dimissione?.trim()||"",reparto_destinazione:e.reparto_destinazione?.trim()||"",clinica_destinazione:e.clinica_destinazione?.trim()||"",codice_clinica:e.codice_clinica?.trim()||null,note:e.note?.trim()||"",infetto:e.infetto||!1,_hasInfectionData:!1,_hasSurgeryData:!1};if(i.hasInfectionData()){const e=i.getInfectionData();e&&(s._hasInfectionData=!0,s._infectionData=e)}if(a.hasSurgeryData()){const e=a.getSurgeryData();e&&(s._hasSurgeryData=!0,s._surgeryData=e)}return n&&n()&&(s.infetto=!0),s}const Y=({patient:a,mode:i,onSubmit:n,onCancel:s,onValidate:t})=>{const{values:r,setValues:o,handleChange:c}=q({initialPatient:a}),[d,m]=l.useState(!1),p=l.useRef(null),u=l.useMemo(()=>[r.nome?.trim(),r.cognome?.trim()].filter(Boolean).join(" ").trim(),[r.nome,r.cognome]),{diagnosiOptions:h,repartoOptions:g,loadingDiagnosi:v,loadingReparti:x}=W(),{infectionBadge:f,surgeryBadge:b,renderBadge:j,handleCheckboxChange:w,handleEditInfection:z,handleEditSurgery:_,modalsPortal:y}=T({values:r,setValues:o,patientDisplayName:u,patientId:a?.id??""}),C=l.useCallback(async e=>{if(e.preventDefault(),!d){m(!0);try{const{infection:e,surgery:a}=await N(),i=Q({values:r,infectionDataManager:e,surgeryDataManager:a});if(t){if(!t(i).valid)return m(!1),void 0}await n(i)}finally{m(!1)}}},[n,t,d,r]),S="create"===i?"Salva paziente":"Aggiorna paziente";return e.jsxs(e.Fragment,{children:[e.jsxs("form",{id:"patient-form",ref:p,onSubmit:C,className:"d-flex flex-column gap-3",noValidate:!0,children:[e.jsx(E,{values:r,onChange:c}),e.jsx(P,{values:r,onChange:c}),e.jsx(R,{values:r,onChange:c,diagnosiOptions:h,repartoOptions:g,loadingDiagnosi:v,loadingReparti:x}),e.jsx(F,{values:r,onChange:c}),e.jsx(B,{values:r,onCheckboxChange:w,onEditInfection:z,onEditSurgery:_,infectionBadge:f,surgeryBadge:b,renderBadge:j}),e.jsx(M,{values:r,onChange:c}),e.jsx($,{submitting:d,submitLabel:S,onCancel:s})]}),y]})},H=["personal-info","admission-dates","diagnosis","provenance","clinical-flags","notes","review"],J={"personal-info":"Dati Personali","admission-dates":"Date Ricovero",diagnosis:"Diagnosi",provenance:"Provenienza","clinical-flags":"Dati Clinici",notes:"Note",review:"Riepilogo"},K=["personal-info","admission-dates","diagnosis","provenance","clinical-flags","notes","review"],X=({currentStep:a,totalSteps:i,getStepLabel:n,getStepNumber:s})=>{const t=K.indexOf(a),r=s(a);return e.jsxs("div",{className:"wizard-stepper",children:[e.jsx("div",{className:"wizard-stepper-progress",children:e.jsx("div",{className:"wizard-stepper-progress-bar",children:e.jsx("div",{className:"wizard-stepper-progress-fill",style:{width:r/i*100+"%"},role:"progressbar","aria-valuenow":r,"aria-valuemin":1,"aria-valuemax":i,"aria-label":`Progresso: ${r} di ${i}`})})}),e.jsxs("div",{className:"wizard-stepper-info",children:[e.jsx("span",{className:"wizard-stepper-label",children:n(a)}),e.jsxs("span",{className:"wizard-stepper-counter",children:[r," di ",i]})]}),e.jsx("div",{className:"wizard-stepper-dots d-md-none",children:K.map((i,s)=>e.jsx("div",{className:`wizard-stepper-dot ${i===a?"active":""} ${s<t?"completed":""}`,"aria-label":`Step ${s+1}: ${n(i)}`},i))})]})},Z=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Dati Personali"}),e.jsx("p",{className:"wizard-step-description",children:"Inserisci i dati anagrafici del paziente"}),e.jsx(E,{values:a,onChange:i})]})}),ee=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Date Importanti"}),e.jsx("p",{className:"wizard-step-description",children:"Inserisci la data di nascita e ricovero"}),e.jsx(P,{values:a,onChange:i})]})}),ae=({values:a,onChange:i,diagnosiOptions:n,repartoOptions:s,loadingDiagnosi:t,loadingReparti:r})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Diagnosi"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona la diagnosi e il reparto"}),e.jsx(R,{values:a,onChange:i,diagnosiOptions:n||[],repartoOptions:s||[],loadingDiagnosi:t??!1,loadingReparti:r??!1})]})}),ie=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Provenienza e Assistenza"}),e.jsx("p",{className:"wizard-step-description",children:"Informazioni sulla provenienza del paziente (opzionale)"}),e.jsx(F,{values:a,onChange:i})]})}),ne=({values:a,onCheckboxChange:i,onEditInfection:n,onEditSurgery:s,infectionBadge:t,surgeryBadge:r,renderBadge:o})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Dati Clinici"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona i flag clinici del paziente"}),e.jsx(B,{values:a,onCheckboxChange:i??(async()=>{}),onEditInfection:n??(async()=>{}),onEditSurgery:s??(async()=>{}),infectionBadge:t,surgeryBadge:r,renderBadge:o})]})}),se=({values:a,onChange:i})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Note Aggiuntive"}),e.jsx("p",{className:"wizard-step-description",children:"Aggiungi eventuali note (opzionale)"}),e.jsx(M,{values:a,onChange:i})]})}),te=({values:a})=>e.jsx("div",{className:"wizard-step",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Riepilogo"}),e.jsx("p",{className:"wizard-step-description",children:"Verifica i dati inseriti prima di confermare"}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Dati Personali"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Nome:"}),e.jsx("span",{className:"review-value",children:a.nome})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Cognome:"}),e.jsx("span",{className:"review-value",children:a.cognome})]})]})]}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Date"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Data Nascita:"}),e.jsx("span",{className:"review-value",children:a.data_nascita})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Data Ricovero:"}),e.jsx("span",{className:"review-value",children:a.data_ricovero})]})]})]}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Clinico"}),e.jsxs("div",{className:"review-grid",children:[e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Diagnosi:"}),e.jsx("span",{className:"review-value",children:a.diagnosi||"Non specificato"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Reparto:"}),e.jsx("span",{className:"review-value",children:a.reparto_appartenenza||"Non specificato"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Paziente Infetto:"}),e.jsx("span",{className:"review-value",children:a.infetto?"Sì":"No"})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("span",{className:"review-label",children:"Intervento Chirurgico:"}),e.jsx("span",{className:"review-value",children:a.ha_intervento?"Sì":"No"})]})]})]}),a.note&&e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{className:"review-section-title",children:"Note"}),e.jsx("p",{className:"review-notes",children:a.note})]})]})}),re=({patient:a,mode:i,onSubmit:n,onCancel:s,onValidate:c})=>{const{values:d,setValues:m,handleChange:p}=q({initialPatient:a}),[u,h]=l.useState(!1),g=l.useRef(null),v=((e="personal-info")=>t({steps:H,labels:J,initialStep:e}))("personal-info"),x=r({currentStep:v.currentStep,getStepLabel:v.getStepLabel,totalSteps:v.totalSteps,currentStepNumber:v.getStepNumber(v.currentStep)});o();const f=l.useMemo(()=>[d.nome?.trim(),d.cognome?.trim()].filter(Boolean).join(" ").trim(),[d.nome,d.cognome]),{diagnosiOptions:b,repartoOptions:j,loadingDiagnosi:w,loadingReparti:z}=W(),{infectionBadge:_,surgeryBadge:y,renderBadge:C,handleCheckboxChange:S,handleEditInfection:D,handleEditSurgery:I,modalsPortal:k}=T({values:d,setValues:m,patientDisplayName:f,patientId:a?.id??""}),E=l.useCallback(async e=>{if(e.preventDefault(),!u){h(!0);try{const{infection:e,surgery:a}=await N(),i=Q({values:d,infectionDataManager:e,surgeryDataManager:a});if(c){if(!c(i).valid)return h(!1),void 0}await n(i)}finally{h(!1)}}},[n,c,u,d]),P="create"===i?"Salva paziente":"Aggiorna paziente",R=l.useCallback(()=>{switch(v.currentStep){case"personal-info":return!!d.nome?.trim()&&!!d.cognome?.trim();case"admission-dates":return!!d.data_nascita&&!!d.data_ricovero;case"diagnosis":return!!d.diagnosi&&!!d.reparto_appartenenza;case"provenance":case"clinical-flags":case"notes":case"review":return!0;default:return!1}},[v.currentStep,d.nome,d.cognome,d.data_nascita,d.data_ricovero,d.diagnosi,d.reparto_appartenenza]);return e.jsxs(e.Fragment,{children:[e.jsxs("form",{id:"patient-form-wizard",ref:g,onSubmit:E,className:"wizard-form",noValidate:!0,children:[e.jsxs("div",{className:"wizard-form-header",children:[e.jsx("button",{type:"button",className:"wizard-back-button",onClick:s,"aria-label":"Torna alla lista pazienti",children:e.jsx("i",{className:"bi bi-arrow-left"})}),e.jsx("h1",{className:"wizard-form-title",children:"Inserimento Nuovo Paziente"})]}),e.jsx(X,{currentStep:v.currentStep,totalSteps:v.totalSteps,getStepLabel:v.getStepLabel,getStepNumber:v.getStepNumber}),e.jsx("div",{ref:x,className:"wizard-form-content",children:(()=>{const a={values:d,onChange:p,diagnosiOptions:b,repartoOptions:j,loadingDiagnosi:w,loadingReparti:z,onCheckboxChange:S,onEditInfection:D,onEditSurgery:I,infectionBadge:_,surgeryBadge:y,renderBadge:C};switch(v.currentStep){case"personal-info":return e.jsx(Z,{...a});case"admission-dates":return e.jsx(ee,{...a});case"diagnosis":return e.jsx(ae,{...a});case"provenance":return e.jsx(ie,{...a});case"clinical-flags":return e.jsx(ne,{...a});case"notes":return e.jsx(se,{...a});case"review":return e.jsx(te,{values:d});default:return null}})()}),e.jsxs("div",{className:"wizard-form-actions",children:[e.jsxs("button",{type:"button",className:"btn btn-secondary btn-block",onClick:v.prevStep,disabled:!v.canGoPrev,children:[e.jsx("i",{className:"bi bi-chevron-left"}),"Indietro"]}),"review"!==v.currentStep?e.jsxs("button",{type:"button",className:"btn btn-primary btn-block",onClick:v.nextStep,disabled:!v.canGoNext||!R(),title:R()?void 0:"Completa i campi obbligatori per continuare",children:["Avanti",e.jsx("i",{className:"bi bi-chevron-right"})]}):e.jsx(e.Fragment,{children:e.jsx("button",{type:"submit",className:"btn btn-success btn-block",disabled:u,children:e.jsxs(e.Fragment,u?{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio in corso..."]}:{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),P]})})})]})]}),k]})};const oe=()=>{const a=function(){const e=g();return l.useCallback(a=>{if(e)return e(a),void 0;const i=a.startsWith("/")?a.slice(1):a;window.location.hash=i||"home"},[e])}(),[i,n]=l.useState("create"),[s,t]=l.useState(void 0),[r,o]=l.useState(!1);l.useEffect(()=>{void(async()=>{const e=sessionStorage.getItem("editPazienteId");if(!e)return n("create"),void 0;o(!0);try{const a=await w.getPatientById(e);a?(t(a),n("edit")):(d.warn("Patient not found",{id:e}),u("Paziente non trovato"))}catch(a){d.error("Error loading patient for edit",a),m("Errore nel caricamento del paziente")}finally{o(!1),sessionStorage.removeItem("editPazienteId")}})()},[]);const c=l.useCallback(async e=>{try{"edit"===i&&s?.id?(d.info("Updating existing patient",{id:s.id,data:e}),await w.updatePatient(s.id,e),p("Paziente aggiornato con successo")):(d.info("Creating new patient",{data:e}),await w.createPatient(e),p("Paziente creato con successo")),a("/list")}catch(n){throw d.error("Error submitting patient form",n),n}},[a,i,s?.id]),h=l.useCallback(async e=>{if(s?.id)try{d.info("Registering patient discharge",{patientId:s.id,data:e}),await w.dischargePatientWithTransfer(s.id,e),p("Dimissione registrata con successo")}catch(a){throw d.error("Error registering patient discharge",a),m("Errore nella registrazione della dimissione"),a}},[s?.id]),v=l.useCallback(()=>{a("/list")},[a]),x=l.useMemo(()=>"undefined"!=typeof window&&window.innerWidth<992,[]);return e.jsxs("div",{className:"patient-form-page-container",children:[x&&e.jsx(e.Fragment,{children:r?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("div",{className:"spinner-border mb-3",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"text-muted",children:"Caricamento dati paziente in corso..."})]}):e.jsx(re,{patient:s,mode:i,onSubmit:c,onCancel:v})}),!x&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"patient-form-hero",children:e.jsx("div",{className:"patient-form-hero-content",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"patient-form-title",children:r?"Caricamento...":"edit"===i?"Modifica Paziente":"Inserimento Nuovo Paziente"}),e.jsx("p",{className:"patient-form-subtitle",children:r?"Attendere il caricamento dei dati...":"edit"===i?`Modifica i dati di ${s?.nome} ${s?.cognome}`:"Compila il form per aggiungere un nuovo paziente al sistema"})]}),e.jsxs("button",{type:"button",className:"patient-form-back-button",onClick:v,disabled:r,"aria-label":"Torna alla lista",children:[e.jsx("span",{className:"material-icons align-middle me-1",children:"arrow_back"}),e.jsx("span",{className:"back-button-text",children:"Torna alla lista"})]})]})})}),e.jsx("div",{className:"row",children:e.jsxs("div",{className:"col-12 col-lg-10 col-xl-8 mx-auto",children:[e.jsxs("div",{className:"patient-form-card",children:[e.jsx("div",{className:"patient-form-card-header",children:e.jsxs("div",{className:"patient-form-card-title-wrapper",children:[e.jsx("div",{className:"patient-form-card-icon",children:e.jsx("span",{className:"material-icons",children:"edit"===i?"edit":"person_add"})}),e.jsxs("h2",{className:"patient-form-card-title",style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"1rem"},children:[e.jsx("span",{children:"Modifica Dati Paziente"}),"edit"===i&&s&&e.jsxs("span",{style:{fontSize:"1.3rem",fontWeight:"700",color:"#0d6efd"},children:[s.nome," ",s.cognome]})]})]})}),e.jsxs("div",{className:"patient-form-card-body",children:[r?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("div",{className:"spinner-border mb-3",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Caricamento..."})}),e.jsx("p",{className:"text-muted",children:"Caricamento dati paziente in corso..."})]}):e.jsx(Y,{patient:s,mode:i,onSubmit:c,onCancel:v}),!r&&"edit"===i&&s&&e.jsx(D,{patientId:s.id,patientName:`${s.nome} ${s.cognome}`,onDischargeSubmit:h})]})]}),e.jsx("div",{className:"patient-form-help-card card",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"patient-form-help-header",children:[e.jsx("div",{className:"help-icon",children:e.jsx("span",{className:"material-icons",children:"info"})}),e.jsx("h3",{className:"help-title",children:"Informazioni"})]}),e.jsxs("ul",{className:"patient-form-help-list",children:[e.jsx("li",{children:"I campi contrassegnati sono obbligatori"}),e.jsx("li",{children:"La data di ricovero non può essere futura"}),e.jsx("li",{children:"Il codice RAD deve essere univoco se specificato"}),e.jsx("li",{children:"I dati possono essere modificati successivamente dalla pagina di dettaglio"})]})]})})]})})]})]})};export{oe as PatientFormPage,oe as default};
