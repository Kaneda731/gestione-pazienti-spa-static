const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CustomDatepicker-6By5cdaM.js","assets/utils-BtSsRyB2.js","assets/ConfirmModal-De4MEDkl.js","assets/index-Ch1Y3veH.js","assets/vendor-CQCqr9ER.js","assets/supabase-86D3GPeZ.js","assets/index-CMiMZzvZ.css","assets/ResolveInfectionModal-DZaI0uGW.js"])))=>i.map(i=>d[i]);
import{_ as e}from"./supabase-86D3GPeZ.js";import{l as t,a as n,n as i,b as a,T as o}from"./index-Ch1Y3veH.js";import{f as r,e as s}from"./infectionDataManager-BUcTDAl8.js";import{d as l,a as c}from"./patientService-EGfMwTHQ.js";import{p as d,a as m}from"./PatientAutocomplete-BAiHZk6W.js";import{g as v}from"./helpers-Bb-HnVL8.js";import{c as u}from"./date-CcL_Wp-e.js";import{initCustomDatepickers as p}from"./CustomDatepicker-6By5cdaM.js";import{i as g}from"./CustomSelect-CVIgPX66.js";import"./vendor-CQCqr9ER.js";import"./searchUtils-CGvlsFoa.js";import"./utils-BtSsRyB2.js";class h{constructor(e,t){this.domElements=e,this.callbacks=t}renderTable(e){try{if(t.log("üé® Rendering tabella eventi:",e),!this.domElements.tableBody)return t.error("‚ùå Container table body non trovato"),void 0;if(this.clearTable(),!e.eventi||0===e.eventi.length)return this.renderEmptyState(),this.updatePaginationControls(e),void 0;const n=this.createTableRows(e.eventi);if(t.debug("üîç [TABLE RENDERER DEBUG]",{tableBody:!!this.domElements.tableBody,tableBodyId:this.domElements.tableBody?.id,rowsHtmlLength:n.length,eventsCount:e.eventi.length}),this.domElements.tableBody){this.domElements.tableBody.innerHTML=n;if(this.domElements.tableBody&&null!=this.domElements.tableBody.children){const n=this.domElements.tableBody.children.length;t.debug("üîç [TABLE RENDERER DEBUG] Righe aggiunte:",n),0===n&&e.eventi.length>0&&t.error("‚ùå [TABLE RENDERER DEBUG] Righe non aggiunte nonostante ci siano eventi!")}}else t.error("‚ùå [TABLE RENDERER DEBUG] tableBody √® null!");this.updatePaginationControls(e),t.log("‚úÖ Tabella renderizzata con successo")}catch(n){t.error("‚ùå Errore rendering tabella:",n),this.callbacks.showError&&this.callbacks.showError("Errore nel rendering della tabella")}}clearTable(){this.domElements.tableBody&&(this.domElements.tableBody.innerHTML=n(""))}renderEmptyState(){if(!this.domElements.tableBody)return;const e=document.createElement("tr"),t=document.createElement("td");t.colSpan=8,t.className="text-center text-muted",t.textContent="Nessun evento trovato",e.appendChild(t),this.domElements.tableBody.appendChild(e)}createTableRows(e){return e.map(e=>this.createTableRow(e)).join("")}createTableRow(e){const t=e.pazienteInfo,i=this.getEventDetails(e),a=this.getStatusBadge(e),o=this.getActionButtons(e),s=this.getTipoBadge(e),l=i&&i.length>60?`title="${n(i)}" data-bs-toggle="tooltip"`:"",c=e.descrizione&&e.descrizione.length>60?`title="${n(e.descrizione)}" data-bs-toggle="tooltip"`:"";return`\n      <tr data-evento-id="${e.id}" class="evento-row">\n        <td>${e.dataEventoFormatted||r(e.data_evento)}</td>\n        <td>${s}</td>\n        <td>${t?n(t.nomeCompleto):"-"}</td>\n        <td>${t?n(t.reparto):"-"}</td>\n        <td><span class="clamp-3" ${l}>${n(i)}</span></td>\n        <td><span class="clamp-3" ${c}>${e.descrizione?n(e.descrizione):"-"}</span></td>\n        <td>${a}</td>\n        <td>${o}</td>\n      </tr>\n    `}getEventDetails(e){return"intervento"===e.tipo_evento?e.tipo_intervento||"-":e.agente_patogeno||"-"}getStatusBadge(e){return"infezione"===e.tipo_evento?e.data_fine_evento?`<span class="badge bg-success" title="Risolta il ${e.dataFineEventoFormatted}">Risolta</span>`:'<span class="badge bg-danger" title="Infezione attiva">Attiva</span>':""}getTipoBadge(e){let t,n;e.tipoEventoColor&&e.tipoEventoLabel?(t=e.tipoEventoColor,n=e.tipoEventoLabel):"intervento"===e.tipo_evento?(t="primary",n="Intervento"):"infezione"===e.tipo_evento?(t="warning",n="Infezione"):e.tipo_evento?(t="secondary",n=`Tipo: ${e.tipo_evento}`):(t="secondary",n="Sconosciuto");return`\n      <span class="badge bg-${t}">\n        ${this.renderEventIcon(e.tipoEventoIcon,e.tipo_evento,"white","me-1 align-middle fs-6")}\n        ${n}\n      </span>\n    `.trim()}getActionButtons(e){return`\n      <div class="btn-group btn-group-sm" role="group">\n        <button class="btn btn-sm btn-outline-primary event-detail-btn" data-evento-id="${e.id}" title="Apri dettagli evento" aria-label="Apri dettagli evento">\n          <span class="material-icons align-middle me-1">visibility</span>\n          <span class="btn-text align-middle">Dettagli</span>\n        </button>\n        ${"infezione"!==e.tipo_evento||e.data_fine_evento?"":`\n      <button class="btn btn-sm btn-outline-success event-resolve-btn" data-evento-id="${e.id}" title="Risolvi infezione" aria-label="Risolvi infezione">\n        <span class="material-icons align-middle me-1">check_circle</span>\n        <span class="btn-text align-middle">Risolvi</span>\n      </button>\n    `}\n      </div>\n    `}renderEventIcon(e,t,n="",i=""){(!e||e.includes("fa-")||e.includes("fas "))&&(e="intervento"===t?"medical_services":"warning");return`<span class="material-icons ${[n?`text-${n}`:"",i].filter(Boolean).join(" ")}">${e}</span>`}updatePaginationControls(e){t.log("üî• TableRenderer.updatePaginationControls chiamato");const n=e?.pagination||e||{},i="number"==typeof n.pageSize?n.pageSize:10,a="number"==typeof n.currentPage?n.currentPage:0,o="number"==typeof n.totalPages?n.totalPages:1,r="number"==typeof n.totalCount?n.totalCount:0,s=void 0!==n.hasNextPage?Boolean(n.hasNextPage):a<o-1,l=void 0!==n.hasPrevPage?Boolean(n.hasPrevPage):a>0;if(t.log("üîç Valori paginazione:",{currentPage:a,totalPages:o,totalCount:r,hasNextPage:s,hasPrevPage:l,provided:{hasNextPage:n.hasNextPage,hasPrevPage:n.hasPrevPage}}),this.domElements.prevPageBtn&&(this.domElements.prevPageBtn.disabled=!l),this.domElements.nextPageBtn&&(this.domElements.nextPageBtn.disabled=!s),this.domElements.prevPageBtnMobile&&(this.domElements.prevPageBtnMobile.disabled=!l),this.domElements.nextPageBtnMobile&&(this.domElements.nextPageBtnMobile.disabled=!s),this.domElements.pageInfo){const e=0===r?0:a*i+1,t=0===r?0:Math.min((a+1)*i,r);this.domElements.pageInfo.textContent=`${e}-${t} di ${r} eventi (Pagina ${a+1} di ${o})`}if(this.domElements.pageInfoMobile){const e=`${a+1} / ${o}`;this.domElements.pageInfoMobile.textContent=e,t.log(`üì± Badge mobile aggiornato: ${e}`)}else{const e=document.getElementById("eventi-page-info-mobile");if(e){const n=`${a+1} / ${o}`;e.textContent=n,t.log(`üì± Badge mobile aggiornato (fallback): ${n}`)}else t.warn("‚ö†Ô∏è Badge mobile non trovato n√© in domElements n√© con getElementById")}this.domElements.paginationControls&&(o<=1?this.domElements.paginationControls.classList.add("d-none"):this.domElements.paginationControls.classList.remove("d-none"),this.domElements.paginationControls.style.display=""),this.domElements.paginationControlsMobile&&(o<=1?this.domElements.paginationControlsMobile.classList.add("d-none"):this.domElements.paginationControlsMobile.classList.remove("d-none"),this.domElements.paginationControlsMobile.style.display="")}updateTableRow(e){try{const n=this.domElements.tableBody.querySelector(`[data-evento-id="${e.id}"]`);if(!n)return t.warn(`‚ö†Ô∏è Riga evento ${e.id} non trovata nella tabella`),void 0;const i=this.createTableRow(e),a=document.createElement("div");a.innerHTML=i;n.replaceWith(a.firstElementChild),t.log(`‚úÖ Riga evento ${e.id} aggiornata nella tabella`)}catch(n){t.error("‚ùå Errore aggiornamento riga tabella:",n)}}}class E{constructor(e,t){this.domElements=e,this.callbacks=t}renderTimeline(e){try{t.log("üé® Rendering timeline eventi:",e);const n=this.domElements.timelineContainer;if(!n)return t.error("‚ùå Container timeline non trovato"),void 0;if(this.clearTimeline(),!e.eventi||0===e.eventi.length)return this.renderEmptyState(),void 0;const i=this.createTimelineElement(),a=this.groupEventsByDate(e.eventi);Object.keys(a).sort((e,t)=>new Date(t)-new Date(e)).forEach(e=>{const t=this.createDateGroup(e,a[e]);i.appendChild(t)}),n.appendChild(i),this.callbacks.updatePaginationControls&&this.callbacks.updatePaginationControls(e),t.log("‚úÖ Timeline renderizzata con successo")}catch(n){t.error("‚ùå Errore rendering timeline:",n),this.callbacks.showError&&this.callbacks.showError("Errore nel rendering della timeline")}}updateTimelineItem(e){try{const n=this.domElements.timelineContainer.querySelector(`[data-evento-id="${e.id}"]`);if(!n)return t.warn(`‚ö†Ô∏è Evento ${e.id} non trovato nella timeline`),void 0;const i=this.createEventCard(e);n.replaceWith(i),t.log(`‚úÖ Evento ${e.id} aggiornato nella timeline`)}catch(n){t.error("‚ùå Errore aggiornamento timeline item:",n)}}clearTimeline(){const e=this.domElements.timelineContainer;e&&(e.innerHTML=n(""))}createTimelineElement(){const e=document.createElement("div");return e.className="eventi-timeline",e.innerHTML=n('\n      <div class="timeline-line"></div>\n    '),e}groupEventsByDate(e){return e.reduce((e,t)=>{const n=t.data_evento;return e[n]||(e[n]=[]),e[n].push(t),e},{})}createDateGroup(e,t){const n=document.createElement("div");n.className="timeline-date-group";const i=document.createElement("div");i.className="timeline-date-header";const a=document.createElement("div");a.className="timeline-date-marker";const o=document.createElement("h5");return o.className="timeline-date-title",o.textContent=r(e),i.appendChild(a),i.appendChild(o),n.appendChild(i),t.sort((e,t)=>new Date(t.created_at||0)-new Date(e.created_at||0)),t.forEach(e=>{const t=this.createEventCard(e);n.appendChild(t)}),n}createEventCard(e){const t=document.createElement("div"),i="infezione"===e.tipo_evento;t.className=`card card-list-compact timeline-event-card ${i?i&&!e.data_fine_evento?"status-infected":"status-error":"status-success"} evento-${e.tipo_evento}`,t.dataset.eventoId=e.id;const a=e.tipoEventoIcon||("intervento"===e.tipo_evento?"medical_services":"warning"),o=e.tipoEventoColor||("intervento"===e.tipo_evento?"primary":"warning"),s=e.tipoEventoLabel||("intervento"===e.tipo_evento?"Intervento":"Infezione"),l=i?e.data_fine_evento?'<span class="badge bg-success ms-1" style="font-size:0.7em;">Risolta</span>':'<span class="badge bg-warning text-dark ms-1" style="font-size:0.7em;"><span class="material-icons" style="font-size:0.8em;vertical-align:middle;">warning</span> Attiva</span>':"",c="intervento"===e.tipo_evento?e.tipo_intervento||"-":e.agente_patogeno||(e.data_fine_evento?"Infezione risolta":"Infezione attiva"),d=e.pazienteInfo?`\n          <div class="card-meta mobile-text-sm mt-1">\n            <div class="d-flex align-items-center">\n              <span class="material-icons me-1" style="font-size:1em;vertical-align:middle;">person</span>\n              <span class="patient-name">${n(e.pazienteInfo.nomeCompleto)}</span>\n            </div>\n            <div class="mt-1">\n              <span class="badge bg-secondary">${n(e.pazienteInfo.reparto)}</span>\n            </div>\n          </div>\n        `:"",m=this.renderEventCardDetails(e),v=`\n        <div class="card-body">\n          <div class="card-info">\n            <div class="card-title d-flex align-items-center gap-2">\n              ${this.renderEventIcon(a,e.tipo_evento,o)}\n              <span class="fw-bold">${s}</span>\n              ${l}\n            </div>\n            <div class="card-meta mobile-text-sm">\n              ${r(e.data_evento)} ‚Ä¢ ${n(c)}\n            </div>\n            ${d}\n          </div>\n          <div class="event-card-body mt-2 mobile-text-sm text-muted">\n            ${m}\n          </div>\n          <div class="mt-2 text-end">\n            <div class="btn-group btn-group-sm" role="group">\n              <button class="btn btn-outline-primary event-detail-btn" data-evento-id="${e.id}" title="Apri dettagli evento" aria-label="Apri dettagli evento">\n                <span class="material-icons align-middle me-1">visibility</span>\n                <span class="btn-text align-middle">Dettagli</span>\n              </button>\n            </div>\n          </div>\n        </div>\n    `;return t.innerHTML=n(v),t}renderEventCardDetails(e){let t="";return e.descrizione&&(t+=`<p class="event-description">${n(e.descrizione)}</p>`),"intervento"===e.tipo_evento?e.tipo_intervento&&(t+=`\n          <div class="event-detail-item">\n            <strong>Tipo Intervento:</strong> ${n(e.tipo_intervento)}\n          </div>\n        `):"infezione"===e.tipo_evento&&e.agente_patogeno&&(t+=`\n          <div class="event-detail-item">\n            <strong>Agente Patogeno:</strong> ${n(e.agente_patogeno)}\n          </div>\n        `),t||'<p class="text-muted">Nessun dettaglio aggiuntivo</p>'}renderEventIcon(e,t,n,i=""){return`<span class="material-icons text-${n||("intervento"===t?"primary":"warning")} ${i}">${e||("intervento"===t?"medical_services":"warning")}</span>`}renderEmptyState(){const e=this.domElements.timelineContainer;if(!e)return;e.innerHTML=n("");const t=document.createElement("div");t.className="empty-state text-center py-5";const i=document.createElement("div");i.className="empty-state-icon mb-3",i.innerHTML=n('<span class="material-icons text-muted" style="font-size:48px;">event_busy</span>'),t.appendChild(i);const a=document.createElement("h4");a.className="text-muted",a.textContent="Nessun evento trovato",t.appendChild(a);const o=document.createElement("p");o.className="text-muted",o.textContent="Non ci sono eventi clinici che corrispondono ai filtri selezionati.",t.appendChild(o);const r=document.createElement("button");r.className="btn btn-primary",r.id="add-first-event-btn",r.innerHTML=n('<span class="material-icons me-1">add</span> Aggiungi primo evento'),t.appendChild(r),e.appendChild(t),r.addEventListener("click",()=>{const e=this.domElements.addEventBtn;e&&e.click()})}}function f(e,t,i){let a=document.getElementById("search-results-info");if(!a){a=document.createElement("div"),a.id="search-results-info",a.className="search-results-info text-muted mb-3";const e=document.getElementById("eventi-timeline-container");e&&e.parentNode&&e.parentNode.insertBefore(a,e)}Object.values(i||{}).some(e=>e&&""!==e.toString().trim())?(a.innerHTML=n(`\n      <span class="material-icons me-1">filter_list</span>\n      Trovati <strong>${e}</strong> eventi su ${t} totali\n      ${i.paziente_search?`per "${n(i.paziente_search)}"`:""}\n    `),a.style.display="block"):a&&(a.style.display="none")}let y=null,b=null,z=null;function _(e){y=e}function w(){b?b.domElements=y:b=new h(y,{showError:D,updatePaginationControls:()=>{}}),z?z.domElements=y:z=new E(y,{showError:D,updatePaginationControls:()=>{}})}function I(e){if(t.log("üî• renderEventsResponsive CHIAMATA - START"),t.log("üé® renderEventsResponsive chiamata con:",e),!y||0===Object.keys(y).length)return t.error("‚ùå domElements non inizializzati in renderEventsResponsive"),void 0;const n=window.innerWidth>=1200;t.log("üì± useTable:",n,"window.innerWidth:",window.innerWidth),y.tableContainer?y.tableContainer.style.display=n?"block":"none":t.warn("‚ö†Ô∏è tableContainer non trovato"),y.timelineContainer?y.timelineContainer.style.display=n?"none":"block":t.warn("‚ö†Ô∏è timelineContainer non trovato"),t.log("üîß Chiamando ensureRenderers..."),w(),n?(t.log("üîß Rendering tabella (renderer) - CHIAMANDO tableRenderer.renderTable"),b.renderTable(e)):(t.log("üîß Rendering timeline (renderer) - CHIAMANDO timelineRenderer.renderTimeline"),z.renderTimeline(e));try{void("undefined"!=typeof window&&window.applyResponsiveDesign&&window.applyResponsiveDesign())}catch(i){t.warn("‚ö†Ô∏è applyResponsiveDesign fallita dopo renderEventsResponsive:",i)}}function C(e){try{if(!y||!y.timelineContainer)return t.error("‚ùå Container timeline non trovato"),void 0;t.log("üé® Rendering timeline (renderer):",e),w(),z.renderTimeline(e)}catch(n){t.error("‚ùå Errore rendering timeline:",n),D("Errore nel rendering della timeline")}}function F(e){try{t.log("üé® Rendering tabella (renderer):",e),w(),b.renderTable(e)}catch(n){t.error("‚ùå Errore rendering tabella eventi:",n),D("Errore nel rendering della tabella")}}function S(){y.timelineContainer&&(y.timelineContainer.innerHTML=n('\n      <div class="loading-state text-center py-5">\n        <div class="spinner-border text-primary mb-3" role="status">\n          <span class="visually-hidden">Caricamento...</span>\n        </div>\n        <p class="text-muted">Caricamento eventi clinici...</p>\n      </div>\n    ')),y.tableBody&&(y.tableBody.innerHTML=n('\n      <tr>\n        <td colspan="8" class="text-center">\n          <div class="spinner-border text-primary" role="status">\n            <span class="visually-hidden">Caricamento...</span>\n          </div>\n        </td>\n      </tr>\n    '))}function D(e="Errore nel caricamento dei dati"){y.timelineContainer&&(y.timelineContainer.innerHTML=n(`\n      <div class="error-state text-center py-5">\n        <div class="error-state-icon mb-3">\n          <span class="material-icons text-danger" style="font-size:48px;">warning</span>\n        </div>\n        <h4 class="text-danger">Errore</h4>\n        <p class="text-muted">${n(e)}</p>\n        <button class="btn btn-outline-primary" onclick="location.reload()">\n          <span class="material-icons me-1">refresh</span>\n          Riprova\n        </button>\n      </div>\n    `)),y.tableBody&&(y.tableBody.innerHTML=n(`\n      <tr>\n        <td colspan="8" class="text-center text-danger">\n          <strong>${n(e)}</strong>\n        </td>\n      </tr>\n    `))}function T(){if(!y.timelineContainer)return;const e=y.timelineContainer;if(e.querySelector(".searching-state"))return;const t=document.createElement("div");t.className="searching-state text-center py-4";const n=document.createElement("div");n.className="spinner-border spinner-border-sm text-primary me-2",n.setAttribute("role","status");const i=document.createElement("span");i.className="visually-hidden",i.textContent="Ricerca in corso...",n.appendChild(i);const a=document.createElement("span");a.className="text-muted",a.textContent="Ricerca in corso...",t.append(n,a),e.prepend(t)}function P(){const e=document.querySelector(".searching-state");e&&e.remove()}function B(e,t){const i=document.getElementById(t);if(!i)return;if(!e||0===e.length)return i.style.display="none",void 0;const a=e.map(e=>function(e){const t=e.nomeCompleto||`${e.nome||""} ${e.cognome||""}`.trim(),i=e.reparto_appartenenza||e.reparto||"",a=e.dataRicoveroFormatted||"",o="boolean"==typeof e.isActive?e.isActive:"Attivo"===e.status,r=o?"badge bg-success":"badge bg-secondary";return`\n    <div class="dropdown-item patient-search-result" data-patient-id="${n(e.id)}">\n      <div class="d-flex align-items-center w-100">\n        <div class="flex-grow-1">\n          <div class="fw-bold">${n(t)}</div>\n          <div class="text-muted small">\n            ${n(i)}${a?` ‚Ä¢ ${n(a)}`:""}\n          </div>\n        </div>\n        <span class="${r}">${o?"Attivo":"Dimesso"}</span>\n      </div>\n    </div>\n  `}(e)).join("");i.innerHTML=n(a),i.style.display="block",function(e,t){const n=e.querySelectorAll(".patient-search-result");n.forEach(n=>{n.addEventListener("click",function(){const n=this.dataset.patientId,i=this.querySelector(".fw-bold").textContent;if("patient-search-results"===t){const e=document.getElementById("paziente-nome");e&&(e.value=i,e.dataset.patientId=n)}e.style.display="none"})})}(i,t)}function M(e){if(!y||!y.detailContent)return;const i=function(e){const t="infezione"===e.tipo_evento,n=t&&!e.data_fine_evento,i="infezione"===e.tipo_evento?`<div class="col-md-6">\n         <strong>Stato:</strong>\n         <div class="mt-1">\n           ${e.data_fine_evento?`<span class="badge bg-success">Risolta il ${r(e.data_fine_evento)}</span>`:'<span class="badge bg-danger">Attiva</span>'}\n         </div>\n       </div>`:"",a=e.pazienteInfo?`<div class="col-12">\n         <strong>Paziente:</strong>\n         <div class="mt-1">\n           <span class="material-icons me-1">person</span>\n           ${e.pazienteInfo.nomeCompleto}\n           <span class="badge bg-secondary ms-2">${e.pazienteInfo.reparto}</span>\n         </div>\n       </div>`:"",o=e.descrizione?`<div class="col-12">\n         <strong>Descrizione:</strong>\n         <div class="mt-1">${e.descrizione}</div>\n       </div>`:"",s=function(e){if("intervento"===e.tipo_evento&&e.tipo_intervento)return`\n      <div class="col-12">\n        <strong>Tipo Intervento:</strong>\n        <div class="mt-1">${e.tipo_intervento}</div>\n      </div>\n    `;if("infezione"===e.tipo_evento&&e.agente_patogeno)return`\n      <div class="col-12">\n        <strong>Agente Patogeno:</strong>\n        <div class="mt-1">${e.agente_patogeno}</div>\n      </div>\n    `;return""}(e),l=function(e){const t=e.updated_at&&e.updated_at!==e.created_at?`<div class="col-md-6">\n         <strong>Modificato il:</strong>\n         <div class="mt-1 text-muted">${r(e.updated_at)}</div>\n       </div>`:"";return`\n    <div class="col-md-6">\n      <strong>Creato il:</strong>\n      <div class="mt-1 text-muted">${r(e.created_at)}</div>\n    </div>\n    ${t}\n  `}(e),c=n?`<button class="btn btn-success btn-sm event-resolve-btn" data-evento-id="${e.id}" title="Risolvi">\n         <span class="material-icons align-middle me-1">check_circle</span>\n         Risolvi\n       </button>`:"",d=`\n    <div class="event-detail-actions d-flex flex-wrap gap-2 justify-content-end mb-3">\n      <button class="btn btn-outline-secondary btn-sm event-edit-btn" data-evento-id="${e.id}" title="Modifica">\n        <span class="material-icons align-middle me-1">edit</span>\n        Modifica\n      </button>\n      <button class="btn btn-outline-danger btn-sm event-delete-btn" data-evento-id="${e.id}" title="Elimina">\n        <span class="material-icons align-middle me-1">delete</span>\n        Elimina\n      </button>\n      ${c}\n    </div>`;return`\n    <div class="event-details">\n      ${d}\n      <div class="row g-3">\n        <div class="col-md-6">\n          <strong>Tipo Evento:</strong>\n          <div class="d-flex align-items-center mt-1">\n            ${function(e,t,n,i=""){const a=e=>"intervento"===e?"local_hospital":"infezione"===e?"bug_report":"event",o="string"==typeof e&&/\bfa[srldb]?\b|fa-/.test(e)?a(t):e||a(t);return`<span class="${["material-icons","white"===n?"text-white":n?`text-${n}`:"",i].filter(Boolean).join(" ")}">${o}</span>`}(e.tipoEventoIcon,e.tipo_evento,e.tipoEventoColor,"me-2")}\n            ${e.tipoEventoLabel}\n          </div>\n        </div>\n        <div class="col-md-6">\n          <strong>Data Evento:</strong>\n          <div class="mt-1">${e.dataEventoFormatted}</div>\n        </div>\n        ${i}\n        ${a}\n        ${o}\n        ${s}\n        ${l}\n      </div>\n    </div>\n  `}(e);y.detailContent.innerHTML=n(i);try{const e=y.eventDetailModal;if(e){const t=e.querySelector(".modal-footer");t&&(t.querySelectorAll(".event-edit-btn, .event-delete-btn").forEach(e=>e.remove()),t.querySelector("*")&&""!==t.textContent.trim()||t.classList.add("d-none"))}}catch(a){t.warn("Footer cleanup dettagli evento non riuscito:",a)}}function L(e){const t=document.getElementById("active-filters-indicator");t&&(e>0?(t.innerHTML=n(`\n      <span class="badge bg-primary me-2">\n        <span class="material-icons" style="font-size: 14px;">filter_list</span>\n        ${e} filtri attivi\n      </span>\n    `),t.style.display="block"):t.style.display="none")}function R(e){const t=document.getElementById("filter-stats");if(!t)return;if(!e)return t.style.display="none",void 0;t.innerHTML=n(`\n    <div class="filter-stats-content">\n      <div class="stats-item">\n        <span class="material-icons">event</span>\n        <span>${e.totalEvents||0} eventi totali</span>\n      </div>\n      <div class="stats-item">\n        <span class="material-icons">visibility</span>\n        <span>${e.filteredEvents||0} eventi visualizzati</span>\n      </div>\n      <div class="stats-item">\n        <span class="material-icons">date_range</span>\n        <span>${e.dateRange||"Tutto il periodo"}</span>\n      </div>\n    </div>\n  `),t.style.display="block"}function x(e="Esportazione in corso..."){const t=document.getElementById("export-progress");t&&(t.innerHTML=n(`\n    <div class="export-progress-content">\n      <div class="spinner-border spinner-border-sm me-2" role="status">\n        <span class="visually-hidden">Esportazione...</span>\n      </div>\n      <span>${n(e)}</span>\n    </div>\n  `),t.style.display="block")}function $(t){const i=document.getElementById("export-progress");i&&(i.style.display="none");const a=document.createElement("div");a.className="toast align-items-center text-white bg-success border-0",a.setAttribute("role","alert"),a.innerHTML=n(`\n    <div class="d-flex">\n      <div class="toast-body">\n        <span class="material-icons me-2">download</span>\n        Esportati ${t.count} eventi in ${n(t.filename)}\n      </div>\n      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>\n    </div>\n  `);let o=document.getElementById("toast-container");o||(o=document.createElement("div"),o.id="toast-container",o.className="toast-container position-fixed top-0 end-0 p-3",document.body.appendChild(o)),o.appendChild(a),e(async()=>{const{Toast:e}=await import("./vendor-CQCqr9ER.js");return{Toast:e}},[]).then(({Toast:e})=>{new e(a).show(),a.addEventListener("hidden.bs.toast",()=>{a.remove()})})}function A(e,t){if(!t||t.length<2)return e;const n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`(${n})`,"gi");return e.replace(i,"<mark>$1</mark>")}const k=Object.freeze(Object.defineProperty({__proto__:null,hideSearchingState:P,highlightSearchTerms:A,initializeRenderer:_,renderEventDetails:M,renderEventsResponsive:I,renderEventsTable:F,renderEventsTimeline:C,renderPatientSearchResults:B,showActiveFiltersIndicator:L,showError:D,showExportProgress:x,showExportSuccess:$,showFilterStats:R,showLoading:S,showSearchingState:T,updateSearchResultsCount:f},Symbol.toStringTag,{value:"Module"}));let O=null;function j(e){O=e}function N(e){if(!e)return;const n=document.getElementById("evento-id"),i=document.getElementById("evento-tipo"),a=document.getElementById("evento-data"),o=document.getElementById("evento-descrizione"),r=document.getElementById("evento-tipo-intervento"),s=document.getElementById("evento-paziente"),l=document.getElementById("evento-paziente-id");if(n&&(n.value=e.id||""),i&&(i.value=e.tipo_evento||""),a&&(a.value=e.dataEventoFormatted||e.data_evento||""),o&&(o.value=e.descrizione||""),r&&(r.value=e.tipo_intervento||""),s){s.value=e.pazienteInfo?.nomeCompleto||""}if(l){l.value=e.pazienteInfo?.id||e.paziente_id||""}W(e.tipo_evento),t.log("üìù Form popolato con evento:",e.id)}function H(){O.eventForm&&(O.eventForm.reset(),O.patientNameInput&&delete O.patientNameInput.dataset.patientId,W(""),V(),t.log("üßπ Form evento resettato"))}function U(e,t="danger"){const i=document.getElementById("evento-messaggio-container");i&&(i.innerHTML=n(`\n    <div class="alert alert-${t} alert-dismissible fade show" role="alert">\n      ${n(e)}\n      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n    </div>\n  `))}function V(){const e=document.getElementById("evento-messaggio-container");e&&(e.innerHTML="")}function q(e,t="add"){const n=document.getElementById("evento-modal-title"),i=document.getElementById("evento-modal-icon");n&&(n.textContent=e,i&&(i.textContent=t))}function W(e){const t=document.getElementById("discharge-fields"),n=document.getElementById("transfer-fields"),i=document.getElementById("intervento-fields"),a=document.getElementById("infezione-fields");t&&(t.style.display="none"),n&&(n.style.display="none"),i&&(i.style.display="none"),a&&(a.style.display="none");const o=document.getElementById("evento-tipo-intervento"),r=document.getElementById("evento-agente-patogeno");switch(o&&(o.value="",o.required=!1),r&&(r.value="",r.required=!1),e){case"dimissione":t&&(t.style.display="block");break;case"trasferimento":n&&(n.style.display="block");break;case"intervento":i&&(i.style.display="block"),o&&(o.required=!0);break;case"infezione":a&&(a.style.display="block"),r&&(r.required=!0)}}function J(){if(!O.eventForm)return{isValid:!1,errors:["Form non trovato"]};const e=[];if(O.eventTypeSelect?.value||e.push("Tipo evento √® obbligatorio"),O.eventDateInput?.value||e.push("Data evento √® obbligatoria"),O.eventDescriptionInput?.value?.trim()||e.push("Descrizione √® obbligatoria"),O.patientNameInput?.dataset?.patientId||e.push("Selezionare un paziente valido"),O.eventDateInput?.value){const t=new Date(O.eventDateInput.value),n=new Date;n.setHours(23,59,59,999),t>n&&e.push("La data evento non pu√≤ essere nel futuro")}const t=O.eventTypeSelect?.value;if("dimissione"===t&&(O.dischargeCodeSelect?.value||e.push("Codice dimissione √® obbligatorio per le dimissioni"),O.dischargeDestinationSelect?.value||e.push("Destinazione dimissione √® obbligatoria per le dimissioni")),"trasferimento"===t&&(O.transferSourceInput?.value?.trim()||e.push("Provenienza √® obbligatoria per i trasferimenti"),O.transferDestinationInput?.value?.trim()||e.push("Destinazione √® obbligatoria per i trasferimenti")),"intervento"===t){const t=document.getElementById("evento-tipo-intervento");t?.value||e.push("Tipo intervento √® obbligatorio per gli interventi")}if("infezione"===t){const t=document.getElementById("evento-agente-patogeno");t?.value?.trim()||e.push("Agente patogeno √® obbligatorio per le infezioni")}return{isValid:0===e.length,errors:e}}function G(){if(!O.eventForm)return null;const e={tipo_evento:O.eventTypeSelect?.value||"",data_evento:O.eventDateInput?.value||"",descrizione:O.eventDescriptionInput?.value?.trim()||"",note:O.eventNotesInput?.value?.trim()||"",reparto:O.departmentSelect?.value||"",priorita:O.prioritySelect?.value||"",status:O.statusSelect?.value||"attivo",paziente_id:O.patientNameInput?.dataset?.patientId||null},t=e.tipo_evento;if("dimissione"===t&&(e.codice_dimissione=O.dischargeCodeSelect?.value||"",e.destinazione_dimissione=O.dischargeDestinationSelect?.value||""),"trasferimento"===t&&(e.provenienza_trasferimento=O.transferSourceInput?.value?.trim()||"",e.destinazione_trasferimento=O.transferDestinationInput?.value?.trim()||""),"intervento"===t){const t=document.getElementById("evento-tipo-intervento");e.tipo_intervento=t?.value||""}if("infezione"===t){const t=document.getElementById("evento-agente-patogeno");e.agente_patogeno=t?.value?.trim()||""}return e}function Y(e){if(!O.eventForm)return;O.eventForm.querySelectorAll("input, select, textarea, button").forEach(t=>{t.disabled=!e}),t.log("üìù Form "+(e?"abilitato":"disabilitato"))}function Z(e,t="Salvataggio in corso..."){const i=O.saveBtn;i&&(e?(i.disabled=!0,i.innerHTML=n(`\n      <span class="spinner-border spinner-border-sm me-2" role="status"></span>\n      ${n(t)}\n    `)):(i.disabled=!1,i.innerHTML=n('\n      <span class="material-icons me-1">save</span>\n      Salva\n    ')))}function K(e){if(!Array.isArray(e))return;const t=O.eventForm?.querySelectorAll(".is-invalid");t?.forEach(e=>e.classList.remove("is-invalid"));const n={"Tipo evento √® obbligatorio":O.eventTypeSelect,"Data evento √® obbligatoria":O.eventDateInput,"Descrizione √® obbligatoria":O.eventDescriptionInput,"Selezionare un paziente valido":O.patientNameInput,"Codice dimissione √® obbligatorio per le dimissioni":O.dischargeCodeSelect,"Destinazione dimissione √® obbligatoria per le dimissioni":O.dischargeDestinationSelect,"Provenienza √® obbligatoria per i trasferimenti":O.transferSourceInput,"Destinazione √® obbligatoria per i trasferimenti":O.transferDestinationInput};e.forEach(e=>{const t=n[e];t&&t.classList.add("is-invalid")})}let Q=null;function X(e,n=3e3){if(!O.eventForm)return;const i=()=>{Q&&clearTimeout(Q),Q=setTimeout(()=>{const n=G();J().isValid&&n.descrizione&&(e(n,!0),t.log("üíæ Auto-save eseguito"))},n)};O.eventForm.querySelectorAll("input, select, textarea").forEach(e=>{e.addEventListener("input",i),e.addEventListener("change",i)}),t.log("üíæ Auto-save abilitato con delay di",n,"ms")}function ee(){Q&&(clearTimeout(Q),Q=null),t.log("üíæ Auto-save disabilitato")}const te=Object.freeze(Object.defineProperty({__proto__:null,clearFormMessages:V,disableAutoSave:ee,enableAutoSave:X,getFormData:G,highlightFormErrors:K,initializeForms:j,populateEventForm:N,resetEventForm:H,setFormEnabled:Y,setFormLoading:Z,showFormMessage:U,toggleEventTypeFields:W,updateModalTitle:q,validateEventForm:J},Symbol.toStringTag,{value:"Module"}));const ne={paziente_search:"",paziente_id:"",tipo_evento:"",data_da:"",data_a:"",reparto:"",stato:"",agente_patogeno:"",sortColumn:"",sortDirection:"desc"};let ie={...ne};const ae=new Set;function oe(){const e={...ie};ae.forEach(t=>{try{t(e)}catch(n){}})}function re(){return{...ie}}function se(e={}){return ie={...ne,...e},oe(),re()}const le={get:re,set:function(e={}){return ie={...ie,...e},oe(),re()},replace:se,reset:function(){return ie={...ne},oe(),re()},subscribe:function(e){return"function"==typeof e?(ae.add(e),()=>ae.delete(e)):()=>{}},getDefault:function(){return{...ne}},loadFromState:function(e,t="eventiCliniciFilters"){try{const n=e?.getState?.(t);if(n&&"object"==typeof n)return se(n)}catch(n){}return re()},saveToState:function(e,t="eventiCliniciFilters"){try{e?.setState?.(t,ie)}catch(n){}}};let ce=null,de=null;function me(e){ce=e,t.log("üéõÔ∏è Modulo Filters inizializzato");try{ue(le.get())}catch(n){}try{"function"==typeof de&&de(),de=le.subscribe(e=>{ue(e)})}catch(n){}}function ve(){if(!ce)return t.warn("‚ö†Ô∏è DOM elements non inizializzati per resetFiltersUI"),void 0;ce.filterType&&(ce.filterType.value=""),ce.filterDateFrom&&(ce.filterDateFrom.value=""),ce.filterDateTo&&(ce.filterDateTo.value=""),ce.filterReparto&&(ce.filterReparto.value=""),ce.filterStato&&(ce.filterStato.value=""),ce.filterSortColumn&&(ce.filterSortColumn.value=""),ce.filterSortDirection&&(ce.filterSortDirection.value="desc"),ce.filterStatus&&(ce.filterStatus.value=""),ce.searchPatientInput&&(ce.searchPatientInput.value=""),ce.filterPriorityFrom&&(ce.filterPriorityFrom.value=""),ce.filterPriorityTo&&(ce.filterPriorityTo.value=""),ce.filterCreatedBy&&(ce.filterCreatedBy.value=""),ce.filterHasAllegati&&(ce.filterHasAllegati.checked=!1),t.log("üßπ Filtri UI resettati")}function ue(e){return ce?e?(ce.filterType&&e.tipo_evento&&(ce.filterType.value=e.tipo_evento),ce.filterDateFrom&&e.data_da&&(ce.filterDateFrom.value=e.data_da),ce.filterDateTo&&e.data_a&&(ce.filterDateTo.value=e.data_a),ce.filterReparto&&e.reparto&&(ce.filterReparto.value=e.reparto),ce.filterStato&&e.stato&&(ce.filterStato.value=e.stato),ce.filterSortColumn&&e.sortColumn&&(ce.filterSortColumn.value=e.sortColumn),ce.filterSortDirection&&e.sortDirection&&(ce.filterSortDirection.value=e.sortDirection),ce.filterStatus&&e.status&&(ce.filterStatus.value=e.status),ce.searchPatientInput&&e.paziente&&(ce.searchPatientInput.value=e.paziente),ce.filterPriorityFrom&&e.priorita_da&&(ce.filterPriorityFrom.value=e.priorita_da),ce.filterPriorityTo&&e.priorita_a&&(ce.filterPriorityTo.value=e.priorita_a),ce.filterCreatedBy&&e.creato_da&&(ce.filterCreatedBy.value=e.creato_da),ce.filterHasAllegati&&"boolean"==typeof e.ha_allegati&&(ce.filterHasAllegati.checked=e.ha_allegati),t.log("üéõÔ∏è Filtri applicati all'UI:",e),void 0):(t.warn("‚ö†Ô∏è Nessun filtro fornito per applyFiltersToUI"),void 0):(t.warn("‚ö†Ô∏è DOM elements non inizializzati per applyFiltersToUI"),void 0)}function pe(){if(!ce)return t.warn("‚ö†Ô∏è DOM elements non inizializzati per getFiltersFromUI"),{};const e={paziente_search:ce.searchPatientInput?.value||"",tipo_evento:ce.filterType?.value||"",data_da:ce.filterDateFrom?.value||"",data_a:ce.filterDateTo?.value||"",reparto:ce.filterReparto?.value||"",stato:ce.filterStato?.value||"",sortColumn:ce.filterSortColumn?.value||"",sortDirection:ce.filterSortDirection?.value||"desc"};return t.log("üìä Filtri raccolti dalla UI:",e),e}function ge(e){return ce.filterReparto?e&&Array.isArray(e)?async function(e,t,n){if(!e)return n&&n.warn("‚ö†Ô∏è Elemento filterReparto non trovato"),void 0;try{const i=e.customSelectInstance;if(i){n&&n.log("üîß Popolamento CustomSelect reparto con",t.length,"opzioni");const a=e.querySelector('option[value=""]');e.innerHTML="",a&&e.appendChild(a),t.forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)}),"function"==typeof i.updateOptions?(i.updateOptions(),n&&n.log("üîß CustomSelect options updated")):"function"==typeof i.refresh&&(i.refresh(),n&&n.log("üîß CustomSelect refreshed"))}else{n&&n.log("üîß Popolamento select standard reparto con",t.length,"opzioni");const i=e.querySelector('option[value=""]');e.innerHTML="",i&&e.appendChild(i),t.forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)})}n&&n.log("‚úÖ Filtro reparti popolato con",t.length,"opzioni")}catch(i){n&&n.error("‚ùå Errore popolamento filtro reparti:",i)}}(ce.filterReparto,e,t):(t.warn("‚ö†Ô∏è Lista departments non valida:",e),void 0):(t.warn("‚ö†Ô∏è DOM elements non inizializzati per populateDepartmentFilter"),void 0)}function he(e){if(!ce)return t.warn("‚ö†Ô∏è DOM elements non inizializzati per populateAdvancedFilters"),void 0;t.log("üîß Popolamento filtri avanzati:",e)}function Ee(){const e=pe(),n=[];if(e.data_da&&e.data_a){new Date(e.data_da)>new Date(e.data_a)&&n.push("La data di inizio deve essere precedente alla data di fine")}if(e.priorita_da&&e.priorita_a){parseInt(e.priorita_da)>parseInt(e.priorita_a)&&n.push("La priorit√† minima deve essere inferiore alla priorit√† massima")}const i=0===n.length;return t.log(i?"‚úÖ Filtri validi":"‚ùå Errori validazione filtri:",n),{isValid:i,errors:n}}function fe(){const e=pe();let n=0;return e.tipo_evento&&n++,e.data_da&&n++,e.data_a&&n++,e.reparto&&n++,e.status&&n++,e.paziente&&n++,e.priorita_da&&n++,e.priorita_a&&n++,e.creato_da&&n++,e.ha_allegati&&n++,t.log(`üìä Filtri attivi: ${n}`),n}function ye(e="eventi-clinici-filters"){try{const n=pe();localStorage.setItem(e,JSON.stringify(n)),t.log("üíæ Filtri salvati nel localStorage:",e)}catch(n){t.error("‚ùå Errore salvataggio filtri:",n)}}function be(e="eventi-clinici-filters"){try{const n=localStorage.getItem(e);if(n){const i=JSON.parse(n);return t.log("üìÇ Filtri caricati dal localStorage:",e),i}}catch(n){t.error("‚ùå Errore caricamento filtri:",n)}return null}function ze(e="eventi-clinici-filters"){const n=be(e);if(n){ue(n);try{le.set(n)}catch(i){}t.log("üîÑ Filtri salvati ripristinati")}}function _e(e="eventi-clinici-filters"){try{localStorage.removeItem(e),t.log("üßπ Filtri salvati rimossi:",e)}catch(n){t.error("‚ùå Errore rimozione filtri salvati:",n)}}const we=Object.freeze(Object.defineProperty({__proto__:null,applyFiltersToUI:ue,clearSavedFilters:_e,getActiveFiltersCount:fe,getFiltersFromUI:pe,initializeFilters:me,loadFiltersFromStorage:be,populateAdvancedFilters:he,populateDepartmentFilter:ge,resetFiltersUI:ve,restoreSavedFilters:ze,saveFiltersToStorage:ye,validateFilters:Ee},Symbol.toStringTag,{value:"Module"}));function Ie(e,t=150,n={}){const{leading:i=!1,trailing:a=!0}=n;let o,r,s=null,l=!1;function c(){s=null,a&&o&&(e.apply(r,o),o=r=void 0,l=!1)}function d(...n){o=n,r=this,s?(clearTimeout(s),s=setTimeout(c,t)):(i&&!l&&(e.apply(r,o),l=!0,o=r=void 0),s=setTimeout(c,t))}return d.cancel=()=>{s&&(clearTimeout(s),s=null),o=r=void 0,l=!1},d}let Ce={},Fe=null,Se=null,De=!1;function Te(){t.log("üîÑ Inizializzazione DOM elements per eventi clinici..."),Ce={timelineContainer:document.getElementById("eventi-timeline-container"),tableContainer:document.getElementById("eventi-table-container"),tableBody:document.getElementById("eventi-table-body"),searchPatientInput:document.getElementById("eventi-search-patient"),patientSearchResults:document.getElementById("patient-search-results"),filterType:document.getElementById("eventi-filter-type"),filterDateFrom:document.getElementById("eventi-filter-date-from"),filterDateTo:document.getElementById("eventi-filter-date-to"),filterReparto:document.getElementById("eventi-filter-reparto"),filterStato:document.getElementById("eventi-filter-stato"),filterSortColumn:document.getElementById("eventi-sort-column"),filterSortDirection:document.getElementById("eventi-sort-direction"),addEventBtn:document.getElementById("eventi-add-btn"),resetFiltersBtn:document.getElementById("eventi-reset-filters-btn"),exportCsvBtn:document.getElementById("eventi-export-csv-btn"),exportJsonBtn:document.getElementById("eventi-export-json-btn"),resetFiltersBtnMobile:document.getElementById("eventi-reset-filters-btn-mobile"),exportCsvBtnMobile:document.getElementById("eventi-export-csv-btn-mobile"),exportJsonBtnMobile:document.getElementById("eventi-export-json-btn-mobile"),paginationControls:document.getElementById("eventi-pagination-controls"),prevPageBtn:document.getElementById("eventi-prev-page-btn"),nextPageBtn:document.getElementById("eventi-next-page-btn"),pageInfo:document.getElementById("eventi-page-info"),paginationControlsMobile:document.getElementById("eventi-pagination-controls-mobile"),prevPageBtnMobile:document.getElementById("eventi-prev-page-btn-mobile"),nextPageBtnMobile:document.getElementById("eventi-next-page-btn-mobile"),pageInfoMobile:document.getElementById("eventi-page-info-mobile"),eventFormModal:document.getElementById("evento-form-modal"),eventDetailModal:document.getElementById("evento-detail-modal"),modalTitle:document.getElementById("evento-modal-title"),modalIcon:document.getElementById("evento-modal-icon"),saveBtn:document.getElementById("evento-save-btn"),detailTitle:document.getElementById("evento-detail-title"),detailIcon:document.getElementById("evento-detail-icon"),detailContent:document.getElementById("evento-detail-content"),messageContainer:document.getElementById("evento-messaggio-container"),eventForm:document.getElementById("evento-form"),eventId:document.getElementById("evento-id"),eventPatientInput:document.getElementById("evento-paziente"),eventPatientId:document.getElementById("evento-paziente-id"),eventPatientSearchResults:document.getElementById("evento-patient-search-results"),eventType:document.getElementById("evento-tipo"),eventDate:document.getElementById("evento-data"),eventDescription:document.getElementById("evento-descrizione"),interventionFields:document.getElementById("intervento-fields"),interventionType:document.getElementById("evento-tipo-intervento"),infectionFields:document.getElementById("infezione-fields"),infectionAgent:document.getElementById("evento-agente-patogeno")};const n=Object.values(Ce).filter(e=>null!==e).length,i=Object.keys(Ce).length;t.log(`üéØ DOM elements inizializzati: ${n}/${i} elementi trovati`);const a=Object.entries(Ce).filter(([e,t])=>null===t).map(([e,t])=>e);return a.length>0&&t.warn("‚ö†Ô∏è Elementi DOM non trovati:",a),t.log("‚úÖ DOM elements inizializzati per eventi clinici UI"),async function(){try{const n=await e(()=>Promise.resolve().then(()=>k),void 0);n.initializeRenderer&&n.initializeRenderer(Ce);const i=await e(()=>Promise.resolve().then(()=>te),void 0);i.initializeForms&&i.initializeForms(Ce);const a=await e(()=>Promise.resolve().then(()=>we),void 0);a.initializeFilters&&a.initializeFilters(Ce),t.log("üîó Tutti i moduli UI inizializzati")}catch(n){t.error("‚ùå Errore inizializzazione moduli UI:",n)}}(),function(){if(Me(),"undefined"!=typeof window){const e=Ie(()=>Me(),150);window.addEventListener("resize",e)}}(),De=!0,t.log("‚úÖ State Manager inizializzato completamente"),Ce}function Pe(){return De?Ce:(t.warn("‚ö†Ô∏è State Manager non inizializzato, chiamando initializeDOMElements()"),Te())}function Be(){try{t.log("üßπ Resetting UI state..."),Fe=null,Se=null,Ce={},De=!1,t.log("‚úÖ UI state reset: renderers e domElements azzerati")}catch(e){t.warn("‚ö†Ô∏è Errore durante resetUIState:",e)}}function Me(){try{!function(e={}){const t=window.innerWidth<768,n=window.innerWidth>=768&&window.innerWidth<1024,i=window.innerWidth>=1024&&window.innerWidth<1200,a=window.innerWidth>=1024;e.tableContainer&&(e.tableContainer.style.display=a?"block":"none"),e.timelineContainer&&(e.timelineContainer.style.display=a?"none":"block",e.timelineContainer.classList.toggle("mobile-layout",t),e.timelineContainer.classList.toggle("tablet-layout",n)),e.tableContainer&&e.tableContainer.classList.toggle("compact-table-layout",i),document.querySelectorAll(".timeline-event-card").forEach(e=>{e.classList.toggle("mobile-card",t),e.classList.toggle("tablet-card",n)})}(),t.log("üì± Design responsive applicato")}catch(e){t.warn("‚ö†Ô∏è Errore applicazione design responsive:",e)}}function Le(e){if(!e)return;const{currentPage:n=0,totalPages:i=1}=e,a=`${n+1} / ${i}`,o=document.getElementById("eventi-page-info-mobile");o?(o.textContent=a,t.log(`üîß Badge mobile forzato: ${a}`)):t.warn("‚ö†Ô∏è Impossibile forzare aggiornamento badge mobile - elemento non trovato")}const Re=Object.freeze(Object.defineProperty({__proto__:null,applyResponsiveDesign:Me,forceUpdateMobilePagination:Le,getDOMElements:Pe,initializeDOMElements:Te,resetUIState:Be},Symbol.toStringTag,{value:"Module"}));function xe(e){const t=[["ID","Tipo Evento","Data Evento","Paziente","Reparto","Descrizione","Tipo Intervento","Agente Patogeno","Data Fine Evento","Stato","Data Creazione"].join(",")];return e.forEach(e=>{const n="infezione"===e.tipo_evento?e.data_fine_evento?"Risolta":"Attiva":"",i=[e.id||"",e.tipo_evento||"",e.data_evento||"",e.pazienti?`"${e.pazienti.nome} ${e.pazienti.cognome}"`:"",e.pazienti?.reparto_appartenenza||"",e.descrizione?`"${String(e.descrizione).replace(/"/g,'""')}"`:"",e.tipo_intervento||"",e.agente_patogeno||"",e.data_fine_evento||"",n,e.created_at||""];t.push(i.join(","))}),t.join("\n")}async function $e(e={},n="csv"){t.log("üì§ Esportazione eventi filtrati:",{format:n,filters:e});const a=await s.getAllEventi(e,{page:0,limit:1e4});if(!a.eventi||0===a.eventi.length)throw new Error("Nessun evento da esportare con i filtri correnti");const o=function(e,t){const n=(new Date).toISOString().split("T")[0];switch(t){case"csv":return{data:xe(e),filename:`eventi_clinici_${n}.csv`,mimeType:"text/csv;charset=utf-8;"};case"json":return{data:JSON.stringify(e,null,2),filename:`eventi_clinici_${n}.json`,mimeType:"application/json;charset=utf-8;"};default:throw new Error(`Formato di esportazione non supportato: ${t}`)}}(a.eventi,n);return"csv"===n?l(o.data,o.filename):"json"===n&&c(o.data,o.filename),t.log("‚úÖ Esportazione completata:",{formato:n,eventi:a.eventi.length,filename:o.filename}),i.success(`Esportati ${a.eventi.length} eventi con successo!`),{success:!0,count:a.eventi.length,filename:o.filename}}const Ae={intervento:{icon:"fas fa-scalpel",color:"primary",label:"Intervento"},infezione:{icon:"fas fa-virus",color:"warning",label:"Infezione"}};function ke(e){if(!e)return null;const t=function(e){const t=Ae[e]||{};return{icon:t.icon||"fas fa-calendar-alt",color:t.color||"secondary",label:t.label||e}}(e.tipo_evento);return{...e,dataEventoFormatted:r(e.data_evento),dataFineEventoFormatted:e.data_fine_evento?r(e.data_fine_evento):null,isInfezione:"infezione"===e.tipo_evento,isRisolta:"infezione"===e.tipo_evento&&!!e.data_fine_evento,tipoEventoIcon:t.icon,tipoEventoColor:t.color,tipoEventoLabel:t.label,pazienteInfo:e.pazienti?{id:e.pazienti.id,nomeCompleto:`${e.pazienti.nome} ${e.pazienti.cognome}`,reparto:e.pazienti.reparto_appartenenza}:null}}function Oe(e){return e?{...e,nomeCompleto:`${e.nome} ${e.cognome}`,dataRicoveroFormatted:r(e.data_ricovero),isActive:!e.data_dimissione}:null}function je(e,t){const n=e?.message||t;e?.message?.includes("Errore nel")||i.error(n)}async function Ne(e={},n=0){try{t.log("üìä Caricamento eventi clinici:",{filters:e,page:n});const i={page:n,limit:10},a=await s.getAllEventi(e,i),o={...a,eventi:a.eventi.map(ke)};return t.log("‚úÖ Eventi clinici caricati:",{count:o.eventi.length,totalCount:o.totalCount,currentPage:o.currentPage}),o}catch(i){throw t.error("‚ùå Errore caricamento eventi clinici:",i),je(i,"Errore nel caricamento degli eventi clinici"),i}}async function He(e){try{t.log("‚ûï Creazione nuovo evento clinico:",e);const n=ke(await s.createEvento(e));return t.log("‚úÖ Evento clinico creato:",n),n}catch(n){throw t.error("‚ùå Errore creazione evento clinico:",n),je(n,"Errore nella creazione dell'evento clinico"),n}}async function Ue(e,n){try{t.log("‚úèÔ∏è Aggiornamento evento clinico:",{eventoId:e,eventoData:n});const i=ke(await s.updateEvento(e,n));return t.log("‚úÖ Evento clinico aggiornato:",i),i}catch(i){throw t.error("‚ùå Errore aggiornamento evento clinico:",i),je(i,"Errore nell'aggiornamento dell'evento clinico"),i}}async function Ve(e){try{return t.log("üóëÔ∏è Eliminazione evento clinico:",e),await s.deleteEvento(e),t.log("‚úÖ Evento clinico eliminato:",e),!0}catch(n){throw t.error("‚ùå Errore eliminazione evento clinico:",n),je(n,"Errore nell'eliminazione dell'evento clinico"),n}}async function qe(e,n){try{return t.log("ü©∫ Risoluzione infezione:",{eventoId:e,dataFine:n}),await s.resolveInfezione(e,n),t.log("‚úÖ Infezione risolta:",e),!0}catch(i){throw t.error("‚ùå Errore risoluzione infezione:",i),je(i,"Errore nella risoluzione dell'infezione"),i}}async function We(e,n=!0){try{if(!e||e.trim().length<2)return[];t.log("üîç Ricerca pazienti (service):",{searchTerm:e,activeOnly:n});const i=(await d.search(e.trim(),{activeOnly:n})).map(Oe);return t.log("‚úÖ Pazienti trovati:",i.length),i}catch(i){throw t.error("‚ùå Errore ricerca pazienti:",i),je(i,"Errore nella ricerca pazienti"),i}}function Je(e,n){return new Promise((i,a)=>{if(!e||e.trim().length<2){return i([]),void 0}try{t.log("üîç Ricerca pazienti real-time (service):",e),d.searchRealtime(e.trim(),{activeOnly:!0,debounceMs:300,onUpdate:e=>{const t=e.map(Oe);n,i(t)},onError:e=>{t.error("‚ùå Errore ricerca pazienti real-time:",e),a(e)}})}catch(o){t.error("‚ùå Errore inizializzazione ricerca real-time:",o),a(o)}})}async function Ge(e={}){try{const n={...le.get(),...e};!function(e){const t=[];if(e.data_da&&e.data_a){const n=new Date(e.data_da),i=new Date(e.data_a);n>i&&t.push("La data di inizio non pu√≤ essere successiva alla data di fine");const a=Math.abs(i-n);Math.ceil(a/864e5)>730&&t.push("Il range di date non pu√≤ superare i 2 anni")}const n=(new Date).toISOString().split("T")[0];if(e.data_da&&e.data_da>n&&t.push("La data di inizio non pu√≤ essere nel futuro"),e.data_a&&e.data_a>n&&t.push("La data di fine non pu√≤ essere nel futuro"),e.tipo_intervento&&"intervento"!==e.tipo_evento&&t.push("Il filtro tipo intervento pu√≤ essere usato solo con eventi di tipo intervento"),t.length>0)throw new Error(t.join(", "))}(n),("sortColumn"in e||"sortDirection"in e)&&function(e,t){if(!e)return;if(!["data_evento","tipo_evento","created_at","paziente_nome"].includes(e))throw new Error(`Colonna di ordinamento non valida: ${e}`);if(!["asc","desc"].includes(t))throw new Error(`Direzione di ordinamento non valida: ${t}`)}(n.sortColumn,n.sortDirection);const i=await Ne(n,0);return le.replace(n),t.log("‚úÖ Filtri applicati:",{filtri:Object.keys(e),risultati:i.eventi.length}),i}catch(n){throw t.error("‚ùå Errore applicazione filtri:",n),je(n,"Errore nell'applicazione dei filtri"),n}}async function Ye(e){return Ge({tipo_evento:e})}async function Ze(e,t){return Ge({data_da:e||"",data_a:t||""})}async function Ke(e){return Ge({stato:e||""})}async function Qe(e,t=""){return Ge({paziente_search:e||"",paziente_id:t||""})}async function Xe(e){return Ge(e)}async function et(e,t){return Ge({sortColumn:e,sortDirection:t})}function tt(){le.reset(),t.log("üîß Filtri in memoria reimpostati ai default")}async function nt(){try{t.log("üîÑ Reset completo filtri e stato"),le.reset(),a.setState("eventiCliniciFilters",null),ct();const e=await Ne(le.get(),0);return t.log("‚úÖ Reset completo completato:",{risultati:e.eventi.length}),i.success("Filtri resettati con successo"),e}catch(e){throw t.error("‚ùå Errore reset completo filtri:",e),je(e,"Errore nel reset dei filtri"),e}}async function it(){try{le.saveToState(a,"eventiCliniciFilters"),t.log("üíæ Filtri salvati nello stato:",le.get()),i.success("Filtri salvati con successo")}catch(e){throw t.error("‚ùå Errore salvataggio filtri:",e),i.error("Impossibile salvare i filtri"),e}}async function at(){try{return le.loadFromState(a,"eventiCliniciFilters"),t.log("üìÇ Filtri caricati dallo stato:",le.get()),le.get()}catch(e){return t.error("‚ùå Errore caricamento filtri:",e),le.get()}}async function ot(e="csv"){try{return await $e(le.get(),e)}catch(n){throw t.error("‚ùå Errore esportazione eventi:",n),i.error(n.message||"Errore nell'esportazione degli eventi"),n}}async function rt(){try{t.log("üìä Calcolo statistiche filtri");const e=(await s.getAllEventi({},{page:0,limit:1,countOnly:!0})).totalCount,n=(await s.getAllEventi(le.get(),{page:0,limit:1,countOnly:!0})).totalCount,i=Object.entries(le.get()).filter(([e,t])=>t&&""!==t.toString().trim()&&!["sortColumn","sortDirection"].includes(e)).map(([e,t])=>({key:e,value:t})),a={totalEvents:e,filteredEvents:n,activeFiltersCount:i.length,activeFilters:i,filterEfficiency:e>0?((e-n)/e*100).toFixed(1):0};return t.log("‚úÖ Statistiche filtri calcolate:",a),a}catch(e){return t.error("‚ùå Errore calcolo statistiche filtri:",e),{totalEvents:0,filteredEvents:0,activeFiltersCount:0,activeFilters:[],filterEfficiency:0}}}async function st(){try{t.log("üè• Caricamento lista reparti");const e=await v("reparto_appartenenza");return t.log("‚úÖ Lista reparti caricata:",e.length),e}catch(e){return t.error("‚ùå Errore caricamento reparti:",e),[]}}async function lt(){try{t.log("üí° Caricamento filtri suggeriti");const e=await s.getSuggestedFilters();return t.log("‚úÖ Filtri suggeriti caricati:",e),e}catch(e){return t.error("‚ùå Errore caricamento filtri suggeriti:",e),{tipiIntervento:[],agentiPatogeni:[],reparti:[]}}}function ct(){try{d.resetCache?.(),t.log("üßπ Cache ricerca pazienti pulita (service)")}catch(e){t.warn("‚ö†Ô∏è clearSearchCache: resetCache non disponibile sul service")}}const dt=Object.freeze(Object.defineProperty({__proto__:null,applyCombinedFilters:Xe,applyDateRangeFilter:Ze,applyEventTypeFilter:Ye,applyFilters:Ge,applyPatientSearch:Qe,applyPatientStatusFilter:Ke,applySorting:et,clearSearchCache:ct,createEventoClinico:He,deleteEventoClinico:Ve,exportFilteredEvents:ot,fetchEventiClinici:Ne,getDepartmentsList:st,getFilterStats:rt,getSuggestedFilters:lt,loadFiltersFromState:at,resetCurrentFiltersToDefaults:tt,resetFiltersAndState:nt,resolveInfezioneEvento:qe,saveFiltersToState:it,searchPatientsRealTime:Je,searchPazientiForEvents:We,updateEventoClinico:Ue},Symbol.toStringTag,{value:"Module"})),mt=Object.freeze(Object.defineProperty({__proto__:null,applyFiltersToUI:ue,applyResponsiveDesign:Me,clearFormMessages:V,clearSavedFilters:_e,disableAutoSave:ee,enableAutoSave:X,forceUpdateMobilePagination:Le,getActiveFiltersCount:fe,getDOMElements:Pe,getFiltersFromUI:pe,getFormData:G,hideSearchingState:P,highlightFormErrors:K,highlightSearchTerms:A,initializeDOMElements:Te,initializeFilters:me,initializeForms:j,initializeRenderer:_,loadFiltersFromStorage:be,populateAdvancedFilters:he,populateDepartmentFilter:ge,populateEventForm:N,renderEventDetails:M,renderEventsResponsive:I,renderEventsTable:F,renderEventsTimeline:C,renderPatientSearchResults:B,resetCurrentFiltersToDefaults:tt,resetEventForm:H,resetFiltersUI:ve,resetUIState:Be,restoreSavedFilters:ze,saveFiltersToStorage:ye,setFormEnabled:Y,setFormLoading:Z,showActiveFiltersIndicator:L,showError:D,showExportProgress:x,showExportSuccess:$,showFilterStats:R,showFormMessage:U,showLoading:S,showSearchingState:T,toggleEventTypeFields:W,updateModalTitle:q,updateSearchResultsCount:f,validateEventForm:J,validateFilters:Ee},Symbol.toStringTag,{value:"Module"}));function vt(e){const t=document.getElementById(e);t&&(t.style.display="none")}function ut(){vt("patient-search-results"),vt("evento-patient-search-results")}class pt{constructor(e,t,n,i,a){this.state=e,this.domElements=t,this.filterManager=n,this.modalManager=i,this.dataManager=a,this.cleanupFunctions=[]}async setupEventListeners(){this.setupMainActionListeners(),this.setupFilterListeners(),this.setupPaginationListeners(),this.setupModalFormListeners(),this.setupSearchListeners(),await this.setupWindowListeners(),t.log("‚úÖ Event listeners configurati")}setupMainActionListeners(){if(this.domElements.addEventBtn){const e=()=>this.modalManager.openEventModal();this.domElements.addEventBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.addEventBtn.removeEventListener("click",e))}if(this.domElements.resetFiltersBtn){const e=()=>this.filterManager.resetFilters();this.domElements.resetFiltersBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.resetFiltersBtn.removeEventListener("click",e))}if(this.domElements.resetFiltersBtnMobile){const e=()=>this.filterManager.resetFilters();this.domElements.resetFiltersBtnMobile.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.resetFiltersBtnMobile.removeEventListener("click",e))}if(this.domElements.exportBtn){const e=()=>this.dataManager.exportEvents("csv");this.domElements.exportBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.exportBtn.removeEventListener("click",e))}if(this.domElements.exportCsvBtn){const e=()=>this.dataManager.exportEvents("csv");this.domElements.exportCsvBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.exportCsvBtn.removeEventListener("click",e))}if(this.domElements.exportJsonBtn){const e=()=>this.dataManager.exportEvents("json");this.domElements.exportJsonBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.exportJsonBtn.removeEventListener("click",e))}if(this.domElements.exportCsvBtnMobile){const e=()=>this.dataManager.exportEvents("csv");this.domElements.exportCsvBtnMobile.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.exportCsvBtnMobile.removeEventListener("click",e))}if(this.domElements.exportJsonBtnMobile){const e=()=>this.dataManager.exportEvents("json");this.domElements.exportJsonBtnMobile.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.exportJsonBtnMobile.removeEventListener("click",e))}if(this.domElements.saveFiltersBtn){const e=()=>this.filterManager.saveCurrentFilters();this.domElements.saveFiltersBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.saveFiltersBtn.removeEventListener("click",e))}if(this.domElements.loadFiltersBtn){const e=()=>this.filterManager.loadSavedFilters();this.domElements.loadFiltersBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.loadFiltersBtn.removeEventListener("click",e))}}setupFilterListeners(){if(this.domElements.filterType){const e=async()=>{await this.filterManager.handleEventTypeFilter(this.domElements.filterType.value)};this.domElements.filterType.addEventListener("change",e),this.cleanupFunctions.push(()=>this.domElements.filterType.removeEventListener("change",e))}if(this.domElements.filterDateFrom){const e=this.filterManager.createDebouncedFilterHandler(async()=>{await this.filterManager.handleDateRangeFilter(this.domElements)},500);this.domElements.filterDateFrom.addEventListener("change",e),this.cleanupFunctions.push(()=>this.domElements.filterDateFrom.removeEventListener("change",e))}if(this.domElements.filterDateTo){const e=this.filterManager.createDebouncedFilterHandler(async()=>{await this.filterManager.handleDateRangeFilter(this.domElements)},500);this.domElements.filterDateTo.addEventListener("change",e),this.cleanupFunctions.push(()=>this.domElements.filterDateTo.removeEventListener("change",e))}if(this.domElements.filterReparto){const e=async()=>{await this.filterManager.handleCombinedFiltersChange()};this.domElements.filterReparto.addEventListener("change",e),this.cleanupFunctions.push(()=>this.domElements.filterReparto.removeEventListener("change",e))}if(this.domElements.filterStato){const e=async()=>{await this.filterManager.handlePatientStatusFilter(this.domElements.filterStato.value)};this.domElements.filterStato.addEventListener("change",e),this.cleanupFunctions.push(()=>this.domElements.filterStato.removeEventListener("change",e))}if(this.domElements.filterTipoIntervento){const e=this.filterManager.createDebouncedFilterHandler(async()=>{await this.filterManager.handleCombinedFiltersChange()},500);this.domElements.filterTipoIntervento.addEventListener("input",e),this.cleanupFunctions.push(()=>this.domElements.filterTipoIntervento.removeEventListener("input",e))}if(this.domElements.filterSortColumn){const e=async()=>{await this.filterManager.handleSortingChange(this.domElements)};this.domElements.filterSortColumn.addEventListener("change",e),this.cleanupFunctions.push(()=>this.domElements.filterSortColumn.removeEventListener("change",e))}if(this.domElements.filterSortDirection){const e=async()=>{await this.filterManager.handleSortingChange(this.domElements)};this.domElements.filterSortDirection.addEventListener("change",e),this.cleanupFunctions.push(()=>this.domElements.filterSortDirection.removeEventListener("change",e))}this.setupAdvancedFiltersToggle()}setupAdvancedFiltersToggle(){if(this.domElements.advancedFiltersToggle&&this.domElements.advancedFiltersContainer){const e=e=>{e.preventDefault(),e.stopPropagation();const n=this.domElements.advancedFiltersContainer.classList.contains("show");n?(this.domElements.advancedFiltersContainer.classList.remove("show"),this.domElements.advancedFiltersToggle.setAttribute("aria-expanded","false")):(this.domElements.advancedFiltersContainer.classList.add("show"),this.domElements.advancedFiltersToggle.setAttribute("aria-expanded","true"));const i=this.domElements.advancedFiltersToggle.querySelector(".material-icons");i&&(i.style.transform=n?"rotate(0deg)":"rotate(180deg)"),t.log("üîß Filtri avanzati "+(n?"chiusi":"aperti"))};this.domElements.advancedFiltersToggle.removeAttribute("data-bs-toggle"),this.domElements.advancedFiltersToggle.removeAttribute("data-bs-target"),this.domElements.advancedFiltersToggle.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.advancedFiltersToggle.removeEventListener("click",e))}}setupPaginationListeners(){if(this.domElements.prevPageBtn){const e=()=>{this.domElements.prevPageBtn.disabled||this.state.currentPage<=0||this.dataManager.changePage(this.state.currentPage-1)};this.domElements.prevPageBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.prevPageBtn.removeEventListener("click",e))}if(this.domElements.nextPageBtn){const e=()=>{this.domElements.nextPageBtn.disabled||this.state.currentPage>=this.state.totalPages-1||this.dataManager.changePage(this.state.currentPage+1)};this.domElements.nextPageBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.nextPageBtn.removeEventListener("click",e))}if(this.domElements.prevPageBtnMobile){const e=()=>{this.domElements.prevPageBtnMobile.disabled||this.state.currentPage<=0||this.dataManager.changePage(this.state.currentPage-1)};this.domElements.prevPageBtnMobile.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.prevPageBtnMobile.removeEventListener("click",e))}if(this.domElements.nextPageBtnMobile){const e=()=>{this.domElements.nextPageBtnMobile.disabled||this.state.currentPage>=this.state.totalPages-1||this.dataManager.changePage(this.state.currentPage+1)};this.domElements.nextPageBtnMobile.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.nextPageBtnMobile.removeEventListener("click",e))}}setupModalFormListeners(){if(this.domElements.saveBtn){const e=()=>this.modalManager.handleSaveEvent(()=>this.dataManager.loadEventsData());this.domElements.saveBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.saveBtn.removeEventListener("click",e))}if(this.domElements.eventType){const t=async t=>{const{toggleEventTypeFields:n}=await e(async()=>{const{toggleEventTypeFields:e}=await Promise.resolve().then(()=>mt);return{toggleEventTypeFields:e}},void 0);n(t.target.value)};this.domElements.eventType.addEventListener("change",t),this.cleanupFunctions.push(()=>this.domElements.eventType.removeEventListener("change",t))}if(this.domElements.editBtn){const e=()=>this.modalManager.handleEditEvent();this.domElements.editBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.editBtn.removeEventListener("click",e))}if(this.domElements.deleteBtn){const e=()=>this.modalManager.handleDeleteEvent();this.domElements.deleteBtn.addEventListener("click",e),this.cleanupFunctions.push(()=>this.domElements.deleteBtn.removeEventListener("click",e))}}setupSearchListeners(){if(this.domElements.searchPatientInput&&this.domElements.patientSearchResults){const{destroy:e}=m({input:this.domElements.searchPatientInput,resultsContainer:this.domElements.patientSearchResults,activeOnly:!0,onSelect:e=>this.filterManager.handlePatientSearchFilter(this.domElements.searchPatientInput.value,e?.id)});this.cleanupFunctions.push(()=>e&&e())}if(this.domElements.eventPatientInput&&this.domElements.eventPatientSearchResults){const{destroy:e}=m({input:this.domElements.eventPatientInput,resultsContainer:this.domElements.eventPatientSearchResults,activeOnly:!0,onSelect:e=>{this.domElements.eventPatientId&&(this.domElements.eventPatientId.value=e.id)}});this.cleanupFunctions.push(()=>e&&e())}const e=e=>{e.target.closest(".position-relative")||ut()};document.addEventListener("click",e),this.cleanupFunctions.push(()=>document.removeEventListener("click",e))}async setupWindowListeners(){const{applyResponsiveDesign:t}=await e(async()=>{const{applyResponsiveDesign:e}=await Promise.resolve().then(()=>mt);return{applyResponsiveDesign:e}},void 0),n=()=>t();window.addEventListener("resize",n),this.cleanupFunctions.push(()=>window.removeEventListener("resize",n))}initializeAdvancedFiltersState(){if(this.domElements.advancedFiltersToggle&&this.domElements.advancedFiltersContainer){this.domElements.advancedFiltersContainer.classList.remove("show"),this.domElements.advancedFiltersToggle.setAttribute("aria-expanded","false");const e=this.domElements.advancedFiltersToggle.querySelector(".material-icons");e&&(e.style.transform="rotate(0deg)",e.style.transition="transform 0.3s ease"),t.log("‚úÖ Stato iniziale filtri avanzati impostato (nascosti)")}}cleanup(){t.log("üßπ Cleanup event listeners"),this.cleanupFunctions.forEach(e=>{try{e()}catch(n){t.error("‚ùå Errore durante cleanup listener:",n)}}),this.cleanupFunctions=[]}}class gt{constructor(e,t,n){this.state=e,this.setupEventCardListenersCallback=t,this.updateFilterStatsCallback=n}async handlePatientSearchFilter(e,n){try{T();const t=await Qe(e,n||"");I(t),this.setupEventCardListenersCallback(),f(t.eventi.length,t.totalCount,le.get()),L(le.get())}catch(i){t.error("‚ùå Errore filtro ricerca pazienti:",i)}finally{P()}}async handleDateRangeFilter(e){try{T();const t=e.filterDateFrom?.value||"",n=e.filterDateTo?.value||"",i=await Ze(t,n);I(i),this.setupEventCardListenersCallback(),f(i.eventi.length,i.totalCount,le.get()),L(le.get())}catch(n){t.error("‚ùå Errore filtro range date:",n),n.message.includes("data di inizio")&&i.error(n.message)}finally{P()}}async handleEventTypeFilter(e){try{T();const t=await Ye(e);I(t),this.setupEventCardListenersCallback(),f(t.eventi.length,t.totalCount,le.get()),L(le.get())}catch(n){t.error("‚ùå Errore applicazione filtro tipo evento:",n)}finally{P()}}async handlePatientStatusFilter(e){try{T();const t=await Ke(e);I(t),this.setupEventCardListenersCallback(),f(t.eventi.length,t.totalCount,le.get()),L(le.get())}catch(n){t.error("‚ùå Errore applicazione filtro stato paziente:",n)}finally{P()}}async handleCombinedFiltersChange(){try{T();const e=pe(),t=await Xe(e);le.set(e),this.state.currentPage=0,I(t),this.setupEventCardListenersCallback(),f(t.eventi.length,t.totalCount,le.get()),L(le.get()),await this.updateFilterStatsCallback(),it()}catch(e){t.error("‚ùå Errore applicazione filtri combinati:",e)}finally{P()}}async handleSortingChange(e){try{T();const t=e.filterSortColumn?.value||"data_evento",n=e.filterSortDirection?.value||"desc",i=await et(t,n);this.state.filters.sortColumn=t,this.state.filters.sortDirection=n,I(i),this.setupEventCardListenersCallback(),f(i.eventi.length,i.totalCount,le.get()),await this.updateFilterStatsCallback(),it()}catch(n){t.error("‚ùå Errore applicazione ordinamento:",n)}finally{P()}}async handlePatientSearch(e,n){try{if(!e||e.length<2)return vt(n),void 0;B(await Je(e),n)}catch(i){t.error("‚ùå Errore ricerca pazienti:",i)}}async resetFilters(){try{T();const e=await nt();ve(),le.reset(),this.state.currentPage=0,this.state.selectedPatientId=null,ut(),I(e),this.setupEventCardListenersCallback(),f(e.eventi.length,e.totalCount,le.get()),L(le.get()),await this.updateFilterStatsCallback()}catch(e){t.error("‚ùå Errore reset filtri:",e)}finally{P()}}async saveCurrentFilters(){try{await it()}catch(e){t.error("‚ùå Errore salvataggio filtri:",e)}}async loadSavedFilters(){try{const e=await at();return e&&(le.set(e),ue(e),t.log("‚úÖ Filtri caricati dallo stato:",e)),e}catch(e){return t.error("‚ùå Errore caricamento filtri salvati:",e),null}}createPatientSearchHandler(e,t){return Ie(async e=>{const n=e.target.value;n&&n.length>=2?await this.handlePatientSearch(n,"patient-search-results"):vt("patient-search-results"),t&&await t(n)},300)}createDebouncedFilterHandler(e,t=500){return Ie(e,t)}}class ht{constructor(e,t){this.state=e,this.domElements=t,this.eventFormModal=null,this.eventDetailModal=null}waitForModalHidden(e,t=500){return new Promise(n=>{if(!e)return n();const i=()=>{e.removeEventListener("hidden.bs.modal",a),clearTimeout(o),n()},a=()=>i();e.addEventListener("hidden.bs.modal",a,{once:!0});const o=setTimeout(()=>{i()},t)})}ensureSingleModalOpen(){try{const e=Array.from(document.querySelectorAll(".modal-backdrop"));e.length>1&&e.slice(0,-1).forEach(e=>e.parentNode&&e.parentNode.removeChild(e));document.querySelector(".modal.show")?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open")}catch(e){}}async initializeModals(){try{const{Modal:n}=await e(async()=>{const{Modal:e}=await import("./vendor-CQCqr9ER.js");return{Modal:e}},[]),i=this.domElements.eventFormModal,a=this.domElements.eventDetailModal;i&&(this.eventFormModal=new n(i,{backdrop:"static",keyboard:!1}),i.addEventListener("hide.bs.modal",()=>{this._defocus(i)})),a&&(this.eventDetailModal=new n(a),a.addEventListener("hide.bs.modal",()=>{this._defocus(a)})),t.log("‚úÖ Modali inizializzati")}catch(n){t.error("‚ùå Errore inizializzazione modali:",n)}}openEventModal(n=null){try{H(),V(),n?(this.state.editingEventId=n.id,q("Modifica Evento Clinico","edit"),N(n)):(this.state.editingEventId=null,q("Nuovo Evento Clinico","add")),setTimeout(()=>{const t=document.getElementById("evento-data");t&&t._flatpickrInstance?t._flatpickrInstance.redraw():e(async()=>{const{initCustomDatepickers:e}=await import("./CustomDatepicker-6By5cdaM.js");return{initCustomDatepickers:e}},__vite__mapDeps([0,1])).then(({initCustomDatepickers:e})=>{e("[data-datepicker]",{maxDate:"today",allowInput:!0,locale:{firstDayOfWeek:1}})})},100),this.eventFormModal&&this.eventFormModal.show()}catch(a){t.error("‚ùå Errore apertura modal evento:",a),i.error("Errore nell'apertura del form")}}async handleSaveEvent(e){try{const t=function(e){const t=e.eventDate?.value||"";let n=null;if(t&&""!==t.trim())try{n=u(t.trim())}catch(i){throw new Error(i.message||"Formato data non valido. Utilizzare il formato gg/mm/aaaa")}return{paziente_id:e.eventPatientId?.value||"",tipo_evento:e.eventType?.value||"",data_evento:n,descrizione:e.eventDescription?.value||"",tipo_intervento:e.interventionType?.value||"",agente_patogeno:e.infectionAgent?.value||""}}(this.domElements),a=function(e){const t=[];return e.paziente_id||t.push("Seleziona un paziente"),e.tipo_evento||t.push("Seleziona il tipo di evento"),e.data_evento||t.push("Inserisci la data dell'evento"),"intervento"!==e.tipo_evento||e.tipo_intervento||t.push("Specifica il tipo di intervento"),t.length>0?{isValid:!1,errors:t.join("<br>")}:{isValid:!0,errors:null}}(t);if(!a.isValid)return U(a.errors),void 0;let o;this.domElements.saveBtn&&(this.domElements.saveBtn.disabled=!0,this.domElements.saveBtn.innerHTML=n('<span class="spinner-border spinner-border-sm me-1"></span>Salvando...')),o=this.state.editingEventId?await Ue(this.state.editingEventId,t):await He(t),this.eventFormModal&&this.eventFormModal.hide(),e&&await e();i.success(`Evento clinico ${this.state.editingEventId?"aggiornato":"creato"} con successo`)}catch(a){t.error("‚ùå Errore salvataggio evento:",a),U(a.message||"Errore nel salvataggio dell'evento")}finally{this.domElements.saveBtn&&(this.domElements.saveBtn.disabled=!1,this.domElements.saveBtn.innerHTML=n('<span class="material-icons me-1" style="vertical-align: middle;">save</span>Salva Evento'))}}async showEventDetail(e){try{let t=await Ne({...this.state.filters},this.state.currentPage||0),n=t.eventi.find(t=>t.id===e);if(!n)for(let i=0;i<10&&(t=await Ne({},i),n=t.eventi.find(t=>t.id===e),!n);i++);if(!n)return i.error("Evento non trovato"),void 0;M(n),this.state.editingEventId=e,this.eventDetailModal&&this.eventDetailModal.show()}catch(n){t.error("‚ùå Errore visualizzazione dettagli evento:",n),i.error("Errore: "+n.message)}}async editEvent(e){try{let t=await Ne({...this.state.filters},this.state.currentPage||0),n=t.eventi.find(t=>t.id===e);if(!n)for(let i=0;i<10&&(t=await Ne({},i),n=t.eventi.find(t=>t.id===e),!n);i++);if(!n)return i.error("Evento non trovato"),void 0;const a=this.domElements&&this.domElements.eventDetailModal;this.eventDetailModal&&(this._defocus(a),this.eventDetailModal.hide(),await this.waitForModalHidden(a)),this.openEventModal(n),this.ensureSingleModalOpen()}catch(n){t.error("‚ùå Errore modifica evento:",n)}}handleEditEvent(){this.state.editingEventId&&this.editEvent(this.state.editingEventId)}async confirmDeleteEvent(t){const{ConfirmModal:n}=await e(async()=>{const{ConfirmModal:e}=await import("./ConfirmModal-De4MEDkl.js");return{ConfirmModal:e}},__vite__mapDeps([2,3,4,5,6])),i=n.forClinicalEventDeletion();await i.show()&&await this.deleteEvent(t)}async handleDeleteEvent(){this.state.editingEventId&&await this.confirmDeleteEvent(this.state.editingEventId)}async deleteEvent(e,n){try{if(await Ve(e),this.eventDetailModal){this._defocus(this.domElements&&this.domElements.eventDetailModal),this.eventDetailModal.hide()}n&&await n()}catch(i){t.error("‚ùå Errore eliminazione evento:",i)}}async handleModalPatientSearch(e){try{if(!e||e.length<2)return vt("evento-patient-search-results"),void 0;B(await We(e),"evento-patient-search-results")}catch(n){t.error("‚ùå Errore ricerca pazienti modal:",n)}}createModalPatientSearchHandler(){return Ie(e=>this.handleModalPatientSearch(e.target.value),300)}cleanup(){if(this.eventFormModal&&(this.eventFormModal.hide(),this.eventFormModal=null),this.eventDetailModal){this._defocus(this.domElements&&this.domElements.eventDetailModal),this.eventDetailModal.hide(),this.eventDetailModal=null}}}ht.prototype._defocus=function(e){try{const t=document.activeElement;e&&t&&e.contains(t)&&"function"==typeof t.blur&&t.blur()}catch{}};class Et{constructor(e,t){this.state=e,this.setupEventCardListenersCallback=t,this._cardListenersAttached=!1}async loadEventsData(){if(!this.state.isLoading)try{this.state.isLoading=!0;const{renderEventsResponsive:n,showLoading:i,updateSearchResultsCount:a,showActiveFiltersIndicator:r}=await e(async()=>{const{renderEventsResponsive:e,showLoading:t,updateSearchResultsCount:n,showActiveFiltersIndicator:i}=await Promise.resolve().then(()=>mt);return{renderEventsResponsive:e,showLoading:t,updateSearchResultsCount:n,showActiveFiltersIndicator:i}},void 0);i(),t.log("üìä Caricamento eventi con filtri:",le.get());const s=await Ne(le.get(),this.state.currentPage);return t.log("üîç Risultato fetchEventiClinici:",s),void 0!==s.totalPages&&(this.state.totalPages=s.totalPages),t.log("üî• PRIMA DI CHIAMARE renderEventsResponsive"),n(s),t.log("üî• DOPO CHIAMATA renderEventsResponsive"),t.log("üé® renderEventsResponsive completato"),this.setupEventCardListeners(),setTimeout(async()=>{try{const{forceUpdateMobilePagination:t}=await e(async()=>{const{forceUpdateMobilePagination:e}=await Promise.resolve().then(()=>Re);return{forceUpdateMobilePagination:e}},void 0);t(s)}catch(n){t.warn("‚ö†Ô∏è Errore nel forzare aggiornamento badge mobile:",n)}},o.MOBILE_PAGINATION_UPDATE_DELAY),a(s.eventi.length,s.totalCount,le.get()),r(le.get()),this.updateFilterStats().catch(e=>t.error("‚ùå Errore aggiornamento statistiche filtri (async):",e)),t.log("‚úÖ Eventi caricati:",s.eventi.length),s}catch(n){t.error("‚ùå Errore caricamento eventi:",n);const{showError:i}=await e(async()=>{const{showError:e}=await Promise.resolve().then(()=>mt);return{showError:e}},void 0);throw i("Errore nel caricamento degli eventi clinici"),n}finally{this.state.isLoading=!1}}setupEventCardListeners(){this._cardListenersAttached||this.setupEventCardListenersCallback&&(this.setupEventCardListenersCallback(),this._cardListenersAttached=!0)}async changePage(e){if(e<0||e>=this.state.totalPages||this.state.isLoading)return t.warn(`‚ö†Ô∏è Tentativo di andare a pagina invalida: ${e} (totale: ${this.state.totalPages})`),void 0;this.state.currentPage=e,await this.loadEventsData()}async exportEvents(n="csv"){try{const{showExportProgress:t}=await e(async()=>{const{showExportProgress:e}=await Promise.resolve().then(()=>mt);return{showExportProgress:e}},void 0);t(!0),await ot(n)}catch(i){t.error("‚ùå Errore export eventi catturato nel DataManager:",i)}finally{const{showExportProgress:t}=await e(async()=>{const{showExportProgress:e}=await Promise.resolve().then(()=>mt);return{showExportProgress:e}},void 0);t(!1)}}async updateFilterStats(){try{const t=await rt();this.state.filterStats=t;const{showFilterStats:n}=await e(async()=>{const{showFilterStats:e}=await Promise.resolve().then(()=>mt);return{showFilterStats:e}},void 0);n(t)}catch(n){t.error("‚ùå Errore aggiornamento statistiche filtri:",n)}}clearCache(){ct()}onShowEventDetail(e){}onEditEvent(e){}onDeleteEvent(e){}}t.log("üî• EVENTI-CLINICI.JS CARICATO - SCRIPT INIZIATO");let ft={currentPage:0,totalPages:1,filters:{paziente_search:"",tipo_evento:"",data_da:"",data_a:"",reparto:"",stato:"",sortColumn:"",sortDirection:"desc"},selectedPatientId:null,editingEventId:null,isLoading:!1,filterStats:null},yt={},bt=null,zt=null,_t=null,wt=null,It=null,Ct=null;async function Ft(n){try{t.log("üöÄ Inizializzazione vista eventi clinici"),t.log("üìù Step 1: Inizializzazione DOM elements"),await async function(e=5,n=100){for(let a=0;a<e;a++)try{const i=["eventi-timeline-container","eventi-add-btn","eventi-reset-filters-btn"].filter(e=>!document.getElementById(e));if(0===i.length)return t.log(`‚úÖ Tutti gli elementi DOM critici trovati al tentativo ${a+1}`),Te(),void 0;t.log(`‚ö†Ô∏è Tentativo ${a+1}: elementi DOM mancanti:`,i),a<e-1&&await new Promise(e=>setTimeout(e,n))}catch(i){t.error(`‚ùå Errore tentativo ${a+1} inizializzazione DOM:`,i),a<e-1&&await new Promise(e=>setTimeout(e,n))}throw t.error("‚ùå Impossibile trovare tutti gli elementi DOM critici dopo",e,"tentativi"),new Error("Template DOM non completamente caricato")}(),yt=Pe(),t.log("‚úÖ DOM elements inizializzati"),t.log("üìù Step 2: Inizializzazione managers"),await async function(){try{const n=()=>{It||(It=async n=>{const i=n.target.closest&&n.target.closest(".event-detail-btn"),a=n.target.closest&&n.target.closest(".event-edit-btn"),o=n.target.closest&&n.target.closest(".event-delete-btn"),r=n.target.closest&&n.target.closest(".event-resolve-btn");if(!(i||a||o||r))return;n.stopPropagation();const s=i||a||o||r,l=s&&s.dataset&&s.dataset.eventoId;if(l)try{const t=document.getElementById("eventi-azioni-modal");if(t)try{const{Modal:n}=await e(async()=>{const{Modal:e}=await import("./vendor-CQCqr9ER.js");return{Modal:e}},[]);(n.getInstance(t)||n.getOrCreateInstance(t)).hide(),await new Promise(e=>{let n=!1;const i=setTimeout(()=>{n||(n=!0,e())},250);t.addEventListener("hidden.bs.modal",()=>{n||(n=!0,clearTimeout(i),e())},{once:!0})})}catch{t.classList.remove("show"),t.style.display="none",document.querySelectorAll(".modal-backdrop").forEach(e=>e.parentNode&&e.parentNode.removeChild(e)),document.body.classList.remove("modal-open")}if(i)return _t.showEventDetail(l),void 0;if(a)return _t.editEvent(l),void 0;if(o)return _t.confirmDeleteEvent(l),void 0;if(r){const{ResolveInfectionModal:t}=await e(async()=>{const{ResolveInfectionModal:e}=await import("./ResolveInfectionModal-DZaI0uGW.js");return{ResolveInfectionModal:e}},__vite__mapDeps([7,3,4,5,6,0,1])),n=new t({eventoId:l}),i=await n.show();return i&&(await qe(l,i),await bt.loadEventsData()),void 0}}catch(c){t.error("Errore gestione azione evento:",c)}},document.addEventListener("click",It),Ct=()=>{try{document.removeEventListener("click",It)}catch(e){t.warn("Listener di delega non rimosso (forse gi√† rimosso)",e)}It=null,Ct=null})};bt=new Et(ft,n),zt=new gt(ft,n,()=>bt.updateFilterStats()),_t=new ht(ft,yt),await _t.initializeModals(),wt=new pt(ft,yt,zt,_t,bt),t.log("‚úÖ Manager inizializzati")}catch(n){t.error("‚ùå Errore inizializzazione manager:",n)}}(),t.log("‚úÖ Managers inizializzati"),t.log("ÔøΩ Stepi 3: Inizializzazione form components"),function(){try{g(),p("[data-datepicker]"),t.log("‚úÖ Componenti form inizializzati")}catch(e){t.error("‚ùå Errore inizializzazione componenti form:",e)}}(),t.log("‚úÖ Form components inizializzati"),t.log("üìù Step 4: Setup event handlers"),await async function(){try{await wt.setupEventListeners(),wt.initializeAdvancedFiltersState(),t.log("‚úÖ Event handlers configurati")}catch(e){t.error("‚ùå Errore setup event handlers:",e)}}(),t.log("‚úÖ Event handlers configurati"),t.log("üìù Step 5: Caricamento filtri suggeriti"),await async function(){try{await new Promise(e=>setTimeout(e,100));const[e,n]=await Promise.all([lt(),st()]);t.log("üîß Popolamento filtri con:",{reparti:n.length,tipiIntervento:e.tipiIntervento?.length||0,agentiPatogeni:e.agentiPatogeni?.length||0}),await ge(n),await he(e),setTimeout(()=>{document.querySelectorAll('select[data-custom="true"]').forEach(e=>{t.log("üîß Checking CustomSelect:",e.id,"has instance?",!!e._customSelect);const n=e.customSelectInstance||e._customSelect;n&&("function"==typeof n.updateOptions?(t.log("üîß Updating CustomSelect options:",e.id),n.updateOptions()):"function"==typeof n.refresh&&(t.log("üîß Refreshing CustomSelect:",e.id),n.refresh()))})},50),setTimeout(()=>{const e=document.getElementById("eventi-filter-reparto");if(e){const n=e.customSelectInstance||e._customSelect;n&&(t.log("üîß Final update/refresh of reparto CustomSelect"),"function"==typeof n.updateOptions?n.updateOptions():"function"==typeof n.refresh&&n.refresh())}},500),t.log("‚úÖ Suggerimenti filtri caricati:",{suggestions:e,reparti:n.length})}catch(e){t.error("‚ùå Errore caricamento suggerimenti filtri:",e)}}(),t.log("‚úÖ Filtri suggeriti caricati"),t.log("üìù Step 6: Reset filtri"),tt(),ve(),t.log("‚úÖ Filtri resettati"),t.log("üìù Step 7: Caricamento dati iniziali");try{t.log("üß™ Test caricamento diretto...");const{fetchEventiClinici:n}=await e(async()=>{const{fetchEventiClinici:e}=await Promise.resolve().then(()=>dt);return{fetchEventiClinici:e}},void 0),i=await n({},0);t.log("üß™ Test result:",i);const a=await bt.loadEventsData();t.log("‚úÖ Dati iniziali caricati:",a)}catch(i){throw t.error("‚ùå ERRORE caricamento dati iniziali:",i),i}return t.log("üìù Step 8: Applicazione responsive design"),Me(),t.log("‚úÖ Responsive design applicato"),t.log("üìù Step 9: Gestione parametri URL"),function(e){if(!e)return;const t=e.get("patient");t&&(ft.selectedPatientId=t,ft.filters.paziente_search=t);const n=e.get("type");n&&yt.filterType&&(yt.filterType.value=n,ft.filters.tipo_evento=n)}(n),t.log("‚úÖ Parametri URL gestiti"),t.log("‚úÖ Vista eventi clinici inizializzata con successo"),St}catch(i){t.error("üí• ERRORE CRITICO inizializzazione vista eventi clinici:",i);try{D("Errore nel caricamento della vista eventi clinici. Ricaricare la pagina.")}catch(a){t.error("‚ùå Impossibile mostrare errore UI:",a),alert("Errore critico nel caricamento. Ricaricare la pagina.")}throw i}}function St(){if(t.log("üßπ Cleanup vista eventi clinici"),wt&&"function"==typeof wt.cleanup&&wt.cleanup(),_t&&"function"==typeof _t.cleanup&&_t.cleanup(),bt&&"function"==typeof bt.clearCache&&bt.clearCache(),Ct)try{Ct()}catch(e){t.warn("‚ö†Ô∏è Errore durante la rimozione del listener di delega:",e)}try{Be()}catch(e){t.warn("‚ö†Ô∏è Errore durante resetUIState:",e)}ft={currentPage:0,totalPages:1,filters:{paziente_search:"",tipo_evento:"",data_da:"",data_a:"",reparto:"",stato:"",agente_patogeno:"",sortColumn:"data_evento",sortDirection:"desc"},selectedPatientId:null,editingEventId:null,isLoading:!1,filterStats:null},bt=null,zt=null,_t=null,wt=null,It=null,Ct=null,yt={},t.log("‚úÖ Cleanup completato")}export{Ft as initEventiCliniciView};
