import{j as e}from"./ui-vendor-S6RcKJ66.js";import{b as t,i as a,R as n}from"./react-vendor-Bp2pLdQf.js";import{p as i,r,e as o}from"./patientService-CbPemdK6.js";import"./CustomSelect-Bsz_N9QM.js";import{D as s}from"./DateRangePicker-Ec6QCNEH.js";import{l}from"./index-DHH13C1o.js";import{b as c,n as d}from"./notificationErrorHandler-DwlcFAqH.js";import"./PatientListPage-CaKW1AX2.js";import{u as p,a as u,b as m}from"./wizard-DwN_BpxF.js";import{u as v}from"./useQuery-CUnc1OL_.js";const h=new class{cache=new Map;timeout=3e5;get(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<this.timeout?t.data:(t&&this.cache.delete(e),null)}set(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}clear(){this.cache.clear()}cleanup(){const e=Date.now();for(const[t,a]of this.cache.entries())e-a.timestamp>this.timeout&&this.cache.delete(t)}},g={activeOnly:!1,maxResults:10,minSearchLength:2,debounceDelay:300,enableCache:!0,cacheKey:"patient-search",enableDeduplication:!0};const x=({value:n,onChange:o,placeholder:s="Cerca paziente...",className:c="",disabled:d=!1,required:p=!1,activeOnly:u=!1,maxResults:m=10,minSearchLength:v=2,debounceDelay:x=300,showPatientInfo:b=!0,highlightMatch:f=!0})=>{const _=t.useId(),j=`patient-autocomplete-${_}`,N=`patient-autocomplete-list-${_}`,w=t.useRef(null),z=t.useRef(null),S=t.useRef(null),[y,E]=t.useState(!1),[C,D]=t.useState(-1),[k,P]=t.useState(""),[I,R]=t.useState({top:0,left:0,width:0}),{searchTerm:T,setSearchTerm:$,results:A,loading:L,error:O,clearSearch:F}=function(e={}){const a={...g,...e},{activeOnly:n,maxResults:o,minSearchLength:s,debounceDelay:c,enableCache:d,cacheKey:p,enableDeduplication:u}=a,[m,v]=t.useState(""),[x,b]=t.useState([]),[f,_]=t.useState(!1),[j,N]=t.useState(null),[w,z]=t.useState({hits:0,misses:0}),S=t.useRef(),y=t.useRef(null),E=t.useRef(""),C=t.useCallback(async e=>{if(e===E.current)return;E.current=e,y.current&&y.current.abort(),y.current=new AbortController;const{signal:t}=y.current;if(!e||e.trim().length<s)return b([]),N(null),_(!1),void 0;const a=e.trim();_(!0),N(null);try{let e;if(d){const e=h.get(`${p}:${a}:${n}:${o}`);if(e)return l.log("[usePatientAutocomplete] Cache hit for:",a),b(e),z(e=>({...e,hits:e.hits+1})),_(!1),void 0;z(e=>({...e,misses:e.misses+1}))}const s=async()=>i.searchPatients(a,n,o);u?(l.log("[usePatientAutocomplete] Using deduplication for search:",{deduplicationKey:`patient-search:${a}:${n}:${o}`}),e=await r.executeRequest(`patient-search:${a}:${n}:${o}`,s,{signal:t})):(l.log("[usePatientAutocomplete] Direct search without deduplication"),e=await s()),t.aborted||(l.group("[usePatientAutocomplete] Search results DEBUG"),l.log("Risultati ricevuti:",{term:a,resultsCount:e.length,fromCache:!1,activeOnly:n,maxResults:o,enableDeduplication:u,sampleResults:e.slice(0,3).map(e=>({id:e.id,nome:e.nome,cognome:e.cognome,codice_rad:e.codice_rad}))}),d&&e.length>0&&(h.set(`${p}:${a}:${n}:${o}`,e),l.log("Results cached")),b(e),0===e.length&&N(`Nessun paziente trovato per "${a}"`))}catch(c){if(!t.aborted){const e=c instanceof Error?c.message:"Errore durante la ricerca";N(e),b([]),l.error("[usePatientAutocomplete] Search error:",c)}}finally{t.aborted||_(!1)}},[n,o,s,d,p,u]),D=t.useCallback(e=>{v(e),S.current&&clearTimeout(S.current),S.current=window.setTimeout(()=>{C(e)},c)},[C,c]),k=t.useCallback(()=>{v(""),b([]),N(null),E.current="",S.current&&clearTimeout(S.current),y.current&&y.current.abort()},[]),P=t.useCallback(()=>{m&&C(m)},[m,C]);return t.useEffect(()=>()=>{S.current&&clearTimeout(S.current),y.current&&y.current.abort()},[]),t.useEffect(()=>{d&&h.clear()},[n,o,d,p]),{searchTerm:m,setSearchTerm:D,results:x,loading:f,error:j,clearSearch:k,refetch:P,cacheStats:w}}({activeOnly:u,maxResults:m,minSearchLength:v,debounceDelay:x,enableCache:!0,cacheKey:"patient-autocomplete",enableDeduplication:!0});t.useEffect(()=>{if(n){P(`${n.cognome} ${n.nome}`)}else P("")},[n]),t.useEffect(()=>{const e=e=>{const t=e.target,a=w.current&&w.current.contains(t),n=S.current&&S.current.contains(t);a||n||(E(!1),D(-1))};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),t.useEffect(()=>{if(y&&z.current){const e=z.current.getBoundingClientRect();R({top:e.top+e.height,left:e.left,width:e.width})}},[y]);const M=t.useMemo(()=>A.slice(0,m),[A,m]),q=t.useCallback((t,a)=>{if(!f||!a.trim())return t;const n=new RegExp(`(${a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return t.split(n).map((t,a)=>n.test(t)?e.jsx("mark",{className:"bg-warning text-dark",children:t},a):t)},[f]),K=t.useCallback(e=>{const t=e.target.value;P(t),(t.toLowerCase().includes("olak")||t.toLowerCase().includes("kozak"))&&(l.group("[PatientAutocomplete] DEBUG SEARCH FOR OLAK/KOZAK"),l.log("Input value:",t),l.log("Min search length:",v),l.log("Will trigger search:",t.trim().length>=v),l.groupEnd()),$(t),t.trim().length>=v?(E(!0),D(-1)):(E(!1),D(-1)),t.trim()||o(null)},[$,v,o]),B=t.useCallback(e=>{o(e),E(!1),D(-1),l.log("[PatientAutocomplete] Patient selected:",{id:e.id,name:`${e.cognome} ${e.nome}`})},[o]),H=t.useCallback(e=>{if(!y||0===M.length)return"ArrowDown"===e.key&&T.trim().length>=v&&(E(!0),D(0)),void 0;switch(e.key){case"ArrowDown":e.preventDefault(),D(e=>e<M.length-1?e+1:0);break;case"ArrowUp":e.preventDefault(),D(e=>e>0?e-1:M.length-1);break;case"Enter":e.preventDefault(),C>=0&&M[C]&&B(M[C]);break;case"Escape":e.preventDefault(),E(!1),D(-1),z.current?.blur()}},[y,M,C,T,v,B]),U=t.useCallback(()=>{T.trim().length>=v&&M.length>0&&E(!0)},[T,v,M.length]),X=t.useCallback(()=>{P(""),$(""),E(!1),D(-1),o(null),F()},[$,o,F]),V=t.useCallback(e=>q(`${e.cognome} ${e.nome}`,T),[T,q]),W=t.useCallback(e=>{const t=[];if(e.codice_rad&&t.push(`RAD: ${e.codice_rad}`),e.reparto_appartenenza&&t.push(e.reparto_appartenenza),e.data_ricovero){const a=new Date(e.data_ricovero);t.push(`Ric: ${a.toLocaleDateString("it-IT")}`)}return t.join(" • ")},[]);return t.useEffect(()=>{if(C>=0&&S.current){const e=S.current.children[C];e&&e.scrollIntoView({block:"nearest"})}},[C]),t.useEffect(()=>{if(!y||!S.current)return;const e=e=>{e.stopPropagation(),e.preventDefault();const t=e.currentTarget,a=S.current?.querySelectorAll('li[role="option"]');if(a){const e=Array.from(a).indexOf(t);e>=0&&M[e]&&B(M[e])}};let t=0;const a=()=>{if(!S.current)return;const n=S.current.querySelectorAll('li[role="option"]');n.length>0?n.forEach(t=>{t.addEventListener("click",e,!1)}):t<10&&(t++,setTimeout(a,50))};return a(),()=>{if(S.current){S.current.querySelectorAll('li[role="option"]').forEach(t=>{t.removeEventListener("click",e,!1)})}}},[y,M,B]),e.jsxs("div",{className:`patient-autocomplete position-relative ${c}`,ref:w,children:[e.jsxs("div",{className:"input-group",children:[e.jsx("input",{ref:z,id:j,type:"text",className:"form-control "+(d?"bg-light":""),placeholder:s,value:k,onChange:K,onKeyDown:H,onFocus:U,disabled:d,required:p,role:"combobox","aria-controls":N,"aria-expanded":y,"aria-autocomplete":"list","aria-busy":L,"aria-describedby":O?`${j}-error`:void 0}),k&&!d&&e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:X,"aria-label":"Cancella ricerca",children:e.jsx("i",{className:"bi bi-x-lg"})}),L&&e.jsx("span",{className:"input-group-text",children:e.jsx("span",{className:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"})})]}),O&&e.jsx("div",{id:`${j}-error`,className:"form-text text-danger mt-1",children:O}),y&&a.createPortal(e.jsxs("ul",{ref:S,id:N,className:"list-group shadow-sm",style:{position:"fixed",top:`${I.top}px`,left:`${I.left}px`,width:`${I.width}px`,maxHeight:"300px",overflowY:"auto",zIndex:9999,backgroundColor:"white",borderRadius:"0.25rem",border:"1px solid #dee2e6"},role:"listbox",children:[L&&e.jsxs("li",{className:"list-group-item text-muted",role:"presentation",children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Ricerca in corso..."]}),!L&&0===M.length&&T.trim().length>=v&&e.jsxs("li",{className:"list-group-item text-muted text-center py-3",role:"presentation",children:[e.jsx("i",{className:"bi bi-person-x fs-4 d-block mb-2"}),'Nessun paziente trovato per "',e.jsx("strong",{children:T}),'"']}),!L&&M.map((t,a)=>e.jsx("li",{role:"option",className:`list-group-item list-group-item-action cursor-pointer ${a===C?"active":""} ${n?.id===t.id?"border-primary":""}`,onMouseEnter:()=>D(a),"aria-selected":a===C,"data-patient-index":a,children:e.jsx("div",{className:"d-flex justify-content-between align-items-start",children:e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"fw-semibold",children:[V(t),n?.id===t.id&&e.jsx("i",{className:"bi bi-check-circle-fill text-primary ms-2","aria-label":"Selezionato"})]}),b&&e.jsx("div",{className:"small text-muted mt-1",children:W(t)}),t.diagnosi&&e.jsxs("div",{className:"small text-muted mt-1",children:[e.jsx("i",{className:"bi bi-clipboard2-pulse me-1"}),t.diagnosi]})]})})},t.id))]}),document.body)]})},b=["event-type","event-details","dates","notes","review"],f=({currentStep:t,getStepLabel:a,getStepNumber:n,totalSteps:i,selectedPatient:r})=>{const o=n(t),s=a(t);return e.jsxs("div",{className:"event-wizard-stepper",children:[e.jsx("div",{className:"event-wizard-stepper-progress",children:e.jsx("div",{className:"event-wizard-stepper-progress-bar",children:e.jsx("div",{className:"event-wizard-stepper-progress-fill",style:{width:`${o/i*100}%`},role:"progressbar","aria-valuenow":o,"aria-valuemin":1,"aria-valuemax":i,"aria-label":`Progresso: ${o} di ${i}`})})}),e.jsxs("div",{className:"event-wizard-stepper-info",children:[e.jsx("span",{className:"event-wizard-stepper-label",children:s}),e.jsxs("span",{className:"event-wizard-stepper-counter",children:[o," di ",i]}),r&&o>1&&e.jsxs("div",{className:"event-wizard-stepper-patient",children:[e.jsx("small",{className:"text-muted",children:"Paziente:"}),e.jsxs("strong",{children:[r.cognome," ",r.nome]})]})]}),e.jsx("div",{className:"event-wizard-stepper-dots d-md-none",children:b.map((n,i)=>{const r=i+1,s=a(n);return e.jsx("div",{className:`event-wizard-stepper-dot ${n===t?"active":""} ${i<o-1?"completed":""}`,"aria-label":`Step ${r}: ${s}`},n)})})]})},_=[{value:"batterico",label:"Batterico"},{value:"virale",label:"Virale"},{value:"fungino",label:"Fungino"},{value:"parassitario",label:"Parassitario"}],j={TEXTAREA_ROWS:{DESCRIPTION:4,NOTES:6},BREAKPOINTS:{MOBILE_MAX:991},DEBOUNCE:{PATIENT_SEARCH:300}},N={PLACEHOLDER:"Cerca per nome, cognome o RAD...",HELP_TEXT:"Seleziona un paziente per continuare",SELECTED:(e,t)=>`Paziente selezionato: ${e} ${t}`},w=({values:t,onChange:a,hasPatient:n=!0,selectedPatient:i=null,onSelectPatient:r,onPatientSelect:o})=>e.jsx("div",{className:"wizard-step","data-step":"event-type",children:e.jsxs("div",{className:"wizard-step-content",children:[!n&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"wizard-step-title",children:"Seleziona Paziente"}),e.jsxs("div",{className:"mb-4",children:[e.jsx(x,{value:i,onChange:e=>{r&&r(e?.id||""),o&&o(e)},placeholder:N.PLACEHOLDER,activeOnly:!1,maxResults:10,minSearchLength:1,debounceDelay:j.DEBOUNCE.PATIENT_SEARCH,showPatientInfo:!0,highlightMatch:!0}),i&&e.jsxs("div",{className:"alert alert-success mt-3",role:"alert",children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),N.SELECTED(i.cognome,i.nome)]}),!i&&e.jsxs("div",{className:"alert alert-info mt-3",role:"alert",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),N.HELP_TEXT]})]}),!i&&e.jsx("div",{style:{marginBottom:"2rem"}})]}),(n||i)&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"wizard-step-title",children:"Tipo di Evento"}),e.jsx("p",{className:"wizard-step-description",children:"Seleziona il tipo di evento clinico da registrare"}),e.jsx("div",{className:"event-type-selection",children:e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"event-type-card "+("intervento"===t.tipo_evento?"selected":""),onClick:()=>a({tipo_evento:"intervento"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),a({tipo_evento:"intervento"}))},children:[e.jsx("div",{className:"event-type-card-icon",children:e.jsx("i",{className:"bi bi-heart-pulse"})}),e.jsxs("div",{className:"event-type-card-content",children:[e.jsx("h4",{className:"event-type-card-title",children:"Intervento Chirurgico"}),e.jsx("p",{className:"event-type-card-description",children:"Registra un intervento chirurgico eseguito sul paziente"})]}),e.jsx("div",{className:"event-type-card-radio",children:e.jsx("input",{type:"radio",name:"tipo_evento",value:"intervento",checked:"intervento"===t.tipo_evento,onChange:()=>a({tipo_evento:"intervento"}),className:"form-check-input"})})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"event-type-card "+("infezione"===t.tipo_evento?"selected":""),onClick:()=>a({tipo_evento:"infezione"}),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),a({tipo_evento:"infezione"}))},children:[e.jsx("div",{className:"event-type-card-icon",children:e.jsx("i",{className:"bi bi-virus"})}),e.jsxs("div",{className:"event-type-card-content",children:[e.jsx("h4",{className:"event-type-card-title",children:"Infezione"}),e.jsx("p",{className:"event-type-card-description",children:"Registra un'infezione contratta dal paziente"})]}),e.jsx("div",{className:"event-type-card-radio",children:e.jsx("input",{type:"radio",name:"tipo_evento",value:"infezione",checked:"infezione"===t.tipo_evento,onChange:()=>a({tipo_evento:"infezione"}),className:"form-check-input"})})]})})]})})]})]})}),z=({values:t,onChange:a,errors:n,isSubmitting:i,tipiIntervento:r,agentiPatogeno:o,loadingTypes:s,loadingPatogens:l})=>{const c="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"event-details",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:c?"Dettagli Intervento":"Dettagli Infezione"}),e.jsx("p",{className:"wizard-step-description",children:c?"Specifica il tipo di intervento e la descrizione":"Specifica l'agente patogeno e il tipo"}),e.jsxs(e.Fragment,c?{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"tipo_intervento_id",className:"form-label",children:["Tipo Intervento ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("select",{id:"tipo_intervento_id",name:"tipo_intervento_id",className:"form-select "+(n?.tipo_intervento_id?"is-invalid":""),value:t.tipo_intervento_id?String(t.tipo_intervento_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):void 0;a({tipo_intervento_id:t})},disabled:i||s,required:!0,children:[e.jsx("option",{value:"",children:s?"Caricamento tipi intervento...":"Seleziona tipo intervento..."}),r.map(t=>e.jsx("option",{value:String(t.id),children:t.nome},t.id))]}),n?.tipo_intervento_id&&e.jsx("div",{className:"invalid-feedback",role:"alert",children:n.tipo_intervento_id})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"descrizione_intervento",className:"form-label",children:"Descrizione Dettagliata"}),e.jsx("textarea",{id:"descrizione_intervento",name:"descrizione_intervento",className:"form-control",value:t.descrizione_intervento||"",onChange:e=>a({descrizione_intervento:e.target.value}),disabled:i,rows:j.TEXTAREA_ROWS.DESCRIPTION,placeholder:"Descrivere dettagliatamente l'intervento eseguito..."}),e.jsx("div",{className:"form-text",children:"Opzionale - Fornire una descrizione dettagliata della procedura"})]})]}:{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"agente_patogeno_id",className:"form-label",children:["Agente Eziologico ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("select",{id:"agente_patogeno_id",name:"agente_patogeno_id",className:"form-select "+(n?.agente_patogeno_id?"is-invalid":""),value:t.agente_patogeno_id?String(t.agente_patogeno_id):"",onChange:e=>{const t=e.target.value?parseInt(e.target.value,10):void 0;a({agente_patogeno_id:t})},disabled:i||l,required:!0,children:[e.jsx("option",{value:"",children:l?"Caricamento agenti patogeno...":"Seleziona agente eziologico..."}),o.map(t=>e.jsx("option",{value:String(t.id),children:t.nome},t.id))]}),n?.agente_patogeno_id&&e.jsx("div",{className:"invalid-feedback",role:"alert",children:n.agente_patogeno_id}),e.jsx("div",{className:"form-text",children:"Selezionare l'agente responsabile dell'infezione"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"tipo_patogeno",className:"form-label",children:"Tipo Patogeno"}),e.jsxs("select",{id:"tipo_patogeno",name:"tipo_patogeno",className:"form-select",value:t.tipo_patogeno||"",onChange:e=>a({tipo_patogeno:e.target.value}),disabled:i,children:[e.jsx("option",{value:"",children:"Seleziona tipo patogeno..."}),_.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]}),e.jsx("div",{className:"form-text",children:"Opzionale - Specificare la categoria del patogeno"})]})]})]})})},S=({values:t,onChange:a,errors:n,isSubmitting:i,showResolutionDate:r,setShowResolutionDate:o})=>{const l="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"dates",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Date Evento"}),e.jsx("p",{className:"wizard-step-description",children:l?"Specifica quando è stato eseguito l'intervento":"Specifica le date di inizio e fine dell'infezione"}),l?e.jsx("div",{className:"mb-3",children:e.jsx(s,{label:"Data Intervento",value:t.data_evento||"",onChange:e=>a({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:i,isInvalid:!!n?.data_evento,errorMessage:n?.data_evento})}):e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-12 mb-3",children:e.jsx(s,{label:"Data Inizio",value:t.data_evento||"",onChange:e=>a({data_evento:e||""}),isRequired:!0,placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:i,isInvalid:!!n?.data_evento,errorMessage:n?.data_evento})}),e.jsxs("div",{className:"col-12 mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2 gap-2",children:[e.jsx("label",{htmlFor:"toggle_resolution",className:"form-label mb-0",children:"Data Fine"}),e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"toggle_resolution",checked:r,onChange:e=>{o(e.target.checked),e.target.checked||a({data_fine_evento:""})},disabled:i}),e.jsx("label",{className:"form-check-label",htmlFor:"toggle_resolution",children:"Infezione risolta"})]})]}),r&&e.jsx(s,{value:t.data_fine_evento||"",onChange:e=>a({data_fine_evento:e||""}),placeholder:"gg/mm/aaaa",allowInput:!0,clearable:!0,isDisabled:i,isInvalid:!!n?.data_fine_evento,errorMessage:n?.data_fine_evento})]})]})]})})},y=({values:t,onChange:a,isSubmitting:n})=>{const i="intervento"===t.tipo_evento;return e.jsx("div",{className:"wizard-step","data-step":"notes",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Note Aggiuntive"}),e.jsx("p",{className:"wizard-step-description",children:"Aggiungi informazioni o osservazioni rilevanti (opzionale)"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"note",className:"form-label",children:i?"Note Aggiuntive":"Note Cliniche"}),e.jsx("textarea",{id:"note",name:"note",className:"form-control",value:t.note||"",onChange:e=>a({note:e.target.value}),disabled:n,rows:j.TEXTAREA_ROWS.NOTES,placeholder:i?"Note aggiuntive sull'intervento...":"Sintomi, terapia, esami, decorso...","aria-describedby":"note-help"}),e.jsxs("div",{id:"note-help",className:"form-text",children:["Opzionale - ",i?"Informazioni aggiuntive sull'intervento":"Informazioni cliniche rilevanti"]})]})]})})},E=({values:a,tipiIntervento:n,agentiPatogeno:i})=>{const r="intervento"===a.tipo_evento,o=t.useMemo(()=>n.find(e=>e.id===a.tipo_intervento_id)?.nome,[n,a.tipo_intervento_id]),s=t.useMemo(()=>i.find(e=>e.id===a.agente_patogeno_id)?.nome,[i,a.agente_patogeno_id]);return e.jsx("div",{className:"wizard-step","data-step":"review",children:e.jsxs("div",{className:"wizard-step-content",children:[e.jsx("h3",{className:"wizard-step-title",children:"Riepilogo"}),e.jsx("p",{className:"wizard-step-description",children:"Verifica i dati inseriti prima di salvare"}),e.jsxs("div",{className:"event-review-summary",children:[e.jsxs("div",{className:"alert alert-light",children:[e.jsx("h5",{className:"alert-heading",children:r?"Intervento Chirurgico":"Infezione"}),e.jsx("hr",{}),e.jsxs(e.Fragment,r?{children:[e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Tipo Intervento:"})," ",e.jsx("span",{children:o||"Non specificato"})]}),a.descrizione_intervento&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Descrizione:"})," ",e.jsx("span",{children:a.descrizione_intervento})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Intervento:"})," ",e.jsx("span",{children:a.data_evento||"Non specificata"})]})]}:{children:[e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Agente Eziologico:"})," ",e.jsx("span",{children:s||"Non specificato"})]}),a.tipo_patogeno&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Tipo Patogeno:"})," ",e.jsx("span",{children:_.find(e=>e.value===a.tipo_patogeno)?.label})]}),e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Inizio:"})," ",e.jsx("span",{children:a.data_evento||"Non specificata"})]}),a.data_fine_evento&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Data Fine:"})," ",e.jsx("span",{children:a.data_fine_evento})]})]}),a.note&&e.jsxs("div",{className:"review-item",children:[e.jsx("strong",{children:"Note:"})," ",e.jsx("span",{children:a.note})]})]}),e.jsxs("div",{className:"alert alert-info",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),"Verifica che tutti i dati siano corretti. Puoi tornare indietro per modificare qualsiasi campo prima di salvare."]})]})]})})},C=["event-type","event-details","dates","notes","review"],D={"event-type":"Tipo Evento","event-details":"Dettagli",dates:"Date",notes:"Note",review:"Riepilogo"},k=()=>{const e=new Date;return e.setHours(0,0,0,0),e},P="La data dell'intervento non può essere futura",I="La data di inizio infezione non può essere futura",R="La data di fine infezione non può essere futura",T="La data di fine non può essere precedente alla data di inizio",$=(e,t,a="intervento")=>{if(!e)return null;if(("string"==typeof(n=e)?new Date(n):n)>k())return"intervento"===a?P:I;var n;if(t){if(((e,t)=>{const a="string"==typeof e?new Date(e):e;return("string"==typeof t?new Date(t):t)<a})(e,t))return T;if((e=>("string"==typeof e?new Date(e):e)>k())(t))return R}return null},A=({patientId:a,event:r,onSubmit:s,onCancel:h})=>{const g=!!r,x=((e="event-type")=>p({steps:C,labels:D,initialStep:e}))("event-type"),b=u({currentStep:x.currentStep,getStepLabel:x.getStepLabel,totalSteps:x.totalSteps,currentStepNumber:x.getStepNumber(x.currentStep),enabled:!1});m();const{patient:_}=(e=>{const{data:t,isLoading:a,error:n}=v({queryKey:["patient",e],queryFn:async()=>{if(!e)return null;try{const t=await i.getPatientById(e);if(t){const a={id:t.id,nome:t.nome,cognome:t.cognome};return l.info("Patient loaded successfully",{patientId:e}),a}return l.warn("Patient not found",{patientId:e}),c("Paziente non trovato",{duration:3e3}),null}catch(t){const a=t instanceof Error?t:new Error(String(t));throw l.error("Error loading patient data",{patientId:e,error:a}),d("Errore nel caricamento del paziente",{duration:5e3}),a}},enabled:!!e,staleTime:3e5});return{patient:t||null,loading:a,error:n instanceof Error?n:null}})(a),{tipiIntervento:j,agentiPatogeno:N,loading:k}=(()=>{const{data:e,isLoading:a,error:n}=v({queryKey:["eventLookupTables"],queryFn:async()=>{try{const[e,t]=await Promise.all([o.getListaTipiIntervento(),o.getListaAgentiPatogeno()]);return l.info("Event lookup tables loaded successfully",{tipiCount:e.length,agentiCount:t.length}),{tipi:e,agenti:t}}catch(e){const t=e instanceof Error?e:new Error(String(e));throw l.error("Error loading event lookup tables",{error:t}),d("Impossibile caricare i dati. Riprova più tardi.",{duration:5e3}),t}},staleTime:6e5}),i=e?.tipi||[],r=e?.agenti||[],s=t.useMemo(()=>new Map(i.map(e=>[e.id,e.nome])),[i]),c=t.useMemo(()=>new Map(r.map(e=>[e.id,e.nome])),[r]);return{tipiIntervento:i,agentiPatogeno:r,loading:a,error:n instanceof Error?n:null,tipiInterventoMap:s,agentiPatogeniMap:c}})(),[P,I]=t.useState(a||""),[R,T]=t.useState(_),[A,L]=t.useState({paziente_id:P,tipo_evento:r?.tipo_evento||"intervento",data_evento:r?.data_evento||"",tipo_intervento_id:r?.tipo_intervento_id??void 0,descrizione_intervento:r?.descrizione_intervento||"",agente_patogeno_id:r?.agente_patogeno_id??void 0,tipo_patogeno:r?.tipo_patogeno??void 0,data_fine_evento:r?.data_fine_evento||"",note:r?.note||""}),[O,F]=t.useState(!!r?.data_fine_evento),[M,q]=t.useState({}),[K,B]=t.useState(!1);n.useEffect(()=>{_&&T(_)},[_]);const H=e=>{I(e),L(t=>({...t,paziente_id:e}))},U=e=>{T(e)},X=e=>{L(t=>({...t,...e}));const t=Object.keys(e);t.some(e=>M[e])&&q(e=>{const a={...e};return t.forEach(e=>delete a[e]),a})},V=()=>{switch(x.currentStep){case"event-type":return!!P&&!!A.tipo_evento;case"event-details":return"intervento"===A.tipo_evento?!!A.tipo_intervento_id:"infezione"===A.tipo_evento&&!!A.agente_patogeno_id;case"dates":return!!A.data_evento;case"notes":case"review":return!0;default:return!1}};return e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),!(()=>{const e={};if(!P)return e.paziente_id="Seleziona un paziente",q(e),!1;if(A.tipo_evento||(e.tipo_evento="Seleziona il tipo di evento"),"intervento"===A.tipo_evento&&(A.tipo_intervento_id||(e.tipo_intervento_id="Il tipo di intervento è obbligatorio"),A.data_evento||(e.data_evento="La data dell'intervento è obbligatoria")),"infezione"===A.tipo_evento){A.agente_patogeno_id||(e.agente_patogeno_id="Il tipo di batterio è obbligatorio"),A.data_evento||(e.data_evento="La data di inizio infezione è obbligatoria");const t=$(A.data_evento,O?A.data_fine_evento:void 0,"infezione");t&&(e.data_evento=t)}if("intervento"===A.tipo_evento){A.data_evento||(e.data_evento="La data dell'intervento è obbligatoria");const t=$(A.data_evento,void 0,"intervento");t&&(e.data_evento=t)}return q(e),0===Object.keys(e).length})())return x.goToStep("event-type"),void 0;try{B(!0);const e={paziente_id:P,tipo_evento:A.tipo_evento,data_evento:A.data_evento,note:A.note};"intervento"===A.tipo_evento&&(e.tipo_intervento_id=A.tipo_intervento_id,e.descrizione_intervento=A.descrizione_intervento),"infezione"===A.tipo_evento&&(e.agente_patogeno_id=A.agente_patogeno_id,e.tipo_patogeno=A.tipo_patogeno,O&&(e.data_fine_evento=A.data_fine_evento)),await s(e)}catch(t){l.error("Errore durante il salvataggio del evento",{error:t}),d("Errore durante il salvataggio. Riprova più tardi.",{duration:5e3}),B(!1)}},className:"wizard-form event-wizard-form",noValidate:!0,children:[e.jsxs("div",{className:"wizard-form-header",children:[e.jsx("button",{type:"button",className:"wizard-back-button",onClick:h,disabled:K,"aria-label":"Torna indietro",children:e.jsx("i",{className:"bi bi-arrow-left"})}),e.jsx("h1",{className:"wizard-form-title",children:g?"Modifica Evento":"Nuovo Evento"})]}),e.jsx(f,{currentStep:x.currentStep,getStepLabel:x.getStepLabel,getStepNumber:x.getStepNumber,totalSteps:x.totalSteps,selectedPatient:R}),e.jsx("div",{ref:b,className:"wizard-form-content",children:(()=>{const t=!!P,a={values:A,onChange:X,errors:M,isSubmitting:K};switch(x.currentStep){case"event-type":return e.jsx(w,{...a,hasPatient:t,selectedPatient:R,onSelectPatient:H,onPatientSelect:U});case"event-details":return e.jsx(z,{...a,tipiIntervento:j,agentiPatogeno:N,loadingTypes:k,loadingPatogens:k});case"dates":return e.jsx(S,{...a,showResolutionDate:O,setShowResolutionDate:F});case"notes":return e.jsx(y,{...a});case"review":return e.jsx(E,{...a,tipiIntervento:j,agentiPatogeno:N,loadingTypes:k,loadingPatogens:k});default:return null}})()}),e.jsxs("div",{className:"wizard-form-actions",children:[x.canGoPrev&&e.jsxs("button",{type:"button",className:"btn btn-secondary btn-block",onClick:x.prevStep,disabled:K,children:[e.jsx("i",{className:"bi bi-chevron-left"})," Indietro"]}),"review"!==x.currentStep?e.jsxs("button",{type:"button",className:"btn btn-primary btn-block",onClick:x.nextStep,disabled:K||!V(),title:V()?void 0:"Completa i campi obbligatori per continuare",children:["Avanti ",e.jsx("i",{className:"bi bi-chevron-right"})]}):e.jsx("button",{type:"submit",className:"btn btn-success btn-block",disabled:K,children:e.jsxs(e.Fragment,K?{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Salvataggio..."]}:{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),g?"Aggiorna Evento":"Salva Evento"]})})]})]})};export{A as E,j as F,x as P};
