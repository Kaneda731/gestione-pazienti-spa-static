import{l as t,n as e}from"./index-Ch1Y3veH.js";import{p as i}from"./patientService-EGfMwTHQ.js";import{d as n,h as s}from"./searchUtils-CGvlsFoa.js";class o{constructor(t={}){this.options={title:"Nessun dato trovato",description:"",icon:"inbox",actionText:"",actionCallback:null,...t}}render(){const t=this.options.actionText?this.renderActionButton():"";return`\n            <div class="text-center text-muted py-5">\n                <span class="material-icons mb-3" style="font-size: 4rem; opacity: 0.5;">${this.options.icon}</span>\n                <h5>${this.options.title}</h5>\n                ${this.options.description?`<p>${this.options.description}</p>`:""}\n                ${t}\n            </div>\n        `}renderForTable(t=7){return`\n            <tr>\n                <td colspan="${t}" class="text-center text-muted py-4">\n                    <div class="d-flex align-items-center justify-content-center flex-column">\n                        <span class="material-icons mb-2" style="font-size: 2rem; opacity: 0.5;">${this.options.icon}</span>\n                        <div>${this.options.title}</div>\n                        ${this.options.description?`<small>${this.options.description}</small>`:""}\n                    </div>\n                </td>\n            </tr>\n        `}renderForCards(){const t=this.options.actionText?this.renderActionButton():"";return`\n            <div class="text-center text-muted p-4">\n                <div class="d-flex align-items-center justify-content-center flex-column">\n                    <span class="material-icons mb-3" style="font-size: 3rem; opacity: 0.5;">${this.options.icon}</span>\n                    <h6>${this.options.title}</h6>\n                    ${this.options.description?`<p class="small">${this.options.description}</p>`:""}\n                    ${t}\n                </div>\n            </div>\n        `}renderCompact(){return`\n            <div class="text-center text-muted py-3">\n                <span class="material-icons me-2" style="font-size: 1.5rem; opacity: 0.5;">${this.options.icon}</span>\n                <span>${this.options.title}</span>\n            </div>\n        `}renderActionButton(){return`\n            <button class="btn btn-primary mt-3" onclick="this.dispatchEvent(new CustomEvent('action'))">\n                ${this.options.actionText}\n            </button>\n        `}static forNoPatients(){return new o({title:"Nessun paziente trovato",description:"Non ci sono pazienti che corrispondono ai criteri di ricerca.",icon:"person_off",actionText:"Aggiungi nuovo paziente"})}static forNoDiagnosis(){return new o({title:"Nessuna diagnosi trovata",description:"Non ci sono diagnosi disponibili nel sistema.",icon:"medical_services",actionText:"Aggiungi diagnosi"})}static forSearchResults(t){return new o({title:"Nessun risultato",description:`Nessun paziente corrisponde alla ricerca "${t}".`,icon:"search_off"})}static forFilteredResults(){return new o({title:"Nessun risultato",description:"Nessun paziente corrisponde ai filtri applicati.",icon:"filter_list_off",actionText:"Rimuovi filtri"})}}const r=new Map,a={hits:0,misses:0,evictions:0};function c(){r.clear(),a.hits=0,a.misses=0,a.evictions=0}function l(t=[]){return t.map(t=>({id:t.id,nome:t.nome,cognome:t.cognome,codice_rad:t.codice_rad,stato:t.stato??t.status??null,data_ricovero:t.data_ricovero,data_dimissione:t.data_dimissione,reparto:t.reparto??null,nomeCompleto:[t.cognome,t.nome].filter(Boolean).join(" ")}))}async function d(n,s={}){try{const e=function(t,e={}){const i=(t||"").trim();if(i.length<2)throw new Error("Search term must be at least 2 characters");if(i.length>100)throw new Error("Search term must be at most 100 characters");const n=e.limit??50;if(n<1||n>100)throw new Error("Limit must be between 1 and 100");const s=["nome","cognome","codice_rad","reparto"],o=e.fields??["nome","cognome","codice_rad"];for(const r of o)if(!s.includes(r))throw new Error(`Invalid search field: ${r}`);return{term:i,...e,limit:n,fields:o}}(n,s),{term:o,activeOnly:c=!0,limit:d=50,fields:u,includeArchived:p=!1}=e,h=function(t,e={}){return`${(t||"").trim().toLowerCase()}::${JSON.stringify({activeOnly:e.activeOnly??!1,limit:e.limit??20,fields:e.fields??["nome","cognome","codice_rad"],includeArchived:e.includeArchived??!1})}`}(o,{activeOnly:c,limit:d,fields:u,includeArchived:p}),m=function(t){const e=r.get(t);return e?Date.now()>e.expiresAt?(r.delete(t),a.misses++,null):(r.delete(t),r.set(t,{...e,accessCount:(e.accessCount||0)+1}),a.hits++,e.data):(a.misses++,null)}(h);if(m)return t?.log?.("🔍 patientSearchService cache HIT",{term:o,count:m.length}),m;t?.log?.("🔍 patientSearchService cache MISS",{term:o,activeOnly:c,limit:d});const v=await i.searchPatients(o,c,d),f=l(Array.isArray(v)?v:[]);return!function(e,i,n=3e5){if(r.size>=100){const e=r.keys().next().value;r.delete(e),a.evictions++,t?.debug?.(`LRU cache eviction: removed ${e}`)}r.set(e,{data:i,expiresAt:Date.now()+n,accessCount:0,createdAt:Date.now()})}(h,f),f}catch(o){throw t?.error?.("❌ patientSearchService.search error",o),e?.error?.(`Errore ricerca pazienti: ${o.message||o}`),o}}const u={search:d,searchRealtime:function(t,{activeOnly:e=!1,debounceMs:i=250,onUpdate:n,onError:s,limit:o=20}={}){let r=!1;const a=setTimeout(async()=>{if(!r)try{const i=await d(t,{activeOnly:e,limit:o});r||n?.(i)}catch(i){r||s?.(i)}},Math.max(0,i));return{cancel(){r=!0,clearTimeout(a)}}},resetCache:c,clearCache:c,getCacheStats:function(){const t=Array.from(r.values()),e=t.length>0?Math.min(...t.map(t=>t.createdAt)):null,i=a.hits+a.misses;return{size:r.size,maxSize:100,hitRate:i>0?a.hits/i:0,totalHits:a.hits,totalMisses:a.misses,totalEvictions:a.evictions,oldestEntry:e}},_normalize:l};class p{constructor({input:t,resultsContainer:e,onSelect:i,activeOnly:n=!1,minChars:s=2,debounceMs:o=250}={}){this.input=t,this.results=e,this.onSelect=i,this.activeOnly=!!n,this.minChars=Math.max(0,s),this.debounceMs=Math.max(0,o),this._cleanup=[],this._currentCancel=null}attach(){if(!this.input||!this.results)return{destroy:()=>{}};this.results.style.display="none",this.input.setAttribute("autocomplete","off"),this.input.setAttribute("aria-autocomplete","list");const e=n(async e=>{const i=(e.target.value||"").trim();if(i.length<this.minChars)return this._clearResults(),void 0;this._showLoading();try{const t=await u.search(i,{activeOnly:this.activeOnly});this._renderList(t,i)}catch(n){t.error("PatientAutocomplete search error",n),this._renderEmpty("Errore durante la ricerca.")}},this.debounceMs),i=()=>{this.results.childElementCount>0&&this._open()},s=t=>{"Escape"===t.key&&this._close()},o=t=>{setTimeout(()=>this._close(),100)};return this.input.addEventListener("input",e),this.input.addEventListener("focus",i),this.input.addEventListener("keydown",s),this.input.addEventListener("blur",o),this._cleanup.push(()=>this.input.removeEventListener("input",e)),this._cleanup.push(()=>this.input.removeEventListener("focus",i)),this._cleanup.push(()=>this.input.removeEventListener("keydown",s)),this._cleanup.push(()=>this.input.removeEventListener("blur",o)),{destroy:()=>this.destroy()}}destroy(){this._cleanup.forEach(t=>t()),this._cleanup=[],this._clearResults()}_clearResults(){this.results.innerHTML="",this.results.style.display="none"}_open(){this.results.style.display="block"}_close(){this.results.style.display="none"}_showLoading(){this.results.innerHTML='\n      <div class="px-3 py-2 text-muted small d-flex align-items-center">\n        <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>\n        <span>Ricerca in corso...</span>\n      </div>',this._open()}_renderEmpty(t="Nessun risultato"){const e=o.forSearchResults(this.input.value||"");e.options.description=t||e.options.description,this.results.innerHTML=`<div class="px-2">${e.render()}</div>`,this._open()}_renderList(t=[],e=""){if(!t.length)return this._renderEmpty(),void 0;const i=t.map((t,i)=>{const n=s(`${t.cognome||""} ${t.nome||""}`.trim(),e),o=t.codice_rad?s(`RAD: ${t.codice_rad}`,e):"";return`\n        <button type="button" class="dropdown-item d-flex flex-column" data-id="${t.id}">\n          <span>${n}</span>\n          ${o?`<small class="text-muted">${o}</small>`:""}\n        </button>`}).join("");this.results.innerHTML=i,this._open(),Array.from(this.results.querySelectorAll(".dropdown-item")).forEach(e=>{const i=i=>{i.preventDefault(),i.stopPropagation();const n=e.getAttribute("data-id"),s=t.find(t=>String(t.id)===String(n));if(s){const t=`${s.cognome||""} ${s.nome||""}`.trim();this.input.value=t,this.input.dataset.patientId=s.id,this._close(),this.onSelect?.(s)}};e.addEventListener("mousedown",i),e.addEventListener("click",i)})}}function h(t){return new p(t).attach()}export{h as a,u as p};
